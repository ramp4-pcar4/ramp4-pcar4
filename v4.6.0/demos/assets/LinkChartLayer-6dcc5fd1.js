import { d1 as ot, eN as y$1, d8 as t$1, s as s$3, bH as e$2, bI as y$2, bJ as c$1, dX as S$1, G as s$4, F as r$1, f8 as b$1, dI as I$2, cX as g, bY as U, M as M$1, lo as e$3, bq as j, gh as s$5, g2 as c$2, dY as n$1, e0 as t$2, dZ as f$1, lp as E$2, dK as o$2, dJ as y$3, bT as t$3, g5 as p$3, g6 as p$4, A as d$2, br as m$1, gc as y$4, bS as P$1, gd as m$2, eb as b$2, hZ as n$2, aa as V, d9 as e$4, V as s$6, D as x$1 } from './main-8822140d.js';
import { z as z$1 } from './geohashUtils-8f52b961.js';
import { G, p as p$5, t as t$4, T as T$3 } from './knowledgeGraphService-fc86ce23.js';
import { a } from './GraphQueryStreaming-6094acc2.js';
import { m } from './FeatureStore-d8989cc0.js';
import { $ } from './QueryEngine-9e07c12e.js';
import { l as l$2, o as o$3 } from './clientSideDefaults-42a3a5d2.js';
import { _ as __vitePreload } from './preload-helper-a4975f27.js';
import './timeSupport-a9e7b11e.js';
import './json-aab78c64.js';
import './BoundsStore-54c424ff.js';
import './PooledRBush-53b32956.js';
import './WhereClause-d8d26e6c.js';
import './TimeOnly-0d3b8280.js';
import './QueryEngineCapabilities-5bb5f351.js';
import './utils-43496024.js';
import './utils-5eef172e.js';
import './utils-d548baca.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const i$1="ESRI__DESTINATION_ID",s$2="ESRI__ORIGIN_ID";let o$1 = class o{constructor(){this._featureLookup=new Map;}static getInstance(){return o.instance||(o.instance=new o),o.instance}static resetInstance(){o.instance&&(o.instance=null);}deleteFromStore(e){e.forEach((e=>{this._featureLookup.delete(e);}));}readFromStoreByList(e){const t=[];return e.forEach((e=>{const r=this.readFromStoreById(e);r&&t.push(r);})),t}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(o,n,p){const a=[];return o.forEach((o=>{if(!o?.id)return;o.properties||(o.properties=[]);let u,c=null;if(p&&o.properties[p]&&(c=ot(o.properties[p])),"originId"in o&&"destinationId"in o&&(o.properties[s$2]=o.originId,o.properties[i$1]=o.destinationId),o.properties[n]=o.id,o.id&&this._featureLookup.has(o.id)&&this._featureLookup.get(o.id).attributes){const e=this._featureLookup.get(o.id),i=JSON.parse(JSON.stringify(Object.assign(e.attributes,o.properties)));p&&o.properties[p]&&(i[p]=y$1(o.properties[p])),u=new t$1(c?JSON.parse(JSON.stringify(c)):e?.geometry?JSON.parse(JSON.stringify(e.geometry)):null,i,null,o.properties[n]);}else u=new t$1(c?JSON.parse(JSON.stringify(c)):null,o.properties,null,o.properties[n]);this._featureLookup.set(o.id,u),a.push(u);})),a}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
var T$2;!function(s){s.ELEMENTUID="ELEMENTUID",s.TYPENAME="TYPENAME";}(T$2||(T$2={}));[T$2.ELEMENTUID,T$2.TYPENAME];var d$1,p$2;!function(s){s[s.ELEMENTUID=0]="ELEMENTUID",s[s.TYPENAME=1]="TYPENAME";}(d$1||(d$1={})),function(s){s[s.ELEMENTUID=0]="ELEMENTUID",s[s.TYPENAME=1]="TYPENAME",s[s.FROMUID=2]="FROMUID",s[s.TOUID=3]="TOUID";}(p$2||(p$2={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
var e$1,l$1,s$1,T$1;!function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult";}(e$1||(e$1={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft";}(l$1||(l$1={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar";}(s$1||(s$1={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY";}(T$1||(T$1={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
function u$1(e){if(!e.spatialReference.isWGS84)throw new s$3("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let r;return r=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],r}async function w$1(e,t){const r=[],n=new Map,s=[];if(t.dataModel?.relationshipTypes)for(const i of t.dataModel.relationshipTypes)i.name&&n.set(i.name,[]);for(const i of e)n.has(i.typeName)&&n.get(i.typeName)?.push(i.id);for(const[o,l]of n){if(l.length<1)continue;const e=new a({openCypherQuery:`MATCH (n)-[r:${o}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:l}});s.push(G(t,e).then((async e=>{const t=e.resultRowsStream.getReader();for(;;){const{done:e,value:n}=await t.read();if(e)break;for(const t of n)r.push({id:t[0],typeName:t[1]}),r.push({id:t[2],typeName:t[3]});}})));}return await Promise.all(s),r}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const w="ESRI__ID",T="ESRI__ORIGIN_ID",D="ESRI__DESTINATION_ID",I$1="ESRI__LAYOUT_GEOMETRY",M="ESRI__AGGREGATION_COUNT",k=12;let E$1=class E extends S$1{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach((i=>{i.name&&(t.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(i.name,{name:e.name??"",geometryType:e.geometryType});})));})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((i=>{i.name&&(t.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach((e=>{e.geometryType&&"esriGeometryNull"!==e.geometryType&&this.geographicLookup.set(i.name,{name:e.name??"",geometryType:e.geometryType});})));})),e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((i,s)=>{if("entity"===t.get(s))this.entityTypeNames.add(s);else {if("relationship"!==t.get(s))return s$4.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this.relationshipTypeNames.add(s);}const a=new Map;i.members?.forEach((e=>{r$1(this.memberIdTypeLookup,e.id,(()=>new Set)).add(s);const t=this.getById(e.id);t&&a.set(e.id,t);})),this.sublayerCaches.set(s,a);}));}addToLayer(e){e.forEach((({typeName:e,id:t})=>{if(!this.inclusionModeDefinition)throw new s$3("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(e);i.members||(i.members=new Map),i.members.set(t,{id:t}),r$1(this.memberIdTypeLookup,t,(()=>new Set)).add(e);}}else {const i=new Map;i.set(t,{id:t}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:i}),r$1(this.memberIdTypeLookup,t,(()=>new Set)).add(e);}}));}getById(e){return o$1.getInstance().readFromStoreById(e)}async getData(e,t,i){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return [];let n;if(n=e||new b$1({where:"1=1",outFields:["*"]}),"link-chart"===t.parentCompositeLayer.type){const e=t.parentCompositeLayer,i=this._processingCacheUpdatesLookup.get(t.objectType.name??""),o=n.outFields,s=n.geometry;let a="",r="";s&&s.extent&&(a=z$1(s.extent.ymin,s.extent.xmin,k),r=z$1(s.extent.ymax,s.extent.xmax,k)),o&&1===o.length&&o[0]===w&&"1=1"===n.where||await Promise.all(i??[]);const d=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],m=[];return d.forEach((i=>{if(this.relationshipTypeNames.has(t.objectType.name)?i.geometry=e.relationshipLinkChartDiagramLookup.get(i.attributes[t.objectIdField]):i.geometry=e.entityLinkChartDiagramLookup.get(i.attributes[t.objectIdField]),i.attributes[I$1]=i.geometry,a&&r){const n=e.linkChartGeohashLookup.get(i.attributes[t.objectIdField]);n?n>=a&&n<=r&&m.push(i):m.push(i);}else m.push(i);})),m}return this.retrieveDataFromService(n,t,i)}async getConnectedRecordIds(e,t){const i=[];let o="";const s=[],a$1=new Map;if(e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e)){if(!this.entityTypeNames.has(t))return;a$1.has(t)?a$1.get(t)?.push(e):a$1.set(t,[e]);}})),t&&0!==t?.length){for(const e of t)o=o+e+"|";o=o.slice(0,-1);}return a$1.forEach(((e,a$1)=>{let r;r=t&&0!==t?.length?`MATCH (n:${a$1})-[r:${o}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${a$1})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const p=new Promise((t=>{(async()=>{const t=(await G(this.knowledgeGraph,new a({openCypherQuery:r,bindParameters:{ids:e}}))).resultRowsStream.getReader();try{for(;;){const{done:e,value:n}=await t.read();if(e)break;for(let t=0;t<n.length;t++){const e=n[t];i.push({id:e[0],typeName:e[1]}),i.push({id:e[2],typeName:e[3]});}}}catch(o){if("AbortError"!==o.name)throw o;s$4.getLogger(this).info("Request aborted as expected");}})().then((()=>{t();}));}));s.push(p);})),this.refreshCacheContent(),await Promise.all(s),i}async refreshCacheContent(e,t,n,s=!0){const a$1=o$1.getInstance(),r=[],p=new Map,d=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&d.set(e.name,e);})),this.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&d.set(e.name,e);})),e||this.inclusionModeDefinition?e?e.forEach((e=>{if(this.memberIdTypeLookup.has(e))for(const t of this.memberIdTypeLookup.get(e))p.has(t)?p.get(t)?.push(e):p.set(t,[e]);})):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e.useAllData?p.set(t,null):e.members&&e.members.forEach((e=>{p.has(t)&&null!==p.get(t)?p.get(t)?.push(e.id):p.set(t,[e.id]);}));})):(this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&p.set(e.name,null);})),this.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&p.set(e.name,null);})));for(const[m,l]of p){const e=new Promise((e=>{const r=async()=>{const e=new Set,r=[];let p,h="",c=!1;if(t||d.get(m)?.properties?.forEach((t=>{t.name&&e.add(t.name);})),n&&this.geographicLookup.has(m)){const t=this.geographicLookup.get(m)?.name;t&&e.add(t);}if(this.entityTypeNames.has(m))h=`MATCH (n:${m}) ${l?"WHERE id(n) IN $ids ":""}return ID(n)`,e.forEach((e=>{h+=`, n.${e}`,r.push(e);}));else {if(!this.relationshipTypeNames.has(m))throw new s$3("knowledge-graph:layer-data-manager",`The graph type of ${m} could not be determined. Was this type set in the KG data model and inclusion definition?`);c=!0,h=`MATCH ()-[n:${m}]->() ${l?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,e.forEach((e=>{h+=`, n.${e}`,r.push(e);}));}p=new a(l?{openCypherQuery:h,bindParameters:{ids:l}}:{openCypherQuery:h});const y=(await G(this.knowledgeGraph,p)).resultRowsStream.getReader();for(;;){const{done:e,value:t}=await y.read();if(e)break;const i=[];for(let s=0;s<t.length;s++){const e=t[s];let n=0,a=0;const p={properties:{}};for(p.id=e[n],n++,a++,c&&(p.originId=e[n],n++,a++,p.destinationId=e[n],n++,a++,r$1(this.nodeConnectionsLookup,p.originId,(()=>new Set)).add(p.id),r$1(this.nodeConnectionsLookup,p.destinationId,(()=>new Set)).add(p.id),r$1(this.relationshipConnectionsLookup,p.id,(()=>[p.originId,p.destinationId])));n<e.length;n++)p.properties[r[n-a]]=e[n];i.push(p);}const n=a$1.writeToStore(i,w,this.geographicLookup.get(m)?.name);this.sublayerCaches.has(m)||this.sublayerCaches.set(m,new Map),s&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(m)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(m,{useAllData:!1,members:new Map}),s&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(m).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(m).members=new Map);const p=this.sublayerCaches.get(m);n.forEach((e=>{p?.set(e.attributes[w],e),s&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(m).members.has(e.attributes[w])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(m).members.set(e.attributes[w],{id:e.attributes[w]}),r$1(this.memberIdTypeLookup,e.attributes[w],(()=>new Set)).add(m));}));}};r().then((()=>{e(null);}));}));r.push(e),this._processingCacheUpdatesLookup.get(m)?.push(e);}await Promise.all(r);}removeFromLayer(e){const t=new Set,i=new Set(e.map((e=>e.id)));for(const n of e)t.add(n.typeName),1===this.memberIdTypeLookup.get(n.id)?.size?this.memberIdTypeLookup.delete(n.id):this.memberIdTypeLookup.get(n.id)?.delete(n.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{t===n.typeName&&e.members?.has(n.id)&&e.members.delete(n.id);}));t.forEach((e=>{this.sublayerCaches.get(e)?.forEach(((t,n)=>{i.has(n)&&this.sublayerCaches.get(e)?.delete(n);}));}));}async retrieveDataFromService(e,t,n){const o=o$1.getInstance(),a$1=new Set,r=[];let p,g$1="",T=[];const D="relationship"===t.graphType,I=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,M=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let k=!I&&M?Array.from(M).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&null!=e.objectIds&&(k=e.objectIds);else if(null!=e.objectIds&&k&&k.length>0){const t=e.objectIds;e.objectIds=k.filter((e=>t.includes(e)));}else if(null!=e.objectIds)k=e.objectIds;else {if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=k;}if(null!=e.outFields){const i=e.outFields;i.includes("*")?t.fields.forEach((e=>{a$1.add(e.name);})):i.forEach((e=>{e!==w&&e!==t.geometryFieldName&&a$1.add(e);}));}if(null!=e.geometry){const n=e.geometry;let o;const c=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,u=c?.spatialReference,w=c?.serviceCapabilities?.geometryCapabilities;let T=w?.geometryMaxBoundingRectangleSizeX,I=w?.geometryMaxBoundingRectangleSizeY;if(n?.extent?.spatialReference&&!n.spatialReference?.isWGS84?(await I$2(n.extent.spatialReference,g),o=U(n.extent,g)):o=n.extent,T&&I&&u){if(4326!==u.wkid){const e=new M$1({spatialReference:u,xmax:T,ymax:I}),t=U(e,g);T=t.xmax,I=t.ymax;}if(o.xmax-o.xmin>T)throw new s$3("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${T}° latitude, limit exceeded`);if(o.ymax-o.ymin>I)throw new s$3("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${I}° longitude, limit exceeded`)}if(null!=e.where&&"1=1"!==e.where){const i=await e$3(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach((e=>{i.fieldNames.includes(e.name)&&a$1.add(e.name);}));}g$1=D?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&a$1.add(t.geometryFieldName),a$1.forEach((e=>{g$1+=`, n.${e}`,r.push(e);})),p=new a({openCypherQuery:g$1,bindParameters:{param_filter_geom:new j({rings:u$1(o)})}});}else {let i="";if(null!=e.where&&"1=1"!==e.where){const n=await e$3(e.where,t.fieldsIndex);t.fields.forEach((e=>{n.fieldNames.includes(e.name)&&a$1.add(e.name);}));const o=new Set(["column-reference","string","number","binary-expression"]),r=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let p=!1;const d=e=>{if("column-reference"===e.type)return `n.${e.column}`;if("string"===e.type)return `'${e.value}'`;if("number"===e.type)return `${e.value}`;if("binary-expression"===e.type&&o.has(e.left.type)&&o.has(e.right.type)&&r.has(e.operator))return `${d(e.left)} ${e.operator} ${d(e.right)}`;if("binary-expression"===e.type&&"LIKE"===e.operator){let t="";if("function"===e.left.type&&"column-reference"===e.left.args.value[0].type)t+=`lower(n.${e.left.args.value[0].column})`;else {if("column-reference"!==e.left.type)return p=!0,"";t+=`lower(n.${e.left.column})`;}if(t+=" CONTAINS (","string"!==e.right.type)return p=!0,"";{let i=e.right.value;"%"===i.charAt(0)&&(i=i.slice(1)),"%"===i.charAt(i.length-1)&&(i=i.slice(0,-1)),t+=`'${i.toLowerCase()}')`;}return t}return p=!0,""};i=d(n.parseTree),p&&(i="");}let n="";n=D?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let o=!1;k&&(o=!0,n+=" WHERE ID(n) IN $ids"),i&&(n+=o?" AND":" WHERE",n+=` ${i}`),n+=" return ID(n)",D&&(n+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&a$1.add(t.geometryFieldName),a$1.forEach((e=>{n+=`, n.${e}`,r.push(e);})),p=new a(k?{openCypherQuery:n,bindParameters:{ids:k}}:{openCypherQuery:n});}const E=(await G(t.parentCompositeLayer.dataManager.knowledgeGraph,p,n)).resultRowsStream.getReader();for(;;){const{done:e,value:i}=await E.read();if(e)break;const n=[];for(let t=0;t<i.length;t++){const e=i[t];let o=0,s=0;const a={properties:{}};for(a.id=e[o],o++,s++,D&&(a.originId=e[o],o++,s++,a.destinationId=e[o],o++,s++);o<e.length;o++)a.properties[r[o-s]]=e[o];n.push(a);}T=T.concat(o.writeToStore(n,w,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name));}return T}};e$2([y$2()],E$1.prototype,"knowledgeGraph",void 0),e$2([y$2()],E$1.prototype,"inclusionModeDefinition",void 0),e$2([y$2()],E$1.prototype,"entityTypeNames",void 0),e$2([y$2()],E$1.prototype,"relationshipTypeNames",void 0),e$2([y$2()],E$1.prototype,"geographicLookup",void 0),e$2([y$2()],E$1.prototype,"sublayerCaches",void 0),e$2([y$2()],E$1.prototype,"nodeConnectionsLookup",void 0),e$2([y$2()],E$1.prototype,"relationshipConnectionsLookup",void 0),e$2([y$2()],E$1.prototype,"memberIdTypeLookup",void 0),E$1=e$2([c$1("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],E$1);

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const t=s$5(),p$1=s=>{let p=class extends s{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null;}};return e$2([y$2(t.fields)],p.prototype,"fields",void 0),e$2([y$2(t.fieldsIndex)],p.prototype,"fieldsIndex",void 0),p=e$2([c$1("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],p),p};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let I=class extends(c$2(p$1(n$1(t$2(f$1(b$2)))))){constructor(e){if(super(e),this.capabilities=l$2(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=w,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then((()=>{const e=new MessageChannel;return new E$2(e.port1,{channel:e,client:{queryFeatures:(e,t={})=>{const r=b$1.fromJSON(e);return this.queryFeaturesJSON(r,t)}}}),[e.port2]}))},this.type="knowledge-graph-sublayer","link-chart"===e.parentCompositeLayer.type)"relationship"===e.graphType?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=I$1;else if(e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType&&"esriGeometryNull"!==e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.geometryType){const t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=t?.name??null,this.geometryType=t?.geometryType?o$2.fromJSON(t.geometryType):null;const r=t?.name,o=r?e.objectType.properties?.[r]:null;o?(this.hasM=o.hasM??!1,this.hasZ=o.hasZ??!1):(this.hasM=!1,this.hasZ=!1);}else this.geometryType=null;e.objectType.properties?.forEach((e=>{let t=null,r=e.fieldType;"esriFieldTypeOID"===r&&(r="esriFieldTypeInteger"),this.fields.push(y$3.fromJSON({name:e.name,type:r,alias:e.alias,defaultValue:t,editable:e.editable,nullable:e.nullable}));})),this.fields.push(y$3.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(y$3.fromJSON({name:M,type:"esriFieldTypeInteger",alias:M,editable:!1})),this._set("fields",[...this.fields]),e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel?.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),"link-chart"===e.parentCompositeLayer.type?"relationship"===e.graphType?this.renderer=t$3(o$3(o$2.toJSON("polyline")).renderer):this.renderer=t$3(o$3(o$2.toJSON("point")).renderer):this.renderer=t$3(o$3(o$2.toJSON(this.geometryType)).renderer);}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){p$3(e,this.fieldsIndex),this._set("renderer",e);}createPopupTemplate(e){return p$4(this,e)}createQuery(){return new b$1({where:"1=1",outFields:["*"]})}getField(e){for(let t=0;t<this.fields.length;t++)if(this.fields[t].name===e)return this.fields[t];return null}getFieldDomain(e,t){return null}async queryFeatures(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e),s=d$2.fromJSON(await o.executeQuery(r.toJSON(),t?.signal));return s.features.forEach((e=>{e.sourceLayer=this;})),s}async queryFeaturesJSON(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e);return await o.executeQuery(r.toJSON(),t?.signal)}async queryFeatureCount(e,t){const{resolvedQuery:r,queryEngine:o}=await this._setupQueryObjects(e);return o.executeQueryForCount(r.toJSON(),t?.signal)}async queryExtent(e={},t){const r={...e,returnGeometry:!0},{resolvedQuery:o,queryEngine:s}=await this._setupQueryObjects(r),i=await s.executeQueryForExtent(o.toJSON(),t?.signal);let a;return a=null!=i.extent?.xmin&&null!=i.extent?.xmax&&null!=i.extent?.ymin&&null!=i.extent?.ymax?new M$1(i.extent):new M$1,{count:i.count,extent:a}}async queryObjectIds(e,t){const r=b$1.from(e);let o;if("link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)o=this._cachedQueryEngine;else {const e=await this.parentCompositeLayer.dataManager.getData(r,this,t);o=this.loadQueryEngine(e);}return o.executeQueryForIds(r.toJSON(),t?.signal)}loadQueryEngine(e){const t=new m({geometryType:o$2.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new $({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:o$2.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new b$1({where:"1=1",outFields:[w]}),this);this._cachedQueryEngine=this.loadQueryEngine(e);}async _setupQueryObjects(e,t){const r=b$1.from(e),o=r.geometry;let s;if(o&&!o.spatialReference?.isWGS84&&(await I$2(o.spatialReference,g),r.geometry=U(o instanceof j||o instanceof m$1?o:o.extent,g)),"link-chart"===this.parentCompositeLayer.type&&this._cachedQueryEngine)s=this._cachedQueryEngine;else {const e=await this.parentCompositeLayer.dataManager.getData(r,this,t);s=this.loadQueryEngine(e);}return {resolvedQuery:r,queryEngine:s}}};e$2([y$2()],I.prototype,"capabilities",void 0),e$2([y$2({readOnly:!0})],I.prototype,"defaultPopupTemplate",null),e$2([y$2()],I.prototype,"definitionExpression",void 0),e$2([y$2()],I.prototype,"displayField",void 0),e$2([y$2()],I.prototype,"elevationInfo",void 0),e$2([y$2()],I.prototype,"geometryType",void 0),e$2([y$2()],I.prototype,"geometryFieldName",void 0),e$2([y$2()],I.prototype,"graphType",void 0),e$2([y$2()],I.prototype,"hasM",void 0),e$2([y$2()],I.prototype,"hasZ",void 0),e$2([y$2()],I.prototype,"labelsVisible",void 0),e$2([y$2()],I.prototype,"labelingInfo",void 0),e$2([y$2()],I.prototype,"objectIdField",void 0),e$2([y$2()],I.prototype,"objectType",void 0),e$2([y$2()],I.prototype,"parentCompositeLayer",void 0),e$2([y$2(y$4)],I.prototype,"popupEnabled",void 0),e$2([y$2({type:P$1,json:{name:"popupInfo",write:!0}})],I.prototype,"popupTemplate",void 0),e$2([y$2({types:m$2,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],I.prototype,"renderer",null),e$2([y$2()],I.prototype,"source",void 0),e$2([y$2({json:{read:!1}})],I.prototype,"type",void 0),I=e$2([c$1("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],I);const R=I;

let e,r=null;function n(){return e||(e=__vitePreload(() => import('./lclayout-dec3edc8.js'),true?["./lclayout-dec3edc8.js","./main-8822140d.js","./preload-helper-a4975f27.js","./main-4fa92696.css"]:void 0,import.meta.url).then((t=>t.l)).then((({default:e})=>e({locateFile:e=>n$2(`esri/libs/linkchartlayout/${e}`)}))).then((t=>{s(t);})),e)}function s(t){r=t;}var u,o;function y(t,e,a,n,s,u){const o=a.length,y=s.length,i=Float64Array.BYTES_PER_ELEMENT,l=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,E=16,p=E-1+o*(c+2*i)+y*(2*l),f=r._malloc(p);try{const c=f+E-f%E,p=c+o*i,A=p+o*i,b=A+y*l,P=b+y*l,L=()=>[r.HEAPF64.subarray(c>>3,(c>>3)+o),r.HEAPF64.subarray(p>>3,(p>>3)+o),r.HEAPU32.subarray(A>>2,(A>>2)+y),r.HEAPU32.subarray(b>>2,(b>>2)+y),r.HEAPU8.subarray(P,P+o)],[d,C,H,_,g]=L();d.set(a),C.set(n),H.set(s),_.set(u),g.set(e);let F=t(o,P,c,p,y,A,b),R=null;if(F){const t=r.getLayoutLinksTypes(),e=r.getLayoutLinksVerticesEndIndices(),a=r.getLayoutLinksVertices(),n=r.countLayoutLinksVertices();!y||t&&e?n&&!a?F=!1:R={types:new Uint8Array(r.HEAPU8.subarray(t,t+y)),vertexEndIndex:new Uint32Array(r.HEAPU32.subarray(e>>2,(e>>2)+y)),vertices:new Float64Array(r.HEAPF64.subarray(a>>3,(a>>3)+2*n))}:F=!1;}const[h,U,m,B,T]=L();return a.set(h),n.set(U),s.set(m),u.set(B),e.set(T),{success:F,links:R}}finally{r._free(f),r.cleanupLayout();}}!function(t){t[t.None=0]="None",t[t.IsMovable=1]="IsMovable",t[t.IsGeographic=2]="IsGeographic",t[t.IsRoot=4]="IsRoot";}(u||(u={})),function(t){t[t.Regular=0]="Regular",t[t.Orthogonal=1]="Orthogonal",t[t.Curved=2]="Curved",t[t.Recursive=3]="Recursive";}(o||(o={}));const i=2,l=1,c=-1;var E,p,f,A,b,P,L,d;!function(t){function e(){return r.getMinIdealEdgeLength()}function a(t,e,a,n,s,u=i,o=l,E=c){return y(((t,e,a,n,s,y,i)=>r.applyForceDirectedLayout(t,e,a,n,s,y,i,u,o,E)),t,e,a,n,s)}t.getMinIdealEdgeLength=e,t.apply=a;}(E||(E={})),function(t){function e(t,e,a,n,s,u=i,o=l,E=c){return y(((t,e,a,n,s,y,i)=>r.applyCommunityLayout(t,e,a,n,s,y,i,u,o,E)),t,e,a,n,s)}t.apply=e;}(p||(p={})),function(t){function e(t,e,a,n,s){return y(r.applySimpleLayout,t,e,a,n,s)}t.apply=e;}(f||(f={})),function(t){function e(t,e,a,n,s){return y(r.applyHierarchicalLayout,t,e,a,n,s)}t.apply=e;}(A||(A={})),function(t){function e(t,e,a,n,s){return y(r.applyRadialTreeLayout,t,e,a,n,s)}t.apply=e;}(b||(b={})),function(t){function e(t,e,a,n,s){return y(r.applySmartTreeLayout,t,e,a,n,s)}t.apply=e;}(P||(P={})),function(t){t[t.Undirected=0]="Undirected",t[t.Directed=1]="Directed",t[t.Reversed=2]="Reversed";}(L||(L={})),function(t){t[t.ByCC_Raw=0]="ByCC_Raw",t[t.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",t[t.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC";}(d||(d={}));

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const S=(e,t,a)=>(e.has(t)||e.set(t,a()),e.get(t));let z=class extends(n$1(t$2(b$2))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new V,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new M$1({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new V,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new s$3("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return {url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const e=this.url.split("/");this.title=e[e.length-2];}const t=new Set;let n=[],s=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new s$3("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e);})),e.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this._graphTypeLookup.set(e.name,e);})),e.inclusionModeDefinition?.generateAllSublayers?(n=e.knowledgeGraph.dataModel.entityTypes??[],s=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach(((a,o)=>{if(!this._graphTypeLookup.get(o))return s$4.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(o);this._graphTypeLookup.get(o)instanceof p$5||"strictOrigin"in this._graphTypeLookup.get(o)?t.has(o)||(t.add(o),s.push(this._graphTypeLookup.get(o))):this._graphTypeLookup.get(o)instanceof t$4||"properties"in this._graphTypeLookup.get(o)?t.has(o)||(t.add(o),n.push(this._graphTypeLookup.get(o))):(s$4.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(o));})):(n=e.knowledgeGraph.dataModel.entityTypes??[],s=e.knowledgeGraph.dataModel.relationshipTypes??[]);const o=new E$1({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=n,this.memberRelationshipTypes=s,this.dataManager=o;}load(e){return this.addResolvingPromise(new Promise((t=>{T$3(this.url).then((a=>{if(this._initializeLayerProperties({knowledgeGraph:a,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0});})),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach((e=>{e.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(e.name,{useAllData:!0});}))),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e=>{e.useAllData=!1,e.members?.forEach((e=>{let t;t=e.linkChartLocation instanceof e$4?e.linkChartLocation:e.linkChartLocation?ot(e.linkChartLocation):null,t&&2===t.coords.length&&0===t.lengths.length?(this.linkChartGeohashLookup.set(e.id,z$1(t.coords[1],t.coords[0],k)),this.entityLinkChartDiagramLookup.set(e.id,t)):(this.linkChartGeohashLookup.set(e.id,""),this.relationshipLinkChartDiagramLookup.set(e.id,t));})),this.addResolvingPromise(this._initializeDiagram().then((async()=>{this.layers.forEach((async e=>{await e.refreshCachedQueryEngine();})),this.tables.forEach((async e=>{await e.refreshCachedQueryEngine();}));})));}));else {const t="GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode;this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,t,!0).then((async()=>{s$6(e);const t=[],a=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach((e=>{e.useAllData=!1;}))),await this._initializeDiagram(),this.layers.forEach((e=>{a.push(e.refreshCachedQueryEngine()),t.push(new Promise((t=>{e.on("layerview-create",(()=>{t(null);}));})));})),this.tables.forEach((e=>{a.push(e.refreshCachedQueryEngine());})),await Promise.all(a);})));}t(null);}));}))),Promise.resolve(this)}async addRecords(e,t){let a=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(a=await w$1(e,this.dataManager.knowledgeGraph));const i=e.concat(a).filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));await this._handleNewRecords(i);}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:a=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){let i=[];for(const s of e)!1===this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(s.typeName)?.useAllData&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(s.typeName)?.members?.has(s.id)&&i.push(s);if(t){const e=new Set,t=[];for(const a of i)if(this.dataManager.nodeConnectionsLookup.has(a.id))for(const t of this.dataManager.nodeConnectionsLookup.get(a.id))e.add(t);for(const a of e)if(this.dataManager.memberIdTypeLookup.has(a))for(const e of this.dataManager.memberIdTypeLookup.get(a))this.dataManager.relationshipTypeNames.has(e)&&t.push({id:a,typeName:e});i=i.concat(t);}this.dataManager.removeFromLayer(i);for(const s of i)this.sublayerIdsCache.get(s.typeName)?.delete(s.id),this.dataManager.relationshipTypeNames.has(s.typeName)?this.relationshipLinkChartDiagramLookup.delete(s.id):this.entityLinkChartDiagramLookup.delete(s.id);a&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{});const n=[];return this.layers.forEach((e=>{n.push(e.refreshCachedQueryEngine());})),await Promise.all(n),this._refreshNamedTypes(),i}async expand(e,t){const a=await this.dataManager.getConnectedRecordIds(e,t),i=a.filter((e=>!this.sublayerIdsCache.get(e.typeName)?.has(e.id)));return await this._handleNewRecords(a),{records:i}}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach((e=>{const t=new R({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map);})),this.memberEntityTypes.forEach((e=>{const t=new R({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map);})),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{const a=S(this.sublayerIdsCache,t,(()=>new Set));e.members?.forEach((e=>{if(a.add(e.id),e.linkChartLocation)if(e.linkChartLocation instanceof e$4)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation),2===e.linkChartLocation.coords.length&&0===e.linkChartLocation.lengths.length?this.linkChartGeohashLookup.set(e.id,z$1(e.linkChartLocation.coords[1],e.linkChartLocation.coords[0],k)):this.linkChartGeohashLookup.set(e.id,"");else {const a=ot(e.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(e.id,e.linkChartLocation?a:null):this.entityLinkChartDiagramLookup.set(e.id,e.linkChartLocation?a:null),"x"in e.linkChartLocation&&"y"in e.linkChartLocation?this.linkChartGeohashLookup.set(e.id,z$1(e.linkChartLocation.x,e.linkChartLocation.y,k)):this.linkChartGeohashLookup.set(e.id,"");}}));}));}async calculateLinkChartLayout(e="RADIAL_TREE",t){const n$1=[],s=[],o$1=[];this.dataManager.sublayerCaches.forEach(((e,t)=>{this.dataManager.entityTypeNames.has(t)?e.forEach((e=>{n$1.push({typeName:t,feature:e});})):this.dataManager.relationshipTypeNames.has(t)&&e.forEach((e=>{s.push({typeName:t,feature:e});}));})),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const h=new Map,p$1=new Map,d=new Map,k$1=new Map,L=new Uint8Array(n$1.length),C=new Float64Array(n$1.length),M$2=new Float64Array(n$1.length),I=new Uint32Array(s.length),v=new Uint32Array(s.length),A$1=[],S="FORCE_DIRECTED",z=new M$1({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let O,U="FORCE_DIRECTED",Q=0,F=0;switch(U="GEOGRAPHIC"===e?S:e,U){case"FORCE_DIRECTED":O=E.apply;break;case"COMMUNITY":O=p.apply;break;case"HIERARCHICAL":O=A.apply;break;case"RADIAL_TREE":O=b.apply;break;case"SMART_TREE":O=P.apply;break;default:O=f.apply;}n$1.forEach((({typeName:a,feature:i})=>{if(t?.lockedNodeLocations?.has(i.attributes[w])){"GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)?L[Q]=u.IsGeographic:L[Q]=u.None;const n=t.lockedNodeLocations.get(i.attributes[w]);C[Q]=n.x,M$2[Q]=n.y;}else if("GEOGRAPHIC"===e&&this.dataManager.geographicLookup.has(a)){L[Q]=u.IsGeographic;let e=null;const t=i.attributes[this.dataManager.geographicLookup.get(a).name],n=this.dataManager.geographicLookup.get(a)?.geometryType;switch(n){case"esriGeometryPoint":C[Q]=t?.x,M$2[Q]=t?.y;break;case"esriGeometryPolygon":e=t?.centroid,null!=e?.x&&null!=e?.y?(C[Q]=e.x,M$2[Q]=e.y):L[Q]=u.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":e=t?.extent?.center,null!=e?.x&&null!=e?.y?(C[Q]=e.x,M$2[Q]=e.y):L[Q]=u.IsMovable;break;default:L[Q]=u.IsMovable;}(null==C[Q]||null==M$2[Q]||Number.isNaN(C[Q])||Number.isNaN(M$2[Q]))&&(L[Q]=u.IsMovable,C[Q]=0,M$2[Q]=0);}else L[Q]=u.IsMovable,C[Q]=0,M$2[Q]=0;k$1.set(i.attributes[w],Q),A$1[Q]={feature:i,typeName:a},Q++;}));let H=!1;const K=new Map;s.forEach((e=>{const t=e.feature.attributes[T],a=e.feature.attributes[D],i=k$1.get(t),n=k$1.get(a);if(void 0!==i&&void 0!==n){const s=t+"-"+a,r=K.get(s),h=r?.has(e.typeName);h||(I[F]=i,v[F]=n,void 0===r?K.set(s,new Map([[e.typeName,F]])):r.set(e.typeName,F),F++),o$1.push(e);}else H=!0,this.relationshipLinkChartDiagramLookup.set(t,null),this.linkChartGeohashLookup.set(t,null);})),H&&s$4.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await n();const{success:$,links:B}=O(L,C,M$2,I.subarray(0,F),v.subarray(0,F));if(!$)throw new s$3("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let a=0;a<A$1.length;a++){if(M$2[a]>84.9999?M$2[a]=84.9999:M$2[a]<-84.9999&&(M$2[a]=-84.9999),C[a]>179.9999?C[a]=179.9999:C[a]<-179.9999&&(C[a]=-179.9999),A$1[a].feature.attributes[I$1]=new x$1(C[a],M$2[a]),h.has(A$1[a].typeName)){const e=h.get(A$1[a].typeName);e?.set(A$1[a].feature.attributes[w],A$1[a].feature);}else {const e=new Map;e.set(A$1[a].feature.attributes[w],A$1[a].feature),h.set(A$1[a].typeName,e);}d.set(A$1[a].feature.attributes[w],A$1[a].feature);const e=ot(A$1[a].feature.attributes[I$1]);this.entityLinkChartDiagramLookup.set(A$1[a].feature.attributes[w],A$1[a].feature.attributes[I$1]?e:null),this.linkChartGeohashLookup.set(A$1[a].feature.attributes[w],z$1(A$1[a].feature.attributes[I$1].y,A$1[a].feature.attributes[I$1].x,k)),A$1[a].feature.attributes[I$1].x<z.xmin&&(z.xmin=A$1[a].feature.attributes[I$1].x),A$1[a].feature.attributes[I$1].x>z.xmax&&(z.xmax=A$1[a].feature.attributes[I$1].x),A$1[a].feature.attributes[I$1].y<z.ymin&&(z.ymin=A$1[a].feature.attributes[I$1].y),A$1[a].feature.attributes[I$1].y>z.ymax&&(z.ymax=A$1[a].feature.attributes[I$1].y);}if(this.linkChartExtent.xmin=z.xmin,this.linkChartExtent.xmax=z.xmax,this.linkChartExtent.ymin=z.ymin,this.linkChartExtent.ymax=z.ymax,!B)throw new s$3("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const W=new Map,Y=new Map,q=new Map,J=new Set;for(let a=0;a<o$1.length;a++){const e=[],t=o$1[a],n=t.feature.attributes[T],s=t.feature.attributes[D],r=n+"-"+s,h=K.get(r).get(t.typeName),g=0===h?0:B?.vertexEndIndex[h-1];if(!J.has(h)){if(J.add(h),B.types[h]===o.Recursive){const t=[B.vertices[2*g],B.vertices[2*g+1]],a=[B.vertices[2*(g+1)],B.vertices[2*(g+1)+1]],i=[.5*(t[0]+a[0]),.5*(t[1]+a[1])],n=[i[0]-t[0],i[1]-t[1]],s=[i[0]+n[1],i[1]-n[0]],o=[i[0]-n[1],i[1]+n[0]];e.push(t),e.push(s),e.push(a),e.push(o),e.push(t);}else {if(B.types[h]!==o.Regular){s$4.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let t=g;t<B.vertexEndIndex[h];t++)e.push([B.vertices[2*t],B.vertices[2*t+1]]);}const t=A$1[k$1.get(n)]?.feature.attributes[I$1],a=A$1[k$1.get(s)]?.feature.attributes[I$1];e[0][0]===t.x&&e[0][1]===t.y||(e[0]=[t.x,t.y]),e[e.length-1][0]===a.x&&e[e.length-1][1]===a.y||(e[e.length-1]=[a.x,a.y]);for(let i=1;i<e.length-1;i++)e[i][1]>85.5?e[i][1]=85.5:e[i][1]<-85.5&&(e[i][1]=-85.5),e[i][0]>179.9999?e[i][0]=179.9999:e[i][0]<-179.9999&&(e[i][0]=-179.9999);W.has(r)?W.get(r).push(e):W.set(r,[e]);}const f=W.get(r);Y.has(r)||(Y.set(r,new Map),q.set(r,new Map));const L=Y.get(r),C=q.get(r);L.has(t.typeName)||(L.set(t.typeName,f.shift()),C.set(t.typeName,0));const M=L.get(t.typeName);C.set(t.typeName,C.get(t.typeName)+1);const w$1=new m$1({paths:M});if(t.feature.attributes[I$1]=w$1,p$1.has(t.typeName)){const e=p$1.get(t.typeName);e?.set(t.feature.attributes[w],t.feature);}else {const e=new Map;e.set(t.feature.attributes[w],t.feature),p$1.set(t.typeName,e);}d.set(t.feature.attributes[w],t.feature);const b=ot(t.feature.attributes[I$1]);this.relationshipLinkChartDiagramLookup.set(t.feature.attributes[w],t.feature.attributes[I$1]?b:null),this.linkChartGeohashLookup.set(t.feature.attributes[w],"");}for(const a of o$1)a.feature.attributes[M]=q.get(a.feature.attributes[T]+"-"+a.feature.attributes[D])?.get(a.typeName)??null;return this._currentLinkChartConfig={layoutMode:e},{nodes:h,links:p$1,idMap:d}}async applyNewLinkChartLayout(e="RADIAL_TREE",t){const a=[];await this.calculateLinkChartLayout(e,t),this.layers.forEach((e=>{a.push(e.refreshCachedQueryEngine());})),await Promise.all(a),this._refreshNamedTypes();}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t=>{t?.members?.forEach((t=>{const a=t.linkChartLocation;let i;const n=t.id;a&&(i="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(n,new x$1({x:i.x,y:i.y})));}));})),e}async synchronizeInclusionListWithCache(){return new Promise((e=>{this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(((e,t)=>{if(e.useAllData=!1,e.members&&e.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const a=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(e.members.keys()).filter((e=>!a.has(e))).forEach((t=>{e.members?.delete(t);}));}})),e();}))}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach((e=>{t.push(e.refreshCachedQueryEngine());})),await Promise.all(t),this._refreshNamedTypes();}async _handleNewRecords(e){const t=[];this.dataManager.addToLayer(e);for(const a of e)this.sublayerIdsCache.has(a.typeName)||(this.sublayerIdsCache.set(a.typeName,new Set),t.push(a.typeName)),this.sublayerIdsCache.get(a.typeName).add(a.id);for(const a of t)if(this._graphTypeLookup.has(a)){const e=this._graphTypeLookup.get(a),t="endPoints"in e?"relationship":"entity",i=new R({objectType:e,parentCompositeLayer:this,graphType:t,title:a});"entity"===t?this.dataManager.entityTypeNames.add(a):this.dataManager.relationshipTypeNames.add(a),i.geometryType?this.layers.push(i):this.tables.push(i),this.dataManager.sublayerCaches.set(a,new Map);}await this.dataManager.refreshCacheContent(e.map((e=>e.id))),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode);}async _initializeDiagram(){this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(((e,t)=>{e?.members?.forEach((e=>{const a=e.linkChartLocation;let i;const n=e.id;if(!a)return;i="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]};const s=ot(i);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(n,s):this.entityLinkChartDiagramLookup.set(n,s),this.linkChartGeohashLookup.set(n,z$1(i.x,i.y,k)),this.linkChartExtent.xmin>i.x&&(this.linkChartExtent.xmin=i.x),this.linkChartExtent.xmax<i.x&&(this.linkChartExtent.xmax=i.x),this.linkChartExtent.ymin>i.y&&(this.linkChartExtent.ymin=i.y),this.linkChartExtent.ymax<i.y&&(this.linkChartExtent.ymax=i.y);}));})),this.memberRelationshipTypes.forEach((e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach((e=>{const t=this.relationshipLinkChartDiagramLookup.get(e.attributes[T]),a=this.relationshipLinkChartDiagramLookup.get(e.attributes[D]);if(t&&a){const i=ot(new m$1({paths:[[t.coords[0],t.coords[1]],[a.coords[0],a.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(e.attributes[w],i);}else this.relationshipLinkChartDiagramLookup.set(e.attributes[w],null);this.linkChartGeohashLookup.set(e.attributes[w],"");}));}))):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()});}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0});}};e$2([y$2()],z.prototype,"dataPreloadedInLocalCache",void 0),e$2([y$2()],z.prototype,"defaultLinkChartConfig",void 0),e$2([y$2()],z.prototype,"dataManager",void 0),e$2([y$2()],z.prototype,"knowledgeGraph",void 0),e$2([y$2()],z.prototype,"layers",void 0),e$2([y$2()],z.prototype,"entityLinkChartDiagramLookup",void 0),e$2([y$2()],z.prototype,"relationshipLinkChartDiagramLookup",void 0),e$2([y$2()],z.prototype,"linkChartExtent",void 0),e$2([y$2()],z.prototype,"linkChartGeohashLookup",void 0),e$2([y$2()],z.prototype,"memberEntityTypes",void 0),e$2([y$2()],z.prototype,"memberRelationshipTypes",void 0),e$2([y$2()],z.prototype,"sublayerIdsCache",void 0),e$2([y$2()],z.prototype,"tables",void 0),e$2([y$2({json:{read:!1}})],z.prototype,"type",void 0),z=e$2([c$1("esri.layers.LinkChartLayer")],z);const O=z;

export { O as default };
