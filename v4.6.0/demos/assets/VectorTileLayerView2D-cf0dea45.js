import { U as U$1, me as n$5, fn as e$3, c6 as Et, eO as p$2, fj as f$1, K as a$2, bG as e$4, al as b$1, dT as v, dM as e$5, nJ as s$2, kZ as a$3, aq as u$2, kc as E, h2 as r$4, nK as A$1, fd as o$4, fe as M, fg as h$6, h4 as f$2, fk as e$7, nL as r$6, nM as r$8, fl as j$1, C as c$6, F as r$9, bD as h$7, nN as m$5, nO as p$3, bV as u$3, ad as G$1, G as s$5, bE as m$6, a1 as a$5, D as x$1, bH as e$9, bI as y$2, bJ as c$7 } from './main-8822140d.js';
import { E as E$1, I as I$2 } from './enums-affa582e.js';
import { t as t$5 } from './Rect-09e0f861.js';
import { G, D as D$1, F, I as I$1, O, R } from './enums-af0bf3a9.js';
import { e as e$2, m as m$3 } from './Texture-bb85fd56.js';
import { i as i$4 } from './rasterizingUtils-a0f383ef.js';
import { w as w$1, d as d$3 } from './GeometryUtils-919c0656.js';
import { h as h$5 } from './Program-c5762f5e.js';
import { o as o$3 } from './ProgramTemplate-3fb0d1fd.js';
import { e as e$6, t as t$6, c as c$5 } from './config-71aad884.js';
import { r as r$5 } from './WGLContainer-05217695.js';
import { n as n$6, l as l$3, r as r$7, i as i$5, a as a$4 } from './StyleDefinition-acf40298.js';
import { E as E$2 } from './Container-827a1ce3.js';
import { i as i$6 } from './TileContainer-cfa23ffa.js';
import { s as s$3 } from './PooledRBush-53b32956.js';
import { e as e$8, s as s$4 } from './SourceLayerData-f9d7b557.js';
import { L, l as l$4 } from './StyleRepository-02b3f05f.js';
import { m as m$4, u as u$4 } from './LayerView-6e37772d.js';
import './preload-helper-a4975f27.js';
import './floatRGBA-142dac3d.js';
import './constants-412c3a33.js';
import './definitions-1e43ef7c.js';
import './LabelMetric-0cdfa04c.js';
import './enums-d24bcbbf.js';
import './VertexElementDescriptor-ec2771ab.js';
import './earcut-ba1601b9.js';
import './highlightReasons-37946872.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let e$1 = class e{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new t$5(0,0,e,t));}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new t$5;let i=null,s=-1;for(let h=0;h<this._free.length;++h){const w=this._free[h];e<=w.width&&t<=w.height&&(null===i||w.y<=i.y&&w.x<=i.x)&&(i=w,s=h);}return null===i?new t$5:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new t$5(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new t$5(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new t$5(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new t$5(i.x,i.y+t,e,i.height-t))),new t$5(i.x,i.y,e,t))}release(h){for(let e=0;e<this._free.length;++e){const t=this._free[e];if(t.y===h.y&&t.height===h.height&&t.x+t.width===h.x)t.width+=h.width;else if(t.x===h.x&&t.width===h.width&&t.y+t.height===h.y)t.height+=h.height;else if(h.y===t.y&&h.height===t.height&&h.x+h.width===t.x)t.x=h.x,t.width+=h.width;else {if(h.x!==t.x||h.width!==t.width||h.y+h.height!==t.y)continue;t.y=h.y,t.height+=h.height;}this._free.splice(e,1),this.release(h);}this._free.push(h);}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let n$4 = class n{constructor(e,s,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=s,this._glyphSource=i,this._binPack=new e$1(e-4,s-4),this._glyphData.push(new Uint8Array(e*s)),this._dirties.push(!0),this._textures.push(void 0);}getGlyphItems(s,i){const h=[],r=this._glyphSource,n=new Set,o=1/256;for(const t of i){const e=Math.floor(t*o);n.add(e);}const a=[];return n.forEach((t=>{const e=s+t;if(this._rangePromises.has(e))a.push(this._rangePromises.get(e));else {const i=r.getRange(s,t).then((()=>{this._rangePromises.delete(e);}),(()=>{this._rangePromises.delete(e);}));this._rangePromises.set(e,i),a.push(i);}})),Promise.all(a).then((()=>{let n=this._glyphIndex[s];n||(n={},this._glyphIndex[s]=n);for(const o of i){const i=n[o];if(i){h[o]={sdf:!0,rect:i.rect,metrics:i.metrics,page:i.page,code:o};continue}const a=r.getGlyph(s,o);if(!a?.metrics)continue;const l=a.metrics;let c;if(0===l.width)c=new t$5(0,0,0,0);else {const e=3,s=l.width+2*e,i=l.height+2*e;let h=s%4?4-s%4:4,r=i%4?4-i%4:4;1===h&&(h=5),1===r&&(r=5),c=this._binPack.allocate(s+h,i+r),c.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new e$1(this.width-4,this.height-4),c=this._binPack.allocate(s+h,i+r));const n=this._glyphData[this._currentPage],o=a.bitmap;let g,_;if(o)for(let t=0;t<i;t++){g=s*t,_=this.width*(c.y+t+1)+c.x;for(let t=0;t<s;t++)n[_+t+1]=o.at(g+t);}}n[o]={rect:c,metrics:l,tileIDs:null,page:this._currentPage},h[o]={sdf:!0,rect:c,metrics:l,page:this._currentPage,code:o},this._dirties[this._currentPage]=!0;}return h}))}removeGlyphs(t){for(const e in this._glyphIndex){const s=this._glyphIndex[e];if(!s)continue;let i;for(const e in s)if(i=s[e],i.tileIDs.delete(t),0===i.tileIDs.size){const t=this._glyphData[i.page],h=i.rect;let r,n;for(let e=0;e<h.height;e++)for(r=this.width*(h.y+e)+h.x,n=0;n<h.width;n++)t[r+n]=0;delete s[e],this._dirties[i.page]=!0;}}}bind(t,e,n,o=0){if(!this._textures[n]){const e=new e$2;e.pixelFormat=G.ALPHA,e.wrapMode=D$1.CLAMP_TO_EDGE,e.width=this.width,e.height=this.height,this._textures[n]=new m$3(t,e,new Uint8Array(this.width*this.height));}const a=this._textures[n];a.setSamplingMode(e),this._dirties[n]&&a.setData(this._glyphData[n]),t.bindTexture(a,o),this._dirties[n]=!1;}destroy(){this.dispose();}dispose(){this._glyphData.length=0,this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0;}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let s$1 = class s{constructor(t){if(this._metrics=[],!t)return void(this._allBitmaps=null);const e=new Map;let s=0;for(;t.next();)switch(t.tag()){case 1:{const a=t.getMessage();for(;a.next();)switch(a.tag()){case 3:{const t=a.getMessage();let r,n,i,c,o,g,h;for(;t.next();)switch(t.tag()){case 1:r=t.getUInt32();break;case 2:n=t.getBytes();break;case 3:i=t.getUInt32();break;case 4:c=t.getUInt32();break;case 5:o=t.getSInt32();break;case 6:g=t.getSInt32();break;case 7:h=t.getUInt32();break;default:t.skip();}if(t.release(),r){const t=n?.length??0;this._metrics[r]={width:i,height:c,left:o,top:g,advance:h,startOffset:s,length:t},e.set(r,n),s+=t;}break}default:a.skip();}a.release();break}default:t.skip();}const a=new Uint8Array(s),r=this._metrics;for(const[n,i]of e){const{startOffset:t,length:e}=r[n];if(i)for(let s=0;s<e;++s)a[t+s]=i[s];}this._allBitmaps=a;}getMetrics(t){return this._metrics[t]}getBitmap(t){if(!this._allBitmaps)return;const e=this._metrics[t];if(void 0===e)return;const{startOffset:s,length:a}=e;return 0!==a?new n$3(this._allBitmaps,s,a):void 0}};let a$1 = class a{constructor(){this._ranges=[];}get ranges(){return this._ranges}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e;}};let r$3 = class r{constructor(t){this._glyphInfo={},this._baseURL=t;}getRange(a,r){const n=this._getFontStack(a);if(n.getRange(r))return Promise.resolve();const i=256*r,c=i+255;if(this._baseURL){const o=this._baseURL.replace("{fontstack}",a).replace("{range}",i+"-"+c);return U$1(o,{responseType:"array-buffer"}).then((t=>{n.addRange(r,new s$1(new n$5(new Uint8Array(t.data),new DataView(t.data))));})).catch((()=>{n.addRange(r,new s$1);}))}return n.addRange(r,new s$1),Promise.resolve()}getGlyph(t,e){const s=this._getFontStack(t);if(!s)return;const a=Math.floor(e/256),r=s.getRange(a);return r?{metrics:r.getMetrics(e),bitmap:r.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new a$1),e}};let n$3 = class n{constructor(t,e,s){this._array=t,this._start=e,this.length=s;}at(t){return 0<=t&&t<this.length?this._array[this._start+t]:void 0}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const r$2="dasharray-";let o$2 = class o{constructor(t,e,s=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,(t<=0||e<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,s>0&&(this._maxItemSize=s),this._binPack=new e$1(t-4,e-4);}destroy(){this.dispose();}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const t of this._textures)t&&t.dispose();this._textures.length=0;}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new e$1(this._pageWidth-4,this._pageHeight-4);const t=Math.floor(this._pageWidth),e=Math.floor(this._pageHeight),s=new Uint32Array(t*e);this._mosaicsData[0]=s,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0);}this._sprites=t;}getSpriteItem(t,i=!1){let e,s,h=this._mosaicRects[t];if(h)return h;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;if(t&&t.startsWith(r$2)?([e,s]=this._rasterizeDash(t),i=!0):e=this._sprites.getSpriteInfo(t),!e?.width||!e.height||e.width<0||e.height<0)return null;const a=e.width,o=e.height,[n,_,g]=this._allocateImage(a,o);return n.width<=0?null:(this._copy(n,e,_,g,i,s),h={type:"sprite",rect:n,width:a,height:o,sdf:e.sdf,simplePattern:!1,rasterizationScale:e.pixelRatio,page:_},this._mosaicRects[t]=h,h)}getSpriteItems(t){const i={};for(const e of t)i[e.name]=this.getSpriteItem(e.name,e.repeat);return i}getMosaicItemPosition(t,i){const e=this.getSpriteItem(t,i),s=e&&e.rect;if(!s)return null;s.width=e.width,s.height=e.height;const h=e.width,a=e.height,r=2;return {tl:[s.x+r,s.y+r],br:[s.x+r+h,s.y+r+a],page:e.page}}bind(t,i,e=0,r=0){if(e>=this._size.length||e>=this._mosaicsData.length)return;if(!this._textures[e]){const i=new e$2;i.wrapMode=D$1.CLAMP_TO_EDGE,i.width=this._size[e][0],i.height=this._size[e][1],this._textures[e]=new m$3(t,i,new Uint8Array(this._mosaicsData[e].buffer));}const o=this._textures[e];o.setSamplingMode(i),this._dirties[e]&&o.setData(new Uint8Array(this._mosaicsData[e].buffer)),t.bindTexture(o,r),this._dirties[e]=!1;}static _copyBits(t,i,e,s,h,a,r,o,n,_,g){let c=s*i+e,l=o*a+r;if(g){l-=a;for(let r=-1;r<=_;r++,c=((r+_)%_+s)*i+e,l+=a)for(let i=-1;i<=n;i++)h[l+i]=t[c+(i+n)%n];}else for(let p=0;p<_;p++){for(let i=0;i<n;i++)h[l+i]=t[c+i];c+=i,l+=a;}}_copy(t,i,e,s,h,a){if(!this._sprites||"loaded"!==this._sprites.loadStatus||e>=this._mosaicsData.length)return;const r=new Uint32Array(a?a.buffer:this._sprites.image.buffer),n=this._mosaicsData[e];n&&r||console.error("Source or target images are uninitialized!");const _=2,g=a?i.width:this._sprites.width;o._copyBits(r,g,i.x,i.y,n,s[0],t.x+_,t.y+_,i.width,i.height,h),this._dirties[e]=!0;}_allocateImage(t,s){t+=2,s+=2;const h=Math.max(t,s);if(this._maxItemSize&&this._maxItemSize<h){const i=new t$5(0,0,t,s);return this._mosaicsData.push(new Uint32Array(t*s)),this._dirties.push(!0),this._size.push([t,s]),this._textures.push(void 0),[i,this._mosaicsData.length-1,[t,s]]}let a=t%4?4-t%4:4,r=s%4?4-s%4:4;1===a&&(a=5),1===r&&(r=5);const o=this._binPack.allocate(t+a,s+r);return o.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new e$1(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,s)):[o,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(i){const e=/\[(.*?)\]/,s=i.match(e);if(!s)return null;const h=s[1].split(",").map(Number),a=i.slice(i.lastIndexOf("-")+1),[r,o,n]=i$4(h,a);return [{x:0,y:0,width:o,height:n,sdf:!0,pixelRatio:1},new Uint8Array(r.buffer)]}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let h$4 = class h{constructor(t,e,s,r){this._layer=t,this._styleRepository=e,this.devicePixelRatio=s,this._sourceDataMaxLOD=r,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null;}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=e$3(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null;}get spriteMosaic(){return this._spriteSourcePromise.then((()=>this._spriteMosaic))}get glyphMosaic(){return this._glyphMosaic}async start(t){this._requestSprite(t);const s=this._layer.currentStyleInfo.glyphsUrl,r=new r$3(s?Et(s,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new n$4(1024,1024,r),this._broadcastPromise=p$2("WorkerTileHandler",{client:this,schedule:t.schedule,signal:t.signal}).then((s=>{if(this._layer&&(this._connection?.close(),this._connection=s,this._layer&&!this._connection.closed)){const r=s.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,sourceDataMaxLOD:this._sourceDataMaxLOD},t);Promise.all(r).catch((t=>f$1(t)));}}));}_requestSprite(t){this._spriteSourceAbortController?.abort();const e=new AbortController;this._spriteSourceAbortController=e;const r=t?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,r&&(this._inputSignalEventListener=p$1(e),r.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:i}=e,o={...t,signal:i};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,o),this._spriteSourcePromise.then((t=>{a$2(i),this._spriteMosaic=new o$2(1024,1024,250),this._spriteMosaic.setSpriteSource(t);}));}async updateStyle(t){return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",t)),this._broadcastPromise}setSpriteSource(t){const e=new o$2(1024,1024,250);return e.setSpriteSource(t),this._spriteMosaic=e,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,e}async setStyle(t,e,s){await this._broadcastPromise,this._styleRepository=t,this._sourceDataMaxLOD=s,this._requestSprite();const r=new r$3(this._layer.currentStyleInfo.glyphsUrl?Et(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new n$4(1024,1024,r),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:e,sourceDataMaxLOD:this._sourceDataMaxLOD})),this._broadcastPromise}async fetchTileData(t,e){const s=await this._getRefKeys(t,e);return this._getSourcesData(Object.keys(this._layer.sourceNameToSource),s,e)}async fetchTilePBFs(t){const e=Object.keys(this._layer.sourceNameToSource),s={},r=await this._getRefKeys(t,s),i=[],o=[];for(let n=0;n<r.length;n++)if(null==r[n].value||null==e[n])o.push(null);else {const t=r[n].value,a=this._getTilePayload(t,e[n],s);a.then((e=>{i.push({...e,key:t});})),o.push(a);}return Promise.all(o).then((()=>i))}async parseTileData(t,e){const s=t&&t.data;if(!s)return null;const{sourceName2DataAndRefKey:r,transferList:i}=s;return 0===Object.keys(r).length?null:this._broadcastPromise.then((()=>this._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:r,styleLayerUIDs:t.styleLayerUIDs},{...e,transferList:i})))}async getSprites(t){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(t)}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}async _getTilePayload(t,e,s){const i=e$4.pool.acquire(t.id),o=this._layer.sourceNameToSource[e],{level:n,row:a,col:l}=i;e$4.pool.release(i);try{return {protobuff:await o.requestTile(n,a,l,s),sourceName:e}}catch(c){if(b$1(c))throw c;return {protobuff:null,sourceName:e}}}async _getRefKeys(t,e){const s=this._layer.sourceNameToSource,r=new Array;for(const i in s){const o=s[i].getRefKey(t,e);r.push(o);}return v(r)}_getSourcesData(t,e,s){const r=[];for(let i=0;i<e.length;i++)if(null==e[i].value||null==t[i])r.push(null);else {const o=e[i].value,n=this._getTilePayload(o,t[i],s);r.push(n);}return v(r).then((t=>{const s={},r=[];for(let i=0;i<t.length;i++){const o=t[i].value;if(o&&(o.protobuff&&o.protobuff.byteLength>0)){const t=e[i].value.id;s[o.sourceName]={refKey:t,protobuff:o.protobuff},r.push(o.protobuff);}}return {sourceName2DataAndRefKey:s,transferList:r}}))}};function p$1(t){return ()=>t.abort()}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const r$1=512,n$2=1e-6,a=(e,i)=>e+1/(1<<2*i);let h$3 = class h{constructor(i,t){this._tiles=new Map,this._tileCache=new e$5(40,(e=>e.dispose())),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=i.acquireTile,this.releaseTile=i.releaseTile,this.tileInfoView=i.tileInfoView,this._container=t;}destroy(){for(const[e,i]of this._tiles)i.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null;}update(e){this._updateCacheSize(e);const i=this.tileInfoView,t=i.getTileCoverage(e.state,0,!0,"smallest");if(!t)return !0;const{spans:l,lodInfo:r}=t,{level:n}=r,a=this._tiles,h=new Set,c=new Set;for(const{row:s,colFrom:_,colTo:f}of l)for(let e=_;e<=f;e++){const i=e$4.getId(n,s,r.normalizeCol(e),r.getWorldForColumn(e)),t=this._getOrAcquireTile(i);h.add(i),t.processed()?this._addToContainer(t):c.add(new e$4(i));}for(const[s,o]of a)o.isCoverage=h.has(s);for(const s of c)this._findPlaceholdersForMissingTiles(s,h);let d=!1;for(const[s,o]of a)o.neededForCoverage=h.has(s),o.neededForCoverage||o.isHoldingForFade&&i.intersects(t,o.key)&&h.add(s),o.isFading&&(d=!0);for(const[s,o]of this._tiles)h.has(s)||this._releaseTile(s);return s$2.pool.release(t),!d}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear();}clearCache(){this._tileCache.clear();}getIntersectingTiles(e,s,o,r,n){const a=[0,0],h=[0,0];r.toMap(a,e-o,s+o),r.toMap(h,e+o,s-o);const c=Math.min(a[0],h[0]),d=Math.min(a[1],h[1]),_=Math.max(a[0],h[0]),f=Math.max(a[1],h[1]),T=a$3(c,d,_,f),p=u$2(),u=[];for(const[i,t]of this._visibleTiles)this.tileInfoView.getTileBounds(p,t.key),E(T,p)&&u.push(t);if(null!=n&&n.length>0){const e=new Set(u.map((e=>e.id))),i=n.filter((i=>!e.has(i.tileKey.id))).map((e=>this._visibleTiles.get(e.tileKey.id))).filter((e=>void 0!==e));u.push(...i);}return u}_findPlaceholdersForMissingTiles(e,i){const t=[];for(const[s,o]of this._tiles)this._addPlaceholderChild(t,o,e,i);const l=t.reduce(a,0);Math.abs(1-l)<n$2||this._addPlaceholderParent(e.id,i);}_addPlaceholderChild(e,i,t,l){i.key.level<=t.level||!i.hasData()||d$2(t,i.key)&&(this._addToContainer(i),l.add(i.id),e.push(i.key.level-t.level));}_addPlaceholderParent(e,i){const t=this._tiles;let l=e;for(;;){if(l=c$4(l),!l||i.has(l))return;const e=t.get(l);if(e&&e.hasData())return this._addToContainer(e),void i.add(e.id)}}_getOrAcquireTile(e){let i=this._tiles.get(e);return i||(i=this._tileCache.pop(e),i||(i=this.acquireTile(new e$4(e))),this._tiles.set(e,i),i)}_releaseTile(e){const i=this._tiles.get(e);this.releaseTile(i),this._removeFromContainer(i),this._tiles.delete(e),i.hasData()?this._tileCache.put(e,i,1):i.dispose();}_addToContainer(e){let i;const t=[],l=this._container;if(l.contains(e))return;const s=this._visibleTiles;for(const[o,r]of s)this._canConnectDirectly(e,r)&&t.push(r),null==i&&this._canConnectDirectly(r,e)&&(i=r);if(null!=i){for(const l of t)i.childrenTiles.delete(l),e.childrenTiles.add(l),l.parentTile=e;i.childrenTiles.add(e),e.parentTile=i;}else for(const o of t)e.childrenTiles.add(o),o.parentTile=e;s.set(e.id,e),l.addChild(e);}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),null!=e.parentTile){e.parentTile.childrenTiles.delete(e);for(const i of e.childrenTiles)null!=e.parentTile&&e.parentTile.childrenTiles.add(i);}for(const i of e.childrenTiles)i.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear();}_canConnectDirectly(e,i){const t=e.key;let{level:l,row:s,col:o,world:r}=i.key;const n=this._visibleTiles;for(;l>0;){if(l--,s>>=1,o>>=1,t.level===l&&t.row===s&&t.col===o&&t.world===r)return !0;if(n.has(`${l}/${s}/${o}/${r}`))return !1}return !1}_updateCacheSize(e){const i=e.state.size;if(i[0]===this._viewSize[0]&&i[1]===this._viewSize[1])return;const t=Math.ceil(i[0]/r$1)+1,l=Math.ceil(i[1]/r$1)+1;this._viewSize[0]=i[0],this._viewSize[1]=i[1],this._tileCache.maxSize=5*t*l;}};function c$4(e){const[i,t,l,s]=e.split("/"),o=parseInt(i,10);return 0===o?null:`${o-1}/${parseInt(t,10)>>1}/${parseInt(l,10)>>1}/${parseInt(s,10)}`}function d$2(e,i){const t=i.level-e.level;return e.row===i.row>>t&&e.col===i.col>>t&&e.world===i.world}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let t$4 = class t{constructor(t,s){this.sourceTile=s,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t;}};class s{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
function o$1(t,e,s,o,i,l){const r=s-i;if(r>=0)return (e>>r)+(o-(l<<r))*(t>>r);const n=-r;return e-(l-(o<<n))*(t>>n)<<n}let i$3 = class i{constructor(t,e,s){this._rows=Math.ceil(e/s),this._columns=Math.ceil(t/s),this._cellSize=s,this.cells=new Array(this._rows);for(let o=0;o<this._rows;o++){this.cells[o]=new Array(this._columns);for(let t=0;t<this._columns;t++)this.cells[o][t]=[];}}getCell(t,e){const s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._rows-1),o=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[s]&&this.cells[s][o]||null}getCellSpan(t,e,s,o){return [Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(o/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function l$2(t,e,o,i,l,r,n){const c=e[i++];for(let a=0;a<c;a++){const c=new t$4(r,n);c.xTile=e[i++],c.yTile=e[i++],c.hash=e[i++],c.priority=e[i++],c.featureIndex=e[i++];const a=e[i++];for(let t=0;t<a;t++){const t=e[i++],s=e[i++],l=e[i++],r=e[i++],n=!!e[i++],a=e[i++],h=o[i++],u=o[i++],f=e[i++],m=e[i++];c.colliders.push({xTile:t,yTile:s,dxPixels:l,dyPixels:r,hard:n,partIndex:a,width:f,height:m,minLod:h,maxLod:u});}const h=t[i++];for(let e=0;e<h;e++)c.textVertexRanges.push([t[i++],t[i++]]);const u=t[i++];for(let e=0;e<u;e++)c.iconVertexRanges.push([t[i++],t[i++]]);l.push(c);}return i}function r(t,e,s){for(const[o,i]of t.symbols)n$1(t,e,s,i,o);}function n$1(e,s,o,i,l){const r=e.layerData.get(l);if(r.type===E$1.SYMBOL){for(const t of i){const s=t.unique;let i;if(t.selectedForRendering){const t=s.parts[0],l=t.startOpacity,r=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===r;const n=o?Math.floor(127*l)|r<<7:r?255:0;i=n<<24|n<<16|n<<8|n;}else i=0;for(const[e,o]of t.iconVertexRanges)for(let t=e;t<e+o;t+=4)r.iconOpacity[t/4]=i;if(t.selectedForRendering){const t=s.parts[1],l=t.startOpacity,r=t.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&0===r;const n=o?Math.floor(127*l)|r<<7:r?255:0;i=n<<24|n<<16|n<<8|n;}else i=0;for(const[e,o]of t.textVertexRanges)for(let t=e;t<e+o;t+=4)r.textOpacity[t/4]=i;}r.lastOpacityUpdate=s,r.opacityChanged=!0;}}function c$3(t,s,o,i){const l=t.colliders;let r,n,c,a;for(const h of l){if(t.unique.show&&t.unique.parts[h.partIndex].show&&(r=h.xScreen-i[0]+h.dxScreen,n=h.yScreen-i[1]+h.dyScreen,c=r+h.width,a=n+h.height,w$1(o,s.x,s.y,r,n,c,a)))return !0}return !1}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let h$2 = class h{constructor(t,e){this.layerUIDs=[],this.isDestroyed=!1,this._data=t;let r=1;const n=new Uint32Array(t);this.layerUIDs=[];const s=n[r++];for(let i=0;i<s;i++)this.layerUIDs[i]=n[r++];this.bufferDataOffset=r,e&&(this.layer=e.getStyleLayerByUID(this.layerUIDs[0]));}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0);}prepareForRendering(t){null!=this._data&&(this.doPrepareForRendering(t,this._data,this.bufferDataOffset),this._data=null);}};class f extends h$2{constructor(t,e){super(t,e),this.type=E$1.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.lineIndexStart=r[s++],this.lineIndexCount=r[s++];const i=r[s++];if(i>0){this.patternMap=new Map;for(let t=0;t<i;t++){const t=r[s++],e=r[s++],n=r[s++];this.patternMap.set(t,[e,n]);}}this.bufferDataOffset=s;}get memoryUsed(){return (this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=r$4(this.vao);}doPrepareForRendering(t,e,r){const n=new Uint32Array(e),s=new Int32Array(n.buffer),h=n[r++],f=h$5.createVertex(t,F.STATIC_DRAW,new Int32Array(s.buffer,4*r,h));r+=h;const l=n[r++],c=h$5.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,l));r+=l;const u=this.layer.lineMaterial;this.vao=new o$3(t,u.getAttributeLocations(),u.getLayoutInfo(),{geometry:f},c);}}let l$1 = class l extends h$2{constructor(t,e){super(t,e),this.type=E$1.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.fillIndexStart=r[s++],this.fillIndexCount=r[s++],this.outlineIndexStart=r[s++],this.outlineIndexCount=r[s++];const i=r[s++];if(i>0){this.patternMap=new Map;for(let t=0;t<i;t++){const t=r[s++],e=r[s++],n=r[s++];this.patternMap.set(t,[e,n]);}}this.bufferDataOffset=s;}get memoryUsed(){return (this.data?.byteLength??0)+(this.fillVAO?.usedMemory??0)+(this.outlineVAO?.usedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return (this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=r$4(this.fillVAO),this.outlineVAO=r$4(this.outlineVAO);}doPrepareForRendering(t,e,r){const n=new Uint32Array(e),s=new Int32Array(n.buffer),h=n[r++],f=h$5.createVertex(t,F.STATIC_DRAW,new Int32Array(s.buffer,4*r,h));r+=h;const l=n[r++],c=h$5.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,l));r+=l;const u=n[r++],y=h$5.createVertex(t,F.STATIC_DRAW,new Int32Array(s.buffer,4*r,u));r+=u;const d=n[r++],A=h$5.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,d));r+=d;const I=this.layer,p=I.fillMaterial,g=I.outlineMaterial;this.fillVAO=new o$3(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:f},c),this.outlineVAO=new o$3(t,g.getAttributeLocations(),g.getLayoutInfo(),{geometry:y},A);}};let c$2 = class c extends h$2{constructor(t,e,i){super(t,e),this.type=E$1.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const a=new Uint32Array(t),o=new Int32Array(t),h=new Float32Array(t);let f=this.bufferDataOffset;this.isIconSDF=!!a[f++];const l=a[f++],c=a[f++],u=a[f++],y=new e$4(l,c,u,0),d=a[f++];for(let r=0;r<d;r++){const t=a[f++],e=a[f++],r=a[f++];this.iconPerPageElementsMap.set(t,[e,r]);}const A=a[f++];for(let r=0;r<A;r++){const t=a[f++],e=a[f++],r=a[f++];this.glyphPerPageElementsMap.set(t,[e,r]);}const I=a[f++],p=a[f++];this.iconOpacity=new Int32Array(I),this.textOpacity=new Int32Array(p),f=l$2(a,o,h,f,this.symbols,i,y),this.bufferDataOffset=f;}get memoryUsed(){return (this.data?.byteLength??0)+(this.iconVAO?.usedMemory??0)+(this.textVAO?.usedMemory??0)+A$1(this.iconOpacity)+A$1(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[e,r]of this.iconPerPageElementsMap)t+=r[1];for(const[e,r]of this.glyphPerPageElementsMap)t+=r[1];return t/3}doDestroy(){this.iconVAO=r$4(this.iconVAO),this.textVAO=r$4(this.textVAO);}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,e=this.iconVAO.vertexBuffers.opacity;t.length>0&&t.byteLength===e.usedMemory&&e.setSubData(t,0,0,t.length);const r=this.textOpacity,n=this.textVAO.vertexBuffers.opacity;r.length>0&&r.byteLength===n.usedMemory&&n.setSubData(r,0,0,r.length);}doPrepareForRendering(t,e,r){const n=new Uint32Array(e),s=new Int32Array(n.buffer),h=n[r++],f=h$5.createVertex(t,F.STATIC_DRAW,new Int32Array(s.buffer,4*r,h));r+=h;const l=n[r++],c=h$5.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,l));r+=l;const u=n[r++],y=h$5.createVertex(t,F.STATIC_DRAW,new Int32Array(s.buffer,4*r,u));r+=u;const d=n[r++],A=h$5.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,d));r+=d;const I=h$5.createVertex(t,F.STATIC_DRAW,this.iconOpacity.buffer),p=h$5.createVertex(t,F.STATIC_DRAW,this.textOpacity.buffer),g=this.layer,x=g.iconMaterial,m=g.textMaterial;this.iconVAO=new o$3(t,x.getAttributeLocations(),x.getLayoutInfo(),{geometry:f,opacity:I},c),this.textVAO=new o$3(t,m.getAttributeLocations(),m.getLayoutInfo(),{geometry:y,opacity:p},A);}};let u$1 = class u extends h$2{constructor(t,e){super(t,e),this.type=E$1.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.circleIndexStart=r[s++],this.circleIndexCount=r[s++],this.bufferDataOffset=s;}get memoryUsed(){return (this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=r$4(this.vao);}doPrepareForRendering(t,e,r){const n=new Uint32Array(e),s=new Int32Array(n.buffer),h=n[r++],f=h$5.createVertex(t,F.STATIC_DRAW,new Int32Array(s.buffer,4*r,h));r+=h;const l=n[r++],c=h$5.createIndex(t,F.STATIC_DRAW,new Uint32Array(n.buffer,4*r,l));r+=l;const u=this.layer.circleMaterial;this.vao=new o$3(t,u.getAttributeLocations(),u.getLayoutInfo(),{geometry:f},c);}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let d$1 = class d extends r$5{constructor(e,t,s,a,r,i,o,h=null){super(e,t,s,a,r,i,4096,4096),this.styleRepository=o,this._memCache=h,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this._referenced=1,this.id=e.id;}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<e$6}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<e$6)}get wasRequested(){return "errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0;}deleteLayerData(e){let t=!1;for(const s of e){const e=this.layerData.get(s);e&&(this._memoryUsedByLayerData-=e.memoryUsed,e.type===E$1.SYMBOL&&this.symbols.delete(s)&&(t=!0),e.destroy(),this.layerData.delete(s));}this._memCache?.updateSize(this.key.id,this,this._memoryUsedByLayerData),t&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender();}processed(){return this._processed}hasData(){return this.layerData.size>0}dispose(){"unloaded"!==this.status&&(this.featureIndex=null,m$2.delete(this),d._destroyRenderBuckets(this.layerData),this.layerData.clear(),this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded");}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced;}get referenced(){return this._referenced}get usedMemory(){return this._memoryUsedByLayerData+256}changeDataImpl(e){this.featureIndex?.clear();let t=!1;if(e){const{bucketsWithData:s,emptyBuckets:a}=e,r=this._createRenderBuckets(s);if(a&&a.byteLength>0){const e=new Uint32Array(a);for(const t of e)this._deleteLayerData(t);}for(const[e,o]of r)this._deleteLayerData(e),o.type===E$1.SYMBOL&&(this.symbols.set(e,o.symbols),t=!0),this._memoryUsedByLayerData+=o.memoryUsed,this.layerData.set(e,o);this._memCache?.updateSize(this.key.id,this,this.usedMemory);}this._hasSymbolBuckets=!1;for(const[s,a]of this.layerData)a.type===E$1.SYMBOL&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed");}attachWithContext(e){this.stage={context:e,trashDisplayObject(e){e.processDetach();},untrashDisplayObject:()=>!1};}setTransform(r){super.setTransform(r);const i=this.resolution/(r.resolution*r.pixelRatio),o=this.width/this.rangeX*i,h=this.height/this.rangeY*i,n=[0,0];r.toScreen(n,[this.x,this.y]);const l=this.transforms.tileUnitsToPixels;o$4(l),M(l,l,n),h$6(l,l,Math.PI*r.rotation/180),f$2(l,l,[o,h,1]);}_createTransforms(){return {displayViewScreenMat3:e$7(),tileMat3:e$7(),tileUnitsToPixels:e$7()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const s of e.values())t.has(s)||(s.destroy(),t.add(s));e.clear();}_createRenderBuckets(e){const t=new Map,s=new Map;for(const a of e){const e=this._deserializeBucket(a,s);for(const s of e.layerUIDs)t.set(s,e);}return t}_deserializeBucket(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case E$1.FILL:s=new l$1(e,this.styleRepository);break;case E$1.LINE:s=new f(e,this.styleRepository);break;case E$1.SYMBOL:s=new c$2(e,this.styleRepository,this);break;case E$1.CIRCLE:s=new u$1(e,this.styleRepository);}return t.set(e,s),s}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._memoryUsedByLayerData-=t.memoryUsed,t.destroy(),this.layerData.delete(e);}};const m$2=new Map;

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
function i$2(e,t,n,o,i,l){const{iconRotationAlignment:a,textRotationAlignment:c,iconTranslate:h,iconTranslateAnchor:u,textTranslate:d,textTranslateAnchor:y}=o;let x=0;for(const g of e.colliders){const[e,o]=0===g.partIndex?h:d,m=0===g.partIndex?u:y,f=g.minLod<=l&&l<=g.maxLod;x+=f?0:1,g.enabled=f,g.xScreen=g.xTile*i[0]+g.yTile*i[3]+i[6],g.yScreen=g.xTile*i[1]+g.yTile*i[4]+i[7],m===r$7.MAP?(g.xScreen+=n*e-t*o,g.yScreen+=t*e+n*o):(g.xScreen+=e,g.yScreen+=o),l$3.VIEWPORT===(0===g.partIndex?a:c)?(g.dxScreen=g.dxPixels,g.dyScreen=g.dyPixels):(g.dxScreen=n*(g.dxPixels+g.width/2)-t*(g.dyPixels+g.height/2)-g.width/2,g.dyScreen=t*(g.dxPixels+g.width/2)+n*(g.dyPixels+g.height/2)-g.height/2);}e.colliders.length>0&&x===e.colliders.length&&(e.unique.show=!1);}class l{constructor(o,r,s,i,l,a){this._symbols=o,this._styleRepository=i,this._zoom=l,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new i$3(r,s,t$6),this._si=Math.sin(Math.PI*a/180),this._co=Math.cos(Math.PI*a/180);for(const t of o)for(const n of t.symbols)this._allNeededMatrices.has(n.tile)||this._allNeededMatrices.set(n.tile,r$6(n.tile.transforms.tileUnitsToPixels));}work(e){const t=this._gridIndex;function n(e){const n=e.xScreen+e.dxScreen,o=e.yScreen+e.dyScreen,r=n+e.width,s=o+e.height,[i,l,a,c]=t.getCellSpan(n,o,r,s);for(let h=l;h<=c;h++)for(let e=i;e<=a;e++){const i=t.cells[h][e];for(const e of i){const t=e.xScreen+e.dxScreen,i=e.yScreen+e.dyScreen,l=t+e.width,a=i+e.height;if(!(r<t||n>l||s<i||o>a))return !0}}return !1}const o=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const t=this._symbols[this._currentLayerCursor],r=this._getProperties(t.styleLayerUID);for(;this._currentSymbolCursor<t.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-o>e)return !1;const s=t.symbols[this._currentSymbolCursor];if(!s.unique.show)continue;i$2(s,this._si,this._co,r,this._allNeededMatrices.get(s.tile),this._zoom);const l=s.unique;if(!l.show)continue;const{iconAllowOverlap:a,iconIgnorePlacement:c,textAllowOverlap:h,textIgnorePlacement:u}=r;for(const e of s.colliders){if(!e.enabled)continue;const t=l.parts[e.partIndex];if(!t.show)continue;!(e.partIndex?h:a)&&n(e)&&(e.hard?l.show=!1:t.show=!1);}if(l.show)for(const e of s.colliders){if(!e.enabled)continue;if(e.partIndex?u:c)continue;if(!l.parts[e.partIndex].show)continue;const t=e.xScreen+e.dxScreen,n=e.yScreen+e.dyScreen,o=t+e.width,r=n+e.height,[s,i,a,h]=this._gridIndex.getCellSpan(t,n,o,r);for(let l=i;l<=h;l++)for(let t=s;t<=a;t++){this._gridIndex.cells[l][t].push(e);}}}}return !0}_getProperties(e){const t=this._styleProps.get(e);if(t)return t;const n=this._zoom,s=this._styleRepository.getStyleLayerByUID(e),i=s.getLayoutValue("symbol-placement",n)!==n$6.POINT;let l=s.getLayoutValue("icon-rotation-alignment",n);l===l$3.AUTO&&(l=i?l$3.MAP:l$3.VIEWPORT);let a=s.getLayoutValue("text-rotation-alignment",n);a===l$3.AUTO&&(a=i?l$3.MAP:l$3.VIEWPORT);const c=s.getPaintValue("icon-translate",n),h=s.getPaintValue("icon-translate-anchor",n),u=s.getPaintValue("text-translate",n),d=s.getPaintValue("text-translate-anchor",n),y={iconAllowOverlap:s.getLayoutValue("icon-allow-overlap",n),iconIgnorePlacement:s.getLayoutValue("icon-ignore-placement",n),textAllowOverlap:s.getLayoutValue("text-allow-overlap",n),textIgnorePlacement:s.getLayoutValue("text-ignore-placement",n),iconRotationAlignment:l,textRotationAlignment:a,iconTranslateAnchor:h,iconTranslate:c,textTranslateAnchor:d,textTranslate:u};return this._styleProps.set(e,y),y}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
function t$3(o,t){if(o.priority-t.priority)return o.priority-t.priority;const e=o.tile.key,i=t.tile.key;return e.world-i.world?e.world-i.world:e.level-i.level?e.level-i.level:e.row-i.row?e.row-i.row:e.col-i.col?e.col-i.col:o.xTile-t.xTile?o.xTile-t.xTile:o.yTile-t.yTile}class e{get running(){return this._running}constructor(o,t,e,i,s,n){this._visibleTiles=o,this._symbolRepository=t,this._createCollisionJob=e,this._assignTileSymbolsOpacity=i,this._symbolLayerSorter=s,this._isLayerVisible=n,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0;}setScreenSize(o,t){this._screenWidth===o&&this._screenHeight===t||this.restart(),this._screenWidth=o,this._screenHeight=t;}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0;}continue(o){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const t=performance.now();if(!this._selectionJob.work(o))return !1;if(this._selectionJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-t))))return !1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const t=performance.now();if(!this._collisionJob.work(o))return !1;if(this._collisionJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-t))))return !1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const t=performance.now();if(!this._opacityJob.work(o))return !1;if(this._opacityJobCompleted=!0,0===(o=Math.max(0,o-(performance.now()-t))))return !1}return this._running=!1,!0}_createSelectionJob(){const o=this._symbolRepository.uniqueSymbols;for(let t=0;t<o.length;t++){const e=o[t];for(let o=0;o<e.uniqueSymbols.length;o++){const t=e.uniqueSymbols[o];for(const o of t.tileSymbols)o.selectedForRendering=!1;}}const e=[];let i=0,s=0;const n=this._isLayerVisible;function r(r){let l;const c=performance.now();for(;s<o.length;s++,i=0){const t=o[s],h=t.styleLayerUID;if(!n(h)){e[s]||(e[s]={styleLayerUID:h,symbols:[]});continue}e[s]=e[s]||{styleLayerUID:h,symbols:[]};const a=e[s];for(;i<t.uniqueSymbols.length;i++){if(l=t.uniqueSymbols[i],i%100==99&&performance.now()-c>r)return !1;let o=null,e=!1,s=!1;for(const t of l.tileSymbols)if(!s||!e){const i=t.tile;(!o||i.isCoverage||i.neededForCoverage&&!e)&&(o=t,(i.neededForCoverage||i.isCoverage)&&(s=!0),i.isCoverage&&(e=!0));}if(o.selectedForRendering=!0,s){a.symbols.push(o),l.show=!0;for(const o of l.parts)o.show=!0;}else l.show=!1;}}for(const o of e)o.symbols.sort(t$3);return !0}const l=this._symbolLayerSorter;return {work:r,get sortedSymbols(){return e.sort(l)}}}_createOpacityJob(){const o=this._assignTileSymbolsOpacity,t=this._visibleTiles;let e=0;function s(t,e){const n=t.symbols;for(const[o,s]of n)i$1(s,e);o(t,e);for(const o of t.childrenTiles)s(o,e);}return {work(o){const i=performance.now();for(;e<t.length;e++){if(performance.now()-i>o)return !1;const n=t[e];if(null!=n.parentTile)continue;s(n,performance.now());}return !0}}}}function i$1(t,e){for(const i of t){const t=i.unique;for(const i of t.parts){const s=i.targetOpacity>.5?1:-1;i.startOpacity+=s*((e-i.startTime)/e$6),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=e,i.targetOpacity=t.show&&i.show?1:0;}}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const o=32,t$2=8,i=64;class n{constructor(e,s,l){this.tileCoordRange=e,this._visibleTiles=s,this._createUnique=l,this._tiles=new Map,this._uniqueSymbolsReferences=new Map;}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(s,l){this._uniqueSymbolLayerArray=null;let n=this._tiles.get(s.id);n||(n={symbols:new Map},this._tiles.set(s.id,n));const r=new Map;if(l)for(const e of l)n.symbols.has(e)&&(r.set(e,n.symbols.get(e)),n.symbols.delete(e));else for(const[e,o]of s.layerData)n.symbols.has(e)&&(r.set(e,n.symbols.get(e)),n.symbols.delete(e));this._removeSymbols(r);const y=s.symbols,a=new Map;for(const[f,u]of y){let s=u.length;if(s>=o){let l=this.tileCoordRange;do{l/=2,s/=4;}while(s>t$2&&l>i);const o=new i$3(this.tileCoordRange,this.tileCoordRange,l);a.set(f,{flat:u,index:o}),n.symbols.set(f,{flat:u,index:o});for(const e of u)o.getCell(e.xTile,e.yTile).push(e);}else a.set(f,{flat:u}),n.symbols.set(f,{flat:u});}this._addSymbols(s.key,y);}deleteStyleLayers(e){this._uniqueSymbolLayerArray=null;for(const[s,l]of this._tiles){const o=new Map;for(const s of e)l.symbols.has(s)&&(o.set(s,l.symbols.get(s)),l.symbols.delete(s));this._removeSymbols(o),0===l.symbols.size&&this._tiles.delete(s);}}removeTile(e){this._uniqueSymbolLayerArray=null;const s=this._tiles.get(e.id);if(!s)return;const l=new Map;for(const[o,t]of e.symbols)s.symbols.has(o)&&(l.set(o,s.symbols.get(o)),s.symbols.delete(o));this._removeSymbols(l),0===s.symbols.size&&this._tiles.delete(e.id);}querySymbols(e,l,o,t){const i=[],n=this.uniqueSymbols;for(const r of n){const t=r.styleLayerUID,n=r.uniqueSymbols;for(const r of n){const n=r.tileSymbols.find((e=>e.selectedForRendering));n&&c$3(n,e,l*(window.devicePixelRatio||1),o)&&i.push({vtlSymbol:n,styleLayerUID:t,tileKey:n.tile.key});}}return i}_removeSymbols(e){for(const[s,{flat:l}]of e)for(const e of l){const l=e.unique,o=l.tileSymbols,t=o.length-1;for(let s=0;s<t;s++)if(o[s]===e){o[s]=o[t];break}if(o.length=t,0===t){const e=this._uniqueSymbolsReferences.get(s);e.delete(l),0===e.size&&this._uniqueSymbolsReferences.delete(s);}e.unique=null;}}_addSymbols(e,s){if(0===s.size)return;const l=this._visibleTiles;for(const o of l)o.parentTile||o.key.world!==e.world||o.key.level===e.level&&!o.key.equals(e)||this._matchSymbols(o,e,s);for(const[o,t]of s)for(const e of t)if(null==e.unique){const s=this._createUnique();e.unique=s,s.tileSymbols.push(e);let l=this._uniqueSymbolsReferences.get(o);l||(l=new Set,this._uniqueSymbolsReferences.set(o,l)),l.add(s);}}_matchSymbols(e,s,o){if(e.key.level>s.level){const l=e.key.level-s.level;if(e.key.row>>l!==s.row||e.key.col>>l!==s.col)return}if(s.level>e.key.level){const l=s.level-e.key.level;if(s.row>>l!==e.key.row||s.col>>l!==e.key.col)return}if(s.equals(e.key)){for(const l of e.childrenTiles)this._matchSymbols(l,s,o);return}const t=new Map;for(const[i,n]of o){const o=[];for(const t of n){const i=o$1(this.tileCoordRange,t.xTile,s.level,s.col,e.key.level,e.key.col),n=o$1(this.tileCoordRange,t.yTile,s.level,s.row,e.key.level,e.key.row);i>=0&&i<this.tileCoordRange&&n>=0&&n<this.tileCoordRange&&o.push({symbol:t,xTransformed:i,yTransformed:n});}const r=[],y=e.key.level<s.level?1:1<<e.key.level-s.level,a=this._tiles.get(e.id).symbols.get(i);if(a){const e=a.flat;for(const s of o){let l,o=!1;const t=s.xTransformed,i=s.yTransformed;l=null!=a.index?a.index.getCell(t,i):e;const n=s.symbol,f=n.hash;for(const e of l)if(f===e.hash&&Math.abs(t-e.xTile)<=y&&Math.abs(i-e.yTile)<=y){const s=e.unique;n.unique=s,s.tileSymbols.push(n),o=!0;break}o||r.push(n);}}r.length>0&&t.set(i,r);}for(const l of e.childrenTiles)this._matchSymbols(l,s,t);}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsReferences,s=new Array(e.size);let l,o=0;for(const[t,i]of e){const e=new Array(i.size);l=0;for(const s of i)e[l++]=s;s[o]={styleLayerUID:t,uniqueSymbols:e},o++;}return s}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const c$1=.5,h$1=1e-6;class _{constructor(e$1,i){this.styleRepository=e$1,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=r$8(!1),this._symbolRepository=new n(4096,i,(()=>new s)),this._symbolDeclutterer=new e(i,this._symbolRepository,((t,e,i)=>this._createCollisionJob(t,e,i)),((t,e)=>{t.allSymbolsFadingOut=!0,t.lastOpacityUpdate=e,r(t,e,!0),t.decluttered=!0,t.requestRender();}),((t,e)=>this.styleRepository.getStyleLayerByUID(t.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(e.styleLayerUID).z),(t=>{const e=this.styleRepository.getStyleLayerByUID(t);if(this._zoom+h$1<e.minzoom||this._zoom-h$1>=e.maxzoom)return !1;const i=e.getLayoutProperty("visibility");return !i||i.getValue()!==i$5.NONE}));}get symbolRepository(){return this._symbolRepository}_createCollisionJob(t,e,i){return this.updateDecluttererViewState(),new l(t,e,i,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",(()=>{this._symbolRepository.add(t),this.restartDeclutter();}))),this._symbolRepository.add(t),this.restartDeclutter();}removeTile(t){const e=this._tileToHandle.get(t);e&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),e.remove(),this._tileToHandle.delete(t));}update(t,e){this._zoom=t,this._viewState={scale:e.scale,rotation:e.rotation,center:[e.center[0],e.center[1]],size:[e.size[0],e.size[1]]};const i=[0,0];e.toScreen(i,e.center);const s=[0,0];return e.toScreen(s,this._declutterViewState.center),this._offsetFromScreenCenter[0]=i[0]-s[0],this._offsetFromScreenCenter[1]=i[1]-s[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable();}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach((t=>t.remove())),this._tileToHandle.clear();}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t);}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(c$5),this._completed&&this._scheduleNotifyStable());}_scheduleNotifyStable(){null!=this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout((()=>{this._stableNotificationHandle=null,this._fading.value=!1;}),(1+c$1)*e$6);}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0;}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
let t$1 = class t extends r$5{_createTransforms(){return {displayViewScreenMat3:e$7(),tileMat3:e$7()}}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const y$1=1e-6;function p(e,t){if(e){const s=e.getLayoutProperty("visibility");if(!s||s.getValue()!==i$5.NONE&&(void 0===e.minzoom||e.minzoom<t+y$1)&&(void 0===e.maxzoom||e.maxzoom>=t-y$1))return !0}return !1}let m$1 = class m extends i$6{constructor(e){super(e),this._backgroundTiles=[],this._computeDisplayInfoView(e);}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[];}get fading(){return this._symbolFader?.fading??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){return this._symbolFader?.symbolRepository}setStyleResources(e,t,r,i){this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=r,this._tileInfoView=i,this._computeDisplayInfoView(i),null==this._symbolFader&&(this._symbolFader=new _(this._styleRepository,this.children)),this._symbolFader.styleRepository=r;}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e;}deleteStyleLayers(e){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(e);}createRenderParams(e){return {...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==E$2.MAP&&e.drawPhase!==E$2.DEBUG||void 0===this._spriteMosaic||super.doRender(e);}addChild(e){return super.addChild(e),null!=this._symbolFader?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return null!=this._symbolFader&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;t!==E$2.DEBUG?this._doRender(e):super.renderChildren(e);}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];null!=this._symbolFader&&this._symbolFader.removeTile(t),t.dispose();}super.removeAllChildren();}getStencilTarget(){return this.children.filter((e=>e.neededForCoverage&&e.hasData()))}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter();}_doRender(e){const{context:t,state:s}=e,r=this._styleRepository;if(!r)return;const i=r.layers,o=this._displayInfo.scaleToZoom(s.scale);r.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,r.backgroundBucketIds,o)),super.renderChildren(e),e.drawPhase===E$2.MAP&&this._fade(o,s);const n=this.children.filter((e=>e.visible&&e.hasData()));if(!n||0===n.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const l of n)l.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(I$1.KEEP,I$1.KEEP,I$1.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(O.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let l=i.length-1;l>=0;l--)this._renderStyleLayer(i[l],e,n);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(R.ONE,R.ONE_MINUS_SRC_ALPHA,R.ONE,R.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let l=0;l<i.length;l++)this._renderStyleLayer(i[l],e,n);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0);for(const l of n)l.debugInfo.display.triangleCount=l.triangleCount;}_fade(e,t){null!=this._symbolFader&&(this._symbolFader.update(e,t)||this.requestRender());}_renderStyleLayer(e,t,s){const{displayLevel:l,painter:o,renderPass:n}=t;if(void 0===e)return;const a=e.getLayoutProperty("visibility");if(a&&a.getValue()===i$5.NONE)return;let d;switch(e.type){case a$4.BACKGROUND:return;case a$4.FILL:if("opaque"!==n&&"translucent"!==t.renderPass)return;d="vtlFill";break;case a$4.LINE:if("translucent"!==n)return;d="vtlLine";break;case a$4.CIRCLE:if("translucent"!==n)return;d="vtlCircle";break;case a$4.SYMBOL:if("translucent"!==n)return;d="vtlSymbol";}if(s=e.type===a$4.SYMBOL?s.filter((e=>e.decluttered)):s.filter((e=>e.neededForCoverage)),"vtlSymbol"!==d&&(0===s.length||void 0!==e.minzoom&&e.minzoom>=l+y$1||void 0!==e.maxzoom&&e.maxzoom<l-y$1))return;const h=e.uid;t.styleLayerUID=h,t.styleLayer=e;for(const r of s)if(r.layerData.has(h)){o.renderObjects(t,s,d);break}}_renderBackgroundLayers(t,s,r){const{context:l,painter:n,state:u}=t,y=this._styleRepository;let m=!1;for(const e of s){if(y.getLayerById(e).type===a$4.BACKGROUND&&p(y.getLayerById(e),r)){m=!0;break}}if(!m)return;const f=this._tileInfoView,g=f.getTileCoverage(t.state,0,!0,"smallest"),{spans:_,lodInfo:b}=g,{level:E}=b,C=u$2(),F=[];if(this._renderPasses){const e=this._renderPasses[0];null!=this._clippingInfos&&(e.brushes[0].prepareState(t),e.brushes[0].drawMany(t,this._clippingInfos));}const L=this._backgroundTiles;let R,v=0;for(const{row:i,colFrom:a,colTo:h}of _)for(let t=a;t<=h;t++){if(v<L.length)R=L[v],R.key.set(E,i,b.normalizeCol(t),b.getWorldForColumn(t)),f.getTileBounds(C,R.key,!1),R.x=C[0],R.y=C[3],R.resolution=f.getTileResolution(E);else {const s=new e$4(E,i,b.normalizeCol(t),b.getWorldForColumn(t)),r=f.getTileBounds(u$2(),s),l=f.getTileResolution(E);R=new t$1(s,l,r[0],r[3],512,512,4096,4096),L.push(R);}R.setTransform(u),F.push(R),v++;}l.setStencilWriteMask(0),l.setColorMask(!0,!0,!0,!0),l.setStencilOp(I$1.KEEP,I$1.KEEP,I$1.REPLACE),l.setStencilFunction(O.EQUAL,0,255),l.setStencilTestEnabled(!0);for(const e of s){const s=y.getLayerById(e);s.type===a$4.BACKGROUND&&p(s,r)&&(t.styleLayerUID=s.uid,t.styleLayer=s,n.renderObjects(t,F,"vtlBackground"));}s$2.pool.release(g);}_computeDisplayInfoView(e){let s=e.tileInfo.lods[0].scale;const r=Math.max(25,e.tileInfo.lods.length),i=[];for(let t=0;t<=r;t++)i.push(s),s/=2;this._displayInfo=j$1.create({scales:i,size:512,spatialReference:e.spatialReference,numLODs:r});}};

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const y=8,c=512,u=4096,h=(e,t)=>{const s=e.vtlSymbol.sourceTile,r=t.vtlSymbol.sourceTile;return s.level!==r.level?s.level-r.level:s.row!==r.row?s.row-r.row:s.col!==r.col?s.col-r.col:e.styleLayerUID-t.styleLayerUID};class d{constructor(e,t,s,r,i){this.tileKey=e,this._index=null,this._styleRepository=null,this._tileHandler=null,this._tileKeyToPBF=new Map,this._tileLayerData=t,this._styleRepository=s,this._tileHandler=r,this._parentLayer=i;}static create(e,t,s,r,i){return new d(e,t,s,r,i)}clear(){this._index?.clear(),this._tileKeyToPBF.clear();}async queryAttributes(e,t,s,i,l){if(0===this._tileLayerData.size||!this._styleRepository||!this._tileHandler)return [];null===this._index&&(this._index=new s$3(100,m),await this._indexLayers());const o=[];return this._queryIndex(o,e,t,s,this.tileKey.level,i),l&&l?.length>0&&await this._getSymbolsAttributes(o,l),o}async _indexLayers(){const e=this.tileKey,t=this._styleRepository.layers,s=await this._getTilePayload(e);for(const[r,l]of this._tileLayerData){const o=t[r],n=s.find((e=>e.sourceName===o.source));if(!n)continue;const{protobuff:a,key:y}=n;if(l.type!==E$1.SYMBOL){const t=1<<e.level-y.level,s=e.row-y.row*t,r=e.col-y.col*t;this._indexLayer(o,a,e.level,t,s,r);}}}_indexLayer(e,t,r,i,y,h){const d=e.sourceLayer,m=e.getFeatureFilter(),f=r,_=r+1,p=d$3(f),g=new n$5(new Uint8Array(t),new DataView(t));for(;g.next();)switch(g.tag()){case 3:{const t=g.getMessage(),s=new e$8(t);if(t.release(),s.name!==d)continue;const o=s.getData(),w=s.extent/i,x=w*h-p,b=w*y-p,I=x+w+2*p,L$1=b+w+2*p,v=w/c,D=u/w,T=w*h,S=w*y;for(;o.nextTag(2);){const t=o.getMessage(),i=new s$4(t,s);if(t.release(),m&&!m.filter(i,r))continue;const n=i.values||{},y=n._minzoom,c=n._maxzoom;if(y&&y>=10*_||c&&c<=10*f)continue;const u=e.getFeatureInflatedBounds(i,f,s.extent,v);null==u||u[0]>I||u[1]>L$1||u[2]<x||u[3]<b||(u[0]=(u[0]-T)*D,u[1]=(u[1]-S)*D,u[2]=(u[2]-T)*D,u[3]=(u[3]-S)*D,this._index.insert(new L(e,i,u,D,T,S)));}break}default:g.skip();}}async _getSymbolsAttributes(e,t){if(!t||0===t.length)return e;const s=[];t.sort(h);let r=t[0].styleLayerUID,i=0;for(let a=0;a<t.length;a++)r!==t[a].styleLayerUID&&(s.push({from:i,to:a,styleLayerUID:r,sourceTileKey:t[a].vtlSymbol.sourceTile}),i=a,r=t[a].styleLayerUID);s.push({from:i,to:t.length,styleLayerUID:r,sourceTileKey:t[t.length-1].vtlSymbol.sourceTile});const l=this._styleRepository.layers;let o,n=null;for(const a of s){const s=await this._getTilePayload(a.sourceTileKey);o=l[a.styleLayerUID],n=!!o&&s.find((e=>e.sourceName===o.source)),n&&this._addSymbolsAttributes(e,t.slice(a.from,a.to).map((e=>e.vtlSymbol)),r,n);}return e}_addSymbolsAttributes(t,s,r,i){const l=this._styleRepository.layers,o=i.key,n=this.tileKey,a=1<<n.level-o.level,y=n.row-o.row*a,c=n.col-o.col*a;this._getSymbolAttributes(i.protobuff,s,r,a,y,c).forEach((s=>{const{attributes:i,tilePoint:o}=s;t.push({layerId:l[r].id,layerIndex:r,graphic:new c$6({attributes:i,origin:{type:"vector-tile",layerId:l[r].id,layerIndex:r,layer:this._parentLayer}}),tilePoint:o});}));}_getSymbolAttributes(e,t,r,i,o,a){const y=[],c=this._styleRepository.layers;let h=0;t.sort(((e,t)=>e.featureIndex-t.featureIndex));const d=new n$5(new Uint8Array(e),new DataView(e));for(;d.next();)switch(d.tag()){case 3:{const e=d.getMessage(),s=new e$8(e);if(e.release(),s.name!==c[r].sourceLayer)continue;const m=s.getData(),f=s.extent/i,_=u/f,p=f*a,g=f*o;let w=0;for(;m.nextTag(2);){const e=m.getMessage();if(w++===t[h].featureIndex){const t=new s$4(e,s),r=t.values,i=t.getGeometry(),o=null!=i?[_*(i[0][0].x-p),_*(i[0][0].y-g)]:null;y.push({attributes:r,tilePoint:o}),h++;}if(e.release(),h===t.length)return y}break}default:d.skip();}return y}_queryIndex(t,s,r,i,l,o){const n=y*i*(window.devicePixelRatio||1);return this._index?.search({minX:s-n,minY:r-n,maxX:s+n,maxY:r+n},(n=>{const{layer:a,feature:y}=n;a.isIntersectingFeature(s,r,i,y,l,o,n)&&t.push({layerId:a.id,layerIndex:a.uid,tilePoint:null,graphic:new c$6({attributes:y.values,origin:{type:"vector-tile",layerId:n.layer.id,layerIndex:n.layer.uid,layer:this._parentLayer}})});})),t}async _getTilePayload(e){return r$9(this._tileKeyToPBF,e.id,(()=>this._tileHandler.fetchTilePBFs(e))).then((e=>e))}}const m=e=>({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]});

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
class t extends h$7{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={};}getTileParentId(e){const l=e$4.pool.acquire(e),t=0===l.level?null:e$4.getId(l.level-1,l.row>>1,l.col>>1,l.world);return e$4.pool.release(l),t}getTileCoverage(e,l,s=!0,t){const o=super.getTileCoverage(e,l,s,t);if(!o)return o;const i=1<<o.lodInfo.level;return o.spans=o.spans.filter((e=>e.row>=0&&e.row<i)),o}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{const l=this._fullCacheLodInfos;if(e>l[0].scale)return l[0].level;let s,t;for(let o=0;o<l.length-1;o++)if(t=l[o+1],e>t.scale)return s=l[o],s.level+(s.scale-e)/(s.scale-t.scale);return l[l.length-1].level}}_initializeFullCacheLODs(l){let s;if(0===l[0].level)s=l.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})));else {const l=this.tileInfo.size[0],t=this.tileInfo.spatialReference;s=j$1.create({size:l,spatialReference:t}).lods.map((e=>({level:e.level,resolution:e.resolution,scale:e.scale})));}for(let e=0;e<s.length;e++)this._levelByScale[s[e].scale]=s[e].level;this._fullCacheLodInfos=s;}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.29/esri/copyright.txt for details.
*/
const w=2,I=8,D=512;let S=class extends(m$4(u$4)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1;}get fading(){return this._vectorTileContainer?.fading??!1}async hitTest(e,t){const i=this._tileHandlerPromise,s=this._vectorTileContainer?.symbolFader;if(!i||!this._isTileHandlerReady||!s)return;await i;let r=null;const a=this._vectorTileContainer?.symbolRepository;a&&(r=a.querySymbols(t,w,s.decluttererOffset,{}));const l=this.view.state,n=this._tileManager.getIntersectingTiles(t.x,t.y,w,l,r);if((!n||0===n.length)&&0===r?.length)return null;e=e.clone().normalize();const o=[],h=[];for(const y of n)o.push(this._queryTile(h,e,w,this.view.state.rotation,y,r?.filter((e=>e.tileKey.id===y.id))));return await Promise.all(o),h}update(e){if(this._tileHandlerPromise&&this._isTileHandlerReady)return e.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=e.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=e.state,this._parseQueue.state=e.state,this._tileManager.update(e)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:e}=this.layer.currentStyleInfo;this._styleRepository=new l$4(e),this._tileInfoView=new t(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new m$1(this._tileInfoView),this._tileHandler=new h$4(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",(e=>{if(e.isDataDriven)this._styleChanges.push({type:I$2.PAINTER_CHANGED,data:e}),this.requestUpdate();else {const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const s=i.type===a$4.SYMBOL;t.setPaintProperties(e.layer,e.paint),s&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender();}})),this.layer.on("layout-change",(e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const s=m$5(i.layout,e.layout);if(null!=s){if(p$3(s,"visibility")&&1===P(s))return t.setLayoutProperties(e.layer,e.layout),i.type===a$4.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:I$2.LAYOUT_CHANGED,data:e}),this.requestUpdate();}})),this.layer.on("style-layer-visibility-change",(e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);i&&(t.setStyleLayerVisibility(e.layer,e.visibility),i.type===a$4.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender());})),this.layer.on("style-layer-change",(e=>{this._styleChanges.push({type:I$2.LAYER_CHANGED,data:e}),this.requestUpdate();})),this.layer.on("delete-style-layer",(e=>{this._styleChanges.push({type:I$2.LAYER_REMOVED,data:e}),this.requestUpdate();})),this.layer.on("load-style",(()=>this._loadStyle())),this.layer.on("spriteSource-change",(e=>{this._styleChanges.push({type:I$2.SPRITES_CHANGED,data:e});const t=this._styleRepository.layers;for(const i of t)switch(i.type){case a$4.SYMBOL:i.getLayoutProperty("icon-image")&&this._styleChanges.push({type:I$2.LAYOUT_CHANGED,data:{layer:i.id,layout:i.layout}});break;case a$4.LINE:i.getPaintProperty("line-pattern")&&this._styleChanges.push({type:I$2.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});break;case a$4.FILL:i.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:I$2.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});}this.requestUpdate();}))]);}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=u$3(this._vectorTileContainer),this._tileHandler=u$3(this._tileHandler);}moveStart(){this.requestUpdate();}viewChange(){this.requestUpdate();}moveEnd(){this.requestUpdate();}supportsSpatialReference(e){return G$1(this.layer.tileInfo?.spatialReference,e)}canResume(){let e=super.canResume();const{currentStyleInfo:t}=this.layer;if(e&&t?.layerDefinition){const i=this.view.scale,{minScale:s,maxScale:r}=t.layerDefinition;t?.layerDefinition&&(s&&s<i&&(e=!1),r&&r>i&&(e=!1));}return e}isUpdating(){return this.fading}acquireTile(e){const t=this._createVectorTile(e);return this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then((e=>this._parseQueue.push({key:t.key,data:e}))).then((e=>{t.once("attach",(()=>this.requestUpdate())),t.setData(e),this.requestUpdate();})).catch((e=>{b$1(e)||s$5.getLogger(this).error(e);}))),t}releaseTile(e){const t=e.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate();}_start(){if(this._stop(),this._tileManager=new h$3({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const e=new AbortController,t=this._tileHandler.start({signal:e.signal}).then((()=>{this._fetchQueue=new m$6({tileInfoView:this._tileInfoView,process:(e,t)=>this._getTileData(e,t),concurrency:15}),this._parseQueue=new m$6({tileInfoView:this._tileInfoView,process:(e,t)=>this._parseTileData(e,t),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0;}));this._tileHandler.spriteMosaic.then((e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate();})),this._tileHandlerAbortController=e,this._tileHandlerPromise=t;}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const e=this._tileHandlerAbortController;e&&e.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=u$3(this._fetchQueue),this._parseQueue=u$3(this._parseQueue),this._tileManager=u$3(this._tileManager),this._vectorTileContainer.removeAllChildren();}async _getTileData(e,t){return this._tileHandler.fetchTileData(e,t)}async _parseTileData(e,t){return this._tileHandler.parseTileData(e,t)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._tileManager.clearCache();const e=this._styleChanges;try{await this._tileHandler.updateStyle(e);}catch(l){s$5.getLogger(this).error("error applying vector-tiles style update",l.message),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0;}const t=this._styleRepository,s=new Set;e.forEach((e=>{if(e.type!==I$2.LAYER_REMOVED)return;const i=e.data,r=t.getLayerById(i.layer);r&&s.add(r.uid);}));const r=new Set;e.forEach((e=>{let i;switch(e.type){case I$2.PAINTER_CHANGED:t.setPaintProperties(e.data.layer,e.data.paint),i=e.data.layer;break;case I$2.LAYOUT_CHANGED:t.setLayoutProperties(e.data.layer,e.data.layout),i=e.data.layer;break;case I$2.LAYER_REMOVED:return void t.deleteStyleLayer(e.data.layer);case I$2.LAYER_CHANGED:t.setStyleLayer(e.data.layer,e.data.index),i=e.data.layer.id;break;case I$2.SPRITES_CHANGED:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(e.data.spriteSource));}if(i){const e=t.getLayerById(i);e&&r.add(e.uid);}}));const a=this._vectorTileContainer.children;if(s.size>0){const e=Array.from(s);this._vectorTileContainer.deleteStyleLayers(e);for(const t of a)t.deleteLayerData(e);}if(this._fetchQueue.resume(),this._parseQueue.resume(),r.size>0){const e=Array.from(r),t=[];for(const i of a){const s=this._updatingHandles.addPromise(this._fetchQueue.push(i.key).then((t=>this._parseQueue.push({key:i.key,data:t,styleLayerUIDs:e}))).then((e=>i.setData(e))));t.push(s);}await Promise.all(t);}this._styleChanges=[],this._isTileHandlerReady=!0,this.requestUpdate();}async _loadStyle(){const{style:e}=this.layer.currentStyleInfo,i=a$5(e);this._isTileHandlerReady=!1,this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.clear(),this._parseQueue.clear(),this._styleRepository=new l$4(i),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:s}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,i,this.layer.tileInfo.lods.length-1),await this._tileHandlerPromise;}catch(n){if(!b$1(n))throw n}if(s.aborted)return this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,void this.requestUpdate();const a=await this._tileHandler.spriteMosaic,l=this._vectorTileContainer;this._tileInfoView=new t(this.layer.tileInfo,this.layer.fullExtent),l.setStyleResources(a,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this._tileManager=new h$3({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),this._fetchQueue.resume(),this._parseQueue.resume(),this._isTileHandlerReady=!0,this.requestUpdate();}_createVectorTile(e){const t=this._tileInfoView.getTileBounds(u$2(),e),i=this._tileInfoView.getTileResolution(e.level);return new d$1(e,i,t[0],t[3],512,512,this._styleRepository)}async _queryTile(e,t,i,s,r,a){if(0===r.layerData.size)return;const l=this._ensureTileIndex(r),n=this._tileInfoView.getTileBounds(u$2(),r.key,!0),o=I*D*((t.x-n[0])/(n[2]-n[0])),h=I*D*(1-(t.y-n[1])/(n[3]-n[1])),u=await l.queryAttributes(o,h,i,s,a);for(const y of u)y.graphic.geometry=this._tileToMapPoint(y.tilePoint,r.transforms.tileUnitsToPixels),e.push({type:"graphic",layer:this.layer,graphic:y.graphic,mapPoint:t.clone()});e.sort(((e,t)=>t.graphic.origin.layerIndex-e.graphic.origin.layerIndex));}_tileToMapPoint(e,t){if(!e)return null;const i=e[0]*t[0]+e[1]*t[3]+t[6],s=e[0]*t[1]+e[1]*t[4]+t[7],r=this.view.state,a=[0,0];return r.toMap(a,[i,s]),new x$1({x:a[0],y:a[1],spatialReference:r.spatialReference})}_ensureTileIndex(e){let t=e.featureIndex;return t||(t=d.create(e.key,e.layerData,this._styleRepository,this._tileHandler,this.layer),e.featureIndex=t),t}};function P(e){if(null==e)return 0;switch(e.type){case"partial":return Object.keys(e.diff).length;case"complete":return Math.max(Object.keys(e.oldValue).length,Object.keys(e.newValue).length);case"collection":return Object.keys(e.added).length+Object.keys(e.changed).length+Object.keys(e.removed).length}}e$9([y$2()],S.prototype,"_isTileHandlerReady",void 0),S=e$9([c$7("esri.views.2d.layers.VectorTileLayerView2D")],S);const A=S;

export { A as default };
