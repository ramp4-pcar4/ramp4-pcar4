import{x as i,bj as z,z as l,K as c,G as A,q as H,V as v,ba as J,n as p,d5 as h,ds as w,iM as W,s as K,X as L,ai as $,B as Q,by as E,iN as k,iO as V,bx as X,S as Y,a4 as Z,f4 as ee,T as te,bG as re,bF as se,cn as ae,cm as O,d4 as oe,a3 as ne,aY as M}from"./main-DnzmeE4U.js";import{a as F,F as f}from"./Basemap-DxWxjcEH.js";import{t as ie}from"./loadAll-BIhJ1RSe.js";import{n as I}from"./CollectionFlattener-9hYRBLDX.js";import"./mat4f32-CiZjBg9k.js";import"./mat4-BFStKTjU.js";import{f as le}from"./Layer-B8q-l4yV.js";var S;let g=S=class extends A{constructor(e){super(e),this.type="none"}clone(){return new S({type:this.type})}};i([z({none:"none",stayAbove:"stay-above"}),l({json:{write:{isRequired:!0}}})],g.prototype,"type",void 0),g=S=i([c("esri.ground.NavigationConstraint")],g);const de=Symbol("GroundInstance");var j,T;let y=T=class extends A.JSONSupportMixin(H){constructor(e){super(e),this[j]=!0,this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new v;const t=s=>{s.parent&&s.parent!==this&&"remove"in s.parent&&s.parent.remove(s),s.parent=this,s.type!=="elevation"&&s.type!=="base-elevation"&&p.getLogger(this).error(`Layer '${s.title}, id:${s.id}' of type '${s.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},r=s=>{s.parent=null};this.addHandles([this.layers.on("after-add",s=>t(s.item)),this.layers.on("after-remove",s=>r(s.item))])}initialize(){this.when().catch(e=>{J(e)||p.getLogger(this).error("#load()","Failed to load ground",e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.layers.removeAll();for(const t of e)h(t);this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}get layers(){return this._get("layers")}set layers(e){this._set("layers",w(e,this._get("layers")))}writeLayers(e,t,r,s){const o=[];e&&(s={...s,layerContainerType:"ground"},e.forEach(n=>{if("write"in n){const a={};W(n)().write(a,s)&&o.push(a)}else s?.messages&&s.messages.push(new K("layer:unsupported",`Layers (${n.title}, ${n.id}) of type '${n.declaredClass}' cannot be persisted in the ground`,{layer:n}))})),t.layers=o}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return ie(this,e=>{e(this.layers)})}async queryElevation(e,t){await this.load({signal:t?.signal});const{ElevationQuery:r}=await import("./ElevationQuery-DuUlMAmS.js");L(t);const s=new r,o=this.layers.filter(B).toArray();return s.queryAll(o,e,t)}async createElevationSampler(e,t){await this.load({signal:t?.signal});const{ElevationQuery:r}=await import("./ElevationQuery-DuUlMAmS.js");L(t);const s=new r,o=this.layers.filter(B).toArray();return s.createSamplerAll(o,e,t)}clone(){const e={opacity:this.opacity,surfaceColor:$(this.surfaceColor),navigationConstraint:$(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new T({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){const t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):Promise.resolve()}async _loadLayersFromJSON(e,t,r){const s=t?.origin||"web-scene",o=t?.portal||null,n=t?.url||null,{populateOperationalLayers:a}=await import("./layersCreator-Vp21VWYz.js");L(r);const u=[];if(e.layers&&Array.isArray(e.layers)){const D={context:{origin:s,url:n,portal:o,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};u.push(a(this.layers,e.layers,D))}await Promise.allSettled(u)}};function ye(e){return e&&"createElevationSampler"in e}function B(e){return e.type==="elevation"||ye(e)}j=de,i([l({json:{read:!1,write:{isRequired:!0}}})],y.prototype,"layers",null),i([Q("layers")],y.prototype,"writeLayers",null),i([l({readOnly:!0})],y.prototype,"resourceInfo",void 0),i([l({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:E,read:{reader:k,source:"transparency"},write:{writer:(e,t)=>{t.transparency=V(e)},target:"transparency"}}})],y.prototype,"opacity",void 0),i([l({type:X,json:{type:[E],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],y.prototype,"surfaceColor",void 0),i([l({type:g,json:{write:!0}})],y.prototype,"navigationConstraint",void 0),y=T=i([c("esri.Ground")],y);const m=y;function N(e){return new I({getCollections:()=>[e.tables,e.layers],getChildrenFunction:t=>{const r=[];return"tables"in t&&r.push(t.tables),"layers"in t&&r.push(t.layers),r},itemFilterFunction:t=>{const r=t.parent;return!!r&&"tables"in r&&r.tables.includes(t)}})}function pe(e){for(const t of e.values())t?.destroy();e.clear()}function C(e,t,r){let s,o;if(e)for(let n=0,a=e.length;n<a;n++){if(s=e.at(n),s?.[t]===r)return s;if(s?.type==="group"&&(o=C(s.layers,t,r),o))return o}}const G=e=>{let t=class extends e{constructor(...r){super(...r),this.layers=new v;const s=a=>{a.parent&&"remove"in a.parent&&a.parent.remove(a)},o=a=>{a.parent=this,this.layerAdded(a),a.type!=="elevation"&&a.type!=="base-elevation"||p.getLogger(this).error(`Layer 'title:${a.title}, id:${a.id}' of type '${a.type}' is not supported as an operational layer and will therefore be ignored.`)},n=a=>{a.parent=null,this.layerRemoved(a)};this.addHandles([this.layers.on("before-add",a=>{if(a.item===this)return a.preventDefault(),void p.getLogger(this).error("#add()","Cannot add layer to itself.");s(a.item)}),this.layers.on("after-add",a=>o(a.item)),this.layers.on("after-remove",a=>n(a.item))])}destroy(){const r=this.layers.toArray();for(const s of r)s.destroy();this.layers.destroy()}set layers(r){this._set("layers",w(r,this._get("layers")))}add(r,s){const o=this.layers;if(s=o.getNextIndex(s),r instanceof le){const n=r;n.parent===this?this.reorder(n,s):o.add(n,s)}else Y(r)?r.then(n=>{this.destroyed||this.add(n,s)}):p.getLogger(this).error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(r,s){const o=this.layers;let n=o.getNextIndex(s);r.slice().forEach(a=>{a.parent!==this?(o.add(a,n),n+=1):this.reorder(a,n)})}findLayerById(r){return C(this.layers,"id",r)}findLayerByUid(r){return C(this.layers,"uid",r)}remove(r){return this.layers.remove(r)}removeMany(r){return this.layers.removeMany(r)}removeAll(){return this.layers.removeAll()}reorder(r,s){return this.layers.reorder(r,s)}layerAdded(r){}layerRemoved(r){}};return i([l()],t.prototype,"layers",null),t=i([c("esri.support.LayersMixin")],t),t},ue=new Set(["feature","subtype-group"]);function _(e,t,r){if(e)for(let s=0,o=e.length;s<o;s++){const n=e.at(s);if(n[t]===r)return n;if(n?.type==="group"){const a=_(n.tables,t,r);if(a)return a}}}const U=e=>{let t=class extends e{constructor(...r){super(...r),this.tables=new v,this.addHandles([this.tables.on("after-add",s=>{const o=s.item;o.parent&&o.parent!==this&&"tables"in o.parent&&o.parent.tables.remove(o),o.parent=this,ue.has(o.type)||p.getLogger(this).error(`Layer 'title:${o.title}, id:${o.id}' of type '${o.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",s=>{s.item.parent=null})])}destroy(){const r=this.tables.toArray();for(const s of r)s.destroy();this.tables.destroy()}set tables(r){this._set("tables",w(r,this._get("tables")))}findTableById(r){return _(this.tables,"id",r)}findTableByUid(r){return _(this.tables,"uid",r)}};return i([l()],t.prototype,"tables",null),t=i([c("esri.support.TablesMixin")],t),t},b=new WeakMap;function P(e){return!e.destroyed&&(b.has(e)||e.addHandles([Z(()=>{const t=e.parent;return!(!t||!("type"in t))&&(t.type==="catalog-dynamic-group"||P(t))},t=>b.set(e,t),ee),te(()=>b.delete(e))]),b.get(e))}function ce(e){return typeof e=="object"&&e!=null&&"loaded"in e&&e.loaded===!0&&"type"in e}function he(e){return!(!ce(e)||!re(e)?.operations?.supportsEditing||"editingEnabled"in e&&!se(e)||P(e))}const x=()=>p.getLogger("esri.support.basemapUtils");function fe(){return{}}function ge(e){for(const t in e){const r=e[t];h(r),delete e[t]}}function me(e,t){let r;if(typeof e=="string"){const s=e in F,o=!s&&e.includes("/");if(!s&&!o){if(ae.apiKey)x().warn(`Unable to find basemap definition for: ${e}. See available styles at https://developers.arcgis.com/rest/basemap-styles/`);else{const n=Object.entries(F).filter(([a,u])=>u.classic||u.is3d).map(([a])=>`"${a}"`).sort().join(", ");x().warn(`Unable to find basemap definition for: ${e}. Try one of these: ${n}`)}return null}t&&(r=t[e]),r||(r=s?f.fromId(e):new f({style:{id:e}}),t&&(t[e]=r))}else r=O(f,e);return r?.destroyed&&(x().warn("The provided basemap is already destroyed",{basemap:r}),r=null),r}const R={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function be(e){let t=null;if(typeof e=="string")if(e in R){const r=R[e];t=new m({resourceInfo:{data:{layers:[r]}}})}else p.getLogger("esri.support.groundUtils").warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`);else t=O(m,e);return t}let d=class extends U(G(oe.EventedMixin(ne))){constructor(e){super(e),this.allLayers=new I({getCollections:()=>[this.basemap?.baseLayers,this.ground?.layers,this.layers,this.basemap?.referenceLayers],getChildrenFunction:t=>"layers"in t?t.layers:null}),this.allTables=N(this),this.basemap=null,this.editableLayers=new I({getCollections:()=>[this.allLayers],itemFilterFunction:he}),this.ground=new m,this._basemapCache=fe()}destroy(){ge(this._basemapCache),this._basemapCache=null,this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),this.basemap=h(this.basemap),h(this.ground),this._set("ground",null)}castBasemap(e){return me(e,this._basemapCache)}castGround(e){return be(e)??this._get("ground")}findLayerById(e){return this.allLayers.find(t=>t.id===e)}findTableById(e){return this.allTables.find(t=>t.id===e)}};i([l({readOnly:!0,dependsOn:[]})],d.prototype,"allLayers",void 0),i([l({readOnly:!0})],d.prototype,"allTables",void 0),i([l({type:f,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],d.prototype,"basemap",void 0),i([M("basemap")],d.prototype,"castBasemap",null),i([l({readOnly:!0})],d.prototype,"editableLayers",void 0),i([l({type:m,nonNullable:!0})],d.prototype,"ground",void 0),i([M("ground")],d.prototype,"castGround",null),i([l()],d.prototype,"undoRedo",void 0),d=i([c("esri.Map")],d);const q=d,ve=Object.freeze(Object.defineProperty({__proto__:null,default:q},Symbol.toStringTag,{value:"Module"}));export{q as L,ve as M,G as a,U as l,pe as n,N as t};
