import{bC as T,eX as E,dm as C,d4 as L,bP as j,fx as X,n as x,s as B,ca as p,fy as A,ai as Y,bE as Z,aj as b}from"./main-DnzmeE4U.js";import{p as v}from"./featureConversionUtils-DRaHTjrY.js";import{s as U}from"./PooledRBush-J5-OtqBl.js";import{h as z,I as O}from"./timeSupport-_0FhDj9z.js";import{e as Q}from"./optimizedFeatureQueryEngineAdapter-Bx4OOJmK.js";import{R as M}from"./normalizeUtils-b-vZURob.js";import{B as q,x as J,j as w}from"./queryUtils-OXllLZed.js";import{c as N,C as P,V}from"./QueryEngine-DEm6IK5j.js";const k=5e4,u={minX:0,minY:0,maxX:0,maxY:0};function D(e){u.minX=e[0],u.minY=e[1],u.maxX=e[2],u.maxY=e[3]}function G(e,t,s){D(t),e.search(u,s)}class S{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new U(9,T("esri-csp-restrictions")?t=>({minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const t=new Array(this._idByBounds.size);let s=0;this._idByBounds.forEach((n,a)=>{t[s++]=a}),this._indexInvalid=!1,this._index.clear(),this._index.load(t)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter(t=>this._idByBounds.has(t))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const t=E();for(const s of this._boundsById.values())s&&(t[0]=Math.min(s[0],t[0]),t[1]=Math.min(s[1],t[1]),t[2]=Math.max(s[2],t[2]),t[3]=Math.max(s[3],t[3]));return t}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(t){const s=this._boundsById.get(t);this._boundsById.delete(t),s&&(this._idByBounds.delete(s),this._indexInvalid||this._index.remove(s))}forEachInBounds(t,s){this._loadIndex(),G(this._index,t,n=>s(this._idByBounds.get(n)))}get(t){return this._boundsById.get(t)}has(t){return this._boundsById.has(t)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(t,s){if(!this._indexInvalid){const n=this._boundsById.get(t);n&&(this._index.remove(n),this._idByBounds.delete(n))}this._boundsById.set(t,s),s&&(this._idByBounds.set(s,t),this._indexInvalid||(this._boundsToLoad.push(s),this._boundsToLoad.length>k&&this._loadIndex()))}}const H=C();let K=class{constructor(e){this.geometryInfo=e,this._boundsStore=new S,this._featuresById=new Map,this._usedMemory=0,this.events=new L,this.featureAdapter=Q}get usedMemory(){return this._usedMemory}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let e=0;return this._featuresById.forEach(t=>{t.geometry!=null&&t.geometry.coords&&(e+=t.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:e/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(e){if(this.fullBounds==null)return null;const[t,s,n,a]=this.fullBounds;return{xmin:t,ymin:s,xmax:n,ymax:a,spatialReference:z(e)}}add(e){this._add(e),this._emitChanged()}addMany(e){for(const t of e)this._add(t);this._emitChanged()}upsertMany(e){const t=e.map(s=>this._upsert(s));return this._emitChanged(),t.filter(j)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged(),this._usedMemory=0}removeById(e){const t=this._featuresById.get(e);return t?(this._remove(t),this._emitChanged(),t):null}removeManyById(e){this._boundsStore.invalidateIndex();for(const t of e){const s=this._featuresById.get(t);s&&this._remove(s)}this._emitChanged()}forEachBounds(e,t){for(const s of e){const n=this._boundsStore.get(s.objectId);n&&t(X(H,n))}}getFeature(e){return this._featuresById.get(e)}has(e){return this._featuresById.has(e)}forEach(e){this._featuresById.forEach(t=>e(t))}forEachInBounds(e,t){this._boundsStore.forEachInBounds(e,s=>{t(this._featuresById.get(s))})}_emitChanged(){this.events.emit("changed",void 0)}_add(e){if(!e)return;const t=e.objectId;if(t==null)return void x.getLogger("esri.layers.graphics.data.FeatureStore").error(new B("featurestore:invalid-feature","feature id is missing",{feature:e}));const s=this._featuresById.get(t);let n;if(s?(e.displayId=s.displayId,n=this._boundsStore.get(t),this._boundsStore.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(s)??0):this.onFeatureAdd!=null&&this.onFeatureAdd(e),!e.geometry?.coords?.length)return this._boundsStore.set(t,null),void this._featuresById.set(t,e);n=v(n??p(),e.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),n!=null&&this._boundsStore.set(t,n),this._featuresById.set(t,e),this._usedMemory+=this.estimateFeatureUsedMemory?.(e)??0}_upsert(e){const t=e?.objectId;if(t==null)return x.getLogger("esri.layers.graphics.data.FeatureStore").error(new B("featurestore:invalid-feature","feature id is missing",{feature:e})),null;const s=this._featuresById.get(t);if(!s)return this._add(e),e;this._usedMemory-=this.estimateFeatureUsedMemory?.(s)??0;const{geometry:n,attributes:a}=e;for(const r in a)s.attributes[r]=a[r];return n&&(s.geometry=n,this._boundsStore.set(t,v(p(),n,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),this._usedMemory+=this.estimateFeatureUsedMemory?.(s)??0,s}_remove(e){this.onFeatureRemove!=null&&this.onFeatureRemove(e);const t=e.objectId;return this._boundsStore.delete(t),this._featuresById.delete(t),this._usedMemory-=this.estimateFeatureUsedMemory?.(e)??0,e}};async function W(e,t,s){const n=A(s),{point:a,distance:r,returnEdge:l,vertexMode:m}=t;if(!l&&m==="none")return{candidates:[]};let o=Y(t.query);o=await e.schedule(()=>q(o,e.definitionExpression,e.spatialReference),n),o=await e.reschedule(()=>N(o,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),n);const h=!Z(a.spatialReference,e.spatialReference);h&&await J(a.spatialReference,e.spatialReference);const y=typeof r=="number"?r:r.x,c=typeof r=="number"?r:r.y,f={xmin:a.x-y,xmax:a.x+y,ymin:a.y-c,ymax:a.y+c,spatialReference:a.spatialReference},i=h?w(f,e.spatialReference):f;if(!i)return{candidates:[]};const _=(await M(b(a),null,{signal:n}))[0],g=(await M(b(i),null,{signal:n}))[0];if(_==null||g==null)return{candidates:[]};const d=new P(await e.reschedule(()=>e.searchFeatures(V(g.toJSON())),n),o,e);await e.reschedule(()=>e.executeObjectIdsQuery(d),n),await e.reschedule(()=>e.executeTimeQuery(d),n),await e.reschedule(()=>e.executeAttributesQuery(d),n),await e.reschedule(()=>$(e,d,n),n);const I=_.toJSON(),F=h?w(I,e.spatialReference):I,R=h?Math.max(i.xmax-i.xmin,i.ymax-i.ymin)/2:r;return d.createSnappingResponse({...t,point:F,distance:R},a.spatialReference)}async function $(e,t,s){const{query:n}=t,{spatialRel:a}=n;if(!t?.items?.length||!n.geometry||!a)return;const r=await O(a,n.geometry,e.geometryType,e.hasZ,e.hasM),l=await e.runSpatialFilter(t.items,m=>r(m.geometry),s);t.items=l}export{K as f,S as o,W as u};
