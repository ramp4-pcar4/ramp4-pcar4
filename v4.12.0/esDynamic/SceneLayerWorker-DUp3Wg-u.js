import{ca as C,b7 as ee,hy as te,hz as ne,cY as re,Y as oe,Q as B,ei as ie}from"./main-DnzmeE4U.js";import{n as se,a as ae}from"./MeshLocalVertexSpace-DFCiKNRA.js";import{n as fe,d as ce}from"./vec3-CRJiMrND.js";import"./workers-0oosFQiO.js";import"./projection-m8vi7Cxv.js";import"./projectVectorToVector-D0K_S4MR.js";import"./vec4f64-CjUMzAyX.js";import"./sphere-Cj20syUS.js";import"./mat4-BFStKTjU.js";import"./mat4f64-BaJwL7tQ.js";import"./vec32-BuqRmYBM.js";import"./Query-CxQYWcUQ.js";import{I as le}from"./I3SBinaryReader-CyBOtojY.js";import{g as ue}from"./edgeUtils-CjV7X0G9.js";import"./NormalAttribute.glsl-C9zbIKka.js";import{I as de}from"./orientedBoundingBox-CTsjUkMw.js";C();var k;async function me(e,t,n,s,o,f,a,c){const u=[];for(const d of t)if(d&&o.includes(d.name)){const m=`${e}/nodes/${n}/attributes/${d.key}/0`;u.push({url:m,storageInfo:d})}const S=await Promise.allSettled(u.map(d=>ee(d.url,{responseType:"array-buffer",query:{...a,token:f},signal:c?.signal}).then(m=>le(d.storageInfo,m.data)))),p=[];for(const d of s){const m={};for(let y=0;y<S.length;y++){const b=S[y];if(b.status==="fulfilled"){const l=b.value;m[u[y].storageInfo.name]=pe(l,d)}}p.push(m)}return p}(function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"})(k||(k={}));const he=-32768,ye=-2147483648;function pe(e,t){if(!e)return null;const n=e[t];return te(e)?n===he?null:n:ne(e)?n===ye?null:n:n!=n?null:n}ue({color:[0,0,0,0],opacity:0}),C(),C(),new de,new Array(72);var _,H;(function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"})(_||(_={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(H||(H={}));function be(){return L||(L=new Promise(e=>import("./i3s-DqZ34uA9.js").then(t=>t.i).then(({default:t})=>{const n=t({locateFile:ge,onRuntimeInitialized:()=>e(n)});delete n.then})).catch(e=>{throw e})),L}function ge(e){return re(`esri/libs/i3s/${e}`)}let L;class Ee{constructor(t,n,s,o,f,a){this.layout=t,this.interleavedVertexData=n,this.indices=s,this.hasColors=o,this.hasModifications=f,this.positionData=a}}let we=class{constructor(e,t,n,s,o,f,a){this.componentOffsets=e,this.featureIds=t,this.anchorIds=n,this.anchors=s,this.transformedGeometry=o,this.globalTrafo=f,this.obb=a}};new oe({deallocator:null});var Y,I,$,z,V;(function(e){e[e.Unmodified=0]="Unmodified",e[e.Culled=1]="Culled",e[e.NotChecked=2]="NotChecked"})(Y||(Y={})),function(e){e[e.Unmodified=0]="Unmodified",e[e.PotentiallyModified=1]="PotentiallyModified",e[e.Culled=2]="Culled",e[e.Unknown=3]="Unknown",e[e.NotChecked=4]="NotChecked"}(I||(I={})),function(e){e[e.Unknown=0]="Unknown",e[e.Uncached=1]="Uncached",e[e.Cached=2]="Cached"}($||($={})),function(e){e[e.None=0]="None",e[e.MaxScreenThreshold=1]="MaxScreenThreshold",e[e.ScreenSpaceRelative=2]="ScreenSpaceRelative",e[e.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",e[e.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(z||(z={})),function(e){e[e.Hole=0]="Hole",e[e.Leaf=1]="Leaf"}(V||(V={}));async function Se(e){r=await N();const t=[e.geometryBuffer];return{result:G(r,e,t),transferList:t}}async function Ie(e){r=await N();const t=[e.geometryBuffer],{geometryBuffer:n}=e,s=n.byteLength,o=r._malloc(s),f=new Uint8Array(r.HEAPU8.buffer,o,s);f.set(new Uint8Array(n));const a=r.dracoDecompressPointCloudData(o,f.byteLength);if(r._free(o),a.error.length>0)throw new Error(`i3s.wasm: ${a.error}`);const c=a.featureIds?.length>0?a.featureIds.slice():null,u=a.positions.slice();return c&&t.push(c.buffer),t.push(u.buffer),{result:{positions:u,featureIds:c},transferList:t}}async function Ne(e){await N(),q(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function Te(e){await N(),J(e)}async function _e(e){r=await N(),r.setLegacySchema(e.context,e.jsonSchema)}async function Re(e){const{localMatrix:t,origin:n,positions:s,vertexSpace:o}=e,f=B.fromJSON(e.inSpatialReference),a=B.fromJSON(e.outSpatialReference);let c;const[{projectBuffer:u},{initializeProjection:S}]=await Promise.all([import("./projection-m8vi7Cxv.js").then(l=>l.p),import("./projection-m8vi7Cxv.js").then(l=>l.g)]);await S(f,a);const p=[0,0,0];if(!u(n,f,0,p,a,0))throw new Error("Failed to project");if(o.type==="georeferenced"&&o.origin==null){if(c=new Float64Array(s.length),!u(s,f,0,c,a,0,c.length/3))throw new Error("Failed to project")}else{const l=o.type==="georeferenced"?se.fromJSON(o):ae.fromJSON(o),{projectMeshVertexPositions:h}=await import("./projectMeshVertexPositions-CwAnO79z.js"),g=h({vertexAttributes:{position:s},transform:t?{localMatrix:t}:void 0,vertexSpace:l,spatialReference:f},a);if(!g)throw new Error("Failed to project");c=g}const d=c.length,[m,y,b]=p;for(let l=0;l<d;l+=3)c[l]-=m,c[l+1]-=y,c[l+2]-=b;return{result:{projected:c,original:s,projectedOrigin:p},transferList:[c.buffer,s.buffer]}}async function Ue({normalMatrix:e,normals:t}){const n=new Float32Array(t.length);return fe(n,t,e),ie(e)&&ce(n,n),{result:{transformed:n,original:t},transferList:[n.buffer,t.buffer]}}function Ae(e){Q(e)}let Ce,r;function J(e){if(!r)return;const t=e.modifications,n=r._malloc(8*t.length),s=new Float64Array(r.HEAPU8.buffer,n,t.length);for(let o=0;o<t.length;++o)s[o]=t[o];r.setModifications(e.context,n,t.length,e.isGeodetic),r._free(n)}function G(e,t,n){const{context:s,globalTrafo:o,mbs:f,obbData:a,elevationOffset:c,geometryBuffer:u,geometryDescriptor:S,indexToVertexProjector:p,vertexToRenderProjector:d}=t,m=e._malloc(u.byteLength),y=33,b=e._malloc(y*Float64Array.BYTES_PER_ELEMENT),l=new Uint8Array(e.HEAPU8.buffer,m,u.byteLength);l.set(new Uint8Array(u));const h=new Float64Array(e.HEAPU8.buffer,b,y);R(h,[NaN,NaN,NaN]);let g=h.byteOffset+3*h.BYTES_PER_ELEMENT,T=new Float64Array(h.buffer,g);R(T,o),g+=16*h.BYTES_PER_ELEMENT,T=new Float64Array(h.buffer,g),R(T,f),g+=4*h.BYTES_PER_ELEMENT,a&&(T=new Float64Array(h.buffer,g),R(T,a));const O=S,W={isDraco:!1,isLegacy:!1,color:t.layouts.some(E=>E.some(w=>w.name==="color")),normal:t.needNormals&&t.layouts.some(E=>E.some(w=>w.name==="normalCompressed")),uv0:t.layouts.some(E=>E.some(w=>w.name==="uv0")),uvRegion:t.layouts.some(E=>E.some(w=>w.name==="uvRegion")),featureIndex:O.featureIndex},i=e.process(s,!!t.obbData,m,l.byteLength,O,W,b,c,p,d,t.normalReferenceFrame);if(e._free(b),e._free(m),i.error.length>0)throw new Error(`i3s.wasm: ${i.error}`);if(i.discarded)return null;const U=i.componentOffsets.length>0?i.componentOffsets.slice():null,A=i.featureIds.length>0?i.featureIds.slice():null,K=i.anchorIds.length>0?Array.from(i.anchorIds):null,X=i.anchors.length>0?Array.from(i.anchors):null,D=i.interleavedVertedData.slice().buffer,F=i.indicesType===_.Int16?new Uint16Array(i.indices.buffer,i.indices.byteOffset,i.indices.byteLength/2).slice():new Uint32Array(i.indices.buffer,i.indices.byteOffset,i.indices.byteLength/4).slice(),M=i.positions.slice(),{buffer:P,byteOffset:v,byteLength:x}=i.positionIndices,j=i.positionIndicesType===_.Int16?new Uint16Array(P,v,x/2).slice():new Uint32Array(P,v,x/4).slice(),Z=new Ee(t.layouts[0],D,F,i.hasColors,i.hasModifications,{data:M,indices:j});return A&&n.push(A.buffer),U&&n.push(U.buffer),n.push(D),n.push(F.buffer),n.push(M.buffer),n.push(j.buffer),new we(U,A,K,X,Z,o,i.obb)}function Le(e){return e===0?I.Unmodified:e===1?I.PotentiallyModified:e===2?I.Culled:I.Unknown}function q(e){if(!r)return;const{context:t,buffer:n}=e,s=r._malloc(n.byteLength),o=n.byteLength/Float64Array.BYTES_PER_ELEMENT,f=new Float64Array(r.HEAPU8.buffer,s,o),a=new Float64Array(n);f.set(a),r.filterOBBs(t,s,o),a.set(f),r._free(s)}function Q(e){r&&r.destroy(e)===0&&(r=null)}function R(e,t){for(let n=0;n<t.length;++n)e[n]=t[n]}async function Oe(){r||await N()}async function N(){return r||(r=await(Ce??=be())),r}const De={transform:(e,t)=>r&&G(r,e,t),destroy:Q},Fe=Object.freeze(Object.defineProperty({__proto__:null,destroyContext:Ae,dracoDecompressPointCloudData:Ie,filterObbsForModifications:Ne,filterObbsForModificationsSync:q,initialize:Oe,interpretObbModificationResults:Le,process:Se,project:Re,setLegacySchema:_e,setModifications:Te,setModificationsSync:J,test:De,transformNormals:Ue},Symbol.toStringTag,{value:"Module"}));export{Fe as S,me as V};
