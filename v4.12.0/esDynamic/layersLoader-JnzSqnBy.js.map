{"version":3,"file":"layersLoader-JnzSqnBy.js","sources":["../../node_modules/@arcgis/core/portal/support/layersLoader.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.32/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{parse as t}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as r}from\"../../layers/support/fetchService.js\";import{LayerLoadContext as a}from\"../../layers/support/LayerLoadContext.js\";import o from\"../Portal.js\";import{createForItemRead as n}from\"./jsonContext.js\";import{getFirstLayerOrTable as s,preprocessFSItemData as l,populateSceneServiceItemData as i,getNumLayersAndTables as u,createSublayerData as p,instanceTypeToLayerTypes as c,getSublayersByLayerType as y,layerTypeToLayerModuleType as m}from\"./loadUtils.js\";import{hasTypeKeyword as d}from\"./portalItemUtils.js\";import{loadStyleRenderer as f}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as w}from\"../../support/requestPresets.js\";async function h(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),g(e),e.validateItem&&e.validateItem(r),I(e,t)}function g(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function I(e,t){const r=e.instance,o=r.portalItem;if(!o)return;const{url:s,title:l}=o,i=n(o,\"portal-item\");if(\"group\"===r.type)return b(r,i,e);s&&\"media\"!==r.type&&r.read({url:s},i);const u=new a,p=await F(e,u,t);return p&&r.read(p,i),r.resourceReferences={portalItem:o,paths:i.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:l},i),f(r,i)}async function b(t,r,a){const o=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:s}=o;if(\"Group Layer\"===s){if(!d(o,\"Map\"))throw new e(\"portal:invalid-layer-item-typekeyword\",\"'Group Layer' item without 'Map' type keyword is not supported\");return L(t,a)}return t.read({title:n},r),S(t,a)}async function L(t,r){const a=t.portalItem,o=await a.fetchData(\"json\");if(!o)return;if(!r.populateGroupLayer)throw new e(\"portal:missing-populate-group-layer\",\"Missing populate group layer\");const s=n(a,\"web-map\");t.read(o,s),await r.populateGroupLayer(t,o,{context:s}),t.resourceReferences={portalItem:a,paths:s.readResourcePaths??[]}}async function S(t,r){let o;const{portalItem:n}=t;if(!n)return;const p=n.type,c=r.layerModuleTypeMap;if(!c)throw new e(\"portal:missing-layer-module-type-map\",\"Layer module type map is required to construct sub layers\");switch(p){case\"Feature Service\":case\"Feature Collection\":o=c.FeatureLayer;break;case\"Stream Service\":o=c.StreamLayer;break;case\"Scene Service\":o=c.SceneLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${p}' is not supported as a 'IGroupLayer'`)}const y=new a;let[m,d]=await Promise.all([o(),F(r,y)]),f=()=>m;if(\"Feature Service\"===p){const e=s(d)?.customParameters;d=n.url?await l(d,n.url,y):{},f=await D(d,c)||f;const r=await C(n.url,{customParameters:e,loadContext:y});return await v(t,f,f,d,c,r)}return\"Scene Service\"===p&&n.url&&(d=await i(n,d,y)),u(d)>0?await v(t,f,null,d,c):await T(t,f,c)}async function T(e,t,r){const{portalItem:a}=e;if(!a?.url)return;const o=await w(a.url);o&&v(e,t,null,{layers:o.layers?.map(p),tables:o.tables?.map(p)},r)}async function v(e,t,r,a,o,n){let s=a.layers||[];const l=a.tables||[];if(\"Feature Collection\"===e.portalItem?.type?(s.forEach(((e,t)=>{e.id=t,\"Table\"===e?.layerDefinition?.type&&l.push(e)})),s=s.filter((e=>\"Table\"!==e?.layerDefinition?.type))):(s.reverse(),l.reverse()),s.forEach((r=>{const o=n?.(r);if(o||!n){const n=j(e,t(r),a,r,o);e.add(n)}})),l.length){const t=r?null:await o.FeatureLayer();l.forEach((o=>{const s=n?.(o);if(s||!n){const n=j(e,r?r(o):t,a,o,s);e.tables.add(n)}}))}}function j(e,t,r,a,n){const s=e.portalItem,l={portalItem:s.clone(),layerId:a.id};null!=a.url&&(l.url=a.url);const i=new t(l);if(\"sourceJSON\"in i&&(i.sourceJSON=n),\"subtype-group\"!==i.type&&\"catalog\"!==i.type&&(i.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===s.type){const e={origin:\"portal-item\",portal:s.portal||o.getDefault()};i.read(a,e);const t=r.showLegend;null!=t&&i.read({showLegend:t},e)}return i}async function F(e,t,r){if(!1===e.supportsData)return;const a=e.instance,o=a.portalItem;if(!o)return;let n=null;try{n=await o.fetchData(\"json\",r)}catch(l){}if(x(a)){let e=null;const r=await M(o,n,t);if((n?.layers||n?.tables)&&r>0){if(null==a.layerId){const e=c(a.type),t=e?.length?y(n,e)[0]:s(n);t&&(a.layerId=t.id)}e=P(n,a),\"OrientedImageryLayer\"===e?.layerType&&\"oriented-imagery\"===a.type&&a.supportedSourceTypes.add(\"Feature Layer\"),e&&null!=n.showLegend&&(e.showLegend=n.showLegend)}return r>1&&\"sublayerTitleMode\"in a&&\"service-name\"!==a.sublayerTitleMode&&(a.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function M(e,r,a){if(r?.layers&&r?.tables)return u(r);const o=t(e.url);if(!o)return 1;const n=await a.fetchServiceMetadata(o.url.path,{customParameters:s(r)?.customParameters}).catch((()=>null));return(r?.layers?.length??n?.layers?.length??0)+(r?.tables?.length??n?.tables?.length??0)}function P(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&G(a,t)?a:null}function x(e){return\"stream\"!==e.type&&\"layerId\"in e}function G(e,t){const r=\"layerType\"in e&&e.layerType,{type:a}=t;return!(\"feature\"===a&&r&&\"ArcGISFeatureLayer\"!==e.layerType||\"catalog\"===a&&!r||\"oriented-imagery\"===a&&!r||\"subtype-group\"===a&&!r)}async function C(e,t){const{layersJSON:a}=await r(e,t);if(!a)return null;const o=[...a.layers,...a.tables];return e=>o.find((t=>t.id===e.id))}async function D(e,t){const{layers:r,tables:a}=e,o=[...r??[],...a??[]];if(!o.length)return;const n=new Set,s=[];for(const{layerType:u}of o){const e=u??\"ArcGISFeatureLayer\";if(n.has(e))continue;n.add(e);const r=t[m(e)];s.push(r())}const l=await Promise.all(s),i=new Map;return Array.from(n).forEach(((e,t)=>{i.set(e,l[t])})),({layerType:e})=>{const t=e??\"ArcGISFeatureLayer\";return i.get(t)}}export{h as load};\n"],"names":["h","e","t","g","I","r","o","s","l","i","n","b","a","p","F","f","d","L","S","c","y","m","D","C","v","u","T","w","j","x","M","P","G"],"mappings":"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","x_google_ignoreList":[0]}