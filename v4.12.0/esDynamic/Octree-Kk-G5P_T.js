import{a9 as E,bL as Ot,Y as D,am as m}from"./main-DnzmeE4U.js";import{u as w,g as y,o as Rt,s as tt,I as pt,v as et}from"./vec32-BuqRmYBM.js";import{s as ot,b as it,v as At,a as C,k as rt,N as V,H as nt,U as T,E as P}from"./sphere-Cj20syUS.js";import{c as bt,h as Et}from"./mat4-BFStKTjU.js";import{z as Ft}from"./vec42-D8CJyqHG.js";import{r as S}from"./vec4f64-CjUMzAyX.js";import{G as gt,M as A,h as Nt,a as Mt,r as St,p as H}from"./plane-B_adY3_o.js";import{i as st}from"./InterleavedLayout-DcHoXu73.js";function q(o){return o?{ray:it(o.ray),c0:o.c0,c1:o.c1}:{ray:it(),c0:0,c1:Number.MAX_VALUE}}function Bt(o,t=q()){return At(o,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function xt(o,t){return at(o,o.c0,t)}function jt(o,t){return at(o,o.c1,t)}function at(o,t,e){return w(e,o.ray.origin,y(e,o.ray.direction,t))}new ot(()=>q());function Lt(o){return o?[A(o[0]),A(o[1]),A(o[2]),A(o[3]),A(o[4]),A(o[5])]:[A(),A(),A(),A(),A(),A()]}function Pt(){return[E(),E(),E(),E(),E(),E(),E(),E()]}function Ht(o,t){for(let e=0;e<U;e++)Nt(o[e],t[e]);return o}function It(o,t,e,i=wt){const r=bt(Mt.get(),t,o);Et(r,r);for(let n=0;n<Dt;++n){const h=Ft(St.get(),vt[n],r);Rt(i[n],h[0]/h[3],h[1]/h[3],h[2]/h[3])}zt(e,i)}function zt(o,t){H(t[s.FAR_BOTTOM_LEFT],t[s.NEAR_BOTTOM_LEFT],t[s.NEAR_TOP_LEFT],o[g.LEFT]),H(t[s.NEAR_BOTTOM_RIGHT],t[s.FAR_BOTTOM_RIGHT],t[s.FAR_TOP_RIGHT],o[g.RIGHT]),H(t[s.FAR_BOTTOM_LEFT],t[s.FAR_BOTTOM_RIGHT],t[s.NEAR_BOTTOM_RIGHT],o[g.BOTTOM]),H(t[s.NEAR_TOP_LEFT],t[s.NEAR_TOP_RIGHT],t[s.FAR_TOP_RIGHT],o[g.TOP]),H(t[s.NEAR_BOTTOM_LEFT],t[s.NEAR_BOTTOM_RIGHT],t[s.NEAR_TOP_RIGHT],o[g.NEAR]),H(t[s.FAR_BOTTOM_RIGHT],t[s.FAR_BOTTOM_LEFT],t[s.FAR_TOP_LEFT],o[g.FAR])}function k(o,t){for(let e=0;e<U;e++){const i=o[e];if(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]+i[3]>=t[3])return!1}return!0}function Gt(o,t){for(let e=0;e<U;e++){const i=o[e];if(!gt(i,t))return!1}return!0}var g,s;(function(o){o[o.LEFT=0]="LEFT",o[o.RIGHT=1]="RIGHT",o[o.BOTTOM=2]="BOTTOM",o[o.TOP=3]="TOP",o[o.NEAR=4]="NEAR",o[o.FAR=5]="FAR"})(g||(g={})),function(o){o[o.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",o[o.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",o[o.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",o[o.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",o[o.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",o[o.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",o[o.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",o[o.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(s||(s={})),s.FAR_BOTTOM_RIGHT,s.NEAR_BOTTOM_RIGHT,s.NEAR_BOTTOM_LEFT,s.FAR_BOTTOM_LEFT,s.NEAR_BOTTOM_LEFT,s.NEAR_BOTTOM_RIGHT,s.NEAR_TOP_RIGHT,s.NEAR_TOP_LEFT,s.FAR_BOTTOM_RIGHT,s.FAR_BOTTOM_LEFT,s.FAR_TOP_LEFT,s.FAR_TOP_RIGHT,s.NEAR_BOTTOM_RIGHT,s.FAR_BOTTOM_RIGHT,s.FAR_TOP_RIGHT,s.NEAR_TOP_RIGHT,s.FAR_BOTTOM_LEFT,s.NEAR_BOTTOM_LEFT,s.NEAR_TOP_LEFT,s.FAR_TOP_LEFT,s.FAR_TOP_LEFT,s.NEAR_TOP_LEFT,s.NEAR_TOP_RIGHT,s.FAR_TOP_RIGHT;const U=6,Dt=8,vt=[S(-1,-1,-1,1),S(1,-1,-1,1),S(1,1,-1,1),S(-1,1,-1,1),S(-1,-1,1,1),S(1,-1,1,1),S(1,1,1,1),S(-1,1,1,1)];new ot(q);const wt=Pt();class I{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(t,e){this.objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new l,this._objectCount=0,e&&(e.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),e.maximumDepth!==void 0&&(this._maximumDepth=e.maximumDepth))}destroy(){this._degenerateObjects.clear(),l.clearPool(),X[0]=null,j.prune(),L.prune()}add(t,e=t.length){this._objectCount+=e,this._grow(t,e);const i=l.acquire();for(let r=0;r<e;r++){const n=t[r];this._isDegenerate(n)?this._degenerateObjects.add(n):(i.init(this._root),this._add(n,i))}l.release(i)}remove(t,e=null){this._objectCount-=t.length;const i=l.acquire();for(const r of t){const n=e??C(this.objectToBoundingSphere(r),Wt);v(n[3])?(i.init(this._root),yt(r,n,i)):this._degenerateObjects.delete(r)}l.release(i),this._shrink()}update(t,e){if(!v(e[3])&&this._isDegenerate(t))return;const i=Ut(t);this.remove(i,e),this.add(i)}forEachAlongRay(t,e,i){const r=rt(t,e);x(this._root,n=>{if(!qt(r,n))return!1;const h=n.node;return h.terminals.forAll(u=>{this._intersectsObject(r,u)&&i(u)}),h.residents!==null&&h.residents.forAll(u=>{this._intersectsObject(r,u)&&i(u)}),!0})}forEachAlongRayWithVerticalOffset(t,e,i,r){const n=rt(t,e);x(this._root,h=>{if(!kt(n,h,r))return!1;const u=h.node;return u.terminals.forAll(a=>{this._intersectsObjectWithOffset(n,a,r)&&i(a)}),u.residents!==null&&u.residents.forAll(a=>{this._intersectsObjectWithOffset(n,a,r)&&i(a)}),!0})}forEach(t){x(this._root,e=>{const i=e.node;return i.terminals.forAll(t),i.residents!==null&&i.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,e,i,r=()=>!0,n=1/0){let h=1/0,u=1/0,a=null;const c=W(t,e),f=d=>{if(--n,!r(d))return;const O=this.objectToBoundingSphere(d);if(!k(i,O))return;const F=B(t,e,T(O)),z=F-O[3],_=F+O[3];z<h&&(h=z,u=_,a=d)};return ht(this._root,d=>{if(n<=0||!k(i,d.bounds)||(y(b,c,d.halfSize),w(b,b,T(d.bounds)),B(t,e,b)>u))return!1;const O=d.node;return O.terminals.forAll(F=>f(F)),O.residents!==null&&O.residents.forAll(F=>f(F)),!0},t,e),a}forEachInDepthRange(t,e,i,r,n,h,u){let a=-1/0,c=1/0;const f={setRange:_=>{i===I.DepthOrder.FRONT_TO_BACK?(a=Math.max(a,_.near),c=Math.min(c,_.far)):(a=Math.max(a,-_.far),c=Math.min(c,-_.near))}};f.setRange(r);const d=B(e,i,t),O=W(e,i),F=W(e,-i),z=_=>{if(!u(_))return;const M=this.objectToBoundingSphere(_),G=T(M),$=B(e,i,G)-d,ft=$-M[3],mt=$+M[3];ft>c||mt<a||!k(h,M)||n(_,f)};ht(this._root,_=>{if(!k(h,_.bounds)||(y(b,O,_.halfSize),w(b,b,T(_.bounds)),B(e,i,b)-d>c)||(y(b,F,_.halfSize),w(b,b,T(_.bounds)),B(e,i,b)-d<a))return!1;const M=_.node;return M.terminals.forAll(G=>z(G)),M.residents!==null&&M.residents.forAll(G=>z(G)),!0},e,i)}forEachNode(t){x(this._root,e=>t(e.node,e.bounds,e.halfSize,e.depth))}forEachNeighbor(t,e){const i=V(e),r=T(e),n=a=>{const c=this.objectToBoundingSphere(a),f=V(c),d=i+f;return!(et(T(c),r)-d*d<=0)||t(a)};let h=!0;const u=a=>{h&&(h=n(a))};x(this._root,a=>{const c=V(a.bounds),f=i+c;if(et(T(a.bounds),r)-f*f>0)return!1;const d=a.node;return d.terminals.forAll(u),h&&d.residents!==null&&d.residents.forAll(u),h}),h&&this.forEachDegenerateObject(u)}_intersectsObject(t,e){const i=this.objectToBoundingSphere(e);return!(i[3]>0)||nt(i,t)}_intersectsObjectWithOffset(t,e,i){const r=this.objectToBoundingSphere(e);return!(r[3]>0)||nt(i.applyToBoundingSphere(r),t)}_add(t,e){e.advanceTo(this.objectToBoundingSphere(t))?e.node.terminals.push(t):(e.node.residents.push(t),e.node.residents.length>this._maximumObjectsPerNode&&e.depth<this._maximumDepth&&this._split(e))}_split(t){const e=t.node.residents;t.node.residents=null;for(let i=0;i<e.length;i++){const r=l.acquire().init(t);this._add(e.at(i),r),l.release(r)}}_grow(t,e){if(e!==0&&(dt(t,e,i=>this.objectToBoundingSphere(i),N),v(N[3])&&!this._fitsInsideTree(N)))if(lt(this._root.node))C(N,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const i=this._rootBoundsForRootAsSubNode(N);this._placingRootViolatesMaxDepth(i)?this._rebuildTree(N,i):this._growRootAsSubNode(i),l.release(i)}}_rebuildTree(t,e){tt(T(Q),T(e.bounds)),Q[3]=e.halfSize,dt([t,Q],2,r=>r,Z);const i=l.acquire().init(this._root);this._root.initFrom(null,Z,Z[3]),this._root.increaseHalfSize(1.25),x(i,r=>(this.add(r.node.terminals.data,r.node.terminals.length),r.node.residents!==null&&this.add(r.node.residents.data,r.node.residents.length),!0)),l.release(i)}_placingRootViolatesMaxDepth(t){const e=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return x(this._root,r=>(i=Math.max(i,r.depth),i+e<=this._maximumDepth)),i+e>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const e=t[3],i=t;let r=-1/0;const n=this._root.bounds,h=this._root.halfSize;for(let a=0;a<3;a++){const c=n[a]-h-(i[a]-e),f=i[a]+e-(n[a]+h),d=Math.max(0,Math.ceil(c/(2*h))),O=Math.max(0,Math.ceil(f/(2*h)))+1,F=2**Math.ceil(Math.log(d+O)*Math.LOG2E);r=Math.max(r,F),J[a].min=d,J[a].max=O}for(let a=0;a<3;a++){let c=J[a].min,f=J[a].max;const d=(r-(c+f))/2;c+=Math.ceil(d),f+=Math.floor(d);const O=n[a]-h-c*h*2;Y[a]=O+(f+c)*h}const u=r*h;return Y[3]=u*_t,l.acquire().initFrom(null,Y,u,0)}_growRootAsSubNode(t){const e=this._root.node;tt(T(N),T(this._root.bounds)),N[3]=this._root.halfSize,this._root.init(t),t.advanceTo(N,null,!0),t.node.children=e.children,t.node.residents=e.residents,t.node.terminals=e.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const e=this._root.node.children;let i=0,r=0;for(;r<e.length&&t==null;)i=r++,t=e[i];for(;r<e.length;)if(e[r++])return-1;return i}_isDegenerate(t){return!v(this.objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const e=this._root.bounds,i=this._root.halfSize;return t[3]<=i&&t[0]>=e[0]-i&&t[0]<=e[0]+i&&t[1]>=e[1]-i&&t[1]<=e[1]+i&&t[2]>=e[2]-i&&t[2]<=e[2]+i}toJSON(){const{maximumDepth:t,maximumObjectsPerNode:e,_objectCount:i}=this,r=this._nodeToJSON(this._root.node);return{maximumDepth:t,maximumObjectsPerNode:e,objectCount:i,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:r}}}_nodeToJSON(t){const e=t.children.map(n=>n?this._nodeToJSON(n):null),i=t.residents?.map(n=>this.objectToBoundingSphere(n)),r=t.terminals?.map(n=>this.objectToBoundingSphere(n));return{children:e,residents:i,terminals:r}}static fromJSON(t){const e=new I(i=>i,{maximumDepth:t.maximumDepth,maximumObjectsPerNode:t.maximumObjectsPerNode});return e._objectCount=t.objectCount,e._root.initFrom(t.root.node,t.root.bounds,t.root.halfSize,t.root.depth),e}}class l{constructor(){this.bounds=P(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,e,i,r=this.depth){return this.node=t??l.createEmptyNode(),e&&C(e,this.bounds),this.halfSize=i,this.depth=r,this}increaseHalfSize(t){this.halfSize*=t,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*_t}advance(t){let e=this.node.children[t];e||(e=l.createEmptyNode(),this.node.children[t]=e),this.node=e,this.halfSize/=2,this.depth++;const i=ut[t];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(t,e,i=!1){for(;;){if(this.isTerminalFor(t))return e&&e(this,-1),!0;if(this.isLeaf()){if(!i)return e&&e(this,-1),!1;this.node.residents=null}const r=this._childIndex(t);e&&e(this,r),this.advance(r)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const e=this.bounds;return(e[0]<t[0]?1:0)+(e[1]<t[1]?2:0)+(e[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new D({shrink:!0}),residents:new D({shrink:!0})}}static acquire(){return l._pool.acquire()}static release(t){l._pool.release(t)}static clearPool(){l._pool.prune()}}function x(o,t){let e=l.acquire().init(o);const i=[e];for(;i.length!==0;){if(e=i.pop(),t(e)&&!e.isLeaf())for(let r=0;r<e.node.children.length;r++)e.node.children[r]&&i.push(l.acquire().init(e).advance(r));l.release(e)}}function ht(o,t,e,i=I.DepthOrder.FRONT_TO_BACK){let r=l.acquire().init(o);const n=[r];for(Vt(e,i,Tt);n.length!==0;){if(r=n.pop(),t(r)&&!r.isLeaf())for(let h=7;h>=0;--h){const u=Tt[h];r.node.children[u]&&n.push(l.acquire().init(r).advance(u))}l.release(r)}}function yt(o,t,e){j.clear();const i=e.advanceTo(t,(r,n)=>{j.push(r.node),j.push(n)})?e.node.terminals:e.node.residents;if(i.removeUnordered(o),i.length===0)for(let r=j.length-2;r>=0&&Ct(j.data[r],j.data[r+1]);r-=2);}function Ct(o,t){return t>=0&&(o.children[t]=null),!!lt(o)&&(o.residents===null&&(o.residents=new D({shrink:!0})),!0)}function qt(o,t){return K(T(t.bounds),2*-t.halfSize,R),K(T(t.bounds),2*t.halfSize,p),st(o.origin,o.direction,R,p)}function kt(o,t,e){return K(T(t.bounds),2*-t.halfSize,R),K(T(t.bounds),2*t.halfSize,p),e.applyToMinMax(R,p),st(o.origin,o.direction,R,p)}function lt(o){if(o.terminals.length!==0)return!1;if(o.residents!==null)return o.residents.length===0;for(let t=0;t<o.children.length;t++)if(o.children[t])return!1;return!0}function Kt(o,t){o[0]=Math.min(o[0],t[0]-t[3]),o[1]=Math.min(o[1],t[1]-t[3]),o[2]=Math.min(o[2],t[2]-t[3])}function Jt(o,t){o[0]=Math.max(o[0],t[0]+t[3]),o[1]=Math.max(o[1],t[1]+t[3]),o[2]=Math.max(o[2],t[2]+t[3])}function K(o,t,e){e[0]=o[0]+t,e[1]=o[1]+t,e[2]=o[2]+t}function dt(o,t,e,i){if(t===1){const r=e(o[0]);C(r,i)}else{R[0]=1/0,R[1]=1/0,R[2]=1/0,p[0]=-1/0,p[1]=-1/0,p[2]=-1/0;for(let r=0;r<t;r++){const n=e(o[r]);v(n[3])&&(Kt(R,n),Jt(p,n))}pt(T(i),R,p,.5),i[3]=Math.max(p[0]-R[0],p[1]-R[1],p[2]-R[2])/2}}function Vt(o,t,e){if(!L.length)for(let i=0;i<8;++i)L.push({index:0,distance:0});for(let i=0;i<8;++i){const r=ut[i];L.data[i].index=i,L.data[i].distance=B(o,t,r)}L.sort((i,r)=>i.distance-r.distance);for(let i=0;i<8;++i)e[i]=L.data[i].index}function W(o,t){let e,i=1/0;for(let r=0;r<8;++r){const n=B(o,t,ct[r]);n<i&&(i=n,e=ct[r])}return e}function B(o,t,e){return t*(o[0]*e[0]+o[1]*e[1]+o[2]*e[2])}function v(o){return!isNaN(o)&&o!==-1/0&&o!==1/0&&o>0}l._pool=new Ot(l),function(o){var t;(t=o.DepthOrder||(o.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(I);const ut=[m(-1,-1,-1),m(1,-1,-1),m(-1,1,-1),m(1,1,-1),m(-1,-1,1),m(1,-1,1),m(-1,1,1),m(1,1,1)],ct=[m(-1,-1,-1),m(-1,-1,1),m(-1,1,-1),m(-1,1,1),m(1,-1,-1),m(1,-1,1),m(1,1,-1),m(1,1,1)],_t=Math.sqrt(3),X=[null];function Ut(o){return X[0]=o,X}const Y=P(),b=E(),R=E(),p=E(),j=new D,Wt=P(),N=P(),Q=P(),Z=P(),J=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],L=new D,Tt=[0,0,0,0,0,0,0,0];export{Lt as H,It as L,Ht as N,q as a,I as b,jt as g,g as j,Gt as m,xt as p,Bt as y};
