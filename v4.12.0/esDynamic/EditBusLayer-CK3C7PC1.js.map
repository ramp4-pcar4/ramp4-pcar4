{"version":3,"file":"EditBusLayer-CK3C7PC1.js","sources":["../../node_modules/@arcgis/core/versionManagement/support/versionManagementUtils.js","../../node_modules/@arcgis/core/layers/mixins/EditBusLayer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.32/esri/copyright.txt for details.\n*/\nimport e from\"../../request.js\";import{generateLowercaseBracedUUID as r}from\"../../core/uuid.js\";const t=r(),n=new Map,s=new Map,a=new Map;async function o(r,t,s){if(!r||!s)return!1;if(!t)return!0;const a=new URL(r).host;let o=n.get(a);if(!o){const t=r.replace(/\\/FeatureServer/i,\"/VersionManagementServer\").replace(/\\/\\d*$/,\"\");o=(await e(t,{responseType:\"json\",query:{f:\"json\"}})).data.defaultVersionName}return o===t}async function i(e,r,n=!1){if(!e||!r)return!0;const a=e.replace(/\\/FeatureServer/i,\"/VersionManagementServer\").replace(/\\/\\d*$/,\"\"),o=s.get(a)?.entries();if(o)for(const[s,i]of o)if(i.name===r){const e=!i.stack?.hasForwardEdits();if(!e&&n){const[{deleteForwardEdits:e},{default:r}]=await Promise.all([import(\"../../rest/versionManagement/gdbVersion/deleteForwardEdits.js\"),import(\"../../rest/versionManagement/gdbVersion/support/DeleteForwardEditsParameters.js\")]),n=await e(a,s,new r({sessionId:t,moment:i.moment}));return n.success&&i.stack?.clearForwardEdits(),n.success}return e}return!0}function c(e,r){if(!e)return!1;const t=e.replace(/\\/FeatureServer/i,\"/VersionManagementServer\").replace(/\\/\\d*$/,\"\"),n=s.get(t)?.entries();if(n)for(const[s,a]of n)if(a.name===r){return\"edit\"===a.lockType}return!1}export{t as currentSessionId,n as defaultVersionNameLookup,o as isHistoricVersion,i as isSafeToEditVersion,c as isVersionInEditSession,s as versionCollection,a as versionCollectionCount};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.32/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../chunks/tslib.es6.js\";import e from\"../../core/Evented.js\";import{clone as i}from\"../../core/lang.js\";import{createResolver as s}from\"../../core/promiseUtils.js\";import{property as r}from\"../../core/accessorSupport/decorators/property.js\";import\"../../core/has.js\";import\"../../core/Logger.js\";import{subclass as d}from\"../../core/accessorSupport/decorators/subclass.js\";import{defaultVersionNameLookup as o,isVersionInEditSession as n}from\"../../versionManagement/support/versionManagementUtils.js\";const a=new e.EventEmitter;function l(t){return a.on(\"apply-edits\",new WeakRef(t))}function h(t){return a.on(\"update-moment\",new WeakRef(t))}function c(t,e,i=null,r=!1){const d=s();return r=null==e||r,a.emit(\"apply-edits\",{serviceUrl:t,layerId:e,gdbVersion:i,mayReceiveServiceEdits:r,result:d.promise}),d}function u(t,e,i=null,s){a.emit(\"update-moment\",{serviceUrl:t,layerId:e,gdbVersion:i,moment:s})}const m=Symbol();function p(t){return null!=t&&\"object\"==typeof t&&m in t}function b(t){return null!=t&&\"object\"==typeof t&&\"gdbVersion\"in t}function g(t,e,i){const s=new URL(t).host,r=o.get(s),d=t=>!t||t===r;return d(e)&&d(i)||e===i}const F=e=>{var s;let o=class extends e{constructor(...t){super(...t),this[s]=!0,this._applyEditsHandler=t=>{const{serviceUrl:e,layerId:s,gdbVersion:r,mayReceiveServiceEdits:d,result:o}=t,n=e===this.url,a=null!=s&&null!=this.layerId&&s===this.layerId,l=b(this),h=b(this)&&g(e,r,this.gdbVersion);if(!n||l&&!h||!a&&!d)return;const c=o.then((t=>{if(this.lastEditsEventDate=new Date,a&&(t.addedFeatures.length||t.updatedFeatures.length||t.deletedFeatures.length||t.addedAttachments.length||t.updatedAttachments.length||t.deletedAttachments.length))return this.emit(\"edits\",i(t)),t;const s=t.editedFeatures?.find((({layerId:t})=>t===this.layerId));if(s){const{adds:e,updates:r,deletes:d}=s.editedFeatures,o={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:e?e.map((({attributes:t})=>({objectId:this.objectIdField&&t[this.objectIdField],globalId:this.globalIdField&&t[this.globalIdField]}))):[],deletedFeatures:d?d.map((({attributes:t})=>({objectId:this.objectIdField&&t[this.objectIdField],globalId:this.globalIdField&&t[this.globalIdField]}))):[],updatedFeatures:r?r.map((({current:{attributes:t}})=>({objectId:this.objectIdField&&t[this.objectIdField],globalId:this.globalIdField&&t[this.globalIdField]}))):[],editedFeatures:i(t.editedFeatures),exceededTransferLimit:!1,historicMoment:i(t.historicMoment)};return this.emit(\"edits\",o),o}const d={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:i(t.editedFeatures),exceededTransferLimit:!1,historicMoment:i(t.historicMoment)};return\"historicMoment\"in this&&this._shouldUpdateHistoricMoment(e,r,d.historicMoment)&&this.emit(\"edits\",d),d})).then((t=>(\"historicMoment\"in this&&this._shouldUpdateHistoricMoment(e,r,t.historicMoment)&&(this.historicMoment=t.historicMoment),t)));this.emit(\"apply-edits\",{result:c})},this._updateMomentHandler=t=>{const{serviceUrl:e,gdbVersion:i,moment:s}=t,r=e===this.url,d=b(this),o=b(this)&&g(e,i,this.gdbVersion),n=b(this)&&!g(e,this.gdbVersion,null);r&&d&&o&&n&&\"historicMoment\"in this&&this.historicMoment!==s&&(this.historicMoment=s)},this.when().then((()=>{this.addHandles(l(this._applyEditsHandler)),\"historicMoment\"in this&&this.addHandles(h(this._updateMomentHandler))}),(()=>{}))}_shouldUpdateHistoricMoment(t,e,i){return\"historicMoment\"in this&&this.historicMoment!==i&&n(t,e)}};return s=m,t([r()],o.prototype,\"lastEditsEventDate\",void 0),o=t([d(\"esri.layers.mixins.EditBusLayer\")],o),o};export{F as EditBusLayer,c as emitApplyEditsEvent,u as emitUpdateMomentEvent,p as isEditBusLayer,b as isLayerWithGDBVersion,l as onApplyEditsEvent,h as onUpdateMomentEvent,g as versionMatches};\n"],"names":["t","r","n","s","o","a","e","i","c","l","h","d","m","p","b","F"],"mappings":"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","x_google_ignoreList":[0,1]}