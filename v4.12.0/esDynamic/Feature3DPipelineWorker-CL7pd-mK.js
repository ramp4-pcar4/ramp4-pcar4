import{ft as oe,c5 as E,a9 as A,ca as ke,aR as Ne,bq as Ue,eo as de,x as p,z as g,K as F,a3 as le,gK as ze,h2 as He,u as ce,bP as Qe,bC as $,ba as We,d4 as ue,jL as qe,s as Ve,f9 as Je,X as j,T as $e,fd as Ye,eI as he,jM as Ze,dm as Xe,dn as Ke,aW as me,dl as et,jN as tt,Q as fe,ap as rt,a4 as nt,dq as st}from"./main-DnzmeE4U.js";import{o as it,Q as at,O as ot}from"./projection-m8vi7Cxv.js";import{L as dt}from"./QueryEngine-DEm6IK5j.js";import{b as pe}from"./Query-CxQYWcUQ.js";import{s as _e}from"./ReactiveMap-BaMcQuG3.js";import{r as lt}from"./signal-DxzURL18.js";import{s as O,n as ge,a as ct,i as ut}from"./memoryEstimations-iHVpvWPf.js";import{s as ht,E as ye}from"./PooledRBush-J5-OtqBl.js";import{n as mt}from"./OptimizedFeatureSet-D6mgsKNr.js";import{e as Y}from"./OptimizedGeometry-1qDYm3YK.js";import{d as ft}from"./query-nJmB7Ppn.js";import{a as pt}from"./pbf-Ijhb7ANA.js";import{u as _t}from"./quantizationUtils-Cndke4AR.js";import{Z as gt}from"./FieldsIndex-Y7EBAYp0.js";import{b as yt,h as wt}from"./pbfQueryUtils-1j64fqcx.js";import{l as I}from"./ViewingMode-CyR_b1T8.js";import{o as bt,t as xt}from"./Indices-DkAzsiH-.js";import{N as It}from"./vec4f64-CjUMzAyX.js";import{t as vt,a as Ct,k as Rt,s as St}from"./LodRenderer-DcLHtm7X.js";import{t as At}from"./glUtil-n1JOrdV3.js";import{n as k}from"./ShaderOutput-C_OqLoo1.js";import{u as Tt,c as Mt,a as Pt,b as Et,s as Ft}from"./HUDMaterial.glsl-DUfp5PMk.js";import{A as we,m as Ot,q as Bt}from"./VerticalOffset.glsl-BtVaDxLq.js";import{a as Gt,z as be,o as Lt}from"./DefaultMaterial-DGGIMylx.js";import{e as _}from"./VertexAttribute-DFC3a3eR.js";import{m as Dt,l as jt,f as kt,h as Nt}from"./RealisticTree.glsl-De7nH4tm.js";import{e as xe}from"./renderState-DlSSrLcZ.js";import{n as Ie,r as Ut,h as zt,s as Ht,o as Qt,f as Wt}from"./mat4-BFStKTjU.js";import{e as B}from"./mat4f64-BaJwL7tQ.js";import{n as Z}from"./projectVectorToVector-D0K_S4MR.js";import{m as qt}from"./computeTranslationToOriginAndRotation-DwwrTl3S.js";import{t as ve,c as Vt,D as Jt}from"./HUDVisibility.glsl-Bl7zdrV0.js";import{t as v}from"./orientedBoundingBox-CTsjUkMw.js";import{o as $t,s as Ce}from"./vec32-BuqRmYBM.js";import{a as Yt}from"./spatialReferenceEllipsoidUtils-DlQOpWof.js";import{c as Zt}from"./projectPointToVector-CG1hALQu.js";import{J as Xt,k as Kt}from"./boundedPlane-B6TkXVHT.js";import{V as er,f as tr}from"./sphere-Cj20syUS.js";import{c as C,u as rr,x as nr}from"./plane-B_adY3_o.js";function sr(t){const{value:e,operations:r}=t;return{operations:r,value:r.create(e)}}function ir(t,e,r){return t.operations.setExtent(t.value,e,r.value),r}function ar(t,e){return t.operations.getExtent(t.value,e),e}function or(t){return{operations:t,value:t.create()}}function Re(t,e,r=or(t)){return r.operations=t,t.copy(e,r.value),r}function dr(t){return Re(tr,er(0,0,0,oe(t).radius))}const Se=2**50;function lr(){return Re(Kt,Xt([0,0,0],[Se,0,0],[0,Se,0]))}function cr(t,e,r){return t.operations.axisAt(t.value,e,E.Z,r)}function ur(t,e,r,n){return t.operations.axisAt(t.value,e,r,n)}function hr(t,e,r){return t.operations.intersectRay(t.value,e,r)}function mr(t,e,r){return t.operations.intersectRayClosestSilhouette(t.value,e,r)}function fr(t,e){return t.operations.altitudeAt(t.value,e)}function Ae(t,e,r,n){return t.operations.setAltitudeAt(t.value,e,r,n)}function pr(t,e,r,n){return e!==n&&Ie(n,e),$t(T,n[12],n[13],n[14]),Ae(t,T,r,T),n[12]=T[0],n[13]=T[1],n[14]=T[2],n}function X(t,e,r){return t.operations.elevate(t.value,e,r.value)}const T=A();class q{constructor(e,r,n,s){this.viewingMode=e,this.spatialReference=r,this.unitInMeters=n,this._coordinateSystem=s,this._tmpCoordinateSystem=sr(s),this.referenceEllipsoid=oe(r),this.sphericalPCPF=Yt(r)}set extent(e){e&&ir(this._coordinateSystem,e,this._coordinateSystem)}get extent(){return ar(this._coordinateSystem,ke())}getAltitude(e){return fr(this._coordinateSystem,e)}setAltitude(e,r,n=e){return Ae(this._coordinateSystem,n,r,e)}setAltitudeOfTransformation(e,r){pr(this._coordinateSystem,r,e,r)}worldUpAtPosition(e,r){return cr(this._coordinateSystem,e,r)}worldBasisAtPosition(e,r,n){return ur(this._coordinateSystem,e,r,n)}basisMatrixAtPosition(e,r){const n=this.worldBasisAtPosition(e,E.X,C.get()),s=this.worldBasisAtPosition(e,E.Y,C.get()),i=this.worldBasisAtPosition(e,E.Z,C.get());return Ut(r,n[0],n[1],n[2],0,s[0],s[1],s[2],0,i[0],i[1],i[2],0,0,0,0,1),r}headingAtPosition(e,r){const n=this.worldUpAtPosition(e,C.get()),s=this.worldBasisAtPosition(e,E.Y,C.get()),i=rr(r,s,n);return Ne(i)}intersectManifoldClosestSilhouette(e,r,n){return X(this._coordinateSystem,r,this._tmpCoordinateSystem),mr(this._tmpCoordinateSystem,e,n),n}intersectManifold(e,r,n){X(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=C.get();return hr(this._tmpCoordinateSystem,e,s)?Ce(n,s):null}intersectInfiniteManifold(e,r,n){if(this.viewingMode===I.Global)return this.intersectManifold(e,r,n);X(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=this._tmpCoordinateSystem.value,i=C.get();return nr(s.plane,e,i)?Ce(n,i):null}toRenderCoords(e,r,n){return ve(e)?Zt(e,r,this.spatialReference):Z(e,r,n,this.spatialReference)}fromRenderCoords(e,r,n=null){return ve(r)?(n!=null&&(r.spatialReference=n),vt(e,this.spatialReference,r)?r:null):Z(e,this.spatialReference,r,n)?r:null}static create(e,r){switch(e){case I.Local:return new q(I.Local,r,Ue(r),lr());case I.Global:return new q(I.Global,r,1,dr(r))}}static renderUnitScaleFactor(e,r){return de(e)/de(r)}}let _r=class extends Gt{constructor(t=A()){super(),this.origin=t}get slicePlaneLocalOrigin(){return this.origin}},y=class extends le{constructor(t){super(t),this._updatingCount=0,this._tileHandles=new _e,this._wanted=new _e}destroy(){for(const t of this._tileHandles.values())t.abort();this._tileHandles.clear(),this._wanted.clear()}get updating(){return this._updatingCount>0}get _boundingRect(){const{extent:t}=this;return t==null?null:ze(t)}get _missingTiles(){const t=new Array,e=this._wanted;for(const r of this._tileHandles.values())e.has(r.id)&&!G(r)&&t.push(r);return t}async onTileTreeChange(t){++this._updatingCount;try{const{added:e,removed:r}=t,n=this._tileHandles,{_boundingRect:s}=this,i=s!=null?e.filter(o=>He(s,o.extent)):e,a=this._wanted,d=new Array;for(const o of r){const{id:l}=o;if(a.delete(l),e.some(h=>b(h,o)||b(o,h)))continue;const c=n.get(l);c!=null&&d.push(this._removeTile(c))}for(const o of i)a.set(o.id,o),d.push(this._addTile(o));await Promise.allSettled(d)}finally{--this._updatingCount}}async _removeTile(t){this._tileHandles.delete(t.id),t.abort(),this._validate();const{tile:e}=t,r=new L(t.untilSettled(),e!=null?this.createRemoveTileCommand(e):null);t.nextEvent=null;const{command:n}=await r.getCommand();n?.execute()}async _addTile(t){const{_tileHandles:e}=this,r=e.get(t.id);if(r!=null)return!G(r)||r.tile.isComplete||(r.tile=r.tile.reset(),r.nextEvent=this._onTileLoad(r)),void await r.untilSettled();const n=new gr(t);this._tileHandles.set(n.id,n);const s=this.loadTile(t,n.signal);n.nextEvent=s;const i=await s;if(n.aborted)throw ce();n.tile=i,yr(n),n.nextEvent=this._onTileLoad(n),await n.untilSettled()}async _onTileLoad(t){const{_wanted:e,_tileHandles:r,_missingTiles:n}=this,s=t.descriptor,i=new Array,a=new Array,d=new Set;for(const l of r.values()){if(l===t)continue;const{descriptor:c,id:h}=l;if(e.has(h)||n.some(({descriptor:m})=>b(m,c)||b(c,m))){if(G(l)){if(b(s,c)){const m=l.tile;for(const u of m.objectIds())d.add(u)}if(b(c,s)){const m=t.tile,u=new Set(m.objectIds()),f=l.tile,x=f.exclude(u);l.tile=x;const R=AbortSignal.any([l.signal,t.signal]),S=l.untilSettled();i.push(new L(S,this.createRemoveTileCommand(f))),i.push(new L(S,this.createAddTileCommand(x,R),R)),a.push(l),this._validateRemoval(x,u)}}}else{l.abort(),r.delete(h);const{tile:m}=l;m!=null&&i.push(new L(l.untilSettled(),this.createRemoveTileCommand(m))),l.nextEvent=null}}d.size>0&&(t.tile=t.tile.exclude(d),this._validateRemoval(t.tile,d)),i.push(new L(t.untilSettled(),this.createAddTileCommand(t.tile,t.signal),t.signal)),a.push(t),this._validate();const o=this._joinCommands(i);for(const l of a)l.nextEvent=o;await o}async _joinCommands(t){const e=(await Promise.allSettled(t.map(async r=>r.getCommand()))).map(r=>r.status!=="fulfilled"||r.value.signal?.aborted?null:r.value.command).filter(Qe);e.length!==0&&e.reduce((r,n)=>(r.append(n),r)).execute()}_validate(){if(!$("feature-pipeline-3d-test-validation"))return;const t=new Array;for(const e of this._tileHandles.values()){if(!G(e))continue;const{tile:r}=e,n=r.featureCount,s=new Uint32Array(n);r.readObjectIds(s),t.push({tile:r,objectIds:new Set(s)})}for(let e=0;e<t.length;++e){const{tile:r,objectIds:n}=t[e];for(let s=e+1;s<t.length;++s){const{tile:i,objectIds:a}=t[s];for(const d of a)if(n.has(d)){const o=b(i.descriptor,r.descriptor),l=b(r.descriptor,i.descriptor);throw new Error(`${r.descriptor.id} and ${i.descriptor.id} both contain ${d}. aInB: ${o}; bInA: ${l}`)}}}}_validateRemoval(t,e){if($("feature-pipeline-3d-test-validation")){for(const r of t.objectIds())if(e.has(r))throw new Error(`Failed to remove ${r} from ${t.descriptor.id}!`)}}};function b({lij:[t,e,r]},{lij:[n,s,i]}){const a=n-t;return a>=0&&e===s>>a&&r===i>>a}p([g()],y.prototype,"updating",null),p([g({constructOnly:!0})],y.prototype,"loadTile",void 0),p([g({constructOnly:!0})],y.prototype,"createAddTileCommand",void 0),p([g({constructOnly:!0})],y.prototype,"createRemoveTileCommand",void 0),p([g()],y.prototype,"_updatingCount",void 0),p([g()],y.prototype,"extent",void 0),p([g()],y.prototype,"_boundingRect",null),p([g()],y.prototype,"_missingTiles",null),y=p([F("esri.views.3d.layers.graphics.pipeline.Tile3DManager")],y);let gr=class{constructor(t){this.descriptor=t,this._controller=new AbortController,this._tile=lt(null),this.nextEvent=null}get id(){return this.descriptor.id}get tile(){return this._tile.value}set tile(t){this._tile.value=t}get signal(){return this._controller.signal}abort(){this._controller.abort()}get aborted(){return this._controller.signal.aborted}async untilSettled(){try{await this.nextEvent}catch(t){We(t)||console.error(t)}}};function G(t){return t.tile!=null}function yr(t){if(!G(t))throw new Error}let L=class{constructor(t,e,r){this.previousEventSettled=t,this.commandPromise=e,this.signal=r}async getCommand(){const{previousEventSettled:t,commandPromise:e,signal:r}=this,[n]=await Promise.all([e,t]);if(r?.aborted)throw ce();return{command:n,signal:r}}},wr=class ie{constructor(e,r){this.tile=e,this._tileIndices=r}get id(){return this.tile.id}get featureCount(){return this._tileIndices?.length??this.tile.featureCount}get usedMemory(){return O+(this._tileIndices?.byteLength??0)}get extent(){return this.tile.descriptor.extent}readObjectIds(e,r){const{_tileIndices:n,tile:s}=this;return s.readObjectIds(e,n,r)}readCoordinates(e,r){const{_tileIndices:n,tile:s}=this;return s.readCoordinates(e,n,r)}subset(e){const{_tileIndices:r,tile:n}=this;if(r==null)return new ie(n,e);const s=new Uint32Array(e.length);for(let i=0;i<s.length;++i)s[i]=r[e[i]];return new ie(n,s)}},br=class{constructor(){this._tileToFeatureData=new Map}add(t){this._tileToFeatureData.set(t.tile,t)}remove(t){this._tileToFeatureData.delete(t)}get(t){return this._tileToFeatureData.get(t)}},K=class{constructor(t,e){this._index=t,this._view=e}get usedMemory(){return O+ge}getObjectId(){return this._view.getObjectId(this._index)}getAttribute(t){return this._view.getAttribute(this._index,t)}getAttributeAsTimestamp(t){return this._view.getAttributeAsTimestamp(this._index,t)}getAttributes(){return this._view.getAttributes(this._index)}getOptimizedGeometry(){return this._view.getOptimizedGeometry(this._index)}getCentroid(t){return this._view.getCentroid(this._index,t)}getBounds(){return this._view.getBounds(this._index)}getBoundingBox(){return this._view.getBoundingBox(this._index)}cloneWithGeometry(t){return new xr(this._index,this._view,t)}},xr=class extends K{constructor(t,e,r){super(t,e),this._geometryOverride=r}getOptimizedGeometry(){return this._geometryOverride}getCentroid(t){return mt(new Y,this._geometryOverride,t.hasZ,t.hasM)}};class Ir{constructor(){this._tileBounds=new Map,this.events=new ue,this.featureAdapter=ee.shared}get usedMemory(){return O+O*this._tileBounds.size}addTile(e){const{featureCount:r}=e;if(r===0)return;const n=new ht(9,i=>e.getBounds(i)),s=new Array;for(let i=0;i<r;++i)s[i]=i;n.load(s),this._tileBounds.set(e,n),this.events.emit("changed")}removeTile(e){this._tileBounds.delete(e),this.events.emit("changed")}clear(){this._tileBounds.clear(),this.events.emit("changed")}forEach(e){for(const[r,n]of this._tileBounds)n.all(s=>e(new K(s,r)))}forEachInBounds(e,r){D.minX=e[0],D.minY=e[1],D.maxX=e[2],D.maxY=e[3];for(const[n,s]of this._tileBounds)s.search(D,i=>r(new K(i,n)))}forEachBounds(e,r){for(const n of e)r(n.getBoundingBox())}getFullExtent(e){let r=1/0,n=1/0,s=-1/0,i=-1/0;for(const a of this._tileBounds.values()){const{minX:d,minY:o,maxX:l,maxY:c}=a.toJSON();r=Math.min(r,d),n=Math.min(n,o),s=Math.min(s,l),i=Math.min(i,c)}return{xmin:r,ymin:n,xmax:s,ymax:i,spatialReference:e}}}let ee=class{getObjectId(t){return t.getObjectId()}getAttribute(t,e){return t.getAttribute(e)}getAttributeAsTimestamp(t,e){return t.getAttributeAsTimestamp(e)}getAttributes(t){return t.getAttributes()}getGeometry(t){return t.getOptimizedGeometry()}getCentroid(t,e){return t.getCentroid(e)}cloneWithGeometry(t,e){return t.cloneWithGeometry(e)}};ee.shared=new ee;const D=new ye;let vr=class ae{constructor(e,r,n=Cr(r)){this.descriptor=e,this._pages=r,this._addressTable=n;const s=ct+r.reduce((d,{usedMemory:o})=>d+o,0),i=3*ge,a=ut(n);this.usedMemory=O+s+i+a,this.featureCount=Math.floor(this._addressTable.length/2),this.isComplete=this.featureCount===r.reduce((d,o)=>d+o.featureCount,0)}get id(){return this.descriptor.id}getObjectId(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getObjectId(n)}getAttribute(e,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getAttribute(s,r)}getAttributeAsTimestamp(e,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getAttributeAsTimestamp(s,r)}getAttributes(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getAttributes(n)}getCoordinates(e,r,n){const{pageIndex:s,featurePageIndex:i}=this._translateIndex(e);this._pages[s].getCoordinates(i,r,n)}getOptimizedGeometry(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getOptimizedGeometry(n)}getCentroid(e,r){const{pageIndex:n,featurePageIndex:s}=this._translateIndex(e);return this._pages[n].getCentroid(s,r)}getBounds(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getBounds(n)}getBoundingBox(e){const{pageIndex:r,featurePageIndex:n}=this._translateIndex(e);return this._pages[r].getBoundingBox(n)}readObjectIds(e,r=this._allFeatureIndices(),n=0){let s=n;for(const{page:i,indices:a}of this._batchPageIndices(r))s=i.readObjectIds(e,a,s);return s}readCoordinates(e,r=this._allFeatureIndices(),n=0){let s=n;for(const{page:i,indices:a}of this._batchPageIndices(r))s=i.readCoordinates(e,a,s);return s}*objectIds(e=this._allFeatureIndices()){for(const{page:r,indices:n}of this._batchPageIndices(e))for(const s of r.objectIds(n))yield s}exclude(e){if(e.size===0)return this;const{_addressTable:r,featureCount:n}=this,s=new Array;for(let i=0;i<n;++i){const a=this.getObjectId(i);e.has(a)||(s.push(r[2*i]),s.push(r[2*i+1]))}return new ae(this.descriptor,this._pages,s)}reset(){const{isComplete:e,_pages:r}=this;return e?this:new ae(this.descriptor,r)}*_allFeatureIndices(){const{featureCount:e}=this;for(let r=0;r<e;++r)yield r}_translateIndex(e){const{_addressTable:r}=this;return{pageIndex:r[2*e],featurePageIndex:r[2*e+1]}}*_batchPageIndices(e){const r=new Array;{let s=0,i=new Array;for(const a of e){const{pageIndex:d,featurePageIndex:o}=this._translateIndex(a);s!==d&&(i.length!==0&&r.push({pageIndex:s,indices:i}),s=d,i=[]),i.push(o)}i.length!==0&&r.push({pageIndex:s,indices:i})}const{_pages:n}=this;for(const{pageIndex:s,indices:i}of r)yield{page:n[s],indices:i}}};function Cr(t){const e=t.reduce((s,{featureCount:i})=>s+i,0),r=new Array;if(e===0)return r;const n=t[0].featureCount;for(let s=0;s<e;++s)r[2*s]=Math.floor(s/n),r[2*s+1]=s%n;return r}let Rr=class{constructor(t){this._reader=new pt(new Uint8Array(t),new DataView(t)),this._index=Sr(this._reader)}get featureCount(){return this._index.featureIndices.length}get exceededTransferLimit(){return this._index.exceededTransferLimit}get usedMemory(){return this._reader.usedMemory}getObjectId(t){return this.getAttribute(t,this._index.objectIdFieldName)}getAttribute(t,e){const{_index:{fieldsIndex:r,attributeIndices:n}}=this,s=r.get(e)?.index;if(s==null)return;const i=n[t*r.fields.length+s],a=this._reader;return a.move(i),U(a)}getAttributeAsTimestamp(t,e){const r=this.getAttribute(t,e);return typeof r=="string"?new Date(r).getTime():typeof r=="number"||r==null?r:null}getAttributes(t){const{_index:{fieldsIndex:e,attributeIndices:r}}=this,n=t*e.fields.length,s=this._reader,i={};for(const a of e.fields){const d=r[n+a.index];s.move(d),i[a.name]=U(s)}return i}getCoordinates(t,e,r=0){const n=this._reader,{transform:s,featureIndices:i}=this._index,{scale:a,translate:d}=s;n.move(i[t]),this._readCoordinates(a,d,e,r)}getOptimizedGeometry(t){const e=A();return this.getCoordinates(t,e),new Y([],e)}getCentroid(t,{hasZ:e,hasM:r}){this.getCoordinates(t,M);const[n,s,i]=M,a=[n,s];return e&&(a[3]=i),r&&(a[e?4:3]=0),new Y([],a)}getBounds(t){this.getCoordinates(t,M);const[e,r]=M,n=new ye;return n.minX=e,n.minY=r,n.maxX=e,n.maxY=r,n}getBoundingBox(t){this.getCoordinates(t,M);const[e,r,n]=M;return qe(e,r,n,e,r,n)}readObjectIds(t,e=this._allFeatureIndices(),r=0){const n=this._reader,{objectIdFieldName:s,attributeIndices:i,fieldsIndex:a}=this._index,d=a.get(s).index,o=a.fields.length;for(const l of e){const c=i[l*o+d];n.move(c),t[r++]=U(n)}return r}readCoordinates(t,e=this._allFeatureIndices(),r=0){const n=this._reader,{transform:s,featureIndices:i}=this._index,{scale:a,translate:d}=s;for(const o of e){const l=i[o];n.move(l),r=this._readCoordinates(a,d,t,r)}return r}*objectIds(t=this._allFeatureIndices()){const e=this._reader,{objectIdFieldName:r,attributeIndices:n,fieldsIndex:s}=this._index,i=s.get(r).index,a=s.fields.length;for(const d of t){const o=n[d*a+i];e.move(o),yield U(e)}}*_allFeatureIndices(){const{featureCount:t}=this;for(let e=0;e<t;++e)yield e}_readCoordinates([t,e,r],[n,s,i],a,d){const o=this._reader,l=o.getLength(),c=o.pos()+l;for(;o.pos()<c&&o.next();)switch(o.tag()){case 2:{const h=o.getLength(),m=o.pos()+h;for(;o.pos()<m&&o.next();)o.tag()===3?(o.getUInt32(),a[d++]=n+t*o.getSInt64(),a[d++]=s+e*o.getSInt64(),a[d++]=i+r*o.getSInt64()):o.skip();break}default:o.skip()}return d}};function Sr(t){for(;t.next();){if(t.tag()===2)return Ar(t.getMessage());t.skip()}N()}function Ar(t){for(;t.next();){if(t.tag()===1)return Tr(t.getMessage());t.skip()}N()}function Tr(t){let e,r,n=!1,s=!1,i=0;const a=new Array,d=new Array,o=new Array;for(;t.next();)switch(t.tag()){case 1:r=t.getString();break;case 7:t.getEnum()!==0&&N();break;case 9:n=t.getBool()??!1;break;case 12:e=_t(t.processMessage(wt));break;case 13:{const c=t.processMessage(yt);c.index=i++,a.push(c);break}case 15:{d.push(t.pos());const c=t.getUInt32(),h=t.pos()+c;for(;t.pos()<h&&t.next();)t.tag()===1&&o.push(t.pos()),t.skip();break}case 10:s=t.getBool()??!1;break;default:t.skip()}const l=new gt(a);return e!=null&&s&&r!=null&&l.has(r)||N(),{transform:e,exceededTransferLimit:n,fieldsIndex:l,objectIdFieldName:r,featureIndices:d,attributeIndices:o}}function N(){const t=new Ve("pbf-parsing-failed","Error while parsing PBF",new Error);throw console.error(t),t}function U(t){const e=t.getLength(),r=t.pos()+e;for(;t.pos()<r&&t.next();)switch(t.tag()){case 1:return t.getString();case 2:return t.getFloat();case 3:return t.getDouble();case 4:return t.getSInt32();case 5:return t.getUInt32();case 6:return t.getInt64();case 7:return t.getUInt64();case 8:return t.getSInt64();case 9:return t.getBool();default:return t.skip(),null}return null}const M=A(),Te=8e3,Mr=4,Pr=4;let Er=class{constructor(t,e,r,n,s){this.spatialReference=t,this.url=r,this.objectIdField=n,this.capabilities=s;const{supportsMaxRecordCountFactor:i,maxRecordCount:a}=this.capabilities.query,d=i?Mr:1,o=(a??Te)*d;this._pageSize=Math.min(Te,o);const l=e.clone();l.cacheHint=!0,l.resultType="tile",l.outSpatialReference=t,l.returnGeometry=!0,l.returnZ=!0,l.maxRecordCountFactor=d,l.num=this._pageSize,l.outFields=[n],this._baseQuery=l}async fetch(t,e){const{spatialReference:r}=this,n=Je(t.extent,r),s=this._baseQuery.clone();s.geometry=n;const i=new Array;let a=0,d=!1,o=1;for(;!d;){const l=[];for(let h=0;h<o;++h)l.push(this._fetchPage(s,a++,e));const c=await Promise.all(l);j(e);for(const h of c){const m=h.featureCount!==0;d||=!h.exceededTransferLimit||!m,m&&i.push(h)}o=Math.min(o+1,Pr)}return new vr(t,i)}async _fetchPage(t,e,r){const n=t.clone();n.start=e*this._pageSize;const s=(await ft(this.url,n,{signal:r})).data;return j(r),new Rr(s)}},z=class extends Tt{constructor(t){super(t),this._glMaterials=null,this._produces=new Map,this._renderGeometries=new Map,this._vaoCache=null,this._drawParameters=new _r,this._bufferWriter=null}get produces(){return this._produces}get numFeatures(){let t=0;return this._renderGeometries.forEach(e=>t+=e.numElements/6),t}get usedMemory(){let t=0;return this._renderGeometries.forEach(e=>{t+=e.vao.usedMemory}),t}initialize(){this._bufferWriter=this.material.createBufferWriter(),this.material.produces.forEach((t,e)=>{this._produces.set(e,r=>r!==k.Highlight&&r!==k.ShadowHighlight&&t(r))})}destroy(){this._glMaterials.dispose();const t=this._renderGeometries.keys();for(const e of t)this.removeRenderGeometry(e)}acquireTechniques(t){const e=this.material;if(!e.shouldRender(t))return null;const{output:r,bind:n}=t;return!e.produces.get(n.slot)?.(r)||r===k.Highlight||r===k.ShadowHighlight?null:this._glMaterials.load(t.rctx,n.slot,r)?.beginSlot(n)}render(t,e){const r=this._renderGeometries;if(r.size===0)return;const{bind:n}=t,s=n.slot===we.OCCLUDER_MATERIAL||n.slot===we.TRANSPARENT_OCCLUDER_MATERIAL?n.slot:null,i=t.rctx;i.runAppleAmdDriverHelper(),i.bindTechnique(e,n,this.material.parameters);const a=e.program;for(const[d,o]of r)this._drawParameters.origin=o.localOrigin,a.bindDraw(n,this.material.parameters,this._drawParameters),e.ensureAttributeLocations(o.vao),i.bindVAO(o.vao),i.setPipelineState(e.getPipeline(!1,s)),i.drawArrays(e.primitiveType,0,o.numElements)}initializeRenderContext(t,e){this._glMaterials=new Ct(this.material,t.materials),this._vaoCache=t.renderContext.rctx.getVaoCache(this.material.vertexAttributeLocations,At(this._bufferWriter.vertexBufferLayout))}uninitializeRenderContext(){}addRenderGeometry(t,e,r){this.removeRenderGeometry(t);const n=this._vaoCache.newVao(e.data.byteLength);n.vertexBuffers.get("geometry").setSubData(new Uint8Array(e.data),0,0,e.data.byteLength);const s={localOrigin:r,vao:n,numElements:e.elementCount};return this._renderGeometries.set(t,s),s}removeRenderGeometry(t){const e=this._renderGeometries.get(t);e!=null&&(this._vaoCache.deleteVao(e.vao),this._renderGeometries.delete(t))}hasHighlightOptions(t){return!1}};p([g({constructOnly:!0})],z.prototype,"material",void 0),z=p([F("esri.views.3d.layers.graphics.pipeline.rendering.DirectRenderer")],z);let te=class{constructor(t){this._optionalFields=new Array,this._featureIdToInstanceIndex=new Map,this._disposeResourceHandles=new Array,this._lodRendererResources=null,this.layerUid=t.layerUid,this.view=t.view,this.sharedResources=this.view.sharedSymbolResources,this.scheduler=this.view.resourceController.scheduler}get numFeatures(){return this._featureIdToInstanceIndex.size}get usedMemory(){return(this._lodRendererResources?.lodRenderer?.symbol?.computeUsedMemory()??0)+16*this._featureIdToInstanceIndex.size}destroy(){this._disposeResourceHandles.forEach(t=>t())}async doLoad(t,e,r){$("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(_.OBJECTANDLAYERIDCOLOR);const n=Fr(o=>e(o),t),s=this.view._stage,i=n.getMaterials();s.addMany(i),this._addDisposeResource(()=>s.removeMany(i));const a=n.getTextures();s.addMany(a),this._addDisposeResource(()=>{a.forEach(o=>o.unload()),s.removeMany(a)}),await Promise.all(a.map(o=>this.view._stage.schedule(()=>o.load(s.renderView.renderingContext),r))),j(r);const d=await this._createLodRenderer(n,r);this._lodRendererResources={lodRenderer:d,materials:i,textures:a}}addInstances(t){const e=this._lodRendererResources;if(e==null)return;const{featureIds:r,localTransforms:n,globalTransforms:s}=t,i=e.lodRenderer;if(i==null)return;const a=i.instanceData,d=r.length;for(let o=0;o<d;++o){const l=r[o],c=a.addInstance(),h=a.view,m=16*o;h.localTransform.copyFromTypedBuffer(c,n,m),h.globalTransform.copyFromTypedBuffer(c,s,m),a.updateModelTransform(c),a.setVisible(c,!0),this._featureIdToInstanceIndex.set(l,c)}}removeInstances(t){const e=this._lodRendererResources;if(e==null)return;const r=e.lodRenderer.instanceData,n=this._featureIdToInstanceIndex,s=t.length;for(let i=0;i<s;++i){const a=t[i],d=n.get(a);d!=null&&(r.removeInstance(d),n.delete(a))}}_addDisposeResource(t){this._disposeResourceHandles.push(t)}async _createLodRenderer(t,e){const r=this.view._stage,n={layerUid:this.layerUid,graphicUid:i=>1,notifyGraphicGeometryChanged:i=>1,notifyGraphicVisibilityChanged:i=>1},s=new Rt({symbol:t,optionalFields:this._optionalFields,metadata:n,shaderTransformation:null},this.scheduler);return s.slicePlaneEnabled=!1,this._addDisposeResource(()=>{r.removeRenderPlugin(s),s.destroy()}),await r.addRenderPlugin(s,e),s}};function Fr(t,e){const r=e.levels.map(n=>{const s=n.components.map(i=>{const a=t(i.materialId);if(!Or(a))throw new Error("LodRenderer only supports DefaultMaterial");const d=new Dt(a,i.renderGeometryBuffer.data,i.renderGeometryBuffer.elementCount,i.boundingInfo);return new jt(d)});return new kt(s,n.minScreenSpaceRadius)});return new Nt(r)}function Or(t){return t!=null&&"materialType"in t&&t.materialType==="default"}te=p([F("esri.views.3d.layers.graphics.pipeline.rendering.LodRenderer")],te);let re=class extends le{constructor(t){super(),this.view=null,this.layerUid=null,this._renderGeometries=new Map,this._materials=new Map,this._directRenderers=new Map,this._lodRenderers=new Map,this.totalFeatures=0,this.view=t.view,this.layerUid=t.layerUid}initialize(){}destroy(){this.removeAllHandles(),this._lodRenderers.forEach(t=>t.destroy())}async executeRenderCommands(t){for(const e of t)switch(e.id){case"create-material":await this._createMaterial(e);break;case"create-direct-renderer":await this._createDirectRenderer(e);break;case"add-direct-renderer-geometry":await this._addDirectRendererGeometry(e),this._updateFeatureCount();break;case"remove-direct-renderer-geometry":await this._removeDirectRendererGeometry(e),this._updateFeatureCount();break;case"create-lod-renderer":await this._createLodRenderer(e);break;case"add-lod-instances":await this._addLodInstances(e),this._updateFeatureCount();break;case"remove-lod-instances":await this._removeLodInstances(e),this._updateFeatureCount()}}_updateFeatureCount(){let t=0;for(const e of this._directRenderers.values())t+=e.numFeatures;for(const e of this._lodRenderers.values())t+=e.numFeatures;this._set("totalFeatures",t)}get usedMemory(){let t=0;for(const e of this._directRenderers.values())t+=e.usedMemory;for(const e of this._lodRenderers.values())t+=e.usedMemory;return t}async _createMaterial(t){const{view:e}=this,{sharedSymbolResources:r}=e;if(r==null)throw new Error("No shared symbol resources found!");const{textures:n}=r,s=e.state.viewingMode===I.Global;let i=null;switch(t.type){case"default":i=Br(r,{physicalBasedRenderingEnabled:!0,slicePlaneEnabled:!1,castShadows:!0,isPrimitive:!0,screenSizePerspectiveEnabled:!0,doublePrecisionRequiresObfuscation:e._stage.renderView.renderingContext.driverTest.doublePrecisionRequiresObfuscation.result},s);break;case"hud":{const[a,d]=Me(n,s);this.addHandles([$e(()=>Ye(d))]),i=a}break;default:throw new Error(`unable to create unknown material type ${t.type}`)}this._materials.set(t.materialId,i)}_getMaterial(t){return this._materials.get(t)}async _createDirectRenderer(t){const e=t.materialId,r=this._getMaterial(e);if(r==null)throw new Error(`material not found ${e}`);const{view:n}=this,s=new z({material:r});this._directRenderers.set(e,s),n._stage.addRenderPlugin(s),n._stage.renderView.renderer.updateHasFlags()}async _addDirectRendererGeometry(t){const e=t.renderGeometryId,r=t.materialId;await this._removeDirectRendererGeometry({renderGeometryId:e});const n=this._directRenderers.get(r);if(n==null)return void console.error("no renderer assigned to provided material");const s=n.addRenderGeometry(e,t.renderGeometryBuffer,t.localOrigin);this._renderGeometries.set(e,{renderGeometry:s,materialId:r}),this.view._stage.renderView.requestRender()}async _removeDirectRendererGeometry(t){const e=t.renderGeometryId,r=this._renderGeometries.get(e);if(r==null)return;const n=r.materialId,s=this._directRenderers.get(n);s!=null?s.removeRenderGeometry(t.renderGeometryId):console.error("no renderer assigned to provided material")}async _createLodRenderer(t){const e=new te({view:this.view,layerUid:this.layerUid}),r=new AbortController,n=s=>this._getMaterial(s);await e.doLoad(t.lodRenderGeometry,n,r.signal),this._lodRenderers.set(t.lodRendererId,e)}async _addLodInstances(t){const e=this._lodRenderers.get(t.lodRendererId);if(e==null)throw new Error("no lod renderer assigned to provided lod renderer Id");e.addInstances(t.data)}async _removeLodInstances(t){const e=this._lodRenderers.get(t.lodRendererId);if(e==null)throw new Error("no lod renderer assigned to provided lod renderer Id");e.removeInstances(t.featureIds)}};function Me(t,e){const r={anchorPosition:St.center,occlusionTest:!0,hasSlicePlane:!1,color:[1,0,0,1],outlineColor:[0,0,0,1],outlineSize:1,distanceFieldBoundingBox:Mt},n=null;if(t!=null){const s=t.fromData("circle-icon",()=>Pt("circle"));r.textureId=s.texture.id,r.textureIsSignedDistanceField=!0,r.sampleSignedDistanceFieldTexelCenter=Ft("circle")}return[new Et(r,e),n]}function Br(t,e,r){const n={usePBR:e.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:Lt,ambient:he,diffuse:he,hasSlicePlane:e.slicePlaneEnabled,castShadows:e.castShadows,offsetTransparentBackfaces:!e.isPrimitive};return Gr(n),n.screenSizePerspective=t.screenSizePerspectiveSettings,n.externalColor=It,n.isInstanced=!0,new be(n,{spherical:r,doublePrecisionRequiresObfuscation:!0})}function Gr(t){const e=t.opacity??1,r=e<1;return t.transparent=r,t.opacity=e,t.cullFace=r?xe.None:xe.Back,t}p([g({readOnly:!0})],re.prototype,"totalFeatures",void 0),re=p([F("esri.views.3d.layers.graphics.pipeline.rendering.FeaturePipelineRenderManager")],re);let Pe=class{constructor(t){this._bufferWriter=null,this._bufferWriter=t.createBufferWriter()}createBuffer(t,e){const r=this._bufferWriter;let n=null;if(t.transformation&&e)Ie(P,t.transformation),P[12]-=e[0],P[13]-=e[1],P[14]-=e[2],n=P;else{if(e)throw new Error("not implemented");t.transformation&&(n=t.transformation)}let s=null;n&&(zt(H,P),Ht(H,H),s=H);const i=t.attributes,a=r.elementCount(i),d=r.vertexBufferLayout.stride/4;a>Math.floor(Lr/d)&&console.warn("geometry with very large number of elements encountered");const o=r.vertexBufferLayout.createBuffer(a);return r.write(n,s,i,t.objectAndLayerIdColor,o,0),{data:o.buffer,elementCount:a}}};const P=B(),H=B(),Lr=16777216/4;let Dr=class{constructor(t){this._context=t,this._commands=[],this._transferables=new Set}createMaterial(t){const e=this._context,r=e.generateId("material");switch(t){case"default":{const n=new be({},{spherical:this._context.globalViewingMode,doublePrecisionRequiresObfuscation:!0}),s=new Pe(n);e.registerRenderGeometryBufferWriter(r,s)}break;case"hud":{const n=Me(null,this._context.globalViewingMode)[0],s=new Pe(n);e.registerRenderGeometryBufferWriter(r,s)}}return this._commands.push({id:"create-material",type:t,materialId:r}),r}createDirectRenderer(t){const e=this._context.generateId("material-renderer");return this._commands.push({id:"create-direct-renderer",materialRendererId:e,materialId:t}),e}addDirectRendererGeometry(t,e,r){const n=e.materialId,s=this._context.getRenderGeometryBufferWriter(n);if(s==null)throw new Error(`no bufferwriter found for material ${n}`);const i=s.createBuffer(e,r);this._transferables.add(i.data),this._commands.push({id:"add-direct-renderer-geometry",renderGeometryId:t,materialId:n,renderGeometryBuffer:i,localOrigin:r})}removeDirectRendererGeometry(t){this._commands.push({id:"remove-direct-renderer-geometry",renderGeometryId:t})}createLodRenderer(t){const e=this._context.generateId("lod-renderer"),r={levels:t.levels.map(n=>({components:n.components.map(s=>{const i=s.attributes.get(_.POSITION);if(!i||i.indices.length===0)throw new Error("positions attribute expected");const a=3,d=bt(i.indices.length/a),o=new Ot(d,a,i),l=this._context.getRenderGeometryBufferWriter(s.materialId);if(l==null)throw new Error("writer not found");const c=l.createBuffer(s,null);return this._transferables.add(c.data),{materialId:s.materialId,renderGeometryBuffer:c,boundingInfo:{bbMax:o.bbMax,bbMin:o.bbMin}}}),minScreenSpaceRadius:n.minScreenSpaceRadius}))};return this._commands.push({id:"create-lod-renderer",lodRendererId:e,lodRenderGeometry:r}),e}addLodInstances(t,e){this._commands.push({id:"add-lod-instances",lodRendererId:t,data:e}),this._transferables.add(e.featureIds.buffer),this._transferables.add(e.globalTransforms.buffer),this._transferables.add(e.localTransforms.buffer)}removeLodInstances(t,e){this._commands.push({id:"remove-lod-instances",lodRendererId:t,featureIds:e}),this._transferables.add(e.buffer)}append(t){if(t._context!==this._context)throw new Error("Cannot append encoders from different contexts");const{_commands:e,_transferables:r}=this;for(const n of t._commands)e.push(n);for(const n of t._transferables)r.add(n)}async dispatch(){const t=this._commands,e=Array.from(this._transferables);this._clearCommandBuffer(),await this._context.dispatchRenderCommands(t,e)}_clearCommandBuffer(){this._commands=[],this._transferables.clear()}};class jr{constructor(e){this._idCounter=0,this._bufferWriters=new Map,this._dispatchRenderCommandsCallback=async()=>{},this.globalViewingMode=!1,this.globalViewingMode=e.viewingMode===I.Global,this._dispatchRenderCommandsCallback=e.dispatchRenderCommandsCallback}generateId(e=""){return`${e}${this._idCounter++}`}createEncoder(){return new Dr(this)}async dispatchRenderCommands(e,r){e.length!==0&&await this._dispatchRenderCommandsCallback(e,r)}registerRenderGeometryBufferWriter(e,r){this._bufferWriters.set(e,r)}getRenderGeometryBufferWriter(e){return this._bufferWriters.get(e)}}let ne=class{constructor(t,e){this._renderCommands=t,this._pipelineStateCommands=e}append(t){this.appendRenderCommands(t._renderCommands),this.appendPipelineStateCommands(t._pipelineStateCommands)}appendRenderCommands(t){this._renderCommands.append(t)}appendPipelineStateCommand(t){this._pipelineStateCommands.push(t)}appendPipelineStateCommands(t){const{_pipelineStateCommands:e}=this;for(const r of t)e.push(r)}execute(){for(const t of this._pipelineStateCommands)t();this._renderCommands.dispatch()}};function se(t,e){const{featureCount:r}=t;if(r===0)return new Uint32Array;const n=new Uint32Array(r);return t.readObjectIds(n),n}function Ee(t,e){const{featureCount:r}=t;if(r===0)return new Float64Array;const n=new Float64Array(3*r);return t.readCoordinates(n),n}function kr(t,e){const{featureCount:r}=t;if(r===0)return new Float64Array;const n=Ee(t),s=e.viewSpatialReference,i=e.renderSpatialReference,a=new Float64Array(3*r);if(!it(n,s,0,a,i,0,r))throw new Error("Failed to project coordinates");return a}function Nr(t,e){const r=e.viewSpatialReference,n=e.renderSpatialReference,{extent:s}=t,i=Ze(s),a=A();return Z([i[0],i[1],0],r,a,n),a}function Fe(t){const e=new Map;for(const[r,n]of t)e.set(r,{...n,indices:xt(n.indices)});return e}function Ur(t,e){const r=(n,s,i=!1)=>({levels:n.map(a=>{const d=Fe(s(a.tesselation));return i&&zr(d),{components:[{attributes:d,objectAndLayerIdColor:void 0,transformation:null,materialId:e}],minScreenSpaceRadius:a.minScreenSpaceRadius}})});switch(t){case"cone":return r(Hr,n=>Vt(1,.5,n,!1),!0);case"sphere":case"cube":case"inverted-cone":case"cylinder":case"tetrahedron":case"diamond":throw new Error("not implemented");default:return}}function zr(t){const e=t,r=e.get(_.POSITION).data,n=e.get(_.NORMAL).data;if(n){const s=Oe(t,_.NORMAL).data;for(let i=0;i<n.length;i+=3){const a=n[i+1];s[i+1]=-n[i+2],s[i+2]=a}}if(r){const s=Oe(t,_.POSITION).data;for(let i=0;i<r.length;i+=3){const a=r[i+1];s[i+1]=-r[i+2],s[i+2]=a}}}function Oe(t,e){let r=t.get(e);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:Bt(r.data)},t.set(e,r)),r}const Hr=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];class Qr{constructor(e){this._context=e,this.lodRendererId=null,this._loaded=!1,this._loadingPromise=null,this._primitive="cone"}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder(),r=e.createMaterial("default"),n=Ur(this._primitive,r);this.lodRendererId=e.createLodRenderer(n),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const r=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)throw new Error("expected lod renderer id to not be null");const{featureCount:n}=e;if(n===0)return r;const s=!0,i=Xe(Ke(this._primitive)),a=me(et(i)),d=me(tt(a,{isPrimitive:s,width:100,depth:null,height:null})),o=new Float64Array(16*n),l=new Float64Array(16*n),c=Ee(e,this._context);for(let u=0;u<n;++u){const f=u,x=c[3*u+0],R=c[3*u+1],S=c[3*u+2],V=this._computeGlobalTransform(x,R,S,this._context.viewSpatialReference,qr),J=this._computeLocalTransform(d,a,Wr);this._writeMatrixToTypedBuffer(o,f,J),this._writeMatrixToTypedBuffer(l,f,V)}const h=se(e,this._context),m={featureIds:new Uint32Array(h),localTransforms:o,globalTransforms:l};return r.addLodInstances(this.lodRendererId,m),r}async createRemoveCommand(e){const r=this._context.renderCommandContext.createEncoder();if(this.lodRendererId==null)return r;const n=se(e,this._context);return r.removeLodInstances(this.lodRendererId,n),r}_writeMatrixToTypedBuffer(e,r,n){let s=16*r;for(let i=0;i<16;i++)e[s++]=n[i]}_computeGlobalTransform(e,r,n,s,i){return Q[0]=e,Q[1]=r,Q[2]=n,qt(s,Q,i,this._context.renderSpatialReference),i}_computeLocalTransform(e,r,n){return Qt(n),this._applyObjectScale(e,r,n),n}_applyObjectScale(e,r,n){const s=Jt(e,e,r,this._context.renderCoordsHelper.unitInMeters);s[0]===1&&s[1]===1&&s[2]===1||Wt(n,n,s)}}const Q=A(),Wr=B(),qr=B();class Vr{constructor(e){this._context=e,this.materialId=null,this._loaded=!1,this._loadingPromise=null}get loaded(){return this._loaded}load(){return this._loadingPromise==null&&(this._loadingPromise=this._load()),this._loadingPromise}async _load(){const e=this._context.renderCommandContext.createEncoder();this.materialId=e.createMaterial("hud"),e.createDirectRenderer(this.materialId),await e.dispatch(),this._loaded=!0}async createAddCommand(e){const r=this._context.renderCommandContext.createEncoder();if(this.materialId==null)throw new Error("expected material not to be null");const{featureCount:n,id:s}=e;if(n===0)return r;const i=kr(e,this._context),a=Nr(e,this._context),d=new Float64Array([0,0,1]),o=new Float64Array([255,255,255,255]),l=new Float64Array([24,24]),c=new Float64Array([0,0,0,1]),h=new Float64Array([0,0]),m=new Float64Array([0]),u=new Uint32Array(n);for(let w=0;w<n;++w)u[w]=w;const f=new Uint32Array(n);for(let w=0;w<n;++w)f[w]=0;const x=new v(i,u,3,!0),R=new v(d,f,3,!0),S=new v(h,f,2,!0),V=new v(o,f,4,!0),J=new v(m,f,1,!0),Ge=new v(l,f,2,!0),Le=new v(c,f,4,!0),De=[[_.POSITION,x],[_.NORMAL,R],[_.UV0,S],[_.COLOR,V],[_.ROTATION,J],[_.SIZE,Ge],[_.CENTEROFFSETANDDISTANCE,Le]],je={attributes:Fe(De),objectAndLayerIdColor:void 0,transformation:B(),materialId:this.materialId};return r.addDirectRendererGeometry(s,je,a),r}async createRemoveCommand(e){const r=this._context.renderCommandContext.createEncoder();return r.removeDirectRendererGeometry(e.id),r}}class Jr{constructor(e){this._symbols=new Array,this._featureDataPartitioning=new Map,this._context=e}async load(){this._symbols[0]=new Vr(this._context),this._symbols[1]=new Qr(this._context)}async createAddCommand(e){const r=this._partition(e),n=await Promise.all(r.map(async({index:i,features:a})=>await(await this._provisionSymbol(i))?.createAddCommand(a))),s=this._context.renderCommandContext.createEncoder();for(const i of n)i!=null&&s.append(i);return new ne(s,[()=>{this._featureDataPartitioning.set(e,r)}])}async createRemoveCommand(e){const{_featureDataPartitioning:r}=this,n=r.get(e),s=this._context.renderCommandContext.createEncoder();if(n==null)return new ne(this._context.renderCommandContext.createEncoder(),[]);const i=await Promise.all(n.map(async({index:a,features:d})=>await this._getLoadedSymbol(a)?.createRemoveCommand(d)));for(const a of i)a!=null&&s.append(a);return new ne(s,[()=>{r.delete(e)}])}async _provisionSymbol(e){if(e==null)return null;const r=this._symbols[e];return r?(r.loaded||await r.load(),r):null}_getLoadedSymbol(e){if(e==null)return null;const r=this._symbols[e];return r!=null&&r.loaded?r:null}_partition(e){const r=se(e,this._context);if(r==null)throw new Error("unable to fetch objectIds");const{featureCount:n}=e,s=[[],[]];for(let i=0;i<n;++i)s[r[i]%2].push(i);return s.map((i,a)=>new $r(a,e.subset(new Uint32Array(i)))).filter(i=>i.features.featureCount>0)}}class $r{constructor(e,r){this.index=e,this.features=r}}let W=class extends ue.EventedAccessor{constructor(){super(...arguments),this.remoteClient=null,this._featureDataStore=new br,this._featureStore=new Ir,this._tileManager=null,this._renderer=null,this._fetcher=null,this._queryEngine=null,this._defaultQueryJSON=null}get updating(){return this._tileManager.updating}destroy(){this._featureStore.clear(),this._tileManager?.destroy()}async setup({viewSpatialReference:t,renderSpatialReference:e,viewingMode:r,baseQuery:n,url:s,objectIdField:i,capabilities:a,fieldsIndex:d,timeInfo:o,fullExtent:l}){const c=fe.fromJSON(t),h=fe.fromJSON(e);this._fetcher=new Er(c,pe.fromJSON(n),s,i,a),this._queryEngine=new dt({hasZ:!0,hasM:!1,geometryType:"esriGeometryPoint",objectIdField:i,fieldsIndex:d,availableFields:[i],spatialReference:t,featureStore:this._featureStore,timeInfo:o}),this._renderer=new Jr({viewSpatialReference:c,renderSpatialReference:h,renderCoordsHelper:q.create(r,h),renderCommandContext:new jr({viewingMode:r,dispatchRenderCommandsCallback:(u,f)=>this.remoteClient.invoke("dispatchRenderCommands",u,{transferList:f})})}),this._defaultQueryJSON=new pe({outSpatialReference:c}).toJSON();let m=null;if(l!=null){const u=rt.fromJSON(l);await at(u.spatialReference,c),m=ot(u,c)}return this._tileManager=new y({loadTile:(u,f)=>this._fetcher.fetch(u,f),createAddTileCommand:(u,f)=>this._createAddTileCommand(u,f),createRemoveTileCommand:u=>this._createRemoveTileCommand(u),extent:m}),this.addHandles(nt(()=>this.updating,u=>{this.emit("notify-updating",{updating:u})}),st),await this._renderer.load(),Be}async executeQuery(t,e){return{result:await this._queryEngine.executeQuery(this._ensureQuery(t),e)}}async executeQueryForIds(t,e){const r=await this._queryEngine.executeQueryForIdSet(this._ensureQuery(t),e);return{result:Array.from(r)}}async executeQueryForCount(t,e){return{result:await this._queryEngine.executeQueryForCount(this._ensureQuery(t),e)}}async executeQueryForExtent(t,e){return{result:await this._queryEngine.executeQueryForExtent(this._ensureQuery(t),e)}}async executeQueryForLatestObservations(t,e){return{result:await this._queryEngine.executeQueryForLatestObservations(this._ensureQuery(t),e)}}async onTileTreeChange(t){return await this._tileManager.onTileTreeChange(t),Be}async _createAddTileCommand(t,e){const r=new wr(t),n=await this._renderer.createAddCommand(r);return j(e),n.appendPipelineStateCommand(()=>{this._featureDataStore.add(r),this._featureStore.addTile(t)}),n}async _createRemoveTileCommand(t){const e=this._featureStore,r=this._featureDataStore,n=this._renderer,s=r.get(t);if(s==null)return null;const i=await n.createRemoveCommand(s);return i.appendPipelineStateCommand(()=>{r.remove(t),e.removeTile(t)}),i}_ensureQuery(t){return t??this._defaultQueryJSON}};p([g()],W.prototype,"updating",null),W=p([F("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorker")],W);const Yr=W,Be={result:void 0};export{Yr as default};
