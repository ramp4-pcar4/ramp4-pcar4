{"version":3,"file":"CIMSymbolRasterizer-DA73qZaB.js","sources":["../../node_modules/@arcgis/core/symbols/cim/CIMSymbolRasterizer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.32/esri/copyright.txt for details.\n*/\nimport e from\"./CIMResourceManager.js\";import{Transformation as t,CanvasDrawHelper as i}from\"./CIMSymbolDrawHelper.js\";import{CIMSymbolHelper as h}from\"./CIMSymbolHelper.js\";import{OverrideHelper as r}from\"./OverrideHelper.js\";import{scale as n,translate as s}from\"./rasterizingUtils.js\";import{mapCIMSymbolToGeometryType as a}from\"./utils.js\";const o=96/72;class l{constructor(t){this._spatialReference=t,this._imageDataCanvas=null,this._cimResourceManager=new e}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement(\"canvas\")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,i,s,o,l,m,g,y,d){if(!e)return null;const{data:w}=e;if(!w||\"CIMSymbolReference\"!==w.type||!w.symbol)return null;const{symbol:u}=w;l||(l=a(u));const x=await r.resolveSymbolOverrides(w,t,this._spatialReference,o,l,m,g),f=this._cimResourceManager,p=[];h.fetchResources(x,f,p),h.fetchFonts(x,f,p),p.length>0&&await Promise.all(p);const{width:b,height:M}=i;let C=c(l,b,M,s,d);const R=h.getEnvelope(x,C,f);if(!R)return null;R.x===1/0&&(R.x=b+2),R.y===1/0&&(R.y=-M/2),R.width===-1/0&&(R.width=b),R.height===-1/0&&(R.height=M);let v=1,I=0,S=0;switch(u.type){case\"CIMPointSymbol\":case\"CIMTextSymbol\":{let e=1;R.width>b&&(e=b/R.width);let t=1;R.height>M&&(t=M/R.height),\"preview\"===s&&(R.width<b&&(e=b/R.width),R.height<M&&(t=M/R.height)),v=Math.min(e,t),I=R.x+R.width/2,S=R.y+R.height/2}break;case\"CIMLineSymbol\":if(d){S=R.y+R.height/2,I=R.x+R.width/2;const e=R.width-b,t=R.height-M;C={paths:n(C.paths,{xmin:-1*R.width/2+e,xmax:R.width/2-e,ymin:-1*R.height/2+t,ymax:R.height/2-t,width:R.width-2*e,height:R.height-2*t})}}else{(y||R.height>M)&&(v=M/R.height),S=R.y+R.height/2;const e=R.x*v+b/2,t=(R.x+R.width)*v+b/2,{paths:i}=C;i[0][0][0]-=e/v,i[0][2][0]-=(t-b)/v}break;case\"CIMPolygonSymbol\":if(d){S=R.y+R.height/2,I=R.x+R.width/2;const e=R.width-b,t=R.height-M;C={paths:n(C.rings,{xmin:-1*R.width/2+e,xmax:R.width/2-e,ymin:-1*R.height/2+t,ymax:R.height/2-t,width:R.width-2*e,height:R.height-2*t})}}else{I=R.x+R.width/2,S=R.y+R.height/2;const e=R.x*v+b/2,t=(R.x+R.width)*v+b/2,i=R.y*v+M/2,h=(R.y+R.height)*v+M/2,{rings:r}=C;e<0&&(r[0][0][0]-=e,r[0][3][0]-=e,r[0][4][0]-=e),i<0&&(r[0][0][1]+=i,r[0][1][1]+=i,r[0][4][1]+=i),t>b&&(r[0][1][0]-=t-b,r[0][2][0]-=t-b),h>M&&(r[0][2][1]+=h-M,r[0][3][1]+=h-M)}}const _={type:\"cim\",data:{type:\"CIMSymbolReference\",symbol:x}};return this.rasterize(_,b,M,I,S,v,l,1,C)}rasterize(e,h,r,n,s,l,m,g=0,y=null,d=window.devicePixelRatio||1){const{data:w}=e;if(!w||\"CIMSymbolReference\"!==w.type||!w.symbol)return null;const{symbol:u}=w,x=this._canvas,f=d*o;x.width=h*f,x.height=r*f,m||(m=a(u)),y||(y=c(m,h,r,\"legend\")),x.width+=2*g,x.height+=2*g;const p=x.getContext(\"2d\",{willReadFrequently:!0}),b=t.createIdentity();b.translate(-n,-s),b.scale(l*f,-l*f),b.translate(h*f/2+g,r*f/2+g),p.clearRect(0,0,x.width,x.height);return new i(p,this._cimResourceManager,b,!0).drawSymbol(u,y),p.getImageData(0,0,x.width,x.height)}}function m(e,t,i,h){if(\"esriGeometryPolygon\"===t){return{rings:s(n(e.rings,{xmin:0,ymin:0,xmax:i,ymax:h,width:i,height:h}),-1*i/2,-1*h/2)}}if(\"esriGeometryPolyline\"===t){return{paths:s(n(e.paths,{xmin:0,ymin:0,xmax:i,ymax:h,width:i,height:h}),-1*i/2,-1*h/2)}}return null}function c(e,t,i,h,r){const n=1,s=-t/2+n,a=t/2-n,o=i/2-n,l=-i/2+n;if(r&&(\"esriGeometryPolygon\"===e||\"esriGeometryPolyline\"===e)){const h=m(r,e,t,i);if(h)return h}switch(e){case\"esriGeometryPoint\":return{x:0,y:0};case\"esriGeometryPolyline\":return{paths:[[[s,0],[0,0],[a,0]]]};default:return\"legend\"===h?{rings:[[[s,o],[a,0],[a,l],[s,l],[s,o]]]}:{rings:[[[s,o],[a,o],[a,l],[s,l],[s,o]]]}}}export{l as CIMSymbolRasterizer};\n"],"names":["o","l","t","e","i","s","m","g","y","d","w","u","a","x","r","f","h","b","M","C","c","R","v","I","S","n","_"],"mappings":"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","x_google_ignoreList":[0]}