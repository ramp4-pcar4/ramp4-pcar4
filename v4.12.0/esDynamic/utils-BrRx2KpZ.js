import{n as le,fv as ae,bQ as ie,an as se,aL as oe,c3 as ue,Q as re,bo as ce,s as C}from"./main-DnzmeE4U.js";import{r as $}from"./TimeExtent-gZaEUVeW.js";import{j as fe}from"./quantizationUtils-Cndke4AR.js";import{l as me,u as de}from"./heatmapUtils--OU2Fakh.js";import{$ as pe}from"./utils-BG7WTOnW.js";import{d as he}from"./ClassBreaksDefinition-B_vYk3bu.js";const ge=()=>le.getLogger("esri.rest.support.generateRendererUtils");function N(e,t){return Number(e.toFixed(t))}function be(e){const t=G(e),n=[],a=t.uniqueValues.length;for(let l=0;l<a;l++){const c=t.uniqueValues[l],u=t.valueFrequency[l],i=c.toString();n.push({value:c,count:u,label:i})}return{uniqueValues:n}}function B(e,t){const{normalizationTotal:n}=e;return{classBreaks:Ve(e,t),normalizationTotal:n}}function Ve(e,t){const n=e.definition,{classificationMethod:a,normalizationType:l,definedInterval:c}=n,u=n.breakCount??1,i=[];let r=e.values;if(r.length===0)return[];r=r.sort((f,s)=>f-s);const[h,d]=t??[r.at(0),r.at(-1)];if(a==="equal-interval")if(r.length>=u){const f=(d-h)/u;let s=h;for(let o=1;o<u;o++){const m=N(h+o*f,6);i.push({minValue:s,maxValue:m,label:v(s,m,l)}),s=m}i.push({minValue:s,maxValue:d,label:v(s,d,l)})}else r.forEach(f=>{i.push({minValue:f,maxValue:f,label:v(f,f,l)})});else if(a==="natural-breaks"){const f=G(r),s=e.valueFrequency||f.valueFrequency,o=ve(f.uniqueValues,s,u);let m=h;for(let p=1;p<u;p++)if(f.uniqueValues.length>p){const g=N(f.uniqueValues[o[p]],6);i.push({minValue:m,maxValue:g,label:v(m,g,l)}),m=g}i.push({minValue:m,maxValue:d,label:v(m,d,l)})}else if(a==="quantile")if(r.length>=u&&h!==d){let f=h,s=Math.ceil(r.length/u),o=0;for(let m=1;m<u;m++){let p=s+o-1;p>r.length&&(p=r.length-1),p<0&&(p=0),i.push({minValue:f,maxValue:r[p],label:v(f,r[p],l)}),f=r[p],o+=s,s=Math.ceil((r.length-o)/(u-m))}i.push({minValue:f,maxValue:d,label:v(f,d,l)})}else{let f=-1;for(let s=0;s<r.length;s++){const o=r[s];o!==f&&(f=o,i.push({minValue:f,maxValue:o,label:v(f,o,l)}),f=o)}}else if(a==="standard-deviation"){const f=Te(r),s=Fe(r,f);if(s===0)i.push({minValue:r[0],maxValue:r[0],label:v(r[0],r[0],l)});else{const o=ye(h,d,u,f,s)*s;let m=0,p=h;for(let V=u;V>=1;V--){const x=N(f-(V-.5)*o,6);i.push({minValue:p,maxValue:x,label:v(p,x,l)}),p=x,m++}let g=N(f+.5*o,6);i.push({minValue:p,maxValue:g,label:v(p,g,l)}),p=g,m++;for(let V=1;V<=u;V++)g=m===2*u?d:N(f+(V+.5)*o,6),i.push({minValue:p,maxValue:g,label:v(p,g,l)}),p=g,m++}}else if(a==="defined-interval"){if(!c)return i;const[f,s]=t??[r.at(0),r.at(-1)],o=Math.ceil((s-f)/c);let m=f;for(let p=1;p<o;p++){const g=N(f+p*c,6);i.push({minValue:m,maxValue:g,label:v(m,g,l)}),m=g}i.push({minValue:m,maxValue:s,label:v(m,s,l)})}return i}function v(e,t,n){let a=null;return a=e===t?n&&n==="percent-of-total"?e+"%":e.toString():n&&n==="percent-of-total"?e+"% - "+t+"%":e+" - "+t,a}function G(e){const t=[],n=[];let a=Number.MIN_VALUE,l=1,c=-1;for(let u=0;u<e.length;u++){const i=e[u];i===a?(l++,n[c]=l):i!==null&&(t.push(i),a=i,l=1,n.push(l),c++)}return{uniqueValues:t,valueFrequency:n}}function ve(e,t,n){const a=e.length,l=[];n>a&&(n=a);for(let u=0;u<n;u++)l.push(Math.round(u*a/n-1));l.push(a-1);let c=L(l,e,t,n);return xe(c.mean,c.sdcm,l,e,t,n)&&(c=L(l,e,t,n)),l}function L(e,t,n,a){let l=[],c=[],u=[],i=0;const r=[],h=[];for(let o=0;o<a;o++){const m=z(o,e,t,n);r.push(m.sbMean),h.push(m.sbSdcm),i+=h[o]}let d,f=i,s=!0;for(;s||i<f;){s=!1,l=[];for(let o=0;o<a;o++)l.push(e[o]);for(let o=0;o<a;o++)for(let m=e[o]+1;m<=e[o+1];m++)if(d=t[m],o>0&&m!==e[o+1]&&Math.abs(d-r[o])>Math.abs(d-r[o-1]))e[o]=m;else if(o<a-1&&e[o]!==m-1&&Math.abs(d-r[o])>Math.abs(d-r[o+1])){e[o+1]=m-1;break}f=i,i=0,c=[],u=[];for(let o=0;o<a;o++){c.push(r[o]),u.push(h[o]);const m=z(o,e,t,n);r[o]=m.sbMean,h[o]=m.sbSdcm,i+=h[o]}}if(i>f){for(let o=0;o<a;o++)e[o]=l[o],r[o]=c[o],h[o]=u[o];i=f}return{mean:r,sdcm:h}}function xe(e,t,n,a,l,c){let u=0,i=0,r=0,h=0,d=!0;for(let f=0;f<2&&d;f++){f===0&&(d=!1);for(let s=0;s<c-1;s++)for(;n[s+1]+1!==n[s+2];){n[s+1]=n[s+1]+1;const o=z(s,n,a,l);r=o.sbMean,u=o.sbSdcm;const m=z(s+1,n,a,l);if(h=m.sbMean,i=m.sbSdcm,!(u+i<t[s]+t[s+1])){n[s+1]=n[s+1]-1;break}t[s]=u,t[s+1]=i,e[s]=r,e[s+1]=h,d=!0}for(let s=c-1;s>0;s--)for(;n[s]!==n[s-1]+1;){n[s]=n[s]-1;const o=z(s-1,n,a,l);r=o.sbMean,u=o.sbSdcm;const m=z(s,n,a,l);if(h=m.sbMean,i=m.sbSdcm,!(u+i<t[s-1]+t[s])){n[s]=n[s]+1;break}t[s-1]=u,t[s]=i,e[s-1]=r,e[s]=h,d=!0}}return d}function ye(e,t,n,a,l){let c=Math.max(a-e,t-a)/l/n;return c=c>=1?1:c>=.5?.5:.25,c}function Te(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n];return t/=e.length,t}function Fe(e,t){let n=0;for(let a=0;a<e.length;a++){const l=e[a];n+=(l-t)*(l-t)}return n/=e.length,Math.sqrt(n)}function z(e,t,n,a){let l=0,c=0;for(let r=t[e]+1;r<=t[e+1];r++){const h=a[r];l+=n[r]*h,c+=h}c<=0&&ge().warn("Exception in Natural Breaks calculation");const u=l/c;let i=0;for(let r=t[e]+1;r<=t[e+1];r++)i+=a[r]*(n[r]-u)**2;return{sbMean:u,sbSdcm:i}}const Ie="<Null>",Me="equal-interval",Ne=1,ze=5,Se=10,De=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,we=new Set(["esriFieldTypeDate","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeOID","esriFieldTypeBigInteger"]),qe=new Set(["esriFieldTypeTimeOnly","esriFieldTypeDateOnly"]),P=["min","max","avg","stddev","count","sum","variance","nullcount","median"];function T(e){return e==null||typeof e=="string"&&!e?Ie:e}function A(e){const t=e.normalizationField!=null||e.normalizationType!=null,n=e.minValue!=null||e.maxValue!=null,a=!!e.sqlExpression&&e.supportsSQLExpression;return!t&&!n&&!a}function ke(e){const{outStatisticTypes:t}=e,n=e.returnDistinct?[...new Set(e.values)]:e.values,a=n.filter(u=>u!=null).sort(),l=a.length,c={count:l,min:a[0],max:a[l-1]};return e.supportsNullCount&&(c.nullcount=n.length-l),!e.percentileParams||t?.include?.length&&!t.include.includes("median")||t?.exclude?.length&&t.exclude.includes("median")||(c.median=E(n,e.percentileParams)),c}function Y(e){const{values:t,useSampleStdDev:n,supportsNullCount:a,outStatisticTypes:l}=e;let c=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,i=null,r=null,h=null,d=null,f=0;const s=e.minValue==null?-1/0:e.minValue,o=e.maxValue==null?1/0:e.maxValue;for(const p of t)Number.isFinite(p)?p>=s&&p<=o&&(i=i===null?p:i+p,c=Math.min(c,p),u=Math.max(u,p),f++):typeof p=="string"&&f++;if(f&&i!=null){r=i/f;let p=0;for(const g of t)Number.isFinite(g)&&g>=s&&g<=o&&(p+=(g-r)**2);d=n?f>1?p/(f-1):0:f>0?p/f:0,h=Math.sqrt(d)}else c=null,u=null;const m={avg:r,count:f,max:u,min:c,stddev:h,sum:i,variance:d};return a&&(m.nullcount=t.length-f),!e.percentileParams||l?.include?.length&&!l.include.includes("median")||l?.exclude?.length&&l.exclude.includes("median")||(m.median=E(t,e.percentileParams)),m}function E(e,t){const{fieldType:n,value:a,orderBy:l,isDiscrete:c}=t,u=j(n,l==="desc");if((e=[...e].filter(o=>o!=null).sort((o,m)=>u(o,m))).length===0)return null;if(a<=0)return e[0];if(a>=1)return e[e.length-1];const i=(e.length-1)*a,r=Math.floor(i),h=r+1,d=i%1,f=e[r],s=e[h];return h>=e.length||c||typeof f=="string"||typeof s=="string"?f:f*(1-d)+s*d}function j(e,t){if(e){if(we.has(e))return _(t);if(qe.has(e))return U(t,!1);if(e==="esriFieldTypeTimestampOffset")return Ee(t);const u=U(t,!0);if(e==="esriFieldTypeString")return u;if(e==="esriFieldTypeGUID"||e==="esriFieldTypeGlobalID")return(i,r)=>u(Q(i),Q(r))}const n=t?1:-1,a=_(t),l=U(t,!0),c=R(t);return(u,i)=>typeof u=="number"&&typeof i=="number"?a(u,i):typeof u=="string"&&typeof i=="string"?l(u,i):c(u,i)??n}const w=(e,t)=>e==null?t==null?0:1:t==null?-1:null,q=(e,t)=>e==null?t==null?0:-1:t==null?1:null;function R(e){return e?w:q}const Ce=(e,t)=>q(e,t)??(e===t?0:new Date(e).getTime()-new Date(t).getTime()),$e=(e,t)=>w(e,t)??(e===t?0:new Date(t).getTime()-new Date(e).getTime());function Ee(e){return e?$e:Ce}const Ue=(e,t)=>q(e,t)??(e===t?0:e<t?-1:1),Oe=(e,t)=>w(e,t)??(e===t?0:e<t?1:-1);function U(e,t){if(!t)return e?Oe:Ue;const n=R(e);return e?(a,l)=>n(a,l)??((a=a.toUpperCase())>(l=l.toUpperCase())?-1:a<l?1:0):(a,l)=>n(a,l)??((a=a.toUpperCase())<(l=l.toUpperCase())?-1:a>l?1:0)}const Be=(e,t)=>w(e,t)??t-e,Ge=(e,t)=>q(e,t)??e-t;function _(e){return e?Be:Ge}function Q(e){return e.slice(24,36)+e.slice(19,23)+e.slice(16,18)+e.slice(14,16)+e.slice(11,13)+e.slice(9,11)+e.slice(6,8)+e.slice(4,6)+e.slice(2,4)+e.slice(0,2)}function Le(e,t,n){let a;for(a in e)t?.include?.length&&!t.include.includes(a)||t?.exclude?.length&&t.exclude.includes(a)?delete e[a]:P.includes(a)&&(Number.isFinite(e[a])||(e[a]=null));return n&&["avg","stddev","variance"].forEach(l=>{e[l]!=null&&(e[l]=Math.ceil(e[l]??0))}),e}function Pe(e){const t={};for(let n of e)(n==null||typeof n=="string"&&n.trim()==="")&&(n=null),t[n]==null?t[n]={count:1,data:n}:t[n].count++;return{count:t}}function O(e){return e?.type!=="coded-value"?[]:e.codedValues.map(t=>t.code)}function Ae(e,t,n,a){const l=e.count,c=[];if(n&&t){const u=[],i=O(t[0]);for(const r of i)if(t[1]){const h=O(t[1]);for(const d of h)if(t[2]){const f=O(t[2]);for(const s of f)u.push(`${T(r)}${a}${T(d)}${a}${T(s)}`)}else u.push(`${T(r)}${a}${T(d)}`)}else u.push(r);for(const r of u)l.hasOwnProperty(r)||(l[r]={data:r,count:0})}for(const u in l){const i=l[u];c.push({value:i.data,count:i.count,label:i.label})}return{uniqueValueInfos:c}}function J(e,t,n,a){let l=null;switch(t){case"log":e!==0&&(l=Math.log(e)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(a)&&a!==0&&(l=e/a*100);break;case"field":Number.isFinite(n)&&n!==0&&(l=e/n);break;case"natural-log":e>0&&(l=Math.log(e));break;case"square-root":e>0&&(l=e**.5)}return l}function K(e,t,n){const a=W({field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,classificationMethod:t.classificationMethod,standardDeviationInterval:t.standardDeviationInterval,definedInterval:t.definedInterval,breakCount:t.numClasses||ze});return e=Ye(e,t.minValue,t.maxValue),B({definition:a,values:e,normalizationTotal:t.normalizationTotal},n)}function Ye(e,t,n){const a=t??-1/0,l=n??1/0;return e.filter(c=>Number.isFinite(c)&&c>=a&&c<=l)}function W(e){const{breakCount:t,field:n,normalizationField:a,normalizationType:l}=e,c=e.classificationMethod||Me,u=c==="standard-deviation"?e.standardDeviationInterval||Ne:void 0,i=c==="defined-interval"?e.definedInterval:void 0;return new he({breakCount:t,classificationField:n,classificationMethod:c,normalizationField:l==="field"?a:void 0,normalizationType:l,standardDeviationInterval:u,definedInterval:i})}function je(e,t){let n=e.classBreaks;const a=n.length,l=n[0]?.minValue,c=n[a-1]?.maxValue,u=t==="standard-deviation",i=De;return n=n.map(r=>{const h=r.label,d={minValue:r.minValue,maxValue:r.maxValue,label:h};if(u&&h){const f=h.match(i),s=f?.map(o=>+o.trim())??[];s.length===2?(d.minStdDev=s[0],d.maxStdDev=s[1],s[0]<0&&s[1]>0&&(d.hasAvg=!0)):s.length===1&&(h.includes("<")?(d.minStdDev=null,d.maxStdDev=s[0]):h.includes(">")&&(d.minStdDev=s[0],d.maxStdDev=null))}return d}),{minValue:l,maxValue:c,classBreakInfos:n,normalizationTotal:e.normalizationTotal}}function Re(e,t){const n=X(e,t);if(n.min==null&&n.max==null)return{bins:[],minValue:n.min,maxValue:n.max,normalizationTotal:t.normalizationTotal};const a=n.intervals,l=n.min??0,c=n.max??0,u=a.map((i,r)=>({minValue:a[r][0],maxValue:a[r][1],count:0}));for(const i of e)if(i!=null&&i>=l&&i<=c){const r=Z(a,i);r>-1&&u[r].count++}return{bins:u,minValue:l,maxValue:c,normalizationTotal:t.normalizationTotal}}function X(e,t,n=!1){const{field:a,classificationMethod:l,standardDeviationInterval:c,definedInterval:u,normalizationType:i,normalizationField:r,normalizationTotal:h,minValue:d,maxValue:f}=t,s=t.numBins||Se;let o=null,m=null,p=null;if((!l||l==="equal-interval")&&!i){if(d!=null&&f!=null)o=d,m=f;else{const g=Y({values:e,minValue:d,maxValue:f,useSampleStdDev:!i,supportsNullCount:A({normalizationType:i,normalizationField:r,minValue:d,maxValue:f})});o=g.min??null,m=g.max??null}p=H(o??0,m??0,s)}else{const{classBreaks:g}=K(e,{field:a,normalizationType:i,normalizationField:r,normalizationTotal:h,classificationMethod:l,standardDeviationInterval:c,definedInterval:u,minValue:d,maxValue:f,numClasses:s},d!=null&&f!=null?[d,f]:void 0);o=g[0]?.minValue,m=g[g.length-1]?.maxValue,p=g.map(V=>[V.minValue,V.maxValue])}if(n){const g=p.at(-1)[1];p.push([g,g])}return{min:o,max:m,intervals:p}}function Z(e,t){let n=-1;for(let a=e.length-1;a>=0;a--)if(t>=e[a][0]){n=a;break}return n}function H(e,t,n){const a=(t-e)/n,l=[];let c,u=e;for(let i=1;i<=n;i++)c=u+a,c=Number(c.toFixed(16)),l.push([u,i===n?t:c]),u=c;return l}let F=null;const _e=/^(?<hh>([0-1][0-9])|([2][0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?([.](?<ms>\d+))?$/;function Qe(e,t,n){return e.x<0?e.x+=t:e.x>n&&(e.x-=t),e}function Je(e,t,n,a){const l=ae(n)?ie(n):null,c=l?Math.round((l.valid[1]-l.valid[0])/t.scale[0]):null;return e.map(u=>{const i=new se(u.geometry);return fe(t,i,i),u.geometry=l?Qe(i,c??0,a[0]):i,u})}function Ke(e,t=18,n,a,l){const c=new Float64Array(a*l);t=Math.round(ce(t));let u=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;const r=de(n);for(const{geometry:h,attributes:d}of e){const{x:f,y:s}=h,o=Math.max(0,f-t),m=Math.max(0,s-t),p=Math.min(l,s+t),g=Math.min(a,f+t),V=+r(d);for(let x=m;x<p;x++)for(let I=o;I<g;I++){const S=x*a+I,D=me(I-f,x-s,t)*V,y=c[S]+=D;u=Math.min(u,y),i=Math.max(i,y)}}return{min:u,max:i}}function ee(e){const t=_e.exec(e);if(!t)return null;const{hh:n,mm:a,ss:l,ms:c}=t.groups;return Number(n)*$.hours+Number(a)*$.minutes+Number(l)*$.seconds+Number(c||0)}async function We(e,t,n=!0){if(!t)return[];const{field:a,field2:l,field3:c,fieldDelimiter:u,fieldInfos:i,timeZone:r}=e,h=a&&i?.find(y=>y.name.toLowerCase()===a.toLowerCase()),d=!!h&&oe(h),f=!!h&&pe(h),s=e.valueExpression,o=e.normalizationType,m=e.normalizationField,p=e.normalizationTotal,g=[],V=e.viewInfoParams;let x=null,I=null;if(s){if(!F){const{arcadeUtils:y}=await ue();F=y}F.hasGeometryOperations(s)&&await F.enableGeometryOperations(),x=F.createFunction(s),I=V?F.getViewInfo({viewingMode:V.viewingMode,scale:V.scale,spatialReference:new re(V.spatialReference)}):null}const S=e.fieldInfos,D=!(t[0]&&"declaredClass"in t[0]&&t[0].declaredClass==="esri.Graphic")&&S?{fields:S}:null;return t.forEach(y=>{const M=y.attributes;let b;if(s){const k=D?{...y,layer:D}:y,ne=F.createExecContext(k,I,r);b=F.executeFunction(x,ne)}else M&&(b=M[a],l?(b=`${T(b)}${u}${T(M[l])}`,c&&(b=`${b}${u}${T(M[c])}`)):typeof b=="string"&&n&&(f?b=b?new Date(b).getTime():null:d&&(b=b?ee(b):null)));if(o&&typeof b=="number"&&isFinite(b)){const k=M&&parseFloat(M[m]);b=J(b,o,k,p)}g.push(b)}),g}function Xe(e){const t=e.field,n=e.normalizationType,a=e.normalizationField;let l;return n==="field"?l="(NOT "+a+" = 0)":n!=="log"&&n!=="natural-log"&&n!=="square-root"||(l=`(${t} > 0)`),l}function Ze(e,t,n){const a=t!=null?e+" >= "+t:"",l=n!=null?e+" <= "+n:"";let c="";return c=a&&l?te(a,l):a||l,c?"("+c+")":""}function te(e,t){let n=e??"";return t!=null&&t&&(n=n?"("+n+") AND ("+t+")":t),n}function He(e,t){if(e&&e.spatialRelationship!=="intersects")return new C(t,"Only 'intersects' spatialRelationship is supported for featureFilter")}function et(e,t,n){const a=tt({layer:e,fields:t});if(a.length)return new C(n,"Unknown fields: "+a.join(", ")+". You can only use fields defined in the layer schema");const l=nt({layer:e,fields:t});return l.length?new C(n,"Unsupported fields: "+l.join(", ")+". You can only use fields that can be fetched i.e. AdapterFieldUsageInfo.supportsStatistics must be true"):void 0}function tt(e){const t=e.layer;return e.fields.filter(n=>!t.getField(n))}function nt(e){const t=e.layer;return e.fields.filter(n=>{const a=t.getFieldUsageInfo(n);return!a||!a.supportsStatistics})}export{Ae as $,J as B,Le as C,K as E,Xe as F,X as G,ee as I,Z as L,He as M,Ze as N,je as P,et as T,Re as U,te as a,We as b,P as c,A as d,B as e,ke as f,j as g,H as j,Pe as k,T as m,be as n,Y as p,W as q,E as v,Ke as w,Je as x};
