{"version":3,"file":"index-gm4v5ic3.js","sources":["../../src/fixtures/northarrow/api/northarrow.ts","../../src/fixtures/northarrow/northarrow.vue","../../src/fixtures/northarrow/index.ts"],"sourcesContent":["import { FixtureInstance } from '@/api';\nimport { useNortharrowStore } from '../store';\nimport type { NortharrowConfig } from '../store';\n\nexport class NortharrowAPI extends FixtureInstance {\n    /**\n     * Parses the north arrow config JSON snippet from the config file and save to the fixture store.\n     *\n     * @param {NortharrowConfig} [northarrowConfig]\n     * @memberof NortharrowAPI\n     */\n    _parseConfig(northarrowConfig?: NortharrowConfig) {\n        const northarrowStore = useNortharrowStore(this.$vApp.$pinia);\n\n        if (!northarrowConfig) return;\n        northarrowStore.arrowIcon = northarrowConfig.arrowIcon;\n        northarrowStore.poleIcon = northarrowConfig.poleIcon;\n    }\n\n    get config(): NortharrowConfig {\n        return super.config;\n    }\n}\n","<template>\n    <div\n        class=\"absolute transition-all duration-300 ease-out\"\n        :style=\"{\n            'transform-origin': `top center`,\n            transform: `rotate(${angle}deg)`,\n            left: `${arrowLeft}px`,\n            visibility: displayArrow ? `visible` : `hidden`\n        }\"\n        ref=\"el\"\n    >\n        <span class=\"northarrow\" v-html=\"arrow\"></span>\n    </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { computed, inject, onBeforeUnmount, onMounted, reactive, ref } from 'vue';\n\nimport { useNortharrowStore } from './store';\nimport { GlobalEvents, CommonGraphicLayer, InstanceAPI } from '@/api/internal';\nimport {\n    Graphic,\n    Extent,\n    LayerType,\n    Point,\n    type PointIconStyleOptions,\n    type PointMarkerStyleOptions,\n    PointStyle,\n    PointStyleType,\n    type RampBasemapConfig,\n    type RampMapConfig,\n    type RampTileSchemaConfig\n} from '@/geo/api';\nimport { useConfigStore } from '@/stores/config';\nimport flag from './flag.json';\nimport { debounce } from 'throttle-debounce';\nimport { POLE_MARKER_LAYER_ID } from '.'; // imports from index.ts\n\nconst configStore = useConfigStore();\nconst northarrowStore = useNortharrowStore();\nconst iApi = inject('iApi') as InstanceAPI;\nconst el = ref();\n\nconst arrowIcon = computed(() => northarrowStore.arrowIcon);\nconst poleIcon = computed(() => northarrowStore.poleIcon);\nconst angle = ref(0);\nconst arrowLeft = ref(0);\nconst displayArrow = ref(false);\nconst arrow =\n    ref(`<svg xmlns=\"http://www.w3.org/2000/svg\" fit=\"\"  width=\"25\" preserveAspectRatio=\"xMidYMid meet\" viewBox=\"0 0 24 24\" focusable=\"false\">\n                <g id=\"northarrow\" transform=\"translate(-285.24 -142.234)\">\n                    <path id=\"path3770-7\" d=\"M305.91 156.648a8.652 8.652 0 0 1-8.654 8.653 8.652 8.652 0 0 1-8.653-8.653 8.653 8.653 0 0 1 8.653-8.653 8.653 8.653 0 0 1 8.653 8.653z\" fill=\"#fff\" stroke=\"#fff\" stroke-width=\".895\"/>\n                    <path id=\"path3770\" d=\"M304.982 156.648a7.725 7.725 0 0 1-7.726 7.726 7.725 7.725 0 0 1-7.726-7.726 7.725 7.725 0 0 1 7.726-7.726 7.725 7.725 0 0 1 7.726 7.726z\" fill=\"none\" stroke=\"#6d6d6d\" stroke-width=\".799\"/>\n                    <path id=\"path3774\" d=\"M297.256 156.648v-8.525\" fill=\"none\" stroke=\"#000\" stroke-width=\".067\"/>\n                    <path d=\"M297.258 143.48l8.793 22.432-8.811-8.812-8.812 8.812z\" id=\"path3778\" fill=\"#fff\" stroke=\"#fff\" stroke-width=\".912\"/>\n                    <path d=\"M297.256 144.805l7.726 19.568-7.726-7.726-7.726 7.726z\" id=\"path3780\" fill=\"#d6d6d6\" stroke=\"#000\" stroke-width=\".266\" stroke-linecap=\"square\"/>\n                    <path id=\"path6038\" d=\"M297.256 144.666l-7.726 19.568 7.726-7.726\" fill=\"#6d6d6d\" stroke-width=\".296\" stroke-linecap=\"square\"/>\n                </g>\n            </svg>`);\nconst poleMarkerAdded = ref(false);\nconst handlers = reactive<Array<string>>([]);\n\nconst tileSchemas = ref<Array<RampTileSchemaConfig>>([]);\nlet basemap: RampBasemapConfig;\n\nonMounted(() => {\n    const mapConfig = configStore.config.map as RampMapConfig;\n    tileSchemas.value = mapConfig.tileSchemas;\n    if (arrowIcon?.value) {\n        arrow.value = `<img width='25' src='${arrowIcon.value}'>`;\n    }\n    // don't think this condition should be needed but sometimes errors at startup without it\n    // TODO could this type of thing be moved to the `initialized()` handler of the FixtureInstance, once implemented?\n    if (iApi.geo.map.esriView?.ready) {\n        updateNortharrow(iApi.geo.map.getExtent());\n    }\n\n    handlers.push(iApi.event.on(GlobalEvents.MAP_EXTENTCHANGE, debounce(300, updateNortharrow)));\n});\n\nonBeforeUnmount(() => {\n    handlers.forEach(h => iApi.event.off(h));\n});\n\nconst updateNortharrow = async (newExtent: Extent) => {\n    // determine if there is a hasNorthPole configured\n    basemap = configStore.activeBasemapConfig!;\n    let hasNorthPole: boolean | undefined;\n    for (const tile of tileSchemas.value) {\n        if (basemap?.tileSchemaId === tile.id) {\n            hasNorthPole = tile?.hasNorthPole;\n            break;\n        }\n    }\n\n    const innerShell = iApi.$vApp.$el.querySelector('.inner-shell')!;\n    const arrowWidth = el.value.querySelector('.northarrow')!.getBoundingClientRect().width;\n    const appbarWidth = iApi.$vApp.$el.querySelector('.appbar')?.clientWidth || 0;\n    const sr = newExtent.sr;\n\n    if (hasNorthPole || (typeof hasNorthPole === 'undefined' && !sr.isWebMercator())) {\n        // set up northpole if it is configured or if it isn't configured and the map isn't mercator\n        // north value (set longitude to be half of Canada extent (141° W, 52° W))\n        const pole: Point = new Point('pole', { x: -96, y: 90 });\n        const projPole = (await iApi.geo.proj.projectGeometry(sr, pole)) as Point;\n        const poleScreenPos = iApi.geo.map.mapPointToScreenPoint(projPole);\n        if (poleScreenPos.screenY < 0) {\n            // draw arrow if pole not visibile\n            displayArrow.value = true;\n            // get angle from bottom centre\n            const bcScreenPos = {\n                screenX: innerShell.clientWidth / 2,\n                screenY: innerShell.clientHeight\n            };\n            angle.value =\n                (Math.atan(\n                    (poleScreenPos.screenX - bcScreenPos.screenX) / (bcScreenPos.screenY - poleScreenPos.screenY)\n                ) *\n                    180) /\n                Math.PI;\n            arrowLeft.value =\n                innerShell.clientWidth / 2 +\n                innerShell.clientHeight * Math.tan((angle.value * Math.PI) / 180) -\n                arrowWidth / 2;\n            // make sure arrow is within visible part of map\n            arrowLeft.value = Math.max(\n                appbarWidth - arrowWidth / 2,\n                Math.min(iApi.geo.map.getPixelWidth() - arrowWidth / 2, arrowLeft.value)\n            );\n        } else {\n            // add pole marker if visible\n            displayArrow.value = false;\n            if (!poleMarkerAdded.value) {\n                poleMarkerAdded.value = true;\n\n                let poleStyleParams;\n                if (poleIcon.value) {\n                    // fixture config has provided a custom image.\n                    // TODO do we need to parameterize the additonal options? offsets? height?\n                    //      we would need to expand what our config schema accepts. Right now\n                    //      you can only specify an icon image. Maybe we should allow the option\n                    //      to pass any Option param object that a PointStyle class can accept.\n                    poleStyleParams = {\n                        style: PointStyleType.ICON,\n                        icon: poleIcon.value,\n                        height: 16.5,\n                        width: 16.5\n                    };\n                } else {\n                    // grab data from our default in flag.json\n                    poleStyleParams = flag;\n                }\n\n                const poleLayer = iApi.geo.layer.createLayer({\n                    id: POLE_MARKER_LAYER_ID,\n                    layerType: LayerType.GRAPHIC,\n                    url: '',\n                    cosmetic: true, // mark this layer as a cosmetic layer\n                    system: true\n                });\n                iApi.geo.map.addLayer(poleLayer);\n\n                poleLayer.loadPromise().then(() => {\n                    const poleGraphic = new Graphic(projPole, 'northpole');\n                    const poleStyle = new PointStyle(\n                        poleStyleParams as PointIconStyleOptions | PointMarkerStyleOptions\n                    );\n                    poleGraphic.style = poleStyle;\n\n                    (poleLayer as CommonGraphicLayer).addGraphic(poleGraphic);\n                });\n            }\n        }\n    } else {\n        // don't specify a northpole if it isn't configured or if the map is mercator\n        displayArrow.value = true;\n        angle.value = 0;\n        arrowLeft.value = appbarWidth + (innerShell.clientWidth - appbarWidth - arrowWidth) / 2;\n    }\n};\n</script>\n\n<style lang=\"scss\" scoped></style>\n","import { NortharrowAPI } from './api/northarrow';\nimport { type NortharrowConfig, useNortharrowStore } from './store/index';\nimport NortharrowV from './northarrow.vue';\n\nexport const POLE_MARKER_LAYER_ID: string = 'RampPoleMarker';\n\nclass NortharrowFixture extends NortharrowAPI {\n    async added() {\n        // console.log(`[fixture] ${this.id} added`);\n\n        this._parseConfig(this.config);\n        const unwatch = this.$vApp.$watch(\n            () => this.config,\n            (value: NortharrowConfig | undefined) => this._parseConfig(value)\n        );\n\n        const { destroy, el } = this.mount(NortharrowV, {\n            app: this.$element\n        });\n        const innerShell = this.$vApp.$el.getElementsByClassName('inner-shell')[0];\n        innerShell.appendChild(el.childNodes[0]);\n\n        // override the removed method here to get access to scope\n        this.removed = () => {\n            // console.log(`[fixture] ${this.id} removed`);\n\n            unwatch();\n\n            // remove the pole marker layer if it exists\n            if (this.$iApi.geo.layer.getLayer(POLE_MARKER_LAYER_ID)) {\n                this.$iApi.geo.map.removeLayer(POLE_MARKER_LAYER_ID);\n            }\n\n            const northarrowStore = useNortharrowStore(this.$vApp.$pinia);\n            northarrowStore.$reset();\n\n            destroy();\n        };\n    }\n}\n\nexport default NortharrowFixture;\n"],"names":["NortharrowAPI","FixtureInstance","northarrowConfig","northarrowStore","useNortharrowStore","configStore","useConfigStore","iApi","inject","el","ref","arrowIcon","computed","poleIcon","angle","arrowLeft","displayArrow","arrow","poleMarkerAdded","handlers","reactive","tileSchemas","basemap","onMounted","mapConfig","updateNortharrow","GlobalEvents","debounce","onBeforeUnmount","h","newExtent","hasNorthPole","tile","innerShell","arrowWidth","appbarWidth","sr","pole","Point","projPole","poleScreenPos","bcScreenPos","poleStyleParams","PointStyleType","flag","poleLayer","POLE_MARKER_LAYER_ID","LayerType","poleGraphic","Graphic","poleStyle","PointStyle","NortharrowFixture","unwatch","value","destroy","NortharrowV"],"mappings":"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"}