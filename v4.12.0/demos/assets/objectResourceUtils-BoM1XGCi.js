const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./loader-BhbO46s4.js","./main-D6UWMbWJ.js","./preload-helper-ExcqyqRp.js","./main-DCJluy1C.css","./mat4f64-Dk4dwAN8.js","./enums-Dk3osxpS.js","./Version-DeyywoNs.js","./mat4-mplESjCB.js","./common-DQOJ18NT.js","./quat-DOvbuK1U.js","./mat3f64-q3fE-ZOt.js","./quatf64-aQ5IuZRd.js","./vec32-DvB22h0L.js","./vec42-CKs01hkn.js","./BufferView-xZDqj2K3.js","./vec2-maR1OrZI.js","./devEnvironmentUtils-8WtPGj6h.js","./mat3-CruJiiUv.js","./vec2f64-DohEyf3f.js","./VerticalOffset.glsl-D5YuYROR.js","./Indices-BMQOyMkI.js","./InterleavedLayout-C4yDe4a4.js","./vec4f64-o2zAXfmz.js","./triangle-C_fuLIxe.js","./sphere-MYAntte_.js","./plane-DXyNbfXV.js","./lineSegment-o0iVtp8N.js","./renderState-fiZ8Gckm.js","./VertexAttribute-Cq4MnHjR.js","./ShaderOutput-DnYY5J1_.js","./BindType-BBwFZqyN.js","./glsl-BH37Aalp.js","./lengthUtils-B1iOgQDj.js","./boundedPlane-DFud_aWw.js","./ViewingMode-HRfKv6NR.js","./requestImageUtils-BM7ey9Ox.js","./TextureFormat-1mYWTFa-.js","./Texture-pu6CNJho.js","./signal-_szBxGG7.js","./getDataTypeBytes-DflDeYgv.js","./orientedBoundingBox-CVUzj9sI.js","./spatialReferenceEllipsoidUtils-DMIJhMZm.js","./computeTranslationToOriginAndRotation-GlDVXUFs.js","./projection-F5U3p10J.js","./vec3-DNqtSGvy.js","./vec4-DOaDdq9f.js","./vec2f32-BbH2jxlN.js","./memoryEstimations-bvdrNroi.js","./NestedMap-CImDozOA.js","./DefaultMaterial-Bw-awx1D.js","./NormalAttribute.glsl-eKv2y2ed.js","./doublePrecisionUtils-B0owpBza.js","./ShaderBuilder-B-d5zQ91.js"])))=>i.map(i=>d[i]);
import{_ as ve}from"./preload-helper-ExcqyqRp.js";import{fo as Re,U as Ae,i4 as $e,b9 as ie,_ as H,be as K,s as ue,aY as X,eY as le,i5 as F,n as Be,Y as Me,i6 as Ee,i7 as Ie,i8 as Se,bE as Oe,f1 as Pe,el as Q,b7 as ce,ab as D}from"./main-D6UWMbWJ.js";import{a as _e}from"./devEnvironmentUtils-8WtPGj6h.js";import{i as Z,j as Le,n as Ue}from"./mat3-CruJiiUv.js";import{t as G,e as fe}from"./mat3f64-q3fE-ZOt.js";import{h as je}from"./mat4-mplESjCB.js";import{e as Ce}from"./mat4f64-Dk4dwAN8.js";import{s as Ne}from"./vec2f64-DohEyf3f.js";import{E as ee,c as ke,i as te,r as Fe,A as qe,I as De}from"./vec32-DvB22h0L.js";import{N as me,f as de,n as k}from"./VerticalOffset.glsl-D5YuYROR.js";import{c as pe,x as Ge,L as Ve,i as he,O as ze,E as Ye}from"./BufferView-xZDqj2K3.js";import{r as He,n as Ke,d as re,l as ne}from"./vec3-DNqtSGvy.js";import{o as We,d as se}from"./vec4-DOaDdq9f.js";import{o as ye,i as Je}from"./Indices-BMQOyMkI.js";import{D as oe,E as V}from"./enums-Dk3osxpS.js";import{e as Y,i as A,u as ge,n as Xe}from"./renderState-fiZ8Gckm.js";import{i as Qe,f as Ze}from"./vec2f32-BbH2jxlN.js";import{u as et}from"./memoryEstimations-bvdrNroi.js";import{t as tt}from"./NestedMap-CImDozOA.js";import{r as xe}from"./Version-DeyywoNs.js";import{t as rt}from"./requestImageUtils-BM7ey9Ox.js";import{t as L}from"./orientedBoundingBox-CVUzj9sI.js";import{e as O}from"./VertexAttribute-Cq4MnHjR.js";import{z as q,s as nt,t as st,n as ot,o as at}from"./DefaultMaterial-Bw-awx1D.js";import{a as ae}from"./NormalAttribute.glsl-eKv2y2ed.js";let it=class{constructor(t){this._streamDataRequester=t}async loadJSON(t,s){return this._load("json",t,s)}async loadBinary(t,s){return Re(t)?(Ae(s),$e(t)):this._load("binary",t,s)}async loadImage(t,s){return this._load("image",t,s)}async _load(t,s,r){if(this._streamDataRequester==null)return(await ie(s,{responseType:ut[t]})).data;const a=await H(this._streamDataRequester.request(s,t,r));if(a.ok===!0)return a.value;throw K(a.error),new ue("glt-loader-request-error",`Request for resource failed: ${a.error}`)}};const ut={image:"image",binary:"array-buffer",json:"json","image+type":void 0},B=()=>Be.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class lt{constructor(t,s,r){this.resource=t,this.textures=s,this.cachedMemory=r}}async function ct(e,t){const s=await ft(e,t),r=await yt(s.textureDefinitions??{},t);let a=0;for(const o in r)if(r.hasOwnProperty(o)){const i=r[o];a+=i?.image?i.image.width*i.image.height*4:0}return new lt(s,r,a+et(s))}async function ft(e,t){const s=t?.streamDataRequester;if(s)return mt(e,s,t);const r=await H(ie(e,t));if(r.ok===!0)return r.value.data;K(r.error),be(r.error)}async function mt(e,t,s){const r=await H(t.request(e,"json",s));if(r.ok===!0)return r.value;K(r.error),be(r.error.details.url)}function be(e){throw new ue("",`Request for object resource failed: ${e}`)}function dt(e){const t=e.params,s=t.topology;let r=!0;switch(t.vertexAttributes||(B().warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const o=t.faces;if(o){if(t.vertexAttributes)for(const i in t.vertexAttributes){const u=o[i];u?.values?(u.valueType!=null&&u.valueType!=="UInt32"&&(B().warn(`Unsupported indexed geometry indices type '${u.valueType}', only UInt32 is currently supported`),r=!1),u.valuesPerElement!=null&&u.valuesPerElement!==1&&(B().warn(`Unsupported indexed geometry values per element '${u.valuesPerElement}', only 1 is currently supported`),r=!1)):(B().warn(`Indexed geometry does not specify face indices for '${i}' attribute`),r=!1)}}else B().warn("Indexed geometries must specify faces"),r=!1;break}default:B().warn(`Unsupported topology '${s}'`),r=!1}e.params.material||(B().warn("Geometry requires material"),r=!1);const a=e.params.vertexAttributes;for(const o in a)a[o].values||(B().warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function pt(e,t){const s=new Array,r=new Array,a=new Array,o=new tt,i=e.resource,u=xe.parse(i.version||"1.0","wosr");xt.validate(u);const n=i.model.name,l=i.model.geometries,c=i.materialDefinitions??{},f=e.textures;let h=0;const y=new Map;for(let d=0;d<l.length;d++){const g=l[d];if(!dt(g))continue;const b=gt(g),T=g.params.vertexAttributes,p=[],x=m=>{if(g.params.topology==="PerAttributeArray")return null;const v=g.params.faces;for(const w in v)if(w===m)return v[w].values;return null},U=T[O.POSITION],C=U.values.length/U.valuesPerElement;for(const m in T){const v=T[m],w=v.values,R=x(m)??ye(C);p.push([m,new L(w,R,v.valuesPerElement,!0)])}const M=b.texture,$=f&&f[M];if($&&!y.has(M)){const{image:m,parameters:v}=$,w=new me(m,v);r.push(w),y.set(M,w)}const N=y.get(M),P=N?N.id:void 0,I=b.material;let E=o.get(I,M);if(E==null){const m=c[I.slice(I.lastIndexOf("/")+1)].params;m.transparency===1&&(m.transparency=0);const v=$&&$.alphaChannelUsage,w=m.transparency>0||v==="transparency"||v==="maskAndTransparency",R=$?we($.alphaChannelUsage):void 0,J={ambient:X(m.diffuse),diffuse:X(m.diffuse),opacity:1-(m.transparency||0),transparent:w,textureAlphaMode:R,textureAlphaCutoff:.33,textureId:P,doubleSided:!0,cullFace:Y.None,colorMixMode:m.externalColorMixMode||"tint",textureAlphaPremultiplied:$?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(J,t.materialParameters),E=new q(J,t),o.set(I,M,E)}a.push(E);const S=new de(E,p);h+=p.find(m=>m[0]===O.POSITION)?.[1]?.indices.length??0,s.push(S)}return{engineResources:[{name:n,stageResources:{textures:r,materials:a,geometries:s},pivotOffset:i.model.pivotOffset,numberOfVertices:h,lodThreshold:null}],referenceBoundingBox:ht(s)}}function ht(e){const t=le();return e.forEach(s=>{const r=s.boundingInfo;r!=null&&(F(t,r.bbMin),F(t,r.bbMax))}),t}async function yt(e,t){const s=new Array;for(const o in e){const i=e[o],u=i.images[0].data;if(!u){B().warn("Externally referenced texture data is not yet supported");continue}const n=i.encoding+";base64,"+u,l="/textureDefinitions/"+o,c=i.channels==="rgba"?i.alphaChannelUsage||"transparency":"none",f={noUnpackFlip:!0,wrap:{s:oe.REPEAT,t:oe.REPEAT},preMultiplyAlpha:we(c)!==A.Opaque},h=t?.disableTextures?Promise.resolve(null):rt(n,t);s.push(h.then(y=>({refId:l,image:y,parameters:f,alphaChannelUsage:c})))}const r=await Promise.all(s),a={};for(const o of r)a[o.refId]=o;return a}function we(e){switch(e){case"mask":return A.Mask;case"maskAndTransparency":return A.MaskBlend;case"none":return A.Opaque;default:return A.Blend}}function gt(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const xt=new xe(1,2,"wosr");function bt(e,t){W(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function W(e,t,s=2,r=s){const a=t.length/2;let o=0,i=0;if(!Me(t)||Ee(t)){for(let n=0;n<a;++n)e[o]=t[i],e[o+1]=t[i+1],o+=s,i+=r;return}const u=Ie(t);if(Se(t))for(let n=0;n<a;++n)e[o]=Math.max(t[i]/u,-1),e[o+1]=Math.max(t[i+1]/u,-1),o+=s,i+=r;else for(let n=0;n<a;++n)e[o]=t[i]/u,e[o+1]=t[i+1]/u,o+=s,i+=r}function wt(e,t,s,r){const a=e.typedBuffer,o=e.typedBufferStride,i=r?.count??e.count;let u=(r?.dstIndex??0)*o;for(let n=0;n<i;++n)a[u]=t,a[u+1]=s,u+=o}Object.freeze(Object.defineProperty({__proto__:null,fill:wt,normalizeIntegerBuffer:W,normalizeIntegerBufferView:bt},Symbol.toStringTag,{value:"Module"}));let Tt=class{constructor(t){this.data=t,this.type="encoded-mesh-texture",this.encoding=ge.KTX2_ENCODING}};function z(e){return e?.type==="encoded-mesh-texture"}async function ir(e){const t=new Blob([e]),s=await t.text();return JSON.parse(s)}async function ur(e,t){if(t===ge.KTX2_ENCODING)return new Tt(e);const s=new Blob([e],{type:t});let r=URL.createObjectURL(s);switch(t){case"image/jpeg":r+="#.jpg";break;case"image/png":r+="#.png"}const a=new Image;if(Oe("esri-iPhone"))return new Promise((o,i)=>{const u=()=>{l(),o(a)},n=c=>{l(),i(c)},l=()=>{URL.revokeObjectURL(r),a.removeEventListener("load",u),a.removeEventListener("error",n)};a.addEventListener("load",u),a.addEventListener("error",n),a.src=r});try{a.src=r,await a.decode()}catch{console.warn("Failed decoding HTMLImageElement")}return URL.revokeObjectURL(r),a}function vt(e,t){switch(t){case V.TRIANGLES:return Rt(e);case V.TRIANGLE_STRIP:return At(e);case V.TRIANGLE_FAN:return $t(e)}}function Rt(e){return typeof e=="number"?ye(e):Pe(e)?new Uint16Array(e):e}function At(e){const t=typeof e=="number"?e:e.length;if(t<3)return[];const s=t-2,r=Je(3*s);if(typeof e=="number"){let a=0;for(let o=0;o<s;o+=1)o%2==0?(r[a++]=o,r[a++]=o+1,r[a++]=o+2):(r[a++]=o+1,r[a++]=o,r[a++]=o+2)}else{let a=0;for(let o=0;o<s;o+=1)o%2==0?(r[a++]=e[o],r[a++]=e[o+1],r[a++]=e[o+2]):(r[a++]=e[o+1],r[a++]=e[o],r[a++]=e[o+2])}return r}function $t(e){const t=typeof e=="number"?e:e.length;if(t<3)return new Uint16Array(0);const s=t-2,r=s<=65536?new Uint16Array(3*s):new Uint32Array(3*s);if(typeof e=="number"){let u=0;for(let n=0;n<s;++n)r[u++]=0,r[u++]=n+1,r[u++]=n+2;return r}const a=e[0];let o=e[1],i=0;for(let u=0;u<s;++u){const n=e[u+2];r[i++]=a,r[i++]=o,r[i++]=n,o=n}return r}function j(e){if(e==null)return null;const t=e.offset!=null?e.offset:Qe,s=e.rotation!=null?e.rotation:0,r=e.scale!=null?e.scale:Ze,a=G(1,0,0,0,1,0,t[0],t[1],1),o=G(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),i=G(r[0],0,0,0,r[1],0,0,0,1),u=fe();return Z(u,o,i),Z(u,a,u),u}class Bt{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class Mt{constructor(t,s,r){this.name=t,this.lodThreshold=s,this.pivotOffset=r,this.stageResources=new Bt,this.numberOfVertices=0}}async function Et(e,t){const s=Te(_e(e));if(s.fileType==="wosr"){const f=await(t.cache?t.cache.loadWOSR(s.url,t):ct(s.url,t)),{engineResources:h,referenceBoundingBox:y}=pt(f,t);return{lods:h,referenceBoundingBox:y,isEsriSymbolResource:!1,isWosr:!0}}let r;if(t.cache)r=await t.cache.loadGLTF(s.url,t,!!t.usePBR);else{const{loadGLTF:f}=await ve(()=>import("./loader-BhbO46s4.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52]),import.meta.url);r=await f(new it(t.streamDataRequester),s.url,t,t.usePBR)}const a=r.model.meta?.ESRI_proxyEllipsoid,o=r.meta.isEsriSymbolResource&&a!=null&&r.meta.ESRI_webstyle==="EsriRealisticTreesStyle";o&&!r.customMeta.esriTreeRendering&&(r.customMeta.esriTreeRendering=!0,_t(r,a));const i=!!t.usePBR,u=r.meta.isEsriSymbolResource?{usePBR:i,isSchematic:!1,treeRendering:o,mrrFactors:nt}:{usePBR:i,isSchematic:!1,treeRendering:!1,mrrFactors:st},n={...t.materialParameters,treeRendering:o},{engineResources:l,referenceBoundingBox:c}=It(r,u,n,t,s.specifiedLodIndex);return{lods:l,referenceBoundingBox:c,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1}}function Te(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function It(e,t,s,r,a){const o=e.model,i=new Array,u=new Map,n=new Map,l=o.lods.length,c=le();return o.lods.forEach((f,h)=>{const y=r.skipHighLods===!0&&(l>1&&h===0||l>3&&h===1)||r.skipHighLods===!1&&a!=null&&h!==a;if(y&&h!==0)return;const d=new Mt(f.name,f.lodThreshold,[0,0,0]);f.parts.forEach(g=>{const b=y?new q({},r):St(o,g,d,t,s,u,n,r),{geometry:T,vertexCount:p}=Ot(g,b??new q({},r)),x=T.boundingInfo;x!=null&&h===0&&(F(c,x.bbMin),F(c,x.bbMax)),b!=null&&(d.stageResources.geometries.push(T),d.numberOfVertices+=p)}),y||i.push(d)}),{engineResources:i,referenceBoundingBox:c}}function St(e,t,s,r,a,o,i,u){const n=e.materials.get(t.material);if(n==null)return null;const{normal:l,color:c,texCoord0:f,tangent:h}=t.attributes,y=t.material+(l?"_normal":"")+(c?"_color":"")+(f?"_texCoord0":"")+(h?"_tangent":""),d=t.attributes.texCoord0!=null,g=t.attributes.normal!=null,b=Pt(n.alphaMode);if(!o.has(y)){if(d){const S=(m,v=!1)=>{if(m!=null&&!i.has(m)){const w=e.textures.get(m);if(w){const R=w.data;i.set(m,new me(z(R)?R.data:R,{...w.parameters,preMultiplyAlpha:!z(R)&&v,encoding:z(R)?R.encoding:void 0}))}}};S(n.colorTexture,b!==A.Opaque),S(n.normalTexture),S(n.occlusionTexture),S(n.emissiveTexture),S(n.metallicRoughnessTexture)}const p=1/ce,x=n.color[0]**p,U=n.color[1]**p,C=n.color[2]**p,M=n.emissiveFactor[0]**p,$=n.emissiveFactor[1]**p,N=n.emissiveFactor[2]**p,P=n.colorTexture!=null&&d?i.get(n.colorTexture):null,I=ot(n),E=n.normalTextureTransform?.scale!=null?n.normalTextureTransform?.scale:Ne;o.set(y,new q({...r,transparent:b===A.Blend,customDepthTest:Xe.Lequal,textureAlphaMode:b,textureAlphaCutoff:n.alphaCutoff,diffuse:[x,U,C],ambient:[x,U,C],opacity:n.opacity,doubleSided:n.doubleSided,doubleSidedType:"winding-order",cullFace:n.doubleSided?Y.None:Y.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:g?ae.Attribute:ae.ScreenDerivative,castShadows:!0,receiveShadows:n.receiveShadows,receiveAmbientOcclusion:n.receiveAmbientOcclustion,textureId:P?.id,colorMixMode:n.colorMixMode,normalTextureId:n.normalTexture!=null&&d?i.get(n.normalTexture).id:void 0,textureAlphaPremultiplied:P!=null&&!!P.parameters.preMultiplyAlpha,occlusionTextureId:n.occlusionTexture!=null&&d?i.get(n.occlusionTexture).id:void 0,emissiveTextureId:n.emissiveTexture!=null&&d?i.get(n.emissiveTexture).id:void 0,metallicRoughnessTextureId:n.metallicRoughnessTexture!=null&&d?i.get(n.metallicRoughnessTexture).id:void 0,emissiveFactor:[M,$,N],mrrFactors:I?at:[n.metallicFactor,n.roughnessFactor,r.mrrFactors[2]],isSchematic:I,colorTextureTransformMatrix:j(n.colorTextureTransform),normalTextureTransformMatrix:j(n.normalTextureTransform),scale:[E[0],E[1]],occlusionTextureTransformMatrix:j(n.occlusionTextureTransform),emissiveTextureTransformMatrix:j(n.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:j(n.metallicRoughnessTextureTransform),...a},u))}const T=o.get(y);if(s.stageResources.materials.push(T),d){const p=x=>{x!=null&&s.stageResources.textures.push(i.get(x))};p(n.colorTexture),p(n.normalTexture),p(n.occlusionTexture),p(n.emissiveTexture),p(n.metallicRoughnessTexture)}return T}function Ot(e,t){const s=e.attributes.position.count,r=vt(e.indices||s,e.primitiveType),a=k(3*s),{typedBuffer:o,typedBufferStride:i}=e.attributes.position;He(a,o,e.transform,3,i);const u=[[O.POSITION,new L(a,r,3,!0)]];if(e.attributes.normal!=null){const l=k(3*s),{typedBuffer:c,typedBufferStride:f}=e.attributes.normal;Le(_,e.transform),Ke(l,c,_,3,f),Q(_)&&re(l,l),u.push([O.NORMAL,new L(l,r,3,!0)])}if(e.attributes.tangent!=null){const l=k(4*s),{typedBuffer:c,typedBufferStride:f}=e.attributes.tangent;Ue(_,e.transform),We(l,c,_,4,f),Q(_)&&re(l,l,4),u.push([O.TANGENT,new L(l,r,4,!0)])}if(e.attributes.texCoord0!=null){const l=k(2*s),{typedBuffer:c,typedBufferStride:f}=e.attributes.texCoord0;W(l,c,2,f),u.push([O.UV0,new L(l,r,2,!0)])}const n=e.attributes.color;if(n!=null){const l=new Uint8Array(4*s);n.elementCount===4?n instanceof pe?se(l,n,1,255):(n instanceof Ge||n instanceof Ve)&&se(l,n,1/255,255):(l.fill(255),n instanceof he?ne(l,n.typedBuffer,1,255,4,n.typedBufferStride):(e.attributes.color instanceof ze||e.attributes.color instanceof Ye)&&ne(l,n.typedBuffer,1/255,255,4,e.attributes.color.typedBufferStride)),u.push([O.COLOR,new L(l,r,4,!0)])}return{geometry:new de(t,u),vertexCount:s}}const _=fe();function Pt(e){switch(e){case"BLEND":return A.Blend;case"MASK":return A.Mask;case"OPAQUE":case null:case void 0:return A.Opaque}}function _t(e,t){for(let s=0;s<e.model.lods.length;++s){const r=e.model.lods[s];for(const a of r.parts){const o=a.attributes.normal;if(o==null)return;const i=a.attributes.position,u=i.count,n=D(),l=D(),c=D(),f=new Float32Array(4*u),h=new Float32Array(3*u),y=je(Ce(),a.transform);let d=0,g=0;for(let b=0;b<u;b++){i.getVec(b,l),o.getVec(b,n),ee(l,l,a.transform),ke(c,l,t.center),te(c,c,t.radius);const T=c[2],p=Fe(c),x=Math.min(.45+.55*p*p,1)**ce;te(c,c,t.radius),y!==null&&ee(c,c,y),qe(c,c),s+1!==e.model.lods.length&&e.model.lods.length>1&&De(c,c,n,T>-1?.2:Math.min(-4*T-3.8,1)),h[d]=c[0],h[d+1]=c[1],h[d+2]=c[2],d+=3,f[g]=x,f[g+1]=x,f[g+2]=x,f[g+3]=1,g+=4}a.attributes.normal=new he(h),a.attributes.color=new pe(f)}}}const lr=Object.freeze(Object.defineProperty({__proto__:null,fetch:Et,parseUrl:Te},Symbol.toStringTag,{value:"Module"}));export{Et as Y,it as a,vt as b,bt as c,lr as d,wt as l,z as n,ur as o,ir as r,j as s,Tt as t};
