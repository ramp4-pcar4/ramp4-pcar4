import{X as d}from"./main-D6UWMbWJ.js";const z=-3,l=z-1;var o;(function(_){_[_.ALL=0]="ALL",_[_.SOME=1]="SOME"})(o||(o={}));class S{get size(){return this._size}constructor(s=10485760){this._maxSize=s,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new d,this._users=new d}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear()}register(s){this._users.push(s)}deregister(s){this._users.removeUnordered(s)}registerRemoveFunc(s,i){this._removeFuncs.push([s,i])}deregisterRemoveFunc(s){this._removeFuncs.filterInPlace(i=>i[0]!==s)}get maxSize(){return this._maxSize}set maxSize(s){this._maxSize=Math.max(s,-1),this._checkSize()}getSize(s,i){return this._db.get(s.id+i)?.size??0}put(s,i,e,h,r){i=s.id+i;const t=this._db.get(i);if(t&&(this._size-=t.size,s.size-=t.size,this._db.delete(i),t.entry!==e&&this._notifyRemove(i,t.entry,t.size,o.ALL)),h>this._maxSize)return void this._notifyRemove(i,e,h,o.ALL);if(e===void 0)return void console.warn("Refusing to cache undefined entry ");if(!h||h<0)return console.warn(`Refusing to cache entry with size ${h} for key ${i}`),void this._notifyRemove(i,e,0,o.ALL);const n=1+Math.max(r,l)-z;this._db.set(i,new b(e,h,n)),this._size+=h,s.size+=h,this._checkSize()}updateSize(s,i,e,h){i=s.id+i;const r=this._db.get(i);if(r&&r.entry===e){for(this._size-=r.size,s.size-=r.size;h>this._maxSize;){const t=this._notifyRemove(i,e,h,o.SOME);if(!(t!=null&&t>0))return void this._db.delete(i);h=t}r.size=h,this._size+=h,s.size+=h,this._checkSize()}}pop(s,i){i=s.id+i;const e=this._db.get(i);if(e)return this._size-=e.size,s.size-=e.size,this._db.delete(i),++this._hit,e.entry;++this._miss}get(s,i){i=s.id+i;const e=this._db.get(i);if(e!==void 0)return this._db.delete(i),e.lives=e.lifetime,this._db.set(i,e),++this._hit,e.entry;++this._miss}peek(s,i){const e=this._db.get(s.id+i);return e?++this._hit:++this._miss,e?.entry}get performanceInfo(){const s={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},i={},e=new Array;this._db.forEach((t,n)=>{const c=t.lifetime;e[c]=(e[c]||0)+t.size,this._users.forAll(u=>{const{id:f,name:a}=u;if(n.startsWith(f)){const m=i[a]||0;i[a]=m+t.size}})});const h={};this._users.forAll(t=>{const n=t.name;if("hitRate"in t&&typeof t.hitRate=="number"&&!isNaN(t.hitRate)&&t.hitRate>0){const c=i[n]||0;i[n]=c,h[n]=Math.round(100*t.hitRate)+"%"}else h[n]="0%"});const r=Object.keys(i);r.sort((t,n)=>i[n]-i[t]),r.forEach(t=>s[t]=Math.round(i[t]/2**20)+"MB / "+h[t]);for(let t=e.length-1;t>=0;--t){const n=e[t];n&&(s["Priority "+(t+z-1)]=Math.round(n/this._size*100)+"%")}return s}resetStats(){this._hit=this._miss=0,this._users.forAll(s=>s.resetHitRate())}clear(s){const i=s.id;this._db.forEach((e,h)=>{h.startsWith(i)&&(this._size-=e.size,this._db.delete(h),this._notifyRemove(h,e.entry,e.size,o.ALL))}),s.size=0}clearAll(){this._db.forEach((s,i)=>this._notifyRemove(i,s.entry,s.size,o.ALL)),this._users.forAll(s=>s.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(s,i,e,h){let r;return this._removeFuncs.some(t=>{if(s.startsWith(t[0])){const n=t[1](i,h,e);return typeof n=="number"&&(r=n),!0}return!1}),r}_checkSize(){this._users.forAll(s=>this._checkSizeLimits(s)),this._checkSizeLimits()}_checkSizeLimits(s){const i=s??this;if(i.maxSize<0||i.size<=i.maxSize)return;const e=s?.id;let h=!0;for(;h;){h=!1;for(const[r,t]of this._db)if(t.lifetime===0&&(!e||r.startsWith(e))){if(this._purgeItem(r,t,s),i.size<=.9*i.maxSize)return;h||=this._db.has(r)}}for(const[r,t]of this._db)if((!e||r.startsWith(e))&&(this._purgeItem(r,t,s),i.size<=.9*i.maxSize))return}_purgeItem(s,i,e=this._users.find(h=>s.startsWith(h.id))){if(this._db.delete(s),i.lives<=1){this._size-=i.size,e&&(e.size-=i.size);const h=this._notifyRemove(s,i.entry,i.size,o.SOME);h!=null&&h>0&&(this._size+=h,e&&(e.size+=h),i.lives=i.lifetime,i.size=h,this._db.set(s,i))}else--i.lives,this._db.set(s,i)}}class b{constructor(s,i,e){this.entry=s,this.size=i,this.lifetime=e,this.lives=e}}export{z as e,S as h};
