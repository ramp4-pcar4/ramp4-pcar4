import{bN as re,bS as oe,l as Q,a as ae,w as ce,L as ue,u as G,A as fe,S as de,v as C,x as k,J as me,a5 as pe,d8 as ge,aL as _e,iZ as we,cc as Z,gO as ve,fc as ye,i_ as xe}from"./main-D6UWMbWJ.js";import{m as Ie,b as H}from"./vec2-maR1OrZI.js";import{s as Se}from"./Queue-Bp8J9hIN.js";import{s as E}from"./ReactiveMap-DNJTwYV-.js";import{r as Me}from"./signal-_szBxGG7.js";import{t as Be}from"./quickselect-QQC62dOK.js";import{a as Te}from"./Query-VeA4-Qk_.js";let z=class b{static getId(e,t,s,i){return typeof e=="object"?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${t}/${s}/${i}`}constructor(e,t,s,i){this.set(e,t,s,i)}get key(){return this}get id(){return this.toString()}get normalizedId(){return`${this.level}/${this.row}/${this.col}`}set id(e){this.set(e)}get hash(){const e=4095&this.row,t=4095&this.col,s=63&this.level;return(3&this.world)<<30|t<<22|e<<8|s}acquire(e,t,s,i){this.set(e,t,s,i)}contains(e){const t=e.level-this.level;return t>=0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}containsChild(e){const t=e.level-this.level;return t>0&&this.row===e.row>>t&&this.col===e.col>>t&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new b(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,t,s,i){if(e==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof e=="object")this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if(typeof e=="string"){const[o,l,n,h]=e.split("/");this.level=parseFloat(o),this.row=parseFloat(l),this.col=parseFloat(n),this.world=parseFloat(h)}else this.level=+e,this.row=+t,this.col=+s,this.world=+i||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new b(this.level-1,this.row>>1,this.col>>1,this.world)}getNormalizedNeighbor(e,t,s){const i=this.clone();return i.col+=e,i.row+=t,s.normalizeKey(i),i}getChildKeys(){const e=this.level+1,t=this.row<<1,s=this.col<<1,i=this.world;return[new b(e,t,s,i),new b(e,t,s+1,i),new b(e,t+1,s,i),new b(e,t+1,s+1,i)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}};z.pool=new re(z,null,null,25,50);function Y(r,e){return[r,e]}function $(r,e,t){return r[0]=e,r[1]=t,r}function Ce(r,e,t,s,i){return r[0]=e,r[1]=t,r[2]=s,r[3]=i,r}const x=new z("0/0/0/0");let $e=class le{static create(e,t,s=null){const i=oe(e.spatialReference),o=t.origin||Y(e.origin.x,e.origin.y),l=Y(e.size[0]*t.resolution,e.size[1]*t.resolution),n=Y(-1/0,-1/0),h=Y(1/0,1/0),a=Y(1/0,1/0);s!=null&&($(n,Math.max(0,Math.floor((s.xmin-o[0])/l[0])),Math.max(0,Math.floor((o[1]-s.ymax)/l[1]))),$(h,Math.max(0,Math.floor((s.xmax-o[0])/l[0])),Math.max(0,Math.floor((o[1]-s.ymin)/l[1]))),$(a,h[0]-n[0]+1,h[1]-n[1]+1));const{cols:c,rows:f}=t;let d,_,v,g;return!s&&c&&f&&($(n,c[0],f[0]),$(h,c[1],f[1]),$(a,c[1]-c[0]+1,f[1]-f[0]+1)),e.isWrappable?(d=Y(Math.ceil(Math.round((i.valid[1]-i.valid[0])/t.resolution)/e.size[0]),a[1]),_=!0,v=i.origin,g=i.valid):(d=a,_=!1),new le(t.level,t.resolution,t.scale,o,n,h,a,l,d,_,v,g)}constructor(e,t,s,i,o,l,n,h,a,c,f,d){this.level=e,this.resolution=t,this.scale=s,this.origin=i,this.first=o,this.last=l,this.size=n,this.norm=h,this.worldSize=a,this.wrap=c,this._spatialReferenceOrigin=f,this._spatialReferenceValid=d}normalizeCol(e){if(!this.wrap)return e;const t=this.worldSize[0];return e<0?t-1-Math.abs((e+1)%t):e%t}normalizeKey(e){if(!this.wrap)return;const t=this.worldSize[0],s=e.col;s<0?(e.col=s+t,e.world-=1):s>=t&&(e.col=s-t,e.world+=1)}denormalizeCol(e,t){return this.wrap?this.worldSize[0]*t+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const t=this.origin[0]+e*this.norm[0],s=this._spatialReferenceOrigin,i=this._spatialReferenceValid;return this.wrap&&s&&i?t===s[0]?i[0]:this.origin[0]===s[0]&&e===this.worldSize[0]?i[1]:t:t}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,t,s=!1){x.set(t);const i=s?x.col:this.denormalizeCol(x.col,x.world),o=x.row;return Ce(e,this.getXForColumn(i),this.getYForRow(o+1),this.getXForColumn(i+1),this.getYForRow(o)),e}getTileCoords(e,t,s=!1){x.set(t);const i=s?x.col:this.denormalizeCol(x.col,x.world);return Array.isArray(e)?$(e,this.getXForColumn(i),this.getYForRow(x.row)):(e.x=this.getXForColumn(i),e.y=this.getYForRow(x.row)),e}},V=class{constructor(){this.spans=[]}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}*keys(){const e=this.lodInfo;for(const{row:t,colFrom:s,colTo:i}of this.spans)for(let o=s;o<=i;o++){const l=e.getWorldForColumn(o);yield new z(e.level,t,e.normalizeCol(o),l)}}forEach(e,t){const{spans:s,lodInfo:i}=this,{level:o}=i;if(s.length!==0)for(const{row:l,colFrom:n,colTo:h}of s)for(let a=n;a<=h;a++)e.call(t,o,l,i.normalizeCol(a),i.getWorldForColumn(a))}};V.pool=new re(V);let j=class{constructor(e,t,s){this.row=e,this.colFrom=t,this.colTo=s}};const p=new z("0/0/0/0");let Fe=class ne{static create(e,t){e[1]>t[1]&&([e,t]=[t,e]);const[s,i]=e,[o,l]=t,n=o-s,h=l-i,a=h!==0?n/h:0,c=(Math.ceil(i)-i)*a,f=(Math.floor(i)-i)*a;return new ne(s,Math.floor(i),Math.ceil(l),a,n<0?c:f,n<0?f:c,n<0?o:s,n<0?s:o)}constructor(e,t,s,i,o,l,n,h){this.x=e,this.ymin=t,this.ymax=s,this.invM=i,this.leftAdjust=o,this.rightAdjust=l,this.leftBound=n,this.rightBound=h}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}};const y=[[0,0],[0,0],[0,0],[0,0]],be=1e-6;let De=class{constructor(e,t=null,s=e.lods[0].level,i=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=t,this.scales=[],this._infoByScale={},this._infoByLevel={};const o=e.lods.filter(n=>n.level>=s&&n.level<=i);this.minScale=o[0].scale,this.maxScale=o[o.length-1].scale;const l=this._lodInfos=o.map(n=>$e.create(e,n,t));o.forEach((n,h)=>{this._infoByLevel[n.level]=l[h],this._infoByScale[n.scale]=l[h],this.scales[h]=n.scale},this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel[typeof e=="number"?e:e.level]}getTileBounds(e,t,s=!1){p.set(t);const i=this._infoByLevel[p.level];return i?i.getTileBounds(e,p,s):e}getTileCoords(e,t,s=!1){p.set(t);const i=this._infoByLevel[p.level];return i?i.getTileCoords(e,p,s):e}getTileCoverage(e,t=192,s=!0,i="closest"){if(!s&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const o=i==="closest"?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),l=V.pool.acquire(o),n=this._wrap;let h,a,c,f=1/0,d=-1/0;const _=l.spans;y[0][0]=y[0][1]=y[1][1]=y[3][0]=-t,y[1][0]=y[2][0]=e.size[0]+t,y[2][1]=y[3][1]=e.size[1]+t;for(const u of y)e.toMap(u,u),u[0]=o.getColumnForX(u[0]),u[1]=o.getRowForY(u[1]);const v=[];let g=3;for(let u=0;u<4;u++){if(y[u][1]===y[g][1]){g=u;continue}const m=Fe.create(y[u],y[g]);f=Math.min(m.ymin,f),d=Math.max(m.ymax,d),v[m.ymin]===void 0&&(v[m.ymin]=[]),v[m.ymin].push(m),g=u}if(f==null||d==null||d-f>100)return null;let w=[];for(h=f;h<d;){v[h]!=null&&(w=w.concat(v[h])),a=1/0,c=-1/0;for(let u=w.length-1;u>=0;u--){const m=w[u];a=Math.min(a,m.getLeftCol()),c=Math.max(c,m.getRightCol())}if(a=Math.floor(a),c=Math.floor(c),h>=o.first[1]&&h<=o.last[1])if(n)if(o.size[0]<o.worldSize[0]){const u=Math.floor(c/o.worldSize[0]);for(let m=Math.floor(a/o.worldSize[0]);m<=u;m++)_.push(new j(h,Math.max(o.getFirstColumnForWorld(m),a),Math.min(o.getLastColumnForWorld(m),c)))}else _.push(new j(h,a,c));else a>o.last[0]||c<o.first[0]||(a=Math.max(a,o.first[0]),c=Math.min(c,o.last[0]),_.push(new j(h,a,c)));h+=1;for(let u=w.length-1;u>=0;u--){const m=w[u];m.ymax>=h?m.incrRow():w.splice(u,1)}}return l}getTileParentId(e){p.set(e);const t=this._infoByLevel[p.level],s=this._lodInfos.indexOf(t)-1;return s<0?null:(this._getTileIdAtLOD(p,this._lodInfos[s],p),p.id)}getTileResolution(e){const t=this._infoByLevel[typeof e=="object"?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){p.set(t);const s=this._infoByLevel[p.level],i=e.lodInfo;if(i.resolution>s.resolution){this._getTileIdAtLOD(p,i,p);const l=i.denormalizeCol(p.col,p.world);for(const n of e.spans)if(n.row===p.row&&n.colFrom<=l&&n.colTo>=l)return!0}if(i.resolution<s.resolution){const[l,n,h,a]=e.spans.reduce((g,w)=>(g[0]=Math.min(g[0],w.row),g[1]=Math.max(g[1],w.row),g[2]=Math.min(g[2],w.colFrom),g[3]=Math.max(g[3],w.colTo),g),[1/0,-1/0,1/0,-1/0]),c=s.denormalizeCol(p.col,p.world),f=i.getColumnForX(s.getXForColumn(c)),d=i.getRowForY(s.getYForRow(p.row)),_=i.getColumnForX(s.getXForColumn(c+1))-1,v=i.getRowForY(s.getYForRow(p.row+1))-1;return!(f>a||_<h||d>n||v<l)}const o=i.denormalizeCol(p.col,p.world);return e.spans.some(l=>l.row===p.row&&l.colFrom<=o&&l.colTo>=o)}normalizeBounds(e,t,s){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){const i=oe(this.tileInfo.spatialReference),o=-s*(i.valid[1]-i.valid[0]);e[0]+=o,e[2]+=o}return e}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let s=1;s<t.length-1;s++)if(e>t[s]+be)return this._infoByScale[t[s-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce((s,i)=>Math.abs(i-e)<Math.abs(s-e)?i:s,t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let s=t.length-1;s>=0;s--)if(e<t[s])return s===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[s]].level+(t[s]-e)/(t[s]-t[s+1]);return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}zoomToScale(e){return this.tileInfo.zoomToScale(e)}_getTileIdAtLOD(e,t,s){const i=this._infoByLevel[s.level];return e.set(s),t.resolution<i.resolution?null:(t.resolution===i.resolution||(e.level=t.level,e.col=Math.floor(s.col*i.resolution/t.resolution+.01),e.row=Math.floor(s.row*i.resolution/t.resolution+.01)),e)}},ze=class{constructor(e,t){this.item=e,this.controller=t,this.promise=null}};class ke{constructor(e){this._schedule=null,this._task=null,this._deferreds=new E,this._controllers=new E,this._processingItems=new E,this._pausedSignal=Me(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new Se(e.peeker),this.process=e.process;const t=e.scheduler;e.priority&&t&&(this._task=t.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=Q(this._schedule),this._task=Q(this._task)}get updating(){return!!this._task?.updating||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(t=>e.push(t)),this._controllers.clear(),e.forEach(t=>t.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((t,s)=>e(s))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,t){const s=this.get(e);if(s)return s;const i=new AbortController;let o=null;t&&(o=ae(t,()=>i.abort()));const l=()=>{const c=this._processingItems.get(e);c&&c.controller.abort(),n(),a.reject(G())},n=()=>{h.remove(),o?.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},h=ce(i.signal,l),a=ue();return this._deferreds.set(e,a),this._controllers.set(e,i),a.promise.then(n,n),this._queue.push(e),this._scheduleNext(),a.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){const e=this._queue.popLast();return e&&(this._deferreds.get(e)?.reject(G()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=fe(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(e==null)return;let t;const s=new AbortController,i=new ze(e,s);this._processingItems.set(e,i);try{t=this.process(e,s.signal)}catch(o){this._processError(i,o)}de(t)?(i.promise=t,t.then(o=>this._processResult(i,o),o=>this._processError(i,o))):this._processResult(i,t)}get test(){}}const U=[0,0];let B=class extends pe{constructor(e){super(e),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:e,process:t,scheduler:s,priority:i}=this;this._queue=new ke({concurrency:e,scheduler:s,priority:i,process:(o,l)=>{const n=this._keyToItem.get(o);return t(n,{signal:l})},peeker:o=>this._peek(o)})}destroy(){this.clear(),this._queue=ge(this._queue)}get length(){return this._queue?this._queue.length:0}abort(e){const t=typeof e=="string"?e:e.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(e){return typeof e=="string"?this._keyToItem.has(e):this._keyToItem.has(e.id)}pause(){this._queue.pause()}push(e){const t=e.key.id;if(this._queue.has(t))return this._queue.get(t);const s=this._queue.push(t),i=this.tileInfoView.getTileScale(e.key),o=_e(this._tilesByScale,i,()=>new Set),l=()=>{o.delete(e.key),o.size===0&&this._tilesByScale.delete(i),this._keyToItem.delete(t)};return o.add(e.key),this._keyToItem.set(t,e),s.then(l,l),s}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(e){if(!this.state)return e.values().next().value;const t=new Set;for(const l of e)t.add(this._keyToItem.get(l).key);const s=this.state.scale;let i,o=Number.POSITIVE_INFINITY;for(const[l,n]of this._tilesByScale)if(we(n,h=>t.has(h))){const h=Math.abs(l-s);h<o&&(i=n,o=h)}return this._getClosestTileKey(i,e).id}_getClosestTileKey(e,t){const s=this.tileInfoView,i=this.state.center;let o,l=Number.POSITIVE_INFINITY;for(const n of e)if(t.has(n.id)){s.getTileCoords(U,n);const h=Ie(U,i);h<l&&(l=h,o=n)}return o}};C([k({constructOnly:!0})],B.prototype,"concurrency",void 0),C([k({constructOnly:!0})],B.prototype,"priority",void 0),C([k({constructOnly:!0})],B.prototype,"process",void 0),C([k({constructOnly:!0})],B.prototype,"scheduler",void 0),C([k()],B.prototype,"state",void 0),C([k({constructOnly:!0})],B.prototype,"tileInfoView",void 0),B=C([me("esri.views.2d.tiling.TileQueue")],B);const Ge=B;class Ye{constructor(e,t,s){this.maxSize=e,this._tileInfoView=t,this._removedFunc=s,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(e){return this._tilePerId.has(e)}get(e){return this._tilePerId.get(e)}pop(e){const t=this._tilePerId.get(e);if(!t)return;const s=t.key.level,i=this._tileKeysPerLevel[s];ee(this._tilePerId,e);for(let o=0;o<i.length;o++)if(i[o].id===e){i.splice(o,1);break}return t.visible=!0,t}add(e){e.visible=!1;const t=e.key,s=t.id;if(this._tilePerId.has(s))return;this._tilePerId.set(s,e);const i=t.level;this._tileKeysPerLevel[i]||(this._tileKeysPerLevel[i]=[]),this._tileKeysPerLevel[i].push(t)}prune(e,t,s){let i=this._tilePerId.size;if(i<=this.maxSize)return;let o=this._tileKeysPerLevel.length-1;for(;i>this.maxSize&&o>=0;)o!==e&&(i=this._pruneAroundCenterTile(i,t,s,o)),o--;i>this.maxSize&&(i=this._pruneAroundCenterTile(i,t,s,e))}_pruneAroundCenterTile(e,t,s,i){const o=this._tileKeysPerLevel[i];if(!o||o.length===0)return e;const{size:l,origin:n}=this._tileInfoView.tileInfo,h=s*l[0],a=s*l[1],c=[0,0],f=[0,0];for(o.sort((d,_)=>(c[0]=n.x+h*(d.col+.5),c[1]=n.y-a*(d.row+.5),f[0]=n.x+h*(_.col+.5),f[1]=n.y-a*(_.row+.5),H(c,t)-H(f,t)));o.length>0;){const d=o.pop();if(this._removeTile(d.id),--e===this.maxSize)break}return e}_removeTile(e){const t=this._tilePerId.get(e);this._removedFunc&&t&&this._removedFunc(t),ee(this._tilePerId,e)}}function ee(r,e){r.delete(e)}const F=new z(0,0,0,0),M=new Map,R=[],K=[];let He=class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,e.resampling!=null&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),e.buffer!=null&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new Ye(e.cacheSize,this.tileInfoView,t=>{this.releaseTile(t)}))}destroy(){this.tileIndex.clear()}update(e){const{resampling:t,tileIndex:s}=this,{scale:i,center:o,resolution:l}=e.state,{minScale:n,maxScale:h}=this.tileInfoView,a=!e.stationary&&i>this._previousScale;if(this._previousScale=i,!t&&(i>n||i<h))return this.tiles.length=0,void this.clear();const c=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!c)return this.tiles.length=0,void this.clear();const{spans:f,lodInfo:d}=c,{level:_}=d;this.tiles.length=0,s.forEach(u=>u.visible=!0);let v=0,g=0;if(f.length>0)for(const{row:u,colFrom:m,colTo:A}of f)for(let T=m;T<=A;T++){v++;const I=F.set(_,u,d.normalizeCol(T),d.getWorldForColumn(T)).id;let S=s.get(I);if(S)S.isReady?(M.set(I,S),g++):a||this._addParentTile(I,M);else{if(this._tileCache?.has(I)){if(S=this._tileCache.pop(I),this.tileIndex.set(I,S),S.isReady){M.set(I,S),g++;continue}}else S=this.acquireTile(F),this.tileIndex.set(I,S);a||this._addParentTile(I,M)}}const w=g===v;for(const[u,m]of s){if(M.has(u))continue;F.set(u);const A=this.tileInfoView.intersects(c,F),T=this.cachePolicy==="purge"?F.level!==_:F.level>_;!A||!a&&w?!T&&A||R.push(m):m.isReady?T&&this.cachePolicy==="purge"&&this._hasReadyAncestor(F,_)?R.push(m):K.push(m):T&&R.push(m)}for(const u of K)u.isReady&&M.set(u.key.id,u);for(const u of R)this._tileCache?this._tileCache.add(u):this.releaseTile(u),s.delete(u.key.id);for(const u of M.values())this.tiles.push(u);for(const u of s.values())M.has(u.key.id)||(u.visible=!1);this._tileCache?.prune(_,o,l),V.pool.release(c),K.length=0,R.length=0,M.clear()}clear(){const{tileIndex:e}=this;for(const t of e.values())this.releaseTile(t);e.clear()}refresh(e){for(const t of this.tileIndex.values())e(t);this._tileCache?.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,t){let s=e,i=null;for(;s=this.tileInfoView.getTileParentId(s),s;)if(this.tileIndex.has(s)){if(i=this.tileIndex.get(s),i?.isReady){t.has(i.key.id)||t.set(i.key.id,i);break}}else if(this._tileCache?.has(s)&&(i=this._tileCache.pop(s),this.tileIndex.set(s,i),i?.isReady)){t.has(i.key.id)||t.set(i.key.id,i);break}}_hasReadyAncestor(e,t){const s=Z();this.tileInfoView.getTileBounds(s,e,!0);for(const i of this.tileIndex.values())if(i.isReady&&i.key.level>=t&&i.key.level<e.level){const o=Z();if(this.tileInfoView.getTileBounds(o,i.key,!0),ve(o,s))return!0}return!1}};function J(r,e){if(!(this instanceof J))return new J(r,e);this._maxEntries=Math.max(4,r||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function Pe(r,e,t){if(!t)return e.indexOf(r);for(var s=0;s<e.length;s++)if(t(r,e[s]))return s;return-1}function P(r,e){q(r,0,r.children.length,e,r)}function q(r,e,t,s,i){i||(i=X(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var o,l=e;l<t;l++)o=r.children[l],L(i,r.leaf?s(o):o);return i}function L(r,e){return r.minX=Math.min(r.minX,e.minX),r.minY=Math.min(r.minY,e.minY),r.maxX=Math.max(r.maxX,e.maxX),r.maxY=Math.max(r.maxY,e.maxY),r}function te(r,e){return r.minX-e.minX}function se(r,e){return r.minY-e.minY}function W(r){return(r.maxX-r.minX)*(r.maxY-r.minY)}function N(r){return r.maxX-r.minX+(r.maxY-r.minY)}function Xe(r,e){return(Math.max(e.maxX,r.maxX)-Math.min(e.minX,r.minX))*(Math.max(e.maxY,r.maxY)-Math.min(e.minY,r.minY))}function Re(r,e){var t=Math.max(r.minX,e.minX),s=Math.max(r.minY,e.minY),i=Math.min(r.maxX,e.maxX),o=Math.min(r.maxY,e.maxY);return Math.max(0,i-t)*Math.max(0,o-s)}function D(r,e){return r.minX<=e.minX&&r.minY<=e.minY&&e.maxX<=r.maxX&&e.maxY<=r.maxY}function O(r,e){return e.minX<=r.maxX&&e.minY<=r.maxY&&e.maxX>=r.minX&&e.maxY>=r.minY}function X(r){return{children:r,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function ie(r,e,t,s,i){for(var o,l=[e,t];l.length;)(t=l.pop())-(e=l.pop())<=s||(o=e+Math.ceil((t-e)/s/2)*s,Be(r,o,e,t,i),l.push(e,o,o,t))}J.prototype={all:function(){return this._all(this.data,[])},search:function(r){var e=this.data,t=[],s=this.toBBox;if(!O(r,e))return t;for(var i,o,l,n,h=[];e;){for(i=0,o=e.children.length;i<o;i++)l=e.children[i],O(r,n=e.leaf?s(l):l)&&(e.leaf?t.push(l):D(r,n)?this._all(l,t):h.push(l));e=h.pop()}return t},collides:function(r){var e=this.data,t=this.toBBox;if(!O(r,e))return!1;for(var s,i,o,l,n=[];e;){for(s=0,i=e.children.length;s<i;s++)if(o=e.children[s],O(r,l=e.leaf?t(o):o)){if(e.leaf||D(r,l))return!0;n.push(o)}e=n.pop()}return!1},load:function(r){if(!r||!r.length)return this;if(r.length<this._minEntries){for(var e=0,t=r.length;e<t;e++)this.insert(r[e]);return this}var s=this._build(r.slice(),0,r.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var i=this.data;this.data=s,s=i}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},insert:function(r){return r!=null&&this._insert(r,this.data.height-1),this},clear:function(){return this.data=X([]),this},remove:function(r,e){if(r==null)return this;for(var t,s,i,o,l=this.data,n=this.toBBox(r),h=[],a=[];l||h.length;){if(l||(l=h.pop(),s=h[h.length-1],t=a.pop(),o=!0),l.leaf&&(i=Pe(r,l.children,e))!==-1)return l.children.splice(i,1),h.push(l),this._condense(h),this;o||l.leaf||!D(l,n)?s?(t++,l=s.children[t],o=!1):l=null:(h.push(l),a.push(t),t=0,s=l,l=l.children[0])}return this},toBBox:function(r){return r},compareMinX:te,compareMinY:se,toJSON:function(){return this.data},fromJSON:function(r){return this.data=r,this},_all:function(r,e){for(var t=[];r;)r.leaf?e.push.apply(e,r.children):t.push.apply(t,r.children),r=t.pop();return e},_build:function(r,e,t,s){var i,o=t-e+1,l=this._maxEntries;if(o<=l)return P(i=X(r.slice(e,t+1)),this.toBBox),i;s||(s=Math.ceil(Math.log(o)/Math.log(l)),l=Math.ceil(o/Math.pow(l,s-1))),(i=X([])).leaf=!1,i.height=s;var n,h,a,c,f=Math.ceil(o/l),d=f*Math.ceil(Math.sqrt(l));for(ie(r,e,t,d,this.compareMinX),n=e;n<=t;n+=d)for(ie(r,n,a=Math.min(n+d-1,t),f,this.compareMinY),h=n;h<=a;h+=f)c=Math.min(h+f-1,a),i.children.push(this._build(r,h,c,s-1));return P(i,this.toBBox),i},_chooseSubtree:function(r,e,t,s){for(var i,o,l,n,h,a,c,f;s.push(e),!e.leaf&&s.length-1!==t;){for(c=f=1/0,i=0,o=e.children.length;i<o;i++)h=W(l=e.children[i]),(a=Xe(r,l)-h)<f?(f=a,c=h<c?h:c,n=l):a===f&&h<c&&(c=h,n=l);e=n||e.children[0]}return e},_insert:function(r,e,t){var s=this.toBBox,i=t?r:s(r),o=[],l=this._chooseSubtree(i,this.data,e,o);for(l.children.push(r),L(l,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)},_split:function(r,e){var t=r[e],s=t.children.length,i=this._minEntries;this._chooseSplitAxis(t,i,s);var o=this._chooseSplitIndex(t,i,s),l=X(t.children.splice(o,t.children.length-o));l.height=t.height,l.leaf=t.leaf,P(t,this.toBBox),P(l,this.toBBox),e?r[e-1].children.push(l):this._splitRoot(t,l)},_splitRoot:function(r,e){this.data=X([r,e]),this.data.height=r.height+1,this.data.leaf=!1,P(this.data,this.toBBox)},_chooseSplitIndex:function(r,e,t){var s,i,o,l,n,h,a,c;for(h=a=1/0,s=e;s<=t-e;s++)l=Re(i=q(r,0,s,this.toBBox),o=q(r,s,t,this.toBBox)),n=W(i)+W(o),l<h?(h=l,c=s,a=n<a?n:a):l===h&&n<a&&(a=n,c=s);return c},_chooseSplitAxis:function(r,e,t){var s=r.leaf?this.compareMinX:te,i=r.leaf?this.compareMinY:se;this._allDistMargin(r,e,t,s)<this._allDistMargin(r,e,t,i)&&r.children.sort(s)},_allDistMargin:function(r,e,t,s){r.children.sort(s);var i,o,l=this.toBBox,n=q(r,0,e,l),h=q(r,t-e,t,l),a=N(n)+N(h);for(i=e;i<t-e;i++)o=r.children[i],L(n,r.leaf?l(o):o),a+=N(n);for(i=t-e-1;i>=e;i--)o=r.children[i],L(h,r.leaf?l(o):o),a+=N(h);return a},_adjustParentBBoxes:function(r,e,t){for(var s=t;s>=0;s--)L(e[s],r)},_condense:function(r){for(var e,t=r.length-1;t>=0;t--)r[t].children.length===0?t>0?(e=r[t-1].children).splice(e.indexOf(r[t]),1):this.clear():P(r[t],this.toBBox)},_initFormat:function(r){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(r[0])),this.compareMinY=new Function("a","b",e.join(r[1])),this.toBBox=new Function("a","return {minX: a"+r[0]+", minY: a"+r[1]+", maxX: a"+r[2]+", maxY: a"+r[3]+"};")}};function qe(r,{timeZone:e,timeExtent:t}){return{$view:{scale:r,timeZone:e,timeProperties:{currentStart:t?.start,currentEnd:t?.end}}}}class he{constructor(e,t){this.key=new z(0,0,0,0),this.bounds=Z(),this.objectIds=new Set,this.key.set(t);const s=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=s.resolution,this.level=s.level,this.scale=s.scale,this.minScale=e.zoomToScale(s.level-1),this.maxScale=e.zoomToScale(s.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return ye(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(e){return qe(this.scale,e)}createChildTiles(){const e=this.key.getChildKeys(),t=xe.acquire();for(let s=0;s<e.length;s++)t[s]=new he(this.tileInfoView,e[s]);return t}getQuantizationParameters(){return Te.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}export{qe as a,he as b,z as e,De as h,J as i,Ge as p,He as r,V as s};
