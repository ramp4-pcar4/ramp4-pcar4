import{cc as Le,bW as pe,bU as ye,a6 as ae,s as $e,dk as x,cX as Ie,m as le,e as G,b6 as Xe,dl as V,cy as Ae,cv as Re}from"./main.efb50b2c.js";import{t as ze,o as He,x as Je,b as Ye,f as he,A as ge,Z as z,h as U,i as A,M as C,d as Ce,k as Ee,l as Fe,p as Te,C as Ge}from"./CIMSymbolHelper.6248d0ad.js";import{H as ne,x as te,D as oe,s as We}from"./enums.6e42a319.js";import{q as De,C as Ue,B as je,v as Be}from"./quantizationUtils.d09757e3.js";import{b as Q,S as qe}from"./Utils.f67560a4.js";import{f as Ve}from"./MaterialKey.c216087c.js";function Ke(e){if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&t.length===1?Ke(t[0]):null}case"CIMVectorMarker":{const t=e.markerGraphics;if(!t||t.length!==1)return null;const i=t[0];if(!i)return null;const r=i.geometry;if(!r)return null;const o=i.symbol;return!o||o.type!=="CIMPolygonSymbol"&&o.type!=="CIMLineSymbol"||o.symbolLayers?.some(n=>!!n.effects)?null:{geom:r,asFill:o.type==="CIMPolygonSymbol"}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function Ze(e){return e?e.rings?e.rings:e.paths?e.paths:e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}function _e(e){let t=1/0,i=-1/0,r=1/0,o=-1/0;for(const n of e)for(const l of n)l[0]<t&&(t=l[0]),l[0]>i&&(i=l[0]),l[1]<r&&(r=l[1]),l[1]>o&&(o=l[1]);return new ze(t,r,i-t,o-r)}function de(e){let t=1/0,i=-1/0,r=1/0,o=-1/0;for(const n of e)for(const l of n)l[0]<t&&(t=l[0]),l[0]>i&&(i=l[0]),l[1]<r&&(r=l[1]),l[1]>o&&(o=l[1]);return[t,r,i,o]}function Oe(e){return e?e.rings?de(e.rings):e.paths?de(e.paths):Le(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function ke(e,t,i,r,o){const[n,l,a,s]=e;if(a<n||s<l)return[0,0,0];const c=a-n,f=s-l,p=128,m=1,u=Math.floor(.5*(.5*p-m)),y=(p-2*(u+m))/Math.max(c,f),g=Math.round(c*y)+2*u,d=Math.round(f*y)+2*u;let v=1;t&&(v=d/y/(t.ymax-t.ymin));let S=0,N=0;if(r)if(o){if(t&&i&&t.ymax-t.ymin>0){const b=(t.xmax-t.xmin)/(t.ymax-t.ymin);S=r.x/(i*b),N=r.y/i}}else S=r.x,N=r.y;return S=.5*(t.xmax+t.xmin)+S*(t.xmax-t.xmin),N=.5*(t.ymax+t.ymin)+N*(t.ymax-t.ymin),S-=n,N-=l,S*=y,N*=y,S+=u,N+=u,[v,S/g-.5,-(N/d-.5)]}function Tt(e){const t=Ze(e.geom),i=_e(t),r=128,o=1,n=Math.floor(.5*(.5*r-o)),l=(r-2*(n+o))/Math.max(i.width,i.height),a=Math.round(i.width*l)+2*n,s=Math.round(i.height*l)+2*n,c=[];for(const p of t)if(p&&p.length>1){const m=[];for(const u of p){let[y,g]=u;y-=i.x,g-=i.y,y*=l,g*=l,y+=n-.5,g+=n-.5,e.asFill?m.push([y,g]):m.push([Math.round(y),Math.round(g)])}if(e.asFill){const u=m.length-1;m[0][0]===m[u][0]&&m[0][1]===m[u][1]||m.push(m[0])}c.push(m)}const f=Qe(c,a,s,n);return e.asFill&&et(c,a,s,n,f),[tt(f,n),a,s]}function Qe(e,t,i,r){const o=t*i,n=new Array(o),l=r*r+1;for(let a=0;a<o;++a)n[a]=l;for(const a of e){const s=a.length;for(let c=1;c<s;++c){const f=a[c-1],p=a[c];let m,u,y,g;f[0]<p[0]?(m=f[0],u=p[0]):(m=p[0],u=f[0]),f[1]<p[1]?(y=f[1],g=p[1]):(y=p[1],g=f[1]);let d=Math.floor(m)-r,v=Math.floor(u)+r,S=Math.floor(y)-r,N=Math.floor(g)+r;d<0&&(d=0),v>t&&(v=t),S<0&&(S=0),N>i&&(N=i);const b=p[0]-f[0],k=p[1]-f[1],$=b*b+k*k;for(let w=d;w<v;w++)for(let P=S;P<N;P++){let M,O,L=(w-f[0])*b+(P-f[1])*k;L<0?(M=f[0],O=f[1]):L>$?(M=p[0],O=p[1]):(L/=$,M=f[0]+L*b,O=f[1]+L*k);const X=(w-M)*(w-M)+(P-O)*(P-O),H=(i-P-1)*t+w;X<n[H]&&(n[H]=X)}}}for(let a=0;a<o;++a)n[a]=Math.sqrt(n[a]);return n}function et(e,t,i,r,o){for(const n of e){const l=n.length;for(let a=1;a<l;++a){const s=n[a-1],c=n[a];let f,p,m,u;s[0]<c[0]?(f=s[0],p=c[0]):(f=c[0],p=s[0]),s[1]<c[1]?(m=s[1],u=c[1]):(m=c[1],u=s[1]);let y=Math.floor(f),g=Math.floor(p)+1,d=Math.floor(m),v=Math.floor(u)+1;y<r&&(y=r),g>t-r&&(g=t-r),d<r&&(d=r),v>i-r&&(v=i-r);for(let S=d;S<v;++S){if(s[1]>S==c[1]>S)continue;const N=(i-S-1)*t;for(let b=y;b<g;++b)b<(c[0]-s[0])*(S-s[1])/(c[1]-s[1])+s[0]&&(o[N+b]=-o[N+b]);for(let b=r;b<y;++b)o[N+b]=-o[N+b]}}}}function tt(e,t){const i=2*t,r=e.length,o=new Uint8Array(4*r);for(let n=0;n<r;++n){const l=.5-e[n]/i;He(l,o,4*n)}return o}const ot=96/72;class Se{static executeEffects(t,i,r){const o=Ye(i),n=ot;let l=new he(o);for(const a of t){const s=ge(a);s&&(l=s.execute(l,a,n,r))}return l}static next(t){const i=t.next();return Je(i),i}static applyEffects(t,i,r){if(!t)return i;let o=new he(i);for(const a of t){const s=ge(a);s&&(o=s.execute(o,a,1,r))}let n,l=null;for(;n=o.next();)l?pe(l)?pe(n)&&l.paths.push(...n.paths):ye(l)&&ye(n)&&l.rings.push(...n.rings):l=n;return l}}function K(e,t,i,r,o){const n=e.referencesGeometry()&&o?it(t,r,o):t,l=e.repurposeFeature(n);try{return e.evaluate({...i,$feature:l})}catch(a){return ae.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const ie=new Map;function it(e,t,i){const{transform:r,hasZ:o,hasM:n}=i;ie.has(t)||ie.set(t,rt(t));const l=ie.get(t)(e.geometry,r,o,n);return{...e,geometry:l}}function rt(e){const t={};switch(e){case"esriGeometryPoint":return(i,r,o,n)=>Be(r,t,i,o,n);case"esriGeometryPolygon":return(i,r,o,n)=>je(r,t,i,o,n);case"esriGeometryPolyline":return(i,r,o,n)=>Ue(r,t,i,o,n);case"esriGeometryMultipoint":return(i,r,o,n)=>De(r,t,i,o,n);default:return ae.getLogger("esri.views.2d.support.arcadeOnDemand").error(new $e("mapview-arcade",`Unable to handle geometryType: ${e}`)),i=>i}}function Me(e){const t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}function Gt(e){const t=nt(e)+at(e);return Me(e.family)+(t.length>0?t:"-regular")}function nt(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function at(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}function lt(e,t){let i;if(typeof e=="string")i=x(e+`-seed(${t})`);else{let r=12;i=e^t;do i=107*(i>>8^i)+r|0;while(--r!=0)}return(1+i/(1<<31))/2}function st(e){return Math.floor(lt(e,ct)*ft)}const ct=53290320,ft=10,se=ae.getLogger("esri.symbols.cim.cimAnalyzer");function ce(e){switch(e){case"Butt":return te.BUTT;case"Square":return te.SQUARE;default:return te.ROUND}}function fe(e){switch(e){case"Bevel":return oe.BEVEL;case"Miter":return oe.MITER;default:return oe.ROUND}}function mt(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return se.warnOnce("Horizontal alignment 'justify' is not implemented. Falling back to 'center'."),"center"}}function ut(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function pt(e){let t="",i="";if(e){const r=e.toLowerCase();r.includes("italic")?t="italic":r.includes("oblique")&&(t="oblique"),r.includes("bold")?i="bold":r.includes("light")&&(i="lighter")}return{style:t,weight:i}}function yt(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}function ve(e,t,i,r){let o;e[t]?o=e[t]:(o={},e[t]=o),o[i]=r}function be(e){const t=e.markerPlacement;return t&&t.angleToLine?ne.MAP:ne.SCREEN}async function Wt(e,t,i,r,o){const n=r??[];if(!e)return n;let l,a;const s={};if(e.type!=="CIMSymbolReference")return se.error("Expect cim type to be 'CIMSymbolReference'"),n;if(l=e.symbol,a=e.primitiveOverrides,a){const f=[];for(const p of a){const m=p.valueExpressionInfo;if(m&&t){const u=m.expression,y=Ie(u,t.spatialReference,t.fields).then(g=>{g&&ve(s,p.primitiveName,p.propertyName,g)});f.push(y)}else p.value!=null&&ve(s,p.primitiveName,p.propertyName,p.value)}f.length>0&&await Promise.all(f)}const c=[];switch(Pe(l,i,c),c.length>0&&await Promise.all(c),l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":ht(l,a,s,t,n,i,o)}return n}function ht(e,t,i,r,o,n,l){if(!e)return;const a=e.symbolLayers;if(!a)return;const s=e.effects;let c;const f=z.getSize(e);e.type==="CIMPointSymbol"&&e.angleAlignment==="Map"&&(c=ne.MAP);let p=a.length;for(;p--;){const m=a[p];if(!m||m.enable===!1)continue;let u;s&&s.length&&(u=[...s]);const y=m.effects;y&&y.length&&(s?u.push(...y):u=[...y]);const g=[];let d;U.findEffectOverrides(u,t,g),d=g.length>0?Lt(u,g,i,r):u;const v=[];switch(U.findApplicableOverrides(m,t,v),m.type){case"CIMSolidFill":gt(m,d,i,v,r,o);break;case"CIMPictureFill":dt(m,d,i,v,r,n,o);break;case"CIMHatchFill":St(m,d,i,v,r,o);break;case"CIMGradientFill":vt(m,d,i,v,r,o);break;case"CIMSolidStroke":bt(m,d,i,v,r,o,e.type==="CIMPolygonSymbol",f);break;case"CIMPictureStroke":Nt(m,d,i,v,r,o,e.type==="CIMPolygonSymbol",f);break;case"CIMGradientStroke":Ct(m,d,i,v,r,o,e.type==="CIMPolygonSymbol",f);break;case"CIMCharacterMarker":if(re(m,d,i,v,r,o))break;break;case"CIMPictureMarker":if(re(m,d,i,v,r,o))break;e.type==="CIMLineSymbol"&&(c=be(m)),Ot(m,d,i,v,r,n,o,c,f);break;case"CIMVectorMarker":if(re(m,d,i,v,r,o))break;e.type==="CIMLineSymbol"&&(c=be(m)),kt(m,d,i,v,r,o,n,c,f,l);break;default:se.error("Cannot analyze CIM layer",m.type)}}}function gt(e,t,i,r,o,n){const l=e.primitiveName,a=A(e.color),[s,c]=Y(r,l,t,null,null),f=x(JSON.stringify(e)+c).toString();n.push({type:"fill",templateHash:f,materialHash:s?()=>f:f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:h(l,i,"Color",o,a,J),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:t,applyRandomOffset:!1,sampleAlphaOnly:!0})}function dt(e,t,i,r,o,n,l){const a=e.primitiveName,s=e.tintColor?A(e.tintColor):{r:255,g:255,b:255,a:1},[c,f]=Y(r,a,t,null,null),p=x(JSON.stringify(e)+f).toString(),m=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let u=C(e.scaleX);if("width"in e){const y=e.width;let g=1;const d=n.getResource(e.url);G(d)&&(g=d.width/d.height),u/=g*(e.height/y)}l.push({type:"fill",templateHash:p,materialHash:c?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:h(a,i,"TintColor",o,s,J),height:h(a,i,"Height",o,e.height),scaleX:h(a,i,"ScaleX",o,u),angle:h(a,i,"Rotation",o,C(e.rotation)),offsetX:h(a,i,"OffsetX",o,C(e.offsetX)),offsetY:h(a,i,"OffsetY",o,C(e.offsetY)),url:e.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}function St(e,t,i,r,o,n){const l=["Rotation","OffsetX","OffsetY"],a=r.filter(y=>y.primitiveName!==e.primitiveName&&!l.includes(y.propertyName)),s=e.primitiveName,[c,f]=Y(r,s,t,null,null),p=x(JSON.stringify(e)+f).toString(),m=x(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();let u={r:255,g:255,b:255,a:1};if(e.lineSymbol){const y=e.lineSymbol?.symbolLayers.find(g=>g.type==="CIMSolidStroke");y&&(u=A(y.color))}n.push({type:"fill",templateHash:p,materialHash:c?Z(m,i,a,o):m,cim:e,materialOverrides:a,colorLocked:e.colorLocked,effects:t,color:u,height:h(s,i,"Separation",o,e.separation),scaleX:1,angle:h(s,i,"Rotation",o,C(e.rotation)),offsetX:h(s,i,"OffsetX",o,C(e.offsetX)),offsetY:h(s,i,"OffsetY",o,C(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0})}function vt(e,t,i,r,o,n){const l=e.primitiveName,[a,s]=Y(r,l,t,null,null),c=x(JSON.stringify(e)+s).toString();n.push({type:"fill",templateHash:c,materialHash:a?Z(c,i,r,o):c,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})}function bt(e,t,i,r,o,n,l,a){const s=e.primitiveName,c=A(e.color),f=e.width!==void 0?e.width:4,p=ce(e.capStyle),m=fe(e.joinStyle),u=e.miterLimit,[y,g]=Y(r,s,t,null,null),d=x(JSON.stringify(e)+g).toString();let v,S;if(t&&t instanceof Array&&t.length>0){const N=t[t.length-1];if(N.type==="CIMGeometricEffectDashes"&&N.lineDashEnding==="NoConstraint"&&N.offsetAlongLine===null){const b=(t=[...t]).pop();v=b.dashTemplate,S=b.scaleDash}}n.push({type:"line",templateHash:d,materialHash:y?()=>d:d,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:h(s,i,"Color",o,c,J),width:h(s,i,"Width",o,f),cap:h(s,i,"CapStyle",o,p),join:h(s,i,"JoinStyle",o,m),miterLimit:h(s,i,"MiterLimit",o,u),referenceWidth:a,zOrder:me(e.name),dashTemplate:v,scaleDash:S,sampleAlphaOnly:!0})}function Nt(e,t,i,r,o,n,l,a){const s=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),c=e.primitiveName,f=A(e.tintColor),p=e.width!==void 0?e.width:4,m=ce(e.capStyle),u=fe(e.joinStyle),y=e.miterLimit,[g,d]=Y(r,c,t,null,null),v=x(JSON.stringify(e)+d).toString();n.push({type:"line",templateHash:v,materialHash:g?()=>s:s,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:h(c,i,"TintColor",o,f,J),width:h(c,i,"Width",o,p),cap:h(c,i,"CapStyle",o,m),join:h(c,i,"JoinStyle",o,u),miterLimit:h(c,i,"MiterLimit",o,y),referenceWidth:a,zOrder:me(e.name),dashTemplate:null,scaleDash:!1,url:e.url,sampleAlphaOnly:!1})}function Ct(e,t,i,r,o,n,l,a){const s=e.primitiveName,c=e.width!==void 0?e.width:4,f=ce(e.capStyle),p=fe(e.joinStyle),m=e.miterLimit,[u,y]=Y(r,s,t,null,null),g=x(JSON.stringify(e)+y).toString();n.push({type:"line",templateHash:g,materialHash:u?Z(g,i,r,o):g,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:t,color:{r:128,g:128,b:128,a:1},width:h(s,i,"Width",o,c),cap:h(s,i,"CapStyle",o,f),join:h(s,i,"JoinStyle",o,p),miterLimit:h(s,i,"MiterLimit",o,m),referenceWidth:a,zOrder:me(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}function re(e,t,i,r,o,n){const l=e.markerPlacement;if(!l||l.type!=="CIMMarkerPlacementInsidePolygon")return!1;const a=l,s=Math.abs(a.stepX),c=Math.abs(a.stepY);if(s===0||c===0)return!0;const f=["Rotation","OffsetX","OffsetY"],p=r.filter(b=>b.primitiveName!==e.primitiveName&&!f.includes(b.propertyName)),m="url"in e?e.url:null,[u,y]=Y(r,a.primitiveName,t,null,null),g=x(JSON.stringify(e)+y).toString();let d,v,S=null;if(l.gridType==="Random"){const b=Re(We),k=Math.max(Math.floor(b/s),1),$=Math.max(Math.floor(b/c),1);d=c*$,S=w=>w?w*$:0,v=k*s/d}else l.shiftOddRows?(d=2*c,S=b=>b?2*b:0,v=s/c*.5):(d=c,S=null,v=s/c);let N={r:255,g:255,b:255,a:1};return"tintColor"in e&&(N=A(e.tintColor)),n.push({type:"fill",templateHash:g,materialHash:u?Z(g,i,p,o):g,cim:e,materialOverrides:p,colorLocked:e.colorLocked,effects:t,color:h(a.primitiveName,i,"TintColor",o,N,J),height:h(a.primitiveName,i,"StepY",o,d,S),scaleX:v,angle:h(a.primitiveName,i,"GridAngle",o,a.gridAngle),offsetX:h(a.primitiveName,i,"OffsetX",o,C(a.offsetX)),offsetY:h(a.primitiveName,i,"OffsetY",o,C(a.offsetY)),url:m,applyRandomOffset:l.gridType==="Random",sampleAlphaOnly:!m}),!0}function Ot(e,t,i,r,o,n,l,a,s){const c=e.primitiveName,f=C(e.size);let p=C(e.scaleX);const m=C(e.rotation),u=C(e.offsetX),y=C(e.offsetY),g=e.tintColor?A(e.tintColor):{r:255,g:255,b:255,a:1},d=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}${JSON.stringify(e.animatedSymbolProperties)}`).toString(),v=xe(e.markerPlacement,r,i,o),S=$t(e.animatedSymbolProperties,r,i,o),[N,b]=Y(r,c,t,v,S),k=x(JSON.stringify(e)+b).toString(),$=e.anchorPoint??{x:0,y:0};if("width"in e){const M=e.width;let O=1;const L=n.getResource(e.url);G(L)&&(O=L.width/L.height),p/=O*(f/M)}function w(M,O){return Ce(S,M,O)}const P=e.animatedSymbolProperties&&e.animatedSymbolProperties.randomizeStartTime===!0?(M,O,L,X)=>{const H=st(X),W=w(M,O);return d+`-MATERIALGROUP(${H})-ASP(${JSON.stringify(W)})`}:N?(M,O)=>{const L=w(M,O);return d+`-ASP(${JSON.stringify(L)})`}:d;l.push({type:"marker",templateHash:k,materialHash:P,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:!1,alignment:a,size:h(c,i,"Size",o,f),scaleX:h(c,i,"ScaleX",o,p),rotation:h(c,i,"Rotation",o,m),offsetX:h(c,i,"OffsetX",o,u),offsetY:h(c,i,"OffsetY",o,y),color:h(c,i,"TintColor",o,g,J),anchorPoint:{x:$.x,y:-$.y},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:s,sizeRatio:1,markerPlacement:v,url:e.url,animatedSymbolProperties:S})}function kt(e,t,i,r,o,n,l,a,s,c){const f=e.markerGraphics;if(!f)return;let p=0;if(e.scaleSymbolsProportionally){const u=e.frame;u&&(p=u.ymax-u.ymin)}const m=xe(e.markerPlacement,r,i,o);for(const u of f)if(u){const y=u.symbol;if(!y)continue;switch(y.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":xt(e,t,m,null,u,r,i,o,n,l,a,s,p,c);break;case"CIMTextSymbol":Mt(e,t,m,u,i,r,o,n,a,s,p)}}}function Mt(e,t,i,r,o,n,l,a,s,c,f){const p=[];U.findApplicableOverrides(r,n,p);const m=r.geometry;if(!("x"in m)||!("y"in m))return;const u=r.symbol,y=yt(u),g=pt(u.fontStyleName),d=Me(u.fontFamilyName);u.font={family:d,decoration:y,...g};const v=e.frame,S=m.x-.5*(v.xmin+v.xmax),N=m.y-.5*(v.ymin+v.ymax),b=e.size/f,k=e.primitiveName,$=C(u.height)*b,w=C(u.angle),P=C(e.offsetX)+(C(u.offsetX)+S)*b,M=C(e.offsetY)+(C(u.offsetY)+N)*b,O=A(z.getFillColor(u));let L=A(z.getStrokeColor(u)),X=z.getStrokeWidth(u);X||(L=A(z.getFillColor(u.haloSymbol)),X=u.haloSize*b);const[H,W]=Y(n,k,t,i,null),j=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),E=x(JSON.stringify(r)+j+W).toString();let I=h(r.primitiveName,o,"TextString",l,r.textString,Ee,u.textCase);if(I==null)return;const{fontStyleName:B}=u,F=d+(B?"-"+B.toLowerCase():"-regular"),T=F;typeof I=="string"&&I.includes("[")&&u.fieldMap&&(I=Fe(u.fieldMap,I,u.textCase)),a.push({type:"text",templateHash:E,materialHash:H||typeof I=="function"||I.match(/\[(.*?)\]/)?(R,ee,_)=>T+"-"+Ce(I,R,ee,_):T+"-"+x(I),cim:u,materialOverrides:null,colorLocked:e.colorLocked,effects:t,alignment:s,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",fontName:F,decoration:y,weight:h(k,o,"Weight",l,g.weight),style:h(k,o,"Size",l,g.style),size:h(k,o,"Size",l,$),angle:h(k,o,"Rotation",l,w),offsetX:h(k,o,"OffsetX",l,P),offsetY:h(k,o,"OffsetY",l,M),horizontalAlignment:mt(u.horizontalAlignment),verticalAlignment:ut(u.verticalAlignment),text:I,color:O,outlineColor:L,outlineSize:X,referenceSize:c,sizeRatio:1,markerPlacement:i})}function xt(e,t,i,r,o,n,l,a,s,c,f,p,m,u){const y=o.symbol,g=y.symbolLayers;if(!g)return;if(u)return void Ne(e,t,i,r,o,l,n,a,s,c,f,p,m);let d=g.length;if(It(g))return void Pt(e,t,i,r,o,g,n,l,a,s,f,p,m);const v=Se.applyEffects(y.effects,o.geometry,c.geometryEngine);if(v)for(;d--;){const S=g[d];if(S&&S.enable!==!1)switch(S.type){case"CIMSolidFill":case"CIMSolidStroke":{const N=Se.applyEffects(S.effects,v,c.geometryEngine),b=Oe(N);if(!b)continue;const[k,$,w]=ke(b,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),P=S.type==="CIMSolidFill",M={type:"sdf",geom:N,asFill:P},O=e.primitiveName,L=C(e.size)??10,X=C(e.rotation),H=C(e.offsetX),W=C(e.offsetY),j=S.path,E=S.primitiveName,I=A(P?z.getFillColor(S):z.getStrokeColor(S)),B=P?{r:0,g:0,b:0,a:0}:A(z.getStrokeColor(S)),F=z.getStrokeWidth(S);if(!P&&!F)break;let T=!1,R="";for(const D of n)D.primitiveName!==E&&D.primitiveName!==O||(D.value!==void 0?R+=`-${D.primitiveName}-${D.propertyName}-${JSON.stringify(D.value)}`:D.valueExpressionInfo&&(T=!0));G(t)&&typeof t=="function"&&(T=!0);const ee=JSON.stringify({...e,markerGraphics:null}),_=x(JSON.stringify(M)+j).toString(),we={type:"marker",templateHash:x(JSON.stringify(o)+JSON.stringify(S)+ee+R).toString(),materialHash:T?()=>_:_,cim:M,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:$,y:w},isAbsoluteAnchorPoint:!1,size:h(e.primitiveName,l,"Size",a,L),rotation:h(e.primitiveName,l,"Rotation",a,X),offsetX:h(e.primitiveName,l,"OffsetX",a,H),offsetY:h(e.primitiveName,l,"OffsetY",a,W),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:k,color:h(E,l,"Color",a,I,J),outlineColor:h(E,l,"Color",a,B,J),outlineWidth:h(E,l,"Width",a,F),markerPlacement:i,animatedSymbolProperties:r,path:j};s.push(we);break}default:Ne(e,t,i,r,o,l,n,a,s,c,f,p,m)}}}function Pt(e,t,i,r,o,n,l,a,s,c,f,p,m){const u=o.geometry,y=n[0],g=n[1],d=Oe(u);if(!d)return;const[v,S,N]=ke(d,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),b={type:"sdf",geom:u,asFill:!0},k=e.primitiveName,$=C(e.size),w=C(e.rotation),P=C(e.offsetX),M=C(e.offsetY),O=g.path,L=g.primitiveName,X=y.primitiveName,H=A(z.getFillColor(g)),W=A(z.getStrokeColor(y)),j=z.getStrokeWidth(y);let E=!1,I="";for(const R of l)R.primitiveName!==L&&R.primitiveName!==X&&R.primitiveName!==k||(R.value!==void 0?I+=`-${R.primitiveName}-${R.propertyName}-${JSON.stringify(R.value)}`:R.valueExpressionInfo&&(E=!0));const B=JSON.stringify({...e,markerGraphics:null}),F=x(JSON.stringify(b)+O).toString(),T={type:"marker",templateHash:x(JSON.stringify(o)+JSON.stringify(g)+JSON.stringify(y)+B+I).toString(),materialHash:E?()=>F:F,cim:b,materialOverrides:null,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:S,y:N},isAbsoluteAnchorPoint:!1,size:h(e.primitiveName,a,"Size",s,$),rotation:h(e.primitiveName,a,"Rotation",s,w),offsetX:h(e.primitiveName,a,"OffsetX",s,P),offsetY:h(e.primitiveName,a,"OffsetY",s,M),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:v,color:h(L,a,"Color",s,H,J),outlineColor:h(X,a,"Color",s,W,J),outlineWidth:h(X,a,"Width",s,j),markerPlacement:i,path:O,animatedSymbolProperties:r};c.push(T)}function Ne(e,t,i,r,o,n,l,a,s,c,f,p,m){const u=wt(e,o);let y=[];const g=["Rotation","OffsetX","OffsetY"];y=l.filter(O=>O.primitiveName!==e.primitiveName||!g.includes(O.propertyName));let d="";for(const O of l)O.value!==void 0&&(d+=`-${O.primitiveName}-${O.propertyName}-${JSON.stringify(O.value)}`);const[v,S,N]=z.getTextureAnchor(u,c),b=e.primitiveName,k=C(e.rotation),$=C(e.offsetX),w=C(e.offsetY),P=x(JSON.stringify(u)+d).toString(),M={type:"marker",templateHash:P,materialHash:y.length>0||G(t)&&typeof t=="function"?Z(P,n,y,a):P,cim:u,materialOverrides:y,colorLocked:e.colorLocked,effects:t,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:v,y:S},isAbsoluteAnchorPoint:!1,size:e.size,rotation:h(b,n,"Rotation",a,k),offsetX:h(b,n,"OffsetX",a,$),offsetY:h(b,n,"OffsetY",a,w),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:N/Xe(e.size),markerPlacement:i,animatedSymbolProperties:r};s.push(M)}function wt(e,t){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[t],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}function me(e){if(e&&e.indexOf("Level_")===0){const t=parseInt(e.substr(6),10);if(!isNaN(t))return t}return 0}function J(e){if(!e||e.length===0)return null;const t=new Ae(e).toRgba();return{r:t[0],g:t[1],b:t[2],a:t[3]}}function h(e,t,i,r,o,n,l){const a=t[e];if(a){const s=a[i];if(typeof s=="string"||typeof s=="number"||s instanceof Array)return n?n.call(null,s,l):s;if(s!=null&&s instanceof V)return(c,f,p)=>{let m=K(s,c,{$view:p},r.geometryType,f);return m!==null&&n&&(m=n.call(null,m,l)),m!==null?m:o}}return o}function ue(e){return e&&e.charAt(0).toLowerCase()+e.substr(1)}function Lt(e,t,i,r){for(const o of t)if(o.valueExpressionInfo){const n=i[o.primitiveName]&&i[o.primitiveName][o.propertyName];n instanceof V&&(o.fn=(l,a,s)=>K(n,l,{$view:s},r.geometryType,a))}return(o,n,l)=>{for(const s of t)s.fn&&(s.value=s.fn(o,n,l));const a=[];for(let s of e){const c=s?.primitiveName;if(c){let f=!1;for(const p of t)if(p.primitiveName===c){const m=ue(p.propertyName);p.value!=null&&p.value!==s[m]&&(f||(s=le(s),f=!0),s[m]=p.value)}}a.push(s)}return a}}function xe(e,t,i,r){const o=[];if(U.findApplicableOverrides(e,t,o),o.length===0)return e;for(const n of o)if(n.valueExpressionInfo){const l=i[n.primitiveName]&&i[n.primitiveName][n.propertyName];l instanceof V&&(n.fn=(a,s,c)=>K(l,a,{$view:c},r.geometryType,s))}return(n,l,a)=>{for(const f of o)f.fn&&(f.value=f.fn(n,l,a));const s=le(e),c=e.primitiveName;for(const f of o)if(f.primitiveName===c){const p=ue(f.propertyName);f.value!=null&&f.value!==s[p]&&(s[p]=f.value)}return s}}function $t(e,t,i,r){const o=[];if(U.findApplicableOverrides(e,t,o),o.length===0)return e;for(const n of o)if(n.valueExpressionInfo){const l=i[n.primitiveName]&&i[n.primitiveName][n.propertyName];l instanceof V&&(n.fn=(a,s,c)=>K(l,a,{$view:c},r.geometryType,s))}return(n,l,a)=>{for(const f of o)f.fn&&(f.value=f.fn(n,l,a));const s=le(e),c=e.primitiveName;for(const f of o)if(f.primitiveName===c){const p=ue(f.propertyName);f.value!=null&&f.value!==s[p]&&(s[p]=f.value)}return s}}function Z(e,t,i,r){for(const o of i)if(o.valueExpressionInfo){const n=t[o.primitiveName]&&t[o.primitiveName][o.propertyName];n instanceof V&&(o.fn=(l,a,s)=>K(n,l,{$view:s},r.geometryType,a))}return(o,n,l)=>{for(const a of i)a.fn&&(a.value=a.fn(o,n,l));return x(e+U.buildOverrideKey(i)).toString()}}function Dt(e,t){if(!t||t.length===0)return e;const i=JSON.parse(JSON.stringify(e));return U.applyOverrides(i,t),i}function Y(e,t,i,r,o){let n=!1,l="";for(const a of e)a.primitiveName===t&&(a.value!==void 0?l+=`-${a.primitiveName}-${a.propertyName}-${JSON.stringify(a.value)}`:a.valueExpressionInfo&&(n=!0));return G(i)&&typeof i=="function"&&(n=!0),G(r)&&typeof r=="function"&&(n=!0),G(o)&&typeof o=="function"&&(n=!0),[n,l]}function Pe(e,t,i){if(e&&t)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const r=e.symbolLayers;if(!r)return;for(const o of r)switch(Xt(o,t,i),o.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in o&&o.url&&i.push(t.fetchResource(o.url,null));break;case"CIMVectorMarker":{const n=o.markerGraphics;if(!n)continue;for(const l of n)if(l){const a=l.symbol;a&&Pe(a,t,i)}}}}}}const It=e=>e&&e.length===2&&e[0].enable&&e[1].enable&&e[0].type==="CIMSolidStroke"&&e[1].type==="CIMSolidFill"&&!e[0].effects&&!e[1].effects;let q;function Xt(e,t,i){if(!(!e.effects||G(t.geometryEngine))){if(q)return void i.push(q);Te(e.effects)&&(q=Ge(),i.push(q),q.then(r=>t.geometryEngine=r))}}const At={marker:Q.MARKER,fill:Q.FILL,line:Q.LINE,text:Q.TEXT};class Ut{constructor(t,i,r,o){const n={minScale:i?.minScale,maxScale:i?.maxScale},l=Rt(n);this.layers=t,this.data=i,this.hash=this._createHash()+l,this.rendererKey=r;const a={isOutline:!1,placement:null,symbologyType:qe.DEFAULT,vvFlags:r};for(const s of t){const c=At[s.type];a.isOutline=s.type==="line"&&s.isOutline,s.materialKey=Ve(c,a),s.maxVVSize=o,s.scaleInfo=n,s.templateHash+=l}}get type(){return"expanded-cim"}_createHash(){let t="";for(const i of this.layers)t+=i.templateHash;return t}}function Rt(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}export{Wt as Y,Tt as a,K as b,lt as e,Se as f,Ut as l,Gt as n,st as o,Ke as r,Dt as s};
