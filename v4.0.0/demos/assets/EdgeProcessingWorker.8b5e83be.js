import{n as St}from"./deduplicate.9837c6dd.js";import{T as U}from"./InterleavedLayout.a13cfeee.js";import{y as Tt,u as yt,i as Lt,c as vt,l as Dt,p as Vt,o as Pt,m as xt,T as bt,h as Mt,a as Ut,b as Rt,d as Ft,A as Bt,O as Ct,x as Ht,g as Wt,w as Gt,E as kt,L as zt,B as Xt,F as Kt,I as _t,U as qt,j as jt,V as Jt,M as Yt,S as Qt,k as Zt,q as te,v as ee,z as ne,C as se,D as oe,G as re,H as ie}from"./BufferView.02e80ac7.js";import{cl as ae,i6 as ce,i7 as mt,b8 as S,fo as it,i8 as le,i9 as ue,ba as k,ia as at,ib as K,ic as ht,id as fe,ie as ge,ig as ct,ih as de}from"./main.efb50b2c.js";import{O as f}from"./VertexAttribute.5551e0d8.js";import{C as D}from"./enums.de935fa5.js";import{t as pe}from"./VertexElementDescriptor.d386088d.js";import"./types.2e1ddd0e.js";import"./preload-helper.387dac8f.js";function lt(t,e,n){const o=e/3,r=new Uint32Array(n+1),i=new Uint32Array(n+1),p=(s,a)=>{s<a?r[s+1]++:i[a+1]++};for(let s=0;s<o;s++){const a=t[3*s],g=t[3*s+1],d=t[3*s+2];p(a,g),p(g,d),p(d,a)}let c=0,m=0;for(let s=0;s<n;s++){const a=r[s+1],g=i[s+1];r[s+1]=c,i[s+1]=m,c+=a,m+=g}const l=new Uint32Array(6*o),u=r[n],I=(s,a,g)=>{if(s<a){const d=r[s+1]++;l[2*d]=a,l[2*d+1]=g}else{const d=i[a+1]++;l[2*u+2*d]=s,l[2*u+2*d+1]=g}};for(let s=0;s<o;s++){const a=t[3*s],g=t[3*s+1],d=t[3*s+2];I(a,g,s),I(g,d,s),I(d,a,s)}const N=(s,a)=>{const g=2*s,d=a-s;for(let A=1;A<d;A++){const E=l[g+2*A],L=l[g+2*A+1];let w=A-1;for(;w>=0&&l[g+2*w]>E;w--)l[g+2*w+2]=l[g+2*w],l[g+2*w+3]=l[g+2*w+1];l[g+2*w+2]=E,l[g+2*w+3]=L}};for(let s=0;s<n;s++)N(r[s],r[s+1]),N(u+i[s],u+i[s+1]);const h=new Int32Array(3*o),T=(s,a)=>s===t[3*a]?0:s===t[3*a+1]?1:s===t[3*a+2]?2:-1,$=(s,a)=>{const g=T(s,a);h[3*a+g]=-1},y=(s,a,g,d)=>{const A=T(s,a);h[3*a+A]=d;const E=T(g,d);h[3*d+E]=a};for(let s=0;s<n;s++){let a=r[s];const g=r[s+1];let d=i[s];const A=i[s+1];for(;a<g&&d<A;){const E=l[2*a],L=l[2*u+2*d];E===L?(y(s,l[2*a+1],L,l[2*u+2*d+1]),a++,d++):E<L?($(s,l[2*a+1]),a++):($(L,l[2*u+2*d+1]),d++)}for(;a<g;)$(s,l[2*a+1]),a++;for(;d<A;)$(l[2*u+2*d],l[2*u+2*d+1]),d++}return h}function H(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:me(t.layout)}}function me(t){const e=new Array;return t.fields.forEach((n,o)=>{const r={...n,constructor:It(n.constructor)};e.push([o,r])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const he=[Tt,yt,Lt,vt,Dt,Vt,Pt,xt,bt,Mt,Ut,Rt,Ft,Bt,Ct,Ht,Wt,Gt,kt,zt,Xt,Kt,_t,qt,jt,Jt,Yt,Qt,Zt,te,ee,ne,se,oe,re,ie];function It(t){return`${t.ElementType}_${t.ElementCount}`}const Ie=new Map;he.forEach(t=>Ie.set(It(t),t));function tt(t,e=0){const n=t.stride;return t.fieldNames.filter(o=>{const r=t.fields.get(o).optional;return!(r&&r.glPadding)}).map(o=>{const r=t.fields.get(o),i=r.constructor.ElementCount,p=Ne(r.constructor.ElementType),c=r.offset,m=!(!r.optional||!r.optional.glNormalized);return new pe(o,i,p,c,n,m,e)})}function Ne(t){const e=$e[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const $e={u8:D.UNSIGNED_BYTE,u16:D.UNSIGNED_SHORT,u32:D.UNSIGNED_INT,i8:D.BYTE,i16:D.SHORT,i32:D.INT,f32:D.FLOAT},Nt=U().vec3f(f.POSITION).u16(f.COMPONENTINDEX).u16(f.U16PADDING),Ae=U().vec2u8(f.SIDENESS);tt(Ae);const $t=U().vec3f(f.POSITION0).vec3f(f.POSITION1).u16(f.COMPONENTINDEX).u8(f.VARIANTOFFSET,{glNormalized:!0}).u8(f.VARIANTSTROKE).u8(f.VARIANTEXTENSION,{glNormalized:!0}).u8(f.U8PADDING,{glPadding:!0}).u16(f.U16PADDING,{glPadding:!0}),_=$t.clone().vec3f(f.NORMAL),q=$t.clone().vec3f(f.NORMALA).vec3f(f.NORMALB);f.POSITION0,f.POSITION1,f.COMPONENTINDEX,f.VARIANTOFFSET,f.VARIANTSTROKE,f.VARIANTEXTENSION,f.NORMAL,f.NORMALA,f.NORMALB,f.SIDENESS;class At{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?Oe:we}write(e,n,o){const r=this.edgeHashFunction(o);C.seed=r;const i=C.getIntRange(0,255),p=C.getIntRange(0,this.settings.variants-1),c=.7,m=C.getFloat(),l=255*(.5*Ee(-(1-Math.min(m/c,1))+Math.max(0,m-c)/(1-c),1.2)+.5);e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1),e.componentIndex.set(n,o.componentIndex),e.variantOffset.set(n,i),e.variantStroke.set(n,p),e.variantExtension.set(n,l)}trim(e,n){return e.slice(0,n)}}const et=new Float32Array(6),W=new Uint32Array(et.buffer),v=new Uint32Array(1);function we(t){const e=et;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],v[0]=5381;for(let n=0;n<W.length;n++)v[0]=31*v[0]+W[n];return v[0]}function Oe(t){const e=et;e[0]=b(t.position0[0]),e[1]=b(t.position0[1]),e[2]=b(t.position0[2]),e[3]=b(t.position1[0]),e[4]=b(t.position1[1]),e[5]=b(t.position1[2]),v[0]=5381;for(let n=0;n<W.length;n++)v[0]=31*v[0]+W[n];return v[0]}const ut=1e4;function b(t){return Math.round(t*ut)/ut}function Ee(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}class j{constructor(){this.commonWriter=new At}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return _.createBuffer(e)}write(e,n,o){this.commonWriter.write(e,n,o),ce(B,o.faceNormal0,o.faceNormal1),mt(B,B),e.normal.setVec(n,B)}trim(e,n){return this.commonWriter.trim(e,n)}}j.Layout=_,j.glLayout=tt(_,1);class J{constructor(){this.commonWriter=new At}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return q.createBuffer(e)}write(e,n,o){this.commonWriter.write(e,n,o),e.normalA.setVec(n,o.faceNormal0),e.normalB.setVec(n,o.faceNormal1)}trim(e,n){return this.commonWriter.trim(e,n)}}J.Layout=q,J.glLayout=tt(q,1);const B=S(),C=new ae,V=-1;var ft;function Y(t,e,n,o=De){const r=t.vertices.position,i=t.vertices.componentIndex,p=it(o.anglePlanar),c=it(o.angleSignificantEdge),m=Math.cos(c),l=Math.cos(p),u=Q.edge,I=u.position0,N=u.position1,h=u.faceNormal0,T=u.faceNormal1,$=ve(t),y=Le(t),s=y.length/4,a=e.allocate(s);let g=0;const d=s,A=n.allocate(d);let E=0,L=0,w=0;const nt=le(0,s),R=new Float32Array(s);ue(R,(P,O,M)=>{r.getVec(y[4*O+0],I),r.getVec(y[4*O+1],N),M[O]=de(I,N)}),nt.sort((P,O)=>R[O]-R[P]);const st=new Array,ot=new Array;for(let P=0;P<s;P++){const O=nt[P],M=R[O],G=y[4*O+0],Et=y[4*O+1],x=y[4*O+2],F=y[4*O+3],rt=F===V;if(r.getVec(G,I),r.getVec(Et,N),rt)k(h,$[3*x+0],$[3*x+1],$[3*x+2]),at(T,h),u.componentIndex=i.get(G),u.cosAngle=K(h,T);else{if(k(h,$[3*x+0],$[3*x+1],$[3*x+2]),k(T,$[3*F+0],$[3*F+1],$[3*F+2]),u.componentIndex=i.get(G),u.cosAngle=K(h,T),Te(u,l))continue;u.cosAngle<-.9999&&at(T,h)}L+=M,w++,rt||Se(u,m)?(e.write(a,g++,u),st.push(M)):ye(u,p)&&(n.write(A,E++,u),ot.push(M))}const wt=new Float32Array(st.reverse()),Ot=new Float32Array(ot.reverse());return{regular:{instancesData:e.trim(a,g),lodInfo:{lengths:wt}},silhouette:{instancesData:n.trim(A,E),lodInfo:{lengths:Ot}},averageEdgeLength:L/w}}function Se(t,e){return t.cosAngle<e}function Te(t,e){return t.cosAngle>e}function ye(t,e){const n=fe(t.cosAngle),o=Q.fwd,r=Q.ortho;return ge(o,t.position1,t.position0),n*(K(ht(r,t.faceNormal0,t.faceNormal1),o)>0?-1:1)>e}function Le(t){const e=t.faces.length/3,n=t.faces,o=t.neighbors;let r=0;for(let c=0;c<e;c++){const m=o[3*c+0],l=o[3*c+1],u=o[3*c+2],I=n[3*c+0],N=n[3*c+1],h=n[3*c+2];r+=m===V||I<N?1:0,r+=l===V||N<h?1:0,r+=u===V||h<I?1:0}const i=new Int32Array(4*r);let p=0;for(let c=0;c<e;c++){const m=o[3*c+0],l=o[3*c+1],u=o[3*c+2],I=n[3*c+0],N=n[3*c+1],h=n[3*c+2];(m===V||I<N)&&(i[p++]=I,i[p++]=N,i[p++]=c,i[p++]=m),(l===V||N<h)&&(i[p++]=N,i[p++]=h,i[p++]=c,i[p++]=l),(u===V||h<I)&&(i[p++]=h,i[p++]=I,i[p++]=c,i[p++]=u)}return i}function ve(t){const e=t.faces.length/3,n=t.vertices.position,o=t.faces,r=z.v0,i=z.v1,p=z.v2,c=new Float32Array(3*e);for(let m=0;m<e;m++){const l=o[3*m+0],u=o[3*m+1],I=o[3*m+2];n.getVec(l,r),n.getVec(u,i),n.getVec(I,p),ct(i,i,r),ct(p,p,r),ht(r,i,p),mt(r,r),c[3*m+0]=r[0],c[3*m+1]=r[1],c[3*m+2]=r[2]}return c}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(ft||(ft={}));const Q={edge:{position0:S(),position1:S(),faceNormal0:S(),faceNormal1:S(),componentIndex:0,cosAngle:0},ortho:S(),fwd:S()},z={v0:S(),v1:S(),v2:S()},De={anglePlanar:4,angleSignificantEdge:35};class Ve{async extract(e){const n=X(e),o=Pe(n),r=[n.data.buffer];return{result:xe(o,r),transferList:r}}async extractComponentsEdgeLocations(e){const n=X(e),o=Z(n.data,n.skipDeduplicate,n.indices,n.indicesLength),r=Y(o,Re,pt),i=[];return{result:H(r.regular.instancesData,i),transferList:i}}async extractEdgeLocations(e){const n=X(e),o=Z(n.data,n.skipDeduplicate,n.indices,n.indicesLength),r=Y(o,Ue,pt),i=[];return{result:H(r.regular.instancesData,i),transferList:i}}}function Pe(t){const e=Z(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return gt.updateSettings(t.writerSettings),dt.updateSettings(t.writerSettings),Y(e,gt,dt)}function X(t){return{data:Nt.createView(t.dataBuffer),indices:t.indicesType==="Uint32Array"?new Uint32Array(t.indicesBuffer):t.indicesType==="Uint16Array"?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function xe(t,e){return e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:H(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:H(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function Z(t,e,n,o){if(e)return{faces:n,facesLength:o,neighbors:lt(n,o,t.count),vertices:t};const r=St(t.buffer,t.stride/4,{originalIndices:n,originalIndicesLength:o}),i=lt(r.indices,o,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:Nt.createView(r.buffer)}}const gt=new j,dt=new J;class be{allocate(e){return Fe.createBuffer(e)}trim(e,n){return e.slice(0,n)}write(e,n,o){e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1)}}class Me{allocate(e){return Be.createBuffer(e)}trim(e,n){return e.slice(0,n)}write(e,n,o){e.position0.setVec(n,o.position0),e.position1.setVec(n,o.position1),e.componentIndex.set(n,o.componentIndex)}}const Ue=new be,Re=new Me,pt={allocate:()=>null,write:()=>{},trim:()=>null},Fe=U().vec3f(f.POSITION0).vec3f(f.POSITION1),Be=U().vec3f(f.POSITION0).vec3f(f.POSITION1).u16(f.COMPONENTINDEX).u16(f.U16PADDING,{glPadding:!0});function qe(){return new Ve}export{Ve as EdgeProcessingWorker,qe as default,Pe as extract,Be as extractComponentsEdgeLocationsLayout,Fe as extractEdgeLocationsLayout};
