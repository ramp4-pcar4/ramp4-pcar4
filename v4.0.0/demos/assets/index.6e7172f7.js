import{gs as I,gN as x}from"./main.efb50b2c.js";import{f as l}from"./fabric.3f822428.js";import"./preload-helper.387dac8f.js";const M=30,N=20,T=16,G=12,L=8,m=32,y=32,k=350,w=20,u="Montserrat, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif";class E extends I{get config(){return this.$iApi.fixture.get("export").config?.legend}async make(o){const i=this.$vApp.$store.get(x.layers).filter(s=>s.isLoaded&&s.visibility&&!s.isCosmetic);if(i.length===0)return new l.fabric.Group([],{originX:"left"});const t=Math.min(i.length,Math.floor(o.width/(k+w))||1),e=(o.width-(t-1)*w)/t;let n=0;const c=(await Promise.all(this._makeSegments(i,e))).map(({title:s,items:f},b)=>{b>0&&(n+=M),s.top=n,n+=s.height+N;const p=f.map(({title:h,items:S},C)=>{const d=[];return h&&!(f.length===1&&h.text===s.text)&&(C>0&&(n+=T),h.top=n,n+=h.height+G,d.push(h)),S.forEach(g=>{g.top=n,n+=g.height+L}),[...d,...S].filter(g=>g)});return new l.fabric.Group([s,...p.flat()])}).flat(),a=this._makeColumns(c,e,t);return Promise.resolve(a)}_makeColumns(o,i,t){let e=0,n=0,r=0;const c=o[o.length-1].aCoords.bl.y/t;return o.forEach((a,s)=>{const f=s!==o.length-1?o[s+1].top-a.top:a.height,b=r>c*(e+1),p=n!==0&&f>c,h=t-e>o.length-s;(b||p||h)&&e<t&&(++e,n=0),a.left=e*(i+w),a.top=n,n+=f,r+=f}),new l.fabric.Group(o,{originX:"left"})}_makeSegments(o,i){return o.map(async t=>{const e=new l.fabric.Textbox(t.name,{fontSize:24,fontFamily:u,width:i}),n=this._getLayerTreeIds(t);let r=[];return r=t.supportsSublayers?await Promise.all(this._makeSegmentChunks(n,t,i)):await Promise.all(this._makeSegmentChunks([-1],t,i)),{title:e,items:r}})}_makeSegmentChunks(o,i,t){const e=i;return o.map(async n=>{const r=n===-1?e:e.getSublayer(n);if(!r)return{title:new l.fabric.Textbox("ERROR",{fontSize:20,fontFamily:u,width:t}),items:[]};await Promise.all(r.legend.map(f=>f.drawPromise));const c=r.legend,a=new l.fabric.Textbox(r.name,{fontSize:20,fontFamily:u,width:t}),s=await Promise.all(this._makeChunkItems(c,t));return{title:a,items:s}})}_makeChunkItems(o,i){return o.map(async t=>{const e=(await F(l.fabric.loadSVGFromString)(t.svgcode))[0];if(t.esriStandard){e.originY="center",e.top=m/2;const n=new l.fabric.Textbox(t.label,{fontSize:12,fontFamily:u,originY:"center",left:y+20,top:m/2,width:i-y-20});return new l.fabric.Group([e,n],{height:m})}else{const n=new l.fabric.Textbox(t.label,{fontSize:12,fontFamily:u,originY:"center",left:0,top:m/2,width:i}),r=Number(t.imgWidth),c=Number(t.imgHeight),a=Math.min(1,i/r);return e&&(e.originY="center",e.top=c*a/2+m,e.scaleToHeight(c*a),e.scaleToWidth(r*a)),new l.fabric.Group([n,e].filter(Boolean),{height:c*a+m})}})}_getLayerTreeIds(o){const i=[],t=[...o.sublayers];for(;t.length>0;){const e=t.shift();!e||(e.visibility&&i.push(e.layerIdx),t.push(...e.sublayers))}return i}}const F=_=>o=>new Promise(i=>{_(o,t=>{i(t)})});export{E as default};
