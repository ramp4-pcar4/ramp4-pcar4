import{gK as g,gs as H,gw as S}from"./main.efb50b2c.js";import{E as T,x as L,a as y}from"./screen.949693af.js";import{f as F}from"./fabric.3f822428.js";import"./preload-helper.387dac8f.js";var $={exports:{}};(function(E,i){(function(p,c){c()})(g,function(){function p(e,t){return typeof t>"u"?t={autoBom:!1}:typeof t!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\uFEFF",e],{type:e.type}):e}function c(e,t,r){var o=new XMLHttpRequest;o.open("GET",e),o.responseType="blob",o.onload=function(){u(o.response,t,r)},o.onerror=function(){console.error("could not download file")},o.send()}function w(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch{}return 200<=t.status&&299>=t.status}function d(e){try{e.dispatchEvent(new MouseEvent("click"))}catch{var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var a=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof g=="object"&&g.global===g?g:void 0,v=a.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),u=a.saveAs||(typeof window!="object"||window!==a?function(){}:"download"in HTMLAnchorElement.prototype&&!v?function(e,t,r){var o=a.URL||a.webkitURL,n=document.createElement("a");t=t||e.name||"download",n.download=t,n.rel="noopener",typeof e=="string"?(n.href=e,n.origin===location.origin?d(n):w(n.href)?c(e,t,r):d(n,n.target="_blank")):(n.href=o.createObjectURL(e),setTimeout(function(){o.revokeObjectURL(n.href)},4e4),setTimeout(function(){d(n)},0))}:"msSaveOrOpenBlob"in navigator?function(e,t,r){if(t=t||e.name||"download",typeof e!="string")navigator.msSaveOrOpenBlob(p(e,r),t);else if(w(e))c(e,t,r);else{var o=document.createElement("a");o.href=e,o.target="_blank",setTimeout(function(){d(o)})}}:function(e,t,r,o){if(o=o||open("","_blank"),o&&(o.document.title=o.document.body.innerText="downloading..."),typeof e=="string")return c(e,t,r);var n=e.type==="application/octet-stream",l=/constructor/i.test(a.HTMLElement)||a.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent);if((f||n&&l||v)&&typeof FileReader<"u"){var h=new FileReader;h.onloadend=function(){var x=h.result;x=f?x:x.replace(/^data:[^;]*;/,"data:attachment/file;"),o?o.location.href=x:location=x,o=null},h.readAsDataURL(e)}else{var b=a.URL||a.webkitURL,m=b.createObjectURL(e);o?o.location=m:location.href=m,o=null,setTimeout(function(){b.revokeObjectURL(m)},4e4)}});a.saveAs=u.saveAs=u,E.exports=u})})($);var M=$.exports;F.fabric.Object.prototype.objectCaching=!1;const A=1200,s={TOP:40,RIGHT:40,BOTTOM:40,LEFT:40};class O extends H{fcFabric;fcFabricDownload;options={runningHeight:0,scale:1};get config(){return super.config}_parseConfig(i){!i||(this.$vApp.$store.set(T.componentSelectedState,{title:i.title?.selected??!0,map:i.map?.selected??!0,mapElements:i.mapElements?.selected??!0,legend:i.legend?.selected??!0,footnote:i.footnote?.selected??!0,timestamp:i.timestamp?.selected??!0}),this.$vApp.$store.set(T.fileName,i.fileName||""),this.handlePanelWidths(["export"]))}getSubFixture(i){return this.$iApi.fixture.get(i)}async make(i,p){this.fcFabric=new F.fabric.StaticCanvas(i,{backgroundColor:"#fff"}),this.fcFabricDownload=new F.fabric.StaticCanvas(null,{backgroundColor:"#fff"}),this.options.runningHeight=0;const c=this.$iApi.$vApp.$store.get(T.componentSelectedState),w=this.getSubFixture("export-title"),d=this.getSubFixture("export-map"),a=this.getSubFixture("export-scalebar"),v=this.getSubFixture("export-northarrow"),u=this.getSubFixture("export-legend");let e,t,r,o,n;const l=[];c.title&&(e=await w.make({top:this.options.runningHeight,left:0,originX:"left",width:p,textAlign:"center"}),this.options.runningHeight+=e.height+40,l.push(e)),c.map&&(t=await d.make({top:this.options.runningHeight}),e&&(e.left=t.width/2,e.originX="center"),this.options.runningHeight+=t.height+40,l.push(t)),!t&&e&&(e.width=A),this.options.scale=p/((t?.width??A)+s.LEFT+s.RIGHT),c.mapElements&&(r=await a.make({top:this.options.runningHeight,left:0}),this.options.runningHeight+=r.height+40,l.push(r),o=await v.make({top:r.top,left:p/this.options.scale}),o.top+=o.height/2-20,o.left+=-o.width*2,l.push(o)),c.legend&&(n=await u.make({width:u.config?.columnWidth??t?.width??A}),n.top=this.options.runningHeight,this.options.runningHeight+=n.height,l.push(n));const f=new F.fabric.Group(l,{top:s.TOP*this.options.scale,left:s.LEFT*this.options.scale}),h=await new Promise(b=>{f.clone(m=>{b(m)})});h.top=s.TOP,h.left=s.LEFT,this.fcFabricDownload.add(h),f.scale(this.options.scale),this.fcFabric.add(f),this.fcFabric.setDimensions({width:p,height:(this.options.runningHeight+s.TOP+s.BOTTOM)*this.options.scale}),this.fcFabric.renderAll(),this.fcFabricDownload.setDimensions({width:(t?.width??A)+s.LEFT+s.RIGHT,height:this.options.runningHeight+s.TOP+s.BOTTOM}),this.fcFabricDownload.renderAll()}export(){if(!this.fcFabric)return;const i=new Date,p=this.config?.fileName||`map-carte - ${i.getFullYear()}-${i.getMonth()}-${i.getDay()}, ${i.getHours()}_${i.getMinutes()}`;M.saveAs(this.fcFabricDownload.toDataURL({format:"png",quality:1}),`${p}.png`)}}var R={en:{"export.title":"Export","export.alertName":"Export","export.download":"Download image","export.refresh":"Refresh","export.scaleBar.approx":"{0} approx.","export.menu":"Settings Menu","export.menu.component.title":"Title","export.menu.component.map":"Map","export.menu.component.mapElements":"North arrow and scalebar","export.menu.component.legend":"Legend","export.menu.component.footnote":"Footnote","export.menu.component.timestamp":"Timestamp"},fr:{"export.title":"Exporter","export.alertName":"Exporter","export.download":"T\xE9l\xE9charger l'image","export.refresh":"Rafra\xEEchir","export.scaleBar.approx":"Environ {0}","export.menu":"Menu des param\xE8tres","export.menu.component.title":"Titre","export.menu.component.map":"Carte","export.menu.component.mapElements":"Fl\xE8che du nord et \xE9chelle graphique","export.menu.component.legend":"L\xE9gende","export.menu.component.footnote":"R\xE9f\xE9rence","export.menu.component.timestamp":"Horodatage"}};class N extends O{initialized(){this.$iApi.fixture.add("export-title"),this.$iApi.fixture.add("export-map"),this.$iApi.fixture.add("export-legend"),this.$iApi.fixture.add("export-northarrow"),this.$iApi.fixture.add("export-scalebar")}added(){this.$vApp.$store.registerModule("export",L()),this.$iApi.panel.register({id:"export",config:{screens:{"export-screen":S(y)},style:{"flex-grow":"1","max-width":"800px"},button:{tooltip:"export.title",icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none" /><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" /></svg>'},alertName:"export.alertName"}},{i18n:{messages:R}}),this._parseConfig(this.config);const i=this.$vApp.$watch(()=>this.config,p=>this._parseConfig(p));this.removed=()=>{i(),this.$iApi.fixture.get("export-title")?.remove(),this.$iApi.fixture.get("export-map")?.remove(),this.$iApi.fixture.get("export-legend")?.remove(),this.$iApi.fixture.get("export-northarrow")?.remove(),this.$iApi.fixture.get("export-scalebar")?.remove(),this.$iApi.fixture.get("appbar")&&this.$iApi.$vApp.$store.dispatch("appbar/removeButton","export"),this.$iApi.panel.remove("export"),this.$vApp.$store.unregisterModule("export")}}}export{N as default};
