import{U as b,s as y,t as I,B as g}from"./main.efb50b2c.js";import{a as i}from"./lazyLayerLoader.e0a392f3.js";import{e as v}from"./jsonContext.4a2dd7f6.js";async function d(e){const{data:n}=await b(e,{responseType:"json",query:{f:"json"}});return n}async function w(e,n){const t=e.instance.portalItem;if(t&&t.id)return await t.load(n),T(e),L(e,n)}function T(e){const n=e.instance.portalItem;if(!e.supportedTypes.includes(n.type))throw new y("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:n.type,expectedType:e.supportedTypes.join(", ")})}async function L(e,n){const t=e.instance,r=t.portalItem,{url:a,title:l}=r,o=v(r);if(t.type==="group")return t.read({title:l},o),S(t,e);a&&t.read({url:a},o);const u=await f(e,n);return u&&t.read(u,o),t.resourceReferences={portalItem:r,paths:o.readResourcePaths},t.read({title:l},o),I(t,o)}function S(e,n){let t;const r=e.portalItem.type;switch(r){case"Feature Service":case"Feature Collection":t=i.FeatureLayer;break;case"Stream Service":t=i.StreamLayer;break;case"Scene Service":t=i.SceneLayer;break;default:throw new y("portal:unsupported-item-type-as-group",`The item type '${r}' is not supported as a 'IGroupLayer'`)}let a;return t().then(l=>(a=l,f(n))).then(async l=>r==="Feature Service"?(l=await m(l,e.portalItem.url),c(e,a,l)):s(l)>0?c(e,a,l):F(e,a))}function F(e,n){return e.portalItem.url?d(e.portalItem.url).then(t=>{function r(a){return{id:a.id,name:a.name}}t&&c(e,n,{layers:t.layers?.map(r),tables:t.tables?.map(r)})}):Promise.resolve()}function c(e,n,t){let r=t.layers||[];const a=t.tables||[];e.portalItem.type==="Feature Collection"&&(r.forEach(l=>{l?.layerDefinition?.type==="Table"&&a.push(l)}),r=r.filter(l=>l?.layerDefinition?.type!=="Table")),r.reverse().forEach(l=>{const o=p(e,n,t,l);e.add(o)}),a.reverse().forEach(l=>{const o=p(e,n,t,l);e.tables.add(o)})}function p(e,n,t,r){const a=new n({portalItem:e.portalItem.clone(),layerId:r.id,sublayerTitleMode:"service-name"});if(e.portalItem.type==="Feature Collection"){const l={origin:"portal-item",portal:e.portalItem.portal||g.getDefault()};a.read(r,l);const o=t.showLegend;o!=null&&a.read({showLegend:o},l)}return a}function f(e,n){if(e.supportsData===!1)return Promise.resolve(void 0);const t=e.instance;return t.portalItem.fetchData("json",n).catch(()=>null).then(async r=>{if(D(t)){let a,l=!0;return r&&s(r)>0&&(t.layerId==null&&(t.layerId=h(r)),a=j(r,t.layerId),a&&(s(r)===1&&(l=!1),r.showLegend!=null&&(a.showLegend=r.showLegend))),l&&t.sublayerTitleMode!=="service-name"&&(t.sublayerTitleMode="item-title-and-service-name"),a}return r})}async function m(e,n){if(e?.layers==null||e?.tables==null){const t=await d(n);(e=e||{}).layers=e.layers||t?.layers,e.tables=e.tables||t?.tables}return e}function h(e){const n=e.layers;if(n&&n.length)return n[0].id;const t=e.tables;return t&&t.length?t[0].id:null}function j(e,n){const t=e.layers;if(t){for(let a=0;a<t.length;a++)if(t[a].id===n)return t[a]}const r=e.tables;if(r){for(let a=0;a<r.length;a++)if(r[a].id===n)return r[a]}return null}function s(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function D(e){return e.type!=="stream"&&"layerId"in e}var _=Object.freeze(Object.defineProperty({__proto__:null,getFirstLayerOrTableId:h,getNumLayersAndTables:s,load:w,preprocessFSItemData:m},Symbol.toStringTag,{value:"Module"}));export{s as I,m as f,_ as l,h as m,d as n};
