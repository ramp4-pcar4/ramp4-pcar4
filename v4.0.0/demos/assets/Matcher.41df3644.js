import{s as rt,cO as Si,bi as Li,i as V,e as E,cP as se,cQ as re,ae as ne,b6 as g,cR as Pi,a6 as mt,bq as qe,cn as ae,cS as Ti,ck as zi,cr as Ii,b5 as bt,cp as St,b7 as oe,bj as Ct,c1 as $i,as as Wi,aL as Ci,b3 as he,aR as Ei,aH as je,aI as Qe,B as Ri,d as Ai,aM as Fi,aN as ki,cT as be,cU as Se,cV as Le,b2 as Bi,au as Pe,cW as Vi,cX as Oi}from"./main.efb50b2c.js";import{E as Ht,F as Di,G as st,f as Gi,j as Je,H as B,L as C,M as Ki,Q as Zi,S as Ni,T as it,W as Xi,_ as Ui,e as I,$ as ti,o as Lt,a0 as Hi,x as Te,a1 as Yi,a2 as ei,a3 as Vt,a4 as ii}from"./enums.6e42a319.js";import{f as qi,p as ji}from"./visualVariablesUtils.42df48c6.js";import{b as P,G as Yt,x as F,d as M,f as Y,j as $,S as Ot,k as Qi,t as Ji}from"./Utils.f67560a4.js";import{l as ts}from"./tileUtils.0431f5e8.js";import{n as si,a as es,d as is,o as ss}from"./TileClipper.68567d53.js";import{U as qt,s as rs,r as ri,n as ni,i as ns,a as as,Z as os,c as hs,o as ls,N as le,C as Et,w as ft,O as Rt,b as ai,P as cs,f as ce}from"./MaterialKey.c216087c.js";import{g as us,b as fs,c as _s,n as ze,d as Pt}from"./CIMSymbolHelper.6248d0ad.js";import{f as Xt,s as ds,l as ms,Y as ps,b as ys}from"./ExpandedCIM.7b8d9605.js";import{h as Ie,M as xs}from"./GeometryUtils.8166011b.js";import"./earcut.d30cbec0.js";import{s as oi}from"./Geometry.b68345ae.js";import{_ as hi}from"./preload-helper.387dac8f.js";import{c as gs,a as Ms}from"./devEnvironmentUtils.8c6e6b72.js";function k(n,t){if(n&&"name"in n){const e=n;return t&&t.error(new rt(e.name,e.message,e.details)),!1}return!0}const vs=1.25;class Tt{constructor(t,e){this._pos=0;const i=e?this._roundToNearest(e,t.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(i),this._buffer=new t(this._array),this._ctor=t,this._i16View=new Int16Array(this._array)}get length(){return this._pos}_roundToNearest(t,e){const i=Math.round(t);return i+(e-i%e)}_ensureSize(t){if(this._pos+t>=this._buffer.length){const e=this._roundToNearest((this._array.byteLength+t*this._buffer.BYTES_PER_ELEMENT)*vs,this._buffer.BYTES_PER_ELEMENT),i=new ArrayBuffer(e),s=new this._ctor(i);s.set(this._buffer,0),this._array=i,this._buffer=s,this._i16View=new Int16Array(this._array)}}ensureSize(t){this._ensureSize(t)}writeF32(t){this._ensureSize(1);const e=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=t,this._pos++,e}push(t){this._ensureSize(1);const e=this._pos;return this._buffer[this._pos++]=t,e}writeFixed(t){this._buffer[this._pos++]=t}setValue(t,e){this._buffer[t]=e}i1616Add(t,e,i){this._i16View[2*t]+=e,this._i16View[2*t+1]+=i}getValue(t){return this._buffer[t]}incr(t){if(this._buffer.length<t)throw new Error("Increment index overflows the target buffer");this._buffer[t]++}decr(t){this._buffer[t]--}writeRegion(t){this._ensureSize(t.length);const e=this._pos;return this._buffer.set(t,this._pos),this._pos+=t.length,e}writeManyFrom(t,e,i){this._ensureSize(i-e);for(let s=e;s!==i;s++)this.writeFixed(t._buffer[s])}buffer(){const t=this._array.slice(0,4*this._pos);return this.destroy(),t}toArray(){const t=this._array,e=[];for(let i=0;i<t.byteLength/4;i++)e.push(t[i]);return e}seek(t){this._pos=t}destroy(){this._array=null,this._buffer=null}}const ct=new Map;function ws(n,t,e){const{indicesPerRecord:i,multiplier:s,verticesPerRecord:r}=ct.get(n);return{recordBytes:e*Ht*Uint32Array.BYTES_PER_ELEMENT,indexBytes:s*i*e*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:s*r*e*t}}ct.set(P.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),ct.set(P.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),ct.set(P.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),ct.set(P.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),ct.set(P.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});class $e{constructor(t,e,i){this._start={index:0,vertex:0};const s=ws(t,e,i),r=e/4;this.geometryType=t,this._records=new Tt(Int32Array,s.recordBytes),this._indices=new Tt(Uint32Array,s.indexBytes),this._vertices=new Tt(Uint32Array,s.vertexBytes),this._metrics=new Tt(Float32Array,0),this._strideInt=r}serialize(t){const e=this._records.buffer(),i=this._indices.buffer(),s=this._vertices.buffer(),r=this._metrics.length?this._metrics.buffer():null,a=4*this._strideInt;return t.push(e,i,s),{stride:a,records:e,indices:i,vertices:s,metrics:r}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/Ht}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(t){this._vertices.ensureSize(t)}indexEnsureSize(t){this._indices.ensureSize(t)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(t,e,i,s,r,a,o,h){this._records.push(t),this._records.push(e),this._records.push(i),this._records.push(s),this._records.push(r),this._records.push(a),this._records.push(o),this._records.writeF32(h)}writeIndex(t){this._indices.push(t)}writeVertex(t){this._vertices.push(t)}writeVertexF32(t){this._vertices.writeF32(t)}copyLastFrom(t,e,i){const s=t._records.length-Ht,r=t._records.getValue(s),a=t._records.getValue(s+1),o=t._records.getValue(s+2),h=t._records.getValue(s+4),l=t._records.getValue(s+6),c=t._records.getValue(s+7),u=this._vertices.length,_=(t._start.vertex-this._vertices.length)/this._strideInt,f=this._indices.length,m=this.vertexCount;for(let d=t._start.index;d!==t._indices.length;d++){const y=t._indices.getValue(d);this._indices.push(y-_)}for(let d=t._start.vertex;d!==t._vertices.length;d++){const y=t._vertices.getValue(d);this._vertices.push(y)}for(let d=u;d<=this._vertices.length;d+=this._strideInt)this._vertices.i1616Add(d,e,i);this._records.push(r),this._records.push(a),this._records.push(o),this._records.push(f),this._records.push(h),this._records.push(m),this._records.push(l),this._records.push(c)}}const Dt=1,ue=2,Gt=4,fe=8,_e=16,Kt=32,de=64,Zt=128;function We(n){switch(n){case Dt:case fe:case Kt:return-1;case ue:case de:return 0;case Gt:case _e:case Zt:return 1}}function Ce(n){switch(n){case Dt:case ue:case Gt:return-1;case fe:case _e:return 0;case Kt:case de:case Zt:return 1}}const Ee=Dt|fe|Kt,Re=Gt|_e|Zt,Ae=Dt|ue|Gt,Fe=Kt|de|Zt;class Kr{constructor(t,e,i,s,r,a=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=e,this.tileKey=t,this._hasAggregate=s,this._pixelBufferEnabled=r,this._version=a,this._symbologyType=i}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(t){const e=[];return e.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((i,s)=>{const r=1<<s,a=We(r),o=Ce(r),h=ts(new Si(this.tileKey),a,o,t),l=this._serializeTileVertexData(this.tileKey,h.id,i.vertexData);l.message.bufferIds=i.displayIds,e.push(l)}),e}_serializeTileVertexData(t,e,i){const s=new Array;return{message:{tileKeyOrigin:t,tileKey:e,data:{[P.MARKER]:i.get(P.MARKER)?.serialize(s),[P.FILL]:i.get(P.FILL)?.serialize(s),[P.LINE]:i.get(P.LINE)?.serialize(s),[P.TEXT]:i.get(P.TEXT)?.serialize(s),[P.LABEL]:i.get(P.LABEL)?.serialize(s)},version:this._version},transferList:s}}featureStart(t,e){this._current.insertAfter=t,this._current.sortKey=e}featureEnd(){}recordStart(t,e,i,s){this._current.writer=this._getVertexWriter(i),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=s,this._current.id=t,this._current.materialKey=e,this._current.geometryType=i,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(t){this._current.writer.vertexEnsureSize(t)}indexEnsureSize(t){this._current.writer.indexEnsureSize(t)}vertexBounds(t,e,i,s){this._current.bufferingEnabled&&this._addOverlap(t,e,i,s)}vertexWrite(t){this._current.writer.writeVertex(t)}vertexWriteF32(t){this._current.writer.writeVertexF32(t)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(t){this._current.writer.writeIndex(t)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(t,e,i,s,r,a,o,h){this._current.writer=this._getVertexWriter(P.LABEL);const l=this._current.writer.metricWriter;l.push(qi(t)),l.push(e),l.push(i),l.push(s),l.push(r),l.push(a),l.push(o),l.push(h),l.push(255),this._current.metricBoxLenPointer=l.push(0)}metricEnd(){const t=this._current.writer.metricWriter;t.getValue(this._current.metricBoxLenPointer)===0&&t.seek(t.length-10)}metricBoxWrite(t,e,i,s){const r=this._current.writer.metricWriter;r.incr(this._current.metricBoxLenPointer),r.push(0),r.push(0),r.push(t),r.push(e),r.push(i),r.push(s)}recordEnd(){const t=this._current.vertStart,e=this._current.writer.vertexCount-t;if(!e)return!1;this.hasRecords=!0;const i=this._current.indexStart,s=this._current.writer.indexCount-i;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,i,s,t,e,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||this._current.overlaps===0||this._current.geometryType===P.LABEL)return!0;const r=this._current.writer;for(let a=0;a<8;a++){const o=1<<a;if(this._current.overlaps&o){this._data.neighbors[a]||(this._data.neighbors[a]={vertexData:new Map,displayIds:new Set});const h=this._data.neighbors[a],l=this._current.geometryType;if(!h.vertexData.has(l)){const m=Yt(l,this._symbologyType).geometry,d=new $e(l,m,Di);h.vertexData.set(l,d)}const c=h.vertexData.get(this._current.geometryType),u=8,_=512*-We(o)*u,f=512*-Ce(o)*u;c.copyLastFrom(r,_,f),h.displayIds.add(this._current.id)}}return!0}_addOverlap(t,e,i,s){const r=255^((t<0+i?Re:t>=st-i?Ee:Re|Ee)|(e<0+s?Fe:e>=st-s?Ae:Fe|Ae));this._current.overlaps|=r}_getVertexWriter(t){if(!this._data.self.has(t)){const e=this._data.self,i=Yt(t,this._symbologyType).geometry;e.set(t,new $e(t,i,this.hint.records))}return this._data.self.get(t)}}const G=0,K=100;function ke(n,t,e){return n[0]=t[0]-e[0],n[1]=t[1]-e[1],n}function li(n,t){return Math.sqrt(n*n+t*t)}function Be(n){const t=li(n[0],n[1]);n[0]/=t,n[1]/=t}function bs(n,t){return li(n[0]-t[0],n[1]-t[1])}function w(n){return typeof n=="function"}function jt(n=2){return 1/Math.max(n,1)}function J(n,t){return[!!n.minScale&&t.scaleToZoom(n.minScale)||G,!!n.maxScale&&t.scaleToZoom(n.maxScale)||K]}function Ss(n,t){return n[t+1]}function ci(n){return n.length-1}function Ls(n){let t=0;for(let e=0;e<ci(n);e++)t+=Ps(n,e);return t}function Ps(n,t,e=1){const[i,s]=Ss(n,t);return Math.sqrt(i*i+s*s)*e}class At{constructor(t,e,i,s,r){this._segments=t,this._index=e,this._distance=i,this._xStart=s,this._yStart=r,this._done=!1}static create(t){return new At(t,0,0,t[0][0],t[0][1])}clone(){return new At(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(e);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<ci(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let s=this.backwardLength;for(;this.prev();){if(s+this.length>t)return this._seekBackwards(t-s);s+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}}function Ts(n,t,e,i=!0){const s=Ls(n),r=At.create(n),a=s/2;if(!i)return r.seek(a),void e(r.clone(),0,a+0*t,s);const o=Math.max((s-t)/2,0),h=Math.floor(o/t),l=a-h*t;r.seek(l);for(let c=-h;c<=h;c++)r.x<512&&r.x>=0&&r.y<512&&r.y>=0&&e(r.clone(),c,a+c*t,s),r.seek(t)}function zs(n,t){const e=t;for(let i=0;i<n.length;i++){let s=n[i];const r=[];r.push(s[0]);for(let o=1;o<s.length;o++){let[h,l]=r[o-1];h+=s[o][0],l+=s[o][1],r.push([h,l])}Is(r,e);const a=[];a.push(r[0]);for(let o=1;o<r.length;o++){const[h,l]=r[o-1],[c,u]=r[o],_=Math.round(c-h),f=Math.round(u-l);a.push([_,f])}n[i]=a,s=a}return n}function Is(n,t){if(t<=0)return;const i=n.length;if(i<3)return;const s=[];let r=0;s.push(0);for(let u=1;u<i;u++)r+=bs(n[u],n[u-1]),s.push(r);t=Math.min(t,.2*r);const a=[];a.push(n[0][0]),a.push(n[0][1]);const o=n[i-1][0],h=n[i-1][1],l=ke([0,0],n[0],n[1]);Be(l),n[0][0]+=t*l[0],n[0][1]+=t*l[1],ke(l,n[i-1],n[i-2]),Be(l),n[i-1][0]+=t*l[0],n[i-1][1]+=t*l[1];for(let u=1;u<i;u++)s[u]+=t;s[i-1]+=t;const c=.5*t;for(let u=1;u<i-1;u++){let _=0,f=0,m=0;for(let d=u-1;d>=0&&!(s[d+1]<s[u]-c);d--){const y=c+s[d+1]-s[u],p=s[d+1]-s[d],x=s[u]-s[d]<c?1:y/p;if(Math.abs(x)<1e-6)break;const v=x*x,b=x*y-.5*v*p,L=x*p/t,S=n[d+1],T=n[d][0]-S[0],z=n[d][1]-S[1];_+=L/b*(S[0]*x*y+.5*v*(y*T-p*S[0])-v*x*p*T/3),f+=L/b*(S[1]*x*y+.5*v*(y*z-p*S[1])-v*x*p*z/3),m+=L}for(let d=u+1;d<i&&!(s[d-1]>s[u]+c);d++){const y=c-s[d-1]+s[u],p=s[d]-s[d-1],x=s[d]-s[u]<c?1:y/p;if(Math.abs(x)<1e-6)break;const v=x*x,b=x*y-.5*v*p,L=x*p/t,S=n[d-1],T=n[d][0]-S[0],z=n[d][1]-S[1];_+=L/b*(S[0]*x*y+.5*v*(y*T-p*S[0])-v*x*p*T/3),f+=L/b*(S[1]*x*y+.5*v*(y*z-p*S[1])-v*x*p*z/3),m+=L}a.push(_/m),a.push(f/m)}a.push(o),a.push(h);for(let u=0,_=0;u<i;u++)n[u][0]=a[_++],n[u][1]=a[_++]}class ui{static getPlacement(t,e,i,s){const r=us(e);if(!r)return null;const a=fs(t);return r.execute(a,e,i,s)}}const zt=8,fi=n=>class extends n{constructor(...t){super(...t),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=P.TEXT,this._aux=F(0,0,this._referenceSize,this._bitset)}bindTextInfo(t,e){t&&t.length?this._shapingInfo=Li(t,i=>_s(i,e,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:Gi*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM})):this._shapingInfo=null}_write(t,e,i,s){const r=e.getDisplayId();this._writeGeometry(t,e,r,i,s)}_writeGeometry(t,e,i,s,r){const a=this._shapingInfo;if(V(a))return;if(E(this._textPlacement)){const h=r??e.readLegacyGeometryForDisplay();return this._writePlacedText(t,i,h,a,s)}const o=r?se(re(r),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!V(o)){if(o.isPoint){const[h,l]=o.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(h<0||h>=512||l<0||l>=512)?void 0:this._writeGlyphs(t,i,{x:h,y:l},a)}o.forEachVertex((h,l)=>this._writeGlyphs(t,i,{x:h,y:l},a))}}_writePlacedText(t,e,i,s,r){const a=ne(this._textPlacement),o=ui.getPlacement(i,a,g(1),r.geometryEngine);if(!o)return;let h=o.next();for(;h!=null;){const l=-h.getAngle();s.setRotation(l);const c=h.tx,u=-h.ty;c<0||c>=512||u<0||u>=512||(this._writeGlyphs(t,e,{x:c,y:u},s),s.setRotation(-l)),h=o.next()}}_writeGlyphs(t,e,i,s){const r=qt.load(this._materialKey),a=M(Math.round(zt*i.x),Math.round(zt*i.y)),o=this._vertexBoundsScale,h=s.bounds,l=2*Math.max(h.width,h.height);for(const c of s.glyphs)r.textureBinding=c.textureBinding,t.recordStart(e,r.data,this.geometryType,!0),t.vertexBounds(i.x+h.x+this._xOffset,i.y+h.y-this._yOffset,l*o,l*o),this._writeVertices(t,e,a,c),t.recordEnd()}_writeGlyph(t,e,i,s,r){const a=qt.load(this._materialKey),o=M(Math.round(zt*i),Math.round(zt*s));a.textureBinding=r.textureBinding,t.recordStart(e,a.data,this.geometryType,!0);const h=r.bounds,l=this._vertexBoundsScale;t.vertexBounds(i+h.x*l,s+h.y*l,h.width*l,h.height*l),this._writeVertices(t,e,o,r),t.recordEnd()}_writeVertices(t,e,i,s){const r=t.vertexCount();this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.upperLeft),t.vertexWrite(s.texcoords.upperLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.upperRight),t.vertexWrite(s.texcoords.upperRight),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.lowerLeft),t.vertexWrite(s.texcoords.lowerLeft),t.vertexEnd(),this._writeVertexCommon(t,e,i,s),t.vertexWrite(s.offsets.lowerRight),t.vertexWrite(s.texcoords.lowerRight),t.vertexEnd(),t.indexWrite(r+0),t.indexWrite(r+1),t.indexWrite(r+2),t.indexWrite(r+1),t.indexWrite(r+3),t.indexWrite(r+2)}_writeVertexCommon(t,e,i,s){const r=this._color,a=this._haloColor,o=F(0,0,this._referenceSize,this._bitset),h=F(0,0,this._size,this._haloSize);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(r),t.vertexWrite(a),t.vertexWrite(h),t.vertexWrite(o),t.vertexWrite(this._minMaxZoom)}};class wt{bindFeature(t,e,i){}write(t,e,i,s){if(V(this._effects)||this._effects?.length===0)return this._write(t,e,s);const r=Xt.executeEffects(this._effects,e.readLegacyGeometryForDisplay(),s.geometryEngine);let a=Xt.next(r);for(;a;)this._write(t,e,s,a),a=Xt.next(r)}_write(t,e,i,s){}}const $s=5;class _t extends fi(wt){constructor(t,e,i,s,r,a,o,h,l,c,u,_,f,m,d,y,p,x,v=!1,b,L){super(),this._xOffset=g(f),this._yOffset=g(m),this._decoration=c||"none",this._color=r,this._haloColor=a,this._haloSize=Math.min(Math.floor($s*g(Pi(i))),127),this._size=Math.min(Math.round(g(e)),127);const S=Math.min(Math.round(g(s||e)),127);this._referenceSize=Math.round(Math.sqrt(256*S)),this._scale=this._size/Je,this._angle=_,this._justify=rs(o||"center"),this._xAlignD=ri(o||"center"),this._yAlignD=ni(h||"baseline"),this._baseline=(h||"baseline")==="baseline",this._bitset=(l===B.MAP?1:0)|(u?1:0)<<1;const T=qt.load(t);T.sdf=!0,this._materialKey=T.data,this._lineWidth=g(d)||512,this._lineHeight=y||1,this._textPlacement=p,this._effects=x,this._isCIM=v,this._minMaxZoom=M(Math.round(b*C),Math.round(L*C))}static fromText(t,e){const i=new _t(t.materialKey,t.font.size,t.haloSize||0,t.font.size,t.color&&Y(t.color)||0,t.haloColor&&Y(t.haloColor)||0,t.horizontalAlignment,t.verticalAlignment,B.SCREEN,t.font.decoration,!1,t.angle||0,t.xoffset,t.yoffset,t.lineWidth,t.lineHeight,null,null,!1,G,K),[,s]=ze(t.text);return i.bindTextInfo(e,s),i._vertexBoundsScale=t.maxVVSize?t.maxVVSize/t.font.size:1,i}static fromCIMText(t,e,i){const s=t.scaleFactor||1,r=t.size*t.sizeRatio*s,[a,o]=J(t.scaleInfo,i),h=new _t(t.materialKey,r,t.outlineSize*t.sizeRatio,t.referenceSize,$(t.color),$(t.outlineColor),t.horizontalAlignment,t.verticalAlignment,t.alignment,t.decoration,t.colorLocked,t.angle,t.offsetX*t.sizeRatio*s,t.offsetY*t.sizeRatio*s,512,1,t.markerPlacement,t.effects,!0,a,o),[,l]=ze(t.text);return h.bindTextInfo(e,l),h._vertexBoundsScale=t.maxVVSize?t.maxVVSize/r:1,h}}const Ws=mt.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),Cs=(n,t="mapview-labeling")=>Ws.error(new rt(t,n)),It=1,ot=0,Es=4,Ve=25;function Rs(n,t){const e=!!n.minScale&&t.scaleToZoom(n.minScale)||0;return qe(e,0,25.5)}function As(n,t){const e=!!n.maxScale&&t.scaleToZoom(n.maxScale)||255;return qe(e,0,25.5)}function Fs(n){const t=new Map;return e=>(t.has(e)||t.set(e,n(e)),t.get(e))}const ks=Fs(n=>{let t=0;if(n===0)return 1/0;for(;!(n%2);)t++,n/=2;return t}),$t=n=>Math.floor(127*n+127),pt=n=>Math.floor(10*n),ht=n=>Math.round(n*(254/360));class Ft extends _t{constructor(t,e,i,s){super(t,i.font.size,i.haloSize||0,i.font.size,i.color&&Y(i.color)||0,i.haloColor&&Y(i.haloColor)||0,i.horizontalAlignment,i.verticalAlignment,ns(e.labelPlacement)?B.MAP:B.SCREEN,i.font.decoration,!1,i.angle||0,i.xoffset,i.yoffset,i.lineWidth,i.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=P.LABEL,this._allowOverrun=e.allowOverrun??!1,this._repeatLabel=e.repeatLabel??!0,this._labelPosition=e.labelPosition??"curved";const r=Rs(e,s),a=As(e,s),o=e.labelPlacement,[h,l]=as(o);this._xAlignD=h,this._yAlignD=l,this._minZoom=r,this._maxZoom=a,this._refPlacementPadding=g(i.haloSize)+Ki,this._repeatLabelDistance=e.repeatLabelDistance?g(e.repeatLabelDistance):128;const c=os.load(t);c.sdf=!0,this._materialKey=c.data}static fromLabelClass(t,e){if(t.labelPlacement==="esriServerLinePlacementCenterAlong"){const i=t.symbol;i.xoffset=0,i.yoffset=0,i.angle=0,i.font.decoration="none"}return new Ft(t.materialKey,t,t.symbol,e)}get _shapedBox(){return ne(this._shapingInfo).bounds}setZoomLevel(t){this._zoomLevel=t}bindReferenceTemplate(t){let e=hs(this._xAlignD),i=ls(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,V(t))return void(this._refSymbolAndPlacementOffset=F(0,0,$t(e),$t(i)));if(t.boundsType==="circle"&&(e||i)){const a=Math.sqrt(e*e+i*i);e/=a,i/=a}const s=Math.max(t.height,t.width),r=this._refPlacementPadding*Es;this._refSymbolAndPlacementOffset=F(r,s,$t(e),$t(i)),this._referenceSize=s,this._refPlacementDirX=e,this._refPlacementDirY=i,this._refOffsetX=t.xOffset,this._refOffsetY=t.yOffset}_write(t,e){if(V(this._shapingInfo))return;const i=this._shapingInfo,s=e.getDisplayId(),r=e.geometryType==="esriGeometryPolygon"?e.readLegacyCentroid():e.readLegacyGeometry();if(r)switch(this.current={out:t,inId:s,inShaping:i,zoomLevel:this._zoomLevel},e.geometryType){case"esriGeometryPolyline":this._placeLineLabels(r);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(r);break;default:Cs("mapview-labeling",`Geometry of type ${e.geometryType} is not supported`)}}_isVisible(t,e){const i=pt(this.current.zoomLevel);return pt(t)<=i&&i<=pt(e)}_placePointLabels(t){const{out:e,inId:i,inShaping:s}=this.current;this._writeGlyphs(e,i,t,s)}_placeLineLabels(t){const e=zs(t.paths,this.current.inShaping.bounds.width),i=this._placeSubdivGlyphs.bind(this),s=(this._shapedBox.width+this._repeatLabelDistance)/(1<<It);for(const r of e)Ts(r,s,i,this._repeatLabel)}_placeSubdivGlyphs(t,e,i,s){const r=ks(e),a=this._shapedBox.width/(1<<It),o=Math.sqrt(this._repeatLabelDistance)/(1<<It),h=Math.min(i,s-i),l=this.current.inShaping.isMultiline?Ve:Math.log2(h/(o+a/2)),c=e===0?l:Math.min(r,l),u=Math.max(this._minZoom,this.current.zoomLevel+It-c),_=this.current.zoomLevel-u,f=this._shapedBox.width/2*2**_;this.current.inShaping.isMultiline?e===0&&this._placeStraight(t,u):this._allowOverrun&&_<0?this._placeStraightAlong(t,this._minZoom):this._labelPosition==="parallel"?this._placeStraightAlong(t,u):this._labelPosition==="curved"&&this._placeCurved(t,u,f)}_placeStraight(t,e){const{out:i,inId:s,inShaping:r}=this.current,a=Math.ceil(t.angle*(180/Math.PI)%360),o=Math.ceil((t.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=ht(a),this._writeGlyphs(i,s,t,r,e),this._outLineLabelAngle=ht(o),this._writeGlyphs(i,s,t,r,e)}_placeCurved(t,e,i){const{out:s,inId:r}=this.current;s.metricStart(r,e,t.x,t.y,0,0,0,0);const a=t.clone(),o=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=ht(o),this._placeFirst(a,e,1),this._placeBack(t,a,e,i,1),this._placeForward(t,a,e,i,1),this._outLineLabelAngle=ht(h),this._placeFirst(a,e,0),this._placeBack(t,a,e,i,0),this._placeForward(t,a,e,i,0),s.metricEnd()}_placeStraightAlong(t,e){const{out:i,inId:s}=this.current;i.metricStart(s,e,t.x,t.y,0,0,0,0);const r=t.clone(),a=t.angle*(180/Math.PI)%360,o=(t.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=ht(a),this._placeFirst(r,e,1,!0),this._outLineLabelAngle=ht(o),this._placeFirst(r,e,0,!0),i.metricEnd()}_placeBack(t,e,i,s,r){const a=t.clone();let o=t.backwardLength+ot;for(;a.prev()&&!(o>=s);)this._placeOnSegment(a,e,o,i,-1,r),o+=a.length+ot}_placeForward(t,e,i,s,r){const a=t.clone();let o=t.remainingLength+ot;for(;a.next()&&!(o>=s);)this._placeOnSegment(a,e,o,i,1,r),o+=a.length+ot}_placeFirst(t,e,i,s=!1){const r=t,a=this.current.inShaping,o=a.glyphs,h=this.current.zoomLevel,{out:l,inId:c}=this.current;for(const u of o){const _=u.x>a.bounds.x?i:1-i,f=_*t.remainingLength+(1-_)*t.backwardLength,m=Math.abs(u.x+u.width/2-a.bounds.x),d=Math.max(0,h+Math.log2(m/(f+ot))),y=Math.max(e,s?0:d);if(u.maxZoom=Ve,u.angle=t.angle+(1-i)*Math.PI,u.minZoom=y,this._writeGlyph(l,c,r.x,r.y,u),i&&this._isVisible(u.minZoom,u.maxZoom)){const p=u.bounds;l.metricBoxWrite(p.center[0],p.center[1],p.width,p.height)}}}_placeOnSegment(t,e,i,s,r,a){const o=this.current.inShaping.glyphs,{out:h,inId:l}=this.current,c=this.current.inShaping,u=this.current.zoomLevel,_=t.dx/t.length,f=t.dy/t.length,m={x:t.x+i*-r*_,y:t.y+i*-r*f};for(const d of o){const y=d.x>c.bounds.x?a:1-a;if(!(y&&r===1||!y&&r===-1))continue;const p=Math.abs(d.x+d.width/2-c.bounds.x),x=Math.max(0,u+Math.log2(p/i)-.1),v=Math.max(s,u+Math.log2(p/(i+t.length+ot)));if(x!==0&&(d.angle=t.angle+(1-a)*Math.PI,d.minZoom=v,d.maxZoom=x,this._writeGlyph(h,l,m.x,m.y,d),a&&this._isVisible(d.minZoom,d.maxZoom))){const b=d.bounds,L=t.x-e.x,S=t.y-e.y;h.metricBoxWrite(b.center[0]+L,b.center[1]+S,b.width,b.height)}}}_writeGlyphs(t,e,i,s,r=this._minZoom){if(i.x<0||i.x>=512||i.y<0||i.y>=512)return;const a=i.x+this._refOffsetX,o=i.y-this._refOffsetY;for(const u of s.glyphs)u.minZoom=r,u.maxZoom=this._maxZoom,this._writeGlyph(t,e,a,o,u);const h=this._refPlacementDirX,l=this._refPlacementDirY,c=s.boundsT;t.metricStart(e,r,a,o,h,l,this._referenceSize,this._materialKey),t.metricBoxWrite(c.center[0],c.center[1],c.width,c.height),t.metricEnd()}_writeVertexCommon(t,e,i,s){const r=this._color,a=this._haloColor,o=F(0,0,this._size,this._haloSize),h=Math.max(s.minZoom,this._minZoom),l=Math.min(s.maxZoom,this._maxZoom),c=F(pt(h),pt(l),this._outLineLabelAngle,0);t.vertexWrite(i),t.vertexWrite(e),t.vertexWrite(r),t.vertexWrite(a),t.vertexWrite(o),t.vertexWrite(this._refSymbolAndPlacementOffset),t.vertexWrite(c)}}const Oe=3.14159265359/180,De=8,_i=n=>class extends n{constructor(...t){super(...t),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=P.MARKER}_write(t,e,i,s){const r=e.getDisplayId();t.recordStart(r,this._materialKey,this.geometryType,!0),this._writeGeometry(t,e,r,i,s),t.recordEnd()}_writeGeometry(t,e,i,s,r){if(E(this._markerPlacement))return this._writePlacedMarkers(t,e,s,r);if(!r&&e.geometryType==="esriGeometryPoint"){const o=e.getX(),h=e.getY();return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=513||h<0||h>=513)?void 0:this._writeVertices(t,i,this._getPos(o,h),o,h)}const a=r?se(re(r),2):e.geometryType==="esriGeometryPolygon"?e.readCentroid():e.readGeometryForDisplay();if(!V(a)){if(a.isPoint){const[o,h]=a.coords;return!t.hasAggregates&&t.hasPixelBufferEnabled&&(o<0||o>=512||h<0||h>=512)?void 0:this._writeVertices(t,i,this._getPos(o,h),o,h)}a.forEachVertex((o,h)=>{const l=2*st;o<-l||o>=l||h<-l||h>=l||this._writeVertices(t,i,this._getPos(o,h),o,h)})}}_writePlacedMarkers(t,e,i,s){const r=s??e.readLegacyGeometryForDisplay(),a=ui.getPlacement(r,ne(this._markerPlacement),g(1),i.geometryEngine);if(!a)return;const o=e.getDisplayId(),h=oe(),l=ae(),c=-128,u=640;let _=a.next();for(;_!=null;){const f=_.tx,m=-_.ty;f>=c&&f<=u&&m>=c&&m<=u&&(this._applyTransformation(l,h,-_.getAngle()/Oe),this._writeVertices(t,o,this._getPos(f,m),f,m)),_=a.next()}}_writeVertices(t,e,i,s,r){const a=le.load(this._materialKey);return a.symbologyType===Ot.HEATMAP?this._writeHeatmapVertices(t,e,i,s,r):this._writeMarkerVertices(t,e,a,i,s,r)}_writeMarkerVertices(t,e,i,s,r,a){const o=i.vvRotation,h=t.vertexCount();let l=this._computedWidth*this._vertexBoundsScaleX,c=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const u=Math.max(l,c);l=u,c=u}if(o){const u=Math.max(this.xOffset,this.yOffset);l+=u,c+=u}t.vertexBounds(r+this.xOffset,a-this.yOffset,l,c),t.vertexWrite(s),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(this._texUpperLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(this._texUpperRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(this._texBottomLeft),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),t.vertexWrite(s),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(this._texBottomRight),t.vertexWrite(this._bitestAndDistRatio),t.vertexWrite(e),t.vertexWrite(this._fillColor),t.vertexWrite(this._outlineColor),t.vertexWrite(this._sizeOutlineWidth),t.vertexWrite(this._minMaxZoom),t.vertexEnd(),this._writeIndices(t,h)}_writeHeatmapVertices(t,e,i,s,r){const a=t.vertexCount();t.vertexBounds(s+this.xOffset,r-this.yOffset,this.width,this.height),t.vertexWrite(i),t.vertexWrite(this._offsetUpperLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetUpperRight),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomLeft),t.vertexWrite(e),t.vertexEnd(),t.vertexWrite(i),t.vertexWrite(this._offsetBottomRight),t.vertexWrite(e),t.vertexEnd(),this._writeIndices(t,a)}_writeIndices(t,e){t.indexWrite(e+0),t.indexWrite(e+1),t.indexWrite(e+2),t.indexWrite(e+1),t.indexWrite(e+3),t.indexWrite(e+2)}_applyTransformation(t,e,i=0){Ti(t,zi(this.xOffset,-this.yOffset)),this.angle+i!==0&&Ii(t,t,Oe*(this.angle+i));const s=this._computedWidth,r=this._computedHeight,a=(this._anchorX-.5)*s,o=(this._anchorY-.5)*r;bt(e,a,o),St(e,e,t),this._offsetUpperLeft=M(16*e[0],16*e[1]),this._offsets.xUpperLeft=e[0],this._offsets.yUpperLeft=e[1],bt(e,a+s,o),St(e,e,t),this._offsetUpperRight=M(16*e[0],16*e[1]),this._offsets.xUpperRight=e[0],this._offsets.yUpperRight=e[1],bt(e,a,o+r),St(e,e,t),this._offsetBottomLeft=M(16*e[0],16*e[1]),this._offsets.xBottomLeft=e[0],this._offsets.yBottomLeft=e[1],bt(e,a+s,o+r),St(e,e,t),this._offsetBottomRight=M(16*e[0],16*e[1]),this._offsets.xBottomRight=e[0],this._offsets.yBottomRight=e[1]}_getPos(t,e){return M(Math.round(De*t),Math.round(De*e))}};class D extends _i(wt){constructor(t,e,i,s,r,a,o,h,l,c,u,_,f,m,d,y,p,x,v,b,L,S,T){super(),this.angle=s,this.height=o,this.width=a,this.xOffset=e*v,this.yOffset=i*v,this._markerPlacement=b,this._effects=L,this._anchorX=.5-(.5+y)*d.width/d.width,this._anchorY=.5-(.5+p)*d.height/d.height,this._minMaxZoom=M(Math.round(S*C),Math.round(T*C));const z=(m===B.MAP?Zi:Ni)|(u?it:0)|(f?Xi:0)|(_?Ui:0),N=d&&d.sdf,q=le.load(t);q.sdf=N,q.pattern=!0,q.textureBinding=d.textureBinding,this._materialKey=q.data,this._fillColor=r,this._outlineColor=l,this._sizeOutlineWidth=F(Math.round(Math.min(Math.sqrt(128*a),255)),Math.round(Math.min(Math.sqrt(128*o),255)),Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*h),255)));const j=d.rect.x+I,O=d.rect.y+I,nt=j+d.width,at=O+d.height;this._offsets.xUpperLeft=j,this._offsets.yUpperLeft=O,this._offsets.xUpperRight=nt,this._offsets.yUpperRight=O,this._offsets.xBottomLeft=j,this._offsets.yBottomLeft=at,this._offsets.xBottomRight=nt,this._offsets.yBottomRight=at,q.symbologyType===Ot.PIE_CHART?(this._texUpperLeft=M(0,1),this._texUpperRight=M(1,1),this._texBottomLeft=M(0,0),this._texBottomRight=M(1,0)):(this._texUpperLeft=M(j,O),this._texUpperRight=M(nt,O),this._texBottomLeft=M(j,at),this._texBottomRight=M(nt,at)),a*=x,o*=x,a*=v,o*=v;const vi=Math.round(64*x);this._bitestAndDistRatio=M(z,vi),this._computedWidth=a,this._computedHeight=o;const wi=oe(),bi=ae();this._applyTransformation(bi,wi)}static fromCIMMarker(t,e,i){const s=e&&e.width||1,r=e&&e.height||1,a=t.size,o=s/r*t.scaleX,h=t.scaleSymbolsProportionally&&t.frameHeight?a/t.frameHeight:1;let l=$(t.color);const c=$(t.outlineColor),u=g(a),_=u*o,f=g(t.offsetX||0),m=g(t.offsetY||0),d=g(t.outlineWidth||0)*h,y=t.alignment||B.SCREEN,p=g(t.referenceSize),[x,v]=J(t.scaleInfo,i);e.sdf||l!==0||(l=-1);let b=t.rotation||0;t.rotateClockwise||(b=-b);let L=0,S=0;const T=t.anchorPoint;T&&(t.isAbsoluteAnchorPoint?a&&(L=-T.x/(a*o),S=T.y/a):(L=T.x,S=T.y));const z=new D(t.materialKey,f,m,b,l,_,u,p,c,d,t.colorLocked,t.scaleSymbolsProportionally,!1,y,e,L,S,t.sizeRatio,Ct(t.scaleFactor,1),t.markerPlacement,t.effects,x,v);return z._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/_:1,z._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/u:1,z}static fromPictureMarker(t,e){const i=Math.round(g(t.width)),s=Math.round(g(t.height)),r=ti,a=Math.round(g(t.xoffset||0)),o=Math.round(g(t.yoffset||0)),h=new D(t.materialKey,a,o,t.angle,r,i,s,s,0,0,!1,!1,!1,B.SCREEN,e,0,0,1,1,null,null,G,K);return h._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.width:1,h._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.height:1,h}static fromSimpleMarker(t,e){const i=Y(t.color),s=Math.round(g(t.size)),r=s,a=Math.round(g(t.xoffset||0)),o=Math.round(g(t.yoffset||0)),h=t.style,l=t.outline,c=0|(l&&l.color&&Y(l.color)),u=0|(l&&l.width&&Math.round(g(l.width))),_=new D(t.materialKey,a,o,t.angle,i,s,r,r,c,u,!1,!1,h==="esriSMSCross"||h==="esriSMSX",B.SCREEN,e,0,0,126/64,1,null,null,G,K);return _.boundsType=h==="esriSMSCircle"?"circle":"square",_._vertexBoundsScaleX=t.maxVVSize?t.maxVVSize/t.size:1,_._vertexBoundsScaleY=t.maxVVSize?t.maxVVSize/t.size:1,_}static fromLineSymbolMarker(t,e){const i=Y(t.color),s=6,r=Math.round(g(s*t.lineWidth)),a=r,o=t.style==="cross"||t.style==="x";let h;switch(t.placement){case"begin-end":h=Lt.Both;break;case"begin":h=Lt.JustBegin;break;case"end":h=Lt.JustEnd;break;default:h=Lt.None}const l={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:h,offsetAlongLine:0},c=new D(t.materialKey,0,0,0,i,r,a,a/s,i,o?Math.round(g(t.lineWidth)):0,!1,!1,o,B.MAP,e,0,0,126/64,1,l,null,G,K);return c.boundsType=t.style==="circle"?"circle":"square",c}}function Bs(n,t,e,i,s,r,a){te=0;const o=(i-e)*r,h=s&&s.length,l=h?(s[0]-e)*r:o;let c,u,_,f,m,d=di(t,e,i,0,l,r,!0);if(d&&d.next!==d.prev){if(h&&(d=Gs(t,e,i,s,d,r)),o>80*r){c=_=t[0+e*r],u=f=t[1+e*r];for(let y=r;y<l;y+=r){const p=t[y+e*r],x=t[y+1+e*r];c=Math.min(c,p),u=Math.min(u,x),_=Math.max(_,p),f=Math.max(f,x)}m=Math.max(_-c,f-u),m=m!==0?1/m:0}gt(d,n,r,c,u,m,a,0)}}function di(n,t,e,i,s,r,a){let o;if(a===Us(n,t,e,i,s,r)>0)for(let h=i;h<s;h+=r)o=Ge(h+t*r,n[h+t*r],n[h+1+t*r],o);else for(let h=s-r;h>=i;h-=r)o=Ge(h+t*r,n[h+t*r],n[h+1+t*r],o);return o&&et(o,o.next)&&(Mt(o),o=o.next),o}function xt(n,t=n){if(!n)return n;let e,i=n;do if(e=!1,i.steiner||!et(i,i.next)&&W(i.prev,i,i.next)!==0)i=i.next;else{if(Mt(i),i=t=i.prev,i===i.next)break;e=!0}while(e||i!==t);return t}function gt(n,t,e,i,s,r,a,o){if(!n)return;!o&&r&&(n=mi(n,i,s,r));let h=n;for(;n.prev!==n.next;){const l=n.prev,c=n.next;if(r?Os(n,i,s,r):Vs(n))t.push(l.index/e+a),t.push(n.index/e+a),t.push(c.index/e+a),Mt(n),n=c.next,h=c.next;else if((n=c)===h){o?o===1?gt(n=Ys(n,t,e,a),t,e,i,s,r,a,2):o===2&&qs(n,t,e,i,s,r,a):gt(xt(n),t,e,i,s,r,a,1);break}}}function Vs(n){const t=n.prev,e=n,i=n.next;if(W(t,e,i)>=0)return!1;let s=n.next.next;const r=s;let a=0;for(;s!==n.prev&&(a===0||s!==r);){if(a++,ut(t.x,t.y,e.x,e.y,i.x,i.y,s.x,s.y)&&W(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function Os(n,t,e,i){const s=n.prev,r=n,a=n.next;if(W(s,r,a)>=0)return!1;const o=s.x<r.x?s.x<a.x?s.x:a.x:r.x<a.x?r.x:a.x,h=s.y<r.y?s.y<a.y?s.y:a.y:r.y<a.y?r.y:a.y,l=s.x>r.x?s.x>a.x?s.x:a.x:r.x>a.x?r.x:a.x,c=s.y>r.y?s.y>a.y?s.y:a.y:r.y>a.y?r.y:a.y,u=Qt(o,h,t,e,i),_=Qt(l,c,t,e,i);let f=n.prevZ,m=n.nextZ;for(;f&&f.z>=u&&m&&m.z<=_;){if(f!==n.prev&&f!==n.next&&ut(s.x,s.y,r.x,r.y,a.x,a.y,f.x,f.y)&&W(f.prev,f,f.next)>=0||(f=f.prevZ,m!==n.prev&&m!==n.next&&ut(s.x,s.y,r.x,r.y,a.x,a.y,m.x,m.y)&&W(m.prev,m,m.next)>=0))return!1;m=m.nextZ}for(;f&&f.z>=u;){if(f!==n.prev&&f!==n.next&&ut(s.x,s.y,r.x,r.y,a.x,a.y,f.x,f.y)&&W(f.prev,f,f.next)>=0)return!1;f=f.prevZ}for(;m&&m.z<=_;){if(m!==n.prev&&m!==n.next&&ut(s.x,s.y,r.x,r.y,a.x,a.y,m.x,m.y)&&W(m.prev,m,m.next)>=0)return!1;m=m.nextZ}return!0}function Ge(n,t,e,i){const s=dt.create(n,t,e);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function Mt(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function Ds(n){let t=n,e=n;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==n);return e}function Gs(n,t,e,i,s,r){const a=new Array;for(let o=0,h=i.length;o<h;o++){const l=di(n,t,e,i[o]*r,o<h-1?i[o+1]*r:e*r,r,!1);l===l.next&&(l.steiner=!0),a.push(Ds(l))}a.sort(Hs);for(const o of a)Ks(o,s),s=xt(s,s.next);return s}function Ks(n,t){if(t=Zs(n,t)){const e=yi(t,n);xt(e,e.next)}}function Zs(n,t){let e=t;const i=n.x,s=n.y;let r,a=-1/0;do{if(s<=e.y&&s>=e.next.y&&e.next.y!==e.y){const _=e.x+(s-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(_<=i&&_>a){if(a=_,_===i){if(s===e.y)return e;if(s===e.next.y)return e.next}r=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!r)return null;if(i===a)return r.prev;const o=r,h=r.x,l=r.y;let c,u=1/0;for(e=r.next;e!==o;)i>=e.x&&e.x>=h&&i!==e.x&&ut(s<l?i:a,s,h,l,s<l?a:i,s,e.x,e.y)&&(c=Math.abs(s-e.y)/(i-e.x),(c<u||c===u&&e.x>r.x)&&vt(e,n)&&(r=e,u=c)),e=e.next;return r}function mi(n,t,e,i){for(let s;s!==n;s=s.next){if(s=s||n,s.z===null&&(s.z=Qt(s.x,s.y,t,e,i)),s.prev.next!==s||s.next.prev!==s)return s.prev.next=s,s.next.prev=s,mi(n,t,e,i);s.prevZ=s.prev,s.nextZ=s.next}return n.prevZ.nextZ=null,n.prevZ=null,Ns(n)}function Ns(n){let t,e=1;for(;;){let i,s=n;n=null,t=null;let r=0;for(;s;){r++,i=s;let a=0;for(;a<e&&i;a++)i=i.nextZ;let o=e;for(;a>0||o>0&&i;){let h;a===0?(h=i,i=i.nextZ,o--):o!==0&&i?s.z<=i.z?(h=s,s=s.nextZ,a--):(h=i,i=i.nextZ,o--):(h=s,s=s.nextZ,a--),t?t.nextZ=h:n=h,h.prevZ=t,t=h}s=i}if(t.nextZ=null,e*=2,r<2)return n}}function W(n,t,e){return(t.y-n.y)*(e.x-t.x)-(t.x-n.x)*(e.y-t.y)}function pi(n,t,e,i){return!!(et(n,t)&&et(e,i)||et(n,i)&&et(e,t))||W(n,t,e)>0!=W(n,t,i)>0&&W(e,i,n)>0!=W(e,i,t)>0}function Xs(n,t){let e=n;do{if(e.index!==n.index&&e.next.index!==n.index&&e.index!==t.index&&e.next.index!==t.index&&pi(e,e.next,n,t))return!0;e=e.next}while(e!==n);return!1}function Us(n,t,e,i,s,r){let a=0;for(let o=i,h=s-r;o<s;o+=r)a+=(n[h+t*r]-n[o+t*r])*(n[o+1+t*r]+n[h+1+t*r]),h=o;return a}function ut(n,t,e,i,s,r,a,o){return(s-a)*(t-o)-(n-a)*(r-o)>=0&&(n-a)*(i-o)-(e-a)*(t-o)>=0&&(e-a)*(r-o)-(s-a)*(i-o)>=0}function vt(n,t){return W(n.prev,n,n.next)<0?W(n,t,n.next)>=0&&W(n,n.prev,t)>=0:W(n,t,n.prev)<0||W(n,n.next,t)<0}function Qt(n,t,e,i,s){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=32767*(n-e)*s)|n<<8))|n<<4))|n<<2))|n<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*s)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function et(n,t){return n.x===t.x&&n.y===t.y}function Hs(n,t){return n.x-t.x}function Ys(n,t,e,i){let s=n;do{const r=s.prev,a=s.next.next;!et(r,a)&&pi(r,s,s.next,a)&&vt(r,a)&&vt(a,r)&&(t.push(r.index/e+i),t.push(s.index/e+i),t.push(a.index/e+i),Mt(s),Mt(s.next),s=n=a),s=s.next}while(s!==n);return s}function qs(n,t,e,i,s,r,a){let o=n;do{let h=o.next.next;for(;h!==o.prev;){if(o.index!==h.index&&js(o,h)){let l=yi(o,h);return o=xt(o,o.next),l=xt(l,l.next),gt(o,t,e,i,s,r,a,0),void gt(l,t,e,i,s,r,a,0)}h=h.next}o=o.next}while(o!==n)}function js(n,t){return n.next.index!==t.index&&n.prev.index!==t.index&&!Xs(n,t)&&vt(n,t)&&vt(t,n)&&Qs(n,t)}function Qs(n,t){let e=n,i=!1;const s=(n.x+t.x)/2,r=(n.y+t.y)/2;do e.y>r!=e.next.y>r&&e.next.y!==e.y&&s<(e.next.x-e.x)*(r-e.y)/(e.next.y-e.y)+e.x&&(i=!i),e=e.next;while(e!==n);return i}function yi(n,t){const e=dt.create(n.index,n.x,n.y),i=dt.create(t.index,t.x,t.y),s=n.next,r=t.prev;return n.next=t,t.prev=n,e.next=s,s.prev=e,i.next=e,e.prev=i,r.next=i,i.prev=r,i}class dt{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const s=te<Jt.length?Jt[te++]:new dt;return s.index=t,s.x=e,s.y=i,s.prev=null,s.next=null,s.z=null,s.prevZ=null,s.nextZ=null,s.steiner=!1,s}}const Jt=new Array,Js=8096;let te=0;for(let n=0;n<Js;n++)Jt.push(new dt);const tr=1e-5,tt=new si(0,0,0,1,0),ee=new si(0,0,0,1,0);function Ke(n,t,e){let i=0;for(let s=1;s<e;s++){const r=n[2*(t+s-1)],a=n[2*(t+s-1)+1];i+=(n[2*(t+s)]-r)*(n[2*(t+s)+1]+a)}return i}function er(n,t,e,i,s){let r=0;const a=2;for(let o=e;o<i;o+=3){const h=(n[o]-s)*a,l=(n[o+1]-s)*a,c=(n[o+2]-s)*a;r+=Math.abs((t[h]-t[c])*(t[l+1]-t[h+1])-(t[h]-t[l])*(t[c+1]-t[h+1]))}return r}function ir(n,t){const{coords:e,lengths:i,hasIndeterminateRingOrder:s}=t,r=0,a=n;if(s)return!1;let o=0;for(let h=0;h<i.length;){let l=h,c=i[h],u=Ke(e,o,c);const _=[];for(;++l<i.length;){const y=i[l],p=Ke(e,o+c,y);if(!(p>0))break;u+=p,_.push(o+c),c+=y}const f=a.length;Bs(a,e,o,o+c,_,2,r);const m=er(a,e,f,a.length,r),d=Math.abs(u);if(Math.abs((m-d)/Math.max(1e-7,d))>tr)return a.length=0,!1;h=l,o+=c}return!0}function sr(n){const{coords:t,lengths:e}=n,{buffer:i}=es(t,e);return i}function rr(n,t,e){let i=0;for(let s=0;s<n.lengths.length;s++){const r=n.lengths[s];for(let a=0;a<r;a++){const o=n.coords[2*(a+i)],h=n.coords[2*(a+i)+1];if(o<t||o>e||h<t||h>e)return!0}i+=r}return!1}function nr(n,t){if(V(n))return null;if(!rr(n,-128,st+128))return n;tt.setPixelMargin(t),tt.reset(oi.Polygon);let e=0;for(let a=0;a<n.lengths.length;a++){const o=n.lengths[a];let h=n.coords[2*(0+e)],l=n.coords[2*(0+e)+1];tt.moveTo(h,l);for(let c=1;c<o;c++)h=n.coords[2*(c+e)],l=n.coords[2*(c+e)+1],tt.lineTo(h,l);tt.close(),e+=o}const i=tt.result(!1);if(!i)return null;const s=[],r=[];for(const a of i){let o=0;for(const h of a)r.push(h.x),r.push(h.y),o++;s.push(o)}return new $i(s,r)}function ar(n,t){ee.setPixelMargin(t);const e=ee,i=-t,s=st+t;let r=[],a=!1,o=0;for(;o<n.length;){const h=[],l=n[o];if(!l)return null;e.reset(oi.LineString);let[c,u]=l[0];if(a)e.moveTo(c,u);else{if(c<i||c>s||u<i||u>s){a=!0;continue}h.push({x:c,y:u})}let _=!1;const f=l.length;for(let m=1;m<f;++m)if(c+=l[m][0],u+=l[m][1],a)e.lineTo(c,u);else{if(c<i||c>s||u<i||u>s){_=!0;break}h.push({x:c,y:u})}if(_)a=!0;else{if(a){const m=e.resultWithStarts();if(m)for(const d of m)r.push(d)}else r.push({line:h,start:0});o++,a=!1}}return r=r.filter(h=>h.line.length>1),r.length===0?null:r}tt.setExtent(st),ee.setExtent(st);const kt=8,A=16,Ze=65535,xi=n=>class extends n{constructor(...t){super(...t),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=P.LINE}writeGeometry(t,e,i,s){this._writeGeometry(t,e,i,s)}_initializeTessellator(t){const e=Et.load(this._materialKey),i=ft.load(this._materialKey),s=this._tessellationOptions,r=e.vvSizeFieldStops||e.vvSizeMinMaxValue||e.vvSizeScaleStops||e.vvSizeUnitValue,a=this.tessellationProperties._halfWidth<Hi&&!t&&!r;this.tessellationProperties.minMaxZoom=this._minMaxZoom,s.wrapDistance=Ze,s.textured=this._isDashed||this._hasPattern,s.offset=this.tessellationProperties.offset,s.halfWidth=this.tessellationProperties._halfWidth;const o=a?0:1,h=Rt(i)?hr:or;this._lineTessellator=new is(h(this.tessellationProperties,o,o),lr(this.tessellationProperties),a)}_write(t,e,i,s){const r=e.geometryType==="esriGeometryPoint";t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,r),this._writeGeometry(t,e,s,r),t.recordEnd()}_writeGeometry(t,e,i,s){const r=i??e.readLegacyGeometryForDisplay(),a=this._getLines(r,s);V(a)||this._writeVertices(t,e,a)}_getLines(t,e){if(V(t))return null;const i=t.paths||t.rings;return V(i)?null:ar(i,e?256:16)}_writeVertices(t,e,i){const s=e.getDisplayId(),r=t.vertexCount(),a=this.tessellationProperties,o=this._tessellationOptions;a.out=t,a.id=s,a.indexCount=0,a.vertexCount=0,a.offset=r,o.capType=this._capType,o.joinType=this._joinType;const h=ft.load(this._materialKey);this.tessellationProperties.key=Rt(h)?h:Et.load(this._materialKey);for(const{line:l,start:c}of i)o.initialDistance=c%Ze,this._lineTessellator.tessellate(l,o)}},or=(n,t,e)=>(i,s,r,a,o,h,l,c,u,_,f)=>{const m=M(f,Math.ceil(A*n._halfWidth)),d=F(Math.round(A*l),Math.round(A*c),Math.round(A*u),Math.round(A*_)),y=F(A*o,A*h,0,n._bitset),p=n.out;return p.vertexBounds(i,s,t,e),p.vertexWrite(M(kt*i,kt*s)),p.vertexWrite(n.id),p.vertexWrite(n._fillColor),p.vertexWrite(d),p.vertexWrite(m),p.vertexWrite(n._tl),p.vertexWrite(n._br),p.vertexWrite(y),p.vertexWrite(M(Math.ceil(A*n._halfReferenceWidth),0)),p.vertexWrite(n.minMaxZoom),p.vertexEnd(),n.offset+n.vertexCount++},hr=(n,t,e)=>(i,s,r,a,o,h,l,c,u,_,f)=>{const m=M(A*n._halfWidth,A*n._halfReferenceWidth),d=F(A*l+128,A*c+128,A*u+128,A*_+128),y=n.out,p=n._bitset<<24|n.id;y.vertexBounds(i,s,t,e),y.vertexWrite(M(kt*i,kt*s)),y.vertexWrite(p),y.vertexWrite(n._fillColor);const x=ai(n.key);return x||(y.vertexWrite(0),y.vertexWrite(0)),y.vertexWrite(0),y.vertexWrite(m),y.vertexWrite(d),x||y.vertexWrite(n.minMaxZoom),y.vertexEnd(),n.offset+n.vertexCount++},lr=n=>(t,e,i)=>{const s=n.out;s.indexWrite(t),s.indexWrite(e),s.indexWrite(i),n.indexCount+=3},cr=mt.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class U extends xi(wt){constructor(t,e,i,s,r,a,o,h,l,c,u,_,f,m,d,y,p,x,v,b){super();const L=Et.load(t);e&&(L.sdf=e.sdf,L.pattern=!0,L.textureBinding=e.textureBinding),this._capType=s,this._joinType=r,this._miterLimitCosine=jt(a),this.tessellationProperties._fillColor=o,this.tessellationProperties._tl=h,this.tessellationProperties._br=l,this._hasPattern=c,this._isDashed=u,this._zOrder=p,this._effects=x,this._minMaxZoom=M(Math.round(v*C),Math.round(b*C)),this._materialKey=L.data;const S=(f?it:0)|(m?Yi:0)|(_?ei:0)|(d?Vt:0);this.tessellationProperties._bitset=S,this.tessellationProperties._halfWidth=.5*i,this.tessellationProperties._halfReferenceWidth=.5*y,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(t,e,i){const s=t.color,r=t.scaleFactor||1,a=!!t.dashTemplate;let o=t.cap;a&&o===Te.ROUND&&(o=Te.SQUARE);const h=t.join,l=g(t.width)*r,c=g(t.referenceWidth),u=g(t.miterLimit),_=s&&$(s)||0,[f,m]=J(t.scaleInfo,i),d=!1;if(!e)return new U(t.materialKey,e,l,o,h,u,_,0,0,!1,a,t.scaleDash,t.colorLocked,d,t.sampleAlphaOnly,c,t.zOrder,t.effects,f,m);const{rect:y,width:p,height:x}=e,v=y.x+I,b=y.y+I,L=v+p,S=b+x,T=M(v,b),z=M(L,S),N=!1;return new U(t.materialKey,e,l,o,h,u,_,T,z,!0,a,t.scaleDash,t.colorLocked,N,t.sampleAlphaOnly,c,t.zOrder,t.effects,f,m)}static fromFillOutline(t){const e=ft.load(t.materialKey);return Rt(e)&&t.outline&&t.outline?.style==="esriSLSSolid"?U.fromSimpleLine({hash:"",materialKey:t.materialKey,...t.outline},null,!0):null}static fromSimpleLine(t,e,i=!1){const{color:s}=t,r=t.style!=="esriSLSSolid"&&t.style!=="esriSLSNull",a=Qi(t.cap||"round"),o=Ji(t.join||"round");let h=s&&t.style!=="esriSLSNull"&&Y(s)||0;t.style==="esriSLSNull"&&(h=0);const l=g(t.width),c=t.miterLimit;if(!e)return new U(t.materialKey,e,l,a,o,c,h,0,0,!1,r,!0,!1,i,!1,l,0,null,G,K);const{rect:u,width:_,height:f}=e,m=u.x+I,d=u.y+I,y=m+_,p=d+f,x=M(m,d),v=M(y,p);return new U(t.materialKey,e,l,a,o,c,h,x,v,!0,r,!0,!1,i,!1,l,0,null,G,K)}static fromPictureLineSymbol(t,e,i,s){return cr.error("PictureLineSymbol support does not exist!"),null}}const ur=100,Ne=1,gi=n=>class extends n{constructor(...t){super(...t),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=P.FILL}_maybeAddLineTemplate(t){this._lineTemplate=U.fromFillOutline(t)}_write(t,e,i,s){const r=e.geometryType==="esriGeometryPoint",a=ft.load(this._materialKey);t.recordStart(e.getDisplayId(),this._materialKey,this.geometryType,r),this._writeGeometry(t,e,a,s,r),Rt(a)&&E(this._lineTemplate)&&this._lineTemplate.writeGeometry(t,e,s,r),t.recordEnd()}_writeGeometry(t,e,i,s,r){const a=this._getGeometry(e,s,r);if(V(a))return;const o=[];if(!(a.maxLength>ur)&&!this.forceLibtess&&ir(o,a))return void(o.length&&this._writeVertices(t,e,a.coords,a.lengths,i,o));const h=sr(a);this._writeVertices(t,e,h,[h.length/2],i)}_writeVertex(t,e,i,s,r,a){const o=M(Ne*s,Ne*r);if(t.vertexBounds(s,r,0,0),t.vertexWrite(o),t.vertexWrite(e),i.symbologyType===Ot.DOT_DENSITY)t.vertexWriteF32(1/Math.abs(a.readGeometryArea()));else{t.vertexWrite(this.fillColor);const h=ai(i);h||(t.vertexWrite(this.tl),t.vertexWrite(this.br)),t.vertexWrite(this.aux2_1),t.vertexWrite(this.aux2_2),t.vertexWrite(this.aux3),h||t.vertexWrite(this._minMaxZoom)}}_writeVertices(t,e,i,s,r,a){const o=e.getDisplayId(),h=this._bitset<<24|o,l=s.reduce((f,m)=>f+m),c=Yt(r.geometryType,r.symbologyType).geometry/4,u=t.vertexCount();t.vertexEnsureSize(c*l);let _=0;if(a)for(const f of a){const m=i[2*f],d=i[2*f+1];this._writeVertex(t,h,r,m,d,e),_++}else for(let f=0;f<i.length;f+=2){const m=Math.round(i[f]),d=Math.round(i[f+1]);this._writeVertex(t,h,r,m,d,e),_++}t.indexEnsureSize(_);for(let f=0;f<_;f++)t.indexWrite(f+u)}_getGeometry(t,e,i){const s=e?se(re(e),2):t.readGeometryForDisplay();return s?nr(s,i?256:8):null}},Xe=mt.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class Nt extends wt{constructor(t){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=t}analyze(t,e,i,s,r){if(r&&r.length===0)return null;const a=r&&r.length>0,o=e.readLegacyFeature(),h=e.getObjectId(),l=this._materialCache,c=this._cimLayer.materialHash;if(!c)return Xe.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const u=typeof c=="function"?c(o,i,s,h):c;if(l.has(u)){const v=l.get(u);return Promise.resolve(v)}const _=this._ongoingMaterialRequestMap.get(u);if(_)return _;const f=this._cimLayer,m=ds(f.cim,this._cimLayer.materialOverrides);m.mosaicHash=u;const{type:d,url:y}=f,p={cim:m,type:d,mosaicHash:u,url:y,size:null,dashTemplate:null,text:null,fontName:null,objectId:h,animatedSymbolProperties:null};switch(d){case"marker":p.size=Pt(f.size,o,i,s),p.animatedSymbolProperties=Pt(f.animatedSymbolProperties,o,i,s);break;case"line":p.dashTemplate=f.dashTemplate;break;case"text":p.text=Pt(f.text,o,i,s),p.fontName=Pt(f.fontName,o,i,s)}const x=t.getMosaicItem(p,r).then(v=>(a||(this._ongoingMaterialRequestMap.delete(u),l.set(u,v)),v)).catch(v=>(this._ongoingMaterialRequestMap.delete(u),Xe.error(".analyze()",v.message),null));return a||this._ongoingMaterialRequestMap.set(u,x),x}}class me extends gi(Nt){constructor(t,e,i){if(super(t),this._minMaxZoom=M(Math.round(e*C),Math.round(i*C)),w(t.color)){const c=(u,_,f)=>{const m=t.color(u,_,f);return m&&$(m)||0};this._dynamicPropertyMap.set("fillColor",c)}else{const c=t.color;this.fillColor=c&&$(c)||0}const s=t.cim.placement?.type==="CIMMarkerPlacementInsidePolygon"&&t.cim.placement.shiftOddRows?2:1,r=t.height;if(w(r)){const c=(u,_,f)=>r(u,_,f)*s;this._dynamicPropertyMap.set("_height",c)}else this._height=(r||0)*s;const a=t.offsetX;if(w(a)){const c=(u,_,f)=>g(a(u,_,f));this._dynamicPropertyMap.set("_offsetX",c)}else this._offsetX=g(a||0);const o=t.offsetY;if(w(o)){const c=(u,_,f)=>g(-o(u,_,f));this._dynamicPropertyMap.set("_offsetY",c)}else this._offsetY=g(-o||0);const h=t.scaleX;w(h)?this._dynamicPropertyMap.set("_scaleX",h):this._scaleX=h||1;const l=t.angle;if(w(l)){const c=(u,_,f)=>Ie(l(u,_,f));this._dynamicPropertyMap.set("_angle",c)}else this._angle=Ie(l)||0;if(E(t.effects)){const c=t.effects;w(c)?this._dynamicPropertyMap.set("_effects",c):this._effects=c}this._cimFillLayer=t,this._bitset=(t.colorLocked?it:0)|(t.applyRandomOffset?ii:0)|(t.sampleAlphaOnly?Vt:0),this._fillMaterialKey=ft.load(t.materialKey)}static fromCIMFill(t,e){const[i,s]=J(t.scaleInfo,e);return new me(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(s,e,i)});const r=this._fillMaterialKey,a=this._materialCache,o=(0,this._cimFillLayer.materialHash)(s,e,i),h=a.get(o);let l=null;if(h&&k(h.spriteMosaicItem)&&(l=h.spriteMosaicItem),l){const{rect:c,width:u,height:_}=l,f=c.x+I,m=c.y+I,d=f+u,y=m+_;let p=Math.round(g(this._height));p<=0&&(p=y-m);let x=Math.round(g(this._height/_*u||0));x<=0&&(x=d-f);const v=this._scaleX,b=1;this.tl=M(f,m),this.br=M(d,y),this.aux2_1=M(x,p),this.aux2_2=M(this._offsetX,this._offsetY),this.aux3=F(v,b,this._angle,0),r.sdf=l.sdf,r.pattern=!0,r.textureBinding=l.textureBinding}else this.tl=0,this.br=0,this.aux2_1=0,this.aux2_2=0,this.aux3=0,r.sdf=!1,r.pattern=!1,r.textureBinding=0;this._materialKey=r.data}}class pe extends xi(Nt){constructor(t,e,i){super(t),this._minMaxZoom=M(Math.round(e*C),Math.round(i*C)),this._cimLineLayer=t;let s=0;w(t.width)||(s=.5*g(t.width));const r=(u,_,f)=>w(t.width)?.5*g(t.width(u,_,f)):s;this._dynamicPropertyMap.set("_halfWidth",r),w(t.cap)?this._dynamicPropertyMap.set("_capType",t.cap):this._capType=t.cap,w(t.join)?this._dynamicPropertyMap.set("_joinType",t.join):this._joinType=t.join;const a=t.color;if(w(a)){const u=(_,f,m)=>$(a(_,f,m));this._dynamicPropertyMap.set("_fillColor",u)}else this._fillColor=a&&$(a)||0;const o=t.miterLimit;if(w(o)){const u=(_,f,m)=>jt(o(_,f,m));this._dynamicPropertyMap.set("_miterLimitCosine",u)}else this._miterLimitCosine=jt(o);if(E(t.effects)){const u=t.effects;w(u)?this._dynamicPropertyMap.set("_effects",u):this._effects=u}this._scaleFactor=t.scaleFactor||1,this._isDashed=t.dashTemplate!=null;const h=t.colorLocked?it:0,l=t.scaleDash?ei:0,c=t.sampleAlphaOnly?Vt:0;this.tessellationProperties._bitset=h|l|c,this._materialKey=t.materialKey,this._initializeTessellator(!0)}static fromCIMLine(t,e){const[i,s]=J(t.scaleInfo,e);return new pe(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature();this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(s,e,i)}),this._halfWidth*=this._scaleFactor;const r=this._materialCache,a=(0,this._cimLineLayer.materialHash)(s,e,i),o=r.get(a);let h=null;if(o&&k(o.spriteMosaicItem)&&(h=o.spriteMosaicItem),h){this._hasPattern=!0;const{rect:c,width:u,height:_}=h,f=c.x+I,m=c.y+I,d=f+u,y=m+_;this.tessellationProperties._tl=M(f,m),this.tessellationProperties._br=M(d,y)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const l=Et.load(this._materialKey);h&&(l.sdf=h.sdf,l.pattern=!0,l.textureBinding=h.textureBinding),this._materialKey=l.data}}const fr=oe(),_r=ae(),dr=mt.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class ye extends _i(Nt){constructor(t,e,i){super(t),this._cimMarkerLayer=t,this._minMaxZoom=M(Math.round(e*C),Math.round(i*C));const s=t.color;if(w(s)){const _=(f,m,d)=>$(s(f,m,d));this._dynamicPropertyMap.set("_fillColor",_)}else this._fillColor=$(s);const r=t.outlineColor;if(w(r)){const _=(f,m,d)=>$(r(f,m,d));this._dynamicPropertyMap.set("_outlineColor",_)}else this._outlineColor=$(r);const a=t.size;if(w(a)){const _=(f,m,d)=>g(a(f,m,d));this._dynamicPropertyMap.set("_size",_)}else this._size=g(a)||0;const o=t.scaleX;w(o)?this._dynamicPropertyMap.set("_scaleX",o):this._scaleX=o||1;const h=t.offsetX;if(w(h)){const _=(f,m,d)=>g(h(f,m,d));this._dynamicPropertyMap.set("xOffset",_)}else this.xOffset=g(h)||0;const l=t.offsetY;if(w(l)){const _=(f,m,d)=>g(l(f,m,d));this._dynamicPropertyMap.set("yOffset",_)}else this.yOffset=g(l)||0;const c=t.outlineWidth;if(w(c)){const _=(f,m,d)=>g(c(f,m,d));this._dynamicPropertyMap.set("_outlineWidth",_)}else this._outlineWidth=g(c)||0;const u=t.rotation;if(w(u)?this._dynamicPropertyMap.set("_angle",u):this._angle=u||0,E(t.effects)){const _=t.effects;w(_)?this._dynamicPropertyMap.set("_effects",_):this._effects=_}if(E(t.markerPlacement)){const _=t.markerPlacement;w(_)?this._dynamicPropertyMap.set("_markerPlacement",_):this._markerPlacement=_}this._scaleFactor=Ct(t.scaleFactor,1),this._bitSet=(t.alignment===B.MAP?1:0)|(t.colorLocked?1:0)<<1|(t.scaleSymbolsProportionally?1:0)<<3,this._materialKey=t.materialKey}static fromCIMMarker(t,e){const[i,s]=J(t.scaleInfo,e);return new ye(t,i,s)}bindFeature(t,e,i){const s=t.readLegacyFeature(),r=t.getObjectId();this._dynamicPropertyMap.forEach((nt,at)=>{this[at]=nt(s,e,i)});const a=this._cimMarkerLayer.materialHash,o=typeof a=="function"?a(s,e,i,r):a,h=this._materialCache.get(o);if(!h||!k(h.spriteMosaicItem)||!h.spriteMosaicItem)return void dr.error(new rt("mapview-cim","Encountered an error when binding feature"));const l=h.spriteMosaicItem,c=this._cimMarkerLayer.sizeRatio,u=l.width/l.height*this._scaleX,_=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let f=this._size,m=f*u;const d=this.xOffset,y=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const p=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/g(this._cimMarkerLayer.frameHeight):1,x=this._outlineWidth*p,v=g(this._cimMarkerLayer.referenceSize);let b=0,L=0;const S=this._cimMarkerLayer.anchorPoint;S&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(b=-S.x/(this._size*u),L=S.y/this._size):(b=S.x,L=S.y)),this._sizeOutlineWidth=F(Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*f),255)),Math.round(Math.min(Math.sqrt(128*x),255)),Math.round(Math.min(Math.sqrt(128*v),255))),this.angle=_;const T=Math.round(64*c);this._bitestAndDistRatio=M(this._bitSet,T);const z=l.rect.x+I,N=l.rect.y+I,q=z+l.width,j=N+l.height;this._texUpperLeft=M(z,N),this._texUpperRight=M(q,N),this._texBottomLeft=M(z,j),this._texBottomRight=M(q,j);const O=le.load(this._materialKey);O.sdf=l.sdf,O.pattern=!0,O.textureBinding=l.textureBinding,this._materialKey=O.data,this._anchorX=.5-(.5+b)*l.width/l.width,this._anchorY=.5-(.5+L)*l.height/l.height,m*=c,f*=c,m*=this._scaleFactor,f*=this._scaleFactor,m*=l.rect.width/l.width,f*=l.rect.height/l.height,this._computedWidth=m,this._computedHeight=f,this._applyTransformation(_r,fr),this.xOffset=d,this.yOffset=y}}function Mi(n){const t=new Array(n.length);for(let e=0;e<n.length;e++)t[e]=n.charCodeAt(e);return t}const Ue=5;function mr(n,t,e,i){return typeof n.text=="string"?n.text:typeof n.text=="function"?n.text(t,e,i):""}class xe extends fi(Nt){constructor(t,e,i){super(t),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=M(Math.round(e*C),Math.round(i*C));const s=t.scaleFactor||1;this._cimTextLayer=t;const r=t.color;if(w(r)){const d=(y,p,x)=>$(r(y,p,x));this._dynamicPropertyMap.set("_color",d)}else this._color=$(r);const a=t.outlineColor;if(w(a)){const d=(y,p,x)=>$(a(y,p,x));this._dynamicPropertyMap.set("_haloColor",d)}else this._haloColor=$(a);let o;w(t.size)||(o=Math.min(Math.round(g(t.size*t.sizeRatio)),127));const h=(d,y,p)=>w(t.size)?Math.min(Math.round(g(t.size(d,y,p)*t.sizeRatio)),127):o;if(this._dynamicPropertyMap.set("_size",h),w(t.outlineSize)){const d=(y,p,x)=>Math.min(Math.floor(Ue*g(t.outlineSize(y,p,x)*t.sizeRatio)),127);this._dynamicPropertyMap.set("_haloSize",d)}else this._haloSize=Math.min(Math.floor(Ue*g(t.outlineSize*t.sizeRatio)),127);let l;w(t.offsetX)||(l=Math.round(g(t.offsetX*t.sizeRatio)));const c=(d,y,p)=>w(t.offsetX)?Math.round(g(t.offsetX(d,y,p)*t.sizeRatio)):l;let u;this._dynamicPropertyMap.set("_xOffset",c),w(t.offsetY)||(u=Math.round(g(t.offsetY*t.sizeRatio)));const _=(d,y,p)=>w(t.offsetY)?Math.round(g(t.offsetY(d,y,p)*t.sizeRatio)):u;if(this._dynamicPropertyMap.set("_yOffset",_),w(t.angle)?this._dynamicPropertyMap.set("_angle",t.angle):this._angle=t.angle,w(t.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",t.horizontalAlignment):this._horizontalAlignment=t.horizontalAlignment,w(t.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",t.verticalAlignment):this._verticalAlignment=t.verticalAlignment,E(t.effects)){const d=t.effects;w(d)?this._dynamicPropertyMap.set("_effects",d):this._effects=d}if(E(t.markerPlacement)){const d=t.markerPlacement;w(d)?this._dynamicPropertyMap.set("_markerPlacement",d):this._textPlacement=d}w(t.text)?this._dynamicPropertyMap.set("_text",t.text):this._text=t.text,this._scaleFactor=s;const f=Math.min(Math.round(g(t.referenceSize*t.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*f)),this._materialKey=t.materialKey;const m=cs.load(this._materialKey);m.sdf=!0,this._bitset=(t.alignment===B.MAP?1:0)|(t.colorLocked?1:0)<<1,this._materialKey=m.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(t,e){const[i,s]=J(t.scaleInfo,e);return new xe(t,i,s)}async analyze(t,e,i,s){const r=e.readLegacyFeature(),a=mr(this._cimTextLayer,r,i,s),o=await super.analyze(t,e,i,s,Mi(a));return o&&o.glyphMosaicItems&&this._textToGlyphs.set(a,o.glyphMosaicItems),o}bindFeature(t,e,i){const s=t.readLegacyFeature();if(this._dynamicPropertyMap.forEach((a,o)=>{this[o]=a(s,e,i)}),!this._text||this._text.length===0)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/Je,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=ri(Ct(this._horizontalAlignment,"center")),this._yAlignD=ni(Ct(this._verticalAlignment,"baseline"));const r=this._textToGlyphs.get(this._text);this.bindTextInfo(r,!1)}}const lt=128;class H extends gi(wt){constructor(t,e,i,s,r,a,o,h,l,c,u,_,f,m,d,y){super(),this._effects=m;const p=ft.load(t);e&&(p.sdf=e.sdf,p.pattern=!0,p.textureBinding=e.textureBinding),this.fillColor=i,this.tl=s,this.br=r,this.aux2_1=M(a,o),this.aux2_2=M(h,l),this.aux3=F(c,u,_,0),this._bitset=f,this._minMaxZoom=M(Math.round(d*C),Math.round(y*C)),this._materialKey=p.data}static fromCIMFill(t,e,i){const s=t.color,r=s&&$(s)||0,a=t.materialKey,[o,h]=J(t.scaleInfo,i),l=(t.colorLocked?it:0)|(t.applyRandomOffset?ii:0)|(t.sampleAlphaOnly?Vt:0);if(!e)return new H(a,null,r,0,0,0,0,0,0,0,0,0,l,t.effects,o,h);const{rect:c,width:u,height:_}=e,f=t.scaleX||1,m=c.x+I,d=c.y+I,y=m+u,p=d+_,x=t.height,v=f*x;let b=Math.round(x);b<=0&&(b=p-d);let L=Math.round(v);L<=0&&(L=y-m);const S=g(t.offsetX||0),T=g(-t.offsetY||0),z=M(m,d),N=M(y,p);return new H(a,e,r,z,N,L,b,S,T,lt,lt,xs(t.angle),l,t.effects,o,h)}static fromSimpleFill(t,e,i=!1){const{color:s}=t,r=s&&t.style!=="esriSFSNull"&&Y(s)||0,a=i?it:0,o=t.materialKey;let h;if(e){const{rect:l,width:c,height:u}=e,_=l.x+I,f=l.y+I,m=_+c,d=f+u,y=M(_,f),p=M(m,d);h=new H(o,e,r,y,p,c,u,0,0,lt,lt,0,a,null,G,K)}else h=new H(o,null,r,0,0,0,0,0,0,0,0,0,a,null,G,K);return h._maybeAddLineTemplate(t),h}static fromPictureFill(t,e,i=!1){const s=ti,{rect:r,width:a,height:o}=e,h=r.x+I,l=r.y+I,c=h+a,u=l+o,_=M(h,l),f=M(c,u),m=Math.round(g(t.width)),d=Math.round(g(t.height)),y=g(t.xoffset),p=g(-t.yoffset),x=t.materialKey,v=i?it:0,b=new H(x,e,s,_,f,m,d,y,p,lt*t.xscale,lt*t.yscale,0,v,null,G,K);return b._maybeAddLineTemplate(t),b}}class pr{constructor(){this._resolver=null}isHeld(){return!!this._resolver}async acquire(){this._resolver?(await this._resolver.promise,await this.acquire()):this._resolver=Wi()}release(){const t=this._resolver;this._resolver=null,t.resolve()}}async function yr(n,t,e){try{await n.acquire(),await t(e),n.release()}catch(i){throw n.release(),i}}async function xr(n,t,e){if(!n.name)throw new rt("style-symbol-reference-name-missing","Missing name in style symbol reference");if(n.styleName&&n.styleName==="Esri2DPointSymbolsStyle")return gr(n,e);try{return Mr(await Ci(n,t,e),n.name,t,e)}catch(i){return he(i),null}}async function gr(n,t){const e=Ei.replace(/\{SymbolName\}/gi,n.name);try{const i=await je(e,t);return Qe(i.data)}catch(i){return he(i),null}}async function Mr(n,t,e,i){const s=n.data,r={portal:e&&E(e.portal)?e.portal:Ri.getDefault(),url:Ai(n.baseUrl),origin:"portal-item"},a=s.items.find(h=>h.name===t);if(!a)throw new rt("symbolstyleutils:symbol-name-not-found",`The symbol name '${t}' could not be found`,{symbolName:t});let o=Fi(ki(a,"cimRef"),r);gs()&&(o=Ms(o));try{const h=await je(o,i);return Qe(h.data)}catch(h){return he(h),null}}const He=async(n,t,e)=>new ms(await ps(n.data,t,e),n.data,n.rendererKey,n.maxVVSize),Z=async(n,t,e,i)=>{if(!n)return null;if(n.type==="cim")return He(n,t,e);if(n.type==="web-style"){const s={type:"cim",data:await xr(n,null,i),rendererKey:n.rendererKey,maxVVSize:n.maxVVSize};return He(s,t,e)}return n};function Wt(n){if(!n)return null;const{type:t,cim:e,url:i,materialHash:s}=n,r={cim:e,type:t,mosaicHash:s,url:i,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null};switch(t){case"marker":r.size=n.size,r.path=n.path,r.animatedSymbolProperties=n.animatedSymbolProperties;break;case"line":r.dashTemplate=n.dashTemplate;break;case"text":r.text=n.text,r.fontName=n.fontName}return r}const R=mt.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),Ye=new Array,ge={isOutline:!1,placement:null,symbologyType:Ot.DEFAULT,vvFlags:0},vr={...be,hash:JSON.stringify(be),materialKey:ce(P.MARKER,ge)},wr={...Se,hash:JSON.stringify(Se),materialKey:ce(P.LINE,ge)},br={...Le,hash:JSON.stringify(Le),materialKey:ce(P.FILL,ge)};function X(n,t){const e=n.length;return n.push(null),t.then(i=>n[e]=i),n}function yt(n){return!!(1&n)}function Sr(n){return n.name==="worker:port-closed"}class Zr{constructor(t,e){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new pr,this._fetchResource=t,this._tileInfo=e}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(t,e){this._initErrorTemplates();const i=t.hash;if(this._symbolToTemplate.has(i))return this._symbolToTemplate.get(i);const s=new Array;e&&this._createMeshTemplates(s,e,!0),this._createMeshTemplates(s,t,!1);const r=this._createGroupId(t.type==="expanded-cim"&&Lr(t));return this._idToTemplateGroup.set(r,s),this._symbolToTemplate.set(i,r),r}getTemplateGroup(t){return this._idToTemplateGroup.has(t)?this._idToTemplateGroup.get(t):Ye}getDynamicTemplateGroup(t){return this._idToTemplateGroup.has(t)?(yt(t)||R.error("mapview-template-store",`Id ${t} does not refer to a dynamic template`),this._idToTemplateGroup.get(t)):Ye}getMosaicItem(t,e){const i=this._createTemplateId(),s=new Promise(r=>this._idToResolver.set(i,r));return this._fetchQueue.push({symbol:t,id:i,glyphIds:e}),s}finalize(t){return this._fetchQueue.length||this._lock.isHeld()?yr(this._lock,this._fetchAllQueuedResources.bind(this),t):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],br,!1),marker:this._createMeshTemplates([],vr,!1),line:this._createMeshTemplates([],wr,!1)})}_fetchAllQueuedResources(t){if(!this._fetchQueue.length)return Promise.resolve();const e=this._fetchQueue,i=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(i).then(()=>this._fetchResource(e,t).then(s=>{for(const{id:r,mosaicItem:a}of s)this._idToResolver.get(r)(a),this._idToResolver.delete(r)})).catch(s=>{Bi(s)?this._fetchQueue=this._fetchQueue.concat(e):Sr(s)||R.error(new rt("mapview-template-store","Unable to fetch requested texture resources",s))})}_createGroupId(t){return this._idCounter++<<1|(t?1:0)}_createTemplateId(){return this._templateIdCounter++}async _createSMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return k(e,R)?D.fromSimpleMarker(t,e):this._markerError}async _createPMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return k(e,R)?D.fromPictureMarker(t,e):this._markerError}async _createSFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return k(i,R)?H.fromSimpleFill(t,i,e):this._fillError}async _createPFS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return k(i,R)?H.fromPictureFill(t,i,e):this._fillError}async _createSLS(t,e){const{spriteMosaicItem:i}=await this.getMosaicItem(t);return k(i,R)?U.fromSimpleLine(t,i):this._lineError}async _createLMS(t){const{spriteMosaicItem:e}=await this.getMosaicItem(t);return k(e,R)?D.fromLineSymbolMarker(t,e):this._markerError}async _createTS(t){const{glyphMosaicItems:e}=await this.getMosaicItem(t);return _t.fromText(t,e)}async _createCIMText(t){const{glyphMosaicItems:e}=await this.getMosaicItem(Wt(t),Mi(t.text));return k(e,R)?_t.fromCIMText(t,e,this._tileInfo):this._textError}async _createCIMFill(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Wt(t));return k(e,R)?H.fromCIMFill(t,e,this._tileInfo):this._fillError}async _createCIMLine(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Wt(t));return k(e,R)?U.fromCIMLine(t,e,this._tileInfo):this._lineError}async _createCIMMarker(t){const{spriteMosaicItem:e}=await this.getMosaicItem(Wt(t));return k(e,R)?D.fromCIMMarker(t,e,this._tileInfo):this._markerError}async _createCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let i;switch(t.type){case"marker":i=await this._createCIMMarker(t);break;case"line":i=await this._createCIMLine(t);break;case"fill":i=await this._createCIMFill(t);break;case"text":i=await this._createCIMText(t)}return this._cimTemplateCache.set(e,i),i}async _createDynamicCIM(t){const e=t.templateHash;if(this._cimTemplateCache.has(e))return this._cimTemplateCache.get(e);let i;switch(t.type){case"marker":i=ye.fromCIMMarker(t,this._tileInfo);break;case"line":i=pe.fromCIMLine(t,this._tileInfo);break;case"fill":i=me.fromCIMFill(t,this._tileInfo);break;case"text":i=xe.fromCIMText(t,this._tileInfo)}return this._cimTemplateCache.set(e,i),i}_createPrimitiveMeshTemplates(t,e,i){switch(e.type){case"esriSMS":return X(t,this._createSMS(e));case"esriPMS":return X(t,this._createPMS(e));case"esriSFS":return X(t,this._createSFS(e,i));case"line-marker":return X(t,this._createLMS(e));case"esriPFS":return X(t,this._createPFS(e,i));case"esriSLS":return X(t,this._createSLS(e,!1));case"esriTS":return X(t,this._createTS(e));default:return R.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),t}}_createMeshTemplates(t,e,i){if(e.type.includes("3d"))return R.error("3D symbols are not supported with MapView"),t;if(e.type==="expanded-cim"){for(const s of e.layers)typeof s.materialHash=="function"?X(t,this._createDynamicCIM(s)):X(t,this._createCIM(s));return t}if(e.type==="composite-symbol"){for(const s of e.layers)this._createPrimitiveMeshTemplates(t,s,i);return t}return e.type==="cim"||e.type==="label"||e.type==="web-style"?t:this._createPrimitiveMeshTemplates(t,e,i)}}const Lr=n=>{if(!n.layers)return!1;for(const t of n.layers)if(typeof t.materialHash=="function")return!0;return!1};class Nr{constructor(t,e,i){this._loadPromise=ss(),this._geometryType=t,this._idField=e,this._templateStore=i}update(t,e){E(t.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(t.mesh.labels,e)),this._schema=t}_createLabelTemplates(t,e){const i=new Map;if(t.type==="simple"){for(const s of t.classes){const r=Ft.fromLabelClass(s,e);i.set(s.index,r)}return i}for(const s in t.classes){const r=t.classes[s];for(const a of r){const o=Ft.fromLabelClass(a,e);i.set(a.index,o)}}return i}get templates(){return this._templateStore}async analyze(t,e,i,s,r,a,o){if(Pe(o))return;let h;i.type==="dictionary"&&(h=await i.analyze(this._idField,t.copy(),e,r,a,o));let l=0;for(;t.next();){let c;if(c=h?h[l++]:E(s)&&ji(t.getDisplayId())&&t.readAttribute("cluster_count")!==1?s.match(this._idField,t,this._geometryType,r,a):i.match(this._idField,t,this._geometryType,r,a),t.setGroupId(c),yt(c)){const u=this._templateStore.getDynamicTemplateGroup(c);for(const _ of u)_&&_.analyze&&_.analyze(this._templateStore,t,r,a)}}return await this._loadPromise,this._templateStore.finalize(o)}async analyzeGraphics(t,e,i,s,r,a){if(Pe(a))return;const o=t.getCursor();for(i&&await i.analyze(this._idField,o.copy(),e,s,r,a);o.next();){let h=o.getGroupId();if(h!=null&&h!==-1||(h=i.match(this._idField,o,o.geometryType,s,r),o.setGroupId(h)),yt(h)){const l=this._templateStore.getDynamicTemplateGroup(h);for(const c of l)c&&c.analyze&&c.analyze(this._templateStore,o,s,r)}o.setGroupId(h)}return await this._loadPromise,this._templateStore.finalize(a)}writeGraphic(t,e,i,s){const r=e.getGroupId(),a=e.getDisplayId(),o=this._templateStore.getTemplateGroup(r);if(t.featureStart(e.insertAfter,0),a!=null){if(yt(r))for(const h of o)h&&h.bindFeature(e,null,null);if(o){for(const h of o)h&&h.write(t,e,i,s);t.featureEnd()}}}writeCursor(t,e,i,s,r,a,o){const h=e.getGroupId(),l=e.getDisplayId(),c=this._templateStore.getTemplateGroup(h),u=this._schema.mesh.sortKey;let _=0;if(E(u)&&(_=u.fieldIndex!=null?e.getComputedNumericAtIndex(u.fieldIndex):u.field!=null?e.readAttribute(u.field):e.readAttribute(this._idField),_*=u.order==="asc"?1:-1),t.featureStart(0,_==null||isNaN(_)?0:_),l!=null&&c){if(yt(h))for(const f of c)f.bindFeature(e,i,s);for(const f of c)f.write(t,e,r,o);if(E(a)&&t.hasRecords){const f=a&&this._findLabelRef(c);this._writeLabels(t,e,a,f,r,o)}t.featureEnd()}}_findLabelRef(t){for(const e of t)if(e instanceof D)return e;return null}_writeLabels(t,e,i,s,r,a){for(const o of i)if(E(o)&&o){const{glyphs:h,rtl:l,index:c}=o,u=this._labelTemplates.get(c);u.setZoomLevel(r),u.bindReferenceTemplate(s),u.bindTextInfo(h,l),u.write(t,e,null,a)}}}const ie=mt.getLogger("esri/views/2d/engine/webgl/util/Matcher");async function Pr(n,t,e,i){switch(n.type){case"simple":case"heatmap":return Q.fromBasicRenderer(n,t,e,i);case"map":return ve.fromUVRenderer(n,t,e,i);case"interval":return Me.fromCBRenderer(n,t,e,i);case"dictionary":return we.fromDictionaryRenderer(n,t,e,i);case"pie-chart":return Bt.fromPieChartRenderer(n,t,e,i);case"subtype":return Bt.fromSubtypes(n,t,e,i)}}class Q{constructor(){this.type="feature",this._defaultResult=null}static async fromBasicRenderer(t,e,i,s){const r=new Q;if(t.symbol){const a=await Z(t.symbol,i,s),o=e.createTemplateGroup(a,null);r.setDefault(o)}return r}static async fromPieChartRenderer(t,e,i,s){const r=new Q;if(t.markerSymbol){const a=await Z(t.markerSymbol,i,s);let o;t.fillSymbol&&(o=await Z(t.fillSymbol,i,s));const h=e.createTemplateGroup(a,o);r.setDefault(h)}return r}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}match(t,e,i,s,r){return this.getDefault()}async analyze(t,e,i,s,r,a){return null}}class Bt extends Q{constructor(t,e){super(),this._subMatchers=t,this._subtypeField=e}static async fromSubtypes(t,e,i,s){const r=new Map,a=[];for(const o in t.renderers){const h=parseInt(o,10),l=Pr(t.renderers[o],e,i,s).then(c=>r.set(h,c));a.push(l)}return await Promise.all(a),new Bt(r,t.subtypeField)}match(t,e,i,s,r){const a=e.readAttribute(this._subtypeField),o=this._subMatchers.get(a);return o?o.match(t,e,i,s,r):null}}class Me extends Q{constructor(t,e,i,s){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=e,this._fieldIndex=s,this._field=t,this._normalizationInfo=i}static async fromCBRenderer(t,e,i,s){const{isMaxInclusive:r,normalizationField:a,normalizationTotal:o,normalizationType:h}=t,l=t.field,c=new Me(l,r,{normalizationField:a,normalizationTotal:o,normalizationType:h},t.fieldIndex),u=await Z(t.backgroundFillSymbol,i,s);await Promise.all(t.intervals.map(async f=>{const m=await Z(f.symbol,i,s),d=await e.createTemplateGroup(m,u),y={min:f.min,max:f.max};c.add(y,d)}));const _=await Z(t.defaultSymbol,i,s);if(_){const f=await e.createTemplateGroup(_,u);c.setDefault(f)}return c}add(t,e){this._intervals.push({interval:t,result:e}),this._intervals.sort((i,s)=>i.interval.min-s.interval.min)}size(){return super.size()+this._intervals.length}match(t,e,i,s,r){if(this._fieldIndex==null&&!this._field)return this.getDefault();const a=this._fieldIndex!=null?e.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(e);if(!a&&(a==null||isNaN(a)))return this.getDefault();for(let o=0;o<this._intervals.length;o++){const{interval:h,result:l}=this._intervals[o],c=a>=h.min,u=this._isMaxInclusive?a<=h.max:a<h.max;if(c&&u)return l}return this.getDefault()}_needsNormalization(){const t=this._normalizationInfo;return t&&(t.normalizationField||t.normalizationTotal||t.normalizationType)}_getValueFromField(t){const e=t.readAttribute(this._field);if(!this._needsNormalization()||e==null)return e;const{normalizationField:i,normalizationTotal:s,normalizationType:r}=this._normalizationInfo,a=!!i&&t.readAttribute(i);if(r)switch(r){case"esriNormalizeByField":return a?e/a:void 0;case"esriNormalizeByLog":return Math.log(e)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return e/s*100;default:return void ie.error(`Found unknown normalization type: ${r}`)}else ie.error("Normalization is required, but no type was set!")}}class ve extends Q{constructor(t,e,i){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=i,this._fields=t,this._seperator=e||""}static async fromUVRenderer(t,e,i,s){const r=t.fieldDelimiter,a=[t.field];t.field2&&a.push(t.field2),t.field3&&a.push(t.field3);const o=await Z(t.backgroundFillSymbol,i,s),h=new ve(a,r,t.fieldIndex);await Promise.all(t.map.map(async c=>{const u=await Z(c.symbol,i,s),_=await e.createTemplateGroup(u,o);c.value==="<Null>"?h.setNullResult(_):h.add(c.value,_)}));const l=await Z(t.defaultSymbol,i,s);if(l){const c=await e.createTemplateGroup(l,o);h.setDefault(c)}return h}setNullResult(t){this._nullResult=t}add(t,e){this._resultsMap.set(t.toString(),e)}size(){return super.size()+this._resultsMap.size}match(t,e,i,s,r){if(this._fieldsIndex==null&&!this._fields)return this.getDefault();const a=this._fieldsIndex!=null?e.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(e);if(this._nullResult!==null&&(a==null||a===""||a==="<Null>"))return this._nullResult;if(!a&&a==null)return this.getDefault();const o=a.toString();return this._resultsMap.has(o)?this._resultsMap.get(o):this.getDefault()}_getValueFromFields(t){const e=[];for(const i of this._fields){const s=t.readAttribute(i);s==null||s===""?e.push("<Null>"):e.push(s)}return e.join(this._seperator)}}async function Tr(n,t){const e=n||1;if(typeof e=="number")return(s,r,a)=>e;const i=await Oi(e,t.spatialReference,t.fields);return(s,r,a)=>ys(i,s,{$view:a},t.geometryType,r)||1}let Ut;async function zr(){return Ut||(Ut=hi(()=>import("./createSymbolSchema.47a02593.js"),["assets/createSymbolSchema.47a02593.js","assets/Utils.f67560a4.js","assets/main.efb50b2c.js","assets/main.908c9a86.css","assets/preload-helper.387dac8f.js","assets/enums.6e42a319.js","assets/enums.de935fa5.js","assets/Texture.627d6838.js","assets/VertexElementDescriptor.d386088d.js","assets/MaterialKey.c216087c.js"])),Ut}class we extends Q{constructor(t,e,i,s,r,a){super(),this.type="dictionary",this._groupIdCache=new Vi(100),this._loader=t,this._fieldMap=t.fieldMap,this._symbolFields=t.getSymbolFields(),this._templates=e,this._info=i,this._scaleFn=s,this._schemaUtilsModule=r,this._symbolOptions=a}static async fromDictionaryRenderer(t,e,i,s){const[{DictionaryLoader:r},a]=await Promise.all([hi(()=>import("./main.efb50b2c.js").then(function(l){return l.nc}),["assets/main.efb50b2c.js","assets/main.908c9a86.css","assets/preload-helper.387dac8f.js"]),zr()]),o=new r(t.url,t.config,t.fieldMap);await o.fetchResources({spatialReference:i.spatialReference,fields:i.fields});const h=await Tr(t.scaleExpression,i);return new we(o,e,i,h,a,t.symbolOptions)}async _analyzeFeature(t,e,i,s,r){const a=t.readLegacyFeature(),o=this._scaleFn(a,i,s),h=this._attributeHash(a)+"-"+o,l=this._groupIdCache.get(h);if(l)return l;const c={...s,spatialReference:this._info.spatialReference,abortOptions:r,fields:this._info.fields},u=await this._loader.getSymbolAsync(a,c),_=this._schemaUtilsModule.createSymbolSchema(u,this._symbolOptions),f=Z(_,this._info,e,r).then(m=>{if(m.type!=="expanded-cim")return ie.error(new rt("mapview-bad-type",`Found unexpected type ${m.type} in dictionary response`)),null;m.hash+="-"+o;for(const d of m.layers)d.scaleFactor=o,d.templateHash+="-"+o;return this._templates.createTemplateGroup(m,null)});return this._groupIdCache.put(h,f,1),f}async analyze(t,e,i,s,r,a){const o=e.getCursor(),h=[];for(;o.next();)h.push(this._analyzeFeature(o,i,s,r,a));return Promise.all(h)}match(t,e,i,s,r){return null}_attributeHash(t){let e="";for(const i of this._symbolFields){const s=this._fieldMap[i];s&&(e+=t.attributes[s]+"-")}return e}}export{Kr as E,Tt as a,Nr as b,k as e,Pr as l,Z as n,Mi as t,Zr as x};
