import{aX as ie,e as D,a_ as Os,R as Bt,U as lt,a$ as Cs,at as Ps,b0 as Ds,s as H,b1 as te,i as P,b2 as Be,b3 as Qt,a6 as ft,b4 as Is,aA as Us,b5 as ht,b6 as Ae,b7 as Ns,b8 as st,b9 as Jt,ba as wt,bb as Ls,bc as li,bd as $s,be as zs,bf as ks,bg as Gs,aW as Vs,ao as Ws,bh as jt,aT as Ft,bi as Xs,bj as hi,bk as Hs,aS as qs,bl as js,bm as Ys,ay as Ks,ak as Rt,bn as ss,bo as Zs,bp as Qs,bq as le,br as we,bs as Js,bt as er,P as Xe,bu as tr,K as C,N as z,O as He,bv as ui,bw as ir,bx as sr,by as rs,bz as Ct,bA as Pt,bB as ns,bC as At,bD as rr,bE as nr,bF as ar,bG as or,bH as ut,bI as lr,bJ as Yt,bK as hr,bL as ur,bM as ci,bN as cr,bO as dr,bP as _r}from"./main.efb50b2c.js";import{e as di,m as fr,Z as pt,t as _i,a as mr,o as pr,n as gr,r as br,s as vr}from"./CIMSymbolHelper.6248d0ad.js";import{s as fi,a as Er}from"./utils.9619dae6.js";import{I as se,N as xr,O as gt,v as yr,M as Tr,a as mi,T as wr,B as Fr,_ as bt,U as pi,w as Rr,A as Br,E as as,D as Ar,b as je,S as Ut}from"./Utils.f67560a4.js";import{n as ne,t as Sr,a as Ne,W as be,m as os}from"./WGLContainer.83fa1e96.js";import{T as J}from"./enums.2a1fad7f.js";import{e as Mr,a as ct}from"./ProgramTemplate.1056febf.js";import{n as Me,s as Or}from"./programUtils.309ffe7b.js";import{f as Le,c as $e,D as X,r as Cr,i as gi}from"./VertexArrayObject.e5cd7959.js";import{R as A,E as re,F as ze,P as F,G as M,L as S,D as U,O as Te,I as We,M as I,C as dt,Y as j,V as Y,B as Pr,T as Kt,N as Ie,S as ls,t as rt,U as Dr,_ as et,A as B,X as Nt,n as de,W as Ir,r as bi,f as Ur}from"./enums.de935fa5.js";import{r as vi,a as Nr,o as Lr,e as $r,n as zr}from"./ExpandedCIM.7b8d9605.js";import{e as Ee,d as xe,z as Ei,y as xi,N as kr,B as Gr,C as Vr,J as hs,I as Ye,Y as us,O as yi,U as Wr,V as Xr}from"./enums.6e42a319.js";import{t as ce}from"./BidiEngine.ec67919b.js";import{u as K,n as q,a as Fe}from"./Texture.627d6838.js";import{P as Ti}from"./GeometryUtils.8166011b.js";import{o as Hr}from"./_commonjsHelpers.01f5fe30.js";import{m as qr}from"./imageutils.2cd0bffb.js";import{e as Lt}from"./Matcher.41df3644.js";import{t as _t}from"./VertexElementDescriptor.d386088d.js";import{s as jr}from"./CircularArray.eecf6ac8.js";import{t as wi,W as Yr,A as Kr,M as Zr,a as Fi}from"./requestImageUtils.2128a3de.js";import{t as Qr}from"./ComputedAttributeStorage.a7ff046c.js";import{a as Hl}from"./BaseGraphicContainer.ab876b54.js";import{i as jl}from"./GraphicContainer.c13e7f7c.js";import{_ as Ri}from"./preload-helper.387dac8f.js";import"./MaterialKey.c216087c.js";import"./GeometryUtils.814cb798.js";import"./StyleDefinition.627ffe6c.js";import"./config.40d47db8.js";import"./earcut.d30cbec0.js";import"./quantizationUtils.d09757e3.js";import"./visualVariablesUtils.42df48c6.js";import"./visualVariablesUtils.087ada97.js";import"./tileUtils.0431f5e8.js";import"./TileClipper.68567d53.js";import"./Geometry.b68345ae.js";import"./devEnvironmentUtils.8c6e6b72.js";import"./centroid.79915d1f.js";import"./normalizeUtilsSync.38eabbc7.js";import"./projectionSupport.a2ec70ff.js";import"./json.d1a0fa35.js";import"./FeatureContainer.423509ab.js";import"./TileContainer.bca8274f.js";import"./schemaUtils.692e0e19.js";import"./createSymbolSchema.47a02593.js";import"./MD5.97b39efc.js";import"./util.5d5e59e8.js";import"./vec3f32.8d37ecf5.js";const Jr=512;class en{constructor(e){this._resourceManager=e}dispose(){this._rasterizationCanvas=null}rasterizeJSONResource(e,t,i){if(this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),e.type==="simple-fill"||e.type==="esriSFS"){const[_,f,m]=di.rasterizeSimpleFill(this._rasterizationCanvas,e.style,t);return{size:[f,m],image:new Uint32Array(_.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0}}if(e.type==="simple-line"||e.type==="esriSLS"||e.type==="line"&&e.dashTemplate){let _,f;if(e.type==="simple-line"||e.type==="esriSLS")switch(_=fr(e.style,e.cap),e.cap){case"butt":f="Butt";break;case"square":f="Square";break;default:f="Round"}else _=e.dashTemplate,f=e.cim.capStyle;const[m,d,g]=di.rasterizeSimpleLine(_,f);return{size:[d,g],image:new Uint32Array(m.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}let s,n,a;if(e.type==="simple-marker"||e.type==="esriSMS"||e.type==="line-marker"?(s=pt.fromSimpleMarker(e),a=vi(s)):e.cim&&e.cim.type==="CIMHatchFill"?(s=pt.fromCIMHatchFill(e.cim),n=new _i(s.frame.xmin,-s.frame.ymax,s.frame.xmax-s.frame.xmin,s.frame.ymax-s.frame.ymin)):e.cim.markerPlacement&&e.cim.markerPlacement.type==="CIMMarkerPlacementInsidePolygon"?(s=pt.fromCIMInsidePolygon(e.cim),n=new _i(s.frame.xmin,-s.frame.ymax,s.frame.xmax-s.frame.xmin,s.frame.ymax-s.frame.ymin)):(s=e.cim,a=vi(s)),a&&!i){const[_,f,m]=Nr(a);return _?{size:[f,m],image:new Uint32Array(_.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}const[o,l,h,c,u]=pt.rasterize(this._rasterizationCanvas,s,n,this._resourceManager,!i);return o?{size:[l,h],image:new Uint32Array(o.buffer),sdf:!1,simplePattern:!1,anchorX:c,anchorY:u}:null}rasterizeImageResource(e,t,i,s){this._rasterizationCanvas||(this._rasterizationCanvas=document.createElement("canvas")),this._rasterizationCanvas.width=e,this._rasterizationCanvas.height=t;const n=this._rasterizationCanvas.getContext("2d");i instanceof ImageData?n.putImageData(i,0,0):(i.setAttribute("width",`${e}px`),i.setAttribute("height",`${t}px`),n.drawImage(i,0,0,e,t));const a=n.getImageData(0,0,e,t),o=new Uint8Array(a.data);if(s){for(const f of s)if(f&&f.oldColor&&f.oldColor.length===4&&f.newColor&&f.newColor.length===4){const[m,d,g,x]=f.oldColor,[p,E,b,y]=f.newColor;if(m===p&&d===E&&g===b&&x===y)continue;for(let v=0;v<o.length;v+=4)m===o[v]&&d===o[v+1]&&g===o[v+2]&&x===o[v+3]&&(o[v]=p,o[v+1]=E,o[v+2]=b,o[v+3]=y)}}let l;for(let f=0;f<o.length;f+=4)l=o[f+3]/255,o[f]=o[f]*l,o[f+1]=o[f+1]*l,o[f+2]=o[f+2]*l;let h=o,c=e,u=t;const _=Jr;if(c>=_||u>=_){const f=c/u;f>1?(c=_,u=Math.round(_/f)):(u=_,c=Math.round(_*f)),h=new Uint8Array(4*c*u);const m=new Uint8ClampedArray(h.buffer);mr(o,e,t,m,c,u,!1)}return{size:[c,u],image:new Uint32Array(h.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}const tn={background:{"background.frag":`#ifdef PATTERN
uniform lowp float u_opacity;
uniform lowp sampler2D u_texture;
varying mediump vec4 v_tlbr;
varying mediump vec2 v_tileTextureCoord;
#else
uniform lowp vec4 u_color;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
void main() {
#ifdef PATTERN
mediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);
mediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);
lowp vec4 color = texture2D(u_texture, samplePos);
gl_FragColor = u_opacity * color;
#else
gl_FragColor = u_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"background.vert":`precision mediump float;
attribute vec2 a_pos;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform mediump float u_coord_range;
uniform mediump float u_depth;
#ifdef PATTERN
uniform mediump mat3 u_pattern_matrix;
varying mediump vec2 v_tileTextureCoord;
uniform mediump vec4 u_tlbr;
uniform mediump vec2 u_mosaicSize;
varying mediump vec4 v_tlbr;
#endif
void main() {
gl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);
#ifdef PATTERN
v_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;
v_tlbr             = u_tlbr / u_mosaicSize.xyxy;
#endif
#ifdef ID
v_id = u_id / 255.0;
#endif
}`},circle:{"circle.frag":`precision lowp float;
varying lowp vec4 v_color;
varying lowp vec4 v_stroke_color;
varying mediump float v_blur;
varying mediump float v_stroke_width;
varying mediump float v_radius;
varying mediump vec2 v_offset;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
mediump float dist = length(v_offset);
mediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);
lowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));
gl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"circle.vert":`precision mediump float;
attribute vec2 a_pos;
#pragma header
varying lowp vec4 v_color;
varying lowp vec4 v_stroke_color;
varying mediump float v_blur;
varying mediump float v_stroke_width;
varying mediump float v_radius;
varying mediump vec2 v_offset;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump vec2 u_circleTranslation;
uniform mediump float u_depth;
uniform mediump float u_antialiasingWidth;
void main()
{
#pragma main
v_color = color * opacity;
v_stroke_color = stroke_color * stroke_opacity;
v_stroke_width = stroke_width;
v_radius = radius;
v_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));
mediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);
v_offset = offset;
#ifdef ID
v_id = u_id / 255.0;
#endif
mediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},fill:{"fill.frag":`precision lowp float;
#ifdef PATTERN
uniform lowp sampler2D u_texture;
varying mediump vec2 v_tileTextureCoord;
varying mediump vec4 v_tlbr;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
vec4 mixColors(vec4 color1, vec4 color2) {
float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);
vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);
return vec4(compositeColor, compositeAlpha);
}
void main()
{
#ifdef PATTERN
mediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);
mediump vec2 samplePos = mix(v_tlbr.xy, v_tlbr.zw, normalizedTextureCoord);
lowp vec4 color = texture2D(u_texture, samplePos);
gl_FragColor = v_color[3] * color;
#else
gl_FragColor = v_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"fill.vert":`precision mediump float;
attribute vec2 a_pos;
#pragma header
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump float u_depth;
uniform mediump vec2 u_fillTranslation;
#ifdef PATTERN
#include <util/util.glsl>
uniform mediump vec2 u_mosaicSize;
uniform mediump float u_patternFactor;
varying mediump vec2 v_tileTextureCoord;
varying mediump vec4 v_tlbr;
#endif
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
void main()
{
#pragma main
v_color = color * opacity;
#ifdef ID
v_id = u_id / 255.0;
#endif
#ifdef PATTERN
float patternWidth = nextPOT(tlbr.z - tlbr.x);
float patternHeight = nextPOT(tlbr.w - tlbr.y);
float scaleX = 1.0 / (patternWidth * u_patternFactor);
float scaleY = 1.0 / (patternHeight * u_patternFactor);
mat3 patterMat = mat3(scaleX, 0.0,    0.0,
0.0,    -scaleY, 0.0,
0.0,    0.0,    1.0);
v_tileTextureCoord = (patterMat * vec3(a_pos, 1.0)).xy;
v_tlbr             = tlbr / u_mosaicSize.xyxy;
#endif
vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},icon:{"icon.frag":`precision mediump float;
uniform lowp sampler2D u_texture;
#ifdef SDF
uniform lowp vec4 u_color;
uniform lowp vec4 u_outlineColor;
#endif
varying mediump vec2 v_tex;
varying lowp float v_opacity;
varying mediump vec2 v_size;
varying lowp vec4 v_color;
#ifdef SDF
varying mediump flaot v_halo_width;
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
#include <util/encoding.glsl>
vec4 mixColors(vec4 color1, vec4 color2) {
float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);
vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);
return vec4(compositeColor, compositeAlpha);
}
void main()
{
#ifdef SDF
lowp vec4 fillPixelColor = v_color;
float d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;
const float softEdgeRatio = 0.248062016;
float size = max(v_size.x, v_size.y);
float dist = d * softEdgeRatio * size;
fillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);
if (v_halo_width > 0.25) {
lowp vec4 outlinePixelColor = u_outlineColor;
const float outlineLimitRatio = (16.0 / 86.0);
float clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));
outlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);
gl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);
}
else {
gl_FragColor = v_opacity * fillPixelColor;
}
#else
lowp vec4 texColor = texture2D(u_texture, v_tex);
gl_FragColor = v_opacity * texColor;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"icon.vert":`attribute vec2 a_pos;
attribute vec2 a_vertexOffset;
attribute vec4 a_texAngleRange;
attribute vec4 a_levelInfo;
attribute float a_opacityInfo;
#pragma header
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
#ifdef SDF
varying mediump float v_halo_width;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump vec2 u_iconTranslation;
uniform vec2 u_mosaicSize;
uniform mediump float u_depth;
uniform mediump float u_mapRotation;
uniform mediump float u_level;
uniform lowp float u_keepUpright;
uniform mediump float u_fadeDuration;
varying mediump vec2 v_tex;
varying lowp float v_opacity;
varying mediump vec2 v_size;
const float C_OFFSET_PRECISION = 1.0 / 8.0;
const float C_256_TO_RAD = 3.14159265359 / 128.0;
const float C_DEG_TO_RAD = 3.14159265359 / 180.0;
const float tileCoordRatio = 1.0 / 8.0;
uniform highp float u_time;
void main()
{
#pragma main
v_color = color;
v_opacity = opacity;
#ifdef SDF
v_halo_width = halo_width;
#endif
float modded = mod(a_opacityInfo, 128.0);
float targetOpacity = (a_opacityInfo - modded) / 128.0;
float startOpacity = modded / 127.0;
float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);
v_opacity *= interpolatedOpacity;
mediump float a_angle         = a_levelInfo[1];
mediump float a_minLevel      = a_levelInfo[2];
mediump float a_maxLevel      = a_levelInfo[3];
mediump vec2 a_tex            = a_texAngleRange.xy;
mediump float delta_z = 0.0;
mediump float rotated = mod(a_angle + u_mapRotation, 256.0);
delta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));
delta_z += 1.0 - step(a_minLevel, u_level);
delta_z += step(a_maxLevel, u_level);
delta_z += step(v_opacity, 0.0);
vec2 offset = C_OFFSET_PRECISION * a_vertexOffset;
v_size = abs(offset);
#ifdef SDF
offset = (120.0 / 86.0) * offset;
#endif
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);
#ifdef ID
v_id = u_id / 255.0;
#endif
v_tex = a_tex.xy / u_mosaicSize;
}`},line:{"line.frag":`precision lowp float;
varying mediump vec2 v_normal;
varying highp float v_accumulatedDistance;
varying mediump float v_lineHalfWidth;
varying lowp vec4 v_color;
varying mediump float v_blur;
#if defined (PATTERN) || defined(SDF)
varying mediump vec4 v_tlbr;
varying mediump vec2 v_patternSize;
varying mediump float v_widthRatio;
uniform sampler2D u_texture;
uniform mediump float u_antialiasing;
#endif
#ifdef SDF
#include <util/encoding.glsl>
#endif
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
mediump float fragDist = length(v_normal) * v_lineHalfWidth;
lowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);
#ifdef PATTERN
mediump float relativeTexX = fract(v_accumulatedDistance / (v_patternSize.x * v_widthRatio));
mediump float relativeTexY = 0.5 + v_normal.y * v_lineHalfWidth / (v_patternSize.y * v_widthRatio);
mediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));
lowp vec4 color = texture2D(u_texture, texCoord);
gl_FragColor = alpha * v_color[3] * color;
#elif defined(SDF)
mediump float relativeTexX = fract((v_accumulatedDistance * 0.5) / (v_patternSize.x * v_widthRatio));
mediump float relativeTexY =  0.5 + 0.25 * v_normal.y;
mediump vec2 texCoord = mix(v_tlbr.xy, v_tlbr.zw, vec2(relativeTexX, relativeTexY));
mediump float d = rgba2float(texture2D(u_texture, texCoord)) - 0.5;
float dist = d * (v_lineHalfWidth + u_antialiasing / 2.0);
gl_FragColor = alpha * clamp(0.5 - dist, 0.0, 1.0) * v_color;
#else
gl_FragColor = alpha * v_color;
#endif
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"line.vert":`precision mediump float;
attribute vec2 a_pos;
attribute vec4 a_extrude_offset;
attribute vec4 a_dir_normal;
attribute vec2 a_accumulatedDistance;
#pragma header
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump float u_zoomFactor;
uniform mediump vec2 u_lineTranslation;
uniform mediump float u_antialiasing;
uniform mediump float u_depth;
varying mediump vec2 v_normal;
varying highp float v_accumulatedDistance;
const float scale = 1.0 / 31.0;
const mediump float tileCoordRatio = 8.0;
#if defined (SDF)
const mediump float sdfPatternHalfWidth = 15.5;
#endif
#if defined (PATTERN) || defined(SDF)
uniform mediump vec2 u_mosaicSize;
varying mediump vec4 v_tlbr;
varying mediump vec2 v_patternSize;
varying mediump float v_widthRatio;
#endif
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
varying lowp vec4 v_color;
varying mediump float v_lineHalfWidth;
varying mediump float v_blur;
void main()
{
#pragma main
v_color = color * opacity;
v_blur = blur + u_antialiasing;
v_normal = a_dir_normal.zw * scale;
#if defined (PATTERN) || defined(SDF)
v_tlbr          = tlbr / u_mosaicSize.xyxy;
v_patternSize   = vec2(tlbr.z - tlbr.x, tlbr.y - tlbr.w);
#if defined (PATTERN)
v_widthRatio = width / v_patternSize.y;
#else
v_widthRatio = width / sdfPatternHalfWidth / 2.0;
#endif
#endif
v_lineHalfWidth = (width + u_antialiasing) * 0.5;
mediump vec2 dir = a_dir_normal.xy * scale;
mediump vec2 offset_ = a_extrude_offset.zw * scale * offset;
mediump vec2 dist = v_lineHalfWidth * scale * a_extrude_offset.xy;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos + offset_ * tileCoordRatio / u_zoomFactor, 1.0) + u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
#if defined (PATTERN) || defined(SDF)
v_accumulatedDistance = a_accumulatedDistance.x * u_zoomFactor / tileCoordRatio + dot(dir, dist + offset_);
#endif
#ifdef ID
v_id = u_id / 255.0;
#endif
}`},outline:{"outline.frag":`varying lowp vec4 v_color;
varying mediump vec2 v_normal;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
lowp float dist = abs(v_normal.y);
lowp float alpha = smoothstep(1.0, 0.0, dist);
gl_FragColor = alpha * v_color;
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"outline.vert":`attribute vec2 a_pos;
attribute vec2 a_offset;
attribute vec2 a_xnormal;
#pragma header
varying lowp vec4 v_color;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform mediump vec2 u_fillTranslation;
uniform mediump float u_depth;
uniform mediump float u_outline_width;
varying lowp vec2 v_normal;
const float scale = 1.0 / 15.0;
void main()
{
#pragma main
v_color = color * opacity;
#ifdef ID
v_id = u_id / 255.0;
#endif
v_normal = a_xnormal;
mediump vec2 dist = u_outline_width * scale * a_offset;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth, 1.0);
}`},text:{"text.frag":`uniform lowp sampler2D u_texture;
varying lowp vec2 v_tex;
varying lowp vec4 v_color;
varying mediump float v_edgeWidth;
varying mediump float v_edgeDistance;
#ifdef ID
varying mediump vec4 v_id;
#endif
void main()
{
lowp float dist = texture2D(u_texture, v_tex).a;
mediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);
gl_FragColor = alpha * v_color;
#ifdef ID
if (gl_FragColor.a < 1.0 / 255.0) {
discard;
}
gl_FragColor = v_id;
#endif
}`,"text.vert":`attribute vec2 a_pos;
attribute vec2 a_vertexOffset;
attribute vec4 a_texAngleRange;
attribute vec4 a_levelInfo;
attribute float a_opacityInfo;
#pragma header
varying lowp vec4 v_color;
#ifdef ID
uniform mediump vec4 u_id;
varying mediump vec4 v_id;
#endif
uniform highp mat3 u_dvsMat3;
uniform highp mat3 u_displayMat3;
uniform highp mat3 u_displayViewMat3;
uniform mediump vec2 u_textTranslation;
uniform vec2 u_mosaicSize;
uniform mediump float u_depth;
uniform mediump float u_mapRotation;
uniform mediump float u_level;
uniform lowp float u_keepUpright;
uniform mediump float u_fadeDuration;
varying lowp vec2 v_tex;
const float offsetPrecision = 1.0 / 8.0;
const mediump float edgePos = 0.75;
uniform mediump float u_antialiasingWidth;
varying mediump float v_edgeDistance;
varying mediump float v_edgeWidth;
uniform lowp float u_halo;
const float sdfFontScale = 1.0 / 24.0;
const float sdfPixel = 3.0;
uniform highp float u_time;
void main()
{
#pragma main
if (u_halo > 0.5)
{
v_color = halo_color * opacity;
halo_width *= sdfPixel;
halo_blur *= sdfPixel;
}
else
{
v_color = color * opacity;
halo_width = 0.0;
halo_blur = 0.0;
}
float modded = mod(a_opacityInfo, 128.0);
float targetOpacity = (a_opacityInfo - modded) / 128.0;
float startOpacity = modded / 127.0;
float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);
v_color *= interpolatedOpacity;
mediump float a_angle       = a_levelInfo[1];
mediump float a_minLevel    = a_levelInfo[2];
mediump float a_maxLevel    = a_levelInfo[3];
mediump vec2 a_tex          = a_texAngleRange.xy;
mediump float a_visMinAngle    = a_texAngleRange.z;
mediump float a_visMaxAngle    = a_texAngleRange.w;
mediump float delta_z = 0.0;
mediump float angle = mod(a_angle + u_mapRotation, 256.0);
if (a_visMinAngle < a_visMaxAngle)
{
delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));
}
else
{
delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));
}
delta_z += 1.0 - step(a_minLevel, u_level);
delta_z += step(a_maxLevel, u_level);
delta_z += step(v_color[3], 0.0);
v_tex = a_tex.xy / u_mosaicSize;
#ifdef ID
v_id = u_id / 255.0;
#endif
v_edgeDistance = edgePos - halo_width / size;
v_edgeWidth = (u_antialiasingWidth + halo_blur) / size;
mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);
gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);
}`},util:{"encoding.glsl":`const vec4 rgba2float_factors = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, rgba2float_factors);
}`,"util.glsl":`float nextPOT(in float x) {
return pow(2.0, ceil(log2(abs(x))));
}`}};function sn(r){let e=tn;return r.split("/").forEach(t=>{e&&(e=e[t])}),e}const rn=new Mr(sn);function ae(r){return rn.resolveIncludes(r)}const Bi=r=>Me({ID:r.id,PATTERN:r.pattern}),nn={shaders:r=>({vertexShader:Bi(r)+ae("background/background.vert"),fragmentShader:Bi(r)+ae("background/background.frag")})},Ai=r=>Me({ID:r.id}),an={shaders:r=>({vertexShader:Ai(r)+ae("circle/circle.vert"),fragmentShader:Ai(r)+ae("circle/circle.frag")})},Si=r=>Me({ID:r.id,PATTERN:r.pattern}),on={shaders:r=>({vertexShader:Si(r)+ae("fill/fill.vert"),fragmentShader:Si(r)+ae("fill/fill.frag")})},Mi=r=>Me({ID:r.id}),ln={shaders:r=>({vertexShader:Mi(r)+ae("outline/outline.vert"),fragmentShader:Mi(r)+ae("outline/outline.frag")})},Oi=r=>Me({ID:r.id,SDF:r.sdf}),hn={shaders:r=>({vertexShader:Oi(r)+ae("icon/icon.vert"),fragmentShader:Oi(r)+ae("icon/icon.frag")})},Ci=r=>Me({ID:r.id,PATTERN:r.pattern,SDF:r.sdf}),un={shaders:r=>({vertexShader:Ci(r)+ae("line/line.vert"),fragmentShader:Ci(r)+ae("line/line.frag")})},Pi=r=>Me({ID:r.id}),cn={shaders:r=>({vertexShader:Pi(r)+ae("text/text.vert"),fragmentShader:Pi(r)+ae("text/text.frag")})};class dn{constructor(){this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getMaterialProgram(e,t,i){const s=t.key<<3|this._getMaterialOptionsValue(t.type,i);if(this._programByKey.has(s))return this._programByKey.get(s);const n=this._getProgramTemplate(t.type),{shaders:a}=n,{vertexShader:o,fragmentShader:l}=a(i),h=t.getShaderHeader(),c=t.getShaderMain(),u=o.replace("#pragma header",h).replace("#pragma main",c),_=e.programCache.acquire(u,l,t.getAttributeLocations());return this._programByKey.set(s,_),_}_getMaterialOptionsValue(e,t){switch(e){case J.BACKGROUND:{const i=t;return(i.pattern?1:0)<<1|(i.id?1:0)}case J.FILL:{const i=t;return(i.pattern?1:0)<<1|(i.id?1:0)}case J.OUTLINE:return t.id?1:0;case J.LINE:{const i=t;return(i.sdf?1:0)<<2|(i.pattern?1:0)<<1|(i.id?1:0)}case J.ICON:{const i=t;return(i.sdf?1:0)<<1|(i.id?1:0)}case J.CIRCLE:return t.id?1:0;case J.TEXT:return t.id?1:0;default:return 0}}_getProgramTemplate(e){switch(e){case J.BACKGROUND:return nn;case J.CIRCLE:return an;case J.FILL:return on;case J.ICON:return hn;case J.LINE:return un;case J.OUTLINE:return ln;case J.TEXT:return cn;default:return null}}}const Di={shaders:{vertexShader:ne("bitBlit/bitBlit.vert"),fragmentShader:ne("bitBlit/bitBlit.frag")},attributes:new Map([["a_pos",0],["a_tex",1]])};class cs{constructor(){this._initialized=!1}dispose(){this._program=ie(this._program),this._vertexArrayObject=ie(this._vertexArrayObject)}render(e,t,i,s){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(A.ONE,A.ONE_MINUS_SRC_ALPHA,A.ONE,A.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),e.drawArrays(re.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const t=ct(e,Di);if(!t)return!1;const i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;const s=Di.attributes,n=new Le(e,s,Sr,{geometry:$e.createVertex(e,ze.STATIC_DRAW,i)});return this._program=t,this._vertexArrayObject=n,this._initialized=!0,!0}}const _n=r=>{let e="";e+=r[0].toUpperCase();for(let t=1;t<r.length;t++){const i=r[t];i===i.toUpperCase()?(e+="_",e+=i):e+=i.toUpperCase()}return e},fn=r=>{const e={};for(const t in r)e[_n(t)]=r[t];return Me(e)},Ii=(r,e,t,i)=>{const s=r+r.substring(r.lastIndexOf("/")),n=e+e.substring(e.lastIndexOf("/")),a=fn(i);return{attributes:t,shaders:{vertexShader:a+ne(`${s}.vert`),fragmentShader:a+ne(`${n}.frag`)}}},ds=r=>r===se.HITTEST||r===se.LABEL_ALPHA,mn=r=>(ds(r)?1:0)|(r===se.HIGHLIGHT?2:0),pn=({rendererInfo:r,drawPhase:e},t,i,s)=>`${t.getVariationHash()}-${s.join(".")}-${mn(e)}-${r.getVariationHash()}-${D(i)&&i.join(".")}`,gn=(r,e,t,i)=>{const s=i.reduce((a,o)=>({...a,[o]:r.context.driverTest[o]}),{}),n={...e.getVariation(),...r.rendererInfo.getVariation(),highlight:r.drawPhase===se.HIGHLIGHT,id:ds(r.drawPhase),...s};if(D(t))for(const a of t)n[a]=!0;return n};class bn{constructor(e){this._rctx=e,this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getProgram(e,t=[],i=[]){const s=e.vsPath+"."+e.fsPath+JSON.stringify(t)+i.join(".");if(this._programByKey.has(s))return this._programByKey.get(s);const n=i.reduce((_,f)=>({..._,[f]:this._rctx.driverTest[f]}),{}),a={...t.map(_=>typeof _=="string"?{name:_,value:!0}:_).reduce((_,f)=>({..._,[f.name]:f.value}),{}),...n},{vsPath:o,fsPath:l,attributes:h}=e,c=Ii(o,l,h,a),u=this._rctx.programCache.acquire(c.shaders.vertexShader,c.shaders.fragmentShader,c.attributes);if(!u)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,u),u}getMaterialProgram(e,t,i,s,n,a=["ignoresSamplerPrecision"]){const o=pn(e,t,n,a);if(this._programByKey.has(o))return this._programByKey.get(o);const l=gn(e,t,n,a),h=Ii(i,i,s,l),c=this._rctx.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!c)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(o,c),c}}class St{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new ce(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new ce;let i=null,s=-1;for(let n=0;n<this._free.length;++n){const a=this._free[n];e<=a.width&&t<=a.height&&(i===null||a.y<=i.y&&a.x<=i.x)&&(i=a,s=n)}return i===null?new ce:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new ce(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new ce(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new ce(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new ce(i.x,i.y+t,e,i.height-t))),new ce(i.x,i.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}const vn=256,En=r=>Math.floor(r/256);function xn(r){const e=new Set;for(const t of r)e.add(En(t));return e}function yn(r,e,t){return r.has(e)||r.set(e,t().then(()=>{r.delete(e)}).catch(i=>{r.delete(e),Os(i)})),r.get(e)}const Tn=r=>({rect:new ce(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:r,sdf:!0});class wn{constructor(e,t,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=e,this.height=t,this._glyphSource=i,this._binPack=new St(e-4,t-4),this._glyphData.push(new Uint8Array(e*t)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyph(){const e=[117,149,181,207,207,181,149,117],t=[];for(let s=0;s<e.length;s++){const n=e[s];for(let a=0;a<11;a++)t.push(n)}const i={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(i)}async getGlyphItems(e,t,i){const s=this._getGlyphCache(e);return await this._fetchRanges(e,t,i),t.map(n=>this._getMosaicItem(s,e,n))}bind(e,t,i,s){const n=this._getTexture(e,i);n.setSamplingMode(t),this._dirties[i]&&(n.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(n,s)}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_getTexture(e,t){return this._textures[t]||(this._textures[t]=new K(e,{pixelFormat:F.ALPHA,dataType:M.UNSIGNED_BYTE,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}_invalidate(){this._dirties[this._currentPage]=!0}async _fetchRanges(e,t,i){const s=xn(t),n=[];s.forEach(a=>{n.push(this._fetchRange(e,a,i))}),await Promise.all(n)}async _fetchRange(e,t,i){if(t>vn)return null;const s=e+t;return yn(this._rangePromises,s,()=>this._glyphSource.getRange(e,t,i))}_getMosaicItem(e,t,i){if(!e[i]){const s=this._glyphSource.getGlyph(t,i);if(!s||!s.metrics)return Tn(i);const n=this._recordGlyph(s),a=this._currentPage,o=s.metrics;e[i]={rect:n,page:a,metrics:o,code:i,sdf:!0},this._invalidate()}return e[i]}_recordGlyph(e){const t=e.metrics;let i;if(t.width===0)i=new ce(0,0,0,0);else{const n=t.width+6,a=t.height+2*3;i=this._binPack.allocate(n,a),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new St(this.width-4,this.height-4),i=this._binPack.allocate(n,a));const o=this._glyphData[this._currentPage],l=e.bitmap;let h,c;if(l)for(let u=0;u<a;u++){h=n*u,c=this.width*(i.y+u)+i.x;for(let _=0;_<n;_++)o[c+_]=l[h+_]}Bt("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(e){const t=document.createElement("canvas"),i=t.getContext("2d"),s=new ImageData(this.width,this.height),n=s.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(let a=0;a<e.length;++a)n[4*a+0]=e[a],n[4*a+1]=0,n[4*a+2]=0,n[4*a+3]=255;i.putImageData(s,0,0),document.body.appendChild(t)}}class Fn{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const t=e.getMessage();for(;t.next();)switch(t.tag()){case 3:{const i=t.getMessage();let s,n,a,o,l,h,c;for(;i.next();)switch(i.tag()){case 1:s=i.getUInt32();break;case 2:n=i.getBytes();break;case 3:a=i.getUInt32();break;case 4:o=i.getUInt32();break;case 5:l=i.getSInt32();break;case 6:h=i.getSInt32();break;case 7:c=i.getUInt32();break;default:i.skip()}i.release(),s&&(this._metrics[s]={width:a,height:o,left:l,top:h,advance:c},this._bitmaps[s]=n);break}default:t.skip()}t.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class Rn{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,t){this._ranges[e]=t}}class Bn{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,t,i){const s=this._getFontStack(e);if(s.getRange(t))return Promise.resolve();const n=256*t,a=n+255,o=this._baseURL.replace("{fontstack}",e).replace("{range}",n+"-"+a);return lt(o,{responseType:"array-buffer",...i}).then(l=>{s.addRange(t,new Fn(new Cs(new Uint8Array(l.data),new DataView(l.data))))})}getGlyph(e,t){const i=this._getFontStack(e);if(!i)return;const s=Math.floor(t/256);if(s>256)return;const n=i.getRange(s);return n?{metrics:n.getMetrics(t),bitmap:n.getBitmap(t)}:void 0}_getFontStack(e){let t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new Rn),t}}const Ke=1e20;class An{constructor(e){this.size=e;const t=document.createElement("canvas");t.width=t.height=e,this._context=t.getContext("2d"),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,t,i=31){this._initSVG();const s=this.createSVGString(e);return new Promise((n,a)=>{const o=new Image;o.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(s),o.onload=()=>{o.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(o,0,0,this.size,this.size);const h=this._context.getImageData(0,0,this.size,this.size),c=new Uint8Array(this.size*this.size*4);for(let u=0;u<this.size*this.size;u++){const _=h.data[4*u+3]/255;this._gridOuter[u]=_===1?0:_===0?Ke:Math.max(0,.5-_)**2,this._gridInner[u]=_===1?Ke:_===0?0:Math.max(0,_-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let u=0;u<this.size*this.size;u++){const _=this._gridOuter[u]-this._gridInner[u];pr(.5-_/(2*i),c,4*u)}n(c)};const l=t&&t.signal;l&&Ps(l,()=>a(Ds()))})}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}createSVGString(e){this._initSVG();const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);const i=t.getBBox(),s=i.width/i.height,n=this.size/2;let a,o,l,h;if(s>1){o=a=n/i.width;const f=n*(1/s);l=this.size/4,h=n-f/2}else a=o=n/i.height,l=n-n*s/2,h=this.size/4;const c=-i.x*a+l,u=-i.y*o+h;t.setAttribute("style",`transform: matrix(${a}, 0, 0, ${o}, ${c}, ${u})`);const _=`<svg style="fill:red;" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${this._svg.innerHTML}</svg>`;return this._svg.removeChild(t),_}_edt(e,t,i){const s=this._f,n=this._d,a=this._v,o=this._z;for(let l=0;l<t;l++){for(let h=0;h<i;h++)s[h]=e[h*t+l];this._edt1d(s,n,a,o,i);for(let h=0;h<i;h++)e[h*t+l]=n[h]}for(let l=0;l<i;l++){for(let h=0;h<t;h++)s[h]=e[l*t+h];this._edt1d(s,n,a,o,t);for(let h=0;h<t;h++)e[l*t+h]=Math.sqrt(n[h])}}_edt1d(e,t,i,s,n){i[0]=0,s[0]=-Ke,s[1]=+Ke;for(let a=1,o=0;a<n;a++){let l=(e[a]+a*a-(e[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);for(;l<=s[o];)o--,l=(e[a]+a*a-(e[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);o++,i[o]=a,s[o]=l,s[o+1]=+Ke}for(let a=0,o=0;a<n;a++){for(;s[o+1]<a;)o++;t[a]=(a-i[o])*(a-i[o])+e[i[o]]}}}function Ce(r){return r&&r.type==="static"}class ei{constructor(e,t,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||t<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=t,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new St(this._pageWidth,this._pageHeight);const s=Math.floor(this._pageWidth),n=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*n)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,t,i,s,n,a){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let o,l,h;if(Ce(i))[o,l,h]=this._allocateImage(t[0],t[1]);else{o=new ce(0,0,t[0],t[1]),l=this._mosaicPages.length;const u=void 0;this._mosaicPages.push({mosaicsData:i,size:[t[0]+2*Ee,t[1]+2*Ee],dirty:!0,texture:u})}if(o.width<=0||o.height<=0)return null;const c={rect:o,width:t[0],height:t[1],sdf:n,simplePattern:a,pixelRatio:1,page:l};return this._mosaicRects.set(e,c),Ce(i)&&this._copy({rect:o,spriteSize:t,spriteData:i.data,page:l,pageSize:h,repeat:s,sdf:n}),c}hasItemsToProcess(){return this._spriteCopyQueue.length!==0}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getSpriteItems(e){const t={};for(const i of e)t[i]=this.getSpriteItem(i);return t}getMosaicItemPosition(e){const t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;const s=t.width,n=t.height,a=Ee,o=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+a)/o[0],(i.y+a)/o[1]],br:[(i.x+a+s)/o[0],(i.y+a+n)/o[1]],page:t.page}}bind(e,t,i=0,s=0){const n=this._mosaicPages[i],a=n.mosaicsData;let o=n.texture;o||(o=Sn(e,a,n.size),n.texture=o),o.setSamplingMode(t),Ce(a)?(e.bindTexture(o,s),n.dirty&&(o.setData(new Uint8Array(a.data.buffer)),o.generateMipmap())):a.data.bindFrame(e,o,s),n.dirty=!1}static _copyBits(e,t,i,s,n,a,o,l,h,c,u){let _=s*t+i,f=l*a+o;if(u){f-=a;for(let m=-1;m<=c;m++,_=((m+c)%c+s)*t+i,f+=a)for(let d=-1;d<=h;d++)n[f+d]=e[_+(d+h)%h]}else for(let m=0;m<c;m++){for(let d=0;d<h;d++)n[f+d]=e[_+d];_+=t,f+=a}}_copy(e){if(e.page>=this._mosaicPages.length)return;const t=this._mosaicPages[e.page],i=t.mosaicsData;if(!Ce(t.mosaicsData))throw new H("mapview-invalid-resource","unsuitable data type!");const s=e.spriteData,n=i.data;n&&s||console.error("Source or target images are uninitialized!"),ei._copyBits(s,e.spriteSize[0],0,0,n,e.pageSize[0],e.rect.x+Ee,e.rect.y+Ee,e.spriteSize[0],e.spriteSize[1],e.repeat),t.dirty=!0}_allocateImage(e,t){e+=2*Ee,t+=2*Ee;const i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){const n=2**Math.ceil(Ti(e)),a=2**Math.ceil(Ti(t)),o=new ce(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*a)},size:[n,a],dirty:!0,texture:void 0}),[o,this._mosaicPages.length-1,[n,a]]}const s=this._binPack.allocate(e,t);if(s.width<=0){const n=this._mosaicPages[this._currentPage];return!n.dirty&&Ce(n.mosaicsData)&&(n.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new St(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}dispose(){this._binPack=null;for(const e of this._mosaicPages){const t=e.texture;t&&t.dispose();const i=e.mosaicsData;Ce(i)||i.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}}function Sn(r,e,t){return Ce(e)?new K(r,{pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,width:t[0],height:t[1]},new Uint8Array(e.data.buffer)):new K(r,{pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,samplingMode:S.LINEAR,wrapMode:U.CLAMP_TO_EDGE,width:t[0],height:t[1]},null)}function _s(r){return te(r.frameDurations.reduce((e,t)=>e+t,0))}function Mn(r){const{width:e,height:t}=r;return{frameDurations:r.frameDurations.reverse(),selectFrame:i=>{const s=r.frameDurations.length-1-i;r.selectFrame(s)},width:e,height:t}}function On(r,e){const{width:t,height:i,selectFrame:s}=r,n=e/_s(r);return{frameDurations:r.frameDurations.map(a=>te(a*n)),selectFrame:s,width:t,height:i}}function Cn(r,e){const{width:t,height:i,selectFrame:s}=r,n=r.frameDurations.slice(),a=n.shift();return n.unshift(te(a+e)),{frameDurations:n,selectFrame:s,width:t,height:i}}function Ui(r,e){const{width:t,height:i,selectFrame:s}=r,n=r.frameDurations.slice(),a=n.pop();return n.push(te(a+e)),{frameDurations:n,selectFrame:s,width:t,height:i}}class Pn{constructor(e,t,i){this._animation=e,this._repeatType=i,this._direction=1,this._currentFrame=0,this.timeToFrame=this._animation.frameDurations[this._currentFrame];let s=0;for(;t>s;)s+=this.timeToFrame,this.nextFrame();this._animation.selectFrame(this._currentFrame)}nextFrame(){if(this._currentFrame+=this._direction,this._direction>0){if(this._currentFrame===this._animation.frameDurations.length)switch(this._repeatType){case xe.None:this._currentFrame-=this._direction;break;case xe.Loop:this._currentFrame=0;break;case xe.Oscillate:this._currentFrame-=this._direction,this._direction=-1}}else if(this._currentFrame===-1)switch(this._repeatType){case xe.None:this._currentFrame-=this._direction;break;case xe.Loop:this._currentFrame=this._animation.frameDurations.length-1;break;case xe.Oscillate:this._currentFrame-=this._direction,this._direction=1}this.timeToFrame=this._animation.frameDurations[this._currentFrame],this._animation.selectFrame(this._currentFrame)}}function Dn(r,e,t){let i,{repeatType:s}=e;if(s==null&&(s=xe.Loop),e.reverseAnimation===!0&&(r=Mn(r)),e.duration!=null&&(r=On(r,te(1e3*e.duration))),e.repeatDelay!=null){const n=1e3*e.repeatDelay;s===xe.Loop?r=Ui(r,te(n)):s===xe.Oscillate&&(r=Cn(Ui(r,te(n/2)),te(n/2)))}if(e.startTimeOffset!=null)i=te(1e3*e.startTimeOffset);else if(e.randomizeStartTime!=null){const n=Lr(t),a=82749913,o=e.randomizeStartSeed!=null?e.randomizeStartSeed:a,l=$r(n,o);i=te(l*_s(r))}else i=te(0);return new Pn(r,i,s)}function In(r,e,t){const i=e.playAnimation==null||e.playAnimation,s=Dn(r,e,t);let n,a=s.timeToFrame;function o(){n=i&&setTimeout(()=>{s.nextFrame(),a=s.timeToFrame,o()},a)}return o(),{remove:()=>{i&&clearTimeout(n)}}}class fs{constructor(e){this._requestRender=e,this._frameData=null}destroy(){this._playHandle.remove()}bindFrame(e,t,i){e.bindTexture(t,i),P(this._frameData)||(t.updateData(0,Ee,Ee,this._frameData.width,this._frameData.height,this._frameData),this._frameData=null)}async _load(e,t,i,s){try{const n=o=>{this._frameData=o,this._requestRender.requestRender()},a=await this._loadAnimation(e,n,s);this.frameCount=a.frameDurations.length,this.width=a.width,this.height=a.height,this._playHandle=In(a,t,i)}catch(n){if(!Be(n))return new H("invalid-resource","Could not parse animated resource.")}}}var Ni,ms={exports:{}};Ni=function(){return function(r){var e={};function t(i){if(e[i])return e[i].exports;var s=e[i]={exports:{},id:i,loaded:!1};return r[i].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}return t.m=r,t.c=e,t.p="",t(0)}([function(r,e,t){Object.defineProperty(e,"__esModule",{value:!0}),e.isNotPNG=l,e.isNotAPNG=h,e.default=u;var i=n(t(1)),s=t(2);function n(p){return p&&p.__esModule?p:{default:p}}var a=new Error("Not a PNG"),o=new Error("Not an animated PNG");function l(p){return p===a}function h(p){return p===o}var c=new Uint8Array([137,80,78,71,13,10,26,10]);function u(p){var E=new Uint8Array(p);if(Array.prototype.some.call(c,function(k,V){return k!==E[V]}))return a;var b=!1;if(_(E,function(k){return!(b=k==="acTL")}),!b)return o;var y=[],v=[],R=null,T=null,L=0,G=new s.APNG;if(_(E,function(k,V,N,Oe){var oe=new DataView(V.buffer);switch(k){case"IHDR":R=V.subarray(N+8,N+8+Oe),G.width=oe.getUint32(N+8),G.height=oe.getUint32(N+12);break;case"acTL":G.numPlays=oe.getUint32(N+8+4);break;case"fcTL":T&&(G.frames.push(T),L++),(T=new s.Frame).width=oe.getUint32(N+8+4),T.height=oe.getUint32(N+8+8),T.left=oe.getUint32(N+8+12),T.top=oe.getUint32(N+8+16);var me=oe.getUint16(N+8+20),qe=oe.getUint16(N+8+22);qe===0&&(qe=100),T.delay=1e3*me/qe,T.delay<=10&&(T.delay=100),G.playTime+=T.delay,T.disposeOp=oe.getUint8(N+8+24),T.blendOp=oe.getUint8(N+8+25),T.dataParts=[],L===0&&T.disposeOp===2&&(T.disposeOp=1);break;case"fdAT":T&&T.dataParts.push(V.subarray(N+8+4,N+8+Oe));break;case"IDAT":T&&T.dataParts.push(V.subarray(N+8,N+8+Oe));break;case"IEND":v.push(d(V,N,12+Oe));break;default:y.push(d(V,N,12+Oe))}}),T&&G.frames.push(T),G.frames.length==0)return o;var he=new Blob(y),ue=new Blob(v);return G.frames.forEach(function(k){var V=[];V.push(c),R.set(x(k.width),0),R.set(x(k.height),4),V.push(g("IHDR",R)),V.push(he),k.dataParts.forEach(function(N){return V.push(g("IDAT",N))}),V.push(ue),k.imageData=new Blob(V,{type:"image/png"}),delete k.dataParts,V=null}),G}function _(p,E){var b=new DataView(p.buffer),y=8,v=void 0,R=void 0,T=void 0;do R=b.getUint32(y),T=E(v=f(p,y+4,4),p,y,R),y+=12+R;while(T!==!1&&v!="IEND"&&y<p.length)}function f(p,E,b){var y=Array.prototype.slice.call(p.subarray(E,E+b));return String.fromCharCode.apply(String,y)}function m(p){for(var E=new Uint8Array(p.length),b=0;b<p.length;b++)E[b]=p.charCodeAt(b);return E}function d(p,E,b){var y=new Uint8Array(b);return y.set(p.subarray(E,E+b)),y}var g=function(p,E){var b=p.length+E.length,y=new Uint8Array(b+8),v=new DataView(y.buffer);v.setUint32(0,E.length),y.set(m(p),4),y.set(E,8);var R=(0,i.default)(y,4,b);return v.setUint32(b+4,R),y},x=function(p){return new Uint8Array([p>>>24&255,p>>>16&255,p>>>8&255,255&p])}},function(r,e){Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(a){for(var o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,l=-1,h=o,c=o+(arguments.length>2&&arguments[2]!==void 0?arguments[2]:a.length-o);h<c;h++)l=l>>>8^t[255&(l^a[h])];return-1^l};for(var t=new Uint32Array(256),i=0;i<256;i++){for(var s=i,n=0;n<8;n++)s=(1&s)!=0?3988292384^s>>>1:s>>>1;t[i]=s}},function(r,e,t){Object.defineProperty(e,"__esModule",{value:!0}),e.Frame=e.APNG=void 0;var i=function(){function o(l,h){for(var c=0;c<h.length;c++){var u=h[c];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(l,u.key,u)}}return function(l,h,c){return h&&o(l.prototype,h),c&&o(l,c),l}}(),s=n(t(3));function n(o){return o&&o.__esModule?o:{default:o}}function a(o,l){if(!(o instanceof l))throw new TypeError("Cannot call a class as a function")}e.APNG=function(){function o(){a(this,o),this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[]}return i(o,[{key:"createImages",value:function(){return Promise.all(this.frames.map(function(l){return l.createImage()}))}},{key:"getPlayer",value:function(l){var h=this,c=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return this.createImages().then(function(){return new s.default(h,l,c)})}}]),o}(),e.Frame=function(){function o(){a(this,o),this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.imageData=null,this.imageElement=null}return i(o,[{key:"createImage",value:function(){var l=this;return this.imageElement?Promise.resolve():new Promise(function(h,c){var u=URL.createObjectURL(l.imageData);l.imageElement=document.createElement("img"),l.imageElement.onload=function(){URL.revokeObjectURL(u),h()},l.imageElement.onerror=function(){URL.revokeObjectURL(u),l.imageElement=null,c(new Error("Image creation error"))},l.imageElement.src=u})}}]),o}()},function(r,e,t){Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function h(c,u){for(var _=0;_<u.length;_++){var f=u[_];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(c,f.key,f)}}return function(c,u,_){return u&&h(c.prototype,u),_&&h(c,_),c}}();function s(h){return h&&h.__esModule?h:{default:h}}function n(h,c){if(!(h instanceof c))throw new TypeError("Cannot call a class as a function")}function a(h,c){if(!h)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!c||typeof c!="object"&&typeof c!="function"?h:c}function o(h,c){if(typeof c!="function"&&c!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof c);h.prototype=Object.create(c&&c.prototype,{constructor:{value:h,enumerable:!1,writable:!0,configurable:!0}}),c&&(Object.setPrototypeOf?Object.setPrototypeOf(h,c):h.__proto__=c)}var l=function(h){function c(u,_,f){n(this,c);var m=a(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return m.playbackRate=1,m._currentFrameNumber=0,m._ended=!1,m._paused=!0,m._numPlays=0,m._apng=u,m.context=_,m.stop(),f&&m.play(),m}return o(c,h),i(c,[{key:"renderNextFrame",value:function(){this._currentFrameNumber=(this._currentFrameNumber+1)%this._apng.frames.length,this._currentFrameNumber===this._apng.frames.length-1&&(this._numPlays++,this._apng.numPlays!==0&&this._numPlays>=this._apng.numPlays&&(this._ended=!0,this._paused=!0)),this._prevFrame&&this._prevFrame.disposeOp==1?this.context.clearRect(this._prevFrame.left,this._prevFrame.top,this._prevFrame.width,this._prevFrame.height):this._prevFrame&&this._prevFrame.disposeOp==2&&this.context.putImageData(this._prevFrameData,this._prevFrame.left,this._prevFrame.top);var u=this.currentFrame;this._prevFrame=u,this._prevFrameData=null,u.disposeOp==2&&(this._prevFrameData=this.context.getImageData(u.left,u.top,u.width,u.height)),u.blendOp==0&&this.context.clearRect(u.left,u.top,u.width,u.height),this.context.drawImage(u.imageElement,u.left,u.top),this.emit("frame",this._currentFrameNumber),this._ended&&this.emit("end")}},{key:"play",value:function(){var u=this;this.emit("play"),this._ended&&this.stop(),this._paused=!1;var _=performance.now()+this.currentFrame.delay/this.playbackRate,f=function m(d){if(!u._ended&&!u._paused){if(d>=_){for(;d-_>=u._apng.playTime/u.playbackRate;)_+=u._apng.playTime/u.playbackRate,u._numPlays++;do u.renderNextFrame(),_+=u.currentFrame.delay/u.playbackRate;while(!u._ended&&d>_)}requestAnimationFrame(m)}};requestAnimationFrame(f)}},{key:"pause",value:function(){this._paused||(this.emit("pause"),this._paused=!0)}},{key:"stop",value:function(){this.emit("stop"),this._numPlays=0,this._ended=!1,this._paused=!0,this._currentFrameNumber=-1,this.context.clearRect(0,0,this._apng.width,this._apng.height),this.renderNextFrame()}},{key:"currentFrameNumber",get:function(){return this._currentFrameNumber}},{key:"currentFrame",get:function(){return this._apng.frames[this._currentFrameNumber]}},{key:"paused",get:function(){return this._paused}},{key:"ended",get:function(){return this._ended}}]),c}(s(t(4)).default);e.default=l},function(r,e){function t(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(o){return typeof o=="function"}function s(o){return typeof o=="number"}function n(o){return typeof o=="object"&&o!==null}function a(o){return o===void 0}r.exports=t,t.EventEmitter=t,t.prototype._events=void 0,t.prototype._maxListeners=void 0,t.defaultMaxListeners=10,t.prototype.setMaxListeners=function(o){if(!s(o)||o<0||isNaN(o))throw TypeError("n must be a positive number");return this._maxListeners=o,this},t.prototype.emit=function(o){var l,h,c,u,_,f;if(this._events||(this._events={}),o==="error"&&(!this._events.error||n(this._events.error)&&!this._events.error.length)){if((l=arguments[1])instanceof Error)throw l;var m=new Error('Uncaught, unspecified "error" event. ('+l+")");throw m.context=l,m}if(a(h=this._events[o]))return!1;if(i(h))switch(arguments.length){case 1:h.call(this);break;case 2:h.call(this,arguments[1]);break;case 3:h.call(this,arguments[1],arguments[2]);break;default:u=Array.prototype.slice.call(arguments,1),h.apply(this,u)}else if(n(h))for(u=Array.prototype.slice.call(arguments,1),c=(f=h.slice()).length,_=0;_<c;_++)f[_].apply(this,u);return!0},t.prototype.addListener=function(o,l){var h;if(!i(l))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",o,i(l.listener)?l.listener:l),this._events[o]?n(this._events[o])?this._events[o].push(l):this._events[o]=[this._events[o],l]:this._events[o]=l,n(this._events[o])&&!this._events[o].warned&&(h=a(this._maxListeners)?t.defaultMaxListeners:this._maxListeners)&&h>0&&this._events[o].length>h&&(this._events[o].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[o].length),typeof console.trace=="function"&&console.trace()),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(o,l){if(!i(l))throw TypeError("listener must be a function");var h=!1;function c(){this.removeListener(o,c),h||(h=!0,l.apply(this,arguments))}return c.listener=l,this.on(o,c),this},t.prototype.removeListener=function(o,l){var h,c,u,_;if(!i(l))throw TypeError("listener must be a function");if(!this._events||!this._events[o])return this;if(u=(h=this._events[o]).length,c=-1,h===l||i(h.listener)&&h.listener===l)delete this._events[o],this._events.removeListener&&this.emit("removeListener",o,l);else if(n(h)){for(_=u;_-- >0;)if(h[_]===l||h[_].listener&&h[_].listener===l){c=_;break}if(c<0)return this;h.length===1?(h.length=0,delete this._events[o]):h.splice(c,1),this._events.removeListener&&this.emit("removeListener",o,l)}return this},t.prototype.removeAllListeners=function(o){var l,h;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[o]&&delete this._events[o],this;if(arguments.length===0){for(l in this._events)l!=="removeListener"&&this.removeAllListeners(l);return this.removeAllListeners("removeListener"),this._events={},this}if(i(h=this._events[o]))this.removeListener(o,h);else if(h)for(;h.length;)this.removeListener(o,h[h.length-1]);return delete this._events[o],this},t.prototype.listeners=function(o){return this._events&&this._events[o]?i(this._events[o])?[this._events[o]]:this._events[o].slice():[]},t.prototype.listenerCount=function(o){if(this._events){var l=this._events[o];if(i(l))return 1;if(l)return l.length}return 0},t.listenerCount=function(o,l){return o.listenerCount(l)}}])},ms.exports=Ni();const Un=Hr(ms.exports);class ti extends fs{static async create(e,t,i,s,n){const a=new ti(s);try{await a._load(e,t,i,n)}catch(o){if(!Be(o))return new H("invalid-resource",`Could not load PNG: ${o.message}`)}return a}async _loadAnimation(e,t,i){return Nn(e,t,i)}}async function Nn(r,e,t){const i=Un(r);if(i instanceof Error)throw i;await i.createImages(),Qt(t);const{frames:s,width:n,height:a}=i,o=document.createElement("canvas");o.width=n,o.height=a;const l=o.getContext("2d"),h=[],c=[];for(const u of s){c.push(te(u.delay));const _=u.imageElement;u.blendOp===0?l.globalCompositeOperation="copy":l.globalCompositeOperation="source-over";const f=u.disposeOp===2&&l.getImageData(u.left,u.top,u.width,u.height);l.drawImage(_,u.left,u.top);const m=l.getImageData(0,0,n,a);h.push(m),u.disposeOp===0||(u.disposeOp===1?l.clearRect(u.left,u.top,u.width,u.height):u.disposeOp===2&&l.putImageData(f,u.left,u.top))}return{frameDurations:c,selectFrame:u=>{const _=h[u];e(_)},width:n,height:a}}const Ln=[137,80,78,71,13,10,26,10];function ps(r){const e=new Uint8Array(r);return!Ln.some((t,i)=>t!==e[i])}function $n(r){if(!ps(r))return!1;const e=new DataView(r),t=new Uint8Array(r);let i,s=8;do{const n=e.getUint32(s);if(i=String.fromCharCode.apply(String,Array.prototype.slice.call(t.subarray(s+4,s+8))),i==="acTL")return!0;s+=12+n}while(i!=="IEND"&&s<t.length);return!1}var Ue={},gs={},ye={};Object.defineProperty(ye,"__esModule",{value:!0}),ye.loop=ye.conditional=ye.parse=void 0;var zn=function r(e,t){var i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:i;if(Array.isArray(t))t.forEach(function(a){return r(e,a,i,s)});else if(typeof t=="function")t(e,i,s,r);else{var n=Object.keys(t)[0];Array.isArray(t[n])?(s[n]={},r(e,t[n],i,s[n])):s[n]=t[n](e,i,s,r)}return i};ye.parse=zn;var kn=function(r,e){return function(t,i,s,n){e(t,i,s)&&n(t,r,i,s)}};ye.conditional=kn;var Gn=function(r,e){return function(t,i,s,n){for(var a=[],o=t.pos;e(t,i,s);){var l={};if(n(t,r,i,l),t.pos===o)break;o=t.pos,a.push(l)}return a}};ye.loop=Gn;var $={};Object.defineProperty($,"__esModule",{value:!0}),$.readBits=$.readArray=$.readUnsigned=$.readString=$.peekBytes=$.readBytes=$.peekByte=$.readByte=$.buildStream=void 0;var Vn=function(r){return{data:r,pos:0}};$.buildStream=Vn;var bs=function(){return function(r){return r.data[r.pos++]}};$.readByte=bs;var Wn=function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return function(e){return e.data[e.pos+r]}};$.peekByte=Wn;var Dt=function(r){return function(e){return e.data.subarray(e.pos,e.pos+=r)}};$.readBytes=Dt;var Xn=function(r){return function(e){return e.data.subarray(e.pos,e.pos+r)}};$.peekBytes=Xn;var Hn=function(r){return function(e){return Array.from(Dt(r)(e)).map(function(t){return String.fromCharCode(t)}).join("")}};$.readString=Hn;var qn=function(r){return function(e){var t=Dt(2)(e);return r?(t[1]<<8)+t[0]:(t[0]<<8)+t[1]}};$.readUnsigned=qn;var jn=function(r,e){return function(t,i,s){for(var n=typeof e=="function"?e(t,i,s):e,a=Dt(r),o=new Array(n),l=0;l<n;l++)o[l]=a(t);return o}};$.readArray=jn;var Yn=function(r,e,t){for(var i=0,s=0;s<t;s++)i+=r[e+s]&&Math.pow(2,t-s-1);return i},Kn=function(r){return function(e){for(var t=bs()(e),i=new Array(8),s=0;s<8;s++)i[7-s]=!!(t&1<<s);return Object.keys(r).reduce(function(n,a){var o=r[a];return o.length?n[a]=Yn(i,o.index,o.length):n[a]=i[o.index],n},{})}};$.readBits=Kn,function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.default=void 0;var e=ye,t=$,i={blocks:function(c){for(var u=0,_=[],f=c.data.length,m=0,d=(0,t.readByte)()(c);d!==u&&d;d=(0,t.readByte)()(c)){if(c.pos+d>=f){var g=f-c.pos;_.push((0,t.readBytes)(g)(c)),m+=g;break}_.push((0,t.readBytes)(d)(c)),m+=d}for(var x=new Uint8Array(m),p=0,E=0;E<_.length;E++)x.set(_[E],p),p+=_[E].length;return x}},s=(0,e.conditional)({gce:[{codes:(0,t.readBytes)(2)},{byteSize:(0,t.readByte)()},{extras:(0,t.readBits)({future:{index:0,length:3},disposal:{index:3,length:3},userInput:{index:6},transparentColorGiven:{index:7}})},{delay:(0,t.readUnsigned)(!0)},{transparentColorIndex:(0,t.readByte)()},{terminator:(0,t.readByte)()}]},function(c){var u=(0,t.peekBytes)(2)(c);return u[0]===33&&u[1]===249}),n=(0,e.conditional)({image:[{code:(0,t.readByte)()},{descriptor:[{left:(0,t.readUnsigned)(!0)},{top:(0,t.readUnsigned)(!0)},{width:(0,t.readUnsigned)(!0)},{height:(0,t.readUnsigned)(!0)},{lct:(0,t.readBits)({exists:{index:0},interlaced:{index:1},sort:{index:2},future:{index:3,length:2},size:{index:5,length:3}})}]},(0,e.conditional)({lct:(0,t.readArray)(3,function(c,u,_){return Math.pow(2,_.descriptor.lct.size+1)})},function(c,u,_){return _.descriptor.lct.exists}),{data:[{minCodeSize:(0,t.readByte)()},i]}]},function(c){return(0,t.peekByte)()(c)===44}),a=(0,e.conditional)({text:[{codes:(0,t.readBytes)(2)},{blockSize:(0,t.readByte)()},{preData:function(c,u,_){return(0,t.readBytes)(_.text.blockSize)(c)}},i]},function(c){var u=(0,t.peekBytes)(2)(c);return u[0]===33&&u[1]===1}),o=(0,e.conditional)({application:[{codes:(0,t.readBytes)(2)},{blockSize:(0,t.readByte)()},{id:function(c,u,_){return(0,t.readString)(_.blockSize)(c)}},i]},function(c){var u=(0,t.peekBytes)(2)(c);return u[0]===33&&u[1]===255}),l=(0,e.conditional)({comment:[{codes:(0,t.readBytes)(2)},i]},function(c){var u=(0,t.peekBytes)(2)(c);return u[0]===33&&u[1]===254}),h=[{header:[{signature:(0,t.readString)(3)},{version:(0,t.readString)(3)}]},{lsd:[{width:(0,t.readUnsigned)(!0)},{height:(0,t.readUnsigned)(!0)},{gct:(0,t.readBits)({exists:{index:0},resolution:{index:1,length:3},sort:{index:4},size:{index:5,length:3}})},{backgroundColorIndex:(0,t.readByte)()},{pixelAspectRatio:(0,t.readByte)()}]},(0,e.conditional)({gct:(0,t.readArray)(3,function(c,u){return Math.pow(2,u.lsd.gct.size+1)})},function(c,u){return u.lsd.gct.exists}),{frames:(0,e.loop)([s,o,l,n,a],function(c){var u=(0,t.peekByte)()(c);return u===33||u===44})}];r.default=h}(gs);var Mt={};Object.defineProperty(Mt,"__esModule",{value:!0}),Mt.deinterlace=void 0;var Zn=function(r,e){for(var t=new Array(r.length),i=r.length/e,s=function(c,u){var _=r.slice(u*e,(u+1)*e);t.splice.apply(t,[c*e,e].concat(_))},n=[0,4,2,1],a=[8,8,4,2],o=0,l=0;l<4;l++)for(var h=n[l];h<i;h+=a[l])s(h,o),o++;return t};Mt.deinterlace=Zn;var Ot={};Object.defineProperty(Ot,"__esModule",{value:!0}),Ot.lzw=void 0;var Qn=function(r,e,t){var i,s,n,a,o,l,h,c,u,_,f,m,d,g,x,p,E=4096,b=-1,y=t,v=new Array(t),R=new Array(E),T=new Array(E),L=new Array(E+1);for(o=(s=1<<(_=r))+1,i=s+2,h=b,n=(1<<(a=_+1))-1,c=0;c<s;c++)R[c]=0,T[c]=c;for(f=m=d=g=x=p=0,u=0;u<y;){if(g===0){if(m<a){f+=e[p]<<m,m+=8,p++;continue}if(c=f&n,f>>=a,m-=a,c>i||c==o)break;if(c==s){n=(1<<(a=_+1))-1,i=s+2,h=b;continue}if(h==b){L[g++]=T[c],h=c,d=c;continue}for(l=c,c==i&&(L[g++]=d,c=h);c>s;)L[g++]=T[c],c=R[c];d=255&T[c],L[g++]=d,i<E&&(R[i]=h,T[i]=d,(++i&n)==0&&i<E&&(a++,n+=i)),h=l}g--,v[x++]=L[g],u++}for(u=x;u<y;u++)v[u]=0;return v};Ot.lzw=Qn,Object.defineProperty(Ue,"__esModule",{value:!0});var vs=Ue.decompressFrames=Ue.decompressFrame=Es=Ue.parseGIF=void 0,Jn=ra(gs),ea=ye,ta=$,ia=Mt,sa=Ot;function ra(r){return r&&r.__esModule?r:{default:r}}var na=function(r){var e=new Uint8Array(r);return(0,ea.parse)((0,ta.buildStream)(e),Jn.default)},Es=Ue.parseGIF=na,aa=function(r){for(var e=r.pixels.length,t=new Uint8ClampedArray(4*e),i=0;i<e;i++){var s=4*i,n=r.pixels[i],a=r.colorTable[n]||[0,0,0];t[s]=a[0],t[s+1]=a[1],t[s+2]=a[2],t[s+3]=n!==r.transparentIndex?255:0}return t},xs=function(r,e,t){if(r.image){var i=r.image,s=i.descriptor.width*i.descriptor.height,n=(0,sa.lzw)(i.data.minCodeSize,i.data.blocks,s);i.descriptor.lct.interlaced&&(n=(0,ia.deinterlace)(n,i.descriptor.width));var a={pixels:n,dims:{top:r.image.descriptor.top,left:r.image.descriptor.left,width:r.image.descriptor.width,height:r.image.descriptor.height}};return i.descriptor.lct&&i.descriptor.lct.exists?a.colorTable=i.lct:a.colorTable=e,r.gce&&(a.delay=10*(r.gce.delay||10),a.disposalType=r.gce.extras.disposal,r.gce.extras.transparentColorGiven&&(a.transparentIndex=r.gce.transparentColorIndex)),t&&(a.patch=aa(a)),a}console.warn("gif frame does not have associated image.")};Ue.decompressFrame=xs;var oa=function(r,e){return r.frames.filter(function(t){return t.image}).map(function(t){return xs(t,r.gct,e)})};vs=Ue.decompressFrames=oa;class ii extends fs{static async create(e,t,i,s,n){const a=new ii(s);try{await a._load(e,t,i,n)}catch(o){if(!Be(o))return new H("invalid-resource",`Could not load GIF: ${o.message}`)}return a}async _loadAnimation(e,t,i){return la(e,t)}}async function la(r,e,t){const i=Es(r),s=vs(i,!0),{width:n,height:a}=i.lsd,o=document.createElement("canvas");o.width=n,o.height=a;const l=o.getContext("2d"),h=[],c=[];for(const u of s){c.push(te(u.delay));const _=new ImageData(u.patch,u.dims.width,u.dims.height),f=qr(_),m=u.disposalType===3&&l.getImageData(u.dims.left,u.dims.top,u.dims.width,u.dims.height);l.drawImage(f,u.dims.left,u.dims.top);const d=l.getImageData(0,0,n,a);h.push(d),u.disposalType===1||(u.disposalType===2?l.clearRect(u.dims.left,u.dims.top,u.dims.width,u.dims.height):u.disposalType===3&&l.putImageData(m,u.dims.left,u.dims.top))}return{frameDurations:c,selectFrame:u=>{const _=h[u];e(_)},width:n,height:a}}const ha=[71,73,70];function ys(r){const e=new Uint8Array(r);return!ha.some((t,i)=>t!==e[i])}function ua(r){if(!ys(r))return!1;const e=new DataView(r),t=e.getUint8(10);let i=13+(128&t?3*2**(1+(7&t)):0),s=0,n=!1;for(;!n;){switch(e.getUint8(i++)){case 33:if(!a())return!1;break;case 44:o();break;case 59:n=!0;break;default:return!1}if(s>1)return!0}function a(){switch(e.getUint8(i++)){case 249:l();break;case 1:h();break;case 254:c();break;case 255:u();break;default:return!1}return!0}function o(){s++,i+=8;const f=e.getUint8(i++);i+=128&f?3*2**(1+(7&f)):0,i++,_()}function l(){i++,i+=4,_()}function h(){s++,i++,i+=12,_()}function c(){_()}function u(){i++,i+=8,i+=3,_()}function _(){let f;for(;f=e.getUint8(i++);)i+=f}return!1}function ca(r){switch(r.type){case"esriSMS":return`${r.style}.${r.path}`;case"esriSLS":return`${r.style}.${r.cap}`;case"esriSFS":return`${r.style}`;case"esriPFS":case"esriPMS":return r.imageData?`${r.imageData}${r.width}${r.height}`:`${r.url}${r.width}${r.height}`;default:return"mosaicHash"in r?r.mosaicHash:JSON.stringify(r)}}const Li=Ns(),$i="arial-unicode-ms-regular",$t=126,Ts=ft.getLogger("esri.views.2d.engine.webgl.TextureManager");async function da(r,e){const t=as(r);let i;const s=";base64,";if(t.includes(s)){const n=t.indexOf(s)+s.length,a=t.substring(n),o=atob(a),l=new Uint8Array(o.length);for(let h=0;h<o.length;h++)l[h]=o.charCodeAt(h);i=l.buffer}else try{const{data:n}=await lt(t,{responseType:"array-buffer",...e});i=n}catch(n){if(!Be(n))return new H("mapview-invalid-resource",`Could not fetch requested resource at ${t}`)}return i}function zi(r,e){const t=Math.round(Ae(e)*window.devicePixelRatio),i=t>=128?2:4;return Math.min(r,t*i)}const zt=(r,e,t)=>Ts.error(new H(r,e,t));class si{constructor(e,t,i){this.mosaicType=e,this.page=t,this.sdf=i}static fromMosaic(e,t){return new si(e,t.page,t.sdf)}}class _a{constructor(e,t){this._requestRender=e,this.resourceManager=t,this._invalidFontsMap=new Map,this._sdfConverter=new An($t),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Is({concurrency:10,process:async(i,s)=>{Qt(s);try{return await lt(i,{responseType:"image",signal:s})}catch(n){throw Be(n)?n:new H("mapview-invalid-resource",`Could not fetch requested resource at ${i}`,n)}}}),this._spriteMosaic=new ei(2048,2048,500),this._glyphSource=new Bn(`${Us.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new wn(1024,1024,this._glyphSource),this._rasterizer=new en(t)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}async rasterizeItem(e,t,i,s){if(P(e))return zt("mapview-null-resource","Unable to rasterize null resource"),null;switch(e.type){case"text":case"esriTS":{const n=await this._rasterizeText(e,i,s);return n.forEach(a=>this._setTextureBinding(gt.GLYPH,a)),{glyphMosaicItems:n}}default:{if(xr(e))return zt("mapview-invalid-type",`MapView does not support symbol type: ${e.type}`,e),null;const n=await this._rasterizeSpriteSymbol(e,t,s);return Lt(n)&&n&&this._setTextureBinding(gt.SPRITE,n),{spriteMosaicItem:n}}}}bindTextures(e,t,i,s=!1){if(i.textureBinding===0)return;const n=this._bindingInfos[i.textureBinding-1],a=n.page,o=s?S.LINEAR_MIPMAP_LINEAR:S.LINEAR;switch(n.mosaicType){case gt.SPRITE:{const l=this.sprites.getWidth(a),h=this.sprites.getHeight(a),c=ht(Li,l,h);return this._spriteMosaic.bind(e,o,a,xi),t.setUniform1i("u_texture",xi),void t.setUniform2fv("u_mosaicSize",c)}case gt.GLYPH:{const l=this.glyphs.width,h=this.glyphs.height,c=ht(Li,l,h);return this._glyphMosaic.bind(e,o,a,Ei),t.setUniform1i("u_texture",Ei),void t.setUniform2fv("u_mosaicSize",c)}default:Ts.error("mapview-texture-manager",`Cannot handle unknown type ${n.mosaicType}`)}}_hashMosaic(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}_setTextureBinding(e,t){const i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){const s=si.fromMosaic(e,t),n=this._bindingInfos.length+1;this._hashToBindingIndex.set(i,n),this._bindingInfos.push(s)}t.textureBinding=this._hashToBindingIndex.get(i)}async _rasterizeText(e,t,i){let s,n;if("cim"in e){const l=e;s=l.fontName,n=l.text}else{const l=e;s=zr(l.font),n=l.text}const a=this._invalidFontsMap.has(s),o=t||yr(gr(n)[0]);try{return await this._glyphMosaic.getGlyphItems(a?$i:s,o,i)}catch{return zt("mapview-invalid-resource",`Couldn't find font ${s}. Falling back to Arial Unicode MS Regular`),this._invalidFontsMap.set(s,!0),this._glyphMosaic.getGlyphItems($i,o,i)}}async _rasterizeSpriteSymbol(e,t,i){if(Tr(e))return null;const s=ca(e);if(this._spriteMosaic.has(s))return this._spriteMosaic.getSpriteItem(s);if(mi(e)||wr(e)&&!Fr(e))return this._handleAsyncResource(s,e,i);const n=1,a=this._rasterizer.rasterizeJSONResource(e,n);if(a){const{size:o,image:l,sdf:h,simplePattern:c}=a;return this._addItemToMosaic(s,o,{type:"static",data:l},bt(e),h,c)}return new H("TextureManager","unrecognized or null rasterized image")}async _handleAsyncResource(e,t,i){if(this._ongoingRasterizations.has(e))return this._ongoingRasterizations.get(e);let s;s=mi(t)?this._handleSVG(t,e,i):this._handleImage(t,e,i),this._ongoingRasterizations.set(e,s);try{await s,this._ongoingRasterizations.delete(e)}catch{this._ongoingRasterizations.delete(e)}return s}async _handleSVG(e,t,i){const s=[$t,$t],n=await this._sdfConverter.draw(e.path,i);return this._addItemToMosaic(t,s,{type:"static",data:new Uint32Array(n.buffer)},!1,!0,!0)}async _handleGIFOrPNG(e,t,i){const s=await da(e,i);if(Lt(s)){const n=ys(s),a=ps(s);if(!n&&!a)return new H("mapview-invalid-resource","Image data is neither GIF nor PNG!");let o;try{const c=e.animatedSymbolProperties||{},u=e.objectId;n&&ua(s)?o=await ii.create(s,c,u,this._requestRender,i):a&&$n(s)&&(o=await ti.create(s,c,u,this._requestRender,i))}catch(c){if(!Be(c))return new H("mapview-invalid-resource","Could not fetch requested resource!")}if(o&&Lt(o))return this._addItemToMosaic(t,[o.width,o.height],{type:"animated",data:o},bt(e),!1,!1);const l=new Blob([s],{type:n?"image/gif":"image/png"}),h=await this._imageFromBlob(l);if(h&&h instanceof HTMLImageElement){let c=h.width,u=h.height;e.type==="esriPMS"&&(c=Math.round(zi(h.width,pi(e))),u=Math.round(h.height*(c/h.width)));const _="cim"in e?e.cim.colorSubstitutions:void 0,{size:f,sdf:m,image:d}=this._rasterizer.rasterizeImageResource(c,u,h,_);return this._addItemToMosaic(t,f,{type:"static",data:d},bt(e),m,!1)}}return new H("mapview-invalid-resource","Could not handle resource!")}async _handleImage(e,t,i){if(Rr(e)||Br(e))return this._handleGIFOrPNG(e,t,i);const s=as(e);try{let n;const a=this.resourceManager.getResource(s);if(D(a))n=a;else{const{data:f}=await this._imageRequestQueue.push(s,{...i});n=f}if(Ar(s)){if("width"in e&&"height"in e)n.width=Ae(e.width),n.height=Ae(e.height);else if("cim"in e){const f=e.cim;n.width=Ae(f.width??f.scaleX*f.size),n.height=Ae(f.size)}}if(!n.width||!n.height)return null;let o=n.width,l=n.height;e.type==="esriPMS"&&(o=Math.round(zi(n.width,pi(e))),l=Math.round(n.height*(o/n.width)));const h="cim"in e?e.cim.colorSubstitutions:void 0,{size:c,sdf:u,image:_}=this._rasterizer.rasterizeImageResource(o,l,n,h);return this._addItemToMosaic(t,c,{type:"static",data:_},bt(e),u,!1)}catch(n){if(!Be(n))return new H("mapview-invalid-resource",`Could not fetch requested resource at ${s}. ${n.message}`)}}async _imageFromBlob(e){const t=window.URL.createObjectURL(e);try{const{data:i}=await this._imageRequestQueue.push(t);return window.URL.revokeObjectURL(t),i}catch(i){if(window.URL.revokeObjectURL(t),!Be(i))return new H("mapview-invalid-resource",`Could not fetch requested resource at ${t}`);throw i}}_addItemToMosaic(e,t,i,s,n,a){return this._spriteMosaic.addSpriteItem(e,t,i,s,n,a)}}const fa={shaders:{vertexShader:ne("stencil/stencil.vert"),fragmentShader:ne("stencil/stencil.frag")},attributes:new Map([["a_pos",0]])},ma=ks(-.5,-.5);class pa{constructor(){this._centerNdc=st(),this._pxToNdc=st(),this._worldDimensionsPx=st(),this._mat3=Jt(),this._initialized=!1}dispose(){this._program=ie(this._program),this._quad=ie(this._quad)}render(e,t){const{context:i}=e;return!!this._updateGeometry(e,t)&&(this._initialized||this._initialize(i),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setColorMask(!1,!1,!1,!1),i.setBlendingEnabled(!1),i.setStencilOp(Te.KEEP,Te.KEEP,Te.REPLACE),i.setStencilFunction(We.ALWAYS,1,255),i.setStencilTestEnabled(!0),i.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind(),!0)}_initialize(e){if(this._initialized)return;const t=ct(e,fa);t&&(this._program=t,this._quad=new Ne(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(e,t){const{state:i,pixelRatio:s}=e,{size:n,rotation:a}=i,o=Math.round(n[0]*s),l=Math.round(n[1]*s);if(!i.spatialReference.isWrappable)return!1;const h=Gs(a),c=Math.abs(Math.cos(h)),u=Math.abs(Math.sin(h)),_=Math.round(o*c+l*u),f=Math.round(i.worldScreenWidth);if(_<=f)return!1;const m=o*u+l*c,d=f*s,g=(t.left-t.right)*s/o,x=(t.bottom-t.top)*s/l;wt(this._worldDimensionsPx,d,m,1),wt(this._pxToNdc,2/o,-2/l,1),wt(this._centerNdc,g,x,1);const p=this._mat3;return Ls(p,this._centerNdc),li(p,p,this._pxToNdc),a!==0&&$s(p,p,h),li(p,p,this._worldDimensionsPx),zs(p,p,ma),!0}}class mt{constructor(){this.name=this.constructor.name}createOptions(e,t){return null}}class ga extends mt{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,t){if(!t.size)return;const{context:i,renderingOptions:s}=e;this._quad||(this._quad=new Ne(i,[0,0,1,0,0,1,1,1]));const n=i.getBoundFramebufferObject(),{x:a,y:o,width:l,height:h}=i.getViewport();t.bindTextures(i);const c=t.getBlock(kr);if(P(c))return;const u=c.getFBO(i),_=c.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,_,s.labelsAnimationTime),this._updateAnimationState(e,_,u),i.bindFramebuffer(n),i.setViewport(a,o,l,h)}_computeDelta(e,t,i){const{context:s,painter:n,displayLevel:a}=e,o=n.materialManager.getProgram(this._desc,["delta"]);s.bindFramebuffer(t),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),s.useProgram(o),o.setUniform1i("u_maskTexture",Gr),o.setUniform1i("u_sourceTexture",Vr),o.setUniform1f("u_timeDelta",e.deltaTime),o.setUniform1f("u_animationTime",i),o.setUniform1f("u_zoomLevel",Math.round(10*a)),this._quad.draw()}_updateAnimationState(e,t,i){const{context:s,painter:n}=e,a=n.materialManager.getProgram(this._desc,["update"]);s.bindTexture(t.colorTexture,1),s.useProgram(a),a.setUniform1i("u_sourceTexture",1),s.bindFramebuffer(i),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),this._quad.draw()}}const ba=r=>r.replace("-","_").toUpperCase(),ki=r=>`#define ${ba(r)}
`;function Gi(r){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:ki(r)+ne("blend/blend.vert"),fragmentShader:ki(r)+ne("blend/blend.frag")}}}const Vi=ft.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class va{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture=ie(this._backBufferTexture),this._quad=ie(this._quad)}draw(e,t,i,s,n){const{context:a,drawPhase:o}=e;if(this._setupShader(a),s&&s!=="normal"&&o!==se.LABEL)return void this._drawBlended(e,t,i,s,n);const l=Gi("normal"),h=a.programCache.acquire(l.shaders.vertexShader,l.shaders.fragmentShader,l.attributes);if(!h)return void Vi.error(new H("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));a.useProgram(h),t.setSamplingMode(i),a.bindTexture(t,0),h.setUniform1i("u_layerTexture",0),h.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA);const c=this._quad;c.draw(),c.unbind(),h.dispose()}_drawBlended(e,t,i,s,n){const{context:a,state:o,pixelRatio:l,inFadeTransition:h}=e,{size:c}=o,u=a.getBoundFramebufferObject();let _,f;if(D(u)){const p=u.descriptor;_=p.width,f=p.height}else _=Math.round(l*c[0]),f=Math.round(l*c[1]);this._createOrResizeTexture(e,_,f);const m=this._backBufferTexture;u.copyToTexture(0,0,_,f,0,0,m),a.setStencilTestEnabled(!1),a.setStencilWriteMask(0),a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!1);const d=Gi(s),g=a.programCache.acquire(d.shaders.vertexShader,d.shaders.fragmentShader,d.attributes);if(!g)return void Vi.error(new H("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));a.useProgram(g),m.setSamplingMode(i),a.bindTexture(m,0),g.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),a.bindTexture(t,1),g.setUniform1i("u_layerTexture",1),g.setUniform1f("u_opacity",n),g.setUniform1f("u_inFadeOpacity",h?1:0),a.setBlendFunction(A.ONE,A.ZERO);const x=this._quad;x.draw(),x.unbind(),g.dispose(),a.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA)}_setupShader(e){this._quad||(this._quad=new Ne(e,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(e,t,i){const{context:s}=e;this._backBufferTexture!==null&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new K(s,{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}class Wi extends mt{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:t}){this._prev=e.getBoundFramebufferObject();const{width:i,height:s}=e.getViewport(),n=t.getFbos(i,s).effect0;e.bindFramebuffer(n),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,t){const{context:i,painter:s}=e,n=s.getPostProcessingEffects(t),a=i.getBoundFramebufferObject();for(const{postProcessingEffect:o,effect:l}of n)o.draw(e,a,l);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,a.colorTexture,S.NEAREST),i.setStencilTestEnabled(!0)}}const Zt=1,Ea=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],xa=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Ze=256,Se={outlineWidth:1.3,outerHaloWidth:.4,innerHaloWidth:.4,outlinePosition:0},kt=ft.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient");function ya(r,e){e.fillColor[0]=r.color.r/255,e.fillColor[1]=r.color.g/255,e.fillColor[2]=r.color.b/255,e.fillColor[3]=r.color.a,r.haloColor?(e.outlineColor[0]=r.haloColor.r/255,e.outlineColor[1]=r.haloColor.g/255,e.outlineColor[2]=r.haloColor.b/255,e.outlineColor[3]=r.haloColor.a):(e.outlineColor[0]=e.fillColor[0],e.outlineColor[1]=e.fillColor[1],e.outlineColor[2]=e.fillColor[2],e.outlineColor[3]=e.fillColor[3]),e.fillColor[3]*=r.fillOpacity,e.outlineColor[3]*=r.haloOpacity,e.fillColor[0]*=e.fillColor[3],e.fillColor[1]*=e.fillColor[3],e.fillColor[2]*=e.fillColor[3],e.outlineColor[0]*=e.outlineColor[3],e.outlineColor[1]*=e.outlineColor[3],e.outlineColor[2]*=e.outlineColor[3],e.outlineWidth=Se.outlineWidth,e.outerHaloWidth=Se.outerHaloWidth,e.innerHaloWidth=Se.innerHaloWidth,e.outlinePosition=Se.outlinePosition}const Ta=[0,0,0,0];class wa{constructor(){this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:Se.outlinePosition,outlineWidth:Se.outlineWidth,innerHaloWidth:Se.innerHaloWidth,outerHaloWidth:Se.outerHaloWidth},this.shadeTexChanged=!0,this.texelData=new Uint8Array(4*Ze),this.minMaxDistance=[0,0]}setHighlightOptions(e){const t=this._convertedHighlightOptions;ya(e,t);const i=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,s=t.outlinePosition-t.outlineWidth/2,n=t.outlinePosition+t.outlineWidth/2,a=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,o=Math.sqrt(Math.PI/2)*Zt,l=Math.abs(i)>o?Math.round(10*(Math.abs(i)-o))/10:0,h=Math.abs(a)>o?Math.round(10*(Math.abs(a)-o))/10:0;let c;l&&!h?kt.error("The outer rim of the highlight is "+l+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!l&&h?kt.error("The inner rim of the highlight is "+h+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):l&&h&&kt.error("The highlight is "+Math.max(l,h)+"px away from the edge of the feature; consider reducing some width values.");const u=[void 0,void 0,void 0,void 0];function _(m,d,g){u[0]=(1-g)*m[0]+g*d[0],u[1]=(1-g)*m[1]+g*d[1],u[2]=(1-g)*m[2]+g*d[2],u[3]=(1-g)*m[3]+g*d[3]}const{texelData:f}=this;for(let m=0;m<Ze;++m)c=i+m/(Ze-1)*(a-i),c<i?(u[4*m+0]=0,u[4*m+1]=0,u[4*m+2]=0,u[4*m+3]=0):c<s?_(Ta,t.outlineColor,(c-i)/(s-i)):c<n?[u[0],u[1],u[2],u[3]]=t.outlineColor:c<a?_(t.outlineColor,t.fillColor,(c-n)/(a-n)):[u[4*m+0],u[4*m+1],u[4*m+2],u[4*m+3]]=t.fillColor,f[4*m+0]=255*u[0],f[4*m+1]=255*u[1],f[4*m+2]=255*u[2],f[4*m+3]=255*u[3];this.minMaxDistance[0]=i,this.minMaxDistance[1]=a,this.shadeTexChanged=!0}applyHighlightOptions(e,t){this.shadeTex||(this.shadeTex=new K(e,{target:I.TEXTURE_2D,pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,width:Ze,height:1,samplingMode:S.LINEAR})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,Ze,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,hs),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}destroy(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}const Fa={shaders:{vertexShader:ne("highlight/textured.vert"),fragmentShader:ne("highlight/highlight.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])},Ra={shaders:{vertexShader:ne("highlight/textured.vert"),fragmentShader:ne("highlight/blur.frag")},attributes:new Map([["a_position",0],["a_texcoord",1]])};class Ba{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,t){e.bindTexture(t,Ye),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ea),e.bindVAO(this._resources.quadVAO),e.drawArrays(re.TRIANGLE_STRIP,0,4),e.bindVAO()}finalBlur(e,t){e.bindTexture(t,Ye),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",xa),e.bindVAO(this._resources.quadVAO),e.drawArrays(re.TRIANGLE_STRIP,0,4),e.bindVAO()}renderHighlight(e,t,i){e.bindTexture(t,Ye),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA),e.drawArrays(re.TRIANGLE_STRIP,0,4),e.bindVAO()}_initialize(e,t,i){this._width=t,this._height=i;const s=$e.createVertex(e,ze.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new Le(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new _t("a_position",2,dt.BYTE,0,4),new _t("a_texcoord",2,dt.UNSIGNED_BYTE,2,4)]},{geometry:s}),a=ct(e,Fa),o=ct(e,Ra);e.useProgram(a),a.setUniform1i("u_texture",Ye),a.setUniform1i("u_shade",hs),a.setUniform1f("u_sigma",Zt),e.useProgram(o),o.setUniform1i("u_texture",Ye),o.setUniform1f("u_sigma",Zt),this._resources={quadGeometry:s,quadVAO:n,highlightProgram:a,blurProgram:o}}setup(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}function Xi(r,e,t){const i=new K(r,{target:I.TEXTURE_2D,pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,width:e,height:t,samplingMode:S.LINEAR});return[i,new X(r,{colorTarget:j.TEXTURE,depthStencilTarget:Y.STENCIL_RENDER_BUFFER},i)]}class Aa{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,t,i){this._width=t,this._height=i;const[s,n]=Xi(e,t,i),[a,o]=Xi(e,t,i);this._resources={sharedBlur1Tex:s,sharedBlur1Fbo:n,sharedBlur2Tex:a,sharedBlur2Fbo:o}}setup(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Tex}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Tex}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}const Pe=4,vt=4/Pe;class Sa extends mt{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new Ba,this._hlGradient=new wa,this._width=void 0,this._height=void 0,this._hlSurfaces=new Aa,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new cs}dispose(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}bind(e){const{context:t,painter:i}=e,{width:s,height:n}=t.getViewport(),a=i.getFbos(s,n).effect0;this.setup(e,s,n),t.bindFramebuffer(a),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},t,i){this._width=t,this._height=i;const s=t%Pe,n=i%Pe;t+=s<Pe/2?-s:Pe-s,i+=n<Pe/2?-n:Pe-n,this._adjustedWidth=t,this._adjustedHeight=i,this._boundFBO=e.getBoundFramebufferObject();const a=Math.round(t*vt),o=Math.round(i*vt);this._hlRenderer.setup(e,a,o),this._hlSurfaces.setup(e,a,o)}draw({context:e}){const t=e.getBoundFramebufferObject();e.setViewport(0,0,this._adjustedWidth*vt,this._adjustedHeight*vt),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setStencilTestEnabled(!1),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(e,t.colorTexture,S.NEAREST,1),e.setStencilTestEnabled(!1),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!0),e.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(e,this._hlSurfaces.sharedBlur1Tex),e.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(e,this._hlSurfaces.sharedBlur2Tex),e.bindFramebuffer(this._boundFBO),e.setBlendingEnabled(!0),e.setColorMask(!0,!0,!0,!0),e.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(e,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}setHighlightOptions(e){this._hlGradient.setHighlightOptions(e)}}class Ma extends mt{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){D(this._fbo)&&this._fbo.dispose()}createOptions({pixelRatio:e},t,i=us){if(!t.length)return null;const s=t.shift(),n=s.point.x,a=s.point.y;return this._outstanding=s,{type:"hittest",distance:i*e,position:[n,a]}}bind(e){const{context:t,attributeView:i}=e;if(!i.size)return;const s=i.getBlock(yi);if(P(s))return;const n=s.getFBO(t);t.setViewport(0,0,i.size,i.size),t.bindFramebuffer(n),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT)}unbind(e){}draw(e){const{context:t,attributeView:i}=e,s=i.getBlock(yi);if(P(this._outstanding))return;const n=this._outstanding.resolver;if(P(s))return n.resolve([]),void(this._outstanding=null);const a=s.getFBO(t),o=new Uint8Array(a.width*a.height*4);a.readPixels(0,0,a.width,a.height,F.RGBA,M.UNSIGNED_BYTE,o);const l=[];for(let h=0;h<o.length;h+=4){const c=o[h],u=o[h+3];c&&l.push({id:h/4,directHits:u})}this._outstanding=null,l.sort((h,c)=>c.directHits===h.directHits?c.id-h.id:c.directHits-h.directHits),n.resolve(l.map(h=>h.id))}}class Oa extends mt{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0}dispose(){D(this._fbo)&&this._fbo.dispose()}bind({context:e,painter:t}){const{width:i,height:s}=e.getViewport();this._boundFBO=e.getBoundFramebufferObject();const n=t.getFbos(i,s).effect0;e.bindFramebuffer(n),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind({context:e}){e.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw({context:e,state:t,pixelRatio:i},s,n=2*us){const a=e.getBoundFramebufferObject(),o=t.size[1]*i,l=Math.round(n*i),h=l/2,c=l/2;this._ensureBuffer(l),s.forEach((u,_)=>{const f=new Map,m=Math.floor(_.x*i-l/2),d=Math.floor(o-_.y*i-l/2);a.readPixels(m,d,l,l,F.RGBA,M.UNSIGNED_BYTE,this._buf);for(let x=0;x<this._buf32.length;x++){const p=this._buf32[x];if(p!==4294967295&&p!==0){const E=x%l,b=l-Math.floor(x/l),y=(h-E)*(h-E)+(c-b)*(c-b),v=f.has(p)?f.get(p):4294967295;f.set(p,Math.min(y,v))}}const g=Array.from(f).sort((x,p)=>x[1]-p[1]).map(x=>x[0]);u.resolve(g),s.delete(_)})}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}const Gt=5,Ca=[1,0],Pa=[0,1],Da=[1,.8,.6,.4,.2],Ia=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class Ua{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(Gt),this._nMips=Gt,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad&&(this._quad.dispose(),this._quad=null),this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null),this._compositeFBO&&(this._compositeFBO.dispose(),this._compositeFBO=null),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,t,i){const{width:s,height:n}=t,{context:a,painter:o}=e,{materialManager:l}=o,h=a.gl,c=this._programDesc,{strength:u,radius:_,threshold:f}=i;this._quad||(this._quad=new Ne(a,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,s,n),a.setStencilTestEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA),a.setStencilWriteMask(0);const m=this._quad;m.bind(),a.bindFramebuffer(this._intensityFBO);const d=l.getProgram(c.luminosityHighPass);a.useProgram(d),a.bindTexture(t.colorTexture,0),d.setUniform1i("u_texture",0),d.setUniform3fv("u_defaultColor",[0,0,0]),d.setUniform1f("u_defaultOpacity",0),d.setUniform1f("u_luminosityThreshold",f),d.setUniform1f("u_smoothWidth",.01);const g=[Math.round(s/2),Math.round(n/2)];a.setViewport(0,0,g[0],g[1]),a.setClearColor(0,0,0,0),a.clear(h.COLOR_BUFFER_BIT),m.draw(),a.setBlendingEnabled(!1);let x=this._intensityFBO.colorTexture;for(let b=0;b<this._nMips;b++){const y=l.getProgram(c.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[b]}]);a.useProgram(y),a.bindTexture(x,b+1),y.setUniform1i("u_colorTexture",b+1),y.setUniform2fv("u_texSize",g),y.setUniform2fv("u_direction",Ca),a.setViewport(0,0,g[0],g[1]);const v=this._mipsFBOs[b];a.bindFramebuffer(v.horizontal),m.draw(),x=v.horizontal.colorTexture,a.bindFramebuffer(v.vertical),a.bindTexture(x,b+1),y.setUniform2fv("u_direction",Pa),m.draw(),x=v.vertical.colorTexture,g[0]=Math.round(g[0]/2),g[1]=Math.round(g[1]/2)}a.setViewport(0,0,s,n);const p=l.getProgram(c.composite,[{name:"nummips",value:Gt}]);a.bindFramebuffer(this._compositeFBO),a.useProgram(p),p.setUniform1f("u_bloomStrength",u),p.setUniform1f("u_bloomRadius",_),p.setUniform1fv("u_bloomFactors",Da),p.setUniform3fv("u_bloomTintColors",Ia),a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),p.setUniform1i("u_blurTexture1",1),a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),p.setUniform1i("u_blurTexture2",2),a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),p.setUniform1i("u_blurTexture3",3),a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),p.setUniform1i("u_blurTexture4",4),a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),p.setUniform1i("u_blurTexture5",5),m.draw(),a.bindFramebuffer(t),a.setBlendingEnabled(!0);const E=l.getProgram(c.blit);a.useProgram(E),a.bindTexture(this._compositeFBO.colorTexture,6),E.setUniform1i("u_texture",6),a.setBlendFunction(A.ONE,A.ONE),m.draw(),m.unbind(),a.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}_createOrResizeResources(e,t,i){const{context:s}=e;if(this._compositeFBO&&this._size[0]===t&&this._size[1]===i)return;this._size[0]=t,this._size[1]=i;const n=[Math.round(t/2),Math.round(i/2)];this._compositeFBO?this._compositeFBO.resize(t,i):this._compositeFBO=new X(s,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE,width:t,height:i}),this._intensityFBO?this._intensityFBO.resize(n[0],n[1]):this._intensityFBO=new X(s,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE,width:n[0],height:n[1]},{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:n[0],height:n[1]});for(let a=0;a<this._nMips;a++)this._mipsFBOs[a]?(this._mipsFBOs[a].horizontal.resize(n[0],n[1]),this._mipsFBOs[a].vertical.resize(n[0],n[1])):this._mipsFBOs[a]={horizontal:new X(s,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE,width:n[0],height:n[1]},{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:n[0],height:n[1]}),vertical:new X(s,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE,width:n[0],height:n[1]},{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:n[0],height:n[1]})},n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}const Na=[1,0],La=[0,1];class $a{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(e,t,i){const{context:s}=e,{type:n,radius:a}=i;if(a===0)return;this._createOrResizeResources(e),this._quad||(this._quad=new Ne(s,[-1,-1,1,-1,-1,1,1,1]));const o=this._quad;o.bind(),n==="blur"?this._gaussianBlur(e,t,a):this._radialBlur(e,t),o.unbind()}_gaussianBlur(e,t,i){const{context:s,state:n,painter:a,pixelRatio:o}=e,{size:l}=n,{materialManager:h}=a,c=this._programDesc,u=this._quad,_=[Math.round(o*l[0]),Math.round(o*l[1])],f=this._blurFBO,m=h.getProgram(c.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);s.useProgram(m),s.setBlendingEnabled(!1),s.bindFramebuffer(f),s.bindTexture(t.colorTexture,4),m.setUniform1i("u_colorTexture",4),m.setUniform2fv("u_texSize",_),m.setUniform2fv("u_direction",Na),m.setUniform1f("u_sigma",i),u.draw(),s.bindFramebuffer(t),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.bindTexture(f.colorTexture,5),m.setUniform1i("u_colorTexture",5),m.setUniform2fv("u_direction",La),u.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0)}_radialBlur(e,t){const{context:i,painter:s}=e,{materialManager:n}=s,a=this._programDesc,o=this._quad,l=this._blurFBO;i.bindFramebuffer(l);const h=n.getProgram(a.radialBlur);i.useProgram(h),i.setBlendingEnabled(!1),i.bindTexture(t.colorTexture,4),h.setUniform1i("u_colorTexture",4),o.draw(),i.bindFramebuffer(t),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const c=n.getProgram(a.blit);i.useProgram(c),i.bindTexture(l.colorTexture,5),c.setUniform1i("u_texture",5),i.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA),o.draw()}_createOrResizeResources(e){const{context:t,state:i,pixelRatio:s}=e,{size:n}=i,a=Math.round(s*n[0]),o=Math.round(s*n[1]);this._blurFBO&&this._size[0]===a&&this._size[1]===o||(this._size[0]=a,this._size[1]=o,this._blurFBO?this._blurFBO.resize(a,o):this._blurFBO=new X(t,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE,width:a,height:o},{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:a,height:o}))}}class za{constructor(){this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(e,t,i){const{width:s,height:n}=t;this._createOrResizeResources(e,s,n);const{context:a,painter:o}=e,{materialManager:l}=o,h=this._programDesc,c=this._quad,u=i.colorMatrix;c.bind();const _=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,s,n,0,0,_),a.setBlendingEnabled(!1),a.setStencilTestEnabled(!1);const f=l.getProgram(h);a.useProgram(f),a.bindTexture(_,2),f.setUniformMatrix4fv("u_coefficients",u),f.setUniform1i("u_colorTexture",2),c.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0),c.unbind()}_createOrResizeResources(e,t,i){const{context:s}=e;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new K(s,{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:t,height:i}),this._quad||(this._quad=new Ne(s,[-1,-1,1,-1,-1,1,1,1])))}}const ka=[1,0],Ga=[0,1];class Va{constructor(){this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null),this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null),this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)}draw(e,t,i){const{context:s,state:n,painter:a}=e,{materialManager:o}=a,l=this._programDesc,h=t.width,c=t.height,u=[Math.round(h/2),Math.round(c/2)],{blurRadius:_,offsetX:f,offsetY:m,color:d}=i,g=[Ae(f/2),Ae(m/2)];this._createOrResizeResources(e,h,c,u);const x=this._horizontalBlurFBO,p=this._verticalBlurFBO;s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1);const E=this._layerFBOTexture;t.copyToTexture(0,0,h,c,0,0,E),this._quad||(this._quad=new Ne(s,[-1,-1,1,-1,-1,1,1,1])),s.setViewport(0,0,u[0],u[1]);const b=this._quad;b.bind(),s.setBlendingEnabled(!1);const y=o.getProgram(l.blur,[{name:"radius",value:Math.ceil(_)}]);s.useProgram(y),s.bindFramebuffer(x),s.bindTexture(t.colorTexture,4),y.setUniform1i("u_colorTexture",4),y.setUniform2fv("u_texSize",u),y.setUniform2fv("u_direction",ka),y.setUniform1f("u_sigma",_),b.draw(),s.bindFramebuffer(p),s.bindTexture(x.colorTexture,5),y.setUniform1i("u_colorTexture",5),y.setUniform2fv("u_direction",Ga),b.draw(),s.bindFramebuffer(t),s.setViewport(0,0,h,c);const v=o.getProgram(l.composite);s.useProgram(v),s.bindTexture(p.colorTexture,2),v.setUniform1i("u_blurTexture",2),s.bindTexture(E,3),v.setUniform1i("u_layerFBOTexture",3),v.setUniform4fv("u_shadowColor",[d[3]*(d[0]/255),d[3]*(d[1]/255),d[3]*(d[2]/255),d[3]]),v.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),v.setUniform2fv("u_shadowOffset",g),b.draw(),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!0),s.setBlendFunction(A.ONE,A.ONE_MINUS_SRC_ALPHA),b.unbind()}_createOrResizeResources(e,t,i,s){const{context:n}=e;this._horizontalBlurFBO&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(s[0],s[1]):this._horizontalBlurFBO=new X(n,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE,width:s[0],height:s[1]},{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:s[0],height:s[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(s[0],s[1]):this._verticalBlurFBO=new X(n,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE,width:s[0],height:s[1]},{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:s[0],height:s[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new K(n,{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:t,height:i}))}}class Wa{constructor(){this._size=[0,0]}dispose(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null)}draw(e,t,i){const{width:s,height:n}=t;this._createOrResizeResources(e,s,n);const{context:a,painter:o}=e,{amount:l}=i,h=a.gl,c=this._layerFBOTexture;a.bindFramebuffer(t),t.copyToTexture(0,0,s,n,0,0,c),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!1),a.setDepthTestEnabled(!1),a.setClearColor(0,0,0,0),a.clear(h.COLOR_BUFFER_BIT),o.blitTexture(a,c,S.NEAREST,l)}_createOrResizeResources(e,t,i){const{context:s}=e;this._layerFBOTexture&&this._size[0]===t&&this._size[1]===i||(this._size[0]=t,this._size[1]=i,this._layerFBOTexture?this._layerFBOTexture.resize(t,i):this._layerFBOTexture=new K(s,{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.NEAREST,flipped:!1,width:t,height:i}))}}function Xa(r){switch(r){case"bloom":case"blur":case"opacity":case"drop-shadow":return r;default:return"colorize"}}const Ha={colorize:()=>new za,blur:()=>new $a,bloom:()=>new Ua,opacity:()=>new Wa,"drop-shadow":()=>new Va};class qa{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach(e=>e.dispose()),this._effectMap.clear()}getPostProcessingEffects(e){if(!e||e.length===0)return[];const t=[];for(const i of e){const s=Xa(i.type);let n=this._effectMap.get(s);n||(n=Ha[s](),this._effectMap.set(s,n)),t.push({postProcessingEffect:n,effect:i})}return t}}class ja{constructor(e,t){this.brushes=e,this.name=t.name,this.drawPhase=t.drawPhase||se.MAP,this._targetFn=t.target,this.effects=t.effects||[],this.enableDefaultDraw=t.enableDefaultDraw??(()=>!0)}render(e){const{context:t,profiler:i}=e,s=this._targetFn(),n=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,s),i.recordPassEnd();for(const a of this.effects){if(!a.enable())continue;const o=a.apply;i.recordPassStart(this.name+"."+o.name),i.recordBrushStart(o.name);const l=a.args&&a.args(),{x:h,y:c,width:u,height:_}=t.getViewport(),f=t.getBoundFramebufferObject();o.bind(e,l);const m=o.createOptions(e,l),d=e.passOptions;e.passOptions=m,this._doRender(e,s,o.defines),e.passOptions=d,o.draw(e,l),o.unbind(e,l),t.bindFramebuffer(f),t.setViewport(h,c,u,_),i.recordBrushEnd(),i.recordPassEnd()}}}_doRender(e,t,i){if(!P(t))if(Vs(t)){for(const s of t)if(s.visible)for(const n of this.brushes)e.profiler.recordBrushStart(n.name),n.prepareState(e,s,i),n.draw(e,s,i),e.profiler.recordBrushEnd()}else for(const s of this.brushes)e.profiler.recordBrushStart(s.name),s.prepareState(e,t,i),s.draw(e,t,i),e.profiler.recordBrushEnd()}}function Ya(r,e){switch(r){case je.LINE:return be.line;case je.TEXT:return be.text;case je.LABEL:return be.label;case je.FILL:return e===Ut.DOT_DENSITY?be.dotDensity:be.fill;case je.MARKER:switch(e){case Ut.HEATMAP:return be.heatmap;case Ut.PIE_CHART:return be.pieChart;default:return be.marker}}}class Ka{constructor(e,t,i){this.context=e,this._blitRenderer=new cs,this._worldExtentClipRenderer=new pa,this._isClippedToWorldExtent=!1,this._brushCache=new Map,this._vtlMaterialManager=new dn,this._blendEffect=new va,this._fboPool=[],this.effects={highlight:new Sa,hittest:new Ma,hittestVTL:new Oa,integrate:new ga,insideEffect:new Wi("inside"),outsideEffect:new Wi("outside")},this.materialManager=new bn(e),this.textureManager=new _a(t,i),this._effectsManager=new qa}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getRenderTarget(){return this._renderTarget}setRenderTarget(e){this._renderTarget=e}getFbos(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(const a in this._fbos)this._fbos[a].resize(e,t);return this._fbos}const i={target:I.TEXTURE_2D,pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,samplingMode:S.NEAREST,wrapMode:U.CLAMP_TO_EDGE,width:e,height:t},s={colorTarget:j.TEXTURE,depthStencilTarget:Y.DEPTH_STENCIL_RENDER_BUFFER},n=new Cr(this.context,{width:e,height:t,internalFormat:Pr.DEPTH_STENCIL});this._stencilBuf=n,this._fbos={output:new X(this.context,s,i,n),blend:new X(this.context,s,i,n),effect0:new X(this.context,s,i,n)}}return this._fbos}acquireFbo(e,t){let i;i=this._fboPool.length>0?this._fboPool.pop():new X(this.context,{colorTarget:j.TEXTURE,depthStencilTarget:Y.DEPTH_STENCIL_RENDER_BUFFER},{target:I.TEXTURE_2D,pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,samplingMode:S.NEAREST,wrapMode:U.CLAMP_TO_EDGE,width:e,height:t},this._stencilBuf);const s=i.descriptor;return s.width===e&&s.height===t||i.resize(e,t),i}releaseFbo(e){this._fboPool.push(e)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderLayers(e,t=null){const{width:i,height:s}=e.getViewport();this._prevFBO=e.getBoundFramebufferObject();const n=this.getFbos(i,s);if(e.bindFramebuffer(n.output),e.setColorMask(!0,!0,!0,!0),D(t)){const{r:a,g:o,b:l,a:h}=t.color;e.setClearColor(h*a/255,h*o/255,h*l/255,h)}else e.setClearColor(0,0,0,0);e.setDepthWriteEnabled(!0),e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}beforeRenderLayer(e,t,i){const{context:s,blendMode:n,effects:a,requireFBO:o,drawPhase:l}=e;if(o||Hi(l,n,a,i))s.bindFramebuffer(this._fbos.blend),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1);else{const h=this._getOutputFBO();s.bindFramebuffer(h)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(t),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}compositeLayer(e,t){const{context:i,blendMode:s,effects:n,requireFBO:a,drawPhase:o}=e;if(a||Hi(o,s,n,t)){D(n)&&n.length>0&&o===se.MAP&&this._applyEffects(e,n);const l=this._getOutputFBO();i.bindFramebuffer(l),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(A.ONE,A.ONE_MINUS_SRC_ALPHA,A.ONE,A.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0);const h=P(s)||o===se.HIGHLIGHT?"normal":s;this._blendEffect.draw(e,this._fbos.blend.colorTexture,S.NEAREST,h,t)}}renderLayers(e){if(e.bindFramebuffer(this._prevFBO),!this._fbos)return;const t=this._getOutputFBO();e.setDepthTestEnabled(!1),e.setStencilWriteMask(0),this._isClippedToWorldExtent?(e.setStencilTestEnabled(!0),e.setStencilFunction(We.EQUAL,1,255)):e.setStencilTestEnabled(!1),this.blitTexture(e,t.colorTexture,S.NEAREST)}prepareDisplay(e,t,i){const{context:s}=e;if(s.bindFramebuffer(this._prevFBO),s.setColorMask(!0,!0,!0,!0),D(t)){const{r:n,g:a,b:o,a:l}=t.color;s.setClearColor(l*n/255,l*a/255,l*o/255,l)}else s.setClearColor(0,0,0,0);s.setStencilWriteMask(255),s.setClearStencil(0),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.STENCIL_BUFFER_BIT),this._isClippedToWorldExtent=this._worldExtentClipRenderer.render(e,i)}dispose(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer=ie(this._blitRenderer),this._worldExtentClipRenderer=ie(this._worldExtentClipRenderer),this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos)for(const e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();for(const e of this._fboPool)e.dispose();if(this._fboPool.length=0,this.effects)for(const e in this.effects)this.effects[e]&&this.effects[e].dispose();this._effectsManager.dispose(),this._vtlMaterialManager=ie(this._vtlMaterialManager),this._prevFBO=null}getBrush(e,t){const i=Ya(e,t);let s=this._brushCache.get(i);return s===void 0&&(s=new i,this._brushCache.set(i,s)),this._brushCache.get(i)}renderObject(e,t,i,s){const n=be[i];if(!n)return null;let a=this._brushCache.get(n);a===void 0&&(a=new n,this._brushCache.set(n,a)),a.prepareState(e,t,s),a.draw(e,t,s)}renderObjects(e,t,i,s){const n=be[i];if(!n)return null;let a=this._brushCache.get(n);a===void 0&&(a=new n,this._brushCache.set(n,a)),a.drawMany(e,t,s)}registerRenderPass(e){const t=e.brushes.map(i=>(this._brushCache.has(i)||this._brushCache.set(i,new i),this._brushCache.get(i)));return new ja(t,e)}setHighlightOptions(e){this.effects.highlight.setHighlightOptions(e)}blitTexture(e,t,i,s=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(A.ONE,A.ONE_MINUS_SRC_ALPHA,A.ONE,A.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,s)}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}_getOutputFBO(){return this._renderTarget!=null?this._renderTarget:this._fbos.output}_applyEffects(e,t){const{context:i}=e,s=this._effectsManager.getPostProcessingEffects(t);for(const{postProcessingEffect:n,effect:a}of s)i.bindFramebuffer(this._fbos.blend),n.draw(e,this._fbos.blend,a)}}function Hi(r,e,t,i){return r!==se.HIGHLIGHT&&(i!==1||D(e)&&e!=="normal"||D(t)&&t.length>0)}class qi{constructor(e,t,i,s,n,a,o,l){this.createQuery=e,this.resultAvailable=t,this.getResult=i,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=a,this.createTimestamp=o,this.timestampBits=l}}function ws(r,e){if(e.disjointTimerQuery)return null;let t=r.getExtension("EXT_disjoint_timer_query_webgl2");return t&&q(r)?new qi(()=>r.createQuery(),i=>r.getQueryParameter(i,r.QUERY_RESULT_AVAILABLE),i=>r.getQueryParameter(i,r.QUERY_RESULT),()=>r.getParameter(t.GPU_DISJOINT_EXT),i=>r.beginQuery(t.TIME_ELAPSED_EXT,i),()=>r.endQuery(t.TIME_ELAPSED_EXT),i=>t.queryCounterEXT(i,t.TIMESTAMP_EXT),()=>r.getQuery(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)):(t=r.getExtension("EXT_disjoint_timer_query"),t?new qi(()=>t.createQueryEXT(),i=>t.getQueryObjectEXT(i,t.QUERY_RESULT_AVAILABLE_EXT),i=>t.getQueryObjectEXT(i,t.QUERY_RESULT_EXT),()=>r.getParameter(t.GPU_DISJOINT_EXT),i=>t.beginQueryEXT(t.TIME_ELAPSED_EXT,i),()=>t.endQueryEXT(t.TIME_ELAPSED_EXT),i=>t.queryCounterEXT(i,t.TIMESTAMP_EXT),()=>t.getQueryEXT(t.TIMESTAMP_EXT,t.QUERY_COUNTER_BITS_EXT)):null)}const _e=Bt("esri-2d-profiler");class Za{constructor(e,t){if(this._events=new Ws,this._entries=new Map,this._timings=new jr(10),!_e)return;this._ext=ws(e.gl,{}),this._debugOutput=t;const i=e.gl;if(this.enableCommandLogging){for(const s in i)if(typeof i[s]=="function"){const n=i[s],a=s.includes("draw");i[s]=(...o)=>(this._events.emit("command",{container:this._currentContainer,pass:this._currentPass,brush:this._currentBrush,method:s,args:o,isDrawCommand:a}),this._currentSummary&&(this._currentSummary.commands++,a&&this._currentSummary.drawCommands++),n.apply(i,o))}}}get enableCommandLogging(){return!(typeof _e=="object"&&_e.disableCommands)}recordContainerStart(e){_e&&(this._currentContainer=e)}recordContainerEnd(){_e&&(this._currentContainer=null)}recordPassStart(e){_e&&(this._currentPass=e,this._initSummary())}recordPassEnd(){_e&&(this._currentPass=null,this._emitSummary())}recordBrushStart(e){_e&&(this._currentBrush=e)}recordBrushEnd(){_e&&(this._currentBrush=null)}recordStart(e){if(_e&&D(this._ext)){if(this._entries.has(e)){const i=this._entries.get(e),s=this._ext.resultAvailable(i.query),n=this._ext.disjoint();if(s&&!n){const a=this._ext.getResult(i.query)/1e6;let o=0;if(D(this._timings.enqueue(a))){const c=this._timings.entries,u=c.length;let _=0;for(const f of c)_+=f;o=_/u}const l=a.toFixed(2),h=o?o.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed(`Frame report for ${e}, ${l} ms (${h} last 10 avg)
${i.commandsLen} Commands (${i.drawCommands} draw)`),console.log("RenderPass breakdown: "),console.table(i.summaries),console.log("Commands: ",i.commands),console.groupEnd()):console.log(`Frame report for ${e}, ${l} ms (${h} last 10 avg)`),this._debugOutput.innerHTML=`${l} (${h})`}for(const a of i.handles)a.remove();this._entries.delete(e)}const t={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(t.handles.push(this._events.on("command",i=>{t.commandsLen++,t.commands.push(i),i.isDrawCommand&&t.drawCommands++})),t.handles.push(this._events.on("summary",i=>{t.summaries.push(i)}))),this._ext.beginTimeElapsed(t.query),this._entries.set(e,t)}}recordEnd(e){_e&&D(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}_initSummary(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}_emitSummary(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}class ji{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:A.ONE,dstRGB:A.ZERO,srcAlpha:A.ONE,dstAlpha:A.ZERO},this.blendEquation={mode:Kt.ADD,modeAlpha:Kt.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=Ie.BACK,this.frontFace=ls.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=We.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:Ie.FRONT_AND_BACK,func:We.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:Ie.FRONT_AND_BACK,fail:Te.KEEP,zFail:Te.KEEP,zPass:Te.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array}}class Qa{constructor(e){this._allocations=new Map,e?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(e){this._allocations.set(e,new Error().stack)}remove(e){this._allocations.delete(e)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const e=new Map;this._allocations.forEach(t=>{e.set(t,(e.get(t)??0)+1)}),e.forEach((t,i)=>{const s=i.split(`
`);s.shift(),s.shift(),console.log(`${t}: ${s.shift()}`),s.forEach(n=>console.log("   ",n))})}}}const Ja={RECORD_ALLOCATIONS:!1};class eo{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new Qa(Ja.RECORD_ALLOCATIONS);this._current.length<rt.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,t){const i=++this._current[e];this._max[e]=Math.max(i,this._max[e]),this._allocations.add(t)}decrement(e,t){--this._current[e],this._allocations.remove(t)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((e,t)=>e+t,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let e=0;e<rt.COUNT;++e){const t=this._current[e];t>0&&console.log(`${rt[e]}: ${t}`)}}this._allocations.print()}}function Yi(r,e){const t=new X(r,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE},{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,samplingMode:S.NEAREST,width:1,height:1});function i(x,p){const E=`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${e?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,b=`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `,y=r.programCache.acquire(E,b,new Map([["position",0]])),v=new Float32Array(6);wi(x,v,3);const R=new Float32Array(6);return wi(p,R,3),r.useProgram(y),y.setUniform3f("u_highA",v[0],v[2],v[4]),y.setUniform3f("u_lowA",v[1],v[3],v[5]),y.setUniform3f("u_highB",R[0],R[2],R[4]),y.setUniform3f("u_lowB",R[1],R[3],R[5]),y}const s=$e.createVertex(r,ze.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new Le(r,new Map([["position",0]]),{geometry:[new _t("position",2,dt.UNSIGNED_SHORT,0,4)]},{geometry:s}),a=jt(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),o=jt(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),l=i(a,o),h=r.getBoundFramebufferObject(),{x:c,y:u,width:_,height:f}=r.getViewport();r.bindFramebuffer(t),r.setViewport(0,0,1,1),r.bindVAO(n),r.drawArrays(re.TRIANGLE_STRIP,0,4);const m=new Uint8Array(4);t.readPixels(0,0,1,1,F.RGBA,M.UNSIGNED_BYTE,m),l.dispose(),n.dispose(!1),s.dispose(),t.dispose(),r.setViewport(c,u,_,f),r.bindFramebuffer(h);const d=(a[2]-o[2])/25,g=br(m);return Math.abs(d-g)}var Ki,Zi,Qi,Fs={exports:{}};function to(r){if(!r.gl)return!1;if(r.type===Ft.WEBGL1)return!(!r.capabilities.textureFloat?.textureFloat||!r.capabilities.colorBufferFloat?.textureFloat);if(!(r.capabilities.textureFloat?.textureFloat&&r.capabilities.colorBufferFloat?.textureFloat&&r.capabilities.colorBufferFloat?.floatBlend))return!1;const e=new X(r,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE},{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:F.RGBA,dataType:M.FLOAT,internalFormat:Dr.RGBA32F,samplingMode:S.NEAREST,width:1,height:1}),t=$e.createVertex(r,ze.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),i=new Le(r,new Map([["a_pos",0]]),{geometry:[new _t("a_pos",2,dt.UNSIGNED_SHORT,0,4)]},{geometry:t}),s=`
  precision highp float;
  attribute vec2 a_pos;

  void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,n=`
   precision highp float;

   void main() {
    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
   }
  `,a=r.programCache.acquire(s,n,new Map([["a_pos",0]]));r.useProgram(a);const o=r.getBoundFramebufferObject(),{x:l,y:h,width:c,height:u}=r.getViewport();r.bindFramebuffer(e),r.setViewport(0,0,1,1),r.bindVAO(i),r.drawArrays(re.TRIANGLE_STRIP,0,4);const _=Yr({blending:Kr});r.setPipelineState(_),r.drawArrays(re.TRIANGLE_STRIP,0,4),Fs.exports.init(r);const f=r.gl.getError();return r.setViewport(l,h,c,u),r.bindFramebuffer(o),a.dispose(),i.dispose(!1),t.dispose(),e.dispose(),f!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}Ki=Fs,Zi=function(){var r=function(d){window.console&&window.console.log&&window.console.log(d)},e=function(d){window.console&&window.console.error?window.console.error(d):r(d)},t={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},i=null,s=null;function n(d){if(i==null)for(var g in i={},s={},d)typeof d[g]=="number"&&(i[d[g]]=g,s[g]=d[g])}function a(){if(i==null)throw"WebGLDebugUtils.init(ctx) not called"}function o(d){return a(),i[d]!==void 0}function l(d){a();var g=i[d];return g!==void 0?"gl."+g:"/*UNKNOWN WebGL ENUM*/ 0x"+d.toString(16)}function h(d,g,x,p){var E;if((E=t[d])!==void 0&&(E=E[g])!==void 0&&E[x]){if(typeof E[x]=="object"&&E[x].enumBitwiseOr!==void 0){for(var b=E[x].enumBitwiseOr,y=0,v=[],R=0;R<b.length;++R){var T=s[b[R]];(p&T)!=0&&(y|=T,v.push(l(T)))}return y===p?v.join(" | "):l(p)}return l(p)}return p===null?"null":p===void 0?"undefined":p.toString()}function c(d,g){for(var x="",p=g.length,E=0;E<p;++E)x+=(E==0?"":", ")+h(d,p,E,g[E]);return x}function u(d,g,x){d.__defineGetter__(x,function(){return g[x]}),d.__defineSetter__(x,function(p){g[x]=p})}function _(d,g,x,p){p=p||d,n(d),g=g||function(T,L,G){for(var he="",ue=G.length,k=0;k<ue;++k)he+=(k==0?"":", ")+h(L,ue,k,G[k]);e("WebGL error "+l(T)+" in "+L+"("+he+")")};var E={};function b(T,L){return function(){x&&x(L,arguments);var G=T[L].apply(T,arguments),he=p.getError();return he!=0&&(E[he]=!0,g(he,L,arguments)),G}}var y={};for(var v in d)if(typeof d[v]=="function")if(v!="getExtension")y[v]=b(d,v);else{var R=b(d,v);y[v]=function(){return _(R.apply(d,arguments),g,x,p)}}else u(y,d,v);return y.getError=function(){for(var T in E)if(E.hasOwnProperty(T)&&E[T])return E[T]=!1,T;return d.NO_ERROR},y}function f(d){var g=d.getParameter(d.MAX_VERTEX_ATTRIBS),x=d.createBuffer();d.bindBuffer(d.ARRAY_BUFFER,x);for(var p=0;p<g;++p)d.disableVertexAttribArray(p),d.vertexAttribPointer(p,4,d.FLOAT,!1,0,0),d.vertexAttrib1f(p,0);d.deleteBuffer(x);var E=d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS);for(p=0;p<E;++p)d.activeTexture(d.TEXTURE0+p),d.bindTexture(d.TEXTURE_CUBE_MAP,null),d.bindTexture(d.TEXTURE_2D,null);for(d.activeTexture(d.TEXTURE0),d.useProgram(null),d.bindBuffer(d.ARRAY_BUFFER,null),d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,null),d.bindFramebuffer(d.FRAMEBUFFER,null),d.bindRenderbuffer(d.RENDERBUFFER,null),d.disable(d.BLEND),d.disable(d.CULL_FACE),d.disable(d.DEPTH_TEST),d.disable(d.DITHER),d.disable(d.SCISSOR_TEST),d.blendColor(0,0,0,0),d.blendEquation(d.FUNC_ADD),d.blendFunc(d.ONE,d.ZERO),d.clearColor(0,0,0,0),d.clearDepth(1),d.clearStencil(-1),d.colorMask(!0,!0,!0,!0),d.cullFace(d.BACK),d.depthFunc(d.LESS),d.depthMask(!0),d.depthRange(0,1),d.frontFace(d.CCW),d.hint(d.GENERATE_MIPMAP_HINT,d.DONT_CARE),d.lineWidth(1),d.pixelStorei(d.PACK_ALIGNMENT,4),d.pixelStorei(d.UNPACK_ALIGNMENT,4),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),d.UNPACK_COLORSPACE_CONVERSION_WEBGL&&d.pixelStorei(d.UNPACK_COLORSPACE_CONVERSION_WEBGL,d.BROWSER_DEFAULT_WEBGL),d.polygonOffset(0,0),d.sampleCoverage(1,!1),d.scissor(0,0,d.canvas.width,d.canvas.height),d.stencilFunc(d.ALWAYS,0,4294967295),d.stencilMask(4294967295),d.stencilOp(d.KEEP,d.KEEP,d.KEEP),d.viewport(0,0,d.canvas.width,d.canvas.height),d.clear(d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT|d.STENCIL_BUFFER_BIT);d.getError(););}function m(d){var g,x,p=[],E=[],b={},y=1,v=!1,R=[],T=0,L=0,G=!1,he=0,ue={};function k(w){return typeof w=="function"?w:function(O){w.handleEvent(O)}}d.getContext=(x=d.getContext,function(){var w=x.apply(d,arguments);if(w instanceof WebGLRenderingContext){if(w!=g){if(g)throw"got different context";b=Ms(g=w)}return b}return w});var V=function(w){p.push(k(w))},N=function(w){E.push(k(w))};function Oe(w){var O=w.addEventListener;w.addEventListener=function(Z,Q,ve){switch(Z){case"webglcontextlost":V(Q);break;case"webglcontextrestored":N(Q);break;default:O.apply(w,arguments)}}}function oe(){for(var w=Object.keys(ue),O=0;O<w.length;++O)delete ue[w]}function me(){++L,v||T==L&&d.loseContext()}function qe(w,O){var Z=w[O];return function(){if(me(),!v)return Z.apply(w,arguments)}}function Ss(){for(var w=0;w<R.length;++w){var O=R[w];O instanceof WebGLBuffer?g.deleteBuffer(O):O instanceof WebGLFramebuffer?g.deleteFramebuffer(O):O instanceof WebGLProgram?g.deleteProgram(O):O instanceof WebGLRenderbuffer?g.deleteRenderbuffer(O):O instanceof WebGLShader?g.deleteShader(O):O instanceof WebGLTexture&&g.deleteTexture(O)}}function ni(w){return{statusMessage:w,preventDefault:function(){G=!0}}}return Oe(d),d.loseContext=function(){if(!v){for(v=!0,T=0,++y;g.getError(););oe(),ue[g.CONTEXT_LOST_WEBGL]=!0;var w=ni("context lost"),O=p.slice();setTimeout(function(){for(var Z=0;Z<O.length;++Z)O[Z](w);he>=0&&setTimeout(function(){d.restoreContext()},he)},0)}},d.restoreContext=function(){v&&E.length&&setTimeout(function(){if(!G)throw"can not restore. webglcontestlost listener did not call event.preventDefault";Ss(),f(g),v=!1,L=0,G=!1;for(var w=E.slice(),O=ni("context restored"),Z=0;Z<w.length;++Z)w[Z](O)},0)},d.loseContextInNCalls=function(w){if(v)throw"You can not ask a lost contet to be lost";T=L+w},d.getNumCalls=function(){return L},d.setRestoreTimeout=function(w){he=w},d;function Ms(w){for(var O in w)typeof w[O]=="function"?b[O]=qe(w,O):u(b,w,O);b.getError=function(){if(me(),!v)for(;W=g.getError();)ue[W]=!0;for(var W in ue)if(ue[W])return delete ue[W],W;return b.NO_ERROR};for(var Z=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],Q=0;Q<Z.length;++Q){var ve=Z[Q];b[ve]=function(W){return function(){if(me(),v)return null;var It=W.apply(w,arguments);return It.__webglDebugContextLostId__=y,R.push(It),It}}(w[ve])}var ai=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(Q=0;Q<ai.length;++Q)ve=ai[Q],b[ve]=function(W){return function(){return me(),v?null:W.apply(w,arguments)}}(b[ve]);var oi=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(Q=0;Q<oi.length;++Q)ve=oi[Q],b[ve]=function(W){return function(){return me(),!v&&W.apply(w,arguments)}}(b[ve]);return b.checkFramebufferStatus=function(W){return function(){return me(),v?b.FRAMEBUFFER_UNSUPPORTED:W.apply(w,arguments)}}(b.checkFramebufferStatus),b.getAttribLocation=function(W){return function(){return me(),v?-1:W.apply(w,arguments)}}(b.getAttribLocation),b.getVertexAttribOffset=function(W){return function(){return me(),v?0:W.apply(w,arguments)}}(b.getVertexAttribOffset),b.isContextLost=function(){return v},b}}return{init:n,mightBeEnum:o,glEnumToString:l,glFunctionArgToString:h,glFunctionArgsToString:c,makeDebugContext:_,makeLostContextSimulatingCanvas:m,resetToInitialState:f}},(Qi=Zi())!==void 0&&(Ki.exports=Qi);const io=ft.getLogger("esri.views.WebGLDriverTest");function so(r){const e=new X(r,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE},{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,samplingMode:S.NEAREST,width:1,height:1}),t=`
precision highp float;
attribute vec2 a_pos;
uniform highp sampler2D u_texture;
varying vec4 v_color;

float getBit(in float bitset, in int bitIndex) {
  float offset = pow(2.0, float(bitIndex));
  return mod(floor(bitset / offset), 2.0);
}

void main() {
  vec4 value = texture2D(u_texture, vec2(0.0));
  float bit = getBit(value.x * 255.0, 1);

  v_color = bit * vec4(1.0);
  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,i=`
precision highp float;
varying vec4 v_color;

void main() {
  gl_FragColor = v_color;
}
`,s=new Uint8Array(4),n=$e.createVertex(r,ze.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),a=new Le(r,new Map([["a_position",0]]),{geometry:[new _t("a_position",2,dt.SHORT,0,4)]},{geometry:n}),o=r.programCache.acquire(t,i,new Map([["a_pos",0]]));r.useProgram(o);const l=new K(r,{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,samplingMode:S.NEAREST,width:1,height:1},new Uint8Array([2,255,0,0]));o.setUniform1i("u_texture",0),r.bindTexture(l,0);const h=r.getBoundFramebufferObject();r.bindFramebuffer(e),r.useProgram(o);const{x:c,y:u,width:_,height:f}=r.getViewport();r.setViewport(0,0,1,1),r.bindVAO(a),r.drawArrays(re.TRIANGLE_STRIP,0,4),r.setViewport(c,u,_,f),e.readPixels(0,0,1,1,F.RGBA,M.UNSIGNED_BYTE,s),o.dispose(),a.dispose(!1),n.dispose(),e.dispose();const m=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return m&&io.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),r.bindFramebuffer(h),m}async function ro(r){const e=new Image;if(e.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",e.width=5,e.height=5,await e.decode(),!r.gl)return!0;const t=new X(r,{colorTarget:j.TEXTURE,depthStencilTarget:Y.NONE},{target:I.TEXTURE_2D,wrapMode:U.CLAMP_TO_EDGE,pixelFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,samplingMode:S.NEAREST,width:1,height:1}),i=$e.createVertex(r,ze.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),s=new Le(r,new Map([["a_pos",0]]),os,{geometry:i}),n=`
  precision highp float;

  attribute vec2 a_pos;
  varying vec2 v_uv;

  void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,a=`
  precision highp float;

  varying vec2 v_uv;
  uniform sampler2D u_texture;

  void main() {
    gl_FragColor = texture2D(u_texture, v_uv);
  }
  `,o=r.programCache.acquire(n,a,new Map([["a_pos",0]]));r.useProgram(o);const l=new K(r,{dataType:M.UNSIGNED_BYTE,pixelFormat:F.RGBA,preMultiplyAlpha:!1,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR},e);r.bindTexture(l,0),o.setUniform1i("u_texture",0);const h=r.getBoundFramebufferObject(),{x:c,y:u,width:_,height:f}=r.getViewport();r.bindFramebuffer(t),r.setViewport(0,0,1,1),r.setClearColor(0,0,0,0),r.setBlendingEnabled(!1),r.clearSafe(et.COLOR_BUFFER_BIT),r.bindVAO(s),r.drawArrays(re.TRIANGLE_STRIP,0,4);const m=new Uint8Array(4);return t.readPixels(0,0,1,1,F.RGBA,M.UNSIGNED_BYTE,m),o.dispose(),s.dispose(!1),i.dispose(),t.dispose(),l.dispose(),r.setViewport(c,u,_,f),r.bindFramebuffer(h),e.src="",m[0]===255}class no{constructor(e){this.context=e,this._floatBufferBlendWorking=to(e),ro(e).then(t=>this._svgAlwaysPremultipliesAlpha=!t)}get floatBufferBlendWorking(){if(P(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if(P(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if(P(this._doublePrecisionRequiresObfuscation)){const e=Yi(this.context,!1),t=Yi(this.context,!0);this._doublePrecisionRequiresObfuscation=e!==0&&(t===0||e/t>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return P(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=so(this.context)),this._ignoresSamplerPrecision}}function ao(r,e){if(e.disjointTimerQuery)return null;if(q(r))return{drawBuffers:r.drawBuffers.bind(r),MAX_DRAW_BUFFERS:r.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:r.MAX_COLOR_ATTACHMENTS};if(e.drawBuffers)return null;const t=r.getExtension("WEBGL_draw_buffers");return t?{drawBuffers:t.drawBuffersWEBGL.bind(t),MAX_DRAW_BUFFERS:t.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:t.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function oo(r){if(q(r))return{drawArraysInstanced:r.drawArraysInstanced.bind(r),drawElementsInstanced:r.drawElementsInstanced.bind(r),vertexAttribDivisor:r.vertexAttribDivisor.bind(r)};const e=r.getExtension("ANGLE_instanced_arrays");return e?{drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e),vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e)}:null}function lo(r,e){if(e.compressedTextureETC)return null;const t=r.getExtension("WEBGL_compressed_texture_etc");return t?{COMPRESSED_R11_EAC:t.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:t.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:t.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:t.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:t.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:t.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:t.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function ho(r,e){if(e.compressedTextureS3TC)return null;const t=r.getExtension("WEBGL_compressed_texture_s3tc");return t?{COMPRESSED_RGB_S3TC_DXT1:t.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:t.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:t.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:t.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function uo(r,e){if(q(r))return{MIN:r.MIN,MAX:r.MAX};if(e.blendMinMax)return null;{const t=r.getExtension("EXT_blend_minmax");return t?{MIN:t.MIN_EXT,MAX:t.MAX_EXT}:null}}function co(r,e){if(e.textureFilterAnisotropic)return null;const t=r.getExtension("EXT_texture_filter_anisotropic")||r.getExtension("MOZ_EXT_texture_filter_anisotropic")||r.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return t?{MAX_TEXTURE_MAX_ANISOTROPY:t.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:t.TEXTURE_MAX_ANISOTROPY_EXT}:null}function _o(r,e){if(q(r))return{textureFloat:!0,textureFloatLinear:!e.textureFloatLinear&&!!r.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!0,HALF_FLOAT:r.HALF_FLOAT,R16F:r.R16F,RG16F:r.RG16F,RGBA16F:r.RGBA16F,R32F:r.R32F,RG32F:r.RG32F,RGBA32F:r.RGBA32F,R11F_G11F_B10F:r.R11F_G11F_B10F,RGB16F:r.RGB16F};if(r instanceof WebGLRenderingContext){const t=!e.textureHalfFloat&&r.getExtension("OES_texture_half_float");return{textureFloat:!e.textureFloat&&!!r.getExtension("OES_texture_float"),textureFloatLinear:!e.textureFloatLinear&&!!r.getExtension("OES_texture_float_linear"),textureHalfFloat:!!t,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!r.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:t?t.HALF_FLOAT_OES:void 0}}return null}function fo(r,e){if(q(r)){const t=!e.colorBufferHalfFloat&&r.getExtension("EXT_color_buffer_half_float")||!e.colorBufferFloat&&r.getExtension("EXT_color_buffer_float"),i=!e.colorBufferFloat&&r.getExtension("EXT_color_buffer_float"),s=!e.floatBlend&&!e.colorBufferFloat&&r.getExtension("EXT_float_blend");return t||i||s?{textureFloat:!!i,textureHalfFloat:!!t,floatBlend:!!s,R16F:r.R16F,RG16F:r.RG16F,RGBA16F:r.RGBA16F,R32F:r.R32F,RG32F:r.RG32F,RGBA32F:r.RGBA32F,R11F_G11F_B10F:r.R11F_G11F_B10F,RGB16F:r.RGB16F}:null}if(r instanceof WebGLRenderingContext){const t=!e.colorBufferHalfFloat&&r.getExtension("EXT_color_buffer_half_float"),i=!e.colorBufferFloat&&r.getExtension("WEBGL_color_buffer_float"),s=!e.floatBlend&&!e.colorBufferFloat&&r.getExtension("EXT_float_blend");return t||i||s?{textureFloat:!!i,textureHalfFloat:!!t,floatBlend:!!s,RGBA16F:t?t.RGBA16F_EXT:void 0,RGB16F:t?t.RGB16F_EXT:void 0,RGBA32F:i?i.RGBA32F_EXT:void 0}:null}return null}function Qe(r,e,t,i,s){if(i&&q(r))return!0;if(e[t])return!1;for(const n of s)if(r.getExtension(n))return!0;return!1}function mo(r,e){if(!q(r)||e.textureNorm16)return null;const t=r.getExtension("EXT_texture_norm16");return t?{R16:t.R16_EXT,RG16:t.RG16_EXT,RGB16:t.RGB16_EXT,RGBA16:t.RGBA16_EXT,R16_SNORM:t.R16_SNORM_EXT,RG16_SNORM:t.RG16_SNORM_EXT,RGB16_SNORM:t.RGB16_SNORM_EXT,RGBA16_SNORM:t.RGBA16_SNORM_EXT}:null}function po(r,e){const t=e.loseContext&&r.getExtension("WEBGL_lose_context");return t?{loseRenderingContext:()=>t.loseContext()}:null}function go(r,e){if(q(r))return{createVertexArray:r.createVertexArray.bind(r),deleteVertexArray:r.deleteVertexArray.bind(r),bindVertexArray:r.bindVertexArray.bind(r)};if(e.vao)return null;const t=r.getExtension("OES_vertex_array_object")||r.getExtension("MOZ_OES_vertex_array_object")||r.getExtension("WEBKIT_OES_vertex_array_object");return t?{createVertexArray:t.createVertexArrayOES.bind(t),deleteVertexArray:t.deleteVertexArrayOES.bind(t),bindVertexArray:t.bindVertexArrayOES.bind(t)}:null}class bo{constructor(e,t){this.gl=e,this._depthTexture=null,this._standardDerivatives=null,this._shaderTextureLOD=null,this._fragDepth=null,this._textureFloatLinear=null,this._disabledExtensions=t.disabledExtensions||{},this._debugWebGLExtensions=t.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=ao(this.gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=oo(this.gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=go(this.gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=lo(this.gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=ho(this.gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=co(this.gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=ws(this.gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=_o(this.gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=fo(this.gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=uo(this.gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return this._depthTexture===null&&(this._depthTexture=Qe(this.gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get standardDerivatives(){return this._standardDerivatives===null&&(this._standardDerivatives=Qe(this.gl,this._disabledExtensions,"standardDerivatives",!0,["OES_standard_derivatives"])),this._standardDerivatives}get shaderTextureLOD(){return this._shaderTextureLOD===null&&(this._shaderTextureLOD=Qe(this.gl,this._disabledExtensions,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),this._shaderTextureLOD}get fragDepth(){return this._fragDepth===null&&(this._fragDepth=Qe(this.gl,this._disabledExtensions,"fragDepth",!0,["EXT_frag_depth"])),this._fragDepth}get loseContext(){return this._loseContext||(this._loseContext=po(this.gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=mo(this.gl,this._disabledExtensions)),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear===null&&(this._textureFloatLinear=Qe(this.gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"])),this._textureFloatLinear}enable(e){return this[e]}}class vo{constructor(e,t){this.gl=e,this.instanceCounter=new eo,this.programCache=new Or(this),this._state=new ji,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=q(e)?Ft.WEBGL2:Ft.WEBGL1,this._loadExtensions(),this.configure(t)}configure(e){this._capabilities=new bo(this.gl,e),this._parameters=this._loadParameters(e);const t=this.gl.getParameter(this.gl.VIEWPORT);this._state=new ji,this._state.viewport={x:t[0],y:t[1],width:t[2],height:t[3]},this._stateTracker=new Zr({setBlending:i=>{if(i){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(i.opRgb,i.opAlpha),this.setBlendFunctionSeparate(i.srcRgb,i.dstRgb,i.srcAlpha,i.dstAlpha);const s=i.color;this.setBlendColor(s.r,s.g,s.b,s.a)}else this.setBlendingEnabled(!1)},setCulling:i=>{i?(this.setFaceCullingEnabled(!0),this.setCullFace(i.face),this.setFrontFace(i.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:i=>{i?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(i.factor,i.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:i=>{i?(this.setDepthTestEnabled(!0),this.setDepthFunction(i.func)):this.setDepthTestEnabled(!1)},setStencilTest:i=>{if(i){this.setStencilTestEnabled(!0);const s=i.function;this.setStencilFunction(s.func,s.ref,s.mask);const n=i.operation;this.setStencilOp(n.fail,n.zFail,n.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:i=>{i?(this.setDepthWriteEnabled(!0),this.setDepthRange(i.zNear,i.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:i=>{i?this.setColorMask(i.r,i.g,i.b,i.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:i=>{i?this.setStencilWriteMask(i.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this._driverTest=new no(this)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(B.ARRAY_BUFFER),this.unbindBuffer(B.ELEMENT_ARRAY_BUFFER),q(this.gl)&&(this.unbindBuffer(B.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(B.PIXEL_PACK_BUFFER),this.unbindBuffer(B.PIXEL_UNPACK_BUFFER),this.unbindBuffer(B.COPY_READ_BUFFER),this.unbindBuffer(B.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,Fe()&&this.instanceCounter.printResourceCount()}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(e===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){this._state.program?.stop(),this._state.program=null}externalTextureUnitUpdate(e,t){for(let i=0;i<e.length;++i)this._state.textureUnitMap[e[i]]=null;t>=0&&(this._state.activeTexture=t)}externalVertexArrayObjectUpdate(){const e=this.capabilities.vao;e&&(e.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,t,i,s){e===this._state.blendColor.r&&t===this._state.blendColor.g&&i===this._state.blendColor.b&&s===this._state.blendColor.a||(this.gl.blendColor(e,t,i,s),this._state.blendColor.r=e,this._state.blendColor.g=t,this._state.blendColor.b=i,this._state.blendColor.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(e,t){e===this._state.blendFunction.srcRGB&&t===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,t),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=t,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,t,i,s){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===t&&this._state.blendFunction.dstAlpha===s||(this.gl.blendFuncSeparate(e,t,i,s),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=t,this._state.blendFunction.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,t){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===t||(this.gl.blendEquationSeparate(e,t),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setColorMask(e,t,i,s){this._state.colorMask.r===e&&this._state.colorMask.g===t&&this._state.colorMask.b===i&&this._state.colorMask.a===s||(this.gl.colorMask(e,t,i,s),this._state.colorMask.r=e,this._state.colorMask.g=t,this._state.colorMask.b=i,this._state.colorMask.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(e,t,i,s){this._state.clearColor.r===e&&this._state.clearColor.g===t&&this._state.clearColor.b===i&&this._state.clearColor.a===s||(this.gl.clearColor(e,t,i,s),this._state.clearColor.r=e,this._state.clearColor.g=t,this._state.clearColor.b=i,this._state.clearColor.a=s)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(e===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(e===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,t){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===t||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=t,this.gl.polygonOffset(e,t),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(e===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,t,i,s){this._state.scissorRect.x===e&&this._state.scissorRect.y===t&&this._state.scissorRect.width===i&&this._state.scissorRect.height===s||(this.gl.scissor(e,t,i,s),this._state.scissorRect.x=e,this._state.scissorRect.y=t,this._state.scissorRect.width=i,this._state.scissorRect.height=s)}setDepthTestEnabled(e){this._state.depthTest!==e&&(e===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,t){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===t||(this.gl.depthRange(e,t),this._state.depthRange.zNear=e,this._state.depthRange.zFar=t,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(e===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,t,i){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===t&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(e,t,i),this._state.stencilFunction.face=Ie.FRONT_AND_BACK,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=t,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,t,i,s){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===s||(this.gl.stencilFuncSeparate(e,t,i,s),this._state.stencilFunction.face=e,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,t,i){this._state.stencilOperation.face===Ie.FRONT_AND_BACK&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===t&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(e,t,i),this._state.stencilOperation.face=Ie.FRONT_AND_BACK,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=t,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,t,i,s){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===s||(this.gl.stencilOpSeparate(e,t,i,s),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,t=!1){const i=this._state.activeTexture;return e>=0&&(t||e!==this._state.activeTexture)&&(this.gl.activeTexture(Nt+e),this._state.activeTexture=e),i}clear(e){e&&this.gl.clear(e)}clearSafe(e,t=255){e&&(e&et.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),e&et.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),e&et.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(t),this.gl.clear(e))}drawArrays(e,t,i){if(Fe()&&(this._numOfDrawCalls++,this._numOfTriangles+=Ji(e,i)),this.gl.drawArrays(e,t,i),Fe()){const s=gi(this);s&&console.error("drawArrays:",s)}}drawElements(e,t,i,s){if(Fe()&&(this._numOfDrawCalls++,this._numOfTriangles+=Ji(e,t)),this.gl.drawElements(e,t,i,s),Fe()){const n=gi(this);if(n){const a=this.getBoundVAO(),o=a?.indexBuffer,l=a?.vertexBuffers,h={indexBuffer:o,vertexBuffers:l},c={mode:e,count:t,type:i,offset:s},u=Xs(o,m=>m.size)??0,_=s+t,f=u<_?`. Buffer is too small. Attempted to draw index ${_} of ${u}`:"";console.error(`drawElements: ${n}${f}`,{args:c,vao:h})}}}logInfo(){Fe()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){Fe()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,t,i,s){i=Math.max(Math.round(i),1),s=Math.max(Math.round(s),1);const n=this._state.viewport;n.x===e&&n.y===t&&n.width===i&&n.height===s||(n.x=e,n.y=t,n.width=i,n.height=s,this.gl.viewport(e,t,i,s))}getViewport(){return{x:this._state.viewport.x,y:this._state.viewport.y,width:this._state.viewport.width,height:this._state.viewport.height}}useProgram(e){this._state.program!==e&&(this._state.program?.stop(),this._state.program=e,this.gl.useProgram(e?.glName??null))}bindTexture(e,t,i=!1){(t>=this.parameters.maxTextureImageUnits||t<0)&&console.error("Input texture unit is out of range of available units!");const s=this._state.textureUnitMap[t];return P(e)||e.glName==null?(D(s)&&(this.setActiveTexture(t,i),this.gl.bindTexture(s.descriptor.target,null)),this._state.textureUnitMap[t]=null,s):i||s!==e?(this.setActiveTexture(t,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[t]=e,s):(e.isDirty&&(this.setActiveTexture(t,i),e.applyChanges()),s)}unbindTexture(e){if(!P(e))for(let t=0;t<this.parameters.maxTextureImageUnits;t++)this._state.textureUnitMap[t]===e&&(this.bindTexture(null,t),this._state.textureUnitMap[t]=null)}bindFramebuffer(e,t=!1){if(t||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(P(e))return this.gl.bindFramebuffer(de.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);e.initializeAndBind(de.FRAMEBUFFER),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,t,i=!1){const s=t===de.READ_FRAMEBUFFER,n=s?this._state.readFramebuffer:this._state.drawFramebuffer;(i||n!==e)&&(P(e)?this.gl.bindFramebuffer(t,null):e.initializeAndBind(t),s?this._state.readFramebuffer=hi(e,null):this._state.drawFramebuffer=hi(e,null))}blitFramebuffer(e,t,i=0,s=0,n=e.width,a=e.height,o=0,l=0,h=t.width,c=t.height,u=et.COLOR_BUFFER_BIT,_=S.NEAREST){this.bindFramebufferSeparate(e,de.READ_FRAMEBUFFER),this.bindFramebufferSeparate(t,de.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(i,s,n,a,o,l,h,c,u,_)}bindBuffer(e,t){if(e)switch(t??(t=e.bufferType),t){case B.ARRAY_BUFFER:this._state.vertexBuffer=ee(this.gl,e,t,this._state.vertexBuffer);break;case B.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=ee(this.gl,e,t,this._state.indexBuffer);break;case B.UNIFORM_BUFFER:this._state.uniformBuffer=ee(this.gl,e,t,this._state.uniformBuffer);break;case B.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=ee(this.gl,e,t,this._state.pixelPackBuffer);break;case B.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=ee(this.gl,e,t,this._state.pixelUnpackBuffer);break;case B.COPY_READ_BUFFER:this._state.copyReadBuffer=ee(this.gl,e,t,this._state.copyReadBuffer);break;case B.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=ee(this.gl,e,t,this._state.copyWriteBuffer)}}bindRenderbuffer(e){const t=this.gl;e||(t.bindRenderbuffer(t.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(t.bindRenderbuffer(t.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,t){if(t>=this.parameters.maxUniformBufferBindings||t<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=this._state.uniformBufferBindingPoints;let s=i[t];return P(s)&&(s={buffer:null,offset:0,size:0},i[t]=s),s}bindBufferBase(e,t,i){const s=this._getBufferBinding(e,t);P(s)||s.buffer===i&&s.offset===0&&s.size===0||(this.gl.bindBufferBase(e,t,i?i.glName:null),s.buffer=i,s.offset=0,s.size=0)}bindBufferRange(e,t,i,s,n){const a=this._getBufferBinding(e,t);if(!P(a)&&!(a.buffer===i&&a.offset===s&&a.size===n)){if(s%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(e,t,i.glName,s,n),a.buffer=i,a.offset=s,a.size=n}}bindUBO(e,t,i,s){P(t)?this.bindBufferBase(B.UNIFORM_BUFFER,e,null):(Fe()&&(s??t.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),t.initialize(),i!==void 0&&s!==void 0?this.bindBufferRange(B.UNIFORM_BUFFER,e,t.buffer,i,s):this.bindBufferBase(B.UNIFORM_BUFFER,e,t.buffer))}unbindUBO(e){for(let t=0,i=this._state.uniformBufferBindingPoints.length;t<i;t++){const s=this._state.uniformBufferBindingPoints[t];D(s)&&s.buffer===e.buffer&&this.bindBufferBase(B.UNIFORM_BUFFER,t,null)}}unbindBuffer(e){switch(e){case B.ARRAY_BUFFER:this._state.vertexBuffer=ee(this.gl,null,e,this._state.vertexBuffer);break;case B.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=ee(this.gl,null,e,this._state.indexBuffer);break;case B.UNIFORM_BUFFER:this._state.uniformBuffer=ee(this.gl,null,e,this._state.uniformBuffer);break;case B.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=ee(this.gl,null,e,this._state.pixelPackBuffer);break;case B.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=ee(this.gl,null,e,this._state.pixelUnpackBuffer);break;case B.COPY_READ_BUFFER:this._state.copyReadBuffer=ee(this.gl,null,e,this._state.copyReadBuffer);break;case B.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=ee(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e=null){P(e)?this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null):this._state.vertexArrayObject!==e&&(e.bind(),this._state.vertexArrayObject=e)}async clientWaitAsync(e=te(10)){const t=this.gl,i=t.fenceSync(Ir.SYNC_GPU_COMMANDS_COMPLETE,0);let s;this.instanceCounter.increment(rt.Sync,i),t.flush();do await Hs(e),s=t.clientWaitSync(i,0,0);while(s===bi.TIMEOUT_EXPIRED);if(this.instanceCounter.decrement(rt.Sync,i),t.deleteSync(i),s===bi.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(e=de.FRAMEBUFFER){return e===de.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(B.ARRAY_BUFFER),this.unbindBuffer(B.ELEMENT_ARRAY_BUFFER),q(this.gl)&&(this.unbindBuffer(B.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(B.PIXEL_PACK_BUFFER),this.unbindBuffer(B.PIXEL_UNPACK_BUFFER),this.unbindBuffer(B.COPY_READ_BUFFER),this.unbindBuffer(B.COPY_WRITE_BUFFER));for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(A.ONE,A.ZERO),this.setBlendEquation(Kt.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(Ie.BACK),this.setFrontFace(ls.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(We.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(We.ALWAYS,0,0),this.setStencilOp(Te.KEEP,Te.KEEP,Te.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const e=this.gl,t=this.capabilities.vao;t&&t.bindVertexArray(null);for(let i=0;i<this.parameters.maxVertexAttributes;i++)e.disableVertexAttribArray(i);if(this._state.vertexBuffer?e.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):e.bindBuffer(B.ARRAY_BUFFER,null),this._state.indexBuffer?e.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):e.bindBuffer(B.ELEMENT_ARRAY_BUFFER,null),q(e)){this._state.uniformBuffer?e.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):e.bindBuffer(B.UNIFORM_BUFFER,null);for(let i=0;i<this._parameters.maxUniformBufferBindings;i++){const s=this._state.uniformBufferBindingPoints[i];if(D(s)){const{buffer:n,offset:a,size:o}=s;n!==null?a===0&&o===0?e.bindBufferBase(B.UNIFORM_BUFFER,i,n.glName):e.bindBufferRange(B.UNIFORM_BUFFER,i,n.glName,a,o):e.bindBufferBase(B.UNIFORM_BUFFER,i,null)}}this._state.pixelPackBuffer?e.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):e.bindBuffer(B.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?e.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):e.bindBuffer(B.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?e.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):e.bindBuffer(B.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?e.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):e.bindBuffer(B.COPY_WRITE_BUFFER,null),e.bindFramebuffer(de.READ_FRAMEBUFFER,null),e.readBuffer(e.BACK),this._state.readFramebuffer&&(e.bindFramebuffer(de.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),e.readBuffer(Ur.COLOR_ATTACHMENT0)),e.bindFramebuffer(de.DRAW_FRAMEBUFFER,this._state.drawFramebuffer?.glName??null)}else this._state.readFramebuffer=this._state.drawFramebuffer,e.bindFramebuffer(de.FRAMEBUFFER,this._state.drawFramebuffer?.glName??null);if(t&&this._state.vertexArrayObject){const i=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(i)}e.useProgram(this._state.program?.glName??null),e.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),e.bindRenderbuffer(e.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),this._state.blend===!0?e.enable(this.gl.BLEND):e.disable(this.gl.BLEND),e.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),e.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),e.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),e.clearDepth(this._state.clearDepth),e.clearStencil(this._state.clearStencil),e.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),e.cullFace(this._state.cullFace),e.depthFunc(this._state.depthFunction),e.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthMask(this._state.depthWrite),e.frontFace(this._state.frontFace),e.lineWidth(1),this._state.faceCulling===!0?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),e.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?e.enable(e.POLYGON_OFFSET_FILL):e.disable(e.POLYGON_OFFSET_FILL),e.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?e.enable(e.SCISSOR_TEST):e.disable(e.SCISSOR_TEST),e.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),e.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),e.stencilMask(this._state.stencilWriteMask);for(let i=0;i<this.parameters.maxTextureImageUnits;i++){e.activeTexture(Nt+i),e.bindTexture(I.TEXTURE_2D,null),e.bindTexture(I.TEXTURE_CUBE_MAP,null),q(e)&&(e.bindTexture(I.TEXTURE_3D,null),e.bindTexture(I.TEXTURE_2D_ARRAY,null));const s=this._state.textureUnitMap[i];D(s)&&e.bindTexture(s.descriptor.target,s.glName)}e.activeTexture(Nt+this._state.activeTexture),e.viewport(this._state.viewport.x,this._state.viewport.y,this._state.viewport.width,this._state.viewport.height),this.resetInfo()}_loadExtensions(){this.type===Ft.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}_loadParameters(e){const t=this.capabilities.textureFilterAnisotropic,i=e.maxAnisotropy??1/0,s=q(this.gl),n=this.gl,a={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:t?Math.min(this.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY),i):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),maxUniformBufferBindings:s?n.getParameter(n.MAX_UNIFORM_BUFFER_BINDINGS):0,maxVertexUniformBlocks:s?n.getParameter(n.MAX_VERTEX_UNIFORM_BLOCKS):0,maxFragmentUniformBlocks:s?n.getParameter(n.MAX_FRAGMENT_UNIFORM_BLOCKS):0,maxUniformBlockSize:s?n.getParameter(n.MAX_UNIFORM_BLOCK_SIZE):0,uniformBufferOffsetAlignment:s?n.getParameter(n.UNIFORM_BUFFER_OFFSET_ALIGNMENT):1,maxArrayTextureLayers:s?n.getParameter(n.MAX_ARRAY_TEXTURE_LAYERS):1,maxSamples:s?n.getParameter(n.MAX_SAMPLES):1};return K.TEXTURE_UNIT_FOR_UPDATES=a.maxTextureImageUnits-1,a}}function ee(r,e,t,i){return e?i!==e&&r.bindBuffer(t,e.glName):r.bindBuffer(t,null),e}function Ji(r,e){switch(r){case re.POINTS:return 2*e;case re.TRIANGLES:return e/3;case re.TRIANGLE_STRIP:case re.TRIANGLE_FAN:return e-2;default:return 0}}const Eo=2e3;class zl extends fi{constructor(e,t){super(),this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this.renderRequested=!1,this.stage=this,this._stationary=!0;const{canvas:i=document.createElement("canvas"),alpha:s=!0,stencil:n=!0,contextOptions:a={}}=t;this._canvas=i;const o=qs("2d",i,{alpha:s,antialias:!1,depth:!0,stencil:n});this.context=new vo(D(o)?o:null,a),this.resourceManager=new vr,this.painter=new Ka(this.context,this,this.resourceManager),Bt("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput)),this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:t.timeline||new js,renderingOptions:t.renderingOptions,requestRender:()=>this.requestRender(),requireFBO:!1,profiler:new Za(this.context,this._debugOutput),dataUploadCounter:0},this._taskHandle=Ys({render:l=>this.renderFrame(l)}),this._taskHandle.pause(),this._lostWebGLContextHandle=Ks(i,"webglcontextlost",()=>{this.emit("webgl-error",{error:new H("webgl-context-lost")})}),i.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(i)}destroy(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this.resourceManager.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get highlightOptions(){return this._highlightOptions}set highlightOptions(e){this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=Rt(()=>this._highlightOptions?.version,()=>{this.painter.setHighlightOptions(e),this.requestRender()},ss))}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=Eo,this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}renderFrame(e){const t=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0;this._renderRemainingTime-=t,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}_createTransforms(){return{dvs:Jt()}}renderChildren(e){for(const t of this.children)t.beforeRender(e);this._renderChildren(this.children,e);for(const t of this.children)t.afterRender(e)}_renderChildren(e,t){const i=this.context;i.resetInfo(),t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,t.drawPhase=se.MAP,this.painter.beforeRenderLayers(i,this.background);for(const s of e)s.processRender(t);this.painter.prepareDisplay(t,this.background,this.state.padding),this.painter.renderLayers(i),t.drawPhase=se.HIGHLIGHT,this.painter.beforeRenderLayers(i);for(const s of e)s.processRender(t);if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=se.LABEL,this.painter.beforeRenderLayers(i);for(const s of e)s.processRender(t);this.painter.renderLayers(i)}if(Bt("esri-tiles-debug")){t.drawPhase=se.DEBUG,this.painter.beforeRenderLayers(i);for(const s of e)s.processRender(t);this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),i.logInfo()}doRender(e){const t=this.context,{state:i,pixelRatio:s}=e;this._resizeCanvas(e),t.setViewport(0,0,s*i.size[0],s*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),super.doRender(e)}async takeScreenshot(e){const{framebufferWidth:t,framebufferHeight:i}={framebufferWidth:Math.round(this.state.size[0]*e.resolutionScale),framebufferHeight:Math.round(this.state.size[1]*e.resolutionScale)},s=1,n=this.context,a=this._state.clone();if(e.rotation!=null){const m=a.viewpoint;a.viewpoint.rotation=e.rotation,a.viewpoint=m}const o={...this._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:a,pixelRatio:s,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1},l=new X(n,{colorTarget:j.TEXTURE,depthStencilTarget:Y.DEPTH_STENCIL_RENDER_BUFFER,width:t,height:i}),h=n.getBoundFramebufferObject(),c=n.getViewport();n.bindFramebuffer(l),n.setViewport(0,0,t,i),this._renderChildren(e.children,o);const u=this._readbackScreenshot(l,{...e.cropArea,y:i-(e.cropArea.y+e.cropArea.height)});n.bindFramebuffer(h),n.setViewport(c.x,c.y,c.width,c.height),this.requestRender();const _=await u;let f;return e.outputScale===1?f=_:(f=new ImageData(Math.round(_.width*e.outputScale),Math.round(_.height*e.outputScale)),Zs(_,f,!0)),f}async _readbackScreenshot(e,t){const i=Qs(t.width,t.height,document.createElement("canvas"));return await e.readPixelsAsync(t.x,t.y,t.width,t.height,F.RGBA,M.UNSIGNED_BYTE,new Uint8Array(i.data.buffer)),i}_resizeCanvas(e){const t=this._canvas,i=t.style,{state:{size:s},pixelRatio:n}=e,a=s[0],o=s[1],l=Math.round(a*n),h=Math.round(o*n);t.width===l&&t.height===h||(t.width=l,t.height=h),i.width=a+"px",i.height=o+"px"}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const t of e)t.processDetach()}}_isLabelDrawPhaseRequired(e){let t=!1;for(const i of e){if(!(i instanceof fi)){t=t||!1;break}if(i.hasLabels)return!0;t=t||this._isLabelDrawPhaseRequired(i.children)}return t}}const Et=2,pe=1,nt=0,at=1,ot=2;class xo{constructor(e,t){this.width=e,this.height=t;const i=Math.ceil(e/pe),s=Math.ceil(t/pe);this._cols=i,this._rows=s,this._cells=Qr.create(i*s)}insertMetrics(e){const t=this._hasCollision(e);return t===nt&&this._markMetrics(e),t}getCellId(e,t){return e+t*this._cols}has(e){return this._cells.has(e)}hasRange(e,t){return this._cells.hasRange(e,t)}set(e){this._cells.set(e)}setRange(e,t){this._cells.setRange(e,t)}_hasCollision(e){const t=e.id;let i=0,s=0;e.save();do{const n=e.boundsCount;i+=n;for(let a=0;a<n;a++){const o=e.boundsComputedAnchorX(a),l=e.boundsComputedAnchorY(a),h=e.boundsWidth(a)+Et,c=e.boundsHeight(a)+Et;switch(this._collide(o,l,h,c)){case ot:return ot;case at:s++}}}while(e.peekId()===t&&e.next());return e.restore(),i===s?at:nt}_collide(e,t,i,s){const n=e-i/2,a=t-s/2,o=n+i,l=a+s;if(o<0||l<0||n>this.width||a>this.height)return at;const h=le(Math.floor(n/pe),0,this._cols),c=le(Math.floor(a/pe),0,this._rows),u=le(Math.ceil(o/pe),0,this._cols),_=le(Math.ceil(l/pe),0,this._rows);for(let f=c;f<=_;f++)for(let m=h;m<=u;m++){const d=this.getCellId(m,f);if(this.has(d))return ot}return nt}_mark(e,t,i,s){const n=e-i/2,a=t-s/2,o=n+i,l=a+s,h=le(Math.floor(n/pe),0,this._cols),c=le(Math.floor(a/pe),0,this._rows),u=le(Math.ceil(o/pe),0,this._cols),_=le(Math.ceil(l/pe),0,this._rows);for(let f=c;f<=_;f++)for(let m=h;m<=u;m++){const d=this.getCellId(m,f);this.set(d)}return!1}_markMetrics(e){const t=e.id;do{const i=e.boundsCount;for(let s=0;s<i;s++){const n=e.boundsComputedAnchorX(s),a=e.boundsComputedAnchorY(s),o=e.boundsWidth(s)+Et,l=e.boundsHeight(s)+Et;this._mark(n,a,o,l)}}while(e.peekId()===t&&e.next())}}const yo=Math.PI;function Rs(r,e){switch(e.transformationType){case we.Additive:return To(r,e);case we.Constant:return wo(e,r);case we.ClampedLinear:return Fo(r,e);case we.Proportional:return Ro(r,e);case we.Stops:return Bo(r,e);case we.RealWorldSize:return Ao(r,e);case we.Identity:return r;case we.Unknown:return null}}function fe(r,e){return typeof r=="number"?r:Rs(e,r)}function To(r,e){return r+(fe(e.minSize,r)||e.minDataValue)}function wo(r,e){const t=r.stops;let i=t&&t.length&&t[0].size;return i==null&&(i=r.minSize),fe(i,e)}function Fo(r,e){const t=(r-e.minDataValue)/(e.maxDataValue-e.minDataValue),i=fe(e.minSize,r),s=fe(e.maxSize,r);return r<=e.minDataValue?i:r>=e.maxDataValue?s:i+t*(s-i)}function Ro(r,e){const t=r/e.minDataValue,i=fe(e.minSize,r),s=fe(e.maxSize,r);let n=null;return n=t*i,le(n,i,s)}function Bo(r,e){const[t,i,s]=So(r,e.cache.ipData);if(t===i)return fe(e.stops[t].size,r);{const n=fe(e.stops[t].size,r);return n+(fe(e.stops[i].size,r)-n)*s}}function Ao(r,e){const t=Js[e.valueUnit],i=fe(e.minSize,r),s=fe(e.maxSize,r),{valueRepresentation:n}=e;let a=null;return a=n==="area"?2*Math.sqrt(r/yo)/t:n==="radius"||n==="distance"?2*r/t:r/t,le(a,i,s)}function So(r,e){if(!e)return;let t=0,i=e.length-1;return e.some((s,n)=>r<s?(i=n,!0):(t=n,!1)),[t,i,(r-e[t])/(e[i]-e[t])]}const Vt=254,xt=255,Je=0;function ke(r,e){const t=[];r.forEachTile(i=>t.push(i)),t.sort((i,s)=>i.instanceId-s.instanceId),t.forEach(i=>{D(i.labelMetrics)&&i.isReady&&e(i,i.labelMetrics.getCursor())})}function Mo(r){return r.layer&&(r.layer.type==="feature"||r.layer.type==="csv"||r.layer.type==="geojson"||r.layer.type==="ogc-feature"||r.layer.type==="stream"||r.layer.type==="subtype-group"||r.layer.type==="wfs")}function Oo(r){return e=>Ae(Rs(e,r))}function Co(r){const e="visualVariables"in r&&r.visualVariables;if(!e)return null;for(const t of e)if(t.type==="size")return Oo(t);return null}function Po(r){for(const e of r){const t="featureReduction"in e&&e.featureReduction&&"labelingInfo"in e.featureReduction&&e.featureReduction,i=[...e.labelingInfo||[],...t?.labelingInfo||[]];if(!(!e.labelsVisible||!i.length)&&i.some(s=>s.deconflictionStrategy==="none"))return!0}return!1}function Do(r,e){if(!Mo(e))return;const t=e.layer.type==="subtype-group"?e.layer.sublayers.items:[e.layer],i=e.layer.geometryType,s=!Po(t),n={};if(e.layer.type!=="subtype-group"){if(e.tileRenderer?.type==="heatmap")return;const l=Co(e.layer.renderer);n[0]=l}const a=e.tileRenderer;if(P(a))return;const o=e.layer.visible&&!e.suspended;r.push({tileRenderer:a,vvEvaluators:n,deconflictionEnabled:s,geometryType:i,visible:o})}class Io{run(e,t,i){const s=[];for(let n=e.length-1;n>=0;n--)Do(s,e[n]);this._transformMetrics(s,t),this._runCollision(s,t,i)}_runCollision(e,t,i){const[s,n]=t.state.size,a=new xo(s*t.pixelRatio,n*t.pixelRatio);for(const{tileRenderer:o,deconflictionEnabled:l,visible:h}of e){const c=o.featuresView.attributeView;l?h?(this._prepare(o),this._collideVisible(a,o,i),this._collideInvisible(a,o)):ke(o,(u,_)=>{for(;_.nextId();)c.setLabelMinZoom(_.id,xt)}):ke(o,(u,_)=>{for(;_.nextId();)c.setLabelMinZoom(_.id,Je)})}}_isFiltered(e,t,i){const s=t.getFilterFlags(e),n=!i.hasFilter||!!(s&Wr),a=P(i.featureEffect)||i.featureEffect.excludedLabelsVisible||!!(s&Xr);return!(n&&a)}_prepare(e){const t=e.featuresView.attributeView,i=new Set;ke(e,(s,n)=>{for(;n.nextId();)if(!i.has(n.id)){if(i.add(n.id),this._isFiltered(n.id,t,e.layerView)){t.setLabelMinZoom(n.id,Vt);continue}t.getLabelMinZoom(n.id)!==Je?t.setLabelMinZoom(n.id,xt):t.setLabelMinZoom(n.id,Je)}})}_collideVisible(e,t,i){const s=t.featuresView.attributeView,n=new Set;ke(t,(a,o)=>{for(;o.nextId();)if(!n.has(o.id))if(a.key.level===i){if(s.getLabelMinZoom(o.id)===0)switch(e.insertMetrics(o)){case at:break;case ot:s.setLabelMinZoom(o.id,Vt),n.add(o.id);break;case nt:s.setLabelMinZoom(o.id,Je),n.add(o.id)}}else s.setLabelMinZoom(o.id,Vt)})}_collideInvisible(e,t){const i=t.featuresView.attributeView,s=new Set;ke(t,(n,a)=>{for(;a.nextId();)if(!s.has(a.id)&&i.getLabelMinZoom(a.id)===xt)switch(e.insertMetrics(a)){case at:break;case ot:i.setLabelMinZoom(a.id,xt),s.add(a.id);break;case nt:i.setLabelMinZoom(a.id,Je),s.add(a.id)}})}_transformMetrics(e,t){for(const{tileRenderer:i,geometryType:s,vvEvaluators:n}of e)ke(i,(a,o)=>{const l=i.featuresView.attributeView,h=a.transforms.labelMat2d;h[4]=Math.round(h[4]),h[5]=Math.round(h[5]);const c=h[4],u=h[5],_=s==="polyline";for(;o.next();){const f=o.boundsCount,m=o.anchorX,d=o.anchorY;let g=o.size;const x=n[0];if(D(x)){const b=x(l.getVVSize(o.id));g=isNaN(b)||b==null||b===1/0?g:b}const p=o.directionX*(g/2),E=o.directionY*(g/2);for(let b=0;b<f;b++){let y=m,v=o.anchorY;if(_){let R=y+o.boundsX(b)+p,T=v+o.boundsY(b)+E;t.state.rotation?(R=h[0]*R+h[2]*T+h[4],T=h[1]*R+h[3]*T+h[5]):(R+=c,T+=u),o.setBoundsComputedAnchorX(b,Math.floor(R)),o.setBoundsComputedAnchorY(b,Math.floor(T))}else{t.state.rotation?(y=h[0]*m+h[2]*d+h[4],v=h[1]*m+h[3]*d+h[5]):(y+=c,v+=u);const R=y+o.boundsX(b)+p,T=v+o.boundsY(b)+E;o.setBoundsComputedAnchorX(b,R),o.setBoundsComputedAnchorY(b,T)}}}})}}const Uo=32;ft.getLogger("esri.views.2d.layers.labels.LabelManager");let De=class extends er(Xe){constructor(r){super(r),this._applyVisibilityPassThrottled=tr(this._applyVisibilityPass,Uo,this),this.lastUpdateId=-1,this.updateRequested=!1,this.view=null}initialize(){this.collisionEngine=new Io}destroy(){this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}get updating(){return this.updateRequested}update(r){this._applyVisibilityPassThrottled(r)}viewChange(){this.requestUpdate()}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}processUpdate(r){this._set("updateParameters",r),this.updateRequested&&(this.updateRequested=!1,this.update(r))}_applyVisibilityPass(r){try{const e=this.view.featuresTilingScheme.getClosestInfoForScale(r.state.scale).level;this.collisionEngine.run(this.view.allLayerViews.items,r,e)}catch{}}};C([z()],De.prototype,"updateRequested",void 0),C([z({readOnly:!0})],De.prototype,"updateParameters",void 0),C([z()],De.prototype,"updating",null),C([z()],De.prototype,"view",void 0),De=C([He("esri.views.2d.layers.labels.LabelManager")],De);const kl=De,yt={container:"esri-zoom-box__container",overlay:"esri-zoom-box__overlay",background:"esri-zoom-box__overlay-background",box:"esri-zoom-box__outline"},Wt={zoom:"Shift",counter:"Ctrl"};let tt=class extends Xe{constructor(r){super(r),this._container=null,this._overlay=null,this._backgroundShape=null,this._boxShape=null,this._box={x:0,y:0,width:0,height:0},this._redraw=this._redraw.bind(this)}destroy(){this.view=null}set view(r){this._handles&&this._handles.forEach(e=>{e.remove()}),this._handles=null,this._destroyOverlay(),this._set("view",r),r&&(r.on("drag",[Wt.zoom],e=>this._handleDrag(e,1),ui.INTERNAL),r.on("drag",[Wt.zoom,Wt.counter],e=>this._handleDrag(e,-1),ui.INTERNAL))}_start(){this._createContainer(),this._createOverlay(),this.navigation.begin()}_update(r,e,t,i){this._box.x=r,this._box.y=e,this._box.width=t,this._box.height=i,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}_end(r,e,t,i,s){const n=this.view,a=n.toMap(ir(r+.5*t,e+.5*i));let o=Math.max(t/n.width,i/n.height);s===-1&&(o=1/o),this._destroyOverlay(),this.navigation.end(),n.goTo({center:a,scale:n.scale*o})}_updateBox(r,e,t,i){const s=this._boxShape;s.setAttributeNS(null,"x",""+r),s.setAttributeNS(null,"y",""+e),s.setAttributeNS(null,"width",""+t),s.setAttributeNS(null,"height",""+i),s.setAttributeNS(null,"class",yt.box)}_updateBackground(r,e,t,i){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(r,e,t,i,this.view.width,this.view.height))}_createContainer(){const r=document.createElement("div");r.className=yt.container,this.view.root.appendChild(r),this._container=r}_createOverlay(){const r=this.view.width,e=this.view.height,t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttributeNS(null,"d","M 0 0 L "+r+" 0 L "+r+" "+e+" L 0 "+e+" Z"),t.setAttributeNS(null,"class",yt.background);const i=document.createElementNS("http://www.w3.org/2000/svg","rect"),s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),s.setAttributeNS(null,"class",yt.overlay),s.appendChild(t),s.appendChild(i),this._container.appendChild(s),this._backgroundShape=t,this._boxShape=i,this._overlay=s}_destroyOverlay(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}_toSVGPath(r,e,t,i,s,n){const a=r+t,o=e+i;return"M 0 0 L "+s+" 0 L "+s+" "+n+" L 0 "+n+" ZM "+r+" "+e+" L "+r+" "+o+" L "+a+" "+o+" L "+a+" "+e+" Z"}_handleDrag(r,e){const t=r.x,i=r.y,s=r.origin.x,n=r.origin.y;let a,o,l,h;switch(t>s?(a=s,l=t-s):(a=t,l=s-t),i>n?(o=n,h=i-n):(o=i,h=n-i),r.action){case"start":this._start();break;case"update":this._update(a,o,l,h);break;case"end":this._end(a,o,l,h,e)}r.stopPropagation()}_redraw(){if(!this._rafId||(this._rafId=null,!this._overlay))return;const{x:r,y:e,width:t,height:i}=this._box;this._updateBox(r,e,t,i),this._updateBackground(r,e,t,i),this._rafId=requestAnimationFrame(this._redraw)}};C([z()],tt.prototype,"navigation",void 0),C([z()],tt.prototype,"view",null),tt=C([He("esri.views.2d.navigation.ZoomBox")],tt);const No=tt;class Re{constructor(e){this.gain=e}update(e){if(this.hasLastValue){const t=this.computeDelta(e);this._updateDelta(t)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return this.lastValue!==void 0}get hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(e){return e-this.lastValue}_updateDelta(e){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*e:this.filteredDelta=e}}class ri{constructor(e,t,i){this._initialVelocity=e,this._stopVelocity=t,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,t){const i=this.value(e);return this.value(e+t)-i}valueFromInitialVelocity(e,t){t=Math.min(t,this.duration);const i=1-this.friction;return e*(i**t-1)/Math.log(i)}}class Lo extends ri{constructor(e,t,i,s,n){super(e,t,i),this.sceneVelocity=s,this.direction=n}value(e){return super.valueFromInitialVelocity(this.sceneVelocity,e)}}class $o{constructor(e=300,t=12,i=.84){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.enabled=!0,this.time=new Re(.6),this.screen=[new Re(.4),new Re(.4)],this.scene=[new Re(.6),new Re(.6),new Re(.6)],this.tmpDirection=st()}add(e,t,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}createMomentum(e,t,i){wt(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=sr(this.tmpDirection);s>0&&rs(this.tmpDirection,this.tmpDirection,1/s);const n=s/this.time.filteredDelta;return new Lo(e,t,i,n,this.tmpDirection)}}let Ge=class extends Xe{constructor(r){super(r),this.animationTime=0,this.momentumEstimator=new $o(500,6,.92),this.momentum=null,this.tmpMomentum=st(),this.momentumFinished=!1,this.viewpoint=new Ct({targetGeometry:new Pt,scale:0,rotation:0}),ns(()=>this.momentumFinished,()=>this.navigation.stop())}begin(r,e){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(e),this.previousDrag=e}update(r,e){this.addToEstimator(e);let t=e.center.x,i=e.center.y;const s=this.previousDrag;t=s?s.center.x-t:-t,i=s?i-s.center.y:i,r.viewpoint=At(this.viewpoint,r.viewpoint,[t||0,i||0]),this.previousDrag=e}end(r,e){this.addToEstimator(e);const t=r.navigation.momentumEnabled;this.momentum=t?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(r),this.previousDrag=null,this.navigation.end()}addToEstimator(r){const e=r.center.x,t=r.center.y,i=rr(-e,t),s=jt(-e,t,0);this.momentumEstimator.add(i,s,.001*r.timestamp)}onAnimationUpdate(r){this.navigation.animationManager.animateContinous(r.viewpoint,(e,t)=>{this.momentumFinished=!this.momentum||this.momentum.isFinished(this.animationTime);const i=.001*t;if(!this.momentumFinished){const s=this.momentum.valueDelta(this.animationTime,i);rs(this.tmpMomentum,this.momentum.direction,s),At(e,e,this.tmpMomentum),r.constraints.constrainByGeometry(e)}this.animationTime+=i})}stopMomentumNavigation(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}};C([z()],Ge.prototype,"momentumFinished",void 0),C([z()],Ge.prototype,"viewpoint",void 0),C([z()],Ge.prototype,"navigation",void 0),Ge=C([He("esri.views.2d.navigation.actions.Pan")],Ge);const zo=Ge;class Bs{constructor(e=2.5,t=.01,i=.95,s=12){this.minimumInitialVelocity=e,this.stopVelocity=t,this.friction=i,this.maxVelocity=s,this.enabled=!0,this.value=new Re(.8),this.time=new Re(.3)}add(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=le(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}createMomentum(e,t,i){return new ri(e,t,i)}}class ko extends Bs{constructor(e=3,t=.01,i=.95,s=12){super(e,t,i,s)}add(e,t){if(this.value.hasLastValue){const i=this.value.lastValue;let s=e-i;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;e=i+s}super.add(e,t)}}class Go extends ri{constructor(e,t,i){super(e,t,i)}value(e){const t=super.value(e);return Math.exp(t)}valueDelta(e,t){const i=super.value(e),s=super.value(e+t)-i;return Math.exp(s)}}class Vo extends Bs{constructor(e=2.5,t=.01,i=.95,s=12){super(e,t,i,s)}add(e,t){super.add(Math.log(e),t)}createMomentum(e,t,i){return new Go(e,t,i)}}let Ve=class extends Xe{constructor(r){super(r),this._animationTime=0,this._momentumFinished=!1,this._rotationMomentumEstimator=new ko(.6,.15,.95),this._rotationDirection=1,this._zoomDirection=1,this._zoomMomentumEstimator=new Vo,this._zoomOnly=null,this.zoomMomentum=null,this.rotateMomentum=null,this.viewpoint=new Ct({targetGeometry:new Pt,scale:0,rotation:0}),this.own(ns(()=>this._momentumFinished,()=>this.navigation.stop()))}begin(r,e){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=e.angle,this._previousRadius=this._startRadius=e.radius,this._previousCenter=e.center,this._updateTimestamp=null,r.constraints.rotationEnabled&&this.addToRotateEstimator(0,e.timestamp),this.addToZoomEstimator(e,1)}update(r,e){this._updateTimestamp===null&&(this._updateTimestamp=e.timestamp);const t=e.angle,i=e.radius,s=e.center,n=Math.abs(180*(t-this._startAngle)/Math.PI),a=Math.abs(i-this._startRadius),o=this._startRadius/i;if(this._previousRadius){const l=i/this._previousRadius;let h=180*(t-this._previousAngle)/Math.PI;this._rotationDirection=h>=0?1:-1,this._zoomDirection=l>=1?1:-1,r.constraints.rotationEnabled?(this._zoomOnly===null&&e.timestamp-this._updateTimestamp>200&&(this._zoomOnly=a-n>0),this._zoomOnly===null||this._zoomOnly?h=0:this.addToRotateEstimator(t-this._startAngle,e.timestamp)):h=0,this.addToZoomEstimator(e,o),this.navigation.setViewpoint([s.x,s.y],1/l,h,[this._previousCenter.x-s.x,s.y-this._previousCenter.y])}this._previousAngle=t,this._previousRadius=i,this._previousCenter=s}end(r){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(r),this.navigation.end()}addToRotateEstimator(r,e){this._rotationMomentumEstimator.add(r,.001*e)}addToZoomEstimator(r,e){this._zoomMomentumEstimator.add(e,.001*r.timestamp)}canZoomIn(r){const e=r.scale,t=r.constraints.effectiveMaxScale;return t===0||e>t}canZoomOut(r){const e=r.scale,t=r.constraints.effectiveMinScale;return t===0||e<t}onAnimationUpdate(r){this.navigation.animationManager.animateContinous(r.viewpoint,(e,t)=>{const i=!this.canZoomIn(r)&&this._zoomDirection>1||!this.canZoomOut(r)&&this._zoomDirection<1,s=!this.rotateMomentum||this.rotateMomentum.isFinished(this._animationTime),n=i||!this.zoomMomentum||this.zoomMomentum.isFinished(this._animationTime),a=.001*t;if(this._momentumFinished=s&&n,!this._momentumFinished){const o=this.rotateMomentum?Math.abs(this.rotateMomentum.valueDelta(this._animationTime,a))*this._rotationDirection*180/Math.PI:0;let l=this.zoomMomentum?Math.abs(this.zoomMomentum.valueDelta(this._animationTime,a)):1;const h=ut(),c=ut();if(this._previousCenter){ht(h,this._previousCenter.x,this._previousCenter.y),nr(c,r.size,r.padding),ar(h,h,c);const{constraints:u,scale:_}=r,f=_*l;l<1&&!u.canZoomInTo(f)?(l=_/u.effectiveMaxScale,this.zoomMomentum=null,this.rotateMomentum=null):l>1&&!u.canZoomOutTo(f)&&(l=_/u.effectiveMinScale,this.zoomMomentum=null,this.rotateMomentum=null),or(e,r.viewpoint,l,o,h,r.size),r.constraints.constrainByGeometry(e)}}this._animationTime+=a})}stopMomentumNavigation(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}};C([z()],Ve.prototype,"_momentumFinished",void 0),C([z()],Ve.prototype,"viewpoint",void 0),C([z()],Ve.prototype,"navigation",void 0),Ve=C([He("esri.views.2d.navigation.actions.Pinch")],Ve);const Wo=Ve,Xt=ut(),es=ut();let it=class extends Xe{constructor(r){super(r),this._previousCenter=ut(),this.viewpoint=new Ct({targetGeometry:new Pt,scale:0,rotation:0})}begin(r,e){this.navigation.begin(),ht(this._previousCenter,e.center.x,e.center.y)}update(r,e){const{state:{size:t,padding:i}}=r;ht(Xt,e.center.x,e.center.y),lr(es,t,i),r.viewpoint=Yt(this.viewpoint,r.state.paddedViewState.viewpoint,hr(es,this._previousCenter,Xt)),ur(this._previousCenter,Xt)}end(){this.navigation.end()}};C([z()],it.prototype,"viewpoint",void 0),C([z()],it.prototype,"navigation",void 0),it=C([He("esri.views.2d.actions.Rotate")],it);const Xo=it,Tt=10,ts=1,Ht=new Ct({targetGeometry:new Pt}),qt=[0,0],is=250;let ge=class extends Xe{constructor(r){super(r),this._endTimer=null,this.animationManager=null}initialize(){this.pan=new zo({navigation:this}),this.rotate=new Xo({navigation:this}),this.pinch=new Wo({navigation:this}),this.zoomBox=new No({view:this.view,navigation:this})}destroy(){this.pan.destroy(),this.rotate.destroy(),this.pinch.destroy(),this.zoomBox.destroy(),this.pan=this.rotate=this.pinch=this.zoomBox=this.animationManager=null}begin(){this._set("interacting",!0)}end(){this._lastEventTimestamp=performance.now(),this._startTimer(is)}async zoom(r,e=this._getDefaultAnchor()){if(this.stop(),this.begin(),this.view.constraints.snapToZoom&&this.view.constraints.effectiveLODs)return r<1?this.zoomIn(e):this.zoomOut(e);this.setViewpoint(e,r,0,[0,0])}async zoomIn(r){const e=this.view,t=e.constraints.snapToNextScale(e.scale);return this._zoomToScale(t,r)}async zoomOut(r){const e=this.view,t=e.constraints.snapToPreviousScale(e.scale);return this._zoomToScale(t,r)}setViewpoint(r,e,t,i){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,r,e,t,i),this.end()}setViewpointImmediate(r,e=0,t=[0,0],i=this._getDefaultAnchor()){this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,i,r,e,t)}continousRotateClockwise(){const r=this.get("view.viewpoint");this.animationManager.animateContinous(r,e=>{Yt(e,e,-ts)})}continousRotateCounterclockwise(){const r=this.get("view.viewpoint");this.animationManager.animateContinous(r,e=>{Yt(e,e,ts)})}resetRotation(){this.view.rotation=0}continousPanLeft(){this._continuousPan([-Tt,0])}continousPanRight(){this._continuousPan([Tt,0])}continousPanUp(){this._continuousPan([0,Tt])}continousPanDown(){this._continuousPan([0,-Tt])}stop(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),this._endTimer!==null&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}_continuousPan(r){const e=this.view.viewpoint;this.animationManager.animateContinous(e,t=>{At(t,t,r),this.view.constraints.constrainByGeometry(t)})}_startTimer(r){return this._endTimer!==null||(this._endTimer=setTimeout(()=>{this._endTimer=null;const e=performance.now()-this._lastEventTimestamp;e<is?this._endTimer=this._startTimer(e):this._set("interacting",!1)},r)),this._endTimer}_getDefaultAnchor(){const{size:r,padding:{left:e,right:t,top:i,bottom:s}}=this.view;return qt[0]=.5*(r[0]-t+e),qt[1]=.5*(r[1]-s+i),qt}async _zoomToScale(r,e=this._getDefaultAnchor()){const{view:t}=this,{constraints:i,scale:s,viewpoint:n,size:a,padding:o}=t,l=i.canZoomInTo(r),h=i.canZoomOutTo(r);if(!(r<s&&!l||r>s&&!h))return ci(Ht,n,r/s,0,e,a,o),i.constrainByGeometry(Ht),t.goTo(Ht,{animate:!0})}_scaleRotateTranslateViewpoint(r,e,t,i,s){const{view:n}=this,{size:a,padding:o,constraints:l,scale:h,viewpoint:c}=n,u=h*t,_=l.canZoomInTo(u),f=l.canZoomOutTo(u);return(t<1&&!_||t>1&&!f)&&(t=1),At(c,c,s),ci(r,c,t,i,e,a,o),l.constrainByGeometry(r)}};C([z()],ge.prototype,"animationManager",void 0),C([z({type:Boolean,readOnly:!0})],ge.prototype,"interacting",void 0),C([z()],ge.prototype,"pan",void 0),C([z()],ge.prototype,"pinch",void 0),C([z()],ge.prototype,"rotate",void 0),C([z()],ge.prototype,"view",void 0),C([z()],ge.prototype,"zoomBox",void 0),ge=C([He("esri.views.2d.navigation.MapViewNavigation")],ge);const Gl=ge,As={shaders:{vertexShader:ne("magnifier/magnifier.vert"),fragmentShader:ne("magnifier/magnifier.frag")},attributes:new Map([["a_pos",0]])};function Ho(r){return ct(r,As)}async function qo(r){const e=Ri(()=>import("./mask-svg.d736db49.js"),[]),t=Ri(()=>import("./overlay-svg.ddc1dd43.js"),[]),i=Fi((await e).default,{signal:r}),s=Fi((await t).default,{signal:r}),n={mask:await i,overlay:await s};return Qt(r),n}class Vl extends Er{constructor(){super(),this._handles=new cr,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}get background(){return this._background}set background(e){this._background=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([Rt(()=>e.version,()=>{this.visible=e.visible&&D(e.position)&&e.size>0,this.requestRender()},ss),Rt(()=>[e.maskUrl,e.overlayUrl],()=>this._reloadResources()),Rt(()=>e.size,()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{dvs:Jt()}}doRender(e){const t=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==se.MAP||!this._canRender())return;this._updateResources(e);const i=this._magnifier;if(P(i.position))return;const s=e.pixelRatio,n=i.size*s,a=1/i.factor,o=Math.ceil(a*n);this._readbackTexture.resize(o,o);const{size:l}=e.state,h=s*l[0],c=s*l[1],u=.5*o,_=.5*o,f=le(s*i.position.x,u,h-u-1),m=le(c-s*i.position.y,_,c-_-1);t.setBlendingEnabled(!0);const d=f-u,g=m-_,x=this._readbackTexture;t.bindTexture(x,0),t.gl.copyTexImage2D(x.descriptor.target,0,x.descriptor.pixelFormat,d,g,o,o,0);const p=this.background?.color,E=p?[p.a*p.r/255,p.a*p.g/255,p.a*p.b/255,p.a]:[1,1,1,1],b=(f+i.offset.x*s)/h*2-1,y=(m-i.offset.y*s)/c*2-1,v=n/h*2,R=n/c*2,T=this._program;t.bindVAO(this._vertexArrayObject),t.bindTexture(this._overlayTexture,6),t.bindTexture(this._maskTexture,7),t.useProgram(T),T.setUniform4fv("u_background",E),T.setUniform1i("u_readbackTexture",0),T.setUniform1i("u_overlayTexture",6),T.setUniform1i("u_maskTexture",7),T.setUniform4f("u_drawPos",b,y,v,R),T.setUniform1i("u_maskEnabled",i.maskEnabled?1:0),T.setUniform1i("u_overlayEnabled",i.overlayEnabled?1:0),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawArrays(re.TRIANGLE_STRIP,0,4),t.bindVAO()}_canRender(){return this.mask&&this.overlay&&this._magnifier!=null}_reloadResources(){this._resourcesTask&&this._resourcesTask.abort();const e=D(this._magnifier)?this._magnifier.maskUrl:null,t=D(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=dr(async i=>{const s=P(e)||P(t)?qo(i):null,n=D(e)?lt(e,{responseType:"image",signal:i}).then(h=>h.data):s.then(h=>h.mask),a=D(t)?lt(t,{responseType:"image",signal:i}).then(h=>h.data):s.then(h=>h.overlay),[o,l]=await Promise.all([n,a]);this.mask=o,this.overlay=l,this._disposeRenderResources(),this.requestRender()})}_disposeRenderResources(){this._readbackTexture=ie(this._readbackTexture),this._overlayTexture=ie(this._overlayTexture),this._maskTexture=ie(this._maskTexture),this._vertexArrayObject=ie(this._vertexArrayObject),this._program=ie(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const t=e.context;this._resourcePixelRatio=e.pixelRatio;const i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=Ho(t);const s=new Uint16Array([0,1,0,0,1,1,1,0]),n=As.attributes;this._vertexArrayObject=new Le(t,n,os,{geometry:$e.createVertex(t,ze.STATIC_DRAW,s)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new K(t,{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.NEAREST,flipped:!0,preMultiplyAlpha:!_r(this.overlay.src)||!e.context.driverTest.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new K(t,{target:I.TEXTURE_2D,pixelFormat:F.ALPHA,internalFormat:F.ALPHA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.NEAREST,flipped:!0},this.mask);const a=1/this._magnifier.factor;this._readbackTexture=new K(t,{target:I.TEXTURE_2D,pixelFormat:F.RGBA,internalFormat:F.RGBA,dataType:M.UNSIGNED_BYTE,wrapMode:U.CLAMP_TO_EDGE,samplingMode:S.LINEAR,flipped:!1,width:Math.ceil(a*i),height:Math.ceil(a*i)})}}export{jl as GraphicContainer,Hl as GraphicsView2D,kl as LabelManager,Vl as MagnifierView2D,Gl as MapViewNavigation,zl as Stage};
