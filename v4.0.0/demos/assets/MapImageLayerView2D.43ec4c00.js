import{e as S,H as k,fJ as B,fK as Z,fL as F,d0 as H,K as a,N as n,fM as z,a2 as K,M as G,k as W,a0 as Y,O,an as J,fN as X,h as q,dC as ee,cY as te,fO as re,u as ie,L as se,fP as ae,fQ as oe,U as ne,eZ as pe,fR as le,s as _,i as ue,R as me,fS as ye,E as he,f2 as de,a6 as ce,fn as fe,b2 as ge,ak as V}from"./main.efb50b2c.js";import{t as we}from"./BitmapContainer.e35b4cc9.js";import{f as ve,u as xe}from"./LayerView.098e8f00.js";import{a as be}from"./BaseGraphicContainer.ab876b54.js";import{n as $e}from"./HighlightGraphicContainer.5ec0b7f2.js";import{S as Ie}from"./ExportStrategy.315d2a85.js";import{s as M,a as Pe}from"./drapedUtils.dfd7dc97.js";import{d as Se,s as Ee}from"./popupUtils.bce68919.js";import{i as Ne}from"./RefreshableLayerView.cc3cb63d.js";import"./preload-helper.387dac8f.js";import"./WGLContainer.83fa1e96.js";import"./enums.de935fa5.js";import"./utils.9619dae6.js";import"./Utils.f67560a4.js";import"./enums.6e42a319.js";import"./Texture.627d6838.js";import"./VertexElementDescriptor.d386088d.js";import"./MaterialKey.c216087c.js";import"./VertexArrayObject.e5cd7959.js";import"./ProgramTemplate.1056febf.js";import"./StyleDefinition.627ffe6c.js";import"./config.40d47db8.js";import"./GeometryUtils.8166011b.js";import"./earcut.d30cbec0.js";import"./CIMSymbolHelper.6248d0ad.js";import"./BidiEngine.ec67919b.js";import"./GeometryUtils.814cb798.js";import"./normalizeUtilsSync.38eabbc7.js";import"./projectionSupport.a2ec70ff.js";import"./json.d1a0fa35.js";import"./FeatureContainer.423509ab.js";import"./TileContainer.bca8274f.js";import"./visualVariablesUtils.42df48c6.js";import"./visualVariablesUtils.087ada97.js";import"./Matcher.41df3644.js";import"./tileUtils.0431f5e8.js";import"./TileClipper.68567d53.js";import"./Geometry.b68345ae.js";import"./ExpandedCIM.7b8d9605.js";import"./quantizationUtils.d09757e3.js";import"./devEnvironmentUtils.8c6e6b72.js";import"./schemaUtils.692e0e19.js";import"./createSymbolSchema.47a02593.js";import"./MD5.97b39efc.js";import"./util.5d5e59e8.js";import"./ComputedAttributeStorage.a7ff046c.js";import"./centroid.79915d1f.js";import"./vec3f32.8d37ecf5.js";import"./Bitmap.3de272b0.js";const A=t=>t.spatialReference.wkid||JSON.stringify(t.spatialReference);function Oe(t,e){const{dpi:i,gdbVersion:r,geometry:s,geometryPrecision:p,height:f,layerOption:m,mapExtent:o,maxAllowableOffset:h,returnFieldName:y,returnGeometry:d,returnUnformattedValues:c,returnZ:I,spatialReference:l,timeExtent:v,tolerance:w,width:g}=t.toJSON(),{dynamicLayers:b,layerDefs:N,layerIds:R}=je(t),U=e&&S(e.geometry)?e.geometry:null,x={geometryPrecision:p,maxAllowableOffset:h,returnFieldName:y,returnGeometry:d,returnUnformattedValues:c,returnZ:I,tolerance:w},P=U&&U.toJSON()||s;if(x.imageDisplay=`${g},${f},${i}`,r&&(x.gdbVersion=r),P&&(delete P.spatialReference,x.geometry=JSON.stringify(P),x.geometryType=k(P)),l?x.sr=l.wkid||JSON.stringify(l):P&&P.spatialReference?x.sr=A(P):o&&o.spatialReference&&(x.sr=A(o)),x.time=v?[v.start,v.end].join(","):null,o){const{xmin:L,ymin:Q,xmax:T,ymax:D}=o;x.mapExtent=`${L},${Q},${T},${D}`}return N&&(x.layerDefs=N),b&&!N&&(x.dynamicLayers=b),x.layers=m==="popup"?"visible":m,R&&!b&&(x.layers+=`:${R.join(",")}`),x}function je(t){const{mapExtent:e,floors:i,width:r,sublayers:s,layerIds:p,layerOption:f,gdbVersion:m}=t,o=s?.find(l=>l.layer!=null)?.layer?.serviceSublayers,h=f==="popup",y={},d=B({extent:e,width:r,spatialReference:e?.spatialReference}),c=[],I=l=>{const v=d===0,w=l.minScale===0||d<=l.minScale,g=l.maxScale===0||d>=l.maxScale;if(l.visible&&(v||w&&g))if(l.sublayers)l.sublayers.forEach(I);else{if(p?.includes(l.id)===!1||h&&(!l.popupTemplate||!l.popupEnabled))return;c.unshift(l)}};if(s?.forEach(I),s&&!c.length)y.layerIds=[];else{const l=Z(c,o,m),v=c.map(w=>{const g=F(i,w);return w.toExportImageJSON(g)});if(l)y.dynamicLayers=JSON.stringify(v);else{if(s){let g=c.map(({id:b})=>b);p&&(g=g.filter(b=>p.includes(b))),y.layerIds=g}else p?.length&&(y.layerIds=p);const w=Fe(i,c);if(S(w)&&w.length){const g={};for(const b of w)b.definitionExpression&&(g[b.id]=b.definitionExpression);Object.keys(g).length&&(y.layerDefs=JSON.stringify(g))}}}return y}function Fe(t,e){const i=!!t?.length,r=e.filter(s=>s.definitionExpression!=null||i&&s.floorInfo!=null);return r.length?r.map(s=>{const p=F(t,s),f=H(p,s.definitionExpression);return{id:s.id,definitionExpression:f}}):null}var j;let u=j=class extends J{constructor(t){super(t),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(t){return X(j,t)}};a([n({type:Number,json:{write:!0}})],u.prototype,"dpi",void 0),a([n()],u.prototype,"floors",void 0),a([n({type:String,json:{write:!0}})],u.prototype,"gdbVersion",void 0),a([n({types:z,json:{read:K,write:!0}})],u.prototype,"geometry",void 0),a([n({type:Number,json:{write:!0}})],u.prototype,"geometryPrecision",void 0),a([n({type:Number,json:{write:!0}})],u.prototype,"height",void 0),a([n({type:[Number],json:{write:!0}})],u.prototype,"layerIds",void 0),a([n({type:["top","visible","all","popup"],json:{write:!0}})],u.prototype,"layerOption",void 0),a([n({type:G,json:{write:!0}})],u.prototype,"mapExtent",void 0),a([n({type:Number,json:{write:!0}})],u.prototype,"maxAllowableOffset",void 0),a([n({type:Boolean,json:{write:!0}})],u.prototype,"returnFieldName",void 0),a([n({type:Boolean,json:{write:!0}})],u.prototype,"returnGeometry",void 0),a([n({type:Boolean,json:{write:!0}})],u.prototype,"returnM",void 0),a([n({type:Boolean,json:{write:!0}})],u.prototype,"returnUnformattedValues",void 0),a([n({type:Boolean,json:{write:!0}})],u.prototype,"returnZ",void 0),a([n({type:W,json:{write:!0}})],u.prototype,"spatialReference",void 0),a([n()],u.prototype,"sublayers",void 0),a([n({type:Y,json:{write:!0}})],u.prototype,"timeExtent",void 0),a([n({type:Number,json:{write:!0}})],u.prototype,"tolerance",void 0),a([n({type:Number,json:{write:!0}})],u.prototype,"width",void 0),u=j=a([O("esri.rest.support.IdentifyParameters")],u);const C=u;let $=class extends J{constructor(t){super(t),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(t,e){return q.fromJSON({attributes:{...e.attributes},geometry:{...e.geometry}})}writeFeature(t,e){if(!t)return;const{attributes:i,geometry:r}=t;i&&(e.attributes={...i}),S(r)&&(e.geometry=r.toJSON(),e.geometryType=re.toJSON(r.type))}};a([n({type:String,json:{write:!0}})],$.prototype,"displayFieldName",void 0),a([n({type:q})],$.prototype,"feature",void 0),a([ee("feature",["attributes","geometry"])],$.prototype,"readFeature",null),a([te("feature")],$.prototype,"writeFeature",null),a([n({type:Number,json:{write:!0}})],$.prototype,"layerId",void 0),a([n({type:String,json:{write:!0}})],$.prototype,"layerName",void 0),$=a([O("esri.rest.support.IdentifyResult")],$);const Re=$;async function Ue(t,e,i){const r=(e=Ve(e)).geometry?[e.geometry]:[],s=ie(t);return s.path+="/identify",se(r).then(p=>{const f=Oe(e,{geometry:p&&p[0]}),m=ae({...s.query,f:"json",...f}),o=oe(m,i);return ne(s.path,o).then(_e).then(h=>Me(h,e.sublayers))})}function _e(t){const e=t.data;e.results=e.results||[];const i={results:[]};return i.results=e.results.map(r=>Re.fromJSON(r)),i}function Ve(t){return t=C.from(t)}function Me(t,e){if(!e?.length)return t;const i=new Map;function r(s){i.set(s.id,s),s.sublayers&&s.sublayers.forEach(r)}e.forEach(r);for(const s of t.results)s.feature.sourceLayer=i.get(s.layerId);return t}const Ae=t=>{let e=class extends t{initialize(){this.exportImageParameters=new le({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){return this.exportImageParameters?.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(i,r){const{layer:s}=this;if(!i)throw new _("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:s});const p=this.layer.capabilities?.operations?.supportsQuery??!0;if(!((this.layer.capabilities?.operations?.supportsIdentify??!0)&&this.layer.version>=10.5)&&!p)throw new _("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:s});return p?this._fetchPopupFeaturesUsingQueries(i,r):this._fetchPopupFeaturesUsingIdentify(i,r)}canResume(){return!!super.canResume()&&!this.timeExtent?.isEmpty}async _fetchPopupFeaturesUsingIdentify(i,r){const s=await this._createIdentifyParameters(i,r);if(ue(s))return[];const{results:p}=await Ue(this.layer.parsedUrl,s);return p.map(f=>f.feature)}async _createIdentifyParameters(i,r){const{floors:s,spatialReference:p,scale:f}=this.view,m=S(r)?r.event:null,o=await this._collectPopupProviders(this.layer.sublayers,f,r);if(!o.length)return null;await Promise.all(o.map(({sublayer:v})=>v.load().catch(()=>{})));const h=Math.min(me("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((v,w)=>w.renderer?M({renderer:w.renderer,event:m}):v,2)),y=this.createFetchPopupFeaturesQueryGeometry(i,h),d=ye(f,p),c=Math.round(y.width/d),I=new G({xmin:y.center.x-d*c,ymin:y.center.y-d*c,xmax:y.center.x+d*c,ymax:y.center.y+d*c,spatialReference:y.spatialReference}),l=this.layer.capabilities?.operations?.supportsQuery===!1||await new Promise(v=>{let w=!1;Promise.all(o.map(async({popupTemplate:g})=>{if(g){const b=await this._loadArcadeModules(g);if(w)return;b?.arcadeUtils.hasGeometryOperations(g)&&(w=!0,v(!0))}})).finally(()=>v(!1))});return new C({floors:s,gdbVersion:this.layer.gdbVersion,geometry:i,height:c,layerOption:"popup",mapExtent:I,maxAllowableOffset:l?0:d,returnGeometry:!0,spatialReference:p,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:h,width:c})}async _fetchPopupFeaturesUsingQueries(i,r){const s=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,r),p=S(r)?r.event:null,f=s.map(async({sublayer:m,popupTemplate:o})=>{await m.load().catch(()=>{});const h=m.createQuery(),y=M({renderer:m.renderer,event:p}),d=this.createFetchPopupFeaturesQueryGeometry(i,y);if(h.geometry=d,h.outFields=await Se(m,o),"floors"in this.view){const I=this.view?.floors?.clone(),l=F(I,m);S(l)&&(h.where=h.where?`(${h.where}) AND (${l})`:l)}const c=await this._loadArcadeModules(o);return c&&c.arcadeUtils.hasGeometryOperations(o)||(h.maxAllowableOffset=d.width/y),(await m.queryFeatures(h)).features});return(await he(f)).reduce((m,o)=>o.value?[...m,...o.value]:m,[]).filter(m=>m!=null)}async _collectPopupProviders(i,r,s){const p=[],f=async o=>{const h=o.minScale===0||r<=o.minScale,y=o.maxScale===0||r>=o.maxScale;if(o.visible&&h&&y){if(o.sublayers)o.sublayers.forEach(f);else if(o.popupEnabled){const d=Ee(o,{...s,defaultPopupTemplateEnabled:!1});S(d)&&p.unshift({sublayer:o,popupTemplate:d})}}},m=i.toArray().reverse().map(f);return await Promise.all(m),p}_loadArcadeModules(i){if(i.expressionInfos?.length||Array.isArray(i.content)&&i.content.some(r=>r.type==="expression"))return de()}};return a([n()],e.prototype,"exportImageParameters",void 0),a([n({readOnly:!0})],e.prototype,"exportImageVersion",null),a([n()],e.prototype,"layer",void 0),a([n()],e.prototype,"suspended",void 0),a([n(pe)],e.prototype,"timeExtent",void 0),e=a([O("esri.views.layers.MapImageLayerView")],e),e},Ge=ce.getLogger("esri.views.2d.layers.MapImageLayerView2D");let E=class extends Ae(Ne(ve(xe))){constructor(){super(...arguments),this._highlightGraphics=new fe}update(t){this.strategy.update(t).catch(e=>{ge(e)||Ge.error(e)})}attach(){const{imageMaxWidth:t,imageMaxHeight:e,version:i}=this.layer,r=i>=10.3,s=i>=10;this._bitmapContainer=new we,this.container.addChild(this._bitmapContainer);const p=new be({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new $e(this.view.featuresTilingScheme)});this.container.addChild(p.container),this.strategy=new Ie({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:t,imageMaxHeight:e,imageRotationSupported:r,imageNormalizationSupported:s,hidpi:!0}),this.handles.add(V(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(V(()=>this.view?.floors,()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(t,e){return this._highlightGraphics.add(t),{remove:()=>{this._highlightGraphics.remove(t)}}}supportsSpatialReference(t){return this.layer.serviceSupportsSpatialReference(t)}createFetchPopupFeaturesQueryGeometry(t,e){return Pe(t,e,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(t,e,i,r){return this.layer.fetchImage(t,e,i,{timeExtent:this.timeExtent,floors:this.view.floors,...r})}};a([n()],E.prototype,"strategy",void 0),a([n()],E.prototype,"updating",void 0),E=a([O("esri.views.2d.layers.MapImageLayerView2D")],E);const _t=E;export{_t as default};
