import{a6 as B,i as y,s as g,U as j,ja as U,d9 as V,k as T,jy as H,bj as X,e as k,q as Y,cQ as ee,dJ as G,hE as te,jz as ne}from"./main.efb50b2c.js";import{O as ie,T as ae,L as se}from"./geojson.82f10ea5.js";import{u as re}from"./clientSideDefaults.24a06bd0.js";const q=B.getLogger("esri.layers.graphics.sources.ogcfeature"),P="http://www.opengis.net/def/crs/",ge=`${P}OGC/1.3/CRS84`;async function ye(e,t,n={},i=5){const{links:r}=e,c=m(r,"items","application/geo+json")||m(r,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(y(c))throw new g("ogc-feature-layer:missing-items-page","Missing items url");const{data:d}=await j(c.href,{signal:n.signal,query:{limit:i,...n.customParameters,token:n.apiKey},headers:{accept:"application/geo+json"}});await ie(d);const o=ae(d,{geometryType:t.geometryType}),f=t.fields||o.fields||[],$=t.hasZ!=null?t.hasZ:o.hasZ,h=o.geometryType,p=t.objectIdField||o.objectIdFieldName||"OBJECTID";let s=t.timeInfo;const F=f.find(a=>a.name===p);if(F)F.type="esriFieldTypeOID",F.editable=!1,F.nullable=!1;else{if(!o.objectIdFieldType)throw new g("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");f.unshift({name:p,alias:p,type:"esriFieldTypeOID",editable:!1,nullable:!1})}if(p!==o.objectIdFieldName){const a=f.find(l=>l.name===o.objectIdFieldName);a&&(a.type="esriFieldTypeInteger")}f===o.fields&&o.unknownFields.length>0&&q.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:o.unknownFields}});for(const a of f){if(a.name==null&&(a.name=a.alias),a.alias==null&&(a.alias=a.name),a.type!=="esriFieldTypeOID"&&a.type!=="esriFieldTypeGlobalID"&&(a.editable=a.editable==null||!!a.editable,a.nullable=a.nullable==null||!!a.nullable),!a.name)throw new g("ogc-feature-layer:invalid-field-name","field name is missing",{field:a});if(!U.jsonValues.includes(a.type))throw new g("ogc-feature-layer:invalid-field-type",`invalid type for field "${a.name}"`,{field:a})}if(s){const a=new V(f);if(s.startTimeField){const l=a.get(s.startTimeField);l?(s.startTimeField=l.name,l.type="esriFieldTypeDate"):s.startTimeField=null}if(s.endTimeField){const l=a.get(s.endTimeField);l?(s.endTimeField=l.name,l.type="esriFieldTypeDate"):s.endTimeField=null}if(s.trackIdField){const l=a.get(s.trackIdField);l?s.trackIdField=l.name:(s.trackIdField=null,q.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:s}}))}s.startTimeField||s.endTimeField||(q.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:s}}),s=null)}return{drawingInfo:h?re(h):null,geometryType:h,fields:f,hasZ:!!$,objectIdField:p,timeInfo:s}}async function we(e,t={}){const{links:n}=e,i=m(n,"data","application/json")||m(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(y(i))throw new g("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:r,customParameters:c,signal:d}=t,{data:o}=await j(i.href,{signal:d,headers:{accept:"application/json"},query:{...c,token:r}});return o}async function be(e,t={}){const{links:n}=e,i=m(n,"conformance","application/json")||m(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(y(i))throw new g("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:r,customParameters:c,signal:d}=t,{data:o}=await j(i.href,{signal:d,headers:{accept:"application/json"},query:{...c,token:r}});return o}async function he(e,t={}){const{apiKey:n,customParameters:i,signal:r}=t,{data:c}=await j(e,{signal:r,headers:{accept:"application/json"},query:{...i,token:n}});return c}async function Fe(e,t={}){const n="application/vnd.oai.openapi+json;version=3.0",i=m(e.links,"service-desc",n);if(y(i))return q.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:r,customParameters:c,signal:d}=t,{data:o}=await j(i.href,{signal:d,headers:{accept:n},query:{...c,token:r}});return o}function Ie(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e)?.groups;if(!t)return null;const{authority:n,code:i}=t;switch(n.toLowerCase()){case"ogc":switch(i.toLowerCase()){case"crs27":return T.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return T.WGS84.wkid;default:return null}case"esri":case"epsg":{const r=Number.parseInt(i,10);return Number.isNaN(r)?null:r}default:return null}}async function je(e,t,n){const i=await oe(e,t,n);return H(i)}async function oe(e,t,n){const{capabilities:{query:{maxRecordCount:i}},collection:r,layerDefinition:c,queryParameters:{apiKey:d,customParameters:o},spatialReference:f,supportedCrs:$}=e,{links:h}=r,p=m(h,"items","application/geo+json")||m(h,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(y(p))throw new g("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:s,num:F,start:a,timeExtent:l,where:W}=t;if(t.objectIds)throw new g("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const Z=T.fromJSON(f),I=X(t.outSpatialReference,Z),x=I.isWGS84?null:R(I,$),K=ue(s,$),L=ce(l),J=de(W),A=F??(a!=null&&a!==void 0?10:i),{data:w}=await j(p.href,{...n,query:{...o,...K,crs:x,datetime:L,query:J,limit:A,startindex:a,token:d},headers:{accept:"application/geo+json"}});let S=!1;w.links&&(S=!!w.links.find(N=>N.rel==="next")),!S&&Number.isInteger(w.numberMatched)&&Number.isInteger(w.numberReturned)&&(S=w.numberReturned<w.numberMatched);const{fields:E,globalIdField:Q,hasM:_,hasZ:M,objectIdField:v}=c,O=c.geometryType,C=se(w,{geometryType:O,hasZ:M,objectIdField:v});if(!x&&I.isWebMercator){for(const b of C)if(k(b.geometry)){const N=Y(b.geometry,O,M,!1);N.spatialReference=T.WGS84,b.geometry=ee(G(N,I))}}for(const b of C)b.objectId=b.attributes[v];const z=x||!x&&I.isWebMercator?I.toJSON():te,u=new ne;return u.exceededTransferLimit=S,u.features=C,u.fields=E,u.geometryType=O,u.globalIdFieldName=Q,u.hasM=_,u.hasZ=M,u.objectIdFieldName=v,u.spatialReference=z,u}function le(e){return k(e)&&e.type==="extent"}function R(e,t){const{isWebMercator:n,wkid:i}=e;if(!i)return null;const r=n?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return r?`${P}${r}`:null}function D(e){if(y(e))return"";const{xmin:t,ymin:n,xmax:i,ymax:r}=e;return`${t},${n},${i},${r}`}function ce(e){if(y(e))return null;const{start:t,end:n}=e;return`${k(t)?t.toISOString():".."}/${k(n)?n.toISOString():".."}`}function de(e){return y(e)||!e||e==="1=1"?null:e}function ue(e,t){if(!le(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:D(e)};const i=R(n,t);return k(i)?{bbox:D(e),"bbox-crs":i}:n.isWebMercator?{bbox:D(G(e,T.WGS84))}:null}function m(e,t,n){return e.find(i=>i.rel===t&&i.type===n)||e.find(i=>i.rel===t&&!i.type)}export{ge as F,ye as I,Ie as N,he as S,we as T,P as j,be as k,je as q,oe as v,Fe as x};
