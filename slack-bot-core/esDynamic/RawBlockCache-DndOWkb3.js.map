{"version":3,"file":"RawBlockCache-DndOWkb3.js","sources":["../../node_modules/@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js","../../node_modules/@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.29/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval((()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()}),this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.29/esri/copyright.txt for details.\n*/\nimport\"../../../geometry.js\";import e from\"./EphemeralBlockCache.js\";import{projectExtent as t,projectResolution as n,snapPyramid as o}from\"../rasterFunctions/rasterProjectionHelper.js\";import l from\"../../../geometry/Point.js\";const r=new Map,c=new e;function i(e,t){return null==t?e:`${e}?sliceId=${t}`}function u(e,t){const n={extent:null,rasterInfo:t,cache:new Map},o=r.get(e);return o?(o.push(n),o.length-1):(r.set(e,[n]),0)}function a(e,t){const n=r.get(e);n&&(n[t]=null,n.some((e=>null!=e))||r.delete(e))}function f(e){r.delete(e)}function s(e,t,n){const o=r.get(e);if(!o)return null==t?c.decreaseRefCount(e,n):0;if(null==t||null==o[t])return c.decreaseRefCount(e,n);const l=o[t]?.cache,i=l?.get(n);if(l&&i){if(i.refCount--,0===i.refCount){l.delete(n);for(let e=0;e<o.length;e++)o[e]?.cache.delete(n);i.controller&&i.controller.abort()}return i.refCount}return 0}function m(e,t,n){const o=r.get(e);if(!o)return null==t?c.getBlock(e,n):null;if(null==t||null==o[t]){for(let e=0;e<o.length;e++){const t=o[e]?.cache.get(n);if(t)return t.refCount++,t.block}return c.getBlock(e,n)}const l=o[t]?.cache.get(n);if(l)return l.refCount++,l.block;for(let r=0;r<o.length;r++){if(r===t||!o[r])continue;const e=o[r]?.cache,l=e?.get(n);if(e&&l)return l.refCount++,e.set(n,l),l.block}return null}function x(e,t,n,o,l=null){const i=r.get(e);if(!i)return void(null==t&&c.putBlock(e,n,o,l));if(null==t||null==i[t])return void c.putBlock(e,n,o,l);const u={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:l};o.then((()=>u.isResolved=!0)).catch((()=>u.isRejected=!0)),i[t]?.cache.set(n,u)}function h(e,t,n){const o=r.get(e);o?null!=t&&null!=o[t]?o[t]?.cache.delete(n):c.deleteBlock(e,n):null==t&&c.deleteBlock(e,n)}function d(e,t){const n=r.get(e);return n?n[t]??null:null}function g(e,r,c,i,u,a,f=null){const s=d(e,r);if(!s)return;const m=s.extent,{cache:x,rasterInfo:h}=s;if(m&&m.xmin===c.xmin&&m.xmax===c.xmax&&m.ymin===c.ymin&&m.ymax===c.ymax)return;i=i??0;const g=c.clone().normalize(),{spatialReference:y,transform:p}=h,k=new Set;for(let d=0;d<g.length;d++){const e=g[d];if(e.xmax-e.xmin<=i||e.ymax-e.ymin<=i)continue;let r=t(e,y,f);null!=p&&(r=p.inverseTransform(r));const c=new l({x:i,y:i,spatialReference:e.spatialReference});if(null==u&&!(u=n(c,y,e,f)))return;const{pyramidLevel:s,pyramidResolution:m,excessiveReading:x}=o(u,h,a||\"closest\");if(x)return;const{storageInfo:M}=h,{origin:R}=M,C={x:Math.max(0,Math.floor((r.xmin-R.x)/m.x)),y:Math.max(0,Math.floor((R.y-r.ymax)/m.y))},B=Math.ceil((r.xmax-r.xmin)/m.x-.1),j=Math.ceil((r.ymax-r.ymin)/m.y-.1),v=s>0?M.pyramidBlockWidth:M.blockWidth,b=s>0?M.pyramidBlockHeight:M.blockHeight,w=1,$=Math.max(0,Math.floor(C.x/v)-w),I=Math.max(0,Math.floor(C.y/b)-w),H=Math.floor((C.x+B-1)/v)+w,E=Math.floor((C.y+j-1)/b)+w;for(let t=I;t<=E;t++)for(let e=$;e<=H;e++)k.add(`${s}/${t}/${e}`)}x.forEach(((e,t)=>{if(!k.has(t)){const e=x.get(t);(null==e||e.isResolved||e.isRejected)&&x.delete(t)}})),s.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}export{s as decreaseRefCount,h as deleteBlock,f as deleteRaster,m as getBlock,i as getRasterId,x as putBlock,u as register,a as unregister,g as update};\n"],"names":["t","s","r","i","c","e","u","n","o","a","m","l","x","h","d","g","f","y","p","k","M","R","C","B","j","v","b","w","$","I","H"],"mappings":"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","x_google_ignoreList":[0,1]}