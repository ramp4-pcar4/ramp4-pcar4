<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <link rel="icon" href="<%= BASE_URL %>favicon.ico" />
        <title>ramp-core</title>

        <!-- Vue is loaded in dev builds as well because of an issue with Cypress and external fixtures -->
        <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

        <!-- these two fixtures will load before either RAMP is loaded -->
        <script src="../sample-fixtures/mouruge-fixture.js"></script>
        <script src="../sample-fixtures/diligord-fixture.js"></script>

        <!-- RAMP will be injected here -->
    </head>
    <body>
        <!-- this fixture will load after RAMP (and Vue) are loaded (since Vue is bundled with RAMP in `dev`); `iklob` requires Vue to be exposed on the global scope -->
        <script src="../sample-fixtures/iklob-fixture.js"></script>

        <style>
            #instance-language {
                margin-left: 20px;
            }
        </style>

        <noscript>
            <strong>We're sorry but ramp-core doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
        </noscript>
        <button onclick="switchLang()">Switch language</button><span id="instance-language"></span>

        <div id="app"></div>

        <span id="ramp-version"></span>
        <!-- built files will be auto injected -->

        <script>
            window.rInstance = null;
            function initRAMP() {
                document.getElementById('ramp-version').innerText =
                    'v.' +
                    RAMP.version.major +
                    '.' +
                    RAMP.version.minor +
                    '.' +
                    RAMP.version.patch +
                    ' [#' +
                    RAMP.version.hash.slice(0, 6) +
                    ']  -  built on ' +
                    new Date(RAMP.version.timestamp).toLocaleDateString();

                rInstance = new RAMP.Instance(document.getElementById('app'), {
                    map: {
                        extent: {
                            xmax: -5007771.626060756,
                            xmin: -16632697.354854,
                            ymax: 10015875.184845109,
                            ymin: 5022907.964742964,
                            spatialReference: {
                                wkid: 102100,
                                latestWkid: 3857
                            }
                        },
                        lods: RAMP.geoapi.maps.defaultLODs(RAMP.geoapi.maps.defaultTileSchemas()[1]), // idx 1 = mercator
                        basemaps: [
                            {
                                id: 'esriImagery',
                                tileSchemaId: 'DEFAULT_ESRI_World_AuxMerc_3857',
                                layers: [
                                    {
                                        layerType: 'esriTile',
                                        url: 'http://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer'
                                    }
                                ]
                            }
                        ],
                        initialBasemapId: 'esriImagery'
                    },
                    layers: [
                        {
                            id: 'WaterQuantity',
                            layerType: 'esriMapImage',
                            url: 'http://maps-cartes.ec.gc.ca/arcgis/rest/services/CESI/MapServer',
                            layerEntries: [
                                {
                                    index: 1,
                                    state: {
                                        opacity: 1,
                                        visibility: true
                                    }
                                }
                            ],
                            state: {
                                opacity: 1,
                                visibility: true
                            },
                            customRenderer: {} // just to chill things out. real ramp will have all properties defaulted and filled in
                        },
                        {
                            id: 'CleanAir',
                            layerType: 'esriFeature',
                            url: 'http://maps-cartes.ec.gc.ca/arcgis/rest/services/EcoGeo/EcoGeo/MapServer/9',
                            state: {
                                opacity: 0.8,
                                visibility: true
                            },
                            customRenderer: {} // just to chill things out. real ramp will have all properties defaulted and filled in
                        },
                        {
                            id: 'WFSLayer',
                            layerType: 'ogcWfs',
                            url: 'https://geo.weather.gc.ca/geomet-beta/features/collections/hydrometric-stations/items?startindex=6000',
                            state: {
                                visibility: true
                            },
                            customRenderer: {}
                        },
                        {
                            id: 'Happy',
                            layerType: 'esriFeature',
                            fileType: 'geojson',
                            url: 'http://fgpv-app.azureedge.net/demo/assets/sample_data/happy.json',
                            state: {
                                visibility: true
                            },
                            customRenderer: {} // just to chill things out. real ramp will have all properties defaulted and filled in
                        }
                    ],
                    fixtures: {
                        appbar: {
                            items: [
                                { id: 'gazebo', options: { colour: '#54a0ff' } },
                                'divider',
                                'snowman-appbar-button',
                                'legend',
                                'geosearch',
                                'basemap',
                                'divider'
                            ]
                        },
                        mapnav: { items: ['fullscreen', 'help', 'home', 'basemap'] }
                    }
                });

                // start loading fixtures; this is just an example

                rInstance.fixture.add('appbar');
                rInstance.fixture.add('mapnav');
                rInstance.fixture.add('snowman');
                var gazProm = rInstance.fixture.add('gazebo');
                rInstance.fixture.add('geosearch');
                rInstance.fixture.add('basemap');
                rInstance.fixture.add('legend');
                rInstance.fixture.add('grid');
                rInstance.fixture.add('details');
                rInstance.fixture.add('help');

                var dillyProm = rInstance.fixture.add('diligord', window.hostFixtures.diligord);
                rInstance.fixture.add('mouruge', window.hostFixtures.mouruge);

                // sample event declared by the page
                Promise.all([gazProm, dillyProm]).then(function (funArray) {
                    // using the fixture gets even though I could use funArray
                    var gazebo = rInstance.fixture.get('gazebo');
                    var handler = function (text) {
                        // important to use get here, as the fixture might have been removed later on
                        var diligord = rInstance.fixture.get('diligord');
                        if (!diligord) { return; }
                        diligord.doAThing(text);
                    };
                    gazebo.on('beholdMyText', handler, 'SAMPLE_HANLDER');
                });
            }

            function switchLang() {
                if (rInstance.language === 'en') {
                    rInstance.setLanguage('fr');
                } else {
                    rInstance.setLanguage('en');
                }
                document.getElementById('instance-language').innerText = rInstance.language;
            }
        </script>
    </body>
</html>
