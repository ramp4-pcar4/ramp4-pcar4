{"version":3,"file":"associatedFeatureServiceUtils-Fa0FisSW.js","sources":["../../node_modules/@arcgis/core/layers/support/associatedFeatureServiceUtils.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport{id as e}from\"../../kernel.js\";import r from\"../../request.js\";import t from\"../../core/Error.js\";import{throwIfAbortError as n}from\"../../core/promiseUtils.js\";import{parse as a}from\"./arcgisLayerUrl.js\";import o from\"../../portal/Portal.js\";import i from\"../../portal/PortalItem.js\";async function s(e,r){const n=a(e);if(!n)throw new t(\"invalid-url\",\"Invalid scene service url\");const o={...r,sceneServerUrl:n.url.path,layerId:n.sublayer??void 0};if(o.sceneLayerItem??=await l(o),null==o.sceneLayerItem)return f(o.sceneServerUrl.replace(\"/SceneServer\",\"/FeatureServer\"),o);const i=await y(o);if(!i?.url)throw new t(\"related-service-not-found\",\"Could not find feature service through portal item relationship\");o.featureServiceItem=i;const s=await f(i.url,o);return s.portalItem=i,s}async function l(e){const r=(await c(e)).serviceItemId;if(!r)return null;const t=new i({id:r,apiKey:e.apiKey}),a=await u(e);null!=a&&(t.portal=new o({url:a}));try{return await t.load({signal:e.signal})}catch(s){return n(s),null}}async function c(e){if(e.rootDocument)return e.rootDocument;const t={query:{f:\"json\",...e.customParameters,token:e.apiKey},responseType:\"json\",signal:e.signal};try{const n=await r(e.sceneServerUrl,t);e.rootDocument=n.data}catch{e.rootDocument={}}return e.rootDocument}async function u(t){const a=e?.findServerInfo(t.sceneServerUrl);if(a?.owningSystemUrl)return a.owningSystemUrl;const o=t.sceneServerUrl.replace(/(.*\\/rest)\\/.*/i,\"$1\")+\"/info\";try{const e=(await r(o,{query:{f:\"json\"},responseType:\"json\",signal:t.signal})).data.owningSystemUrl;if(e)return e}catch(i){n(i)}return null}async function f(e,n){const o=a(e);if(!o)throw new t(\"invalid-feature-service-url\",\"Invalid feature service url\");const i=o.url.path,s=n.layerId;if(null==s)return{serverUrl:i};const l=c(n),u=n.featureServiceItem?await n.featureServiceItem.fetchData(\"json\"):null,f=(u?.layers?.[0]||u?.tables?.[0])?.customParameters,y=e=>{const t={query:{f:\"json\",...f},responseType:\"json\",authMode:e,signal:n.signal};return r(i,t)},m=y(\"anonymous\").catch((()=>y(\"no-prompt\"))),[p,d]=await Promise.all([m,l]),v=d?.layers,w=p.data&&p.data.layers;if(!Array.isArray(w))throw new Error(\"expected layers array\");if(Array.isArray(v))for(let r=0;r<Math.min(v.length,w.length);r++){if(v[r].id===s)return{serverUrl:i,layerId:w[r].id}}else if(null!=s&&s<w.length)return{serverUrl:i,layerId:w[s].id};throw new Error(\"could not find matching associated sublayer\")}async function y({sceneLayerItem:e,signal:r}){if(!e)return null;try{const t=(await e.fetchRelatedItems({relationshipType:\"Service2Service\",direction:\"reverse\"},{signal:r})).find((e=>\"Feature Service\"===e.type))||null;if(!t)return null;const n=new i({portal:t.portal,id:t.id});return await n.load(),n}catch(t){return n(t),null}}export{s as findAssociatedFeatureService};\n"],"names":["s","r","n","a","t","o","l","f","i","y","c","u","e","m","p","d","v","w"],"mappings":"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","x_google_ignoreList":[0]}