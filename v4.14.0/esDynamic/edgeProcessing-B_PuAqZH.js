import{e as At}from"./deduplicate-Cqg-F-nU.js";import{Q as F,t as H}from"./InterleavedLayout-CuMGnz6O.js";import{t as T}from"./VertexAttributeLocations-DBgVVQz-.js";import{az as I,dk as R,e0 as xt,ci as tt,ce as yt}from"./main-CSjwO60s.js";import{p as It,o as j,s as et,P as K,c as nt,_ as ot,A as st,K as Nt,u as St}from"./vec32-CI1xtKog.js";import{e as Q}from"./Normals-BYejxmw4.js";const it=F().vec3f("position").u16("componentIndex").freeze(),Vt=F().vec2u8("sideness").freeze(),at=H(Vt),rt=F().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),ct=F().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").vec2i16("normal2Compressed").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),zt=H(rt,1),Bt=H(ct,1);T([at,zt]),T([at,Bt]);class _t{constructor(){this.position0=I(),this.position1=I(),this.faceNormal0=I(),this.faceNormal1=I(),this.componentIndex=0,this.cosAngle=0}}const D=-1;function lt(t,n,s){const i=t.vertices.position,r=t.vertices.componentIndex,l=m.position0,d=m.position1,v=m.faceNormal0,A=m.faceNormal1,{edges:a,normals:u}=Ft(t),g=a.length/4,x=n.allocate(g);let M=0;const L=g,N=s?.allocate(L);let U=0,e=0,o=0;O.length=0;for(let p=0;p<g;++p){const V=4*p;i.getVec(a.data[V],l),i.getVec(a.data[V+1],d);const C=O.pushNew();C.index=4*p,C.length=It(l,d)}O.sort((p,V)=>V.length-p.length);const f=new Array,c=new Array;O.forAll(({length:p,index:V})=>{const C=a.data[V],wt=a.data[V+1],Z=a.data[V+2],G=a.data[V+3],J=G===D;if(i.getVec(C,l),i.getVec(wt,d),J){const y=3*Z;j(v,u.data[y],u.data[y+1],u.data[y+2]),et(A,v),m.componentIndex=r.get(C),m.cosAngle=K(v,A)}else{let y=3*Z;if(j(v,u.data[y],u.data[y+1],u.data[y+2]),y=3*G,j(A,u.data[y],u.data[y+1],u.data[y+2]),m.componentIndex=r.get(C),m.cosAngle=K(v,A),bt(m,Et))return;m.cosAngle<-.9999&&et(A,v)}e+=p,o++,J||Mt(m,Ut)?(n.write(x,M++,m),f.push(p)):Ct(m,ut)&&(N&&s&&s.write(N,U++,m),c.push(p))});const w=new Float32Array(f.reverse()),S=new Float32Array(c.reverse()),z=N&&s?{instancesData:N.slice(0,U),lodInfo:{lengths:S}}:void 0;return{regular:{instancesData:x.slice(0,M),lodInfo:{lengths:w}},silhouette:z,averageEdgeLength:e/o}}function Mt(t,n){return t.cosAngle<n}function bt(t,n){return t.cosAngle>n}function Ct(t,n){const s=xt(t.cosAngle);return Nt(ft,t.position1,t.position0),s*(K(ot(kt,t.faceNormal0,t.faceNormal1),ft)>0?-1:1)>n}function Ft(t){const n=t.faces.length/3,s=t.faces,i=t.neighbors,r=t.vertices.position;h.length=X.length=0;for(let l=0;l<n;l++){const d=3*l,v=i[d],A=i[d+1],a=i[d+2],u=s[d],g=s[d+1],x=s[d+2];r.getVec(u,b),r.getVec(g,P),r.getVec(x,$),nt(P,P,b),nt($,$,b),ot(b,P,$),st(b,b),X.pushArray(b),(v===D||u<g)&&(h.push(u),h.push(g),h.push(l),h.push(v)),(A===D||g<x)&&(h.push(g),h.push(x),h.push(l),h.push(A)),(a===D||x<u)&&(h.push(x),h.push(u),h.push(l),h.push(a))}return{edges:h,normals:X}}class Wt{constructor(){this.index=0,this.length=0}}const O=new R({allocator:t=>t||new Wt,deallocator:null}),h=new R({deallocator:null}),X=new R({deallocator:null}),m=new _t,kt=I(),ft=I(),b=I(),P=I(),$=I(),ut=tt(4),Et=Math.cos(ut),Lt=tt(35),Ut=Math.cos(Lt);function pt(t,n,s){const i=n/3,r=new Uint32Array(s+1),l=new Uint32Array(s+1),d=(e,o)=>{e<o?r[e+1]++:l[o+1]++};for(let e=0;e<i;e++){const o=t[3*e],f=t[3*e+1],c=t[3*e+2];d(o,f),d(f,c),d(c,o)}let v=0,A=0;for(let e=0;e<s;e++){const o=r[e+1],f=l[e+1];r[e+1]=v,l[e+1]=A,v+=o,A+=f}const a=new Uint32Array(6*i),u=r[s],g=(e,o,f)=>{if(e<o){const c=r[e+1]++;a[2*c]=o,a[2*c+1]=f}else{const c=l[o+1]++;a[2*u+2*c]=e,a[2*u+2*c+1]=f}};for(let e=0;e<i;e++){const o=t[3*e],f=t[3*e+1],c=t[3*e+2];g(o,f,e),g(f,c,e),g(c,o,e)}const x=(e,o)=>{const f=2*e,c=o-e;for(let w=1;w<c;w++){const S=a[f+2*w],z=a[f+2*w+1];let p=w-1;for(;p>=0&&a[f+2*p]>S;p--)a[f+2*p+2]=a[f+2*p],a[f+2*p+3]=a[f+2*p+1];a[f+2*p+2]=S,a[f+2*p+3]=z}};for(let e=0;e<s;e++)x(r[e],r[e+1]),x(u+l[e],u+l[e+1]);const M=new Int32Array(3*i),L=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,N=(e,o)=>{const f=L(e,o);M[3*o+f]=-1},U=(e,o,f,c)=>{const w=L(e,o);M[3*o+w]=c;const S=L(f,c);M[3*c+S]=o};for(let e=0;e<s;e++){let o=r[e];const f=r[e+1];let c=l[e];const w=l[e+1];for(;o<f&&c<w;){const S=a[2*o],z=a[2*u+2*c];S===z?(U(e,a[2*o+1],z,a[2*u+2*c+1]),o++,c++):S<z?(N(e,a[2*o+1]),o++):(N(z,a[2*u+2*c+1]),c++)}for(;o<f;)N(e,a[2*o+1]),o++;for(;c<w;)N(a[2*u+2*c],a[2*u+2*c+1]),c++}return M}const Y=.7;let dt=class{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?Ot:Dt}write(t,n,s){q.seed=this._edgeHashFunction(s);const i=q.getIntRange(0,255),r=q.getIntRange(0,this.settings.variants-1),l=q.getFloat(),d=255*(.5*Pt(-(1-Math.min(l/Y,1))+Math.max(0,l-Y)/(1-Y),1.2)+.5);t.position0.setVec(n,s.position0),t.position1.setVec(n,s.position1),t.componentIndex.set(n,s.componentIndex),t.variantOffset.set(n,i),t.variantStroke.set(n,r),t.variantExtension.set(n,d)}};const B=new Float32Array(6),_=new Uint32Array(B.buffer),W=new Uint32Array(1);function Dt(t){return B[0]=t.position0[0],B[1]=t.position0[1],B[2]=t.position0[2],B[3]=t.position1[0],B[4]=t.position1[1],B[5]=t.position1[2],W[0]=31*(31*(31*(31*(31*(166811+_[0])+_[1])+_[2])+_[3])+_[4])+_[5],W[0]}function Ot(t){const n=B;n[0]=k(t.position0[0]),n[1]=k(t.position0[1]),n[2]=k(t.position0[2]),n[3]=k(t.position1[0]),n[4]=k(t.position1[1]),n[5]=k(t.position1[2]),W[0]=5381;for(let s=0;s<_.length;s++)W[0]=31*W[0]+_[s];return W[0]}const ht=1e4;function k(t){return Math.round(t*ht)/ht}function Pt(t,n){return Math.abs(t)**n*Math.sign(t)}class $t{constructor(){this._commonWriter=new dt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return rt.createBuffer(n)}write(n,s,i){this._commonWriter.write(n,s,i),St(E,i.faceNormal0,i.faceNormal1),st(E,E);const{typedBuffer:r,typedBufferStride:l}=n.normalCompressed;Q(r,s,E[0],E[1],E[2],l)}}class qt{constructor(){this._commonWriter=new dt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return ct.createBuffer(n)}write(n,s,i){this._commonWriter.write(n,s,i);{const{typedBuffer:r,typedBufferStride:l}=n.normalCompressed;Q(r,s,i.faceNormal0[0],i.faceNormal0[1],i.faceNormal0[2],l)}{const{typedBuffer:r,typedBufferStride:l}=n.normal2Compressed;Q(r,s,i.faceNormal1[0],i.faceNormal1[1],i.faceNormal1[2],l)}}}const E=I(),q=new yt;function Ht(t){const n=mt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return gt.updateSettings(t.writerSettings),vt.updateSettings(t.writerSettings),lt(n,gt,vt)}function mt(t,n,s,i){if(n){const d=pt(s,i,t.count);return new Rt(s,i,d,t)}const r=At(t.buffer,t.stride/4,{originalIndices:s}),l=pt(r.indices,i,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:l,vertices:it.createView(r.buffer)}}class Rt{constructor(n,s,i,r){this.faces=n,this.facesLength=s,this.neighbors=i,this.vertices=r}}const gt=new $t,vt=new qt,jt=F().vec3f("position0").vec3f("position1"),Kt=F().vec3f("position0").vec3f("position1").u16("componentIndex");export{jt as a,Ht as c,lt as d,mt as f,Kt as g,it as t};
