import{fe as P,p as w,cW as v,ff as R}from"./main-CSjwO60s.js";import{P as N,$ as x}from"./utils-BY9h3ZK4.js";import{n as G,l as _}from"./fetchService-CbI45rct.js";import{o as D}from"./jsonContext-XeqO0vLP.js";import{l as J,u,c as C,E as l,s as Y}from"./portalItemUtils-C12I5owR.js";const p="Feature Service",d="feature-layer-utils",$=`${d}-save`,F=`${d}-save-as`;function m(e){return{isValid:P(e)&&(!("dynamicDataSource"in e)||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function h(e,r){const a=D(e,"portal-item");return r?.isTable&&(a.layerContainerType="tables"),a}function b(e){const r=[],a=[];for(const{layer:t,layerJSON:o}of e)M(t)?a.push(o):r.push(o);return{layers:r,tables:a}}function M(e,r){return e.isTable}function T(e){return b([e])}async function U(e,r){return/\/\d+\/?$/.test(e.url)?T(r[0]):k(r,e)}async function k(e,r){if(e.reverse(),!r)return b(e);const a=await B(r,e);for(const t of e)I(t.layer,t.layerJSON,a);return V(a,e),a}async function B(e,r){let a=await e.fetchData("json");if(K(a)&&!Y(e,l.HOSTED_SERVICE))return a;a||={},H(a);const{layer:{url:t,customParameters:o,apiKey:n}}=r[0];return await j(a,{url:t??"",customParameters:o,apiKey:n},r.map(s=>s.layer.layerId)),a}function K(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function H(e){e.layers||=[],e.tables||=[]}function V(e,r){const a=[],t=[];for(const{layer:o}of r){const{isTable:n,layerId:s}=o;n?t.push(s):a.push(s)}S(e.layers,a),S(e.tables,t)}function S(e,r){if(e.length<2)return;const a=[];for(const{id:t}of e)a.push(t);v(a.sort(E),r.slice().sort(E))&&e.sort((t,o)=>{const n=r.indexOf(t.id),s=r.indexOf(o.id);return n<s?-1:n>s?1:0})}function E(e,r){return e<r?-1:e>r?1:0}async function j(e,r,a){const{url:t,customParameters:o,apiKey:n}=r,{serviceJSON:s,layersJSON:i}=await G(t,{customParameters:o,apiKey:n}),c=L(e.layers,s.layers,a),y=L(e.tables,s.tables,a);e.layers=c.itemResources,e.tables=y.itemResources;const f=[...c.added,...y.added],O=i?[...i.layers,...i.tables]:[];await W(e,f,t,O)}function L(e,r,a){const t=R(e,r,(n,s)=>n.id===s.id);e=e.filter(n=>!t.removed.some(s=>s.id===n.id));const o=t.added;return o.forEach(({id:n})=>{e.push({id:n})}),{itemResources:e,added:o.filter(({id:n})=>!a.includes(n))}}async function W(e,r,a,t){const o=await q(r),n=r.map(({id:s,type:i})=>new(o.get(i))({url:a,layerId:s,sourceJSON:t.find(({id:c})=>c===s)}));await Promise.allSettled(n.map(s=>s.load())),n.forEach(s=>{const{layerId:i,loaded:c,defaultPopupTemplate:y}=s;if(!c||y==null)return;const f={id:i,popupInfo:y.toJSON()};I(s,s.operationalLayerType==="ArcGISFeatureLayer"?f:{...f,layerType:s.operationalLayerType},e)})}async function q(e){const r=[];e.forEach(({type:o})=>{switch(_(o)){case"CatalogLayer":r.push(import("./CatalogLayer-CCoq0UKN.js").then(n=>n.default));break;case"FeatureLayer":r.push(import("./FeatureLayer-CCD4d2TK.js").then(n=>n.default));break;case"OrientedImageryLayer":r.push(import("./OrientedImageryLayer-D3KTQDD3.js").then(n=>n.default))}});const a=await Promise.all(r),t=new Map;return e.forEach(({type:o},n)=>{t.set(o,a[n])}),t}function I(e,r,a){e.isTable?g(a.tables,r):g(a.layers,r)}function g(e,r){const a=e.findIndex(({id:t})=>t===r.id);a===-1?e.push(r):e[a]=r}function z(e){if(!("layerType"in e))return!!e.charts?.length;switch(e.layerType){case"OrientedImageryLayer":return!!e.charts?.length;case"SubtypeGroupLayer":return!!e.layers.some(r=>!!r.charts?.length);case"SubtypeGroupTable":return!!e.tables.some(r=>!!r.charts?.length);case"CatalogLayer":return!!e.footprintLayer?.charts?.length}}function A(e,r){let a=0,t=0,o=0,n=0;for(const s of[...r.layers,...r.tables])if(z(s)&&n++,"layerType"in s)switch(s.layerType){case"OrientedImageryLayer":a++;break;case"SubtypeGroupLayer":t++;break;case"SubtypeGroupTable":o++}u(e,l.ORIENTED_IMAGERY_LAYER,a>0),u(e,l.SUBTYPE_GROUP_LAYER,t>0),u(e,l.SUBTYPE_GROUP_TABLE,o>0),u(e,l.CHARTS,n>0)}function Q(e,r,a){C(r,l.METADATA),u(r,l.MULTI_LAYER,e.length>1),u(r,l.SINGLE_LAYER,e.length===1),u(r,l.TABLE,a.tables.length>0&&a.layers.length===0),A(r,a)}async function X(e,r,a){A(r,a)}async function Z(e,r,a){const{url:t,layerId:o,title:n,fullExtent:s,isTable:i}=e,c=w(t);r.url=(c?.serverType==="FeatureServer"?t:`${t}/${o}`)??null,r.title||=n,r.extent=null,i||s==null||(r.extent=await J(s)),Q([e],r,a)}async function ee(e,r){return N({layer:e,itemType:p,validateLayer:m,createJSONContext:a=>h(a,e),createItemData:(a,t)=>U(t,[a]),errorNamePrefix:$,setItemProperties:X},r)}async function re(e,r,a){return x({layer:e,itemType:p,validateLayer:m,createJSONContext:t=>h(t,e),createItemData:(t,o)=>Promise.resolve(T(t)),errorNamePrefix:F,newItem:r,setItemProperties:Z},a)}export{ee as save,re as saveAs};
