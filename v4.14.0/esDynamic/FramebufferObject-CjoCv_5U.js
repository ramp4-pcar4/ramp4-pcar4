import{al as C,eB as F,i as R}from"./main-CSjwO60s.js";import{o as U}from"./BufferObject-RHe5uojV.js";import{_ as y,A as f,a as D}from"./Texture-DLw7oaIg.js";import{O as _,D as o,N as T,u as M,G as N,n as A,T as b,o as B}from"./enums-DDJfd4_p.js";class z{constructor(e,i=0,t=i,r=!1,n=1){this.internalFormat=e,this.width=i,this.height=t,this.multisampled=r,this.samples=n}}function P(s){return s.width<=0||s.height<=0||s.internalFormat==null?0:s.width*s.height*y(s.internalFormat)}const v=!!C("esri-tests-disable-gpu-memory-measurements");class S{constructor(e,i){this._context=e,this._descriptor=i,this.type=2,this._context.instanceCounter.increment(_.Renderbuffer,this);const t=this._context.gl;this.glName=t.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:r,height:n,internalFormat:h,multisampled:a}=i;a?t.renderbufferStorageMultisample(t.RENDERBUFFER,this.samples,h,r,n):t.renderbufferStorage(t.RENDERBUFFER,h,r,n),this._context.bindRenderbuffer(null)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,i=this._context.parameters.maxSamples;return e?Math.min(e,i):i}get usedMemory(){return v?0:P(this._descriptor)}resize(e,i){const t=this._descriptor;if(t.width===e&&t.height===i)return;t.width=e,t.height=i;const r=this._context.gl;this._context.bindRenderbuffer(this),t.multisampled?r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,t.internalFormat,t.width,t.height):r.renderbufferStorage(r.RENDERBUFFER,t.internalFormat,t.width,t.height),this._context.bindRenderbuffer(null)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(_.Renderbuffer,this),this._context=null)}}const L=()=>R.getLogger("esri.views.webgl.FramebufferObject");let I=class d{constructor(e,i,t){if(this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthStencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(_.FramebufferObject,this),i!=null){const r=G(e,i);r!=null&&(this._colorAttachments.set(o,r),u(r)?this._validateTextureDescriptor(r.descriptor):this._validateRenderbufferDescriptor(r.descriptor)),this._validateColorAttachmentPoint(o)}if(t!=null)if(H(t))this._depthStencilTexture=u(t)?t:new f(e,t),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const r=E(t)?t:new S(e,t);this._depthStencilBuffer=r,this._validateRenderbufferDescriptor(r.descriptor)}}dispose(){const{_colorAttachments:e,_glName:i}=this;if(e.size===0&&!this._depthStencilBuffer&&!this._depthStencilTexture&&!i)return;const{_context:t}=this,r=t.getBoundFramebufferObject();e.forEach((n,h)=>this.detachColorTexture(h)?.dispose()),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),t.gl.deleteFramebuffer(i),this._glName=null,t.bindFramebuffer(r===this?null:r),t.instanceCounter.decrement(_.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){const e=this._colorAttachments.get(o);return u(e)?e:null}get depthStencil(){return this._depthStencilTexture||this._depthStencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){return(this._colorAttachments.get(o)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.width??0}get height(){return(this._colorAttachments.get(o)??this._depthStencilTexture??this._depthStencilBuffer)?.descriptor?.height??0}get usedMemory(){return[...this._colorAttachments].reduce((e,[i,t])=>e+t.usedMemory,this.depthStencil?.usedMemory??0)}static{this._MAX_COLOR_ATTACHMENTS=-1}getColorTexture(e){const i=this._colorAttachments.get(e);return i&&u(i)?i:null}get colorAttachments(){return[...this._colorAttachments.keys()]}attachColorTexture(e,i=o){if(!e)return;this._validateColorAttachmentPoint(i);const{descriptor:t}=e;this._validateTextureDescriptor(t),this.detachColorTexture(i)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,i)),this._colorAttachments.set(i,e)}detachColorTexture(e=o){const i=this._colorAttachments.get(e);if(!i)return;const t=u(i);return this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{if(t)this._framebufferTexture2D(null,e);else{const r=this._context.gl;r.framebufferRenderbuffer(r.FRAMEBUFFER,e,r.RENDERBUFFER,null)}}),this._colorAttachments.delete(e),t?i:void 0}setColorTextureTarget(e,i=o,t=0){const r=this._colorAttachments.get(i);r&&(e===35866?this._framebufferTextureLayer(r.glName,i,36160,0,t):this._framebufferTexture2D(r.glName,i,e,36160,0))}attachDepthStencil(e){if(e)switch(e.type){case 1:return this._attachDepthStencilTexture(e);case 2:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(e==null)return;const{descriptor:i}=e,{pixelFormat:t,dataType:r}=i;t===34041||t===6402?t!==34041||r===T.UNSIGNED_INT_24_8?t!==6402||r===T.UNSIGNED_INT||r===T.UNSIGNED_SHORT?(this._validateTextureDescriptor(i),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,x(t))),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e):console.error("Depth texture must have data type of UNSIGNED_INT or UNSIGNED_SHORT!"):console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"):console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!")}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&this._context.temporaryBindFramebufferObject(this,()=>{this._framebufferTexture2D(null,x(e.descriptor.pixelFormat))}),this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(e==null)return;const i=e.descriptor;if(this._validateRenderbufferDescriptor(i),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const{gl:t}=this._context,r=this._getGLAttachmentPoint(i);t.framebufferRenderbuffer(36160,r,t.RENDERBUFFER,e.glName)}this._depthStencilBuffer=e}detachDepthStencilBuffer(){const e=this._depthStencilBuffer;if(e&&this._initialized){const{_context:i}=this,t=i.getBoundFramebufferObject();i.bindFramebuffer(this);const{gl:r}=i,n=this._getGLAttachmentPoint(e.descriptor);r.framebufferRenderbuffer(36160,n,r.RENDERBUFFER,null),i.bindFramebuffer(t)}return this._depthStencilBuffer=null,e}invalidateAttachments(e){const{_context:i}=this;i.temporaryBindFramebufferObject(this,()=>i.gl.invalidateFramebuffer(36160,e),!0)}copyToTexture(e,i,t,r,n,h,a){(e<0||i<0||n<0||h<0)&&console.error("Offsets cannot be negative!"),(t<=0||r<=0)&&console.error("Copy width and height must be greater than zero!");const l=a.descriptor;a.descriptor.target!==3553&&console.error("Texture target must be TEXTURE_2D!"),(l?.width==null||l?.height==null||e+t>this.width||i+r>this.height||n+t>l.width||h+r>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const c=this._context,g=c.bindTexture(a,f.TEXTURE_UNIT_FOR_UPDATES);c.setActiveTexture(f.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(this),c.gl.copyTexSubImage2D(3553,0,n,h,e,i,t,r),c.bindTexture(g,f.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,i,t,r,n,h,a){(t<=0||r<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,i,t,r,n,h,a)}async readPixelsAsync(e,i,t,r,n,h,a){const{gl:l}=this._context,c=U.createPixelPack(this._context,35041,a.byteLength);this._context.bindBuffer(c);const g=this._context.getBoundFramebufferObject();this._context.bindFramebuffer(this),l.readPixels(e,i,t,r,n,h,0),this._context.unbindBuffer(35051),this._context.bindFramebuffer(g),await c.getSubDataAsync(a),c.dispose()}resize(e,i){if(this.width===e&&this.height===i)return;const t={width:e,height:i};if(p(t,this._context.parameters.maxTextureSize),this._colorAttachments.forEach(r=>r.resize(t.width,t.height)),this._depthStencilTexture?.resize(t.width,t.height),this._initialized&&(p(t,this._context.parameters.maxRenderbufferSize),this._depthStencilBuffer?.resize(t.width,t.height),D())){const{gl:r}=this._context;r.checkFramebufferStatus(36160)!==r.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!")}}initializeAndBind(e=36160){const{gl:i}=this._context;if(this._initialized)return void i.bindFramebuffer(e,this.glName);this._glName&&i.deleteFramebuffer(this._glName);const t=i.createFramebuffer();if(i.bindFramebuffer(e,t),this._colorAttachments.forEach((r,n)=>{if(u(r)){const h=O(r);h===35866?this._framebufferTextureLayer(r.glName,n,e,0,0):this._framebufferTexture2D(r.glName,n,h,e)}else if(E(r)){const h=this._context.gl;h.framebufferRenderbuffer(e,n,h.RENDERBUFFER,r.glName)}}),this._depthStencilBuffer){const r=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);i.framebufferRenderbuffer(e,r,i.RENDERBUFFER,this._depthStencilBuffer.glName)}else if(this._depthStencilTexture){const r=x(this._depthStencilTexture.descriptor.pixelFormat);this._framebufferTexture2D(this._depthStencilTexture.glName,r,O(this._depthStencilTexture),e)}D()&&i.checkFramebufferStatus(e)!==i.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=t,this._initialized=!0}_framebufferTexture2D(e,i=o,t=3553,r=36160,n=0){this._context.gl.framebufferTexture2D(r,i,t,e,n)}_framebufferTextureLayer(e,i=o,t=36160,r=0,n=0){this._context.gl.framebufferTextureLayer(t,i,e,r,n)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthStencilBuffer){if(this._initialized){this._context.bindFramebuffer(this);const i=this._getGLAttachmentPoint(this._depthStencilBuffer.descriptor);e.framebufferRenderbuffer(36160,i,e.RENDERBUFFER,null)}this._depthStencilBuffer=F(this._depthStencilBuffer)}this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,x(this._depthStencilTexture.descriptor.pixelFormat))),this._depthStencilTexture=F(this._depthStencilTexture))}_validateTextureDescriptor(e){e.target!==3553&&e.target!==34067&&e.target!==35866&&console.error("Texture type must be TEXTURE_2D, TEXTURE_2D_ARRAY or TEXTURE_CUBE_MAP!"),p(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderbufferDescriptor(e){p(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case b.DEPTH_COMPONENT16:case b.DEPTH_COMPONENT24:case b.DEPTH_COMPONENT32F:return B;case N.DEPTH24_STENCIL8:case N.DEPTH32F_STENCIL8:return A;case 36168:return M;default:return o}}_validateColorAttachmentPoint(e){if(d._MAX_COLOR_ATTACHMENTS===-1){const{gl:t}=this._context;d._MAX_COLOR_ATTACHMENTS=t.getParameter(t.MAX_COLOR_ATTACHMENTS)}const i=e-o;i+1>d._MAX_COLOR_ATTACHMENTS&&R.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${i+1}. Implementation supports up to ${d._MAX_COLOR_ATTACHMENTS} color attachments`)}};function u(s){return m(s)===1}function E(s){return m(s)===2}function H(s){return u(s)||w(s)}function w(s){return m(s)===0}function X(s){return m(s)===3||s!=null&&"samples"in s}function m(s){return s!=null&&"type"in s?s.type:null}function G(s,e){return u(e)||E(e)?e:w(e)?new f(s,e):X(e)?new S(s,e):null}function p(s,e){const i=Math.max(s.width,s.height);if(i>e){L().warnOnce(`Resizing FBO attachment size ${s.width}x${s.height} to device limit ${e}`);const t=e/i;return s.width=Math.round(s.width*t),s.height=Math.round(s.height*t),!1}return!0}function O(s){return s.descriptor.target===34067?34069:s.descriptor.target===35866?35866:3553}function x(s){return s===6402?B:A}export{z as i,I as m,S as s};
