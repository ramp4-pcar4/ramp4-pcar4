import{Y as ds}from"./CIMSymbolHelper-C-M9oL19.js";import{o as ms}from"./defaultCIMValues-BWu-APou.js";import{al as kt,dm as hs,_ as n,ie as P,ll as ys,hY as fs,ce as vs,s as Oe,eB as Hi,i as Ni,ca as jt,j9 as qi,c3 as gs,bJ as bs,eM as xs,$ as ws}from"./main-CSjwO60s.js";import{m as h,C as a,c as f,U as N,r as L,j as E,d as B,a0 as ee,s as vt,a as fe,ao as Ss,P as yi,x as k,v as Fe,_ as w,p as M,G as U,f as y,Y as R,n as Lt,a2 as C,i as fi,au as ve,I as Wi,T as vi,F as gt,y as zt,e as G,a5 as Ie,B as ge,a7 as gi,u as Bt,M as Et,J as ke,b as lt,q as ut,$ as be,at as Vs,a3 as Y,av as zs,Q as xe,L as Zt,aw as Le,a8 as Gi,D as bi,ax as Ps,w as $t,ay as As,t as Ut,g as A,az as ji,o as Zi,X as pt,k as _s,E as $i,A as Ki,z as Rs,N as xi,ab as Ms,ae as Ts,W as Cs,aA as Ds}from"./GraphShaderModule-2-Wwh4Ie.js";import{d as bt,g as Os,b as Xi,e as Yi,c as Be,n as Fs}from"./UpdateTracking2D-CIKx7GWt.js";import{P as Is,o as at,O as ks,N as Qi,s as Ji,u as Ls,y as Bs}from"./definitions-DVO21zOC.js";import{B as Es,q as wi,A as Us,h as W,g as Hs,x as Pt,C as Ee,k as ie,z as Ns,w as to,D as eo,E as Ue}from"./utils-CVxMaYM5.js";import{H as qs,e as io,o as Si,p as oo,i as so,w as ao,C as Ws,r as Gs,s as js,h as Zs,B as $s,L as Ks,K as Xs,J as Ys,d as ro,f as no,F as Qs,G as Js,D as ta,E as ea}from"./constants-CWFGCPkc.js";import{e as lo,l as q,B as j,C as we,D as X,E as tt,F as Q,H as uo,I as ia}from"./MapView-CrB-5KSL.js";import{R as St,_ as po,G as co,N as He,E as mo}from"./enums-DDJfd4_p.js";import{o as oa}from"./BufferObject-RHe5uojV.js";import{s as sa,i as ho,m as yo}from"./FramebufferObject-CjoCv_5U.js";import"./ProgramTemplate-BqCbl7jA.js";import{h as Ne,A as fo}from"./Texture-DLw7oaIg.js";import{h as aa}from"./VertexArrayObject-BAcBN849.js";import{r as ra}from"./VertexBuffer-7GCTDD7e.js";import{t as na}from"./VertexElementDescriptor-DLvjNrmQ.js";import{i as la,a as ua}from"./rasterizingUtils-Cf1zdzIw.js";import{d as vo}from"./WGLContainer-CV7lovie.js";import{m as pa}from"./lengthUtils-CopeXEyE.js";import{r as ca}from"./streamLayerUtils-CcwO9-27.js";import{t as qe}from"./capabilities-BaKzUyhi.js";import{QueueProcessor as da}from"./QueueProcessor-Bne-Dlbg.js";let ma=class{get forceStaticPath(){return kt("esri-cim-animations-enable-status")==="disabled"}get forceAnimatedPath(){return kt("esri-cim-animations-enable-status")==="forced"}get freezeGlobalTime(){return kt("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!kt("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return kt("esri-cim-animations-freeze-time")!==!1}};const We=new ma,Vi={[St.BYTE]:1,[St.UNSIGNED_BYTE]:1,[St.SHORT]:2,[St.UNSIGNED_SHORT]:2,[St.HALF_FLOAT]:2,[St.INT]:4,[St.UNSIGNED_INT]:4,[St.FLOAT]:4};let go=class{constructor(t,e){this._boundPart=null,this.vertexBuffers=new Map,this.indexBuffers=new Map,this.groups=[];for(const i in e.vertex){const{data:o,layout:s}=e.vertex[i],r=new ra(t,s,o);this.vertexBuffers.set(i,r)}for(const i in e.index){const{data:o}=e.index[i],s=oa.createIndex(t,35044,o);this.indexBuffers.set(i,s)}for(const i of e.groups)this.groups.push({...i,vertexArrays:new Map});this.parts=e.parts}bind(t,e,i){this._boundPart=i;const{group:o}=this.parts[this._boundPart],s=this.groups[o];if(!s)throw new Error(`Missing group ${o}.`);let r=s.vertexArrays.get(e.stringHash);if(!r){const l=hs(new Set(e.locations.keys())),u=s.index?this.indexBuffers.get(s.index):null,p=new Map;for(const[c,d]of this.vertexBuffers)d.layout.filter(m=>l.has(m.name)).length>0&&p.set(c,d);r=new aa(t,p,u),s.vertexArrays.set(e.stringHash,r)}t.bindVAO(r)}draw(t){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");const{start:e,count:i}=this.parts[this._boundPart],{group:o}=this.parts[this._boundPart],{primitive:s,index:r}=this.groups[o];if(r){const l=this.indexBuffers.get(r);if(!l)throw new Error(`Missing index buffer "${r}".`);const{indexType:u}=l;if(!u)throw new Error("Buffer type error.");t.drawElements(s,i,u,e*Vi[u])}else t.drawArrays(s,e,i)}unbind(t){this._boundPart=null,t.bindVAO(null)}destroy(){this.groups.forEach(({vertexArrays:t})=>t.forEach(e=>e.disposeVAOOnly())),this.vertexBuffers.forEach(t=>t.dispose()),this.indexBuffers.forEach(t=>t.dispose())}};const ha={position:{type:St.SHORT,count:2}};let bo=class Ui extends go{static create(e,i){const o=[];let{stride:s}=i;if(s==null){s=0;for(const[d,{count:m,type:v,offset:b}]of Object.entries(i.layout)){if(b!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");s+=m*Vi[v]}}let r=0;for(const[d,{count:m,offset:v,type:b,normalized:g}]of Object.entries(i.layout)){v!=null&&(r=v);const x=new na(d,m,b,r,s,g!=null&&g,0);o.push(x),r+=m*Vi[b]}const l={primitive:i.primitive};i.index!=null&&(l.index="indexData");let{count:u}=i;if(u==null&&(u=i.index?i.index.length:i.vertex.byteLength/s,Math.floor(u)!==u))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${s}.`);const p={start:0,count:u,group:0,primitive:i.primitive},c={vertex:{vertexData:{data:i.vertex,layout:o}},parts:[p],groups:[l]};return i.index!=null&&(c.index={indexData:{data:i.index}}),new Ui(e,c,i.layout)}static fromVertexStream(e,i){return Ui.create(e,{primitive:po.TRIANGLE_STRIP,vertex:new Uint16Array(i),layout:ha})}constructor(e,i,o){super(e,i),this._spec=o}bind(e,i,o=0){super.bind(e,i,o)}},Ht=class extends E{};n([h(a)],Ht.prototype,"globalTime",void 0),n([h(f)],Ht.prototype,"animationTextureSize",void 0),n([h(N)],Ht.prototype,"animationTexture",void 0),n([h(L)],Ht.prototype,"toScreen",void 0),n([h(L)],Ht.prototype,"toNdc",void 0),n([h(a)],Ht.prototype,"mapRotation",void 0),n([h(a)],Ht.prototype,"pixelRatio",void 0);let Vt=class extends E{getVisualVariableData(t){if(!this._vvData){const e=this.getAttributeDataCoords(t);this._vvData=B(this.visualVariableData,e).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const e=Es(t),i=this.size,o=ee(e.x),s=ee(e.y).multiply(ee(256)),r=ee(e.z).multiply(ee(256)).multiply(ee(256)),l=vt(o.add(s).add(r)),u=fe(l,i),p=l.subtract(u).divide(i);this._uv=new f(u,p).add(.5).divide(i)}return this._uv}getFilterData(t){const e=this.getAttributeDataCoords(t);return B(this.filterFlags,e).setDebugName("storage0")}getAnimationData(t){const e=this.getAttributeDataCoords(t);return B(this.animation,e).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const e=this.getAttributeDataCoords(t);return B(this.dataDriven0,e).setDebugName("storage30")}getDataDrivenData1(t){const e=this.getAttributeDataCoords(t);return B(this.dataDriven1,e).setDebugName("storage31")}getDataDrivenData2(t){const e=this.getAttributeDataCoords(t);return B(this.dataDriven2,e).setDebugName("storage32")}getGPGPUData(t){const e=this.getAttributeDataCoords(t);return B(this.gpgpu,e).setDebugName("storage4")}getLocalTimeOrigin(t){const e=this.getAttributeDataCoords(t);return B(this.localTimeOrigin,e).x.setDebugName("storage5")}getFilterFlags(t){return kt("webgl-ignores-sampler-precision")?Ss(this.getFilterData(t).x.multiply(vt(255))):this.getFilterData(t).x.multiply(vt(255))}getLabelVisibility(t){const e=this.getFilterData(t).y.multiply(255);return new a(1).subtract(e)}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}};n([h(N)],Vt.prototype,"filterFlags",void 0),n([h(N)],Vt.prototype,"animation",void 0),n([h(N)],Vt.prototype,"gpgpu",void 0),n([h(N)],Vt.prototype,"localTimeOrigin",void 0),n([h(N)],Vt.prototype,"visualVariableData",void 0),n([h(N)],Vt.prototype,"dataDriven0",void 0),n([h(N)],Vt.prototype,"dataDriven1",void 0),n([h(N)],Vt.prototype,"dataDriven2",void 0),n([h(a)],Vt.prototype,"size",void 0);let zi=class extends E{};n([h(a)],zi.prototype,"activeReasons",void 0),n([h(a)],zi.prototype,"highlightAll",void 0);let Se=class extends E{};n([h(f)],Se.prototype,"position",void 0),n([h(a)],Se.prototype,"distance",void 0),n([h(a)],Se.prototype,"smallSymbolDistance",void 0),n([h(a)],Se.prototype,"smallSymbolSizeThreshold",void 0);let et=class extends E{};n([h(L)],et.prototype,"displayViewScreenMat3",void 0),n([h(L)],et.prototype,"displayViewMat3",void 0),n([h(L)],et.prototype,"displayMat3",void 0),n([h(L)],et.prototype,"viewMat3",void 0),n([h(L)],et.prototype,"tileMat3",void 0),n([h(a)],et.prototype,"displayZoomFactor",void 0),n([h(a)],et.prototype,"requiredZoomFactor",void 0),n([h(f)],et.prototype,"tileOffset",void 0),n([h(a)],et.prototype,"currentScale",void 0),n([h(a)],et.prototype,"currentZoom",void 0),n([h(a)],et.prototype,"metersPerSRUnit",void 0),n([h(a)],et.prototype,"rotation",void 0),n([h(a)],et.prototype,"pixelRatio",void 0);let ct=class extends fi{};n([y(0,R)],ct.prototype,"id",void 0),n([y(1,a)],ct.prototype,"bitset",void 0),n([y(2,f)],ct.prototype,"pos",void 0);let dt=class extends ve{};n([y(14,f)],dt.prototype,"nextPos1",void 0),n([y(15,f)],dt.prototype,"nextPos2",void 0);let xt=class extends Wi{},ot=class extends yi{clip(t,e){let i=new a(0);const o=this.storage.getFilterFlags(t);if(i=i.add(vt(2).multiply(vt(1).subtract(wi(o,0)))),this.inside?i=i.add(vt(2).multiply(vt(1).subtract(wi(o,1)))):this.outside?i=i.add(vt(2).multiply(wi(o,1))):this.highlight&&(i=i.add(vt(2).multiply(vt(1).subtract(this._checkHighlight(o))))),e!=null){const s=new a(1).subtract(k(e.x,this.view.currentZoom)),r=k(e.y,this.view.currentZoom);i=i.add(new a(2).multiply(s.add(r)))}return i}getFragmentOutput(t,e,i=new a(1/255)){const o=new Fe;return o.fragColor=this._maybeWriteHittest(e)??this._maybeHighlight(t,i)??t,o}_maybeHighlight(t,e){return this.highlight?new w(t.rgb,k(e,t.a)):null}_checkHighlight(t){let e=this._checkHighlightBit(t,0);for(let i=1;i<Is;i++)e=e.add(this._checkHighlightBit(t,i));return k(new a(.1),e.add(this.highlight.highlightAll))}_checkHighlightBit(t,e){return Us(t,e).multiply(W(this.highlight.activeReasons,e))}maybeRunHittest(t,e,i){if(this.hittestRequest==null)return null;const o=this.hittest(t,e,i);let s=M(U(o,this.hittestRequest.distance),new a(2),new a(0));const r=this.storage.getAttributeDataCoords(t.id),l=Hs(r);s=s.add(this.clip(t.id,t.zoomRange));const u=new w(new a(1/255),0,0,0);return{glPointSize:new a(1),glPosition:new w(l,s,1),color:u}}_maybeWriteHittest(t){return this.hittestRequest!=null?t.color:null}};n([Lt],ot.prototype,"inside",void 0),n([Lt],ot.prototype,"outside",void 0),n([C(zi)],ot.prototype,"highlight",void 0),n([h(Vt)],ot.prototype,"storage",void 0),n([h(et)],ot.prototype,"view",void 0),n([C(Se)],ot.prototype,"hittestRequest",void 0);let Kt=class extends E{getPatternOffsetAtTileOrigin(t,e=new a(0),i=new a(1)){const o=new f(qs).divide(t);let s=t.multiply(vi(this.maxIntsToLocalOrigin.multiply(o))).add(this.tileOffsetFromLocalOrigin).subtract(new a(.5).multiply(t));return s=new f(s.x.multiply(i).subtract(s.y.multiply(e)),s.x.multiply(e).add(s.y.multiply(i))),fe(s,t)}};n([h(f)],Kt.prototype,"tileOffsetFromLocalOrigin",void 0),n([h(f)],Kt.prototype,"maxIntsToLocalOrigin",void 0);let mt=class extends E{};n([h(f)],mt.prototype,"size",void 0),n([h(N)],mt.prototype,"texture",void 0);let Nt=class extends E{getColor(t,e,i){return zt([gi(Pt(t),i),e],[ge(t,this.values.first()),this.colors.first()],[Ie(t,this.values.last()),this.colors.last()],[!0,()=>{const o=this.values.findIndex(p=>U(p,t)),s=this.values.get(o),r=o.subtract(1),l=this.values.get(r),u=t.subtract(l).divide(s.subtract(l));return G(this.colors.get(r),this.colors.get(o),u)}])}};n([h(gt.ofType(w,8))],Nt.prototype,"colors",void 0),n([h(gt.ofType(a,8))],Nt.prototype,"values",void 0);let qt=class extends E{getOpacity(t){return zt([Pt(t),new a(1)],[ge(t,this.opacityValues.first()),this.opacities.first()],[Ie(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const e=this.opacityValues.findIndex(l=>U(l,t)),i=this.opacityValues.get(e),o=e.subtract(1),s=this.opacityValues.get(o),r=t.subtract(s).divide(i.subtract(s));return G(this.opacities.get(o),this.opacities.get(e),r)}])}};n([h(gt.ofType(a,8))],qt.prototype,"opacities",void 0),n([h(gt.ofType(a,8))],qt.prototype,"opacityValues",void 0);let Ge=class extends E{getVVRotationMat4(t){return M(Pt(t),ke.identity(),()=>{const e=this.getNormalizedAngle(t).multiply(io),i=Bt(e),o=Et(e);return new ke(o,i,0,0,i.multiply(new a(-1)),o,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(t){return M(Pt(t),L.identity(),()=>{const e=this.getNormalizedAngle(t).multiply(io),i=Bt(e),o=Et(e);return new L(o,i,0,i.multiply(new a(-1)),o,0,0,0,1)})}getNormalizedAngle(t){const e=lt(this.rotationType,new a(1));return M(e,new a(90).subtract(t),t)}};n([h(a)],Ge.prototype,"rotationType",void 0);let oe=class extends E{getSize(t,e){const i=this.minMaxValueAndSize.xy,o=this.minMaxValueAndSize.zw;return M(Pt(t),e,()=>{const s=t.subtract(i.x).divide(i.y.subtract(i.x)),r=ut(s,new a(0),new a(1));return o.x.add(r.multiply(o.y.subtract(o.x)))})}};n([h(w)],oe.prototype,"minMaxValueAndSize",void 0);let Xt=class extends E{getSizeForViewScale(t){return zt([ge(t,this.values.first()),this.sizes.first()],[Ie(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex(l=>U(l,t)),i=this.values.get(e),o=e.subtract(1),s=this.values.get(o),r=t.subtract(s).divide(i.subtract(s));return G(this.sizes.get(o),this.sizes.get(e),r)}])}};n([h(gt.ofType(a,8))],Xt.prototype,"sizes",void 0),n([h(gt.ofType(a,8))],Xt.prototype,"values",void 0);let Yt=class extends E{getSize(t,e){const i=zt([Pt(t),e],[ge(t,this.values.first()),this.sizes.first()],[Ie(t,this.values.last()),this.sizes.last()],[!0,()=>{const o=this.values.findIndex(p=>U(p,t)),s=this.values.get(o),r=o.subtract(1),l=this.values.get(r),u=t.subtract(l).divide(s.subtract(l));return G(this.sizes.get(r),this.sizes.get(o),u)}]);return M(Pt(i),e,i)}};n([h(gt.ofType(a,8))],Yt.prototype,"sizes",void 0),n([h(gt.ofType(a,8))],Yt.prototype,"values",void 0);let se=class extends E{getSize(t,e){return M(Pt(t),e,t.multiply(this.unitValueToPixelsRatio))}};n([h(a)],se.prototype,"unitValueToPixelsRatio",void 0);function xo(t){return t.visualVariableSizeMinMaxValue!=null||t.visualVariableSizeScaleStops!=null||t.visualVariableSizeStops!=null||t.visualVariableSizeUnitValue!=null}function Ve(t,e,i){if(xo(t)){const o=t.storage.getSizeValue(e);return t.visualVariableSizeMinMaxValue?.getSize(o,i)??t.visualVariableSizeScaleStops?.getSizeForViewScale(t.view.currentScale)??t.visualVariableSizeStops?.getSize(o,i)??t.visualVariableSizeUnitValue?.getSize(o,i)}return i}function ae(t,e,i,o=new be(!1)){if(t.visualVariableColor==null)return i;const s=t.storage.getColorValue(e);return t.visualVariableColor.getColor(s,i,o)}function re(t,e){if(t.visualVariableOpacity==null)return new a(1);const i=t.storage.getOpacityValue(e);return t.visualVariableOpacity.getOpacity(i)}function wo(t,e){if(t.visualVariableRotation==null)return L.identity();const i=t.storage.getRotationValue(e);return t.visualVariableRotation.getVVRotationMat3(i)}function ya(t,e){if(t.visualVariableRotation==null)return new a(0);const i=t.storage.getRotationValue(e);return t.visualVariableRotation.getNormalizedAngle(i)}let Wt=class extends ct{};n([y(3,f)],Wt.prototype,"offset",void 0),n([y(4,w)],Wt.prototype,"sizing",void 0),n([y(5,w)],Wt.prototype,"value1Position2Value2",void 0),n([y(6,w)],Wt.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),n([y(7,f)],Wt.prototype,"zoomRange",void 0),n([y(8,a)],Wt.prototype,"lineLength",void 0);let So=class extends xt{},ht=class extends ot{_vertexPreamble(t,e,i){const{id:o,offset:s,animationPointerAndBaseSizeAndReferenceSize:r,sizing:l}=t,u=r.xy,p=r.z,c=r.w,d=l.xy,m=this._getEvalParams(t,d,i);let v,b;if(t.value1Position2Value2){const z=rt(u,6,m).a,nt=t.pos,Ft=t.value1Position2Value2.yz,It=t.value1Position2Value2.x,cs=t.value1Position2Value2.w,hi=z.subtract(It).divide(cs.subtract(It));b=nt.add(Ft.subtract(nt).multiply(hi)),v=k(new a(1),hi).add(k(new a(0),Y(hi)))}else b=t.pos,v=new a(0);const g=l.z,x=W(t.bitset,bt.bitset.isStroke),V=l.w,S=W(t.bitset,bt.bitset.scaleSymbolsProportionally),_=rt(u,0,m),T=zt([lt(W(t.bitset,bt.bitset.isMapAligned),new a(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new a(0)]),H=new zs(Et(T),Bt(T.multiply(-1)),Bt(T),Et(T)).multiply(_.xy),D=_.z.subtract(T).subtract(e.multiply(Si)),O=_.w,F=W(t.bitset,bt.bitset.isSDF),I=Ve(this,o,new a(c)).divide(new a(c));return{baseSize:p,animationPointer:u,strokeWidth:g,isOutline:x,unscaledDistanceToPx:V,scaleSymbolsProportionally:S,isSDF:F,position:this._getScreenPosition({id:o,pos:b,offset:s,referenceSize:c,translation:H,rotation:D,scale:O,vvScale:I}),evalParams:m,vvScale:I,scale:O,clip:v}}_getScreenPosition(t){const{pos:e,translation:i,rotation:o,scale:s,offset:r,id:l,vvScale:u}=t,p=ya(this,l).multiply(Math.PI/180),c=i.x.multiply(4/3),d=i.y.multiply(-1).multiply(4/3),m=Bt(p),v=Et(p),b=v.multiply(c).add(Y(m).multiply(d)),g=m.multiply(c).add(v.multiply(d)),x=Bt(o.subtract(p)),V=Et(o.subtract(p)),S=new a(0),_=new a(1),{pixelRatio:T}=this.animationInfo,H=new L(_,S,S,S,_,S,b.multiply(T),g.multiply(T),_),D=new L(V,x.multiply(-1),S,x,V,S,0,0,_),O=s.multiply(u).multiply(T).multiply(4/3),F=D.multiply(O),I=this.animationInfo.toScreen.multiply(new R(e,1)),z=H.multiply(I).xy,nt=F.multiply(new R(r,0)).xy;return z.add(nt)}_clip(t,e){let i=super.clip(t,e);const o=ge(this._getLocalTimeOrigin(t),new a(0));return We.forceGlobalTimeOrigin||(i=i.add(zt([o,()=>new a(2)],[!0,()=>new a(0)]))),i}_getLocalTimeOrigin(t){return this.storage.getLocalTimeOrigin(t)}_toNdc(t){return this.animationInfo.toNdc.multiply(new R(t,1)).xy}_getEvalParams(t,e,i){const{globalTime:o,animationTextureSize:s,animationTexture:r}=this.animationInfo;return{globalTime:o,localTimeOrigin:this._getLocalTimeOrigin(t.id),animationTextureSize:s,animationTexture:r,pixelDimensions:e,lineLength:i}}_getColor(t,e){return M(lt(e.isSDF,new a(1)),this._getSDFColor(t,e),this._getSpriteColor(t,e))}_getSpriteColor(t,e){return B(this.mosaicInfo.texture,t).multiply(e.color)}_getSDFColor(t,e){const i=B(this.mosaicInfo.texture,t),o=new a(.5).subtract(Ee(i)).multiply(e.distanceToPx).multiply(oo),s=ut(new a(.5).subtract(o),new a(0),new a(1)),r=e.color.multiply(s),l=e.outlineSize.multiply(.5),u=xe(o).subtract(l),p=ut(new a(.5).subtract(u),new a(0),new a(1)),c=e.outlineColor.multiply(p);return new a(1).subtract(c.a).multiply(r).add(c)}};function rt(t,e,i){const o=t.add(new f(e,0)),s=B(i.animationTexture,o.add(.5).divide(i.animationTextureSize)).xy;return t=t.add(s),Vs({animationPointer:t,...i},w,null,r=>{const{out:l}=r;if(!l)throw new Error("out is null");return Os({...r,out:l})})}n([h(mt)],ht.prototype,"mosaicInfo",void 0),n([h(Ht)],ht.prototype,"animationInfo",void 0),n([h(Kt)],ht.prototype,"localTileOffset",void 0),n([C(Nt)],ht.prototype,"visualVariableColor",void 0),n([C(qt)],ht.prototype,"visualVariableOpacity",void 0),n([C(oe)],ht.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(Xt)],ht.prototype,"visualVariableSizeScaleStops",void 0),n([C(Yt)],ht.prototype,"visualVariableSizeStops",void 0),n([C(se)],ht.prototype,"visualVariableSizeUnitValue",void 0),n([C(Ge)],ht.prototype,"visualVariableRotation",void 0);let Pi=class extends Wt{};n([y(9,w)],Pi.prototype,"tlbr",void 0);let je=class extends ve{};n([y(13,f)],je.prototype,"nextPos1",void 0),n([y(14,f)],je.prototype,"nextPos2",void 0);let Vo=class extends So{},zo=class extends ht{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}_fragmentPoly(t){const e=fe(t.uv,new a(1)),i=G(t.tlbr.xy,t.tlbr.zw,e);return this._getColor(i,{color:t.color,distanceToPx:t.distanceToPx,isSDF:t.isSDF,outlineColor:t.outlineColor,outlineSize:t.strokeWidth})}_vertexPoly(t){const{position:e,animationPointer:i,evalParams:o,isOutline:s,unscaledDistanceToPx:r,vvScale:l,strokeWidth:u,scaleSymbolsProportionally:p,scale:c,isSDF:d,baseSize:m,clip:v}=this._vertexPreamble(t,new a(0),t.lineLength||new a(0)),b=this._toNdc(e);let g=rt(i,1,o);g=new w(g.rgb.multiply(g.a),g.a);let x=rt(i,2,o);x=new w(x.rgb.multiply(x.a),x.a);let V=rt(i,3,o);V=new w(V.rgb.multiply(V.a),V.a);const S=rt(i,4,o).a,_=rt(i,5,o).a,T=ae(this,t.id,g,gi(ie(t.bitset,bt.bitset.colorLocked),new be(s))),H=G(T,x,V),D=re(this,t.id),O=G(D,S,_),F=H.multiply(O),I=this.clip(t.id,t.zoomRange).add(v.multiply(2)),z=r.multiply(l);return{unscaledDistanceToPx:r,vvScale:l,strokeWidth:u,scaleSymbolsProportionally:p,scale:c,isSDF:d,baseSize:m,ndc:b,color:F,z:I,isOutline:s,evalParams:o,distanceToPx:z}}};function fa(t,e){return $t(t,As(e))}function Qt(t,e,i){const o=i.subtract(e),s=fa(t.subtract(e),o),r=ut(s.divide(Zt(o)),new a(0),new a(1));return Le(t,e.add(r.multiply(i.subtract(e))))}function Z(t){const e=xe(t);return k(e.x.add(e.y).add(e.z),new a(1.05))}function $(t,e,i,o){const s=new L(i.x.multiply(o.y).subtract(o.x.multiply(i.y)),o.x.multiply(e.y).subtract(e.x.multiply(o.y)),e.x.multiply(i.y).subtract(i.x.multiply(e.y)),i.y.subtract(o.y),o.y.subtract(e.y),e.y.subtract(i.y),o.x.subtract(i.x),e.x.subtract(o.x),i.x.subtract(e.x)),r=e.x.multiply(i.y.subtract(o.y)),l=i.x.multiply(o.y.subtract(e.y)),u=o.x.multiply(e.y.subtract(i.y)),p=r.add(l).add(u);return new a(1).divide(p).multiply(s.multiply(new R(1,t)))}function va(t,e,i,o){return lt(Z($(t,e,i,o)),new a(1))}function Ze(t,e,i,o){const s=i.subtract(e),r=o.subtract(e),l=Ns(s,r),u=Gi(bi(l,new a(so)),U(l,new a(-so)));return zt([Gi(Ps(u),va(t.xy,e,i,o)),new a(-1)],[!0,()=>{const p=Qt(t,e,i),c=Qt(t,i,o),d=Qt(t,o,e);return Ut(Ut(p,c),d)}])}function ne(t){return t.distance.add(1)}function $e(t,e,i){const{viewMat3:o,tileMat3:s}=t.view,r=o.multiply(s),l=r.multiply(new R(e.pos,1)),u=r.multiply(new R(i.nextPos1,1)),p=r.multiply(new R(i.nextPos2,1));return Ze(t.hittestRequest.position,l.xy,u.xy,p.xy)}function ga(t,e,i){return Le(t,i).subtract(e)}let le=class extends ct{};n([y(3,w)],le.prototype,"color",void 0),n([y(4,f)],le.prototype,"zoomRange",void 0);let At=class extends ot{constructor(){super(...arguments),this.type="FillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const i=re(this,t.id),o=ae(this,t.id,t.color).multiply(i),s=this.view.displayViewScreenMat3.multiply(new R(t.pos.xy,1)),r=this.clip(t.id,t.zoomRange);return{glPosition:new w(s.xy,r,1),color:o,...this.maybeRunHittest(t,e,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new a(0))}hittest(t,e){return $e(this,t,e)}};n([C(Nt)],At.prototype,"visualVariableColor",void 0),n([C(qt)],At.prototype,"visualVariableOpacity",void 0),n([P(0,A(le)),P(1,A(dt))],At.prototype,"vertex",null),n([P(0,A(xt))],At.prototype,"fragment",null);let Jt=class extends le{};n([y(5,w)],Jt.prototype,"tlbr",void 0),n([y(6,a)],Jt.prototype,"width",void 0),n([y(7,a)],Jt.prototype,"height",void 0),n([y(8,f)],Jt.prototype,"offset",void 0),n([y(9,f)],Jt.prototype,"scale",void 0),n([y(10,a)],Jt.prototype,"angle",void 0);let ba=class extends xt{};function Po(t,e,i,o,s){const r=lt(W(s,Ws),vt(1)),l=Ee(new w(t,0));return M(r,ji(o.divide(e.x),i.divide(e.y),0,Y(i.divide(e.x)),o.divide(e.y),0,to(Zi(l,0)),to(Zi(0,l)),1),ji(o.divide(e.x),i.divide(e.y),0,Y(i.divide(e.x)),o.divide(e.y),0,0,0,1))}function Ao(t,e){const i=t.view.requiredZoomFactor,o=new f(e.width,e.height),s=o.multiply(e.scale).multiply(i),r=e.angle.multiply(Si),l=Bt(r),u=Et(r),p=Po(e.id,s,l,u,e.bitset),c=t.localTileOffset.getPatternOffsetAtTileOrigin(o,l,u),d=i.multiply(e.scale).multiply(e.offset.subtract(c)).divide(s),m=new R(e.pos,1),v=p.multiply(m).xy.subtract(d),b=e.tlbr.divide(t.mosaicInfo.size.xyxy);let g=W(e.bitset,ao);return t.visualVariableColor!=null&&(g=M(Pt(t.storage.getColorValue(e.id)),new a(0),g)),{tileTextureCoord:v,tlbr:b,sampleAlphaOnly:g}}function _o(t,e){const i=fe(e.tileTextureCoord,new a(1)),o=G(e.tlbr.xy,e.tlbr.zw,i);let s=B(t.mosaicInfo.texture,o);return s=M(U(e.sampleAlphaOnly,new a(.5)),s.aaaa,s),e.color.multiply(s)}let ze=class extends At{constructor(){super(...arguments),this.type="ComplexFillShader"}vertex(t,e){return{...super.vertex(t,e),...Ao(this,t)}}fragment(t){const e=_o(this,t);return this.getFragmentOutput(e,t,new a(0))}};n([h(mt)],ze.prototype,"mosaicInfo",void 0),n([h(Kt)],ze.prototype,"localTileOffset",void 0),n([P(0,A(Jt)),P(1,A(dt))],ze.prototype,"vertex",null),n([P(0,A(ba))],ze.prototype,"fragment",null);let Ai=class extends zo{constructor(){super(...arguments),this.type="AnimatedFillShader"}vertex(t,e){const{distanceToPx:i,ndc:o,z:s,color:r,isOutline:l,strokeWidth:u,isSDF:p,scale:c,scaleSymbolsProportionally:d}=this._vertexPoly(t),m=this.view.requiredZoomFactor,v=t.sizing.xy,b=v.multiply(m),g=new a(0),x=Bt(g),V=Et(g),S=Po(t.id,b,x,V,t.bitset),_=this.localTileOffset.getPatternOffsetAtTileOrigin(v,x,V),T=m.multiply(t.offset.subtract(_)).divide(b),H=new R(t.pos,1),D=S.multiply(H).xy.subtract(T),O=t.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new w(o,s,1),tlbr:O,uv:D,color:r.multiply(new a(1).subtract(l)),outlineColor:r.multiply(l),distanceToPx:i,strokeWidth:u.multiply(G(new a(1),c,d)),isOutline:l,isSDF:p,...this.maybeRunHittest(t,e,{})}}fragment(t){const e=this._fragmentPoly(t);return this.getFragmentOutput(e,t)}hittest(t,e,i){return $e(this,t,e)}};n([P(0,A(Pi)),P(1,A(je))],Ai.prototype,"vertex",null),n([P(0,A(Vo))],Ai.prototype,"fragment",null);let _t=class extends ct{};n([y(3,w)],_t.prototype,"color",void 0),n([y(4,f)],_t.prototype,"offset",void 0),n([y(5,f)],_t.prototype,"normal",void 0),n([y(6,a)],_t.prototype,"halfWidth",void 0),n([y(7,a)],_t.prototype,"referenceHalfWidth",void 0),n([y(8,f)],_t.prototype,"zoomRange",void 0);let Ro=class extends xt{},Pe=class extends E{};function _i(t){return pt(new a(Gs).multiply(k(t,new a(js))),new a(1))}function Ke(t,e){const{halfWidth:i,normal:o}=t,s=_i(i),r=Zt(o).multiply(i);return ut(s.multiply(i.subtract(r)).divide(e.add(s).subtract(new a(1))),new a(0),new a(1))}function xa(t,e){const{id:i,halfWidth:o,referenceHalfWidth:s}=e;if(xo(t)){const r=new a(2).multiply(s),l=Ve(t,i,r);return new a(.5).multiply(o.divide(pt(s,new a(Zs)))).multiply(l)}return o}function Xe(t,e){const{id:i,offset:o,pos:s,normal:r,zoomRange:l}=e,{displayViewScreenMat3:u,displayViewMat3:p}=t.view,c=ae(t,i,e.color),d=re(t,i),m=xa(t,e),v=new a(.5).multiply(t.antialiasingControls.antialiasing),b=pt(m.add(v),new a(.45)).add(new a(.1).multiply(v)),g=_i(b).multiply(b).multiply(o),x=p.multiply(new R(g,new a(0))),V=u.multiply(new R(s,new a(1))).add(x),S=new a(2).multiply(k(m,new a(0))).add(t.clip(i,l)),_=new w(V.xy,S,1);return{color:c,opacity:d,halfWidth:b,normal:r,scaledOffset:g,scaledHalfWidth:m,glPosition:new w(_.xy,S,1)}}function Ye(t,e){const{opacity:i,color:o}=t,s=Ke(t,e);return i.multiply(o).multiply(s)}n([h(a)],Pe.prototype,"antialiasing",void 0),n([h(a)],Pe.prototype,"blur",void 0);class yt extends ot{constructor(){super(...arguments),this.type="LineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(e,i){const o=Xe(this,e);return{...o,...this.maybeRunHittest(e,i,o.halfWidth)}}fragment(e){const i=Ye(e,this.antialiasingControls.blur);return this.getFragmentOutput(i,e)}hittest(e,i,o){const{viewMat3:s,tileMat3:r}=this.view,l=s.multiply(r),u=l.multiply(new R(e.pos,1)),p=l.multiply(new R(i.nextPos1,1)),c=l.multiply(new R(i.nextPos2,1)),{distance:d,smallSymbolDistance:m,smallSymbolSizeThreshold:v}=this.hittestRequest,b=k(o,v.multiply(.5)).multiply(d.subtract(m)),g=this.hittestRequest.position;return Ut(Qt(g,u.xy,p.xy),Qt(g,u.xy,c.xy)).subtract(o).add(b)}}n([h(Pe)],yt.prototype,"antialiasingControls",void 0),n([C(Nt)],yt.prototype,"visualVariableColor",void 0),n([C(qt)],yt.prototype,"visualVariableOpacity",void 0),n([C(oe)],yt.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(Xt)],yt.prototype,"visualVariableSizeScaleStops",void 0),n([C(Yt)],yt.prototype,"visualVariableSizeStops",void 0),n([C(se)],yt.prototype,"visualVariableSizeUnitValue",void 0),n([P(0,A(_t)),P(1,A(dt))],yt.prototype,"vertex",null),n([P(0,A(Ro))],yt.prototype,"fragment",null);let Qe=class extends Pi{};n([y(10,a)],Qe.prototype,"accumulatedDistance",void 0),n([y(11,f)],Qe.prototype,"normal",void 0),n([y(12,f)],Qe.prototype,"segmentDirection",void 0);let wa=class extends Vo{},Je=class extends zo{constructor(){super(...arguments),this.type="AnimatedLineShader"}vertex(t,e){const{animationPointerAndBaseSizeAndReferenceSize:i}=t,o=i.xy,{distanceToPx:s,ndc:r,z:l,color:u,isOutline:p,strokeWidth:c,isSDF:d,baseSize:m,scale:v,scaleSymbolsProportionally:b,evalParams:g}=this._vertexPoly(t),x=t.sizing.xy,V=x.x.multiply(m).divide(x.y),S=rt(o,6,g).a,_=t.accumulatedDistance.subtract(S),{normal:T}=t,H=t.normal.y,D=_.divide(this.view.displayZoomFactor).add($t(t.segmentDirection,t.offset)).divide(V),O=H.add(1).divide(2),F=new f(D,O),I=t.tlbr.divide(this.mosaicInfo.size.xyxy),z=m.divide(2),nt=new a(.5).multiply(this.antialiasingControls.antialiasing),Ft=pt(z.add(nt),new a(.45)).add(new a(.1).multiply(nt));return{glPosition:new w(r,l,1),tlbr:I,uv:F,color:u.multiply(new a(1).subtract(p)),outlineColor:u.multiply(p),distanceToPx:s,strokeWidth:c.multiply(G(new a(1),v,b)),isOutline:p,isSDF:d,halfWidth:Ft,normal:T,...this.maybeRunHittest(t,e,Ft)}}fragment(t){const e=this._fragmentPoly(t),i=Ke(t,this.antialiasingControls.blur),{halfWidth:o,normal:s}=t,r=_i(o),l=Zt(s).multiply(o),u=ut(r.multiply(o.subtract(l)).divide(r.subtract(new a(1))),new a(0),new a(1));return this.getFragmentOutput(e.multiply(u).multiply(i),t)}hittest(t,e,i){const{viewMat3:o,tileMat3:s}=this.view,r=o.multiply(s),l=r.multiply(new R(t.pos,1)),u=r.multiply(new R(e.nextPos1,1)),p=r.multiply(new R(e.nextPos2,1)),{distance:c,smallSymbolDistance:d,smallSymbolSizeThreshold:m}=this.hittestRequest,v=k(i,m.multiply(.5)).multiply(c.subtract(d)),b=this.hittestRequest.position;return Ut(Qt(b,l.xy,u.xy),Qt(b,l.xy,p.xy)).subtract(i).add(v)}};n([h(Pe)],Je.prototype,"antialiasingControls",void 0),n([P(0,A(Qe)),P(1,A(je))],Je.prototype,"vertex",null),n([P(0,A(wa))],Je.prototype,"fragment",null);let Ri=class extends Wt{};n([y(9,f)],Ri.prototype,"uv",void 0),n([y(10,a)],Ri.prototype,"angle",void 0);let Ae=class extends ve{};n([y(11,f)],Ae.prototype,"offsetNextVertex1",void 0),n([y(12,f)],Ae.prototype,"offsetNextVertex2",void 0),n([y(13,f)],Ae.prototype,"textureUVNextVertex1",void 0),n([y(14,f)],Ae.prototype,"textureUVNextVertex2",void 0);let Sa=class extends So{};function Rt(t,e,i,o){return e.multiply(t.x).add(i.multiply(t.y)).add(o.multiply(t.z))}class ti extends ht{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,i){const o=e.uv.divide(this.mosaicInfo.size),{position:s,animationPointer:r,evalParams:l,isOutline:u,unscaledDistanceToPx:p,vvScale:c,strokeWidth:d,scaleSymbolsProportionally:m,scale:v,isSDF:b,baseSize:g,clip:x}=this._vertexPreamble(e,e.angle,e.lineLength||new a(0)),V=this._toNdc(s);let S=rt(r,1,l);S=new w(S.rgb.multiply(S.a),S.a);let _=rt(r,2,l);_=new w(_.rgb.multiply(_.a),_.a);let T=rt(r,3,l);T=new w(T.rgb.multiply(T.a),T.a);const H=rt(r,4,l).a,D=rt(r,5,l).a,O=ae(this,e.id,S,gi(ie(e.bitset,bt.bitset.colorLocked),new be(u))),F=G(O,_,T),I=re(this,e.id),z=G(I,H,D),nt=F.multiply(z),Ft=this.clip(e.id,e.zoomRange).add(x.multiply(2)),It=p.multiply(c);return{glPosition:new w(V,Ft,1),uv:o,color:nt.multiply(new a(1).subtract(u)),outlineColor:nt.multiply(u),distanceToPx:It,strokeWidth:d.multiply(G(new a(1),v,m)),isOutline:u,isSDF:b,...this.maybeRunHittest(e,i,{pos:e.pos,size:g,sizeCorrection:new a(1),isMapAligned:new a(1),vvRotationMat3:new L(1,0,0,0,1,0,0,0,1),placementMat3:new L(1,0,0,0,1,0,0,0,1),outlineSize:new a(1),distanceToPx:It,isSDF:b})}}fragment(e){let i=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return We.spotlightAnimatedSymbols&&(i=i.add(new w(0,.3,0,.3))),this.getFragmentOutput(i,e)}hittest(e,i,o){return M(bi(o.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,i,o),this._hittestMarker(e,i,o))}_hittestSmallMarker(e,i,o){const{position:s,distance:r,smallSymbolDistance:l}=this.hittestRequest,u=r.subtract(l),{viewMat3:p,tileMat3:c}=this.view,d=p.multiply(c).multiply(new R(o.pos,1)).xy,m=o.size.multiply(.5);return Le(d,s).subtract(m).add(u)}_hittestMarker(e,i,o){const s=this._vertexPreamble({...e},e.angle,new a(0)).position,r=this._vertexPreamble({...e,offset:i.offsetNextVertex1},e.angle,new a(0)).position,l=this._vertexPreamble({...e,offset:i.offsetNextVertex2},e.angle,new a(0)).position,u=this.hittestRequest.position,p=this.hittestRequest.distance,c=Ze(u,s,r,l);return M(U(c,p),c,this._hittestSamples(s,r,l,e,i,o))}_hittestSamples(e,i,o,s,r,l){const{outlineSize:u,isSDF:p,distanceToPx:c}=l,d=this.hittestRequest.position,m=this.hittestRequest.distance,v=$(d.add(new f(Y(m),Y(m))),e,i,o),b=$(d.add(new f(0,Y(m))),e,i,o),g=$(d.add(new f(m,Y(m))),e,i,o),x=$(d.add(new f(Y(m),0)),e,i,o),V=$(d,e,i,o),S=$(d.add(new f(m,0)),e,i,o),_=$(d.add(new f(Y(m),m)),e,i,o),T=$(d.add(new f(0,m)),e,i,o),H=$(d.add(new f(m,m)),e,i,o),D=s.uv.divide(this.mosaicInfo.size),O=r.textureUVNextVertex1.divide(this.mosaicInfo.size),F=r.textureUVNextVertex2.divide(this.mosaicInfo.size),I={color:new w(1,1,1,1),outlineSize:u,outlineColor:new w(1,1,1,1),isSDF:p,distanceToPx:c};let z=new a(0);return z=z.add(Z(v).multiply(this._getColor(Rt(v,D,O,F),I).a)),z=z.add(Z(b).multiply(this._getColor(Rt(b,D,O,F),I).a)),z=z.add(Z(g).multiply(this._getColor(Rt(g,D,O,F),I).a)),z=z.add(Z(x).multiply(this._getColor(Rt(x,D,O,F),I).a)),z=z.add(Z(V).multiply(this._getColor(Rt(V,D,O,F),I).a)),z=z.add(Z(S).multiply(this._getColor(Rt(S,D,O,F),I).a)),z=z.add(Z(_).multiply(this._getColor(Rt(_,D,O,F),I).a)),z=z.add(Z(T).multiply(this._getColor(Rt(T,D,O,F),I).a)),z=z.add(Z(H).multiply(this._getColor(Rt(H,D,O,F),I).a)),k(z,new a(.05)).multiply(ne(this.hittestRequest))}}n([P(0,A(Ri)),P(1,A(Ae))],ti.prototype,"vertex",null),n([P(0,A(Sa))],ti.prototype,"fragment",null);let J=class extends _s{constructor(){super(...arguments),this.symbologyPlane=0,this._input=null}};function te(t){const e=1/t;return{antialiasing:e,blur:0+e}}let ei=class extends J{render(t,e){const{context:i,painter:o,pixelRatio:s}=t,{target:r}=e,{freezeGlobalTime:l}=We,u=0,p=o.textureManager.animationStore.getTexture(i,u),c=[2/t.state.size[0],0,0,0,-2/t.state.size[1],0,-1,1,1],d=Array.from(ys(lo(),c)),m=Array.from(fs(lo(),d,r.transforms.displayViewScreenMat3)),v=e.instance.getInput(),b=o.textureManager.getMosaicInfo(t,e.textureKey,!1),{optionalAttributes:g}=v,x=g.zoomRange,V=g.value1Position2Value2,S="accumulatedDistance"in g&&g.accumulatedDistance,_="segmentDirection"in g&&g.segmentDirection,T="normal"in g&&g.normal;o.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,v.uniforms),...X(t,e.target),antialiasingControls:te(s),mosaicInfo:b,animationInfo:{globalTime:t.animationsEnabled?l===!1?t.time/1e3:l:0,animationTextureSize:[p.descriptor.width,p.descriptor.height],animationTexture:{unit:6,texture:p},toScreen:m,toNdc:c,mapRotation:t.state.rotation,pixelRatio:t.state.pixelRatio},localTileOffset:we(e.target)},defines:{...j(t)},optionalAttributes:{zoomRange:x,value1Position2Value2:V,accumulatedDistance:S,segmentDirection:_,normal:T},useComputeBuffer:q(t)}),o.setPipelineState({...Q(t)}),o.submitDraw(t,e),l===!1&&t.animationsEnabled&&r.requestRender()}},Va=class extends ei{constructor(){super(...arguments),this.type=2,this.symbologyPlane=2,this.shaders={geometry:new ti}}},za=class extends ei{constructor(){super(...arguments),this.type=3,this.symbologyPlane=2,this.shaders={geometry:new ti}}},Pa=class extends ei{constructor(){super(...arguments),this.type=0,this.symbologyPlane=0,this.shaders={geometry:new Ai}}},Aa=class extends ei{constructor(){super(...arguments),this.type=1,this.symbologyPlane=1,this.shaders={geometry:new Je}}},Mo=class extends fi{};n([y(0,f)],Mo.prototype,"pos",void 0);let _a=class extends xt{},To=class extends E{};n([h(a)],To.prototype,"dotSize",void 0);let ii=class extends E{};n([h(N)],ii.prototype,"locations",void 0),n([h(a)],ii.prototype,"pixelRatio",void 0),n([h(a)],ii.prototype,"tileZoomFactor",void 0);const Ra=1e-6;let ue=class extends yi{constructor(){super(...arguments),this.type="DotDensityPointShader"}vertex(t){const e=new L(1,0,0,0,-1,0,0,1,1).multiply(new R(t.pos.xy.divide(at),1)),i=B(this.draw.locations,e.xy),o=pt(this.instance.dotSize.divide(2),new a(1));let s=new a(0);s=s.add(k(i.a,new a(Ra)).multiply(2));let r=o.add(this.instance.dotSize);const l=this.view.displayViewScreenMat3.multiply(new R(t.pos.add(.5),1)),u=new w(l.xy,s,1),p=this.instance.dotSize.divide(r),c=new a(-1).divide(o.divide(r));return r=r.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:r,color:i,ratio:p,invEdgeRatio:c}}fragment(t){const e=Zt(t.glPointCoord.subtract(.5)).multiply(2),i=$i(new a(0),new a(1),t.invEdgeRatio.multiply(e.subtract(t.ratio)).add(1)),o=new Fe;return o.fragColor=t.color.multiply(i),o}};n([h(To)],ue.prototype,"instance",void 0),n([h(ii)],ue.prototype,"draw",void 0),n([h(et)],ue.prototype,"view",void 0),n([P(0,A(Mo))],ue.prototype,"vertex",null),n([P(0,A(_a))],ue.prototype,"fragment",null);let Co=class extends ct{};n([y(3,a)],Co.prototype,"inverseArea",void 0);let oi=class extends E{};n([h(gt.ofType(w,2))],oi.prototype,"isActive",void 0),n([h(gt.ofType(w,8))],oi.prototype,"colors",void 0),n([h(a)],oi.prototype,"dotValue",void 0);let pe=class extends E{};n([h(N)],pe.prototype,"dotTexture0",void 0),n([h(N)],pe.prototype,"dotTexture1",void 0),n([h(a)],pe.prototype,"tileZoomFactor",void 0),n([h(a)],pe.prototype,"pixelRatio",void 0),n([h(a)],pe.prototype,"tileDotsOverArea",void 0);let ce=class extends ot{constructor(){super(...arguments),this.type="DotDensityPolygonShader"}_dotThreshold(t,e,i){return t.divide(e).divide(i)}vertex(t){const e=new L(2/at,0,0,0,-2/at,0,-1,1,1).multiply(new R(t.pos,1)),i=this.clip(t.id),o=new w(e.xy,i,1),s=this.storage.getVVData(t.id).multiply(this.instance.isActive.get(0)).multiply(t.inverseArea),r=this.storage.getDataDrivenData0(t.id).multiply(this.instance.isActive.get(1)).multiply(t.inverseArea),l=this.draw.tileZoomFactor.multiply(at).divide(this.draw.pixelRatio),u=this._dotThreshold(s,this.instance.dotValue,this.draw.tileDotsOverArea),p=this._dotThreshold(r,this.instance.dotValue,this.draw.tileDotsOverArea),c=t.pos.add(.5).divide(l);return{glPosition:o,color:new w(0,0,0,0),textureCoords:c,thresholds0:u,thresholds1:p}}fragment(t){const e=new Fe,i=B(this.draw.dotTexture0,t.textureCoords),o=B(this.draw.dotTexture1,t.textureCoords),s=t.thresholds0.subtract(i),r=t.thresholds1.subtract(o);let l;const u=ke.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),p=ke.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const c=k(new a(0),s),d=k(new a(0),r),m=$t(c,s).add($t(d,r)),v=k(m,new a(0)),b=new a(1).subtract(v),g=m.add(v),x=s.multiply(c).divide(g),V=r.multiply(d).divide(g),S=u.multiply(x).add(p.multiply(V));l=b.multiply(S)}else{const c=pt(eo(s),eo(r)),d=k(c,new a(0)),m=new a(1).subtract(d),v=k(c,s),b=k(c,r),g=u.multiply(v).add(p.multiply(b));l=m.multiply(g)}return e.fragColor=l,e}hittest(t){return ne(this.hittestRequest)}};n([Lt],ce.prototype,"blending",void 0),n([h(oi)],ce.prototype,"instance",void 0),n([h(pe)],ce.prototype,"draw",void 0),n([P(0,A(Co))],ce.prototype,"vertex",null),n([P(0,A(xt))],ce.prototype,"fragment",null);const Ma={pos:{count:2,type:St.UNSIGNED_SHORT}};let Ta=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(t){if(this._dotFBO==null){const e=at,i=at,o=new Ne(e,i);o.samplingMode=9728,o.wrapMode=33071;const s=new sa(t,new ho(co.DEPTH24_STENCIL8,e,i));this._dotFBO=new yo(t,o,s)}return this._dotFBO}getDotDensityMesh(t){if(this._dotMesh==null){const e=at,i=e*e,o=2,s=new Int16Array(i*o);for(let r=0;r<e;r++)for(let l=0;l<e;l++)s[o*(l+r*e)]=l,s[o*(l+r*e)+1]=r;this._dotMesh=bo.create(t,{primitive:po.POINTS,vertex:s,count:i,layout:Ma})}return this._dotMesh}getDotDensityTextures(t,e,i){if(this._dotTextureSize===e&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=e,this._seed=i),this._dotTextures===null){const o=new vs(i);this._dotTextures=[this._allocDotDensityTexture(t,e,o),this._allocDotDensityTexture(t,e,o)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let t=0;t<this._dotTextures.length;t++)this._dotTextures[t].dispose();this._dotTextures=null}}_allocDotDensityTexture(t,e,i){const o=new Float32Array(e*e*4);for(let r=0;r<o.length;r++)o[r]=i.getFloat();const s=new Ne(e);return s.dataType=He.FLOAT,s.samplingMode=9728,new fo(t,s,o)}},Ca=class extends J{constructor(){super(...arguments),this.type=11,this.shaders={polygon:new ce,point:new ue,fill:new At},this._resources=new Map}render(t,e){uo(t)||q(t)?this._renderPolygons(t,e):this._renderDotDensity(t,e)}_renderPolygons(t,e){const{painter:i}=t;i.setShader({shader:this.shaders.fill,uniforms:{...X(t,e.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...j(t)},optionalAttributes:{zoomRange:!1},useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}_renderDotDensity(t,e){const{context:i,painter:o,requiredLevel:s}=t,r=e.instance.getInput().uniforms,l=this._getOrCreateResourcesRecord(i),u=l.getDotDensityTextures(i,at,r.seed),p=1/2**(s-e.target.key.level),c=at,d=c*window.devicePixelRatio*c*window.devicePixelRatio,m=1/p*(1/p),v=r.dotScale?t.state.scale/r.dotScale:1,b=r.dotValue*v*m;o.setShader({shader:this.shaders.polygon,uniforms:{...X(t,e.target),instance:{isActive:r.isActive,colors:r.colors,dotValue:Math.max(1,b)},draw:{dotTexture0:{unit:Qi,texture:u[0]},dotTexture1:{unit:ks,texture:u[1]},tileZoomFactor:p,pixelRatio:window.devicePixelRatio,tileDotsOverArea:d/(at*window.devicePixelRatio*at*window.devicePixelRatio)}},defines:{...j(t),blending:r.blending},optionalAttributes:{},useComputeBuffer:!1});const g=i.getViewport();i.setViewport(0,0,at,at);const x=i.getBoundFramebufferObject(),V=l.getFBO(i);i.bindFramebuffer(V),i.setClearColor(0,0,0,0),i.clear(16384),o.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),o.updatePipelineState(i),o.submitDraw(t,e),i.bindFramebuffer(x),i.setViewport(g.x,g.y,g.width,g.height);const S=l.getFBO(i).colorTexture,_={shader:this.shaders.point,uniforms:{view:ia(t,e.target),instance:{dotSize:r.dotSize},draw:{locations:{unit:Qi,texture:S},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...j(t)},optionalAttributes:{},useComputeBuffer:!1};o.setPipelineState(Q(t)),o.submitDrawMesh(i,_,l.getDotDensityMesh(i),{stencilRef:e.getStencilReference()})}shutdown(t){super.shutdown(t),this._resources.get(t)?.destroy(),this._resources.delete(t)}_getOrCreateResourcesRecord(t){let e=this._resources.get(t);return e==null&&(e=new Ta,this._resources.set(t,e)),e}},Da=class extends J{constructor(){super(...arguments),this.type=9,this.shaders={geometry:new ze}}render(t,e){const{painter:i}=t,o=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,o.uniforms),...X(t,e.target),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey),localTileOffset:we(e.target)},defines:{...j(t)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},Gt=class extends ct{};n([y(3,f)],Gt.prototype,"offset",void 0),n([y(4,w)],Gt.prototype,"color",void 0),n([y(5,f)],Gt.prototype,"normal",void 0),n([y(6,a)],Gt.prototype,"halfWidth",void 0),n([y(7,a)],Gt.prototype,"referenceHalfWidth",void 0),n([y(8,f)],Gt.prototype,"zoomRange",void 0);let Do=class extends Ro{};function Mi(t,e,i){const{id:o,bitset:s}=e,r=W(s,$s),l=U(r,new a(.5)),u=Xe(t,e),p=M(l,u.halfWidth,new a(0)),c=re(t,o),d=ae(t,o,e.color),m=M(l,M(ie(s,Ks),d,e.color),d.multiply(c)),v=t.view.displayViewScreenMat3.multiply(new R(e.pos.xy,1)),b=t.clip(e.id),g=new w(v.xy,b,1),x=M(l,u.glPosition,g),V=i&&t.maybeRunHittest(e,i,l);return{isOutline:r,color:m,opacity:new a(1),halfWidth:p,normal:u.normal,glPosition:x,...V}}class Mt extends ot{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}}n([h(Pe)],Mt.prototype,"antialiasingControls",void 0),n([C(Nt)],Mt.prototype,"visualVariableColor",void 0),n([C(qt)],Mt.prototype,"visualVariableOpacity",void 0),n([C(oe)],Mt.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(Xt)],Mt.prototype,"visualVariableSizeScaleStops",void 0),n([C(Yt)],Mt.prototype,"visualVariableSizeStops",void 0),n([C(se)],Mt.prototype,"visualVariableSizeUnitValue",void 0);let si=class extends Mt{constructor(){super(...arguments),this.type="OutlineFillShader"}vertex(t,e){return Mi(this,t,e)}fragment(t){const{color:e,isOutline:i}=t,o=U(i,new a(.5)),s=Ye(t,this.antialiasingControls.blur),r=M(o,s,e),l=M(o,new a(1/255),new a(0));return this.getFragmentOutput(r,t,l)}hittest(t,e,i){return M(i,ne(this.hittestRequest),$e(this,t,e))}};n([P(0,A(Gt)),P(1,A(dt))],si.prototype,"vertex",null),n([P(0,A(Do))],si.prototype,"fragment",null);let Ti=class extends le{};n([y(5,w)],Ti.prototype,"tlbr",void 0),n([y(6,a)],Ti.prototype,"inverseRasterizationScale",void 0);let Oa=class extends xt{};function Fa(t){const e=new a(1),i=new a(0);return new L(e.divide(t.x),i.divide(t.y),0,Y(i.divide(t.x)),e.divide(t.y),0,0,0,1)}function Oo(t,e){const i=e.tlbr.xy,o=e.tlbr.zw,s=o.x.subtract(i.x),r=i.y.subtract(o.y),l=new f(s,r).multiply(e.inverseRasterizationScale),u=l.multiply(t.view.requiredZoomFactor),p=Fa(u),c=t.localTileOffset.getPatternOffsetAtTileOrigin(l).divide(u),d=new R(e.pos,1);return{tileTextureCoord:p.multiply(d).xy.subtract(c),tlbr:e.tlbr.divide(t.mosaicInfo.size.xyxy)}}function Fo(t,e){const i=fe(t.tileTextureCoord,new a(1)),o=G(t.tlbr.xy,t.tlbr.zw,i),s=B(e.texture,o);return t.color.multiply(s)}class _e extends At{constructor(){super(...arguments),this.type="PatternFillShader"}vertex(e,i){return{...super.vertex(e,i),...Oo(this,e)}}fragment(e){const i=Fo(e,this.mosaicInfo);return this.getFragmentOutput(i,e,new a(0))}}n([h(mt)],_e.prototype,"mosaicInfo",void 0),n([h(Kt)],_e.prototype,"localTileOffset",void 0),n([P(0,A(Ti)),P(1,A(dt))],_e.prototype,"vertex",null),n([P(0,A(Oa))],_e.prototype,"fragment",null);let Ci=class extends Gt{};n([y(9,w)],Ci.prototype,"tlbr",void 0),n([y(10,a)],Ci.prototype,"inverseRasterizationScale",void 0);let Io=class extends Do{},Re=class extends si{constructor(){super(...arguments),this.type="PatternOutlineFillShader"}vertex(t,e){return{...Mi(this,t,e),...Oo(this,t)}}fragment(t){const{isOutline:e}=t,i=U(e,new a(.5)),o=Ye(t,this.antialiasingControls.blur),s=Fo(t,this.mosaicInfo),r=M(i,o,s),l=M(i,new a(1/255),new a(0));return this.getFragmentOutput(r,t,l)}};n([h(mt)],Re.prototype,"mosaicInfo",void 0),n([h(Kt)],Re.prototype,"localTileOffset",void 0),n([P(0,A(Ci)),P(1,A(dt))],Re.prototype,"vertex",null),n([P(0,A(Io))],Re.prototype,"fragment",null);const ko=1/Ys;let Tt=class extends ct{};n([y(3,w)],Tt.prototype,"color",void 0),n([y(4,w)],Tt.prototype,"tlbr",void 0),n([y(5,a)],Tt.prototype,"angle",void 0),n([y(6,a)],Tt.prototype,"aux1",void 0),n([y(7,a)],Tt.prototype,"aux2",void 0),n([y(8,f)],Tt.prototype,"aux3",void 0),n([y(9,f)],Tt.prototype,"aux4",void 0),n([y(10,f)],Tt.prototype,"zoomRange",void 0);let Ia=class extends Io{},Me=class extends Mt{constructor(){super(...arguments),this.type="ComplexOutlineFillShader"}vertex(t,e){const{aux1:i,aux2:o,aux3:s,aux4:r}=t,l={...t,width:i,height:o,offset:s,scale:r.multiply(ko)},u={...t,halfWidth:i,referenceHalfWidth:o,offset:s,normal:r.subtract(Xs).multiply(ko)},p=Mi(this,u),c=Ao(this,l),d=U(p.isOutline,new a(.5));return{...p,...c,...Object.assign({},this.maybeRunHittest(t,e,d))}}fragment(t){const{isOutline:e}=t,i=U(e,new a(.5)),o=Ye(t,this.antialiasingControls.blur),s=_o(this,t),r=M(i,o,s),l=M(i,new a(1/255),new a(0));return this.getFragmentOutput(r,t,l)}hittest(t,e,i){return M(i,ne(this.hittestRequest),$e(this,t,e))}};n([h(mt)],Me.prototype,"mosaicInfo",void 0),n([h(Kt)],Me.prototype,"localTileOffset",void 0),n([P(0,A(Tt)),P(1,A(dt))],Me.prototype,"vertex",null),n([P(0,A(Ia))],Me.prototype,"fragment",null);let ka=class extends J{constructor(){super(...arguments),this.type=10,this.shaders={geometry:new Me}}render(t,e){const{painter:i,pixelRatio:o}=t,s=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,s.uniforms),...X(t,e.target),antialiasingControls:te(o),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey),localTileOffset:we(e.target)},defines:{...j(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},La=class extends J{constructor(){super(...arguments),this.type=13,this.shaders={geometry:new At}}render(t,e){const{painter:i}=t,o=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,o.uniforms),...X(t,e.target)},defines:j(t),optionalAttributes:o.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},Te=class extends le{};n([y(5,w)],Te.prototype,"tlbr",void 0),n([y(6,f)],Te.prototype,"relativePosition",void 0),n([y(7,a)],Te.prototype,"gradientMethod",void 0),n([y(8,f)],Te.prototype,"relativeGradientSize",void 0);class Ba extends xt{}let ai=class extends At{constructor(){super(...arguments),this.type="GradientFillShader"}vertex(t,e){const{tlbr:i,relativePosition:o,gradientMethod:s,relativeGradientSize:r}=t,l=M(ie(t.bitset,Yi.isAbsolute),this.view.displayZoomFactor,new a(1));return{...super.vertex(t,e),tlbr:i,relativePosition:o,gradientMethod:s,gradientSize:r.multiply(l),isDiscrete:W(t.bitset,Yi.isDiscrete)}}fragment(t){const{tlbr:e,relativePosition:i,gradientMethod:o,gradientSize:s,isDiscrete:r}=t,l=M(U(r,new a(.5)),s.subtract(1),new f(0)),u=zt([lt(o,new a(Xi.rectangular)),()=>{const v=xe(i).add(l).divide(s);return Ue(pt(v.x,v.y))}],[lt(o,new a(Xi.circular)),Ue(Ki($t(i,i)).add(l.x).divide(s.x))],[!0,Ue(i.x.add(l.x).divide(s.x))]),p=new f(ut(u,new a(0),new a(1)),.5),c=G(e.xy,e.zw,p).divide(this.mosaicInfo.size),d=B(this.mosaicInfo.texture,c),m=t.color.a;return this.getFragmentOutput(d.multiply(m),t,new a(0))}};n([h(mt)],ai.prototype,"mosaicInfo",void 0),n([P(0,A(Te)),P(1,A(dt))],ai.prototype,"vertex",null),n([P(0,A(Ba))],ai.prototype,"fragment",null);let Ea=class extends J{constructor(){super(...arguments),this.type=14,this.shaders={geometry:new ai},this.symbologyPlane=0}render(t,e){const{painter:i}=t,o=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,o.uniforms),...X(t,e.target),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey)},defines:{...j(t)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},Ua=class extends J{constructor(){super(...arguments),this.type=24,this.shaders={geometry:new si}}render(t,e){const{painter:i,pixelRatio:o}=t,s=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,s.uniforms),...X(t,e.target),antialiasingControls:te(o)},defines:{...j(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},Ha=class extends J{constructor(){super(...arguments),this.type=26,this.shaders={geometry:new _e}}render(t,e){const{painter:i}=t,o=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,o.uniforms),...X(t,e.target),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey),localTileOffset:we(e.target)},defines:{...j(t)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},Na=class extends J{constructor(){super(...arguments),this.type=27,this.shaders={geometry:new Re}}render(t,e){const{painter:i,pixelRatio:o}=t,s=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,s.uniforms),...X(t,e.target),antialiasingControls:te(o),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey),localTileOffset:we(e.target)},defines:{...j(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},Lo=class{constructor(t,e,i,o){this.dataType=t,this.samplingMode=e,this.pixelFormat=i,this.internalFormat=o}};function qa(t,e){const{textureFloatLinear:i,colorBufferFloat:o}=t.capabilities,s=o?.textureFloat,r=o?.textureHalfFloat,l=o?.floatBlend,u=t.driverTest.floatBufferBlend.result;if(!s&&!r)throw new Oe("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(l&&u||r))throw new Oe("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));const p=s&&l&&u,c=r,d=i,m=!!o?.R32F,v=!!o?.R16F;if(p&&d)return d||e.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new Lo(He.FLOAT,d?9729:9728,m?6403:6408,m?mo.R32F:6408);if(c)return new Lo(He.HALF_FLOAT,9729,v?6403:6408,v?mo.R16F:6408);throw new Oe("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}const Wa=()=>Ni.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources");let Ga=class{destroy(){this._accumulateFramebuffer=Hi(this._accumulateFramebuffer),this._resolveGradientTexture=Hi(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(t){if(this._qualityProfile==null){const e=qa(t,Wa());this._qualityProfile={...e,defines:{usesHalfFloatPrecision:e.dataType!==He.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(t,e,i){if(this._accumulateFramebuffer==null){const{dataType:o,samplingMode:s,pixelFormat:r,internalFormat:l}=this.loadQualityProfile(t),u=new Ne(e,i);u.pixelFormat=r,u.internalFormat=l,u.dataType=o,u.samplingMode=s,u.wrapMode=33071;const p=new ho(co.DEPTH24_STENCIL8,e,i);this._accumulateFramebuffer=new yo(t,u,p)}else{const{width:o,height:s}=this._accumulateFramebuffer;o===e&&s===i||this._accumulateFramebuffer.resize(e,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(t,e,i){if(this._resolveGradientTexture==null){const o=new Ne;o.wrapMode=33071,this._resolveGradientTexture=new fo(t,o),this._prevGradientHash=null}return this._prevGradientHash!==e&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=e),this._resolveGradientTexture}};function Bo(t){return t?.25:1}let Eo=class extends ct{};n([y(5,f)],Eo.prototype,"offset",void 0);let ja=class extends xt{},Di=class extends E{};n([h(a)],Di.prototype,"radius",void 0),n([h(a)],Di.prototype,"isFieldActive",void 0);let Ce=class extends ot{constructor(){super(...arguments),this.type="HeatmapAccumulateShader",this.usesHalfFloatPrecision=!1}vertex(t){const{radius:e,isFieldActive:i}=this.kernelControls,o=t.offset,s=i.multiply(this.storage.getVVData(t.id).x).add(new a(1).subtract(i)),r=this.view.displayViewScreenMat3.multiply(new R(t.pos,1)).add(this.view.displayViewMat3.multiply(new R(o,0)).multiply(e)),l=this.clip(t.id);return{glPosition:new w(r.xy,l,1),offset:o,fieldValue:s,color:new w(0),...this.maybeRunHittest(t,{},null)}}fragment(t){const{offset:e,fieldValue:i}=t,o=Zt(e),s=k(o,new a(1)),r=new a(1).subtract(o.multiply(o)),l=r.multiply(r),u=s.multiply(l).multiply(i).multiply(new a(Bo(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new w(u),t)}hittest(t){const{viewMat3:e,tileMat3:i}=this.view,o=e.multiply(i).multiply(new R(t.pos,1));return ga(o.xy,this.kernelControls.radius,this.hittestRequest.position)}};n([Lt],Ce.prototype,"usesHalfFloatPrecision",void 0),n([h(Di)],Ce.prototype,"kernelControls",void 0),n([P(0,A(Eo))],Ce.prototype,"vertex",null),n([P(0,A(ja))],Ce.prototype,"fragment",null);let Uo=class extends fi{};n([y(0,f)],Uo.prototype,"position",void 0);let Za=class extends Wi{},ri=class extends E{};n([h(N)],ri.prototype,"texture",void 0),n([h(f)],ri.prototype,"minAndInvRange",void 0),n([h(a)],ri.prototype,"normalization",void 0);class Ho extends E{}n([h(N)],Ho.prototype,"texture",void 0);let de=class extends yi{constructor(){super(...arguments),this.type="HeatmapResolveShader",this.usesHalfFloatPrecision=!1}vertex(t){return{glPosition:new w(t.position.multiply(2).subtract(1),1,1),uv:t.position}}fragment(t){const{accumulatedDensity:e,gradient:i}=this;let o=B(e.texture,t.uv).r.divide(new a(Bo(this.usesHalfFloatPrecision)));o=o.multiply(e.normalization),o=o.subtract(e.minAndInvRange.x).multiply(e.minAndInvRange.y);const s=B(i.texture,new f(o,.5)),r=new Fe;return r.fragColor=new w(s.rgb.multiply(s.a),s.a),r}};n([Lt],de.prototype,"usesHalfFloatPrecision",void 0),n([h(ri)],de.prototype,"accumulatedDensity",void 0),n([h(Ho)],de.prototype,"gradient",void 0),n([P(0,A(Uo))],de.prototype,"vertex",null),n([P(0,A(Za))],de.prototype,"fragment",null);let $a=class extends J{constructor(){super(...arguments),this.type=17,this.drawPhase=73,this.shaders={accumulate:new Ce,resolve:new de},this._isBound=!1,this._resources=new Map}shutdown(t){super.shutdown(t),this._resources.get(t)?.destroy(),this._resources.delete(t),this._prevFBO=null,this._unbind()}render(t,e){const{context:i,painter:o,state:s}=t,r=e.instance.getInput(),{isFieldActive:l}=r.uniforms,u=this._getOrCreateResourcesRecord(i),p=u.loadQualityProfile(i);q(t)||this._bind(t,u,r),o.setShader({shader:this.shaders.accumulate,uniforms:{...X(t,e.target),kernelControls:{radius:qo(r,s),isFieldActive:l?1:0}},defines:{...j(t),...p.defines},optionalAttributes:{},useComputeBuffer:q(t)});const c=q(t)?Ya:No;o.setPipelineState(c),o.submitDraw(t,e)}getStencilReference(t){return Xa(t)}renderResolvePass(t,e){if(q(t))return;const{context:i,painter:o}=t,s=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!s?.initialized)return;const{defines:r}=s.loadQualityProfile(i),{minDensity:l,maxDensity:u,radius:p}=e.getInput().uniforms,c=8,d=9,m=s.accumulateFramebuffer,v=s.resolveGradientTexture,b={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:c,texture:m.colorTexture},minAndInvRange:[l,1/(u-l)],normalization:3/(p*p*Math.PI)},gradient:{texture:{unit:d,texture:v}}},defines:r,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(m.colorTexture,c),i.bindTexture(v,d),o.setPipelineState(Qa),o.submitDrawMesh(i,b,o.quadMesh),this._unbind()}_getOrCreateResourcesRecord(t){let e=this._resources.get(t);return e==null&&(e=new Ga,this._resources.set(t,e)),e}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(t,e,i){if(this._isBound)return;const{context:o,state:s,pixelRatio:r}=t,l=o.getBoundFramebufferObject(),u=o.getViewport();this._prevFBO=l,this._prevViewport=u;const{gradient:p,gradientHash:c}=i.uniforms;e.ensureResolveGradientTexture(o,c,p);const{width:d,height:m}=u,v=Ka(qo(i,s),r),b=d*v,g=m*v,x=e.ensureAccumulateFBO(o,b,g);o.blitFramebuffer(l,x,1024),o.bindFramebuffer(x),o.setViewport(0,0,x.width,x.height),o.setColorMask(!0,!0,!0,!0),o.setClearColor(0,0,0,0),o.clear(16384),this._isBound=!0}};function Ka(t,e){const i=e>1.5?.25:.5;return t<1/(2*i)?1:i}function Xa(t){return t.key.level+1}const No={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{compare:518,mask:255,op:{fail:7680,zFail:7680,zPass:7681}}}},Ya={...No,stencil:!1},Qa={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function qo(t,e){const{referenceScale:i,radius:o}=t.uniforms;return o*(i!==0?i/e.scale:1)}const Ja=360/254;class ft extends ct{}n([y(3,w)],ft.prototype,"color",void 0),n([y(4,f)],ft.prototype,"offset",void 0),n([y(5,f)],ft.prototype,"textureUV",void 0),n([y(6,f)],ft.prototype,"fontAndReferenceSize",void 0),n([y(7,w)],ft.prototype,"outlineColor",void 0),n([y(8,w)],ft.prototype,"haloColor",void 0),n([y(9,f)],ft.prototype,"outlineAndHaloSize",void 0),n([y(10,f)],ft.prototype,"zoomRange",void 0),n([y(11,a)],ft.prototype,"clipAngle",void 0),n([y(12,w)],ft.prototype,"referenceSymbol",void 0),n([y(15,a)],ft.prototype,"visibility",void 0);class Oi extends ve{}n([y(13,f)],Oi.prototype,"offsetNextVertex1",void 0),n([y(14,f)],Oi.prototype,"offsetNextVertex2",void 0);let tr=class extends xt{},it=class extends ot{constructor(){super(...arguments),this.type="TextShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=0,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(t,e){const{clipAngle:i,zoomRange:o,visibility:s}=t,r=i.multiply(Ja),l=xe(this.view.rotation.subtract(r)),u=Ut(new a(360).subtract(l),l);let p=new a(0);const c=Rs(this.view.currentZoom.multiply(Ji)).divide(Ji),d=o.x,m=o.y,v=new a(1).subtract(k(d,c)).multiply(2),b=k(new a(90),u).multiply(2),g=new a(2).multiply(new a(1).subtract(k(c,m)));return p=p.add(e.multiply(v)),p=p.add(e.multiply(b)),p=p.add(g),s&&(p=p.add(s)),p}vertex(t,e){const i=W(t.bitset,Qs),o=new a(1).subtract(i);let s=t.fontAndReferenceSize[0];const r=t.fontAndReferenceSize[1];let l=s.divide(ro);const u=this.textRenderPassType===1?t.outlineColor:this.textRenderPassType===2?t.haloColor:this._getVertexColor(t),p=this.view.displayViewScreenMat3.multiply(new R(t.pos,1));let c=t.offset,d=new a(1),m=L.identity(),v=new f(0);if(this.isLabel){if(!t.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const _=t.referenceSymbol,T=_.xy,H=_.z,D=this._unpackDirection(_.w),O=Ve(this,t.id,H).divide(2),F=D.multiply(O.add(Ls));v=T.add(F),c=c.add(v)}else d=Ve(this,t.id,r).divide(r),s=s.multiply(d),l=l.multiply(d),c=c.multiply(d),m=wo(this,t.id),c=m.multiply(new R(c,0)).xy;const b=W(t.bitset,Js),g=this._getViewRotationMatrix(b).multiply(new R(c,0));let x=this.isLabel?this.clipLabel(t,b):this.clip(t.id,t.zoomRange);x=this.isBackgroundPass?x.add(o.multiply(2)):x.add(i.multiply(2));let V=new a(0);if(this.textRenderPassType===1&&(x=x.add(M(lt(t.outlineAndHaloSize.x,new a(0)),new a(2),new a(0))),V=new a(t.outlineAndHaloSize.x).divide(l).divide(no)),this.textRenderPassType===2){const _=t.outlineAndHaloSize.x,T=new a(t.outlineAndHaloSize.y);x=x.add(M(lt(T,new a(0)),new a(2),new a(0))),V=T.add(_).divide(l).divide(no)}const S=this.isLabel?U(x,new a(1)):new be(!1);return{glPosition:new w(p.xy.add(g.xy),x,1),color:u,size:l,textureUV:t.textureUV.divide(this.mosaicInfo.size),antialiasingWidth:new a(.105*ro).divide(s).divide(this.view.pixelRatio),outlineDistanceOffset:V,...this.maybeRunHittest(t,e,{vvSizeAdjustment:d,vvRotation:m,labelOffset:v,labelClipped:S})}}_getViewRotationMatrix(t){const e=this.view.displayViewMat3,i=this.view.displayMat3,o=new a(1).subtract(t);return e.multiply(t).add(i.multiply(o))}fragment(t){const e=new a(.25),i=new a(1).subtract(e),o=B(this.mosaicInfo.texture,t.textureUV).a;let s=i.subtract(t.outlineDistanceOffset);this.highlight&&(s=s.divide(2));const r=t.antialiasingWidth,l=$i(s.subtract(r),s.add(r),o);return this.getFragmentOutput(t.color.multiply(l),t)}hittest(t,e,{vvSizeAdjustment:i,vvRotation:o,labelOffset:s,labelClipped:r}){let l,u,p;this.isLabel?(l=new R(t.offset.add(s),0),u=new R(e.offsetNextVertex1.add(s),0),p=new R(e.offsetNextVertex2.add(s),0)):(l=o.multiply(new R(t.offset.multiply(i),0)),u=o.multiply(new R(e.offsetNextVertex1.multiply(i),0)),p=o.multiply(new R(e.offsetNextVertex2.multiply(i),0)));const{viewMat3:c,tileMat3:d}=this.view,m=c.multiply(d).multiply(new R(t.pos,1)),v=m.add(d.multiply(l)).xy,b=m.add(d.multiply(u)).xy,g=m.add(d.multiply(p)).xy,x=Ze(this.hittestRequest.position,v.xy,b.xy,g.xy);return this.isLabel?M(r,ne(this.hittestRequest),x):x}_unpackDirection(t){const e=new xi(t),i=Ms(e,new xi(2)),o=Ts(e,new xi(3));return new f(new a(i).subtract(1),new a(o).subtract(1))}_getVertexColor(t){let e=t.color;if(this.visualVariableColor){const i=this.storage.getColorValue(t.id);e=this.visualVariableColor.getColor(i,t.color,new be(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(t.id),o=this.visualVariableOpacity.getOpacity(i);e=e.multiply(o)}return e}};n([C(Nt)],it.prototype,"visualVariableColor",void 0),n([C(qt)],it.prototype,"visualVariableOpacity",void 0),n([C(Ge)],it.prototype,"visualVariableRotation",void 0),n([C(oe)],it.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(Xt)],it.prototype,"visualVariableSizeScaleStops",void 0),n([C(Yt)],it.prototype,"visualVariableSizeStops",void 0),n([C(se)],it.prototype,"visualVariableSizeUnitValue",void 0),n([h(mt)],it.prototype,"mosaicInfo",void 0),n([Lt],it.prototype,"textRenderPassType",void 0),n([Lt],it.prototype,"isBackgroundPass",void 0),n([Lt],it.prototype,"isLabel",void 0),n([P(0,A(ft)),P(1,A(Oi))],it.prototype,"vertex",null),n([P(0,A(tr))],it.prototype,"fragment",null);let er=class extends J{constructor(){super(...arguments),this.type=18,this.shaders={geometry:new it},this.drawPhase=14,this.symbologyPlane=3}render(t,e){const{painter:i}=t,o=j(t),s={...Q(t),stencil:{write:!1,test:{compare:516,mask:255,op:{fail:7680,zFail:7680,zPass:7680}}}},r=e.instance.getInput(),l={shader:this.shaders.geometry,uniforms:{...tt(t,e.target,r.uniforms),...X(t,e.target),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey)},defines:{...o,textRenderPassType:0,isBackgroundPass:!0,isLabel:!0},optionalAttributes:r.optionalAttributes,useComputeBuffer:q(t)};i.setPipelineState(s),i.setShader(l),i.submitDraw(t,e,{stencilRef:255}),i.setShader({...l,defines:{...o,textRenderPassType:2,isBackgroundPass:!1,isLabel:!0}}),i.submitDraw(t,e,{stencilRef:255}),i.setShader({...l,defines:{...o,textRenderPassType:0,isBackgroundPass:!1,isLabel:!0}}),i.submitDraw(t,e,{stencilRef:255})}};function ir(t){return k(new a(0),t).multiply(2).subtract(1)}class me extends _t{}n([y(9,a)],me.prototype,"accumulatedDistance",void 0),n([y(10,a)],me.prototype,"totalLength",void 0),n([y(11,a)],me.prototype,"gradientSize",void 0),n([y(12,f)],me.prototype,"segmentDirection",void 0),n([y(13,w)],me.prototype,"tlbr",void 0);let Wo=class extends E{};n([h(a)],Wo.prototype,"isColorPass",void 0);let ni=class extends yt{constructor(){super(...arguments),this.type="GradientStrokeShader"}vertex(t,e){const{totalLength:i,gradientSize:o,segmentDirection:s,tlbr:r}=t,l=Xe(this,t),u=W(t.bitset,Be.isAlongLine),p=i.divide(this.view.displayZoomFactor),c=M(ie(t.bitset,Be.isAbsoluteSize),()=>{const v=M(U(u,new a(.5)),p,l.halfWidth);return o.divide(v)},o),d=t.accumulatedDistance.add($t(s,l.scaledOffset).divide(p)),m=r.divide(this.mosaicInfo.size.xyxy);return{...l,tlbr:m,relativePositionAlongLine:d,relativeGradientSize:c,isAlongLine:W(t.bitset,Be.isAlongLine),isDiscrete:W(t.bitset,Be.isDiscrete),...this.maybeRunHittest(t,e,l.halfWidth)}}fragment(t){const{isAlongLine:e,isDiscrete:i,relativePositionAlongLine:o,relativeGradientSize:s,normal:r,tlbr:l}=t,u=Ke(t,this.antialiasingControls.blur),p=ir(r.y).multiply(Ut(Zt(r),new a(1))),c=new a(.5).multiply(p).add(new a(.5)),d=M(U(e,new a(.5)),o,c),m=M(U(i,new a(.5)),s.subtract(1),new a(0));let v=d.add(m).divide(s);v=M(U(e,new a(.5)),v,Ue(v));const b=G(l.xy,l.zw,new f(ut(v,new a(0),new a(1)),.5)),g=B(this.mosaicInfo.texture,b),x=t.opacity.multiply(u),V=this.getFragmentOutput(g.multiply(x),t),S=k(new a(.5),this.technique.isColorPass).multiply(kt("gradient-depth-epsilon")),_=k(new a(0),r.y).multiply(new a(kt("gradient-depth-bias")).subtract(S));return V.glFragDepth=ut(Zt(r).add(_),new a(0),new a(1)),V}};n([h(mt)],ni.prototype,"mosaicInfo",void 0),n([h(Wo)],ni.prototype,"technique",void 0),n([P(0,A(me)),P(1,A(dt))],ni.prototype,"vertex",null);let or=class extends J{constructor(){super(...arguments),this.type=15,this.shaders={geometry:new ni},this.symbologyPlane=1}_getShaderOptions(t,e,i){const{painter:o,pixelRatio:s}=t,r=e.instance.getInput();return{shader:this.shaders.geometry,uniforms:{...tt(t,e.target,r.uniforms),...X(t,e.target),antialiasingControls:te(s),mosaicInfo:o.textureManager.getMosaicInfo(t,e.textureKey),technique:{isColorPass:i}},defines:{...j(t)},optionalAttributes:r.optionalAttributes,useComputeBuffer:q(t)}}render(t,e){const{painter:i}=t;if(q(t)||uo(t)){const r=Q(t);return i.setPipelineState(r),i.setShader(this._getShaderOptions(t,e,1)),void i.submitDraw(t,e)}t.context.setClearDepth(1),t.context.clear(256);const o={color:!1,depth:{write:{zNear:0,zFar:1},test:513},stencil:{write:!1,test:{compare:514,mask:255,op:{fail:7680,zFail:7680,zPass:7680}}}};i.setShader(this._getShaderOptions(t,e,0)),i.setPipelineState(o),i.submitDraw(t,e);const s={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:{write:!1,test:515},stencil:{write:!1,test:{compare:514,mask:255,op:{fail:7680,zFail:7680,zPass:7680}}}};i.setShader(this._getShaderOptions(t,e,1)),i.setPipelineState(s),i.submitDraw(t,e)}},sr=class extends J{constructor(){super(...arguments),this.type=19,this.shaders={geometry:new yt},this.symbologyPlane=1}render(t,e){const{painter:i,pixelRatio:o}=t,s=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,s.uniforms),...X(t,e.target),antialiasingControls:te(o)},defines:{...j(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}};class he extends _t{}n([y(9,a)],he.prototype,"accumulatedDistance",void 0),n([y(10,f)],he.prototype,"segmentDirection",void 0),n([y(11,a)],he.prototype,"offsetAlongLine",void 0),n([y(12,a)],he.prototype,"capType",void 0),n([y(13,w)],he.prototype,"tlbr",void 0);class Fi extends yt{constructor(){super(...arguments),this.type="TexturedLineShader"}_getDistanceRatio(e,i){const o=W(e.bitset,ta);return o.multiply(pt(i,new a(.25)).multiply(new a(2))).add(new a(1).subtract(o).multiply(jt(1)))}_getSDFAlpha(e){const{halfWidth:i,normal:o,tlbr:s,patternSize:r,accumulatedDistance:l,offsetAlongLine:u,dashToPx:p,capType:c}=e,d=r.x.divide(la).multiply(p),m=vi(l.add(u).divide(d)),v=G(s.xy,s.zw,new f(m,.5)),b=Ee(B(this.mosaicInfo.texture,v)).multiply(2).subtract(1).multiply(ua).multiply(p),g=o.y.multiply(i),x=zt([lt(c,new a(1)),b.subtract(i)],[lt(c,new a(2)),Ki(Cs(pt(b,new a(0)),new a(2)).add(g.multiply(g))).subtract(i)],[!0,b]),V=ut(new a(.25).subtract(x),new a(0),new a(1));return new w(V)}_getPatternColor(e){const{halfWidth:i,normal:o,color:s,accumulatedDistance:r,patternSize:l,sampleAlphaOnly:u,tlbr:p}=e,c=l.y.multiply(new a(2).multiply(i).divide(l.x)),d=vi(r.divide(c)),m=new a(.5).multiply(o.y).add(new a(.5)),v=G(p.xy,p.zw,new f(m,d));let b=B(this.mosaicInfo.texture,v);return this.visualVariableColor!=null&&(b=M(U(u,new a(.5)),new w(s.a),s)),b}vertex(e,i){const{segmentDirection:o,tlbr:s,bitset:r}=e,l=Xe(this,e),u=e.accumulatedDistance.divide(this.view.displayZoomFactor).add($t(o,l.scaledOffset)),p=new f(s.z.subtract(s.x),s.w.subtract(s.y)),c=s.divide(this.mosaicInfo.size.xyxy),d=W(r,ea),m=W(r,ao),v=M(U(d,new a(.5)),this._getDistanceRatio(e,l.scaledHalfWidth),new a(1));return{...l,tlbr:c,patternSize:p,accumulatedDistance:u,isSDF:d,sampleAlphaOnly:m,dashToPx:v,offsetAlongLine:e.offsetAlongLine,capType:e.capType,...this.maybeRunHittest(e,i,l.halfWidth)}}fragment(e){const{color:i,opacity:o,isSDF:s}=e,r=Ke(e,this.antialiasingControls.blur),l=M(U(s,new a(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),u=i.multiply(o).multiply(r).multiply(l);return this.getFragmentOutput(u,e)}}n([h(mt)],Fi.prototype,"mosaicInfo",void 0),n([P(0,A(he)),P(1,A(dt))],Fi.prototype,"vertex",null);let ar=class extends J{constructor(){super(...arguments),this.type=31,this.shaders={geometry:new Fi},this.symbologyPlane=1}render(t,e){const{painter:i,pixelRatio:o}=t,s=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,s.uniforms),...X(t,e.target),antialiasingControls:te(o),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey)},defines:{...j(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}};class Ct extends ct{}n([y(3,w)],Ct.prototype,"color",void 0),n([y(4,w)],Ct.prototype,"outlineColor",void 0),n([y(5,f)],Ct.prototype,"offset",void 0),n([y(6,f)],Ct.prototype,"textureUV",void 0),n([y(7,w)],Ct.prototype,"sizing",void 0),n([y(8,a)],Ct.prototype,"placementAngle",void 0),n([y(9,a)],Ct.prototype,"sdfDecodeCoeff",void 0),n([y(10,f)],Ct.prototype,"zoomRange",void 0);class De extends ve{}n([y(11,f)],De.prototype,"offsetNextVertex1",void 0),n([y(12,f)],De.prototype,"offsetNextVertex2",void 0),n([y(13,f)],De.prototype,"textureUVNextVertex1",void 0),n([y(14,f)],De.prototype,"textureUVNextVertex2",void 0);class rr extends xt{}function Dt(t,e,i,o){return e.multiply(t.x).add(i.multiply(t.y)).add(o.multiply(t.z))}function Ii(t){return t.multiply(t).divide(128)}class wt extends ot{constructor(){super(...arguments),this.type="MarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,i){const o=Ii(e.sizing.x),s=Ii(e.sizing.y),r=Ii(e.sizing.z),l=e.placementAngle,u=W(e.bitset,bt.bitset.isSDF),p=W(e.bitset,bt.bitset.isMapAligned),c=W(e.bitset,bt.bitset.scaleSymbolsProportionally),d=ie(e.bitset,bt.bitset.colorLocked),m=re(this,e.id),v=ae(this,e.id,e.color,d).multiply(m),b=this.view.displayViewScreenMat3.multiply(new R(e.pos.xy,1)),g=Ve(this,e.id,r).divide(r),x=o.multiply(g),V=e.offset.xy.multiply(g);let S=s.multiply(c.multiply(g.subtract(1)).add(1));S=Ut(S,pt(x.subtract(.99),new a(0)));const _=pt(S,new a(1)),T=Ut(S,new a(1)),H=L.fromRotation(l.multiply(Si)),D=wo(this,e.id),O=this._getViewRotationMatrix(p).multiply(D).multiply(H).multiply(new R(V.xy,0)),F=this.clip(e.id,e.zoomRange),I=new w(b.xy.add(O.xy),F,1),z=e.textureUV.divide(this.mosaicInfo.size),nt=e.outlineColor.multiply(T),Ft=W(e.bitset,bt.bitset.overrideOutlineColor),It=e.sdfDecodeCoeff.multiply(x);return{glPosition:I,color:v,textureUV:z,outlineColor:nt,outlineSize:_,distanceToPx:It,isSDF:u,overrideOutlineColor:Ft,...this.maybeRunHittest(e,i,{pos:e.pos,size:x,sizeCorrection:g,isMapAligned:p,vvRotationMat3:D,placementMat3:H,outlineSize:_,distanceToPx:It,isSDF:u})}}fragment(e){const i=this._getColor(e.textureUV,e);return this.getFragmentOutput(i,e)}hittest(e,i,o){return M(bi(o.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,i,o),this._hittestMarker(e,i,o))}_getViewRotationMatrix(e){const i=this.view.displayViewMat3,o=this.view.displayMat3,s=new a(1).subtract(e);return i.multiply(e).add(o.multiply(s))}_getViewScreenMatrix(e){const i=this.view.viewMat3.multiply(this.view.tileMat3),o=this.view.tileMat3,s=new a(1).subtract(e);return i.multiply(e).add(o.multiply(s))}_getColor(e,i){return M(lt(i.isSDF,new a(1)),this._getSDFColor(e,i),this._getSpriteColor(e,i))}_getSpriteColor(e,i){return B(this.mosaicInfo.texture,e).multiply(i.color)}_getSDFColor(e,i){const o=B(this.mosaicInfo.texture,e),s=new a(.5).subtract(Ee(o)).multiply(i.distanceToPx).multiply(oo),r=ut(new a(.5).subtract(s),new a(0),new a(1)),l=i.color.multiply(r);let u=i.outlineSize;this.highlight&&(u=pt(u,i.overrideOutlineColor.multiply(4)));const p=u.multiply(.5),c=xe(s).subtract(p),d=ut(new a(.5).subtract(c),new a(0),new a(1)),m=G(i.outlineColor,i.color,i.overrideOutlineColor).multiply(d);return new a(1).subtract(m.a).multiply(l).add(m)}_hittestSmallMarker(e,i,o){const{position:s,distance:r,smallSymbolDistance:l}=this.hittestRequest,u=r.subtract(l),{viewMat3:p,tileMat3:c}=this.view,d=p.multiply(c).multiply(new R(o.pos,1)).xy,m=o.size.multiply(.5);return Le(d,s).subtract(m).add(u)}_hittestMarker(e,i,o){const{pos:s,sizeCorrection:r,isMapAligned:l}=o,u=new R(e.offset.multiply(r),0),p=new R(i.offsetNextVertex1.multiply(r),0),c=new R(i.offsetNextVertex2.multiply(r),0),{viewMat3:d,tileMat3:m}=this.view,v=d.multiply(m).multiply(new R(s,1)),b=this._getViewScreenMatrix(l).multiply(o.vvRotationMat3).multiply(o.placementMat3),g=v.add(b.multiply(u)).xy,x=v.add(b.multiply(p)).xy,V=v.add(b.multiply(c)).xy,S=this.hittestRequest.position,_=this.hittestRequest.distance,T=Ze(S,g,x,V);return M(U(T,_),T,this._hittestSamples(g,x,V,e,i,o))}_hittestSamples(e,i,o,s,r,l){const{outlineSize:u,isSDF:p,distanceToPx:c}=l,d=this.hittestRequest.position,m=this.hittestRequest.distance,v=$(d.add(new f(Y(m),Y(m))),e,i,o),b=$(d.add(new f(0,Y(m))),e,i,o),g=$(d.add(new f(m,Y(m))),e,i,o),x=$(d.add(new f(Y(m),0)),e,i,o),V=$(d,e,i,o),S=$(d.add(new f(m,0)),e,i,o),_=$(d.add(new f(Y(m),m)),e,i,o),T=$(d.add(new f(0,m)),e,i,o),H=$(d.add(new f(m,m)),e,i,o),D=s.textureUV.divide(this.mosaicInfo.size),O=r.textureUVNextVertex1.divide(this.mosaicInfo.size),F=r.textureUVNextVertex2.divide(this.mosaicInfo.size),I={color:new w(1),outlineColor:new w(1),overrideOutlineColor:new a(1),outlineSize:u,distanceToPx:c,isSDF:p};let z=new a(0);return z=z.add(Z(v).multiply(this._getColor(Dt(v,D,O,F),I).a)),z=z.add(Z(b).multiply(this._getColor(Dt(b,D,O,F),I).a)),z=z.add(Z(g).multiply(this._getColor(Dt(g,D,O,F),I).a)),z=z.add(Z(x).multiply(this._getColor(Dt(x,D,O,F),I).a)),z=z.add(Z(V).multiply(this._getColor(Dt(V,D,O,F),I).a)),z=z.add(Z(S).multiply(this._getColor(Dt(S,D,O,F),I).a)),z=z.add(Z(_).multiply(this._getColor(Dt(_,D,O,F),I).a)),z=z.add(Z(T).multiply(this._getColor(Dt(T,D,O,F),I).a)),z=z.add(Z(H).multiply(this._getColor(Dt(H,D,O,F),I).a)),k(z,new a(.05)).multiply(ne(this.hittestRequest))}}n([C(Nt)],wt.prototype,"visualVariableColor",void 0),n([C(qt)],wt.prototype,"visualVariableOpacity",void 0),n([C(Ge)],wt.prototype,"visualVariableRotation",void 0),n([C(oe)],wt.prototype,"visualVariableSizeMinMaxValue",void 0),n([C(Xt)],wt.prototype,"visualVariableSizeScaleStops",void 0),n([C(Yt)],wt.prototype,"visualVariableSizeStops",void 0),n([C(se)],wt.prototype,"visualVariableSizeUnitValue",void 0),n([h(mt)],wt.prototype,"mosaicInfo",void 0),n([P(0,A(Ct)),P(1,A(De))],wt.prototype,"vertex",null),n([P(0,A(rr))],wt.prototype,"fragment",null);let nr=class extends J{constructor(){super(...arguments),this.type=21,this.shaders={geometry:new wt},this.symbologyPlane=2}render(t,e){const{painter:i}=t,o=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...tt(t,e.target,o.uniforms),...X(t,e.target),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey,!0)},defines:{...j(t)},optionalAttributes:o.optionalAttributes,useComputeBuffer:q(t)}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},lr=class{constructor(){this.computeAttributes={}}get locationsMap(){const t=new Map;for(const e in this.locations)t.set(e,this.locations[e].index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set(Object.keys(this.options));this._optionPropertyKeys=t}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,e=Array.from(t.entries()).map(([i,o])=>`${i}.${o}`).join(".");this._locationInfo={stringHash:e,locations:t,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const[e,i]of this.locationsMap.entries())t.set("a_"+e,i);return t}getShaderKey(t,e,i){return`${Object.keys(t).map(o=>`${o}.${t[o]}`).join(".")}.${Object.keys(i).filter(o=>i[o]).map(o=>`${o}_${i[o].toString()}`).join(".")}.${Object.keys(e).filter(o=>this.optionPropertyKeys.has(o)).join(".")}`}getProgram(t,e,i,o){let s="",r="";for(const l in i)if(i[l]){const u=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;s+=u,r+=u}return s+=this.vertexShader,r+=this.fragmentShader,new Ds(s,r,this.renamedLocationsMap,this._getUniformBindings(e),this._transformFeedbackBindings)}_getUniformBindings(t){const e=[];for(const i in this.required){const o=this.required[i];e.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:o.type,uniformArrayElementType:Go(o),uniformArrayLength:jo(o)})}for(const i in t){const o=this.options[i];if(t[i])for(const s in o){const r=o[s];e.push({uniformHydrated:null,shaderModulePath:`${i}.${s}`,uniformName:s,uniformType:r.type,uniformArrayElementType:Go(r),uniformArrayLength:jo(r)})}}return e}};const Go=t=>t.type==="array"?t.elementType?.type:void 0,jo=t=>t.type==="array"?t.size:void 0,ur={hittestDist:a,hittestPos:f},pr={filterFlags:N,animation:N,visualVariableData:N,dataDriven0:N,dataDriven1:N,dataDriven2:N,gpgpu:N,size:a},cr={displayViewScreenMat3:L,displayViewMat3:L,displayMat3:L,viewMat3:L,tileMat3:L,displayZoomFactor:a,requiredZoomFactor:a,tileOffset:f,currentScale:a,currentZoom:a,metersPerSRUnit:a};let dr=class extends lr{constructor(){super(...arguments),this.vertexShader=vo("materials/pie/pie.vert"),this.fragmentShader=vo("materials/pie/pie.frag"),this.required={...pr,...cr,outlineWidth:a,colors:gt,defaultColor:w,othersColor:w,outlineColor:w,donutRatio:a,sectorThreshold:a},this.options={hittestUniforms:ur,visualVariableSizeMinMaxValue:{minMaxValueAndSize:w},visualVariableSizeScaleStops:{sizes:{type:"array",elementType:a,size:8},values:{type:"array",elementType:a,size:8}},visualVariableSizeStops:{sizes:{type:"array",elementType:a,size:8},values:{type:"array",elementType:a,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:a},visualVariableOpacity:{opacities:{type:"array",elementType:a,size:8},opacityValues:{type:"array",elementType:a,size:8}},highlightUniforms:{highlightAll:a,activeReasons:a}},this.locations={pos:{index:0,type:f},id:{index:1,type:R},bitset:{index:2,type:a},offset:{index:3,type:f},texCoords:{index:4,type:f},size:{index:5,type:f},referenceSize:{index:6,type:a},zoomRange:{index:7,type:f}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(t){this.required.colors={type:"array",elementType:w,size:t}}},mr=class extends J{constructor(){super(...arguments),this.type=28,this.shaders={geometry:new dr},this.symbologyPlane=2}render(t,e){const{painter:i}=t,{instance:o,target:s}=e,r=this.shaders.geometry,l=o.getInput(),u=l.uniforms.numberOfFields,p=q(t),c=X(t,s),d=j(t);r.setNumberOfFields(u),i.setShader({shader:r,uniforms:{...tt(t,e.target,l.uniforms.shader),...c.storage,...c.view,...c.highlight,highlightUniforms:c.highlight,hittestUniforms:c.hittestRequest?{hittestDist:c.hittestRequest?.distance,hittestPos:c.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!l.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!l.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!l.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!l.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!l.uniforms.shader.visualVariableOpacity,HITTEST:p,highlight:c.highlight?1:0,...d,numberOfFields:u},optionalAttributes:{},useComputeBuffer:p}),i.setPipelineState(Q(t)),i.submitDraw(t,e)}},hr=class extends J{constructor(){super(...arguments),this.type=30,this.shaders={geometry:new it},this.symbologyPlane=3}render(t,e){const{painter:i}=t,o=j(t),s=e.instance.getInput(),r={shader:this.shaders.geometry,uniforms:{...tt(t,e.target,s.uniforms),...X(t,e.target),mosaicInfo:i.textureManager.getMosaicInfo(t,e.textureKey)},defines:{...o,isBackgroundPass:!0,isLabel:!1,textRenderPassType:0},optionalAttributes:s.optionalAttributes,useComputeBuffer:q(t)};i.setShader(r),i.setPipelineState(Q(t)),i.submitDraw(t,e),i.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:2}}),i.submitDraw(t,e),i.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:1}}),i.submitDraw(t,e),i.setShader({...r,defines:{...o,isBackgroundPass:!1,isLabel:!1,textRenderPassType:0}}),i.submitDraw(t,e)}};const K={fill:new La,patternFill:new Ha,complexFill:new Da,gradientFill:new Ea,outlineFill:new Ua,patternOutlineFill:new Na,complexOutlineFill:new ka,marker:new nr,pieChart:new mr,line:new sr,texturedLine:new ar,gradientStroke:new or,text:new hr,label:new er,heatmap:new $a,dotDensity:new Ca,animatedMarker:new Va,animatedMarkerShift:new za,animatedFill:new Pa,animatedLine:new Aa};function yr(){for(const t in K)K[t].startup()}function fr(t){for(const e in K)K[e].shutdown(t)}function li(t,e){const i=t.slice(0,e),o=e-i.length;for(let s=0;s<o;s++){const r=i[i.length-1];i.push(r)}return i}function Zo(t){if(!t)return[0,0,0,0];const{r:e,g:i,b:o,a:s}=t;return[e*(s/255),i*(s/255),o*(s/255),s]}const ui=8,$o=ui-2,Ko=()=>Ni.getLogger("esri.views.2d.layers.features.support.rendererUtils");function Xo(t){return t.map(e=>vr(e)?gr(e.clone()):e)}function vr(t){return(t.type==="size"||t.type==="color"||t.type==="opacity")&&t.stops!=null}function gr(t){return t.stops=wr(t.type,t.stops??[]),t}function ye(t,e,i){return(1-i)*t+i*e}function br(t,e){const[i,...o]=e,s=o.pop(),r=o[0].value,l=o[o.length-1].value,u=(l-r)/$o,p=[];for(let c=r;c<l;c+=u){let d=0;for(;c>=o[d].value;)d++;const m=o[d],v=e[d-1],b=c-v.value,g=m.value===v.value?1:b/(m.value-v.value);if(t==="color"){const x=o[d],V=e[d-1],S=x.color.clone();S.r=ye(V.color.r,S.r,g),S.g=ye(V.color.g,S.g,g),S.b=ye(V.color.b,S.b,g),S.a=ye(V.color.a,S.a,g),p.push({value:c,color:S,label:x.label})}else if(t==="size"){const x=o[d],V=e[d-1],S=qi(x.size),_=ye(qi(V.size),S,g);p.push({value:c,size:_,label:x.label})}else{const x=o[d],V=ye(e[d-1].opacity,x.opacity,g);p.push({value:c,opacity:V,label:x.label})}}return[i,...p,s]}function xr(t){const[e,...i]=t,o=i.pop();for(;i.length>$o;){let s=0,r=0;for(let l=1;l<i.length;l++){const u=i[l-1],p=i[l],c=Math.abs(p.value-u.value);c>r&&(r=c,s=l)}i.splice(s,1)}return[e,...i,o]}function wr(t,e){return e.length<=ui?e:(Ko().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${ui}. Displayed stops will be simplified.`),e.length>2*ui?br(t,e):xr(e))}function Sr(){const{supportsColorBufferFloat:t,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:i}=qe();return t&&e||i}function Vr(t){if(!t)return!0;switch(t.type){case"dot-density":break;case"heatmap":if(!Sr()){const e=qe(),i=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(o=>!e[o]).join(", ");return Ko().errorOnce(new Oe("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${i}`)),!1}}return!0}const zr=1.25,pi=128,Pr=128;function Ar(t){if(!t.stops?.length)return null;const e=t.stops.sort((r,l)=>r.value-l.value),i=li(e,8),o=i.map(({value:r})=>r),s=i.map(({color:r})=>Zo(r));return{values:o,colors:s}}function _r(t){if(!t.stops?.length)return null;const e=t.stops.sort((o,s)=>o.value-s.value),i=li(e,8);return{opacityValues:i.map(({value:o})=>o),opacities:i.map(({opacity:o})=>o)}}function Rr(t){return{rotationType:t.rotationType==="geographic"?0:1}}function ki(t){if(!t.stops?.length)return null;if(t.stops.some(o=>o.useMaxValue||o.useMinValue))return(o,s)=>{const r=o.statisticsByLevel.get(s.key.level),l=t.stops.map(p=>({value:p.useMaxValue?r?.get(t.field)?.maxValue??0:p.useMinValue?r?.get(t.field)?.minValue??0:p.value,size:p.size?jt(p.size):Bs})).sort((p,c)=>p.value-c.value),u=li(l,8);return{values:u.map(({value:p})=>p),sizes:u.map(({size:p})=>p)}};const e=t.stops.sort((o,s)=>o.value-s.value),i=li(e,8);return{values:i.map(({value:o})=>o),sizes:i.map(({size:o})=>jt(o))}}function Mr(t){return e=>{const{state:i}=e;return{unitValueToPixelsRatio:gs(i.spatialReference)/pa[t.valueUnit??"meters"]/i.resolution}}}function Yo(t,e){const i=e.length;if(t<e[0].value||i===1)return e[0].size;for(let o=1;o<i;o++)if(t<e[o].value){const s=(t-e[o-1].value)/(e[o].value-e[o-1].value);return e[o-1].size+s*(e[o].size-e[o-1].size)}return e[i-1].size}function Tr(t){const{minDataValue:e,maxDataValue:i,minSize:o,maxSize:s}=t;if(typeof o=="object"&&typeof s=="object")return(r,l)=>{const u=r.state.scale,p=jt(Yo(u,o.stops)),c=jt(Yo(u,s.stops));return{minMaxValueAndSize:[e,i,p,c]}};if(typeof o=="object"||typeof s=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,i,jt(o),jt(s)]}}const Ot={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function Li(t,e=Pr,i=zr){if(t.visualVariableSizeMinMaxValue)return typeof t.visualVariableSizeMinMaxValue=="function"?pi:Math.max(t.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,e);if(t.visualVariableSizeScaleStops){if(typeof t.visualVariableSizeScaleStops=="function")return pi;const o=t.visualVariableSizeScaleStops.sizes;return Math.max(o[o.length-1]*i,e)}if(t.visualVariableSizeStops){if(typeof t.visualVariableSizeStops=="function")return pi;const o=t.visualVariableSizeStops.sizes;return Math.max(o[o.length-1]*i,e)}return t.visualVariableSizeUnitValue?2*pi:0}function Cr(t){const e={...Ot};if(!t||!("visualVariables"in t)||!t.visualVariables)return e;for(const i of Xo(t.visualVariables))switch(i.type){case"color":e.visualVariableColor=Ar(i);break;case"opacity":e.visualVariableOpacity=_r(i);break;case"rotation":e.visualVariableRotation=Rr(i);break;case"size":switch(Dr(i)){case"field-stops":e.visualVariableSizeStops=ki(i);break;case"scale-stops":i.target==="outline"?e.visualVariableSizeOutlineScaleStops=ki(i):e.visualVariableSizeScaleStops=ki(i);break;case"min-max":e.visualVariableSizeMinMaxValue=Tr(i);break;case"unit-value":e.visualVariableSizeUnitValue=Mr(i)}break}return e}function Dr(t){return typeof t.minDataValue=="number"&&typeof t.maxDataValue=="number"&&t.minSize!=null&&t.maxSize!=null?"min-max":t?.valueExpression==="$view.scale"&&Array.isArray(t.stops)?"scale-stops":t.field==null&&t?.valueExpression==="$view.scale"||!(Array.isArray(t.stops)||"levels"in t&&t.levels)?t.field!=null||t?.valueExpression!=="$view.scale"?"unit-value":null:"field-stops"}function Qo(t){return!!(t.visualVariableSizeMinMaxValue||t.visualVariableSizeScaleStops||t.visualVariableSizeStops||t.visualVariableSizeUnitValue||t.visualVariableSizeOutlineScaleStops)}function Or(t){return!!t.visualVariableRotation}function Jo(t){return t.spriteRasterizationParam?t.spriteRasterizationParam:{type:"sprite-rasterization-param",resource:{type:"CIMPictureMarker",url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAJOgAACToAYJjBRwAAAAsSURBVEhL7c0xAQAwDASh+jf9lcCU7TDA27ECKqACKqACKqACKqACKqDjYPuLVfSmMPfafQAAAABJRU5ErkJggg==",size:16,invertBackfaceTexture:!1,scaleX:1,textureFilter:"Picture"},overrides:[]}}function ts(t){return t.minScale||t.maxScale?{minScale:t.minScale??0,maxScale:t.maxScale??0}:null}function st(t){if(t==null)return null;if(Array.isArray(t)){const[e,i,o,s]=t;return[e,i,o,255*s]}return typeof t=="string"?t:{...t,defaultValue:st(t?.defaultValue)}}async function Fr(t,e){const{cimResourceManager:i,cimAnalyzer:o,scaleExpression:s}=e.schemaOptions;await Promise.all(ds.fetchResources(t.symbol,i,[]));const r=o.analyzeSymbolReference(t,!1),l={scaleInfo:ts(t),scaleExpression:s},u=[];for(const p of r)switch(p.type){case"marker":u.push(...Ir(p,e,l));break;case"fill":u.push(...Br(p,e,l));break;case"outlineFill":u.push(...Lr(p,e,l));break;case"gradientFill":u.push(...Er(p,e,l));break;case"line":u.push(...Ur(p,e,l));break;case"gradientStroke":u.push(...Hr(p,e,l));break;case"text":u.push(...Nr(p,e,l))}return u}function Ir(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:r}=s,l=t.isOutline?{...Ot,visualVariableSizeScaleStops:o.visualVariableSizeOutlineScaleStops}:{visualVariableColor:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue,visualVariableRotation:o.visualVariableRotation};if(t.animationParams){const{hasShiftAnimation:u}=t.animationParams.params,p=u?K.animatedMarkerShift:K.animatedMarker;return es(r.ensureInstance(p,{uniforms:l,optionalAttributes:{zoomRange:!0,value1Position2Value2:t.animationParams.params.hasShiftAnimation,lineLength:u}}),t,Ot,i)}return is(r.ensureInstance(K.marker,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,o,i)}function es(t,e,i,o){return e.animationParams?[t.createMeshInfo({pixelDimensions:e.pixelDimensions,texelDimensions:e.texelDimensions,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,sprite:Jo(e),animations:e.animationParams,scaleInfo:o.scaleInfo,scaleSymbolsProportionally:e.scaleSymbolsProportionally,strokeWidth:e.outlineWidth,isMapAligned:e.alignment===1,colorLocked:e.colorLocked,isStroke:e.isStroke,baseSize:e.baseSize,placement:e.markerPlacement,referenceSize:e.referenceSize,angleToLine:!!e.markerPlacement&&e.markerPlacement.placement&&"angleToLine"in e.markerPlacement.placement&&e.markerPlacement.placement.angleToLine,sizeRatio:e.sizeRatio,patternHeight:null})]:[]}function ci(t,e,i,o){return e.animationParams?[t.createMeshInfo({effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,sprite:Jo(e),animations:e.animationParams,scaleInfo:o.scaleInfo,scaleSymbolsProportionally:!1,strokeWidth:1,isMapAligned:!0,colorLocked:e.colorLocked||!1,isStroke:!1,baseSize:"width"in e?e.width:-1,placement:null,referenceSize:2,angleToLine:!1,sizeRatio:1,patternHeight:e.type==="fill"&&e.spriteRasterizationParam?e.height:null,joinType:"join"in e?e.join:"round",capType:"cap"in e?e.cap:"round",miterLimit:"miterLimit"in e&&e.miterLimit||2})]:[]}function is(t,e,i,{scaleInfo:o,scaleExpression:s}){const r=Qo(i);return[t.createMeshInfo({size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:st(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:o,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:st(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||ms.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:s??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:r,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:Li(i)})]}function kr(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:r}=s,l={visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity};if(t.animationParams){const u=K.animatedFill;return ci(r.ensureInstance(u,{uniforms:{...l,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),t,Ot,i)}return ss(r.ensureInstance(K.fill,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,i)}function Lr(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:r}=s;return os(r.ensureInstance(K.outlineFill,{uniforms:{visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,i)}function os(t,e,i){const o=st(e.color)??[0,0,0,0],s=st(e.outlineColor)??[0,0,0,0];return[t.createMeshInfo({color:o,outlineColor:s,width:e.outlineWidth,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,outlineUsesColorVV:!e.outlineColorLocked,hasSizeVV:!1,scaleInfo:i.scaleInfo,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,outlineEffects:e.outlineEffects?{type:"cim-effect-infos",effectInfos:e.outlineEffects}:null})]}function ss(t,e,{scaleInfo:i}){return[t.createMeshInfo({color:st(e.color)??[0,0,0,0],scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Br(t,e,i){if(!t.spriteRasterizationParam)return kr(t,e,i);const{uniforms:o,schemaOptions:s}=e,{store:r}=s,l={visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity};if(t.animationParams){const u=K.animatedFill;return ci(r.ensureInstance(u,{uniforms:{...l,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),t,Ot,i)}return as(r.ensureInstance(K.complexFill,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,o.visualVariableColor!=null,i)}function as(t,e,i,{scaleInfo:o}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const s=!!e.hasUnresolvedReplacementColor&&(!i||e.colorLocked),r=e.sampleAlphaOnly&&!s,l=e.spriteRasterizationParam;return[t.createMeshInfo({color:st(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:r,scaleProportionally:l.resource.type==="CIMHatchFill",sprite:l,scaleInfo:o,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Er(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:r}=s;return rs(r.ensureInstance(K.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:o.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,i)}function rs(t,e,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=e.spriteRasterizationParam;return[t.createMeshInfo({color:st(e.color)??[0,0,0,0],angle:e.angle,gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:o,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Ur(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:r}=s,l=t.isOutline?{...Ot,visualVariableSizeScaleStops:o.visualVariableSizeOutlineScaleStops}:{visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue};if(t.animationParams){const{hasShiftAnimation:c}=t.animationParams.params,d=K.animatedLine;return ci(r.ensureInstance(d,{uniforms:{...l,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,accumulatedDistance:!0,segmentDirection:!0,normal:!0,lineLength:c}}),t,Ot,i)}const u={uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}},p=!!(l.visualVariableSizeMinMaxValue||l.visualVariableSizeScaleStops||l.visualVariableSizeStops||l.visualVariableSizeUnitValue);return t.spriteRasterizationParam?ls(r.ensureInstance(K.texturedLine,u),t,p,i):ns(r.ensureInstance(K.line,u),t,p,i)}function Bi(t,e,{scaleInfo:i}){return{color:st(t.color)??[0,0,0,0],width:t.width,referenceWidth:t.referenceWidth,capType:t.cap,joinType:t.join,miterLimit:t.miterLimit,scaleInfo:i,hasSizeVV:e,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null}}function ns(t,e,i,o){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const s=Bi(e,i,o);return[t.createMeshInfo(s)]}function ls(t,e,i,o){const{spriteRasterizationParam:s,scaleDash:r,sampleAlphaOnly:l}=e;if(!s)throw new Error("InternalError: Sprite should be defined");return[t.createMeshInfo({...Bi(e,i,o),offsetAlongLine:e.offsetAlongLine??0,shouldScaleDash:r??!1,shouldSampleAlphaOnly:l,isSDF:s.resource.type!=="CIMPictureStroke"&&s.resource.type!=="CIMGradientStroke",sprite:s})]}function Hr(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:r}=s;return us(r.ensureInstance(K.gradientStroke,{uniforms:t.isOutline?{...Ot,visualVariableSizeScaleStops:o.visualVariableSizeOutlineScaleStops}:{visualVariableColor:null,visualVariableOpacity:o.visualVariableOpacity,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,i)}function us(t,e,i){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=e.spriteRasterizationParam;return[t.createMeshInfo({...Bi(e,!1,i),gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:o,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function Nr(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:r}=s;return ps(r.ensureInstance(K.text,{uniforms:{visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableRotation:o.visualVariableRotation,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1,visibility:!1}}),t,o,i)}function ps(t,e,i,{scaleInfo:o,scaleExpression:s}){return[t.createMeshInfo({boxBackgroundColor:st(e.backgroundColor),boxBorderLineColor:st(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:st(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:st(e.haloColor)??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:st(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:o,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:s??1,minPixelBuffer:Li(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,layerId:null,labelClassId:null})]}function qr(t,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:qe().maxTextureSize},bindings:mi(t)}}function Wr(t,e){const i=qe();return{type:"multi",target:"feature",keyField:ca,filters:e,capabilities:{maxTextureSize:i.maxTextureSize},bindings:{0:mi(t.trackLines.renderer),1:mi(t.latestObservations.renderer),2:mi(t.previousObservations.renderer)}}}function di(t){switch(t){case"opacity":return 2;case"color":return 1;case"rotation":return 3;case"size":return 0;default:return null}}function mi(t){if(!t)return[];switch(t.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return Ei(t);case"dot-density":return Gr(t);case"pie-chart":return jr(t);case"heatmap":return Zr(t)}}function Gr(t){const e=[];for(const i of t.attributes)e.push({binding:e.length,expression:i.valueExpression,field:i.field});return e}function jr(t){const e=Ei(t);let i=4;for(const o of t.attributes)e.push({binding:i++,expression:o.valueExpression,field:o.field});return e}function Zr({valueExpression:t,field:e}){return t||e?[{binding:0,expression:t,field:e}]:[]}function Ei(t){return!("visualVariables"in t)||!t.visualVariables?.length?[]:Xo(t.visualVariables).map(e=>Qr(e)).filter(bs)}function $r(t){return t.valueExpression==="$view.scale"?null:{binding:di(t.type),field:t.field,normalizationField:t.normalizationField,expression:t.valueExpression,valueRepresentation:t.valueRepresentation}}function Kr(t){return{binding:di(t.type),field:t.field,normalizationField:t.normalizationField,expression:t.valueExpression}}function Xr(t){return{binding:di(t.type),field:t.field,normalizationField:t.normalizationField,expression:t.valueExpression}}function Yr(t){return{binding:di(t.type),expression:t.valueExpression,field:t.field}}function Qr(t){switch(t.type){case"size":return $r(t);case"color":return Kr(t);case"opacity":return Xr(t);case"rotation":return Yr(t)}}class Jr{constructor(){this.type="override-batch",this.messages=[],this._resovler=ws()}get promise(){return this._resovler.promise}resolve(){this._resovler.resolve()}add(e){this.messages.push(e)}}class tn{constructor(e){this.updateTracking=new Fs({debugName:"FeatureCommandQueue"}),this.process=e.process,this._queueProcessor=new da({concurrency:1,process:async i=>{if(i.type==="override-batch"){const o=this._nextOverrideBatch;if(o==null)throw new Error("InternalError: Override should be defined");return this._nextOverrideBatch=null,await this.process(o),void o.resolve()}return this.process(i)}})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return xs(this.updateTracking.addPromise(this._doPush(e)))}async _doPush(e){const i=this._queueProcessor,o=i.last();switch(e.type){case"update":case"highlight":return o?.type===e.type?void 0:i.push(e);case"override":case"edit":return this._pushOverride(e)}}_pushOverride(e){return this._nextOverrideBatch==null&&(this._nextOverrideBatch=new Jr,this._queueProcessor.push(this._nextOverrideBatch)),this._nextOverrideBatch.add(e),this._nextOverrideBatch.promise}}export{Qo as A,K as F,ps as L,ns as M,ls as P,os as V,tn as a,Ot as b,Zo as c,as as d,Li as e,es as f,Fr as g,Or as h,Vr as i,Ei as j,us as k,We as l,ci as m,bo as n,go as o,is as p,yr as q,ts as r,Wr as s,qr as t,fr as u,Cr as x,rs as y,ss as z};
