import{da as I,k as P,ab as w,H as k,G as m,db as h,dc as S,dd as p,de as d,z as x,df as v,bS as E}from"./main-CSjwO60s.js";import{fromJSON as O}from"./jsonUtils-5anAqpiW.js";import{g as F}from"./FeatureSet-BIUKCqNW.js";const M={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function J(n){const r=n.folders||[],o=r.slice(),t=new Map,s=new Map,u=new Map,y=new Map,c=new Map,f={esriGeometryPoint:s,esriGeometryPolyline:u,esriGeometryPolygon:y};(n.featureCollection?.layers||[]).forEach(e=>{const l=m(e);l.featureSet.features=[];const a=e.featureSet.geometryType;t.set(a,l);const g=e.layerDefinition.objectIdField;a==="esriGeometryPoint"?b(s,g,e.featureSet.features):a==="esriGeometryPolyline"?b(u,g,e.featureSet.features):a==="esriGeometryPolygon"&&b(y,g,e.featureSet.features)}),n.groundOverlays&&n.groundOverlays.forEach(e=>{c.set(e.id,e)}),r.forEach(e=>{e.networkLinkIds.forEach(l=>{const a=z(l,e.id,n.networkLinks);a&&o.push(a)})}),o.forEach(e=>{if(e.featureInfos){e.points=m(t.get("esriGeometryPoint")),e.polylines=m(t.get("esriGeometryPolyline")),e.polygons=m(t.get("esriGeometryPolygon")),e.mapImages=[];for(const l of e.featureInfos)switch(l.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const a=f[l.type].get(l.id);a&&e[M[l.type]]?.featureSet.features.push(a);break}case"GroundOverlay":{const a=c.get(l.id);a&&e.mapImages.push(a);break}}e.fullExtent=G([e])}});const i=G(o);return{folders:r,sublayers:o,extent:i}}function N(n,r,o,t){const s=P?.findCredential(n);n=I(n,{token:s?.token});const u=w.kmlServiceUrl;return k(u,{query:{url:n,model:"simple",folders:"",refresh:o!==0||void 0,outSR:JSON.stringify(r)},responseType:"json",signal:t})}function T(n,r,o=null,t=[]){const s=[],u={},y=r.sublayers,c=new Set(r.folders.map(f=>f.id));return y.forEach(f=>{const i=new n;if(o?i.read(f,o):i.read(f),t.length&&c.has(i.id)&&(i.visible=t.includes(i.id)),u[f.id]=i,f.parentFolderId!=null&&f.parentFolderId!==-1){const e=u[f.parentFolderId];e.sublayers||(e.sublayers=[]),e.sublayers?.unshift(i)}else s.unshift(i)}),s}function b(n,r,o){o.forEach(t=>{n.set(t.attributes[r],t)})}function j(n,r){let o;return r.some(t=>t.id===n&&(o=t,!0)),o}function z(n,r,o){const t=j(n,o);return t&&(t.parentFolderId=r,t.networkLink=t),t}async function L(n,r,o,t){const s=n[r];if(!s)return[];const u=F.fromJSON(s.featureSet).features,y=s.layerDefinition,c=O(y.drawingInfo.renderer),f=E.fromJSON(s.popupInfo),i=[];for(const e of u){const l=await c.getSymbolAsync(e);e.symbol=l,e.popupTemplate=f,e.visible=!0;const a=o.sublayerById.get(t);e.origin=a.origin,i.push(e)}return i}function G(n){const r=h(S),o=h(S);for(const t of n){if(t.polygons?.featureSet?.features)for(const s of t.polygons.featureSet.features)p(r,s.geometry),d(o,r);if(t.polylines?.featureSet?.features)for(const s of t.polylines.featureSet.features)p(r,s.geometry),d(o,r);if(t.points?.featureSet?.features)for(const s of t.points.featureSet.features)p(r,s.geometry),d(o,r);if(t.mapImages)for(const s of t.mapImages)p(r,s.extent),d(o,r)}return v(o,S)?void 0:{xmin:o[0],ymin:o[1],zmin:o[2],xmax:o[3],ymax:o[4],zmax:o[5],spatialReference:x.WGS84}}export{G as I,T as S,L as b,J as d,N as g};
