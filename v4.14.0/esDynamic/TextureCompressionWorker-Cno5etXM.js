import{eP as _}from"./main-CSjwO60s.js";import{Y as w}from"./enums-DDJfd4_p.js";function B(){return y??=(async()=>{const e=await import("./basis_encoder-BioYXz2m.js"),t=await e.default({locateFile:n=>_(`esri/libs/basisu/${n}`)});return t.initializeBasis(),t})(),y}let y;function F(){y=null}function M(){return T??=(async()=>await(await import("./dxt_encoder-P9_YitA5.js")).default({locateFile:e=>_(`esri/libs/dxtEncoder/${e}`)}))(),T}let T;function R(){T=null}let A,C,o=null,f=null;class m{constructor(t,n){this.internalFormat=t,this.compressedTexture=n}}function U(){o=null,A=null,f=null,C=null,F(),R()}async function G(e){let t;t=e.data instanceof ImageBitmap?I(e.data):O(e.data,e.width,e.height,e.components,e.needsFlip);try{if(e.hasS3TC){f||await g();const n=new Uint8Array(t.length);if(f?.encode(t,e.width,e.height,e.preMultiplyAlpha,n)){const a=q(n,!0),u=[n.buffer];return{result:new m(a?.internalFormat??null,a?.textureData??null),transferList:u}}return{result:new m(null,null)}}if(e.hasETC){if(o||await b(),e.preMultiplyAlpha&&!f&&await g(),e.preMultiplyAlpha){const s=new Uint8ClampedArray(t.length);f?.premultiply(new Uint8Array(t),e.width,e.height,s),t=s}const n=X(t,e.width,e.height,e.hasMipmap),a=n?x(n):null,u=a?.compressedTexture?.levels.map(s=>s.buffer)||[];return{result:new m(a?.internalFormat??null,a?.compressedTexture??null),transferList:u}}return{result:new m(null,null)}}finally{t instanceof ImageBitmap&&t.close()}}async function b(){o||(o=await(A??=B()),A=null)}async function g(){f||(f=await(C??=M()),C=null)}function X(e,t,n,a,u=255,s=0,l=!1,i=!1){if(!o)return null;const r=new o.BasisEncoder;r.setPerceptual(!i),r.setCheckForAlpha(!0),r.setForceAlpha(!1),r.setRenormalize(i),r.setMipGen(a),r.setMipSRGB(!i),r.setCreateKTX2File(!0),r.setKTX2SRGBTransferFunc(!i),r.setQualityLevel(u),r.setCompressionLevel(s);const c=new Uint8Array(e.byteLength);r.setSliceSourceImage(0,new Uint8Array(e),t,n,l);const d=r.encode(c),h=new Uint8Array(c.buffer,0,d),p=new o.KTX2File(new Uint8Array(h));return p.isValid()?(r.delete(),h):(p.close(),p.delete(),r.delete(),null)}function x(e){if(!o)return new m(null,null);const t=new o.KTX2File(new Uint8Array(e));t.startTranscoding();const[n,a]=t.getHasAlpha()?[1,w.COMPRESSED_RGBA8_ETC2_EAC]:[0,w.COMPRESSED_RGB8_ETC2],u=t.getLevels(),s=[];for(let l=0;l<u;l++)s.push(new Uint8Array(t.getImageTranscodedSizeInBytes(l,0,0,n))),t.transcodeImage(s[l],l,0,0,n,0,-1,-1);return t.close(),t.delete(),{internalFormat:a,compressedTexture:{type:"compressed",levels:s}}}function I(e){const t=new OffscreenCanvas(e.width,e.height),n=t.getContext("2d");return n.drawImage(e,0,0),n.getImageData(0,0,t.width,t.height).data}function O(e,t,n,a,u){const s=new Uint8ClampedArray(e).subarray(0,t*n*a);if(!u)return s;const l=new Uint8ClampedArray(s.length),i=t*a;for(let r=0;r<n;r++){const c=r*i,d=(n-r-1)*i;l.set(s.subarray(c,c+i),d)}return l}const v=31,P=1,K=2,L=3,k=4,z=7,$=21,H=131072;function E(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}const Q=E("DXT1"),V=E("DXT3"),j=E("DXT5");function q(e,t){const n=new Int32Array(e.buffer,e.byteOffset,v);let a,u;switch(n[$]){case Q:a=8,u=w.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case V:a=16,u=w.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case j:a=16,u=w.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return null}let s=1,l=n[k],i=n[L];(3&l||3&i)&&(l=l+3&-4,i=i+3&-4);const r=l,c=i;let d,h;n[K]&H&&t!==!1&&(s=Math.max(1,n[z]));let p=e.byteOffset+n[P]+4;const S=[];for(let D=0;D<s;++D)h=(l+3>>2)*(i+3>>2)*a,d=new Uint8Array(e.buffer,p,h),S.push(d),p+=h,l=Math.max(1,l>>1),i=Math.max(1,i>>1);return{textureData:{type:"compressed",levels:S},internalFormat:u,width:r,height:c}}export{m as TextureCompressionWorkerOutput,G as compress,X as compressRGBADataToKTX2,x as createTextureDataKTX2,U as destroy,b as initializeBasisEncoder,g as initializeDXTEncoder};
