import{cs as p,bE as g,I as E,H as b,bv as I}from"./main-CSjwO60s.js";import{P as j}from"./normalizeUtils-DK5542Ty.js";import{t as R}from"./pbfQueryUtils-DYXcN4x1.js";import{t as q}from"./queryZScale-B66ZWsfS.js";function m(t){const n={};for(const i in t){if(i==="declaredClass")continue;const a=t[i];if(a!=null&&typeof a!="function")if(Array.isArray(a)){n[i]=[];for(let s=0;s<a.length;s++)n[i][s]=m(a[s])}else typeof a=="object"?a.toJSON&&(n[i]=JSON.stringify(a)):n[i]=a}return n}function F(t,n){if(n&&t.type==="extent")return`${t.xmin},${t.ymin},${t.xmax},${t.ymax}`;if(n&&t.type==="point")return`${t.x},${t.y}`;const i=t.toJSON();return delete i.spatialReference,JSON.stringify(i)}function S(t,n,i){const{geometry:a}=t,s=t.compactGeometryEnabled??!1,e=t.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const r=e;let u,o,l;if(a&&(o=a.spatialReference,l=p(o),r.geometryType=g(a),r.geometry=F(a,s),r.inSR=l),e.groupByFieldsForStatistics&&(r.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds)switch(i?.uniqueIdFields?.length){case void 0:r.objectIds=e.objectIds.join(",");break;case 1:r.uniqueIds=JSON.stringify(e.objectIds),delete r.objectIds;break;default:r.uniqueIds=JSON.stringify(e.objectIds.map(c=>JSON.parse(c))),delete r.objectIds}if(e.orderByFields&&(r.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&(n?.returnCountOnly||n?.returnExtentOnly||n?.returnIdsOnly)?delete r.outFields:e.outFields.includes("*")?r.outFields="*":r.outFields=e.outFields.join(","),e.outSR?(r.outSR=p(e.outSR),u=t.outSpatialReference):a&&(e.returnGeometry||e.returnCentroid)&&(r.outSR=r.inSR,u=o),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(r.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(r.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(r.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(t.defaultSpatialReferenceEnabled&&o!=null&&t.quantizationParameters?.extent!=null&&o.equals(t.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,r.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(r.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(r.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(r.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const c=e.timeExtent,{start:y,end:f}=c;y==null&&f==null||(r.time=y===f?y:`${y??"null"},${f??"null"}`),delete e.timeExtent}return t.defaultSpatialReferenceEnabled&&o!=null&&u!=null&&o.equals(u)&&(r.defaultSR=r.inSR,delete r.inSR,delete r.outSR),r}const O="Layer does not support extent calculation.";function J(t,n,i){return S(t,n,i)}async function N(t,n,i,a,s){const e=n.timeExtent?.isEmpty?{data:{features:[]}}:await d(t,n,"json",a,void 0,s);return q(n,i,e.data),e}async function w(t,n,i,a,s){if(n.timeExtent?.isEmpty)return{data:i.createFeatureResult()};const e=await x(t,n,a,s),r=e;return r.data=R(e.data,i),r}function x(t,n,i,a){return d(t,n,"pbf",i,void 0,a)}function P(t,n,i,a){return n.timeExtent?.isEmpty?Promise.resolve({data:{objectIds:[]}}):d(t,n,"json",i,{returnIdsOnly:!0},a)}function z(t,n,i,a){return n.timeExtent?.isEmpty?Promise.resolve({data:{count:0}}):d(t,n,"json",i,{returnIdsOnly:!0,returnCountOnly:!0},a)}async function $(t,n,i){if(n.timeExtent?.isEmpty)return{data:{count:0,extent:null}};const a=await d(t,n,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}),s=a.data;if(s.hasOwnProperty("extent"))return a;if(s.features)throw new Error(O);if(s.hasOwnProperty("count"))throw new Error(O);return a}function h(t,n){if(!t.returnIdsOnly||!n.uniqueIdFields)return t;const i={...t,returnUniqueIdsOnly:!0};return delete i.returnIdsOnly,i}async function d(t,n,i,a={},s={},e={}){const r=typeof t=="string"?E(t):t,u=n.geometry?[n.geometry]:[],o=await j(u,null,{signal:a.signal}),l=o?.[0];l!=null&&((n=n.clone()).geometry=l);const c=m({...r.query,f:i,...h(s,e),...J(n,s,e)});return b(I(r.path,V(n,s)?"query3d":"query"),{...a,responseType:i==="pbf"?"array-buffer":"json",query:{...c,...a.query}})}function V(t,n){return t.formatOf3DObjects!=null&&!(n.returnCountOnly||n.returnExtentOnly||n.returnIdsOnly)}export{x as c,$ as d,w as f,P as m,z as p,S as r,m as t,N as y};
