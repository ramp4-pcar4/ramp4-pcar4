import{s as L,H as U,bA as S,ba as _,cS as q,d4 as G,gn as D,cR as C,go as M,gp as H,dY as N}from"./main-CSjwO60s.js";import{r as k}from"./vec4f64-DD-nkcCV.js";import{g as K,u as Q,p as Y,h as J}from"./MeshComponent-BEAtZpvD.js";import{c as W}from"./MeshVertexAttributes-SXUaA7ll.js";import{l as $}from"./meshVertexSpaceUtils-EbHpWZGf.js";import{T as j,g as A,M as X,O,o as R,V as Z,y as ee,U as te}from"./BufferView-B6RYETl3.js";import{e as oe,f as re,s as ne,u as F}from"./vec3-DXB2oTmo.js";import{n as se,u as ae,c as I}from"./vec4-Dua3dSaz.js";import{e as le}from"./types-l27bT09Q.js";import{loadGLTF as ue}from"./loader-DBZkumMs.js";import{l as fe,o as ie,a as ce,b as pe}from"./indexUtils-BOzySSm0.js";import{q as de}from"./vertexSpaceConversion-okU9QrPr.js";import{t as me}from"./resourceUtils-DV37Keuk.js";function ye(e,t,o){const a=e.typedBuffer,l=e.typedBufferStride,r=t.typedBuffer,s=t.typedBufferStride,n=o?o.count:t.count;let u=(o?.dstIndex??0)*l,i=(o?.srcIndex??0)*s;for(let c=0;c<n;++c){for(let f=0;f<9;++f)a[u+f]=r[i+f];u+=l,i+=s}}Object.freeze(Object.defineProperty({__proto__:null,copy:ye},Symbol.toStringTag,{value:"Module"}));function ge(e,t,o){const a=e.typedBuffer,l=e.typedBufferStride,r=t.typedBuffer,s=t.typedBufferStride,n=o?o.count:t.count;let u=(o?.dstIndex??0)*l,i=(o?.srcIndex??0)*s;for(let c=0;c<n;++c){for(let f=0;f<16;++f)a[u+f]=r[i+f];u+=l,i+=s}}Object.freeze(Object.defineProperty({__proto__:null,copy:ge},Symbol.toStringTag,{value:"Module"}));function xe(e,t){z(e.typedBuffer,t.typedBuffer,e.typedBufferStride,t.typedBufferStride)}function z(e,t,o=3,a=o){const l=t.length/a;let r=0,s=0;for(let n=0;n<l;++n)e[r]=t[s],e[r+1]=t[s+1],e[r+2]=t[s+2],r+=o,s+=a}function E(e,t,o,a,l){const r=e.typedBuffer,s=e.typedBufferStride,n=l?.count??e.count;let u=(l?.dstIndex??0)*s;for(let i=0;i<n;++i)r[u]=t,r[u+1]=o,r[u+2]=a,u+=s}Object.freeze(Object.defineProperty({__proto__:null,copy:z,copyView:xe,fill:E},Symbol.toStringTag,{value:"Module"}));function Te(e,t){P(e.typedBuffer,t,e.typedBufferStride)}function P(e,t,o=4){const a=t.typedBuffer,l=t.typedBufferStride,r=t.count;let s=0,n=0;for(let u=0;u<r;++u)e[s]=a[n],e[s+1]=a[n+1],e[s+2]=a[n+2],e[s+3]=a[n+3],s+=o,n+=l}function b(e,t,o,a,l,r){const s=e.typedBuffer,n=e.typedBufferStride,u=r?.count??e.count;let i=(r?.dstIndex??0)*n;for(let c=0;c<u;++c)s[i]=t,s[i+1]=o,s[i+2]=a,s[i+3]=l,i+=n}Object.freeze(Object.defineProperty({__proto__:null,copy:P,copyView:Te,fill:b},Symbol.toStringTag,{value:"Module"}));function g(e,t){return new e(new ArrayBuffer(t*e.ElementCount*le(e.ElementType)))}async function be(e,t,o){const a=new fe(Be(o)),l=await ue(a,t,o,!0),r=l.model,s=r.lods.shift(),n=new Map,u=new Map;r.textures.forEach((y,h)=>n.set(h,ve(y))),r.materials.forEach((y,h)=>u.set(h,Se(y,n)));const i=we(s);for(const y of i.parts)_e(i,y,u);const{position:c,normal:f,tangent:p,color:d,texCoord0:B}=i.vertexAttributes,T=$(e,o),w=e.spatialReference.isGeographic?$(e):T,v=de({vertexAttributes:{position:c.typedBuffer,normal:f?.typedBuffer,tangent:p?.typedBuffer},vertexSpace:w,spatialReference:e.spatialReference},T,{allowBufferReuse:!0,sourceUnit:o?.unitConversionDisabled?void 0:"meters"});if(!v)throw new L("load-gltf-mesh:vertex-space-projection",`Failed to load mesh from glTF because we could not convert the vertex space from ${w.type} to ${T.type}`);return{mesh:{transform:null,vertexSpace:T,components:i.components,spatialReference:e.spatialReference,vertexAttributes:new W({...v,color:d?.typedBuffer,uv:B?.typedBuffer})},meta:l.meta}}function Be(e){const t=e?.resolveFile;return t?{busy:!1,request:async(o,a,l)=>{const r=t?.(o)??o;return(await U(r,{responseType:a===2?"image":a===1||a===3?"array-buffer":"json",signal:l?.signal,timeout:0})).data}}:null}function x(e,t){if(e==null)return"-";const o=e.typedBuffer;return`${_(t,o.buffer,()=>t.size)}/${o.byteOffset}/${o.byteLength}`}function he(e){return e!=null?e.toString():"-"}function we(e){let t=0;const o={color:!1,tangent:!1,normal:!1,texCoord0:!1},a=new Map,l=new Map,r=[];for(const s of e.parts){const{position:n,normal:u,color:i,tangent:c,texCoord0:f}=s.attributes,p=`
      ${x(n,a)}/
      ${x(u,a)}/
      ${x(i,a)}/
      ${x(c,a)}/
      ${x(f,a)}/
      ${he(s.transform)}
    `;let d=!1;const B=_(l,p,()=>(d=!0,{start:t,length:n.count}));d&&(t+=n.count),u&&(o.normal=!0),i&&(o.color=!0),c&&(o.tangent=!0),f&&(o.texCoord0=!0),r.push({gltf:s,writeVertices:d,region:B})}return{vertexAttributes:{position:g(te,t),normal:o.normal?g(R,t):null,tangent:o.tangent?g(j,t):null,color:o.color?g(A,t):null,texCoord0:o.texCoord0?g(ee,t):null},parts:r,components:[]}}function ve(e){return new K({data:(me(e.data),e.data),wrap:$e(e.parameters.wrap)})}function Se(e,t){const o=new S(je(e.color,e.opacity)),a=e.emissiveFactor?new S(Ae(e.emissiveFactor)):null,l=r=>r?new Y({scale:r.scale?[r.scale[0],r.scale[1]]:[1,1],rotation:G(r.rotation??0),offset:r.offset?[r.offset[0],r.offset[1]]:[0,0]}):null;return new Q({color:o,colorTexture:t.get(e.colorTexture),normalTexture:t.get(e.normalTexture),emissiveColor:a,emissiveTexture:t.get(e.emissiveTexture),occlusionTexture:t.get(e.occlusionTexture),alphaMode:Me(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:t.get(e.metallicRoughnessTexture),colorTextureTransform:l(e.colorTextureTransform),normalTextureTransform:l(e.normalTextureTransform),occlusionTextureTransform:l(e.occlusionTextureTransform),emissiveTextureTransform:l(e.emissiveTextureTransform),metallicRoughnessTextureTransform:l(e.metallicRoughnessTextureTransform)})}function _e(e,t,o){t.writeVertices&&Ce(e,t);const{indices:a,attributes:l,primitiveType:r,material:s}=t.gltf;let n=ie(a||l.position.count,r);const u=t.region.start;if(u){const i=new Uint32Array(n);for(let c=0;c<n.length;c++)i[c]+=u;n=i}e.components.push(new J({name:t.gltf.name,faces:n,material:o.get(s),shading:l.normal?"source":"flat",trustSourceNormals:!0}))}function Ce(e,t){const{position:o,normal:a,tangent:l,color:r,texCoord0:s}=e.vertexAttributes,n=t.region.start,{attributes:u,transform:i}=t.gltf,c=u.position.count;if(oe(o.slice(n,c),u.position,i),u.normal!=null&&a!=null){const f=D(C(),i),p=a.slice(n,c);re(p,u.normal,f),M(f)&&ne(p,p)}else a!=null&&E(a,0,0,1,{dstIndex:n,count:c});if(u.tangent!=null&&l!=null){const f=H(C(),i),p=l.slice(n,c);se(p,u.tangent,f),M(f)&&ae(p,p)}else l!=null&&b(l,0,0,1,1,{dstIndex:n,count:c});if(u.texCoord0!=null&&s!=null?ce(s.slice(n,c),u.texCoord0):s!=null&&pe(s,0,0,{dstIndex:n,count:c}),u.color!=null&&r!=null){const f=u.color,p=r.slice(n,c);if(f.elementCount===4)f instanceof j?I(p,f,1,255):(f instanceof A||f instanceof X)&&I(p,f,1/255,255);else{b(p,255,255,255,255);const d=O.fromTypedArray(p.typedBuffer,p.typedBufferStride);f instanceof R?F(d,f,1,255):(f instanceof O||f instanceof Z)&&F(d,f,1/255,255)}}else r!=null&&b(r.slice(n,c),255,255,255,255)}function Me(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function $e(e){return{horizontal:V(e.s),vertical:V(e.t)}}function V(e){switch(e){case 33071:return"clamp";case 33648:return"mirror";case 10497:return"repeat"}}function m(e){return e**(1/N)*255}function je(e,t){return k(m(e[0]),m(e[1]),m(e[2]),t)}function Ae(e){return q(m(e[0]),m(e[1]),m(e[2]))}export{be as loadGLTFMesh};
