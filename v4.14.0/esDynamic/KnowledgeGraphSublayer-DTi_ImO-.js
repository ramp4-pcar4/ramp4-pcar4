import{z as oe,l5 as J,H as xe,ba as q,s as P,bQ as ut,eP as ct,a0 as Fe,N as Re,i as Ae,d as yt,dE as Q,ch as le,jv as Oe,aH as je,_ as c,X as y,Y as pe,iS as ht,iZ as mt,hT as ee,bA as $e,ed as ft,jX as qe,eS as gt,dP as te,i$ as bt,bG as wt,aG as Tt,cl as It,at as Et,G as O,bS as _t,a5 as Nt}from"./main-CSjwO60s.js";import{e as vt}from"./OptimizedGeometry-BYxlP_oK.js";import{i as fe,r as St,n as ge,a as Z,l as Lt,V as Mt}from"./knowledgeGraphService-CuOTexj3.js";import{N as de,W as ie}from"./projectionUtils-CsX1UTBu.js";import{I as ue,t as ce,_ as A,E as re,S as be,o as we}from"./constants-DVYXs0Da.js";import{u as kt}from"./featureConversionUtils-CZmIxyv5.js";import{s as Ge}from"./OptimizedFeature-C33SioFK.js";import"./GraphicsLayer-DPoztXf7.js";import{p as z,a as Pe,i as Ue}from"./Relationship-CxaLXN7a.js";import{b as Y}from"./Query-DKLDaFaA.js";import{l as Dt}from"./MultiOriginJSONSupport-DNNJhlNT.js";import{E as Ct}from"./workers-CixlqDQM.js";import{s as He,o as Qe}from"./GraphicOrigin-BZpgptRb.js";import{f as xt}from"./FeatureStore-yiKuYgT-.js";import{W as Ft}from"./QueryEngine-CHUxUulR.js";import{u as ze}from"./clientSideDefaults-BTftx6ta.js";import{s as Rt}from"./fieldProperties-B4tOVJmv.js";import{l as At,F as Ot}from"./FormTemplate-VNQ04sPR.js";import{P as jt}from"./normalizeUtils-DK5542Ty.js";import{s as $t,t as qt}from"./QueryEngineCapabilities-DPRPXYxY.js";import{a as Gt}from"./FeatureTemplate-DN-lMS1p.js";import{A as K,d as se,l as Pt}from"./labelingInfo-jIy5P_vY.js";import{p as Ut,n as Ht,l as Qt}from"./BlendLayer-D8oJmNCO.js";import{a as zt,p as Wt,l as Bt}from"./DisplayFilteredLayer-Ce0lf91Z.js";import{c as Vt,p as Jt}from"./FeatureEffectLayer-Bw8pqFtl.js";import{f as Zt,a as Yt}from"./FeatureReductionLayer-fRVzjp_G.js";import{p as Kt,c as Xt}from"./OrderedLayer-BpzV2gVo.js";import{f as ei}from"./RefreshableLayer-BEBm0YMm.js";import{t as ti}from"./ScaleRangeLayer-DkZwCH6_.js";import{l as ii,f as ri}from"./TemporalLayer-D43PzGI2.js";import{d as si,v as ni,j as ai,w as oi,l as li}from"./OperationalLayer-Ds0FQSCg.js";import{m as ye}from"./Field-Dn1Bgq7n.js";import{u as pi}from"./TimeInfo-BoebCPJB.js";import{p as di}from"./SimpleRenderer-DSyBXxyY.js";import{fromJSON as We}from"./jsonUtils-5anAqpiW.js";import{m as ui}from"./typeUtils-BTAsL08-.js";import{g as ci}from"./FeatureSet-BIUKCqNW.js";import{d as yi}from"./popupUtils-D0h6TFFF.js";import{L as Be}from"./utils-DvP1Tc7W.js";let hi=class{constructor(){this.version="",this.queryResult=new mi}},mi=class{constructor(){this.featureResult=new fi}},fi=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new gi,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new bi,this.geometryType=null,this.spatialReference=new oe,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new Ve,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},gi=class{constructor(){this.name="",this.isSystemMaintained=!1}},bi=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},Ve=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new wi,this.translate=new Ti}},wi=class{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}},Ti=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},Ii=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},Ei=class{constructor(){this.attributes=[],this.compressedGeometry=new Te,this.centroid=new Te,this.aggregateGeometries=[]}},Te=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};const _i=["ELEMENTUID","TYPENAME"],Ni={upperLeft:0,lowerLeft:1},vi={sqlTypeBigInt:0,sqlTypeBinary:1,sqlTypeBit:2,sqlTypeChar:3,sqlTypeDate:4,sqlTypeDecimal:5,sqlTypeDouble:6,sqlTypeFloat:7,sqlTypeGeometry:8,sqlTypeGUID:9,sqlTypeInteger:10,sqlTypeLongNVarchar:11,sqlTypeLongVarbinary:12,sqlTypeLongVarchar:13,sqlTypeNChar:14,sqlTypeNVarChar:15,sqlTypeOther:16,sqlTypeReal:17,sqlTypeSmallInt:18,sqlTypeSqlXml:19,sqlTypeTime:20,sqlTypeTimestamp:21,sqlTypeTimestamp2:22,sqlTypeTinyInt:23,sqlTypeVarbinary:24,sqlTypeVarchar:25};function Si(t){const e=new hi;e.version=t.version;const r=t.get_query_result();if(r.results_type.value!==0)throw new Error("Got a non-feature collection type");const i=r.get_feature_result(),s=e.queryResult.featureResult;s.objectIdFieldName=i.objectid_field_name,s.exceededTransferLimit=i.exceeded_transfer_limit,s.hasM=i.has_m,s.hasZ=i.has_z,s.geometryType=J(fe,i.geometry_type.value),s.globalIdFieldName=i.globalid_field_name,s.geohashFieldName=i.geohash_field_name;const n=s.uniqueIdField,p=i.unique_id_field;n.name=p.name,n.isSystemMaintained=p.isSystemMaintained;const d=s.geometryProperties,m=i.geometry_properties;d.shapeAreaFieldName=m.shapeAreaFieldName,d.shapeLengthFieldName=m.shapeLengthFieldName,d.units=m.units;const a=s.spatialReference,o=i.spatial_reference;a.wkid=o.wkid,a.latestWkid=o.latestWkid,a.vcsWkid=o.vcsWkid,a.latestVcsWkid=o.latestVcsWkid,a.wkt=o.wkt,s.transform=Mi(i.transform);const l=s.fields,u=s.fieldNameToAttributeIndexMap,h=i.fields,g=h.size();for(let v=0;v<g;v++){const M=h.get(v),L=Je(M);l.push(L),u[L.name]=v,M.delete()}h.delete();const f=s.values,S=i.values_count();for(let v=0;v<S;v++)f.push(i.get_value_at(v));const N=s.features,I=i.features,_=I.size();if(_>0){for(const v of _i)if(u[v]===void 0)throw new Error(`Feature collection missing required attribute: ${v}`)}for(let v=0;v<_;v++){const M=new Ei,L=I.get(v),G=M.attributes,k=L.attributes_count();for(let H=0;H<k;H++)G.push(L.get_attribute_at(H));const F=L.get_compressed_geometry();F&&(M.compressedGeometry=Ie(F),M.centroid=Ie(L.get_centroid()));const C=M.aggregateGeometries,R=L.aggregate_geometries,x=R.size();for(let H=0;H<x;H++){const V=R.get(H),X=Ie(V);C.push(X),V.delete()}R.delete(),N.push(M),L.delete()}I.delete();const D=s.geometryFields,E=i.geometry_fields,w=E.size();for(let v=0;v<w;v++){const M=E.get(v),L=Li(M);D.push(L),M.delete()}return E.delete(),e}function Ie(t){const e=new Te;e.geometryType=J(fe,t.geometry_type.value);const r=[],i=[];for(let s=0;s<t.lengths.length;s++)r.push(t.lengths[s]);for(let s=0;s<t.coords.length;s++)i.push(t.coords[s]);return e.lengths=r,e.coords=i,e}function Je(t){const e=new Ii;return e.name=t.name,e.alias=t.alias,e.fieldType=J(St,t.field_type.value),e.sqlType=J(vi,t.sql_type.value),e.domain=t.domain,e.defaultValue=t.default_value,e}function Li(t){const e=Je(t);return e.geometryType=J(fe,t.geometry_type.value),e}function Mi(t){const e=new Ve;e.quantizeOriginPosition=J(Ni,t.quantizeOriginPosition.value);const r=e.scale,i=t.scale;r.xScale=i.xScale,r.yScale=i.yScale,r.mScale=i.mScale,r.zScale=i.zScale;const s=e.translate,n=t.translate;return s.xTranslate=n.xTranslate,s.yTranslate=n.yTranslate,s.mTranslate=n.mTranslate,s.zTranslate=n.zTranslate,e}async function ki(t){const e=[],r={generateAllSublayers:!1,namedTypeDefinitions:new Map};return t.entitiesUrl&&e.push(Ze(t.entitiesUrl).then(i=>{Ye(i,r)})),t.relationshipsUrl&&e.push(Ze(t.relationshipsUrl).then(i=>{Ye(i,r)})),await Promise.all(e),r}async function Di(t,e){e??=!1;const r={generateAllSublayers:e,namedTypeDefinitions:new Map};return await Ri(t).then(i=>{Oi(i,r)}),r}async function Ci(t){const e=await ge(),r=new e.MapOfObjectIdentifierSets;xi(r,e,t);const i=new e.MapOfObjectIdentifierSetsEncoder;try{i.set_map_of_identifier_sets(r),i.encode();const s=i.get_encoding_result();if(s.error.error_code!==0)throw new P("knowledge-graph:layer-support-utils",s.error.error_message);const n=structuredClone(s.get_byte_buffer());return i.delete(),n}finally{r.delete()}}function xi(t,e,r){for(const[i,s]of r.namedTypeDefinitions){if(!s.members||s.useAllData)continue;const n=s.members.keys();let p=!1,d=!0;const m=new e.ObjectIdArray,a=new e.StringArray,o=new e.GlobalIdArray,l=new e.IdentifierArray,u=new e.ObjectIdentifierSet;for(const h of n)d&&(p=!isNaN(Number(h)),d=!1),p?m.add_objectid(Number(h)):(a.add_string(h),o.add_globalid(h)),l.add_identifier(h);u.set_oid_array(m),u.set_string_array(a),u.set_globalid_array(o),u.set_identifier_array(l),m.delete(),a.delete(),o.delete(),l.delete(),t.put_identifier_set(i,u),u.delete()}return t}async function Ze(t){const e=await xe(t,{responseType:"array-buffer"});return Fi(await e.data)}async function Fi(t){const e=new(await ge()).FeatureCollectionDecoder,r=e.decode(new Uint8Array(t));if(r.error_code!==0)throw new P("knowledge-graph:layer-support-utils",r.error_message);const i=e.get_feature_collection(),s=Si(i);return e.delete(),s}async function Ri(t){const e=await xe(t,{responseType:"array-buffer"}),r=await e.data;return Ai(new Uint8Array(r))}async function Ai(t){const e=new(await ge()).MapOfObjectIdentifierSetsDecoder,r=e.decode(new Uint8Array(t)),i=new Map;if(r.error_code!==0)throw new P("knowledge-graph:layer-support-utils",r.error_message);const s=e.get_map_of_identifier_sets(),n=s.keys,p=n.size();for(let d=0;d<p;d++){const m=n.get(d),a=s.query_identifier_set(m),o=[];if(a.id_array_type.value===1){const l=a.get_globalid_array(),u=l.count();for(let h=0;h<u;h++)o.push(l.get_globalid_at(h))}else if(a.id_array_type.value===3){const l=a.get_identifier_array(),u=l.count();for(let h=0;h<u;h++)o.push(l.get_identifier_at(h).toString())}else if(a.id_array_type.value===2){const l=a.get_string_array(),u=l.count();for(let h=0;h<u;h++)o.push(l.get_string_at(h))}else{if(a.id_array_type.value!==0)throw new P("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const l=a.get_oid_array(),u=l.count();for(let h=0;h<u;h++)o.push(l.get_objectid_at(h).toString())}}i.set(m,o)}return e.delete(),i}function Ye(t,e){if(!t?.queryResult?.featureResult)return e;const r=t.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const i of t.queryResult.featureResult.features){const s=i.attributes[r.TYPENAME],n=q(e.namedTypeDefinitions,s,()=>({useAllData:!1,members:new Map})),p=i.attributes[r.ELEMENTUID];if(i.compressedGeometry?.coords?.length>0){let d=i.compressedGeometry.lengths;i.compressedGeometry.geometryType==="esriGeometryPoint"&&(d=[]),n.members.set(p,{id:p,linkChartLocation:new vt(d,i.compressedGeometry.coords)})}else n.members.set(p,{id:p})}return e}function Oi(t,e){for(const[r,i]of t){const s=q(e.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map}));for(const n of i)s.members.has(n)||s.members.set(n,{id:n})}return e}const ji={fetchAndConvertSerializedLinkChart:t=>ki(t)},Ee=(t,e)=>{if(t.type==="column-reference")return t.column===e.systemOidFieldName?"ID(n)":`n.${t.column}`;if(t.type==="string")return`'${t.value}'`;if(t.type==="number")return`${t.value}`;if(t.type==="binary-expression"&&e.supportedSqlTypes.has(t.left.type)&&e.supportedSqlTypes.has(t.right.type)&&e.supportedSqlOperators.has(t.operator))return`${Ee(t.left,e)} ${t.operator} ${Ee(t.right,e)}`;if(t.type==="binary-expression"&&t.operator==="LIKE"){let r="";if(t.left.type==="function"&&t.left.args.value[0].type==="column-reference")r+=`lower(n.${t.left.args.value[0].column})`;else{if(t.left.type!=="column-reference")return e.unsupportedOperationFound=!0,"";r+=`lower(n.${t.left.column})`}if(r+=" CONTAINS (",t.right.type!=="string")return e.unsupportedOperationFound=!0,"";{let i=t.right.value;i.startsWith("%")&&(i=i.slice(1)),i.endsWith("%")&&(i=i.slice(0,-1)),r+=`'${i.toLowerCase()}')`}return r}return e.unsupportedOperationFound=!0,""};let he=class B{constructor(){this._featureLookup=new Map}static getInstance(){return B.instance||(B.instance=new B),B.instance}static resetInstance(){B.instance&&(B.instance=null)}deleteFromStore(e){e.forEach(r=>{this._featureLookup.delete(r)})}readFromStoreByList(e){const r=[];return e.forEach(i=>{const s=this.readFromStoreById(i);s&&r.push(s)}),r}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,r,i){const s=[];return e.forEach(n=>{if(!n?.id)return;n.properties||(n.properties=[]);let p,d=null;if(i&&n.properties[i]&&(d=kt(n.properties[i])),"originId"in n&&"destinationId"in n&&(n.properties[ue]=n.originId,n.properties[ce]=n.destinationId),n.properties[r]=n.id,n.id&&this._featureLookup.has(n.id)&&this._featureLookup.get(n.id).attributes){const m=this._featureLookup.get(n.id),a=JSON.parse(JSON.stringify(Object.assign(m.attributes,n.properties)));i&&n.properties[i]&&(a[i]=ut(n.properties[i])),p=new Ge(d?JSON.parse(JSON.stringify(d)):m?.geometry?JSON.parse(JSON.stringify(m.geometry)):null,a,null,n.properties[r])}else p=new Ge(d?JSON.parse(JSON.stringify(d)):null,n.properties,null,n.properties[r]);this._featureLookup.set(`${n.typeName?`${n.typeName}__${n.id}`:n.id}`,p),s.push(p)}),s}},_e,T=null;function $i(){return _e||(_e=import("./lclayout-uHKPd4rG.js").then(t=>t.l).then(({default:t})=>t({locateFile:e=>ct(`esri/libs/linkchartlayout/${e}`)})).then(t=>{qi(t)}),_e)}function qi(t){T=t}const Ke={right:0,left:1,top:2,bottom:3},Xe={none:0,"start-only":1,"start-and-end":2};function Gi(t){const e={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...t?.toJSON(),eventsTicksVisualization:t?.eventsTicksVisualization??"start-and-end"};return{...e,timeDirection:{value:Ke[e.timeDirection]??Ke.right},eventsTicksVisualization:{value:Xe[e.eventsTicksVisualization]??Xe["start-and-end"]}}}function W(t,e,r,i,s,n){const p=r.length,d=s.length,m=Float64Array.BYTES_PER_ELEMENT,a=Uint32Array.BYTES_PER_ELEMENT,o=Uint8Array.BYTES_PER_ELEMENT,l=16,u=l+p*(o+2*m)+d*(2*a),h=T._malloc(u);try{const g=h+l-h%l,f=g+p*m,S=f+p*m,N=S+d*a,I=N+d*a,_=()=>[T.HEAPF64.subarray(g>>3,(g>>3)+p),T.HEAPF64.subarray(f>>3,(f>>3)+p),T.HEAPU32.subarray(S>>2,(S>>2)+d),T.HEAPU32.subarray(N>>2,(N>>2)+d),T.HEAPU8.subarray(I,I+p)],[D,E,w,v,M]=_();D.set(r),E.set(i),w.set(s),v.set(n),M.set(e);const L=t(p,I,g,f,d,S,N);let G=null,k=null;if(L.value===0){const V=T.getLayoutLinksTypes(),X=T.getLayoutLinksVerticesEndIndices(),me=T.getLayoutLinksVertices(),Ce=T.countLayoutLinksVertices();!d||V&&X?Ce&&!me?L.value=1:(G={types:new Uint8Array(T.HEAPU8.subarray(V,V+d)),vertexEndIndex:new Uint32Array(T.HEAPU32.subarray(X>>2,(X>>2)+d)),vertices:new Float64Array(T.HEAPF64.subarray(me>>3,(me>>3)+2*Ce))},k=T.getAuxiliaryGraphicElements()):L.value=1}const[F,C,R,x,H]=_();return r.set(F),i.set(C),s.set(R),n.set(x),e.set(H),{status:L.value,links:G,graphics:k}}finally{T._free(h),T.cleanupLayout()}}const et=2,tt=1,it=-1;var Ne,ve,Se,Le,Me,ke,De;(function(t){function e(){return T.getMinIdealEdgeLength()}function r(i,s,n,p,d,m,a=et,o=tt,l=it){return W((u,h,g,f,S,N,I)=>T.applyForceDirectedLayout(i,u,h,g,f,S,N,I,a,o,l),s,n,p,d,m)}t.getMinIdealEdgeLength=e,t.apply=r})(Ne||(Ne={})),function(t){function e(r,i,s,n,p,d,m=et,a=tt,o=it){return W((l,u,h,g,f,S,N)=>T.applyCommunityLayout(r,l,u,h,g,f,S,N,m,a,o),i,s,n,p,d)}t.apply=e}(ve||(ve={})),function(t){function e(r,i,s,n,p,d){return W((m,a,o,l,u,h,g)=>T.applySimpleLayout(r,m,a,o,l,u,h,g),i,s,n,p,d)}t.apply=e}(Se||(Se={})),function(t){function e(r,i,s,n,p,d){return W((m,a,o,l,u,h,g)=>T.applyHierarchicalLayout(r,m,a,o,l,u,h,g),i,s,n,p,d)}t.apply=e}(Le||(Le={})),function(t){function e(r,i,s,n,p,d){return W((m,a,o,l,u,h,g)=>T.applyRadialTreeLayout(r,m,a,o,l,u,h,g),i,s,n,p,d)}t.apply=e}(Me||(Me={})),function(t){function e(r,i,s,n,p,d){return W((m,a,o,l,u,h,g)=>T.applySmartTreeLayout(r,m,a,o,l,u,h,g),i,s,n,p,d)}t.apply=e}(ke||(ke={})),function(t){function e(r,i,s,n,p,d,m,a,o,l,u,h){return W((g,f,S,N,I,_,D)=>{if(p.length!==g)return{value:1};if(d.length!==g)return{value:1};if(o.length!==I)return{value:1};if(l.length!==I)return{value:1};const E=Float64Array.BYTES_PER_ELEMENT,w=16,v=T._malloc(w+g*E),M=T._malloc(w+g*E),L=T._malloc(w+I*E),G=T._malloc(w+I*E),k=v+w-v%w,F=M+w-M%w,C=L+w-L%w,R=G+w-G%w;try{return T.HEAPF64.subarray(k>>3,(k>>3)+g).set(p),T.HEAPF64.subarray(F>>3,(F>>3)+g).set(d),T.HEAPF64.subarray(C>>3,(C>>3)+I).set(o),T.HEAPF64.subarray(R>>3,(R>>3)+I).set(l),T.applyChronologicalLayout(r,g,f,S,N,k,F,I,_,D,C,R,u,Gi(h))}finally{T._free(v),T._free(M),T._free(L),T._free(G)}},i,s,n,m,a)}t.apply=e}(De||(De={})),Fe()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"}),Fe()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Pi=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function Ui(t,e){const r=new Map;if(e.dataModel?.relationshipTypes)for(const i of e.dataModel.relationshipTypes)i.name&&r.set(i.name,[]);for(const i of t)r.has(i.typeName)&&r.get(i.typeName)?.push(i.id);return r}async function Hi(t,e,r){const i=[],s=Ui(t,e),n={},p=[];for(const[o,l]of s){if(l.length<1)continue;const u=`${o}_ids`;n[u]=l,p.push(`MATCH (n)-[r:${o}]->(m) WHERE id(r) in $${u} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(p.length===0)return[];const d=p.join(" UNION "),m=new z({openCypherQuery:d,bindParameters:n}),a=(await Z(e,m,r?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:o,value:l}=await a.read();if(o)break;for(const u of l)i.push({id:u[0],typeName:u[1]}),i.push({id:u[2],typeName:u[3]})}return i}const Qi=t=>Pi.get(t)??"radial-root-centric";function zi(t){if(!t.spatialReference.isWGS84)throw new P("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return t.clone().normalize().map(e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]])}let $=class extends Re{constructor(t){super(t),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const e=new Map;t.knowledgeGraph.dataModel.entityTypes?.forEach(r=>{r.name&&(e.set(r.name,"entity"),this._processingCacheUpdatesLookup.set(r.name,[]),t.inclusionModeDefinition&&!t.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(r.name),r.properties?.forEach(i=>{i.geometryType&&i.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(r.name,{name:i.name??"",geometryType:i.geometryType})}))}),t.knowledgeGraph.dataModel.relationshipTypes?.forEach(r=>{r.name&&(e.set(r.name,"relationship"),this._processingCacheUpdatesLookup.set(r.name,[]),t.inclusionModeDefinition&&!t.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(r.name),r.properties?.forEach(i=>{i.geometryType&&i.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(r.name,{name:i.name??"",geometryType:i.geometryType})}))}),t.inclusionModeDefinition?.namedTypeDefinitions.forEach((r,i)=>{if(e.get(i)==="entity")this.entityTypeNames.add(i);else{if(e.get(i)!=="relationship")return Ae.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void t.inclusionModeDefinition?.namedTypeDefinitions.delete(i);this.relationshipTypeNames.add(i)}const s=new Map;r.members?.forEach(n=>{q(this.memberIdTypeLookup,n.id,()=>new Set).add(i)}),this.sublayerCaches.set(i,s)})}addToLayer(t){t.forEach(({typeName:e,id:r})=>{if(!this.inclusionModeDefinition)throw new P("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(e)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(e);i.members||(i.members=new Map),i.members.set(r,{id:r}),q(this.memberIdTypeLookup,r,()=>new Set).add(e)}}else{const i=new Map;i.set(r,{id:r}),this.inclusionModeDefinition.namedTypeDefinitions.set(e,{useAllData:!1,members:i}),q(this.memberIdTypeLookup,r,()=>new Set).add(e)}})}getById(t){return he.getInstance().readFromStoreById(t)}async getData(t,e,r){if(e.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(e.objectType.name))return[];let i;if(i=t||new Y({where:"1=1",outFields:["*"]}),e.parentCompositeLayer.type==="link-chart"){const s=e.parentCompositeLayer,n=this._processingCacheUpdatesLookup.get(e.objectType.name??""),p=i.outFields;p&&p.length===1&&p[0]===A&&i.where==="1=1"||await Promise.all(n??[]);const d=this.sublayerCaches.has(e.objectType.name??"")?Array.from(this.sublayerCaches.get(e.objectType.name)?.values()):[],m=[];return d.forEach(a=>{if(this.relationshipTypeNames.has(e.objectType.name)){a.geometry=s.relationshipLinkChartDiagramLookup.get(a.attributes[e.objectIdField]);const o=this.memberIdTypeLookup.get(a.attributes[ue]),l=this.memberIdTypeLookup.get(a.attributes[ce]),u=this._isEndEntitySpatial(o,a,ue),h=this._isEndEntitySpatial(l,a,ce);a.attributes[re]=Number(u&&h)}else{a.geometry=s.entityLinkChartDiagramLookup.get(a.attributes[e.objectIdField]);const o=this.geographicLookup.get(e.objectType.name);o&&a.attributes[o.name]?a.attributes[re]=1:a.attributes[re]=0}a.attributes[be]=a.geometry,m.push(a)}),m}return this.retrieveDataFromService(i,e,r)}async getConnectedRecordIds(t,e,r){const i=[];let s="";const n=this._getNamedTypeIdMapFromNodeIds(t);if(e&&e?.length!==0){for(const o of e)s=s+o+"|";s=s.slice(0,-1)}const p={},d=[];for(const[o,l]of n){const u=`${o}_ids`;p[u]=l,e&&e?.length!==0?d.push(`MATCH (n:${o}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r:${s}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):d.push(`MATCH (n:${o}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!d.length)return i;const m=d.join(" UNION "),a=(await Z(this.knowledgeGraph,new z({openCypherQuery:m,bindParameters:p}),{signal:r?.signal})).resultRowsStream.getReader();for(;;){const{done:o,value:l}=await a.read();if(o)break;for(let u=0;u<l.length;u++){const h=l[u];i.push({id:h[0],typeName:h[1]}),i.push({id:h[2],typeName:h[3]})}}return i}async getRelationshipsBetweenNodes(t,e,r){const i=this._getNamedTypeIdMapFromNodeIds(t);if(i.size===0)return[];const s={relationshipExclusionIds:e,possibleConnectionEntityIds:t},n=[];for(const[a,o]of i.entries()){const l=`${a}_ids`;s[l]=o,n.push(`MATCH (n:${a}) WHERE id(n) IN $${l} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const p=n.join(" UNION "),d=[],m=(await Z(this.knowledgeGraph,new z({openCypherQuery:p,bindParameters:s}),{signal:r?.signal})).resultRowsStream.getReader();for(;;){const{done:a,value:o}=await m.read();if(a)break;for(let l=0;l<o.length;l++){const u=o[l];d.push({id:u[0],typeName:u[1]})}}return d}async getRelationshipsFromNodes(t,e,r,i){const s=this._getNamedTypeIdMapFromNodeIds(t);if(s.size===0||e.length===0)return[];const n={relationshipExclusionIds:r,possibleConnectionEntityIds:e},p=[];for(const[l,u]of s.entries()){const h=`${l}_ids`;n[h]=u,p.push(`MATCH (n:${l}) WHERE id(n) IN $${h} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const d=p.join(" UNION "),m=new Map,a=(await Z(this.knowledgeGraph,new z({openCypherQuery:d,bindParameters:n}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:l,value:u}=await a.read();if(l)break;for(let h=0;h<u.length;h++){const g=u[h];let f=m.get(g[1]);f||(f=new Set,m.set(g[1],f)),f.add(g[0])}}const o=[];for(const[l,u]of m)for(const h of u)o.push({id:h,typeName:l});return o}async refreshCacheContent(t,e,r,i=!0,s){const n=he.getInstance(),p=[],d=new Map,m=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&m.set(a.name,a)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&m.set(a.name,a)}),t||this.inclusionModeDefinition?t?t.forEach(a=>{if(this.memberIdTypeLookup.has(a))for(const o of this.memberIdTypeLookup.get(a))d.has(o)?d.get(o)?.push(a):d.set(o,[a])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,o)=>{a.useAllData?d.set(o,null):a.members&&a.members.forEach(l=>{d.has(o)&&d.get(o)!==null?d.get(o)?.push(l.id):d.set(o,[l.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&d.set(a.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&d.set(a.name,null)}));for(const[a,o]of d){const l=new Set(o),u=new Promise((h,g)=>{(async()=>{const f=new Set,S=[];let N,I="",_=!1;if(e||m.get(a)?.properties?.forEach(w=>{w.name&&f.add(w.name)}),r&&this.geographicLookup.has(a)){const w=this.geographicLookup.get(a)?.name;w&&f.add(w)}if(this.entityTypeNames.has(a))I=`MATCH (n:${a}) ${o?"WHERE id(n) IN $ids ":""}return ID(n)`,f.forEach(w=>{I+=`, n.${w}`,S.push(w)});else{if(!this.relationshipTypeNames.has(a))throw new P("knowledge-graph:layer-data-manager",`The graph type of ${a} could not be determined. Was this type set in the KG data model and inclusion definition?`);_=!0,I=`MATCH ()-[n:${a}]->() ${o?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,f.forEach(w=>{I+=`, n.${w}`,S.push(w)})}N=new z(o?{openCypherQuery:I,bindParameters:{ids:o}}:{openCypherQuery:I});const D=(await Z(this.knowledgeGraph,N,{signal:s?.signal})).resultRowsStream.getReader();for(;;){const{done:w,value:v}=await D.read();if(w)break;const M=[];for(let k=0;k<v.length;k++){const F=v[k];let C=0,R=0;const x={properties:{}};for(x.id=F[C],C++,R++,_&&(x.originId=F[C],C++,R++,x.destinationId=F[C],C++,R++,q(this.nodeConnectionsLookup,x.originId,()=>new Set).add(x.id),q(this.nodeConnectionsLookup,x.destinationId,()=>new Set).add(x.id),q(this.relationshipConnectionsLookup,x.id,()=>[x.originId,x.destinationId]));C<F.length;C++)x.properties[S[C-R]]=F[C];l.delete(x.id),M.push(x)}const L=n.writeToStore(M,A,this.geographicLookup.get(a)?.name);this.sublayerCaches.has(a)||this.sublayerCaches.set(a,new Map),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(a)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(a,{useAllData:!1,members:new Map}),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(a).members=new Map);const G=this.sublayerCaches.get(a);L.forEach(k=>{G?.set(k.attributes[A],k),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.has(k.attributes[A])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.set(k.attributes[A],{id:k.attributes[A]}),q(this.memberIdTypeLookup,k.attributes[A],()=>new Set).add(a))})}const E=this.inclusionModeDefinition?.namedTypeDefinitions.get(a);if(E)for(const w of l)E.members?.delete(w)})().then(()=>{h(null)}).catch(f=>{f.name==="AbortError"?h(null):g(f)})});p.push(u),this._processingCacheUpdatesLookup.get(a)?.push(u)}if(await Promise.all(p),s?.signal?.aborted)throw yt()}removeFromLayer(t){const e=new Set,r=new Set(t.map(i=>i.id));for(const i of t)e.add(i.typeName),this.memberIdTypeLookup.get(i.id)?.size===1?this.memberIdTypeLookup.delete(i.id):this.memberIdTypeLookup.get(i.id)?.delete(i.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((s,n)=>{n===i.typeName&&s.members?.has(i.id)&&s.members.delete(i.id)});e.forEach(i=>{this.sublayerCaches.get(i)?.forEach((s,n)=>{r.has(n)&&this.sublayerCaches.get(i)?.delete(n)})})}async retrieveDataFromService(t,e,r){const i=he.getInstance(),s=new Set,n=[];let p,d="",m=[];const a=e.graphType==="relationship",o=this.inclusionModeDefinition?.namedTypeDefinitions?.get(e.objectType.name)?.useAllData,l=e.parentCompositeLayer.sublayerIdsCache.get(e.objectType.name);let u=!o&&l?Array.from(l).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(e.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(e.objectType.name)?.useAllData&&t.objectIds!=null&&(u=t.objectIds);else if(t.objectIds!=null&&u&&u.length>0){const g=t.objectIds;t.objectIds=u.filter(f=>g.includes(f))}else if(t.objectIds!=null)u=t.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(e.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(e.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(e.objectType.name)?.members?.size<1))return t.objectIds=[],[];t.objectIds=u}if(t.outFields!=null){const g=t.outFields;g.includes("*")?e.fields.forEach(f=>{s.add(f.name)}):g.forEach(f=>{f!==A&&f!==e.geometryFieldName&&s.add(f)})}if(t.geometry!=null){const g=t.geometry;let f;const S=e.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,N=S?.spatialReference,I=S?.serviceCapabilities?.geometryCapabilities;let _=I?.geometryMaxBoundingRectangleSizeX,D=I?.geometryMaxBoundingRectangleSizeY;if(g.type==="point"){let E=g;E.spatialReference?.isWGS84||(await de(E.spatialReference,Q),E=ie(E,Q)),f=new le({spatialReference:Q,xmin:E.x-1e-4,ymin:E.y-1e-4,xmax:E.x+1e-4,ymax:E.y+1e-4})}else g?.extent?.spatialReference&&!g.spatialReference?.isWGS84?(await de(g.extent.spatialReference,Q),f=ie(g.extent,Q)):f=g.extent;if(_&&D&&N){if(N.wkid!==4326){const E=new le({spatialReference:N,xmax:_,ymax:D}),w=ie(E,Q);_=w.xmax,D=w.ymax}if(f.xmax-f.xmin>_)throw new P("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${_}\xB0 latitude, limit exceeded`);if(f.ymax-f.ymin>D)throw new P("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${D}\xB0 longitude, limit exceeded`)}if(t.where!=null&&t.where!=="1=1"){const E=await Oe(t.where.toUpperCase(),e.fieldsIndex);e.fields.forEach(w=>{E.fieldNames.includes(w.name)&&s.add(w.name)})}d=a?`Match ()-[n:${e.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${e.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${e.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${e.geometryFieldName}) return ID(n)`,e.geometryFieldName&&s.add(e.geometryFieldName),s.forEach(E=>{d+=`, n.${E}`,n.push(E)}),p=new z({openCypherQuery:d,bindParameters:{param_filter_geom:new je({rings:zi(f)})}})}else{let g="";if(t.where!=null&&t.where!=="1=1"){const N=await Oe(t.where,e.fieldsIndex);e.fields.forEach(_=>{N.fieldNames.includes(_.name)&&s.add(_.name)});const I={systemOidFieldName:A,supportedSqlTypes:new Set(["column-reference","string","number","binary-expression"]),supportedSqlOperators:new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]),unsupportedOperationFound:!1};g=Ee(N.parseTree,I),I.unsupportedOperationFound&&(g="")}let f="";f=a?`Match ()-[n:${e.objectType.name}]->()`:`Match (n:${e.objectType.name})`;let S=!1;u&&(S=!0,f+=" WHERE ID(n) IN $ids"),g&&(f+=S?" AND":" WHERE",f+=` ${g}`),f+=" return ID(n)",a&&(f+=", id(startNode(n)), id(endNode(n))"),t.returnGeometry&&e.geometryFieldName&&s.add(e.geometryFieldName),s.forEach(N=>{f+=`, n.${N}`,n.push(N)}),p=new z(u?{openCypherQuery:f,bindParameters:{ids:u}}:{openCypherQuery:f})}const h=(await Z(e.parentCompositeLayer.dataManager.knowledgeGraph,p,r)).resultRowsStream.getReader();for(;;){const{done:g,value:f}=await h.read();if(g)break;const S=[];for(let N=0;N<f.length;N++){const I=f[N];let _=0,D=0;const E={properties:{}};for(E.id=I[_],_++,D++,a&&(E.originId=I[_],_++,D++,E.destinationId=I[_],_++,D++);_<I.length;_++)E.properties[n[_-D]]=I[_];S.push(E)}m=m.concat(i.writeToStore(S,A,e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name)?.name))}return m}_isEndEntitySpatial(t,e,r){for(const i of t??[])if(this.entityTypeNames.has(i)){const s=this.geographicLookup.get(i),n=s&&this.sublayerCaches.get(i)?.get(e.attributes[r]);if(s&&n?.attributes[s.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(t){const e=new Map;return t.forEach(r=>{if(this.memberIdTypeLookup.has(r))for(const i of this.memberIdTypeLookup.get(r)){if(!this.entityTypeNames.has(i))return;e.has(i)?e.get(i)?.push(r):e.set(i,[r])}}),e}};c([y()],$.prototype,"knowledgeGraph",void 0),c([y()],$.prototype,"inclusionModeDefinition",void 0),c([y()],$.prototype,"entityTypeNames",void 0),c([y()],$.prototype,"relationshipTypeNames",void 0),c([y()],$.prototype,"geographicLookup",void 0),c([y()],$.prototype,"sublayerCaches",void 0),c([y()],$.prototype,"nodeConnectionsLookup",void 0),c([y()],$.prototype,"relationshipConnectionsLookup",void 0),c([y()],$.prototype,"memberIdTypeLookup",void 0),$=c([pe("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],$);const Wi=Symbol("isKnowledgeGraphGraphicOriginSymbol");var rt;class Bi extends He{get[(rt=Wi,ht)](){return this.sublayer}get[mt](){return this.sublayer}get[Qe](){return this.sublayer}constructor(e,r){super(),this[rt]=!0,this.type="knowledge-graph",this.layer=e,this.sublayer=r}get id(){return this.layer.id}}const Vi=Symbol("isLinkChartGraphicOriginSymbol");var st;class Ji extends He{get[(st=Vi,Qe)](){return this.layer}constructor(e,r){super(),this[st]=!0,this.type="link-chart",this.layer=e,this.sublayer=r}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}}const nt=Rt(),Zi=t=>{const e=t;let r=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return c([y(nt.fields)],r.prototype,"fields",void 0),c([y(nt.fieldsIndex)],r.prototype,"fieldsIndex",void 0),r=c([pe("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],r),r},Yi=At;let U=class extends Re{constructor(t){super(t),this.entityAdds=void 0,this.entityUpdates=void 0,this.entityDeletes=void 0,this.relationshipAdds=void 0,this.relationshipUpdates=void 0,this.relationshipDeletes=void 0,this.options=void 0}};c([y()],U.prototype,"entityAdds",void 0),c([y()],U.prototype,"entityUpdates",void 0),c([y()],U.prototype,"entityDeletes",void 0),c([y()],U.prototype,"relationshipAdds",void 0),c([y()],U.prototype,"relationshipUpdates",void 0),c([y()],U.prototype,"relationshipDeletes",void 0),c([y()],U.prototype,"options",void 0),U=c([pe("esri.rest.knowledgeGraph.GraphApplyEdits")],U);const Ki={initializeLayersFromClientData:async(t,e,r)=>{if(e||(e=[...t.layers,...t.tables].map(n=>n.graphTypeName)),e?.length===0)return;const i=new Map;for(const n of e)i.set(n,at(t,n));const s=await Lt(t.dataManager.knowledgeGraph,Array.from(i.values()),{requestOptions:{signal:r?.signal}});for(const n of[...t.layers,...t.tables]){const p=n.objectType.name;if(p==null)continue;const d=s.get(at(t,p));if(d){const m=JSON.parse(d);m===null||typeof m!="object"||m.hasOwnProperty("showLabels")||(m.showLabels=!1),n.read(m,{origin:"service"})}}}},at=(t,e)=>t.type==="knowledge-graph"?`${e}/Map`:`${e}/LinkChart/LinkChartSubLayer`;async function Xi(t,e,r){return Ki.initializeLayersFromClientData(t,e,r)}const ot=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],er="#8f8f82";function tr(t){return t<0||t>=ot.length?new $e(er):new $e(ot[t])}function ir(t){const e=t.toArray();return new ft({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:e},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:e}]}}]}]}}})}function rr(t){let e="ESRI__ID",r=4;for(const i of t)if(i.name){if(i.name.toLowerCase()==="name"){e=i.name;break}i.name.toLowerCase().includes("name")?(e=i.name,r=2):i.fieldType==="esriFieldTypeString"&&r>3&&(e=i.name,r=3)}return e}function sr(t,e,r){const i={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},s=new K({labelExpressionInfo:new se({expression:r==="ESRI__ID"?`${e}`:`$feature.${r}`}),labelPlacement:"above-center",symbol:new ee(i)}),n=new K({labelExpressionInfo:new se({expression:`'${e}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new ee({...i,yoffset:"12px"})});return t==="entity"?[s]:[n]}function nr(t,e,r){const i={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},s=r==="ESRI__ID"?`${t}`:`$feature.${r}`;return e==="point"?[new K({labelExpressionInfo:new se({expression:s}),labelPlacement:"above-center",symbol:new ee(i)})]:e==="polyline"?[new K({labelExpressionInfo:new se({expression:s}),labelPlacement:"center-along",repeatLabel:!0,symbol:new ee(i)})]:e==="polygon"?[new K({labelExpressionInfo:new se({expression:s}),labelPlacement:"always-horizontal",symbol:new ee(i)})]:null}const ar={capabilities:[],allowGeometryUpdates:!1,serviceCapabilities:{geometryCapabilities:{supportsZValues:!1,supportsMValues:!1}}};function lt(t){const{capabilities:e,allowGeometryUpdates:r,serviceCapabilities:{geometryCapabilities:{supportsZValues:i,supportsMValues:s}}}=t?.serviceDefinition||ar,n=t?.dataModel.arcgisManaged?e:e.filter(d=>d==="Query"),p=new Set(n);return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:s,supportsZ:i},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:p.has("Create"),supportsDelete:p.has("Delete"),supportsEditing:p.has("Editing"),supportsChangeTracking:!1,supportsQuery:p.has("Query"),supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:p.has("Update"),supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:qt,queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryAttributeBins:$t,editing:{supportsGeometryUpdate:!!t?.dataModel.arcgisManaged&&r,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:p.has("Delete"),supportsUpdateByAnonymous:!1,supportsUpdateByOthers:p.has("Update"),supportsAsyncApplyEdits:!1,zDefault:void 0}}}async function or(t,e){const r=new U,i=e.graphTypeName,s=e.graphType,n=e.parentCompositeLayer.type==="knowledge-graph"?e.geometryFieldName:null,p=!!e.fieldsIndex.get(n)?.editable,d=o=>{const l={...o};for(const u of e.fields)u.editable||delete l[u.name];for(const u of Object.keys(o))u.includes("ESRI__")&&delete l[u];return l},m=async o=>{await de(o.spatialReference,oe.WGS84);const l=ie(o,oe.WGS84);return l.type==="point"?l.normalize():(await jt(l))[0]};for(const o of t.addFeatures??[]){const l=d(o.attributes);qe(o.sourceLayer)&&o.sourceLayer.graphTypeName===i&&(s==="entity"?(r.entityAdds||(r.entityAdds=[]),n&&o.geometry&&(l[n]=await m(o.geometry)),r.entityAdds.push(new Pe({properties:l,typeName:i}))):(r.relationshipAdds||(r.relationshipAdds=[]),r.relationshipAdds.push(new Ue({properties:l,typeName:i}))))}for(const o of t.updateFeatures??[]){const l=o.attributes[A],u=d(o.attributes);qe(o.sourceLayer)&&o.sourceLayer.graphTypeName===i&&(s==="entity"?(r.entityUpdates||(r.entityUpdates=[]),n&&p&&o.geometry&&(u[n]=await m(o.geometry)),r.entityUpdates.push(new Pe({id:l,properties:u,typeName:i}))):(r.relationshipUpdates||(r.relationshipUpdates=[]),r.relationshipUpdates.push(new Ue({id:l,properties:u,typeName:i}))))}const a=new Map;for(const o of t.deleteFeatures??[])if(gt(o)){const l=o,u=q(a,l.sourceLayer.graphTypeName,()=>({typeName:l.sourceLayer.graphTypeName,ids:[]}));l.sourceLayer.graphTypeName===i&&u.ids.push(l.attributes[A])}else o.objectId&&typeof o.objectId=="string"&&q(a,i,()=>({typeName:i,ids:[]})).ids.push(o.objectId);for(const o of a.values())o.ids.length>0&&(s==="entity"?(r.entityDeletes||(r.entityDeletes=[]),r.entityDeletes.push({typeName:o.typeName,ids:o.ids})):(r.relationshipDeletes||(r.relationshipDeletes=[]),r.relationshipDeletes.push({typeName:o.typeName,ids:o.ids})));return r}function lr(t,e){const r={addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]};for(const i of t.editResults)if(i.typeName===e){for(const s of i.adds)r.addFeatureResults.push({objectId:s.id,globalId:s.id});for(const s of i.updates)r.updateFeatureResults.push({objectId:s.id,globalId:s.id});for(const s of i.deletes)r.deleteFeatureResults.push({objectId:s.id,globalId:s.id})}return r}function pr(t){if(!t.objectType)return null;const e=[];for(const r of t.fields)!r.name.includes("ESRI__")&&r.editable&&r.type!=="geometry"&&e.push(new Yi({fieldName:r.name}));return new Ot({elements:e})}function dr(t){if(!t.objectType)return null;let e=null;switch(t.geometryType){case"point":case"multipoint":e="point";break;case"polyline":e="line";break;case"polygon":e="polygon";break;default:e=null}return[new Gt({name:t.graphTypeName,drawingTool:e,prototype:{}})]}function j(t){if(!t.json)return t;t.json.write=pt(t.json.write);const e=t.json.origins;if(!e)return t;let r;for(r in e){const i=e[r];i&&(i.write=pt(i.write))}return t}function pt(t){return typeof t=="object"&&t?(t.enabled!==!1&&(t.overridePolicy=ur(t)),t):t===!0?ne():t}function ur(t){const{target:e,writer:r,overridePolicy:i,...s}=t;return function(n,p){const d=dt.call(this,n,p);return d.enabled?{...s,...d}:d}}function ne(){return{overridePolicy:dt}}function dt(t,e){const r=!!this.geometryType;let i={enabled:r};return r&&(i={...i,...ae.call(this,t,e)}),i}function ae(t,e){return{ignoreOrigin:this.originIdOf(e)>0}}let b=class extends Zi(zt(Zt(Vt(Ut(Kt(ii(ti(ei(Dt(Et)))))))))){constructor(t){super(t),this.blendMode="normal",this.charts=null,this.definitionExpression=null,this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=A,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const e=new MessageChannel;return new Ct(e.port1,{channel:e,client:{queryFeatures:(r,i={})=>{const s=Y.fromJSON(r);return this.queryFeaturesJSON(s,i)}}}),[e.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get capabilities(){return this.parent?this.parent.sublayerCapabilities:lt(null)}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}get editingEnabled(){return this._isOverridden("editingEnabled")?this._get("editingEnabled"):this.capabilities.operations.supportsEditing}set editingEnabled(t){this._overrideIfSome("editingEnabled",t)}get isTable(){return this.parentCompositeLayer.type!=="link-chart"&&this.geometryFieldName==null}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(t){const e=this._normalizeFeatureReduction(t);this._set("featureReduction",e)}get fields(){const t=[];return this.objectType?.properties?.forEach(e=>{const r=e.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":e.fieldType;t.push(ye.fromJSON({name:e.name,type:r,alias:e.alias,defaultValue:e.defaultValue,editable:e.editable,nullable:e.nullable}))}),t.push(ye.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),ye.fromJSON({name:we,type:"esriFieldTypeInteger",alias:we,editable:!1}),ye.fromJSON({name:re,type:"esriFieldTypeInteger",alias:re,editable:!1})),t}get formTemplate(){return this._isOverridden("formTemplate")?this._get("formTemplate"):pr(this)}set formTemplate(t){this._overrideIfSome("formTemplate",t)}get geometryType(){if(this.parentCompositeLayer?.type==="link-chart")return this.graphType==="relationship"?"polyline":"point";const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.geometryType;return e&&e!=="esriGeometryNull"?te.fromJSON(e):null}get geometryFieldName(){return this.parentCompositeLayer?.type==="link-chart"?be:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphicOrigin(){if(!this.parent)return null;switch(this.parent.type){case"knowledge-graph":return new Bi(this.parent,this);case"link-chart":return new Ji(this.parent,this)}}get graphTypeName(){return this.objectType?.name}set graphTypeName(t){this._set("graphTypeName",t)}get hasM(){const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.name;return(e?this.objectType?.properties?.[e]:null)?.hasM??!1}get hasZ(){const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.name;return(e?this.objectType?.properties?.[e]:null)?.hasZ??!1}set labelingInfo(t){this._set("labelingInfo",t)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const t=this.objectType.properties?rr(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?sr(this.graphType,this.graphTypeName,t):nr(this.graphTypeName,this.geometryType,t)}set renderer(t){bt(t,this.fieldsIndex),this._set("renderer",t)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const t=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,e=[...t?.entityTypes??[],...t?.relationshipTypes??[]].map(s=>s.name).indexOf(this.graphTypeName),r=tr(e);if(this.parentCompositeLayer?.type==="link-chart"){if(this.graphType==="relationship")return new di({type:"simple",symbol:ir(r)});const s=We(ze(te.toJSON("point")).renderer);return Be(s.symbol,r),s}const i=We(ze(te.toJSON(this.geometryType)).renderer);return Be(i.symbol,r),i}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??oe.WGS84}get templates(){return this._isOverridden("templates")?this._get("templates"):dr(this)}set templates(t){this._overrideIfSome("templates",t)}set timeInfo(t){this._set("timeInfo",t)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(t){this._set("title",t)}writeTitle(t,e){e.title=t??"Layer"}createPopupTemplate(t){return yi(this,t)}createQuery(){return new Y({where:"1=1",outFields:["*"]})}getField(t){return this.fieldsIndex.get(t)}getFieldDomain(t,e){return null}async queryFeatures(t,e){await this.load();const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(t),s=this.graphicOrigin,n=ci.fromJSON(await i.executeQuery(r.toJSON(),e?.signal));return n.features.forEach(p=>{p.sourceLayer=this,p.origin=s}),n}async queryFeaturesJSON(t,e){await this.load();const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(t);return await i.executeQuery(r.toJSON(),e?.signal)}async queryFeatureCount(t,e){await this.load();const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(t);return i.executeQueryForCount(r.toJSON(),e?.signal)}async queryExtent(t={},e){await this.load();const r={...t,returnGeometry:!0},{resolvedQuery:i,queryEngine:s}=await this._setupQueryObjects(r),n=await s.executeQueryForExtent(i.toJSON(),e?.signal);let p;return p=n.extent?.xmin!=null&&n.extent?.xmax!=null&&n.extent?.ymin!=null&&n.extent?.ymax!=null?new le(n.extent):new le,{count:n.count,extent:p}}async queryObjectIds(t,e){await this.load();const r=Y.from(t);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const s=await this.parentCompositeLayer.dataManager.getData(r,this,e);i=this.loadQueryEngine(s)}return await i.executeQueryForIds(r.toJSON(),e?.signal)}async applyEdits(t){if(!this.parentCompositeLayer.dataManager.knowledgeGraph)throw new P("knowledge-graph-sublayer:no-knowledge-graph","ApplyEdits cannot be executed because the parent does not have a Knowledge Graph model.  This is usually caused by the layer not yet being loaded");const e=await or(t,this);e.options={cascadeDelete:!0,cascadeProvenanceDelete:!!this.parent?.knowledgeGraph.serviceDefinition.supportsProvenance||void 0};const r=await Mt(this.parentCompositeLayer.dataManager.knowledgeGraph,e),i=lr(r,this.graphTypeName),s={addedFeatures:i.addFeatureResults,updatedFeatures:i.updateFeatureResults,deletedFeatures:i.deleteFeatureResults,addedAttachments:i.addAttachmentResults,deletedAttachments:i.deleteAttachmentResults,updatedAttachments:i.updateAttachmentResults,exceededTransferLimit:!1,historicMoment:new Date,edits:void 0};return this.emit("edits",s),this.emit("apply-edits",{result:Promise.resolve(s)}),this.parentCompositeLayer.type==="link-chart"&&await this.parentCompositeLayer.refreshLinkChartCache([...s.addedFeatures.map(n=>n.globalId),...s.updatedFeatures.map(n=>n.globalId),...s.deletedFeatures.map(n=>n.globalId)]),i}loadQueryEngine(t){const e=new xt({geometryType:te.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new Ft({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:te.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:e});return r.featureStore.addMany(t),r}async refreshCachedQueryEngine(){const t=await this.parentCompositeLayer.dataManager.getData(new Y({where:"1=1",outFields:[A]}),this);this._cachedQueryEngine=this.loadQueryEngine(t)}load(t){return this.addResolvingPromise(this.parent.load(t).then(()=>wt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(t,e){const r=Y.from(t),i=r.geometry;if(i&&!i.spatialReference?.isWGS84&&(await de(i.spatialReference,Q),r.geometry=ie(i instanceof je||i instanceof Tt||i instanceof It?i:i.extent,Q)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:r,queryEngine:this._cachedQueryEngine};const s=await this.parentCompositeLayer.dataManager.getData(r,this,e);return{resolvedQuery:r,queryEngine:this.loadQueryEngine(s)}}};function cr(t,e,r){const i=[["ESRI__AGGREGATION_COUNT",we],["ESRI__ORIGIN_ID",ue],["ESRI__DESTINATION_ID",ce],["ESRI__LAYOUT_GEOMETRY",be]];try{for(const s of t)for(const[n,p]of i)s.labelExpression=s.labelExpression?.replaceAll(n,p),s.labelExpressionInfo?.expression&&(s.labelExpressionInfo.expression=s.labelExpressionInfo.expression.replaceAll(n,p))}catch(s){Ae.getLogger(this).warn("Error updating labelingInfo",s)}return Pt(t,e,r)}c([y(j(O(Ht)))],b.prototype,"blendMode",void 0),c([y({readOnly:!0})],b.prototype,"capabilities",null),c([y({readOnly:!0})],b.prototype,"userHasUpdateItemPrivileges",null),c([y({type:Boolean})],b.prototype,"editingEnabled",null),c([y()],b.prototype,"isTable",null),c([y({json:{origins:{"web-scene":{write:!1}},write:ne()}})],b.prototype,"charts",void 0),c([y({readOnly:!0})],b.prototype,"defaultPopupTemplate",null),c([y({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],b.prototype,"definitionExpression",void 0),c([y(j(O(Wt)))],b.prototype,"displayFilterEnabled",void 0),c([y(j(O(Bt)))],b.prototype,"displayFilterInfo",void 0),c([y(j(O(Qt)))],b.prototype,"effect",void 0),c([y()],b.prototype,"elevationInfo",void 0),c([y(j(O(Jt)))],b.prototype,"featureEffect",void 0),c([y(j(O(Yt)))],b.prototype,"featureReduction",null),c([y()],b.prototype,"fields",null),c([y()],b.prototype,"formTemplate",null),c([y()],b.prototype,"geometryType",null),c([y()],b.prototype,"geometryFieldName",null),c([y({readOnly:!0})],b.prototype,"graphicOrigin",null),c([y({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],b.prototype,"graphType",void 0),c([y({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],b.prototype,"graphTypeName",null),c([y()],b.prototype,"hasM",null),c([y()],b.prototype,"hasZ",null),c([y({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],b.prototype,"id",void 0),c([y({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],b.prototype,"labelsVisible",void 0),c([y({type:[K],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:cr,write:ne()}})],b.prototype,"labelingInfo",null),c([y({readOnly:!0,json:{read:!1,write:{writer(t,e){switch(this.parentCompositeLayer?.type){case"link-chart":e.layerType="LinkChartSubLayer";break;case"knowledge-graph":e.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],b.prototype,"layerType",void 0),c([y(j(O(si)))],b.prototype,"legendEnabled",void 0),c([y(j(O(ni)))],b.prototype,"maxScale",void 0),c([y(j(O(ai)))],b.prototype,"minScale",void 0),c([y()],b.prototype,"objectIdField",void 0),c([y()],b.prototype,"objectType",void 0),c([y(j(O(oi)))],b.prototype,"opacity",void 0),c([y(j(O(Xt)))],b.prototype,"orderBy",void 0),c([y({clonable:!1})],b.prototype,"parent",void 0),c([y()],b.prototype,"parentCompositeLayer",void 0),c([y(j(O(li)))],b.prototype,"popupEnabled",void 0),c([y({type:_t,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],b.prototype,"popupTemplate",void 0),c([y({type:Number,json:{write:{overridePolicy:ae}}})],b.prototype,"refreshInterval",void 0),c([y({types:ui,json:{name:"layerDefinition.drawingInfo.renderer",write:ne()}})],b.prototype,"renderer",null),c([y()],b.prototype,"source",void 0),c([y()],b.prototype,"spatialReference",null),c([y()],b.prototype,"templates",null),c([y({type:pi,json:{name:"layerDefinition.timeInfo",write:{overridePolicy:ae},origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:ae}},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:ae}}}}})],b.prototype,"timeInfo",null),c([y({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],b.prototype,"title",null),c([Nt("title")],b.prototype,"writeTitle",null),c([y({json:{read:!1}})],b.prototype,"type",void 0),c([y(j(O(ri)))],b.prototype,"useViewTime",void 0),c([y({type:Boolean,json:{name:"visibility",write:ne()}})],b.prototype,"visible",void 0),b=c([pe("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],b);export{Se as A,Qi as C,lt as F,ji as I,Xi as L,b as N,Le as P,$ as a,De as b,Me as c,ke as d,ve as e,Di as f,Hi as g,he as o,Ne as p,$i as r,Ci as w};
