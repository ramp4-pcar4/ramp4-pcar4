import{O as U,ch as me,s as W,av as Ne,ay as De,i as E,ba as F,a9 as H,aa as oe,gm as ve,cl as X,d as xe,aG as fe,dg as Ie,at as Ee,_ as b,X as M,Y as _e}from"./main-CSjwO60s.js";import{N as V,a as Se,I as Ae,C as Re,o as ze,F as Ge,g as Fe,L as re,b as Oe,A as Pe,d as Be,c as Ue,P as je,e as We,p as Qe,r as $e}from"./KnowledgeGraphSublayer-DTi_ImO-.js";import{l as He}from"./MultiOriginJSONSupport-DNNJhlNT.js";import{u as q}from"./featureConversionUtils-CZmIxyv5.js";import{_ as C,I as Y,t as Z,S as A,o as Ve}from"./constants-DVYXs0Da.js";import{p as qe}from"./BlendLayer-D8oJmNCO.js";import{b as Je,y as Ke}from"./OperationalLayer-Ds0FQSCg.js";import{t as Xe}from"./ScaleRangeLayer-DkZwCH6_.js";import{u as Ye}from"./knowledgeGraphService-CuOTexj3.js";const le={MULTIPLIER:"multiplier",ABSOLUTE:"absolute-value"};let m=class extends Je(qe(Xe(He(Ee)))){constructor(e){if(super(e),this.url=null,this.dataPreloadedInLocalCache=!1,this.initializationLinkChartConfig=null,this.membershipModified=!0,this._currentLinkChartConfig={layoutMode:"organic-standard"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new(U.ofType(V)),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new me({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="LinkChartLayer",this.sublayerIdsCache=new Map,this.tables=new(U.ofType(V)),this.type="link-chart",this.chronologicalAuxiliaryGraphics=null,this._originalInclusionList=e?.initializationInclusionModeDefinition,e?.dataPreloadedInLocalCache&&!e?.initializationInclusionModeDefinition)throw new W("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it");this.addHandles(Ne(()=>this.layers.concat(this.tables),(t,a)=>this._handleSublayersChange(t,a),De))}normalizeCtorArgs(e){if(!e)return{};const{url:t,title:a,dataPreloadedInLocalCache:n,initializationLinkChartConfig:i}=e;return{url:t,title:a,dataPreloadedInLocalCache:n,initializationLinkChartConfig:i}}_initializeLayerProperties(e){if(!this.title&&this.url){const s=this.url.split("/");this.title=s[s.length-2]}const t=new Set;let a=[],n=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new W("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.inclusionModeDefinition?.generateAllSublayers?(a=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((s,r)=>{const h=this._graphTypeLookup.get(r);if(!h)return E.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(r);h.type==="relationship"?t.has(r)||(t.add(r),n.push(h)):h.type==="entity"?t.has(r)||(t.add(r),a.push(h)):(E.getLogger(this).warn(`A named type, ${r}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(r))}):(a=e.knowledgeGraph.dataModel.entityTypes??[],n=e.knowledgeGraph.dataModel.relationshipTypes??[]);const i=new Se({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=a,this.memberRelationshipTypes=n,this.dataManager=i}load(e){const t=async()=>{const a=[],n=[];this.loadLayerAssumingLocalCache(),this._layersLoadedFromAuthoritativeItem()||await re(this),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(i=>{i.useAllData=!1}),await this._initializeDiagram(),this.layers.forEach(i=>{n.push(i.refreshCachedQueryEngine()),a.push(new Promise(s=>{i.on("layerview-create",()=>{s(null)})}))}),this.tables.forEach(i=>{n.push(i.refreshCachedQueryEngine())}),await Promise.all(n)};return this.addResolvingPromise(new Promise(a=>{Ye(this.url).then(async n=>{n.dataModel.entityTypes?.forEach(s=>{s.name&&this._graphTypeLookup.set(s.name,s)}),n.dataModel.relationshipTypes?.forEach(s=>{s.name&&this._graphTypeLookup.set(s.name,s)});const i=this.linkChart?.linkChartProperties;if(i?.originIdOf("entitiesUrl")===6&&(this.membershipModified=!1,this._originalInclusionList=await Ae.fetchAndConvertSerializedLinkChart({entitiesUrl:i?.entitiesUrl,relationshipsUrl:i?.relationshipsUrl}),this._alignLayersDataModelAndInclusionDefinition(n.dataModel),this.initializationLinkChartConfig={layoutSettings:i?.layoutSettings??void 0,layoutMode:Re(i.layoutType)}),this._initializeLayerProperties({knowledgeGraph:n,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(s=>{s.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(s.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(s=>{s.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(s.name,{useAllData:!0})})),this.dataPreloadedInLocalCache){const s=ze.getInstance();for(const[r,h]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions??[])for(const p of h.members?.values()??[]){const y=s.readFromStoreById(`${r}__${p.id}`);y&&F(this.dataManager.sublayerCaches,r,()=>new Map).set(p.id,y)}await t()}else{const s=this.initializationLinkChartConfig?.layoutMode==="geographic-organic-standard";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,s,!0).then(async()=>{H(e),await t()}))}a(null)})})),Promise.resolve(this)}set initializationInclusionModeDefinition(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("initializationInclusionModeDefinition",e):E.getLogger(this).error("#initializationInclusionModeDefinition","initializationInclusionModeDefinition cannot be changed after the layer is loaded.")}get linkChart(){return this.parent}get sublayerCapabilities(){return Ge(this.knowledgeGraph)}async addRecords(e,t){let a=[];t?.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(a=await Fe(e,this.dataManager.knowledgeGraph));const n=e.concat(a).filter(i=>!this.sublayerIdsCache.get(i.typeName)?.has(i.id));n.length>0&&(this.membershipModified=!0),await this._handleNewRecords(n,t)}async createSublayerForNamedType(e){await this.load();const t=this._graphTypeLookup.get(e);if(!t)throw new W("knowledge-graph:missing-type","The specified type does not exist in the knowledge graph.");if(this.dataManager.sublayerCaches.has(e))throw new W("knowledge-graph:duplicate-type","The specified type already exists as a sublayer.");this.dataManager.sublayerCaches.set(e,new Map),F(this.sublayerIdsCache,e,()=>new Set);const a=this._createSublayer(t);return t.type==="entity"?this.dataManager.entityTypeNames.add(e):this.dataManager.relationshipTypeNames.add(e),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.set(e,{useAllData:!1,members:new Map}),a.geometryType?this.layers.push(a):this.tables.push(a),await re(this,[e]),this._refreshNamedTypes(),a}async removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:a=!1,overrideMembershipCheck:n=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1,overrideMembershipCheck:!1}){let i=[];for(const h of e)(n||this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(h.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(h.typeName)?.members?.has(h.id))&&i.push(h);if(t){const h=new Set,p=[];for(const y of i)if(this.dataManager.nodeConnectionsLookup.has(y.id))for(const g of this.dataManager.nodeConnectionsLookup.get(y.id))h.add(g);for(const y of h)if(this.dataManager.memberIdTypeLookup.has(y))for(const g of this.dataManager.memberIdTypeLookup.get(y))this.dataManager.relationshipTypeNames.has(g)&&p.push({id:y,typeName:g});i=i.concat(p)}this.dataManager.removeFromLayer(i);for(const h of i)this.sublayerIdsCache.get(h.typeName)?.delete(h.id),this.dataManager.relationshipTypeNames.has(h.typeName)?this.relationshipLinkChartDiagramLookup.delete(h.id):this.entityLinkChartDiagramLookup.delete(h.id);const s=a?void 0:this.getCurrentNodeLocations();await this._calculateLayoutWithSublayerTimeInfo(this._currentLinkChartConfig.layoutMode,{layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:s}),i.length>0&&(this.membershipModified=!0);const r=[];return this.layers.forEach(h=>{r.push(h.refreshCachedQueryEngine())}),await Promise.all(r),this._refreshNamedTypes(),i}async expand(e,t){let a=[];try{const n=await this.dataManager.getConnectedRecordIds(e,t?.relationshipTypeNames,t);a=n.filter(i=>!this.sublayerIdsCache.get(i.typeName)?.has(i.id)),await this._handleNewRecords(a,t),n.length>0&&(this.membershipModified=!0),H(t?.signal)}catch(n){throw oe(n)&&a.length>0&&await this.removeRecords(a,{overrideMembershipCheck:!0}),n}return{records:a}}loadLayerAssumingLocalCache(){const e=[...this.memberRelationshipTypes,...this.memberEntityTypes];this.layers.length||this.originIdOf("tables")===0?this.originIdOf("layers")===0?this._createSublayers(e,this.layers,t=>!!t.geometryType):this._updateSublayers(e,this.layers):this.layers=new U,this.tables.length||this.originIdOf("layers")===0?this.originIdOf("tables")===0?this._createSublayers(e,this.tables,t=>!t.geometryType):this._updateSublayers(e,this.tables):this.tables=new U,this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t,a)=>{const n=F(this.sublayerIdsCache,a,()=>new Set);t.members?.forEach(({id:i,linkChartLocation:s})=>{if(n.add(i),s){const r="coords"in s&&"lengths"in s?s:q(s);this.dataManager.relationshipTypeNames.has(a)?this.relationshipLinkChartDiagramLookup.set(i,r):this.entityLinkChartDiagramLookup.set(i,r)}})})}async calculateLinkChartLayout(e="organic-standard",t){const a=[],n=[],i=[];this.dataManager.sublayerCaches.forEach((o,d)=>{this.dataManager.entityTypeNames.has(d)?o.forEach(l=>{a.push({typeName:d,feature:l})}):this.dataManager.relationshipTypeNames.has(d)&&o.forEach(l=>{n.push({typeName:d,feature:l})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const s=new Map,r=new Map,h=new Map,p=new Map,y=new Uint8Array(a.length),g=new Float64Array(a.length),w=new Float64Array(a.length),j=new Float64Array(a.length),S=new Float64Array(a.length),T=new Uint32Array(n.length),ee=new Uint32Array(n.length),he=new Float64Array(n.length),de=new Float64Array(n.length),f=[],be="organic-standard";let ce=!1;const N=new me({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let O,pe="organic-standard",u=0,v=0;const we=Oe.apply;switch(pe=e==="geographic-organic-standard"?be:e,pe){case"organic-standard":O=Qe.apply;break;case"organic-community":O=We.apply;break;case"hierarchical-bottom-to-top":O=je.apply;break;case"radial-root-centric":O=Ue.apply;break;case"tree-left-to-right":O=Be.apply;break;default:O=Pe.apply}let te=!1;a.forEach(({typeName:o,feature:d})=>{if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"&&t?.lockedNodeLocations?.has(d.attributes[C])){e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(o)?y[u]=2:y[u]=0;const l=t.lockedNodeLocations.get(d.attributes[C]);g[u]=l.x,w[u]=l.y}else if(e==="geographic-organic-standard"&&this.dataManager.geographicLookup.has(o)){y[u]=2;let l=null;const k=d.attributes[this.dataManager.geographicLookup.get(o).name];switch(this.dataManager.geographicLookup.get(o)?.geometryType){case"esriGeometryPoint":g[u]=k?.x,w[u]=k?.y;break;case"esriGeometryPolygon":{const D=ve(k);l=D?X.fromJSON(D):null,l?.x!=null&&l?.y!=null?(g[u]=l.x,w[u]=l.y):y[u]=1;break}case"esriGeometryPolyline":case"esriGeometryMultipoint":l=k?.extent?.center,l?.x!=null&&l?.y!=null?(g[u]=l.x,w[u]=l.y):y[u]=1;break;default:y[u]=1}(g[u]==null||w[u]==null||Number.isNaN(g[u])||Number.isNaN(w[u]))&&(y[u]=1,g[u]=0,w[u]=0)}else if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){!te&&t?.lockedNodeLocations?.has(d.attributes[C])&&(te=!0);const l=t?.timeInfoByTypeName?.get(o),k=l?.startField,D=k&&l?.startField?d.attributes[k]:null;j[u]=D?new Date(D).getTime():NaN;const L=l?.endField,I=L&&l?.endField?d.attributes[L]:null;S[u]=I?new Date(I).getTime():NaN,g[u]=0,w[u]=0,y[u]=1}else y[u]=1,g[u]=0,w[u]=0;p.set(d.attributes[C],u),f[u]={feature:d,typeName:o},u++}),te&&E.getLogger(this).warn("Locked node locations are not supported for chronological layout at this time.  Requested node locations were ignored");let ue=!1;const ae=new Map;n.forEach(o=>{const d=o.feature.attributes[Y],l=o.feature.attributes[Z],k=p.get(d),D=p.get(l),L=t?.timeInfoByTypeName?.get(o.typeName),I=t?.timeInfoByTypeName?L?.startField:null,R=I?o.feature.attributes[I]:null,K=L?.endField,P=K?o.feature.attributes[K]:null;if(k!==void 0&&D!==void 0){let z=d+"-"+l;e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(z=z+"-"+R+"-"+P);const $=ae.get(z);$?.has(o.typeName)||(T[v]=k,ee[v]=D,e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"||(he[v]=R?new Date(R).getTime():NaN,de[v]=P?new Date(P).getTime():NaN),$===void 0?ae.set(z,new Map([[o.typeName,v]])):$.set(o.typeName,v),v++),i.push(o)}else ue=!0,this.relationshipLinkChartDiagramLookup.set(d,null)}),ue&&E.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");const Le=this._validateOrganicLayoutSettings(e,t?.layoutSettings?.organicLayoutSettings),ie=this._convertValidatedOrganicSettingsToCalculationSettings(Le);await $e();let Q=1,x=null;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){let o;({status:Q,links:x,graphics:o}=we(()=>t?.signal?.aborted??!1,y,g,w,j,S,T.subarray(0,v),ee.subarray(0,v),he.subarray(0,v),de.subarray(0,v),e==="chronological-multi-timeline",t?.layoutSettings?.chronologicalLayoutSettings)),Q===0&&(this.chronologicalAuxiliaryGraphics=o)}else({status:Q,links:x}=O(()=>t?.signal?.aborted??!1,y,g,w,T.subarray(0,v),ee.subarray(0,v),ie.computationBudgetTime,ie.idealEdgeLengthMultiplier,ie.repulsionRadiusMultiplier));if(H(t?.signal),Q===1)throw new W("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");if(Q===2)throw xe();for(let o=0;o<f.length;o++){if(w[o]>84.9999?w[o]=84.9999:w[o]<-84.9999&&(w[o]=-84.9999),g[o]>179.9999?g[o]=179.9999:g[o]<-179.9999&&(g[o]=-179.9999),f[o].feature.attributes[A]=new X(g[o],w[o]),s.has(f[o].typeName))s.get(f[o].typeName)?.set(f[o].feature.attributes[C],f[o].feature);else{const L=new Map;L.set(f[o].feature.attributes[C],f[o].feature),s.set(f[o].typeName,L)}h.set(f[o].feature.attributes[C],f[o].feature);const d=q(f[o].feature.attributes[A]);this.entityLinkChartDiagramLookup.set(f[o].feature.attributes[C],f[o].feature.attributes[A]?d:null);const l=F(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,f[o].typeName,()=>({useAllData:!1,members:new Map}));F(l.members,f[o].feature.attributes[C],()=>({id:f[o].feature.attributes[C],linkChartLocation:void 0})).linkChartLocation=f[o].feature.attributes[A];const{x:k,y:D}=f[o].feature.attributes[A];ce?(N.xmin=Math.min(N.xmin,k),N.xmax=Math.max(N.xmax,k),N.ymin=Math.min(N.ymin,D),N.ymax=Math.max(N.ymax,D)):(N.xmin=k-1e-7,N.xmax=k+1e-7,N.ymin=D-1e-7,N.ymax=D+1e-7,ce=!0)}if(this.linkChartExtent.xmin=N.xmin,this.linkChartExtent.xmax=N.xmax,this.linkChartExtent.ymin=N.ymin,this.linkChartExtent.ymax=N.ymax,!x)throw new W("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const J=new Map,ne=new Map,se=new Map,ye=new Set;for(let o=0;o<i.length;o++){const d=[],l=i[o],k=l.feature.attributes[Y],D=l.feature.attributes[Z];let L=k+"-"+D;if(e==="chronological-mono-timeline"||e==="chronological-multi-timeline"){const c=t?.timeInfoByTypeName?.get(l.typeName),_=t?.timeInfoByTypeName?c?.startField:null,G=_?l.feature.attributes[_]:null,B=c?.endField;L+="-"+G+"-"+(B?l.feature.attributes[B]:null)}const I=ae.get(L).get(l.typeName),R=I===0?0:x?.vertexEndIndex[I-1];if(!ye.has(I)){if(ye.add(I),x.types[I]===2){const c=[x.vertices[2*R],x.vertices[2*R+1]],_=[x.vertices[2*(R+1)],x.vertices[2*(R+1)+1]],G=[.5*(c[0]+_[0]),.5*(c[1]+_[1])],B=[G[0]-c[0],G[1]-c[1]],Ce=[G[0]+B[1],G[1]-B[0]],Te=[G[0]-B[1],G[1]+B[0]];d.push(c),d.push(Ce),d.push(_),d.push(Te),d.push(c)}else{if(x.types[I]!==0){E.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let c=R;c<x.vertexEndIndex[I];c++)d.push([x.vertices[2*c],x.vertices[2*c+1]])}if(e!=="chronological-mono-timeline"&&e!=="chronological-multi-timeline"){const c=f[p.get(k)]?.feature.attributes[A],_=f[p.get(D)]?.feature.attributes[A];d[0][0]===c.x&&d[0][1]===c.y||(d[0]=[c.x,c.y]),d[d.length-1][0]===_.x&&d[d.length-1][1]===_.y||(d[d.length-1]=[_.x,_.y])}for(let c=1;c<d.length-1;c++)d[c][1]>85.5?d[c][1]=85.5:d[c][1]<-85.5&&(d[c][1]=-85.5),d[c][0]>179.9999?d[c][0]=179.9999:d[c][0]<-179.9999&&(d[c][0]=-179.9999);J.has(L)?J.get(L).push(d):J.set(L,[d])}const K=J.get(L);ne.has(L)||(ne.set(L,new Map),se.set(L,new Map));const P=ne.get(L),z=se.get(L);P.has(l.typeName)||(P.set(l.typeName,K.shift()),z.set(l.typeName,0));const $=P.get(l.typeName);z.set(l.typeName,z.get(l.typeName)+1);const Me=new fe({paths:[$]});if(l.feature.attributes[A]=Me,r.has(l.typeName))r.get(l.typeName)?.set(l.feature.attributes[C],l.feature);else{const c=new Map;c.set(l.feature.attributes[C],l.feature),r.set(l.typeName,c)}h.set(l.feature.attributes[C],l.feature);const ge=q(l.feature.attributes[A]);this.relationshipLinkChartDiagramLookup.set(l.feature.attributes[C],l.feature.attributes[A]?ge:null);const ke=F(this.dataManager.inclusionModeDefinition.namedTypeDefinitions,l.typeName,()=>({useAllData:!1,members:new Map}));F(ke.members,l.feature.attributes[C],()=>({id:l.feature.attributes[C],linkChartLocation:void 0})).linkChartLocation=ge}for(const o of i)o.feature.attributes[Ve]=se.get(o.feature.attributes[Y]+"-"+o.feature.attributes[Z])?.get(o.typeName)??null;return this._currentLinkChartConfig={layoutMode:e,layoutSettings:t?.layoutSettings?.clone()},{nodes:s,links:r,idMap:h}}async applyNewLinkChartLayout(e="organic-standard",t){const a=[];await this._calculateLayoutWithSublayerTimeInfo(e,t),this.layers.forEach(n=>{a.push(n.refreshCachedQueryEngine())}),this.membershipModified=!0,await Promise.all(a),this._refreshNamedTypes()}getCurrentNodeLocations(){const e=new Map;for(const[t,a]of this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.entries()??[])this.dataManager.relationshipTypeNames.has(t)||a?.members?.forEach(n=>{const i=n.linkChartLocation;let s;const r=n.id;i&&(s="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]},e.set(r,new X({x:s.x,y:s.y})))});return e}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const t=[];this.layers.forEach(a=>{t.push(a.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}async connectBetweenEntities(e,t){if(!e.length)return{records:[]};let a=[];try{let n=[];for(const i of this.dataManager.relationshipTypeNames){const s=this.sublayerIdsCache.get(i);s&&(n=n.concat(Array.from(s.keys())))}a=await this.dataManager.getRelationshipsBetweenNodes(e,n,t),await this._handleNewRecords(a,t),H(t)}catch(n){throw oe(n)&&this.removeRecords(a),n}return{records:a}}async connectFromEntities(e,t){if(!e.length)return{records:[]};let a=[];try{let n=[];for(const s of this.dataManager.relationshipTypeNames){const r=this.sublayerIdsCache.get(s);r&&(n=n.concat(Array.from(r.keys())))}let i=[];for(const s of this.dataManager.entityTypeNames){const r=this.sublayerIdsCache.get(s);r&&(i=i.concat(Array.from(r)))}a=await this.dataManager.getRelationshipsFromNodes(e,i,n,t),await this._handleNewRecords(a,t),a.length>0&&(this.membershipModified=!0),H(t)}catch(n){throw oe(n)&&this.removeRecords(a),n}return{records:a}}getCurrentLayout(){return this._currentLinkChartConfig.layoutMode}async _calculateLayoutWithSublayerTimeInfo(e="organic-standard",t){const a=new Map;this.layers.forEach(n=>{a.set(n.objectType.name,n.timeInfo)}),await this.calculateLinkChartLayout(e,{timeInfoByTypeName:a,...t}),this.linkChart?.handleChronologicalOverlay()}async _handleNewRecords(e,t){const a=new Set,n=[],i=this.layers.concat(this.tables);for(const r of e)this._graphTypeLookup.has(r.typeName)&&(i.some(h=>h.objectType.name===r.typeName)===!1&&(this.dataManager.sublayerCaches.set(r.typeName,new Map),a.add(r.typeName)),F(this.sublayerIdsCache,r.typeName,()=>new Set).add(r.id),n.push(r));this.dataManager.addToLayer(n);for(const r of a){const h=this._graphTypeLookup.get(r);if(h){const p=this._createSublayer(h);h.type==="entity"?this.dataManager.entityTypeNames.add(r):this.dataManager.relationshipTypeNames.add(r),p.geometryType?this.layers.push(p):this.tables.push(p)}}await re(this,Array.from(a),t),await this.dataManager.refreshCacheContent(e.map(r=>r.id),void 0,void 0,void 0,t);const s={layoutSettings:this._currentLinkChartConfig.layoutSettings,lockedNodeLocations:new Map};for(const[r,h]of this.entityLinkChartDiagramLookup.entries())h&&s.lockedNodeLocations.set(r,new X(h.coords[0],h.coords[1]));await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,s)}_createSublayers(e,t,a){e.forEach(n=>{const i=this._createSublayer(n);a(i)&&t.push(i),this._updateSublayerCaches(n)})}_updateSublayers(e,t){t.forEach(a=>{a.parentCompositeLayer=this;const n=e.find(i=>i.type===a.graphType&&i.name===a.graphTypeName);n&&(a.objectType=n,a.read({title:n.name},{origin:"service"}),this._updateSublayerCaches(n))})}_updateSublayerCaches({name:e}){if(!e)return;const t=this.dataManager.sublayerCaches;t.has(e)||t.set(e,new Map)}_layersLoadedFromAuthoritativeItem(){const e=this.originIdOf("layers");return e>=3&&e<7}async _initializeDiagram(){this.initializationLinkChartConfig?this.initializationLinkChartConfig.doNotRecalculateLayout?(this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((e,t)=>{e?.members?.forEach(a=>{const n=a.linkChartLocation;let i;const s=a.id;if(!n)return;i="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]};const r=q(i);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(s,r):this.entityLinkChartDiagramLookup.set(s,r),this.linkChartExtent.xmin>i.x&&(this.linkChartExtent.xmin=i.x),this.linkChartExtent.xmax<i.x&&(this.linkChartExtent.xmax=i.x),this.linkChartExtent.ymin>i.y&&(this.linkChartExtent.ymin=i.y),this.linkChartExtent.ymax<i.y&&(this.linkChartExtent.ymax=i.y)})}),this.memberRelationshipTypes.forEach(e=>{e.name&&this.dataManager.sublayerCaches.get(e.name)?.forEach(t=>{const a=this.relationshipLinkChartDiagramLookup.get(t.attributes[Y]),n=this.relationshipLinkChartDiagramLookup.get(t.attributes[Z]);if(a&&n){const i=q(new fe({paths:[[[a.coords[0],a.coords[1]],[n.coords[0],n.coords[1]]]]}));this.relationshipLinkChartDiagramLookup.set(t.attributes[C],i)}else this.relationshipLinkChartDiagramLookup.set(t.attributes[C],null)})})):await this._calculateLayoutWithSublayerTimeInfo(this.initializationLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.initializationLinkChartConfig}):await this._calculateLayoutWithSublayerTimeInfo("organic-standard",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateOrganicLayoutSettings(e,t){const a=T=>typeof T=="number"&&!isNaN(T),n=T=>a(T)&&T>=1,i=T=>a(T)&&T>=1,s=T=>Object.values(le).includes(T),r=T=>a(T)&&T>=0,h={};if(!new Set(["organic-standard","organic-community","geographic-organic-standard","chronological-multi-timeline","chronological-mono-timeline"]).has(e)||!t)return h;const{computationBudgetTime:p,autoRepulsionRadius:y,repulsionRadiusMultiplier:g,absoluteIdealEdgeLength:w,multiplicativeIdealEdgeLength:j,idealEdgeLengthType:S}=t;return i(p)?h.computationBudgetTime=p:p&&E.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),h.autoRepulsionRadius=y,!y&&n(g)?h.repulsionRadiusMultiplier=g:y||(h.autoRepulsionRadius=!0,E.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting")),e==="geographic-organic-standard"&&(s(S)?h.idealEdgeLengthType=S:S!==void 0&&E.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),S==="absolute-value"&&r(w)?h.absoluteIdealEdgeLength=w:S==="absolute-value"&&w!==void 0?E.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting"):S==="multiplier"&&r(j)?h.multiplicativeIdealEdgeLength=j:S==="multiplier"&&j!==void 0&&E.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),h}_convertValidatedOrganicSettingsToCalculationSettings(e){let t=e.idealEdgeLengthType===le.ABSOLUTE?e.absoluteIdealEdgeLength:e.multiplicativeIdealEdgeLength;return e.idealEdgeLengthType===le.ABSOLUTE&&(t===void 0?t=-1:t*=-1),{computationBudgetTime:e.computationBudgetTime??void 0,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier&&!e.autoRepulsionRadius?e.repulsionRadiusMultiplier:void 0,idealEdgeLengthMultiplier:t}}_createSublayer(e){return new V({objectType:e,parentCompositeLayer:this,graphType:e.type})}_handleSublayersChange(e,t){t&&(t.forEach(a=>{a.parent=null}),this.removeHandles("sublayers-owner")),e&&(e.forEach(a=>{a.parent=this}),this.addHandles([e.on("after-add",({item:a})=>{a.parent=this}),e.on("after-remove",({item:a})=>{a.parent=null})],"sublayers-owner"))}_alignLayersDataModelAndInclusionDefinition(e){const t=new Set((e.entityTypes??[]).map(i=>i.name).concat((e.relationshipTypes??[]).map(i=>i.name))),a=new Set((e.entityTypes??[]).map(i=>i.name)),n=new Set((e.relationshipTypes??[]).map(i=>i.name));if(this.layers){for(const s of this.layers)!s.graphType&&t.has(s.graphTypeName)&&(s.graphType=a.has(s.graphTypeName)?"entity":"relationship");const i=this.layers.filter(s=>t.has(s.graphTypeName)&&(s.graphType==="entity"?a.has(s.graphTypeName):n.has(s.graphTypeName)));this.setAtOrigin("layers",i,Ie(this.originIdOf("layers")))}else this.layers=new U;if(this.layers&&this._originalInclusionList){const i=new Set(this._originalInclusionList.namedTypeDefinitions.keys()),s=this.tables?.map(p=>p.graphTypeName)??[],r=this.layers.map(p=>p.graphTypeName).concat(s);for(const p of r)i.has(p)||this._originalInclusionList.namedTypeDefinitions.set(p,{useAllData:!1,members:new Map});const h=[];for(const p of this._originalInclusionList.namedTypeDefinitions.keys())r.includes(p)||(E.getLogger(this).warn(`A named type, ${p}, was in the serialized feature collection but did not have a sublayer config in the item, so will be removed`),h.push(p));for(const p of h)this._originalInclusionList.namedTypeDefinitions.delete(p)}}};b([M(Ke)],m.prototype,"url",void 0),b([M()],m.prototype,"dataPreloadedInLocalCache",void 0),b([M()],m.prototype,"initializationLinkChartConfig",void 0),b([M()],m.prototype,"membershipModified",void 0),b([M()],m.prototype,"dataManager",void 0),b([M()],m.prototype,"initializationInclusionModeDefinition",null),b([M()],m.prototype,"knowledgeGraph",void 0),b([M({type:U.ofType(V),json:{write:{ignoreOrigin:!0}}})],m.prototype,"layers",void 0),b([M({readOnly:!0})],m.prototype,"linkChart",null),b([M()],m.prototype,"entityLinkChartDiagramLookup",void 0),b([M()],m.prototype,"relationshipLinkChartDiagramLookup",void 0),b([M()],m.prototype,"linkChartExtent",void 0),b([M()],m.prototype,"memberEntityTypes",void 0),b([M()],m.prototype,"memberRelationshipTypes",void 0),b([M({type:["LinkChartLayer"]})],m.prototype,"operationalLayerType",void 0),b([M()],m.prototype,"sublayerCapabilities",null),b([M()],m.prototype,"sublayerIdsCache",void 0),b([M({type:U.ofType(V),json:{write:{ignoreOrigin:!0}}})],m.prototype,"tables",void 0),b([M({json:{read:!1}})],m.prototype,"type",void 0),b([M({json:{read:!1}})],m.prototype,"chronologicalAuxiliaryGraphics",void 0),m=b([_e("esri.layers.LinkChartLayer")],m);const Ze=m;export{Ze as default};
