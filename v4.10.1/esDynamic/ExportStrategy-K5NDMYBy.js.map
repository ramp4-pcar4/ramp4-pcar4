{"version":3,"file":"ExportStrategy-K5NDMYBy.js","sources":["../../node_modules/@arcgis/core/views/2d/viewStateUtils.js","../../node_modules/@arcgis/core/views/2d/layers/support/ExportStrategy.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nconst t=Math.PI/180;function n(n){return n*t}function o(t,o){const a=n(o.rotation),r=Math.abs(Math.cos(a)),s=Math.abs(Math.sin(a)),[u,c]=o.size;return t[0]=Math.round(c*s+u*r),t[1]=Math.round(c*r+u*s),t}function a(t,n,o,a){const[r,s]=n,[u,c]=a,h=.5*o;return t[0]=r-h*u,t[1]=s-h*c,t[2]=r+h*u,t[3]=s+h*c,t}export{a as getBBox,o as getOuterSize};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport{_ as t}from\"../../../../chunks/tslib.es6.js\";import e from\"../../../../core/Accessor.js\";import\"../../../../core/has.js\";import{debounce as i,throwIfAborted as o,throwIfAbortError as r,eachAlways as s}from\"../../../../core/promiseUtils.js\";import{property as a}from\"../../../../core/accessorSupport/decorators/property.js\";import\"../../../../core/Logger.js\";import\"../../../../core/RandomLCG.js\";import{subclass as n}from\"../../../../core/accessorSupport/decorators/subclass.js\";import{create as p,toExtent as m}from\"../../../../geometry/support/aaBoundingRect.js\";import{getInfo as h}from\"../../../../geometry/support/spatialReferenceUtils.js\";import l from\"../../../../layers/support/TileInfo.js\";import{getOuterSize as d,getBBox as c}from\"../../viewStateUtils.js\";import{Bitmap as u}from\"../../engine/Bitmap.js\";import g from\"../../tiling/TileInfoView.js\";import f from\"../../tiling/TileKey.js\";const y=p(),x=[0,0],S=new f(0,0,0,0),w={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};let M=class extends e{constructor(t){super(t),this._imagePromise=null,this.bitmaps=[],this.hidpi=w.hidpi,this.imageMaxWidth=w.imageMaxWidth,this.imageMaxHeight=w.imageMaxHeight,this.imageRotationSupported=w.imageRotationSupported,this.imageNormalizationSupported=w.imageNormalizationSupported,this.update=i((async(t,e)=>{if(o(e),!t.stationary||this.destroyed)return;const i=t.state,s=h(i.spatialReference),a=this.hidpi?t.pixelRatio:1,n=i.worldScreenWidth>0,p=n&&this.imageNormalizationSupported&&i.worldScreenWidth<i.size[0],m=Math.round((this.imageMaxWidth??0)/a),l=Math.round((this.imageMaxHeight??0)/a);p?(x[0]=i.worldScreenWidth,x[1]=i.size[1]):this.imageRotationSupported?(x[0]=i.size[0],x[1]=i.size[1]):d(x,i);const c=Math.floor(x[0])>m||Math.floor(x[1])>l,u=s&&(i.extent.xmin<s.valid[0]||i.extent.xmax>s.valid[1]),g=!this.imageNormalizationSupported&&u,f=!c&&!g,y=this.imageRotationSupported?i.rotation:0,S=this.container.children.slice();if(f){const t=p?i.paddedViewState.center:i.center;this._imagePromise=this._singleExport(i,x,t,i.resolution,y,a,e)}else{let t=Math.min(m,l);n&&(t=Math.min(i.worldScreenWidth,t),t=Math.round(i.worldScreenWidth/Math.ceil(i.worldScreenWidth/t))),this._imagePromise=this._tiledExport(i,t,a,e)}try{const t=await this._imagePromise??[];o(e);const i=[];if(this._imagePromise=null,this.destroyed)return;this.bitmaps=t;for(const e of S)t.includes(e)||i.push(e.fadeOut().then((()=>{e.remove(),e.destroy()})));for(const e of t)i.push(e.fadeIn());await Promise.all(i)}catch(w){this._imagePromise=null,r(w)}}),5e3),this.updateExports=i((async t=>{const e=[];for(const i of this.container.children){if(!i.visible||!i.stage)return;e.push(t(i).then((()=>{i.invalidateTexture(),i.requestRender()})))}this._imagePromise=s(e).then((()=>this._imagePromise=null)),await this._imagePromise}))}destroy(){this.bitmaps.forEach((t=>t.destroy())),this.bitmaps=[]}get updating(){return!this.destroyed&&null!==this._imagePromise}async _export(t,e,i,r,s,a){const n=await this.fetchSource(t,Math.floor(e*s),Math.floor(i*s),{rotation:r,pixelRatio:s,signal:a});o(a);const p=new u(null,!0);return p.x=t.xmin,p.y=t.ymax,p.resolution=t.width/e,p.rotation=r,p.pixelRatio=s,p.opacity=0,this.container.addChild(p),await p.setSourceAsync(n,a),o(a),p}async _singleExport(t,e,i,o,r,s,a){c(y,i,o,e);const n=m(y,t.spatialReference);return[await this._export(n,e[0],e[1],r,s,a)]}_tiledExport(t,e,i,o){const r=l.create({size:e,spatialReference:t.spatialReference,scales:[t.scale]}),s=new g(r),a=s.getTileCoverage(t);if(!a)return null;const n=[];return a.forEach(((r,a,p,h)=>{S.set(r,a,p,0),s.getTileBounds(y,S);const l=m(y,t.spatialReference);n.push(this._export(l,e,e,0,i,o).then((t=>(0!==h&&(S.set(r,a,p,h),s.getTileBounds(y,S),t.x=y[0],t.y=y[3]),t))))})),Promise.all(n)}};t([a()],M.prototype,\"_imagePromise\",void 0),t([a()],M.prototype,\"bitmaps\",void 0),t([a()],M.prototype,\"container\",void 0),t([a()],M.prototype,\"fetchSource\",void 0),t([a()],M.prototype,\"hidpi\",void 0),t([a()],M.prototype,\"imageMaxWidth\",void 0),t([a()],M.prototype,\"imageMaxHeight\",void 0),t([a()],M.prototype,\"imageRotationSupported\",void 0),t([a()],M.prototype,\"imageNormalizationSupported\",void 0),t([a()],M.prototype,\"requestUpdate\",void 0),t([a()],M.prototype,\"updating\",null),M=t([n(\"esri.views.2d.layers.support.ExportStrategy\")],M);const _=M;export{_ as default};\n"],"names":["t","n","o","a","r","u","c","s","h","y","p","x","S","f","w","M","e","i","l","d","g","m","_"],"mappings":"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","x_google_ignoreList":[0,1]}