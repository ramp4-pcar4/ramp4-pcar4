import{iS as b,iT as M,bZ as O,fm as $,gG as R,gH as D}from"./main-8eb577c9.js";import{f as A}from"./fabric-0b3762e6.js";import{_ as k}from"./screen.vue_vue_type_script_setup_true_lang-84faced3.js";import"./preload-helper-388ac9d5.js";var H={exports:{}};(function(T,n){(function(r,h){h()})(b,function(){function r(t,o){return typeof o>"u"?o={autoBom:!1}:typeof o!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),o={autoBom:!o}),o.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\uFEFF",t],{type:t.type}):t}function h(t,o,p){var e=new XMLHttpRequest;e.open("GET",t),e.responseType="blob",e.onload=function(){x(e.response,o,p)},e.onerror=function(){console.error("could not download file")},e.send()}function l(t){var o=new XMLHttpRequest;o.open("HEAD",t,!1);try{o.send()}catch{}return 200<=o.status&&299>=o.status}function d(t){try{t.dispatchEvent(new MouseEvent("click"))}catch{var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(o)}}var s=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof b=="object"&&b.global===b?b:void 0,v=s.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),x=s.saveAs||(typeof window!="object"||window!==s?function(){}:"download"in HTMLAnchorElement.prototype&&!v?function(t,o,p){var e=s.URL||s.webkitURL,i=document.createElement("a");o=o||t.name||"download",i.download=o,i.rel="noopener",typeof t=="string"?(i.href=t,i.origin===location.origin?d(i):l(i.href)?h(t,o,p):d(i,i.target="_blank")):(i.href=e.createObjectURL(t),setTimeout(function(){e.revokeObjectURL(i.href)},4e4),setTimeout(function(){d(i)},0))}:"msSaveOrOpenBlob"in navigator?function(t,o,p){if(o=o||t.name||"download",typeof t!="string")navigator.msSaveOrOpenBlob(r(t,p),o);else if(l(t))h(t,o,p);else{var e=document.createElement("a");e.href=t,e.target="_blank",setTimeout(function(){d(e)})}}:function(t,o,p,e){if(e=e||open("","_blank"),e&&(e.document.title=e.document.body.innerText="downloading..."),typeof t=="string")return h(t,o,p);var i=t.type==="application/octet-stream",w=/constructor/i.test(s.HTMLElement)||s.safari,u=/CriOS\/[\d]+/.test(navigator.userAgent);if((u||i&&w||v)&&typeof FileReader<"u"){var f=new FileReader;f.onloadend=function(){var a=f.result;a=u?a:a.replace(/^data:[^;]*;/,"data:attachment/file;"),e?e.location.href=a:location=a,e=null},f.readAsDataURL(t)}else{var m=s.URL||s.webkitURL,g=m.createObjectURL(t);e?e.location=g:location.href=g,e=null,setTimeout(function(){m.revokeObjectURL(g)},4e4)}});s.saveAs=x.saveAs=x,T.exports=x})})(H);var j=H.exports;const B=M(j);A.fabric.Object.prototype.objectCaching=!1;const F=1200,c={TOP:40,RIGHT:40,BOTTOM:40,LEFT:40};class _ extends O{fcFabric;fcFabricDownload;options={runningHeight:0,scale:1};get config(){return super.config}_parseConfig(n){if(!n)return;const r=$(this.$vApp.$pinia);r.componentSelectedState={title:n.title?.selected??!0,map:n.map?.selected??!0,mapElements:n.mapElements?.selected??!0,legend:n.legend?.selected??!0,footnote:n.footnote?.selected??!0,timestamp:n.timestamp?.selected??!0},r.fileName=n.fileName||"",this.handlePanelWidths(["export"]),this.handlePanelTeleports(["export"])}getSubFixture(n){return this.$iApi.fixture.get(n)}async make(n,r){const h=$(this.$vApp.$pinia);this.fcFabric=new A.fabric.StaticCanvas(n,{backgroundColor:"#fff"}),this.fcFabricDownload=new A.fabric.StaticCanvas(null,{backgroundColor:"#fff"}),this.options.runningHeight=0;const l=h.componentSelectedState,d=this.getSubFixture("export-title"),s=this.getSubFixture("export-map"),v=this.getSubFixture("export-scalebar"),x=this.getSubFixture("export-northarrow"),t=this.getSubFixture("export-legend"),o=this.getSubFixture("export-footnote"),p=this.getSubFixture("export-timestamp");let e,i,w,u,f,m,g;const a=[];l.title&&d&&(e=await d.make({top:this.options.runningHeight,left:0,originX:"left",width:r,textAlign:"center"}),this.options.runningHeight+=e.height+40,a.push(e)),l.map&&s&&(i=await s.make({top:this.options.runningHeight}),e&&(e.left=i.width/2,e.originX="center"),this.options.runningHeight+=i.height+40,a.push(i)),!i&&e&&(e.width=F),this.options.scale=r/((i?.width??F)+c.LEFT+c.RIGHT),l.mapElements&&v&&(w=await v.make({top:this.options.runningHeight,left:0}),this.options.runningHeight+=w.height+40,a.push(w),x&&(u=await x.make({top:w.top,left:r/this.options.scale}),u.top+=u.height/2-20,u.left+=-u.width*2,a.push(u))),l.legend&&t&&(f=await t.make({width:t.config?.columnWidth??i?.width??F}),f.top=this.options.runningHeight,this.options.runningHeight+=f.height,a.push(f)),l.timestamp&&p&&(g=await p.make({top:this.options.runningHeight+20,width:r}),this.options.runningHeight+=g.height,a.push(g)),l.footnote&&o&&(m=await o.make({top:this.options.runningHeight,left:r/this.options.scale+40}),m.left+=-m.width*2,this.options.runningHeight+=m.height+20,a.push(m));const E=new A.fabric.Group(a,{top:c.TOP*this.options.scale,left:c.LEFT*this.options.scale}),S=await new Promise(L=>{E.clone(y=>{L(y)})});S.top=c.TOP,S.left=c.LEFT,this.fcFabricDownload.add(S),E.scale(this.options.scale),this.fcFabric.add(E),this.fcFabric.setDimensions({width:r,height:(this.options.runningHeight+c.TOP+c.BOTTOM)*this.options.scale}),this.fcFabric.renderAll(),this.fcFabricDownload.setDimensions({width:(i?.width??F)+c.LEFT+c.RIGHT,height:this.options.runningHeight+c.TOP+c.BOTTOM}),this.fcFabricDownload.renderAll()}export(){if(!this.fcFabric)return;const n=new Date,r=this.config?.fileName||`map-carte - ${n.getFullYear()}-${n.getMonth()}-${n.getDay()}, ${n.getHours()}_${n.getMinutes()}`;B.saveAs(this.fcFabricDownload.toDataURL({format:"png",quality:1}),`${r}.png`)}}const N={en:{"export.title":"Export","export.alertName":"Export","export.download":"Download image","export.refresh":"Refresh","export.scaleBar.approx":"{0} approx.","export.menu":"Settings Menu","export.menu.component.title":"Title","export.menu.component.map":"Map","export.menu.component.mapElements":"North arrow and scalebar","export.menu.component.legend":"Legend","export.menu.component.footnote":"Footnote","export.menu.component.timestamp":"Timestamp"},fr:{"export.title":"Exporter","export.alertName":"Exporter","export.download":"Télécharger l'image","export.refresh":"Rafraîchir","export.scaleBar.approx":"Environ {0}","export.menu":"Menu des paramètres","export.menu.component.title":"Titre","export.menu.component.map":"Carte","export.menu.component.mapElements":"Flèche du nord et échelle graphique","export.menu.component.legend":"Légende","export.menu.component.footnote":"Référence","export.menu.component.timestamp":"Horodatage"}};class C extends _{initialized(){this.$iApi.fixture.add("export-title"),this.$iApi.fixture.add("export-map"),this.$iApi.fixture.add("export-legend"),this.$iApi.fixture.add("export-northarrow"),this.$iApi.fixture.add("export-scalebar"),this.$iApi.fixture.add("export-timestamp"),this.$iApi.fixture.add("export-footnote")}added(){this.$iApi.panel.register({id:"export",config:{screens:{"export-screen":R(k)},style:{"flex-grow":"1","max-width":"800px"},button:{tooltip:"export.title",icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none" /><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" /></svg>'},alertName:"export.alertName"}},{i18n:{messages:N}}),this._parseConfig(this.config);const n=this.$vApp.$watch(()=>this.config,r=>this._parseConfig(r));this.removed=()=>{n(),this.$iApi.fixture.get("export-title")?.remove(),this.$iApi.fixture.get("export-map")?.remove(),this.$iApi.fixture.get("export-legend")?.remove(),this.$iApi.fixture.get("export-northarrow")?.remove(),this.$iApi.fixture.get("export-scalebar")?.remove(),this.$iApi.fixture.get("export-timestamp")?.remove(),this.$iApi.fixture.get("export-footnote")?.remove(),this.$iApi.fixture.get("appbar")&&D(this.$vApp.$pinia).removeButton("export"),$(this.$vApp.$pinia).$reset(),this.$iApi.panel.remove("export")}}}export{C as default};
