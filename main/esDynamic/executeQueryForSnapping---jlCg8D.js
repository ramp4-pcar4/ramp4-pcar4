import{cF as I,h as S,bI as T,bw as w}from"./main-CnDVnExo.js";import{R as h}from"./normalizeUtils-CahpTq5j.js";import{B as v,x as O,j as g}from"./queryUtils-Djye3faZ.js";import{d as Q,O as j,V as q}from"./QueryEngine-BTiuHzq6.js";import{I as E}from"./timeSupport-CXlK9Us3.js";async function M(e,s,o){const a=I(o),{point:t,distance:i,returnEdge:u,vertexMode:m}=s;if(!u&&m==="none")return{candidates:[]};let r=S(s.query);r=await e.schedule(()=>v(r,e.definitionExpression,e.spatialReference),a),r=await e.reschedule(()=>Q(r,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),a);const l=!T(t.spatialReference,e.spatialReference);l&&await O(t.spatialReference,e.spatialReference);const p=typeof i=="number"?i:i.x,f=typeof i=="number"?i:i.y,d={xmin:t.x-p,xmax:t.x+p,ymin:t.y-f,ymax:t.y+f,spatialReference:t.spatialReference},n=l?g(d,e.spatialReference):d;if(!n)return{candidates:[]};const y=(await h(w(t),null,{signal:a}))[0],x=(await h(w(n),null,{signal:a}))[0];if(y==null||x==null)return{candidates:[]};const c=new j(await e.reschedule(()=>e.searchFeatures(q(x.toJSON())),a),r,e);await e.reschedule(()=>e.executeObjectIdsQuery(c),a),await e.reschedule(()=>e.executeTimeQuery(c),a),await e.reschedule(()=>e.executeAttributesQuery(c),a),await e.reschedule(()=>B(e,c,a),a);const R=y.toJSON(),b=l?g(R,e.spatialReference):R,F=l?Math.max(n.xmax-n.xmin,n.ymax-n.ymin)/2:i;return c.createSnappingResponse({...s,point:b,distance:F},r.returnZ,t.spatialReference)}async function B(e,s,o){const{query:a}=s,{spatialRel:t}=a;if(!s?.items?.length||!a.geometry||!t)return;const i=await E(t,a.geometry,e.geometryType,e.hasZ,e.hasM),u=await e.runSpatialFilter(s.items,m=>i(m.geometry),o);s.items=u}export{M as u};
