import{Z as W,dX as w,dW as S,db as b,dY as I,a3 as K,T as M,J as T,dZ as Q,d_ as Z}from"./main-CnDVnExo.js";import{t as z}from"./arcade-g-h2psGD.js";import{a as k,p as G,x as B,q as P,j as q,i as C,y as A,z as E,A as H,E as O,H as D}from"./aiServices-DNHDbNOt.js";import{a as l,r as p}from"./enum-BZRMMRUi.js";import{l as U}from"./portalUtils-C0NwLfO9.js";import{K as V,O as X,k as Y}from"./projectionUtils-B4YRVrjd.js";import _ from"./PortalItem-DT83duN4.js";import{p as L,n as $}from"./project-BagIF3vW.js";import{s as rr,p as tr,e as er,i as ar,a as nr}from"./Relationship-DOxbUlPo.js";let f=null;async function ir(r){const t=M.geometryServiceUrl??"";if(!t){Y()||await V();for(const e of r)e.container[e.indexer]=X(e.container[e.indexer],T.WGS84);return}const a=r.map(e=>e.container[e.indexer]),i=new L({geometries:a,outSpatialReference:T.WGS84}),s=await $(t,i);for(let e=0;e<s.length;e++){const n=r[e];n.container[n.indexer]=s[e]}}async function F(r,t){const a=new _({portal:r,id:t});return await a.load(),f===null&&(f=await import("./knowledgeGraphService-DEgGWJlm.js").then(i=>i.k)),await f.fetchKnowledgeGraph(a.url)}function v(r,t,a,i,s){if(r===null)return null;if(w(r)||b(r))return r;if(A(r)||A(r))return r.toJSDate();if(E(r))return r.toStorageFormat();if(H(r))return r.toStorageString();if(O(r)){const e={};for(const n of r.keys())e[n]=v(r.field(n),t,a,i,s),e[n]instanceof I&&s.push({container:e,indexer:n});return e}if(S(r)){const e=r.map(n=>v(n,t,a,i,s));for(let n=0;n<e.length;n++)e[n]instanceof I&&s.push({container:e,indexer:n});return e}return D(r)?r.spatialReference.isWGS84?r:r.spatialReference.isWebMercator&&t?K(r):r:void 0}function or(r,t){if(!r)return r;if(r.spatialReference.isWGS84&&t.spatialReference.isWebMercator)return Z(r);if(r.spatialReference.equals(t.spatialReference))return r;throw new l(t,p.WrongSpatialReference,null)}function R(r,t){if(!r)return null;const a={};for(const i in r)a[i]=m(r[i],t);return a}function m(r,t){return r===null?null:S(r)?r.map(a=>m(a,t)):r instanceof tr?{graphTypeName:r.typeName,id:r.id,graphType:"entity",properties:R(r.properties,t)}:r instanceof er?{graphType:"object",properties:R(r.properties,t)}:r instanceof ar?{graphTypeName:r.typeName,id:r.id,graphType:"relationship",originId:r.originId??null,destinationId:r.destinationId??null,properties:R(r.properties,t)}:r instanceof nr?{graphType:"path",path:r.path?r.path.map(a=>m(a,t)):null}:D(r)?or(r,t):w(r)||b(r)||Q(r)?r:null}function sr(r){r.mode==="async"&&(r.functions.knowledgegraphbyportalitem=function(t,a){return r.standardFunctionAsync(t,a,(i,s,e)=>{if(k(e,2,2,t,a),e[0]===null)throw new l(t,p.PortalRequired,a);if(e[0]instanceof z){const d=G(e[1]);let u;return u=t.services?.portal?t.services.portal:W.getDefault(),F(U(e[0],u),d)}if(w(e[0])===!1)throw new l(t,p.InvalidParameter,a);const n=G(e[0]);return F(t.services?.portal??W.getDefault(),n)})},r.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),r.functions.querygraph=function(t,a){return r.standardFunctionAsync(t,a,async(i,s,e)=>{k(e,2,4,t,a);const n=e[0];if(!B(n))throw new l(t,p.InvalidParameter,a);const d=e[1];if(!w(d))throw new l(t,p.InvalidParameter,a);f===null&&(f=await import("./knowledgeGraphService-DEgGWJlm.js").then(o=>o.k));let u=null;const h=P(e[2],null);if(!(h instanceof q||h===null))throw new l(t,p.InvalidParameter,a);if(h){let o=[];u=v(h,!0,!1,t,o),o=o.filter(c=>!c.container[c.indexer].spatialReference.isWGS84),o.length>0&&await ir(o)}const N=P(e[3],!1),x=new rr({openCypherQuery:d,bindParameters:u,provenanceBehavior:N?"include":"exclude"});(n?.serviceDefinition?.currentVersion??11.3)>11.2&&(x.outputSpatialReference=t.spatialReference);const J=(await f.executeQueryStreaming(n,x)).resultRowsStream.getReader(),y=[];try{for(;;){const{done:o,value:c}=await J.read();if(o)break;if(S(c))for(const g of c)y.push(m(g,t));else{const g=[];for(const j of c)g.push(m(c[j],t));y.push(g)}}}catch(o){throw o}return q.convertJsonToArcade(y,C(t),!1,!0)})},r.signatures.push({name:"querygraph",min:2,max:4}))}export{sr as registerFunctions};
