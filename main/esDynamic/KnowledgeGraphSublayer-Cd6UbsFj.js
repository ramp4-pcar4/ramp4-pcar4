import{J as Fe,a0 as je,aS as U,s as H,bw as ct,fg as ut,D as qe,n as yt,i as $e,u as ht,cV as z,bY as se,i2 as Pe,am as Ge,v as m,x as g,z as me,eo as te,bh as Ue,ds as mt,dh as ie,ga as ft,bm as gt,al as bt,bZ as Tt,h as O,by as wt,H as It,c5 as Et}from"./main-CnDVnExo.js";import{e as _t}from"./OptimizedGeometry-BBZXbf77.js";import{i as fe,r as Nt,a as ge,b as W,l as Lt}from"./knowledgeGraphService-DEgGWJlm.js";import{Q as be,O as le}from"./projectionUtils-B4YRVrjd.js";import{I as pe,t as de,_ as q,E as ne,S as Te,o as we}from"./constants-5AlnYBiV.js";import{u as Mt}from"./featureConversionUtils-DJPd03TP.js";import{s as He}from"./OptimizedFeature-Ch3Mnc5k.js";import"./GraphicsLayer-BFz-x5ra.js";import{s as B}from"./Relationship-DOxbUlPo.js";import{R as Y}from"./Query-B3kr4GG5.js";import{S as St}from"./MultiOriginJSONSupport-Ruo0_g0o.js";import{E as vt}from"./workers-COYZ-Fi7.js";import{h as Dt}from"./Layer-CmkLQVqW.js";import{f as Rt}from"./FeatureStore-B0ERptus.js";import{L as Ct}from"./QueryEngine-BTiuHzq6.js";import{y as kt,u as ze}from"./clientSideDefaults-DNcFUTLf.js";import{s as xt}from"./fieldProperties-D6eH-God.js";import{A as Z,d as re,l as At}from"./labelingInfo-CSbKYIkt.js";import{p as Ot,n as Ft,l as jt}from"./BlendLayer-BDk2CQB5.js";import{a as qt,p as $t,l as Pt}from"./DisplayFilteredLayer-CGSGYcab.js";import{c as Gt,p as Ut}from"./FeatureEffectLayer-Bg0GWBLK.js";import{d as Ht,p as zt}from"./FeatureReductionLayer-x1gAhrqF.js";import{p as Bt,c as Qt}from"./OrderedLayer-Ce5Zvw1A.js";import{f as Jt}from"./RefreshableLayer-D50o-qLz.js";import{t as Vt}from"./ScaleRangeLayer-C11AuBvk.js";import{c as Wt,f as Yt}from"./TemporalLayer-CJyRpOty.js";import{d as Zt,v as Kt,j as Xt,w as ei,l as ti}from"./OperationalLayer-A4hDIwth.js";import{m as ce}from"./Field-aY1vu-yl.js";import{u as ii}from"./TimeInfo-Cat8-OUc.js";import{m as ni}from"./SimpleRenderer-CvNHC6Ed.js";import{fromJSON as Be}from"./jsonUtils-Bbdlzfrl.js";import{m as ri}from"./typeUtils-kZYFTRE_.js";import{g as oi}from"./FeatureSet-DClCm5PU.js";import{p as ai}from"./popupUtils-DOiXoTRP.js";import{L as Qe}from"./utils-m8U_TYuN.js";let si=class{constructor(){this.version="",this.queryResult=new li}},li=class{constructor(){this.featureResult=new pi}},pi=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new di,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new ci,this.geometryType=null,this.spatialReference=new Fe,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new Je,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},di=class{constructor(){this.name="",this.isSystemMaintained=!1}},ci=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},Je=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new ui,this.translate=new yi}};class ui{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}let yi=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},hi=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},mi=class{constructor(){this.attributes=[],this.compressedGeometry=new Ie,this.centroid=new Ie,this.aggregateGeometries=[]}},Ie=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var K;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(K||(K={}));const fi=[K.ELEMENTUID,K.TYPENAME];var Ve,We;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(Ve||(Ve={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(We||(We={}));var Ye,Ee,_e,X;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(Ye||(Ye={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(Ee||(Ee={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(_e||(_e={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(X||(X={}));function gi(e){const t=new si;t.version=e.version;const n=e.get_query_result();if(n.results_type.value!==0)throw new Error("Got a non-feature collection type");const i=n.get_feature_result(),r=t.queryResult.featureResult;r.objectIdFieldName=i.objectid_field_name,r.exceededTransferLimit=i.exceeded_transfer_limit,r.hasM=i.has_m,r.hasZ=i.has_z,r.geometryType=fe[i.geometry_type.value],r.globalIdFieldName=i.globalid_field_name,r.geohashFieldName=i.geohash_field_name;const o=r.uniqueIdField,p=i.unique_id_field;o.name=p.name,o.isSystemMaintained=p.isSystemMaintained;const s=r.geometryProperties,h=i.geometry_properties;s.shapeAreaFieldName=h.shapeAreaFieldName,s.shapeLengthFieldName=h.shapeLengthFieldName,s.units=h.units;const a=r.spatialReference,l=i.spatial_reference;a.wkid=l.wkid,a.latestWkid=l.latestWkid,a.vcsWkid=l.vcsWkid,a.latestVcsWkid=l.latestVcsWkid,a.wkt=l.wkt,r.transform=Ti(i.transform);const c=r.fields,d=r.fieldNameToAttributeIndexMap,u=i.fields,b=u.size();for(let _=0;_<b;_++){const M=u.get(_),D=Ze(M);c.push(D),d[D.name]=_,M.delete()}u.delete();const f=r.values,S=i.values_count();for(let _=0;_<S;_++)f.push(i.get_value_at(_));const N=r.features,E=i.features,L=E.size();if(L>0){for(const _ of fi)if(d[_]===void 0)throw new Error(`Feature collection missing required attribute: ${_}`)}for(let _=0;_<L;_++){const M=new mi,D=E.get(_),$=M.attributes,R=D.attributes_count();for(let G=0;G<R;G++)$.push(D.get_attribute_at(G));const x=D.get_compressed_geometry();x&&(M.compressedGeometry=Ne(x),M.centroid=Ne(D.get_centroid()));const C=M.aggregateGeometries,A=D.aggregate_geometries,k=A.size();for(let G=0;G<k;G++){const V=A.get(G),ee=Ne(V);C.push(ee),V.delete()}A.delete(),N.push(M),D.delete()}E.delete();const v=r.geometryFields,w=i.geometry_fields,y=w.size();for(let _=0;_<y;_++){const M=w.get(_),D=bi(M);v.push(D),M.delete()}return w.delete(),t}function Ne(e){const t=new Ie;t.geometryType=fe[e.geometry_type.value];const n=[],i=[];for(let r=0;r<e.lengths.length;r++)n.push(e.lengths[r]);for(let r=0;r<e.coords.length;r++)i.push(e.coords[r]);return t.lengths=n,t.coords=i,t}function Ze(e){const t=new hi;return t.name=e.name,t.alias=e.alias,t.fieldType=Nt[e.field_type.value],t.sqlType=_e[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function bi(e){const t=Ze(e);return t.geometryType=fe[e.geometry_type.value],t}function Ti(e){const t=new Je;t.quantizeOriginPosition=Ee[e.quantizeOriginPosition.value];const n=t.scale,i=e.scale;n.xScale=i.xScale,n.yScale=i.yScale,n.mScale=i.mScale,n.zScale=i.zScale;const r=t.translate,o=e.translate;return r.xTranslate=o.xTranslate,r.yTranslate=o.yTranslate,r.mTranslate=o.mTranslate,r.zTranslate=o.zTranslate,t}async function wi(e){const t=[],n={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(Ke(e.entitiesUrl).then(i=>{Xe(i,n)})),e.relationshipsUrl&&t.push(Ke(e.relationshipsUrl).then(i=>{Xe(i,n)})),await Promise.all(t),n}async function Ii(e,t){t??=!1;const n={generateAllSublayers:t,namedTypeDefinitions:new Map};return await Li(e).then(i=>{Si(i,n)}),n}async function Ei(e){const t=await ge(),n=new t.MapOfObjectIdentifierSets;_i(n,t,e);const i=new t.MapOfObjectIdentifierSetsEncoder;try{i.set_map_of_identifier_sets(n),i.encode();const r=i.get_encoding_result();if(r.error.error_code!==0)throw new H("knowledge-graph:layer-support-utils",r.error.error_message);const o=structuredClone(r.get_byte_buffer());return i.delete(),o}finally{n.delete()}}function _i(e,t,n){for(const[i,r]of n.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const o=r.members.keys();let p=!1,s=!0;const h=new t.ObjectIdArray,a=new t.StringArray,l=new t.GlobalIdArray,c=new t.IdentifierArray,d=new t.ObjectIdentifierSet;for(const u of o)s&&(p=!isNaN(Number(u)),s=!1),p?h.add_objectid(Number(u)):(a.add_string(u),l.add_globalid(u)),c.add_identifier(u);d.set_oid_array(h),d.set_string_array(a),d.set_globalid_array(l),d.set_identifier_array(c),h.delete(),a.delete(),l.delete(),c.delete(),e.put_identifier_set(i,d),d.delete()}return e}async function Ke(e){const t=await je(e,{responseType:"array-buffer"});return Ni(await t.data)}async function Ni(e){const t=new(await ge()).FeatureCollectionDecoder,n=t.decode(new Uint8Array(e));if(n.error_code!==0)throw new H("knowledge-graph:layer-support-utils",n.error_message);const i=t.get_feature_collection(),r=gi(i);return t.delete(),r}async function Li(e){const t=await je(e,{responseType:"array-buffer"}),n=await t.data;return Mi(new Uint8Array(n))}async function Mi(e){const t=new(await ge()).MapOfObjectIdentifierSetsDecoder,n=t.decode(new Uint8Array(e)),i=new Map;if(n.error_code!==0)throw new H("knowledge-graph:layer-support-utils",n.error_message);const r=t.get_map_of_identifier_sets(),o=r.keys,p=o.size();for(let s=0;s<p;s++){const h=o.get(s),a=r.query_identifier_set(h),l=[];if(a.id_array_type.value===X.GLOBALID_ARRAY){const c=a.get_globalid_array(),d=c.count();for(let u=0;u<d;u++)l.push(c.get_globalid_at(u))}else if(a.id_array_type.value===X.IDENTIFIER_ARRAY){const c=a.get_identifier_array(),d=c.count();for(let u=0;u<d;u++)l.push(c.get_identifier_at(u).toString())}else if(a.id_array_type.value===X.STRING_ARRAY){const c=a.get_string_array(),d=c.count();for(let u=0;u<d;u++)l.push(c.get_string_at(u))}else{if(a.id_array_type.value!==X.OID_ARRAY)throw new H("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const c=a.get_oid_array(),d=c.count();for(let u=0;u<d;u++)l.push(c.get_objectid_at(u).toString())}}i.set(h,l)}return t.delete(),i}function Xe(e,t){if(!e?.queryResult?.featureResult)return t;const n=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const i of e.queryResult.featureResult.features){const r=i.attributes[n[K.TYPENAME]],o=U(t.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map})),p=i.attributes[n[K.ELEMENTUID]];if(i.compressedGeometry?.coords?.length>0){let s=i.compressedGeometry.lengths;i.compressedGeometry.geometryType==="esriGeometryPoint"&&(s=[]),o.members.set(p,{id:p,linkChartLocation:new _t(s,i.compressedGeometry.coords)})}else o.members.set(p,{id:p})}return t}function Si(e,t){for(const[n,i]of e){const r=U(t.namedTypeDefinitions,n,()=>({useAllData:!1,members:new Map}));for(const o of i)r.members.has(o)||r.members.set(o,{id:o})}return t}const vi={fetchAndConvertSerializedLinkChart:e=>wi(e)};let ue=class J{constructor(){this._featureLookup=new Map}static getInstance(){return J.instance||(J.instance=new J),J.instance}static resetInstance(){J.instance&&(J.instance=null)}deleteFromStore(t){t.forEach(n=>{this._featureLookup.delete(n)})}readFromStoreByList(t){const n=[];return t.forEach(i=>{const r=this.readFromStoreById(i);r&&n.push(r)}),n}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,n,i){const r=[];return t.forEach(o=>{if(!o?.id)return;o.properties||(o.properties=[]);let p,s=null;if(i&&o.properties[i]&&(s=Mt(o.properties[i])),"originId"in o&&"destinationId"in o&&(o.properties[pe]=o.originId,o.properties[de]=o.destinationId),o.properties[n]=o.id,o.id&&this._featureLookup.has(o.id)&&this._featureLookup.get(o.id).attributes){const h=this._featureLookup.get(o.id),a=JSON.parse(JSON.stringify(Object.assign(h.attributes,o.properties)));i&&o.properties[i]&&(a[i]=ct(o.properties[i])),p=new He(s?JSON.parse(JSON.stringify(s)):h?.geometry?JSON.parse(JSON.stringify(h.geometry)):null,a,null,o.properties[n])}else p=new He(s?JSON.parse(JSON.stringify(s)):null,o.properties,null,o.properties[n]);this._featureLookup.set(`${o.typeName?`${o.typeName}__${o.id}`:o.id}`,p),r.push(p)}),r}},Le,I=null;function Di(){return Le||(Le=import("./lclayout-uHKPd4rG.js").then(e=>e.l).then(({default:e})=>e({locateFile:t=>ut(`esri/libs/linkchartlayout/${t}`)})).then(e=>{Ri(e)}),Le)}function Ri(e){I=e}var Me,P,Se,ye;(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot",e[e.IsOld=8]="IsOld"})(Me||(Me={})),function(e){e[e.Success=0]="Success",e[e.Error=1]="Error",e[e.Canceled=2]="Canceled"}(P||(P={})),function(e){e[e.Regular=0]="Regular",e[e.Curved=1]="Curved",e[e.Recursive=2]="Recursive"}(Se||(Se={})),function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom"}(ye||(ye={}));const et={none:0,"start-only":1,"start-and-end":2};function Ci(e){const t={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...e?.toJSON()??{},eventsTicksVisualization:e?.eventsTicksVisualization??"start-and-end"};return{...t,timeDirection:{value:ye[t.timeDirection]??ye.right},eventsTicksVisualization:{value:et[t.eventsTicksVisualization]??et["start-and-end"]}}}function Q(e,t,n,i,r,o){const p=n.length,s=r.length,h=Float64Array.BYTES_PER_ELEMENT,a=Uint32Array.BYTES_PER_ELEMENT,l=Uint8Array.BYTES_PER_ELEMENT,c=16,d=c+p*(l+2*h)+s*(2*a),u=I._malloc(d);try{const b=u+c-u%c,f=b+p*h,S=f+p*h,N=S+s*a,E=N+s*a,L=()=>[I.HEAPF64.subarray(b>>3,(b>>3)+p),I.HEAPF64.subarray(f>>3,(f>>3)+p),I.HEAPU32.subarray(S>>2,(S>>2)+s),I.HEAPU32.subarray(N>>2,(N>>2)+s),I.HEAPU8.subarray(E,E+p)],[v,w,y,_,M]=L();v.set(n),w.set(i),y.set(r),_.set(o),M.set(t);const D=e(p,E,b,f,s,S,N);let $=null,R=null;if(D.value===P.Success){const V=I.getLayoutLinksTypes(),ee=I.getLayoutLinksVerticesEndIndices(),he=I.getLayoutLinksVertices(),Oe=I.countLayoutLinksVertices();!s||V&&ee?Oe&&!he?D.value=P.Error:($={types:new Uint8Array(I.HEAPU8.subarray(V,V+s)),vertexEndIndex:new Uint32Array(I.HEAPU32.subarray(ee>>2,(ee>>2)+s)),vertices:new Float64Array(I.HEAPF64.subarray(he>>3,(he>>3)+2*Oe))},R=I.getAuxiliaryGraphicElements()):D.value=P.Error}const[x,C,A,k,G]=L();return n.set(x),i.set(C),r.set(A),o.set(k),t.set(G),{status:D.value,links:$,graphics:R}}finally{I._free(u),I.cleanupLayout()}}const tt=2,it=1,nt=-1;var ve,De,Re,Ce,ke,xe,Ae,rt,ot;(function(e){function t(){return I.getMinIdealEdgeLength()}function n(i,r,o,p,s,h,a=tt,l=it,c=nt){return Q((d,u,b,f,S,N,E)=>I.applyForceDirectedLayout(i,d,u,b,f,S,N,E,a,l,c),r,o,p,s,h)}e.getMinIdealEdgeLength=t,e.apply=n})(ve||(ve={})),function(e){function t(n,i,r,o,p,s,h=tt,a=it,l=nt){return Q((c,d,u,b,f,S,N)=>I.applyCommunityLayout(n,c,d,u,b,f,S,N,h,a,l),i,r,o,p,s)}e.apply=t}(De||(De={})),function(e){function t(n,i,r,o,p,s){return Q((h,a,l,c,d,u,b)=>I.applySimpleLayout(n,h,a,l,c,d,u,b),i,r,o,p,s)}e.apply=t}(Re||(Re={})),function(e){function t(n,i,r,o,p,s){return Q((h,a,l,c,d,u,b)=>I.applyHierarchicalLayout(n,h,a,l,c,d,u,b),i,r,o,p,s)}e.apply=t}(Ce||(Ce={})),function(e){function t(n,i,r,o,p,s){return Q((h,a,l,c,d,u,b)=>I.applyRadialTreeLayout(n,h,a,l,c,d,u,b),i,r,o,p,s)}e.apply=t}(ke||(ke={})),function(e){function t(n,i,r,o,p,s){return Q((h,a,l,c,d,u,b)=>I.applySmartTreeLayout(n,h,a,l,c,d,u,b),i,r,o,p,s)}e.apply=t}(xe||(xe={})),function(e){function t(n,i,r,o,p,s,h,a,l,c,d,u){return Q((b,f,S,N,E,L,v)=>{if(p.length!==b)return{value:P.Error};if(s.length!==b)return{value:P.Error};if(l.length!==E)return{value:P.Error};if(c.length!==E)return{value:P.Error};const w=Float64Array.BYTES_PER_ELEMENT,y=16,_=I._malloc(y+b*w),M=I._malloc(y+b*w),D=I._malloc(y+E*w),$=I._malloc(y+E*w),R=_+y-_%y,x=M+y-M%y,C=D+y-D%y,A=$+y-$%y;try{return I.HEAPF64.subarray(R>>3,(R>>3)+b).set(p),I.HEAPF64.subarray(x>>3,(x>>3)+b).set(s),I.HEAPF64.subarray(C>>3,(C>>3)+E).set(l),I.HEAPF64.subarray(A>>3,(A>>3)+E).set(c),I.applyChronologicalLayout(n,b,f,S,N,R,x,E,L,v,C,A,d,Ci(u))}finally{I._free(_),I._free(M),I._free(D),I._free($)}},i,r,o,h,a)}e.apply=t}(Ae||(Ae={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(rt||(rt={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(ot||(ot={})),qe()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"}),qe()({absoluteValue:"absolute-value",multiplier:"multiplier"});const ki=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function xi(e,t){const n=new Map;if(t.dataModel?.relationshipTypes)for(const i of t.dataModel.relationshipTypes)i.name&&n.set(i.name,[]);for(const i of e)n.has(i.typeName)&&n.get(i.typeName)?.push(i.id);return n}async function Ai(e,t,n){const i=[],r=xi(e,t),o={},p=[];for(const[l,c]of r){if(c.length<1)continue;const d=`${l}_ids`;o[d]=c,p.push(`MATCH (n)-[r:${l}]->(m) WHERE id(r) in $${d} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(p.length===0)return[];const s=p.join(" UNION "),h=new B({openCypherQuery:s,bindParameters:o}),a=(await W(t,h,n?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:l,value:c}=await a.read();if(l)break;for(const d of c)i.push({id:d[0],typeName:d[1]}),i.push({id:d[2],typeName:d[3]})}return i}const Oi=e=>ki.get(e)??"radial-root-centric";function Fi(e){if(!e.spatialReference.isWGS84)throw new H("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]])}let j=class extends yt{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(n=>{n.name&&(t.set(n.name,"entity"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(n.name),n.properties?.forEach(i=>{i.geometryType&&i.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(n.name,{name:i.name??"",geometryType:i.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(n=>{n.name&&(t.set(n.name,"relationship"),this._processingCacheUpdatesLookup.set(n.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(n.name),n.properties?.forEach(i=>{i.geometryType&&i.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(n.name,{name:i.name??"",geometryType:i.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,i)=>{if(t.get(i)==="entity")this.entityTypeNames.add(i);else{if(t.get(i)!=="relationship")return $e.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(i);this.relationshipTypeNames.add(i)}const r=new Map;n.members?.forEach(o=>{U(this.memberIdTypeLookup,o.id,()=>new Set).add(i)}),this.sublayerCaches.set(i,r)})}addToLayer(e){e.forEach(({typeName:t,id:n})=>{if(!this.inclusionModeDefinition)throw new H("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(t);i.members||(i.members=new Map),i.members.set(n,{id:n}),U(this.memberIdTypeLookup,n,()=>new Set).add(t)}}else{const i=new Map;i.set(n,{id:n}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:i}),U(this.memberIdTypeLookup,n,()=>new Set).add(t)}})}getById(e){return ue.getInstance().readFromStoreById(e)}async getData(e,t,n){if(t.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let i;if(i=e||new Y({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const r=t.parentCompositeLayer,o=this._processingCacheUpdatesLookup.get(t.objectType.name??""),p=i.outFields;p&&p.length===1&&p[0]===q&&i.where==="1=1"||await Promise.all(o??[]);const s=this.sublayerCaches.has(t.objectType.name??"")?Array.from(this.sublayerCaches.get(t.objectType.name)?.values()):[],h=[];return s.forEach(a=>{if(this.relationshipTypeNames.has(t.objectType.name)){a.geometry=r.relationshipLinkChartDiagramLookup.get(a.attributes[t.objectIdField]);const l=this.memberIdTypeLookup.get(a.attributes[pe]),c=this.memberIdTypeLookup.get(a.attributes[de]),d=this._isEndEntitySpatial(l,a,pe),u=this._isEndEntitySpatial(c,a,de);a.attributes[ne]=Number(d&&u)}else{a.geometry=r.entityLinkChartDiagramLookup.get(a.attributes[t.objectIdField]);const l=this.geographicLookup.get(t.objectType.name);l&&a.attributes[l.name]?a.attributes[ne]=1:a.attributes[ne]=0}a.attributes[Te]=a.geometry,h.push(a)}),h}return this.retrieveDataFromService(i,t,n)}async getConnectedRecordIds(e,t,n){const i=[];let r="";const o=this._getNamedTypeIdMapFromNodeIds(e);if(t&&t?.length!==0){for(const l of t)r=r+l+"|";r=r.slice(0,-1)}const p={},s=[];for(const[l,c]of o){const d=`${l}_ids`;p[d]=c,t&&t?.length!==0?s.push(`MATCH (n:${l}) WHERE id(n) IN $${d} WITH n MATCH (n)-[r:${r}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):s.push(`MATCH (n:${l}) WHERE id(n) IN $${d} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!s.length)return i;const h=s.join(" UNION "),a=(await W(this.knowledgeGraph,new B({openCypherQuery:h,bindParameters:p}),{signal:n?.signal})).resultRowsStream.getReader();for(;;){const{done:l,value:c}=await a.read();if(l)break;for(let d=0;d<c.length;d++){const u=c[d];i.push({id:u[0],typeName:u[1]}),i.push({id:u[2],typeName:u[3]})}}return i}async getRelationshipsBetweenNodes(e,t,n){const i=this._getNamedTypeIdMapFromNodeIds(e);if(i.size===0)return[];const r={relationshipExclusionIds:t,possibleConnectionEntityIds:e},o=[];for(const[a,l]of i.entries()){const c=`${a}_ids`;r[c]=l,o.push(`MATCH (n:${a}) WHERE id(n) IN $${c} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const p=o.join(" UNION "),s=[],h=(await W(this.knowledgeGraph,new B({openCypherQuery:p,bindParameters:r}),{signal:n?.signal})).resultRowsStream.getReader();for(;;){const{done:a,value:l}=await h.read();if(a)break;for(let c=0;c<l.length;c++){const d=l[c];s.push({id:d[0],typeName:d[1]})}}return s}async getRelationshipsFromNodes(e,t,n,i){const r=this._getNamedTypeIdMapFromNodeIds(e);if(r.size===0||t.length===0)return[];const o={relationshipExclusionIds:n,possibleConnectionEntityIds:t},p=[];for(const[c,d]of r.entries()){const u=`${c}_ids`;o[u]=d,p.push(`MATCH (n:${c}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const s=p.join(" UNION "),h=new Map,a=(await W(this.knowledgeGraph,new B({openCypherQuery:s,bindParameters:o}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:c,value:d}=await a.read();if(c)break;for(let u=0;u<d.length;u++){const b=d[u];let f=h.get(b[1]);f||(f=new Set,h.set(b[1],f)),f.add(b[0])}}const l=[];for(const[c,d]of h)for(const u of d)l.push({id:u,typeName:c});return l}async refreshCacheContent(e,t,n,i=!0,r){const o=ue.getInstance(),p=[],s=new Map,h=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&h.set(a.name,a)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&h.set(a.name,a)}),e||this.inclusionModeDefinition?e?e.forEach(a=>{if(this.memberIdTypeLookup.has(a))for(const l of this.memberIdTypeLookup.get(a))s.has(l)?s.get(l)?.push(a):s.set(l,[a])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,l)=>{a.useAllData?s.set(l,null):a.members&&a.members.forEach(c=>{s.has(l)&&s.get(l)!==null?s.get(l)?.push(c.id):s.set(l,[c.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&s.set(a.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&s.set(a.name,null)}));for(const[a,l]of s){const c=new Set(l),d=new Promise((u,b)=>{(async()=>{const f=new Set,S=[];let N,E="",L=!1;if(t||h.get(a)?.properties?.forEach(y=>{y.name&&f.add(y.name)}),n&&this.geographicLookup.has(a)){const y=this.geographicLookup.get(a)?.name;y&&f.add(y)}if(this.entityTypeNames.has(a))E=`MATCH (n:${a}) ${l?"WHERE id(n) IN $ids ":""}return ID(n)`,f.forEach(y=>{E+=`, n.${y}`,S.push(y)});else{if(!this.relationshipTypeNames.has(a))throw new H("knowledge-graph:layer-data-manager",`The graph type of ${a} could not be determined. Was this type set in the KG data model and inclusion definition?`);L=!0,E=`MATCH ()-[n:${a}]->() ${l?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,f.forEach(y=>{E+=`, n.${y}`,S.push(y)})}N=new B(l?{openCypherQuery:E,bindParameters:{ids:l}}:{openCypherQuery:E});const v=(await W(this.knowledgeGraph,N,{signal:r?.signal})).resultRowsStream.getReader();for(;;){const{done:y,value:_}=await v.read();if(y)break;const M=[];for(let R=0;R<_.length;R++){const x=_[R];let C=0,A=0;const k={properties:{}};for(k.id=x[C],C++,A++,L&&(k.originId=x[C],C++,A++,k.destinationId=x[C],C++,A++,U(this.nodeConnectionsLookup,k.originId,()=>new Set).add(k.id),U(this.nodeConnectionsLookup,k.destinationId,()=>new Set).add(k.id),U(this.relationshipConnectionsLookup,k.id,()=>[k.originId,k.destinationId]));C<x.length;C++)k.properties[S[C-A]]=x[C];c.delete(k.id),M.push(k)}const D=o.writeToStore(M,q,this.geographicLookup.get(a)?.name);this.sublayerCaches.has(a)||this.sublayerCaches.set(a,new Map),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(a)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(a,{useAllData:!1,members:new Map}),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(a).members=new Map);const $=this.sublayerCaches.get(a);D.forEach(R=>{$?.set(R.attributes[q],R),i&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.has(R.attributes[q])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.set(R.attributes[q],{id:R.attributes[q]}),U(this.memberIdTypeLookup,R.attributes[q],()=>new Set).add(a))})}const w=this.inclusionModeDefinition?.namedTypeDefinitions.get(a);if(w)for(const y of c)w.members?.delete(y)})().then(()=>{u(null)}).catch(f=>{f.name==="AbortError"?u(null):b(f)})});p.push(d),this._processingCacheUpdatesLookup.get(a)?.push(d)}if(await Promise.all(p),r?.signal?.aborted)throw ht()}removeFromLayer(e){const t=new Set,n=new Set(e.map(i=>i.id));for(const i of e)t.add(i.typeName),this.memberIdTypeLookup.get(i.id)?.size===1?this.memberIdTypeLookup.delete(i.id):this.memberIdTypeLookup.get(i.id)?.delete(i.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((r,o)=>{o===i.typeName&&r.members?.has(i.id)&&r.members.delete(i.id)});t.forEach(i=>{this.sublayerCaches.get(i)?.forEach((r,o)=>{n.has(o)&&this.sublayerCaches.get(i)?.delete(o)})})}async retrieveDataFromService(e,t,n){const i=ue.getInstance(),r=new Set,o=[];let p,s="",h=[];const a=t.graphType==="relationship",l=this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData,c=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let d=!l&&c?Array.from(c).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(t.objectType.name)?.useAllData&&e.objectIds!=null&&(d=e.objectIds);else if(e.objectIds!=null&&d&&d.length>0){const b=e.objectIds;e.objectIds=d.filter(f=>b.includes(f))}else if(e.objectIds!=null)d=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(t.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=d}if(e.outFields!=null){const b=e.outFields;b.includes("*")?t.fields.forEach(f=>{r.add(f.name)}):b.forEach(f=>{f!==q&&f!==t.geometryFieldName&&r.add(f)})}if(e.geometry!=null){const b=e.geometry;let f;const S=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,N=S?.spatialReference,E=S?.serviceCapabilities?.geometryCapabilities;let L=E?.geometryMaxBoundingRectangleSizeX,v=E?.geometryMaxBoundingRectangleSizeY;if(b.type==="point"){let w=b;w.spatialReference?.isWGS84||(await be(w.spatialReference,z),w=le(w,z)),f=new se({spatialReference:z,xmin:w.x-1e-4,ymin:w.y-1e-4,xmax:w.x+1e-4,ymax:w.y+1e-4})}else b?.extent?.spatialReference&&!b.spatialReference?.isWGS84?(await be(b.extent.spatialReference,z),f=le(b.extent,z)):f=b.extent;if(L&&v&&N){if(N.wkid!==4326){const w=new se({spatialReference:N,xmax:L,ymax:v}),y=le(w,z);L=y.xmax,v=y.ymax}if(f.xmax-f.xmin>L)throw new H("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${L}\xB0 latitude, limit exceeded`);if(f.ymax-f.ymin>v)throw new H("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${v}\xB0 longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const w=await Pe(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(y=>{w.fieldNames.includes(y.name)&&r.add(y.name)})}s=a?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(w=>{s+=`, n.${w}`,o.push(w)}),p=new B({openCypherQuery:s,bindParameters:{param_filter_geom:new Ge({rings:Fi(f)})}})}else{let b="";if(e.where!=null&&e.where!=="1=1"){const N=await Pe(e.where,t.fieldsIndex);t.fields.forEach(y=>{N.fieldNames.includes(y.name)&&r.add(y.name)});const E=new Set(["column-reference","string","number","binary-expression"]),L=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let v=!1;const w=y=>{if(y.type==="column-reference")return`n.${y.column}`;if(y.type==="string")return`'${y.value}'`;if(y.type==="number")return`${y.value}`;if(y.type==="binary-expression"&&E.has(y.left.type)&&E.has(y.right.type)&&L.has(y.operator))return`${w(y.left)} ${y.operator} ${w(y.right)}`;if(y.type==="binary-expression"&&y.operator==="LIKE"){let _="";if(y.left.type==="function"&&y.left.args.value[0].type==="column-reference")_+=`lower(n.${y.left.args.value[0].column})`;else{if(y.left.type!=="column-reference")return v=!0,"";_+=`lower(n.${y.left.column})`}if(_+=" CONTAINS (",y.right.type!=="string")return v=!0,"";{let M=y.right.value;M.charAt(0)==="%"&&(M=M.slice(1)),M.charAt(M.length-1)==="%"&&(M=M.slice(0,-1)),_+=`'${M.toLowerCase()}')`}return _}return v=!0,""};b=w(N.parseTree),v&&(b="")}let f="";f=a?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let S=!1;d&&(S=!0,f+=" WHERE ID(n) IN $ids"),b&&(f+=S?" AND":" WHERE",f+=` ${b}`),f+=" return ID(n)",a&&(f+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(N=>{f+=`, n.${N}`,o.push(N)}),p=new B(d?{openCypherQuery:f,bindParameters:{ids:d}}:{openCypherQuery:f})}const u=(await W(t.parentCompositeLayer.dataManager.knowledgeGraph,p,n)).resultRowsStream.getReader();for(;;){const{done:b,value:f}=await u.read();if(b)break;const S=[];for(let N=0;N<f.length;N++){const E=f[N];let L=0,v=0;const w={properties:{}};for(w.id=E[L],L++,v++,a&&(w.originId=E[L],L++,v++,w.destinationId=E[L],L++,v++);L<E.length;L++)w.properties[o[L-v]]=E[L];S.push(w)}h=h.concat(i.writeToStore(S,q,t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name)?.name))}return h}_isEndEntitySpatial(e,t,n){for(const i of e??[])if(this.entityTypeNames.has(i)){const r=this.geographicLookup.get(i),o=r&&this.sublayerCaches.get(i)?.get(t.attributes[n]);if(r&&o?.attributes[r.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const t=new Map;return e.forEach(n=>{if(this.memberIdTypeLookup.has(n))for(const i of this.memberIdTypeLookup.get(n)){if(!this.entityTypeNames.has(i))return;t.has(i)?t.get(i)?.push(n):t.set(i,[n])}}),t}};m([g()],j.prototype,"knowledgeGraph",void 0),m([g()],j.prototype,"inclusionModeDefinition",void 0),m([g()],j.prototype,"entityTypeNames",void 0),m([g()],j.prototype,"relationshipTypeNames",void 0),m([g()],j.prototype,"geographicLookup",void 0),m([g()],j.prototype,"sublayerCaches",void 0),m([g()],j.prototype,"nodeConnectionsLookup",void 0),m([g()],j.prototype,"relationshipConnectionsLookup",void 0),m([g()],j.prototype,"memberIdTypeLookup",void 0),j=m([me("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],j);const at=xt(),ji=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return m([g(at.fields)],t.prototype,"fields",void 0),m([g(at.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=m([me("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t},qi={initializeLayersFromClientData:async(e,t,n)=>{if(t||(t=[...e.layers,...e.tables].map(o=>o.graphTypeName)),t?.length===0)return;const i=new Map;for(const o of t)i.set(o,st(e,o));const r=await Lt(e.dataManager.knowledgeGraph,Array.from(i.values()),{requestOptions:{signal:n?.signal}});for(const o of[...e.layers,...e.tables]){const p=o.objectType.name;if(p==null)continue;const s=r.get(st(e,p));if(s){const h=JSON.parse(s);h===null||typeof h!="object"||h.hasOwnProperty("showLabels")||(h.showLabels=!1),o.read(h,{origin:"service"})}}}},st=(e,t)=>e.type==="knowledge-graph"?`${t}/Map`:`${t}/LinkChart/LinkChartSubLayer`;async function $i(e,t,n){return qi.initializeLayersFromClientData(e,t,n)}const lt=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Pi="#8f8f82";function Gi(e){return e<0||e>=lt.length?new Ue(Pi):new Ue(lt[e])}function Ui(e){const t=e.toArray();return new mt({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:t},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:t}]}}]}]}}})}function Hi(e){let t="ESRI__ID",n=4;for(const i of e)if(i.name){if(i.name.toLowerCase()==="name"){t=i.name;break}i.name.toLowerCase().includes("name")?(t=i.name,n=2):i.fieldType==="esriFieldTypeString"&&n>3&&(t=i.name,n=3)}return t}function zi(e,t,n){const i={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},r=new Z({labelExpressionInfo:new re({expression:n==="ESRI__ID"?`${t}`:`$feature.${n}`}),labelPlacement:"above-center",symbol:new te(i)}),o=new Z({labelExpressionInfo:new re({expression:`'${t}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new te({...i,yoffset:"12px"})});return e==="entity"?[r]:[o]}function Bi(e,t,n){const i={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},r=n==="ESRI__ID"?`${e}`:`$feature.${n}`;return t==="point"?[new Z({labelExpressionInfo:new re({expression:r}),labelPlacement:"above-center",symbol:new te(i)})]:t==="polyline"?[new Z({labelExpressionInfo:new re({expression:r}),labelPlacement:"center-along",repeatLabel:!0,symbol:new te(i)})]:t==="polygon"?[new Z({labelExpressionInfo:new re({expression:r}),labelPlacement:"always-horizontal",symbol:new te(i)})]:null}function F(e){if(!e.json)return e;e.json.write=pt(e.json.write);const t=e.json.origins;if(!t)return e;let n;for(n in t){const i=t[n];i&&(i.write=pt(i.write))}return e}function pt(e){return typeof e=="object"&&e?(e.enabled!==!1&&(e.overridePolicy=Qi(e)),e):e===!0?oe():e}function Qi(e){const{target:t,writer:n,overridePolicy:i,...r}=e;return function(o,p){const s=dt.call(this,o,p);return s.enabled?{...r,...s}:s}}function oe(){return{overridePolicy:dt}}function dt(e,t){const n=!!this.geometryType;let i={enabled:n};return n&&(i={...i,...ae.call(this,e,t)}),i}function ae(e,t){return{ignoreOrigin:this.originIdOf(t)>Et.DEFAULTS}}let T=class extends ji(qt(Ht(Gt(Ot(Bt(Wt(Vt(Jt(St(Dt)))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=kt(!1,!0),this.charts=null,this.definitionExpression=null,this.displayField="",this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=q,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new vt(t.port1,{channel:t,client:{queryFeatures:(n,i={})=>{const r=Y.fromJSON(n);return this.queryFeaturesJSON(r,i)}}}),[t.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){const e=[];return this.objectType?.properties?.forEach(t=>{const n=t.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":t.fieldType;e.push(ce.fromJSON({name:t.name,type:n,alias:t.alias,defaultValue:t.defaultValue,editable:t.editable,nullable:t.nullable}))}),e.push(ce.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),ce.fromJSON({name:we,type:"esriFieldTypeInteger",alias:we,editable:!1}),ce.fromJSON({name:ne,type:"esriFieldTypeInteger",alias:ne,editable:!1})),e}get geometryType(){if(this.parentCompositeLayer?.type==="link-chart")return this.graphType==="relationship"?"polyline":"point";const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.geometryType;return t&&t!=="esriGeometryNull"?ie.fromJSON(t):null}get geometryFieldName(){return this.parentCompositeLayer?.type==="link-chart"?Te:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphTypeName(){return this.objectType?.name}get hasM(){const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name;return(t?this.objectType?.properties?.[t]:null)?.hasM??!1}get hasZ(){const e=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),t=e?.name;return(t?this.objectType?.properties?.[t]:null)?.hasZ??!1}set labelingInfo(e){this._set("labelingInfo",e)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const e=this.objectType.properties?Hi(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?zi(this.graphType,this.graphTypeName,e):Bi(this.graphTypeName,this.geometryType,e)}set renderer(e){ft(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const e=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,t=[...e?.entityTypes??[],...e?.relationshipTypes??[]].map(r=>r.name).indexOf(this.graphTypeName),n=Gi(t);if(this.parentCompositeLayer?.type==="link-chart"){if(this.graphType==="relationship")return new ni({type:"simple",symbol:Ui(n)});const r=Be(ze(ie.toJSON("point")).renderer);return Qe(r.symbol,n),r}const i=Be(ze(ie.toJSON(this.geometryType)).renderer);return Qe(i.symbol,n),i}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??Fe.WGS84}set timeInfo(e){this._set("timeInfo",e)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(e){this._set("title",e)}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return ai(this,e)}createQuery(){return new Y({where:"1=1",outFields:["*"]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return null}async queryFeatures(e,t){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e),r=oi.fromJSON(await i.executeQuery(n.toJSON(),t?.signal));return r.features.forEach(o=>{o.sourceLayer=this}),r}async queryFeaturesJSON(e,t){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(n.toJSON(),t?.signal)}async queryFeatureCount(e,t){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(n.toJSON(),t?.signal)}async queryExtent(e={},t){await this.load();const n={...e,returnGeometry:!0},{resolvedQuery:i,queryEngine:r}=await this._setupQueryObjects(n),o=await r.executeQueryForExtent(i.toJSON(),t?.signal);let p;return p=o.extent?.xmin!=null&&o.extent?.xmax!=null&&o.extent?.ymin!=null&&o.extent?.ymax!=null?new se(o.extent):new se,{count:o.count,extent:p}}async queryObjectIds(e,t){await this.load();const n=Y.from(e);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const r=await this.parentCompositeLayer.dataManager.getData(n,this,t);i=this.loadQueryEngine(r)}return await i.executeQueryForIds(n.toJSON(),t?.signal)}loadQueryEngine(e){const t=new Rt({geometryType:ie.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new Ct({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:ie.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new Y({where:"1=1",outFields:[q]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>gt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){const n=Y.from(e),i=n.geometry;if(i&&!i.spatialReference?.isWGS84&&(await be(i.spatialReference,z),n.geometry=le(i instanceof Ge||i instanceof bt||i instanceof Tt?i:i.extent,z)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:n,queryEngine:this._cachedQueryEngine};const r=await this.parentCompositeLayer.dataManager.getData(n,this,t);return{resolvedQuery:n,queryEngine:this.loadQueryEngine(r)}}};function Ji(e,t,n){const i=[["ESRI__AGGREGATION_COUNT",we],["ESRI__ORIGIN_ID",pe],["ESRI__DESTINATION_ID",de],["ESRI__LAYOUT_GEOMETRY",Te]];try{for(const r of e)for(const[o,p]of i)r.labelExpression=r.labelExpression?.replaceAll(o,p),r.labelExpressionInfo?.expression&&(r.labelExpressionInfo.expression=r.labelExpressionInfo.expression.replaceAll(o,p))}catch(r){$e.getLogger(this).warn("Error updating labelingInfo",r)}return At(e,t,n)}m([g(F(O(Ft)))],T.prototype,"blendMode",void 0),m([g()],T.prototype,"capabilities",void 0),m([g({readOnly:!0})],T.prototype,"userHasUpdateItemPrivileges",null),m([g({json:{origins:{"web-scene":{write:!1}},write:oe()}})],T.prototype,"charts",void 0),m([g({readOnly:!0})],T.prototype,"defaultPopupTemplate",null),m([g({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],T.prototype,"definitionExpression",void 0),m([g()],T.prototype,"displayField",void 0),m([g(F(O($t)))],T.prototype,"displayFilterEnabled",void 0),m([g(F(O(Pt)))],T.prototype,"displayFilterInfo",void 0),m([g(F(O(jt)))],T.prototype,"effect",void 0),m([g()],T.prototype,"elevationInfo",void 0),m([g(F(O(Ut)))],T.prototype,"featureEffect",void 0),m([g(F(O(zt)))],T.prototype,"featureReduction",null),m([g()],T.prototype,"fields",null),m([g()],T.prototype,"geometryType",null),m([g()],T.prototype,"geometryFieldName",null),m([g({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],T.prototype,"graphType",void 0),m([g({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],T.prototype,"graphTypeName",null),m([g()],T.prototype,"hasM",null),m([g()],T.prototype,"hasZ",null),m([g({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],T.prototype,"id",void 0),m([g({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],T.prototype,"labelsVisible",void 0),m([g({type:[Z],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:Ji,write:oe()}})],T.prototype,"labelingInfo",null),m([g({readOnly:!0,json:{read:!1,write:{writer(e,t){switch(this.parentCompositeLayer?.type){case"link-chart":t.layerType="LinkChartSubLayer";break;case"knowledge-graph":t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],T.prototype,"layerType",void 0),m([g(F(O(Zt)))],T.prototype,"legendEnabled",void 0),m([g(F(O(Kt)))],T.prototype,"maxScale",void 0),m([g(F(O(Xt)))],T.prototype,"minScale",void 0),m([g()],T.prototype,"objectIdField",void 0),m([g()],T.prototype,"objectType",void 0),m([g(F(O(ei)))],T.prototype,"opacity",void 0),m([g(F(O(Qt)))],T.prototype,"orderBy",void 0),m([g({clonable:!1})],T.prototype,"parent",void 0),m([g()],T.prototype,"parentCompositeLayer",void 0),m([g(F(O(ti)))],T.prototype,"popupEnabled",void 0),m([g({type:wt,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],T.prototype,"popupTemplate",void 0),m([g({type:Number,json:{write:{overridePolicy:ae}}})],T.prototype,"refreshInterval",void 0),m([g({types:ri,json:{name:"layerDefinition.drawingInfo.renderer",write:oe()}})],T.prototype,"renderer",null),m([g()],T.prototype,"source",void 0),m([g()],T.prototype,"spatialReference",null),m([g({type:ii,json:{name:"layerDefinition.timeInfo",write:{overridePolicy:ae},origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:ae}},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:ae}}}}})],T.prototype,"timeInfo",null),m([g({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],T.prototype,"title",null),m([It("title")],T.prototype,"writeTitle",null),m([g({json:{read:!1}})],T.prototype,"type",void 0),m([g(F(O(Yt)))],T.prototype,"useViewTime",void 0),m([g({type:Boolean,json:{name:"visibility",write:oe()}})],T.prototype,"visible",void 0),T=m([me("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],T);export{De as A,Oi as C,vi as D,j as E,T as I,Ce as P,ke as _,Ae as a,Re as b,xe as c,Me as d,Di as e,P as f,Ai as g,Ei as h,$i as i,Ii as m,ue as o,Se as u,ve as v};
