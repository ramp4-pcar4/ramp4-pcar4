import{t as Ts}from"./CIMSymbolHelper-1qtHKtJm.js";import{n as Ms}from"./defaultCIMValues-BcSaJjm-.js";import{c as Rs,i as Cs}from"./enums-a_LDTPYU.js";import{S as ut,E as re,L as Ue}from"./enums-COb5EYx9.js";import{e as W}from"./TechniqueType-CMl1wqtX.js";import{ao as Bt,v as n,gY as z,ig as Os,s as qe,fV as io,i as oo,bS as Xt,gL as Ds,i7 as so,bL as Is,bp as Fs,fa as Ls,L as Es}from"./main-CnDVnExo.js";import{g as h,_ as r,c as f,U as N,r as E,P as H,d as B,O as ae,u as wt,a as Pe,am as ks,j as zi,q as k,w as Ge,e as w,k as M,G as U,f as y,X as _,K as Ht,$ as R,i as Pi,at as Ae,v as ro,T as Ai,a0 as Y,x as Tt,Y as K,a3 as We,B as _e,a5 as _i,s as Nt,F as Ut,au as Ke,b as dt,n as mt,N as Te,as as Bs,a1 as J,av as Hs,Q as Me,R as Yt,aw as $e,a6 as ao,D as Ti,ax as Ns,y as Qt,ay as Us,p as qt,m as P,az as no,o as lo,C as St,t as qs,H as uo,A as po,z as Gs,I as Mi,a9 as Ws,ac as Ks,W as $s,aA as js}from"./GraphShaderModule-OJeiuf1_.js";import{o as Vt,g as Zs,r as co,e as mo,a as je,d as Xs}from"./UpdateTracking2D-Cx4qEMNv.js";import{K as Ys,a as pt,P as Qs,Q as ho,s as yo,L as Js,T as tr}from"./definitions-MCCItX4r.js";import{A as er,k as Ri,q as ir,v as q,z as or,w as Mt,B as Ze,h as ne,j as sr,b as fo,C as vo,D as Xe}from"./utils-C6xLrH0e.js";import{I as rr,t as go,i as Ci,c as Oi,o as bo,u as ar,q as xo,C as nr,h as lr,n as ur,s as pr,B as cr,M as dr,L as mr,K as hr,A as wo,G as So,F as yr,H as fr,D as vr,E as gr}from"./constants-oLcGh8d3.js";import{s as br,i as xr}from"./mat3-DOnW3DjW.js";import{e as Vo,z as $,A as Re,B as Q,C as it,M as tt,D as zo,j as G,E as wr}from"./MapView-CIFPSVS7.js";import{O as At,Y as Po,R as Ao,L as le,P as Di,H as _o,X as Ce,_ as Ye,M as Gt,B as To,D as ht,C as ue}from"./enums-wEDHPbCF.js";import{E as Mo,o as Sr}from"./VertexArrayObject-BT85FO0w.js";import{s as Vr,i as Ro,R as Co}from"./FramebufferObject-BCj-WFlt.js";import{a as Qe,S as Oo}from"./Texture-BMXmG4Zf.js";import{t as zr}from"./VertexElementDescriptor-DLvjNrmQ.js";import{i as Pr,o as Ar}from"./rasterizingUtils-CWvuSRoD.js";import{b as Do}from"./WGLContainer-BdWMCp2t.js";import{m as _r}from"./lengthUtils-BZRuU07m.js";import{r as Tr,s as Ii}from"./streamLayerUtils-Dae818Yl.js";import{t as Je}from"./capabilities-BaKzUyhi.js";import{QueueProcessor as Mr}from"./QueueProcessor-CdvWemgp.js";let Rr=class{get forceStaticPath(){return Bt("esri-cim-animations-enable-status")==="disabled"}get forceAnimatedPath(){return Bt("esri-cim-animations-enable-status")==="forced"}get freezeGlobalTime(){return Bt("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!Bt("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return Bt("esri-cim-animations-freeze-time")!==!1}};const ti=new Rr,Fi={[At.BYTE]:1,[At.UNSIGNED_BYTE]:1,[At.SHORT]:2,[At.UNSIGNED_SHORT]:2,[At.HALF_FLOAT]:2,[At.INT]:4,[At.UNSIGNED_INT]:4,[At.FLOAT]:4};let Io=class{constructor(t,e){this._boundPart=null,this.vertexBuffers=new Map,this.indexBuffers=new Map,this.groups=[];for(const i in e.vertex){const{data:o,attributes:s}=e.vertex[i],a=Mo.createVertex(t,Po.STATIC_DRAW,o);this.vertexBuffers.set(i,{buffer:a,attributes:s})}for(const i in e.index){const{data:o}=e.index[i],s=Mo.createIndex(t,Po.STATIC_DRAW,o);this.indexBuffers.set(i,{buffer:s})}for(const i of e.groups)this.groups.push({...i,vertexArrays:new Map});this.parts=e.parts}bind(t,e,i){this._boundPart=i;const{group:o}=this.parts[this._boundPart],s=this.groups[o];if(!s)throw new Error(`Missing group ${o}.`);let a=s.vertexArrays.get(e.stringHash);if(!a){const l=new Set(e.locations.keys()),u=s.index?this.indexBuffers.get(s.index)?.buffer:null,p=new Map,c=new Map;for(const[d,{buffer:m,attributes:v}]of this.vertexBuffers){const g=v.filter(b=>l.has(b.name));g.length>0&&(p.set(d,g),c.set(d,m))}a=new Sr(t,e.locations,p,c,u),s.vertexArrays.set(e.stringHash,a)}t.bindVAO(a)}draw(t){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");const{start:e,count:i}=this.parts[this._boundPart],{group:o}=this.parts[this._boundPart],{primitive:s,index:a}=this.groups[o];if(a){const l=this.indexBuffers.get(a);if(!l)throw new Error(`Missing index buffer "${a}".`);const{indexType:u}=l.buffer;if(!u)throw new Error("Buffer type error.");t.drawElements(s,i,u,e*Fi[u])}else t.drawArrays(s,e,i)}unbind(t){this._boundPart=null,t.bindVAO(null)}destroy(){for(const{vertexArrays:t}of this.groups)for(const[e,i]of t)i.disposeVAOOnly();for(const{buffer:t}of this.vertexBuffers.values())t.dispose();for(const{buffer:t}of this.indexBuffers.values())t.dispose()}};const Cr={position:{type:At.SHORT,count:2}};let Fo=class eo extends Io{static create(e,i){const o=[];let{stride:s}=i;if(s==null){s=0;for(const[d,{count:m,type:v,offset:g}]of Object.entries(i.layout)){if(g!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");s+=m*Fi[v]}}let a=0;for(const[d,{count:m,offset:v,type:g,normalized:b}]of Object.entries(i.layout)){v!=null&&(a=v);const x=new zr(d,m,g,a,s,b!=null&&b,0);o.push(x),a+=m*Fi[g]}const l={primitive:i.primitive};i.index!=null&&(l.index="indexData");let{count:u}=i;if(u==null&&(u=i.index?i.index.length:i.vertex.byteLength/s,Math.floor(u)!==u))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${s}.`);const p={start:0,count:u,group:0,primitive:i.primitive},c={vertex:{vertexData:{data:i.vertex,attributes:o}},parts:[p],groups:[l]};return i.index!=null&&(c.index={indexData:{data:i.index}}),new eo(e,c,i.layout)}static fromVertexStream(e,i){return eo.create(e,{primitive:Ao.TRIANGLE_STRIP,vertex:new Uint16Array(i),layout:Cr})}constructor(e,i,o){super(e,i),this._spec=o}bind(e,i,o=0){super.bind(e,i,o)}},Wt=class extends H{};n([h(r)],Wt.prototype,"globalTime",void 0),n([h(f)],Wt.prototype,"animationTextureSize",void 0),n([h(N)],Wt.prototype,"animationTexture",void 0),n([h(E)],Wt.prototype,"toScreen",void 0),n([h(E)],Wt.prototype,"toNdc",void 0),n([h(r)],Wt.prototype,"mapRotation",void 0),n([h(r)],Wt.prototype,"pixelRatio",void 0);var ot;(function(t){t[t.transform=0]="transform",t[t.fromColor=1]="fromColor",t[t.toColor=2]="toColor",t[t.colorMix=3]="colorMix",t[t.toOpacity=4]="toOpacity",t[t.opacityMix=5]="opacityMix",t[t.shift=6]="shift"})(ot||(ot={}));let _t=class extends H{getVisualVariableData(t){if(!this._vvData){const e=this.getAttributeDataCoords(t);this._vvData=B(this.visualVariableData,e).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const e=er(t),i=this.size,o=ae(e.x),s=ae(e.y).multiply(ae(256)),a=ae(e.z).multiply(ae(256)).multiply(ae(256)),l=wt(o.add(s).add(a)),u=Pe(l,i),p=l.subtract(u).divide(i);this._uv=new f(u,p).add(.5).divide(i)}return this._uv}getFilterData(t){const e=this.getAttributeDataCoords(t);return B(this.filterFlags,e).setDebugName("storage0")}getAnimationData(t){const e=this.getAttributeDataCoords(t);return B(this.animation,e).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const e=this.getAttributeDataCoords(t);return B(this.dataDriven0,e).setDebugName("storage30")}getDataDrivenData1(t){const e=this.getAttributeDataCoords(t);return B(this.dataDriven1,e).setDebugName("storage31")}getDataDrivenData2(t){const e=this.getAttributeDataCoords(t);return B(this.dataDriven2,e).setDebugName("storage32")}getGPGPUData(t){const e=this.getAttributeDataCoords(t);return B(this.gpgpu,e).setDebugName("storage4")}getLocalTimeOrigin(t){const e=this.getAttributeDataCoords(t);return B(this.localTimeOrigin,e).x.setDebugName("storage5")}getFilterFlags(t){return Bt("webgl-ignores-sampler-precision")?ks(this.getFilterData(t).x.multiply(wt(255))):this.getFilterData(t).x.multiply(wt(255))}getLabelVisibility(t){const e=this.getFilterData(t).y.multiply(255);return new r(1).subtract(e)}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}};n([h(N)],_t.prototype,"filterFlags",void 0),n([h(N)],_t.prototype,"animation",void 0),n([h(N)],_t.prototype,"gpgpu",void 0),n([h(N)],_t.prototype,"localTimeOrigin",void 0),n([h(N)],_t.prototype,"visualVariableData",void 0),n([h(N)],_t.prototype,"dataDriven0",void 0),n([h(N)],_t.prototype,"dataDriven1",void 0),n([h(N)],_t.prototype,"dataDriven2",void 0),n([h(r)],_t.prototype,"size",void 0);let Li=class extends H{};n([h(r)],Li.prototype,"activeReasons",void 0),n([h(r)],Li.prototype,"highlightAll",void 0);let Oe=class extends H{};n([h(f)],Oe.prototype,"position",void 0),n([h(r)],Oe.prototype,"distance",void 0),n([h(r)],Oe.prototype,"smallSymbolDistance",void 0),n([h(r)],Oe.prototype,"smallSymbolSizeThreshold",void 0);let st=class extends H{};n([h(E)],st.prototype,"displayViewScreenMat3",void 0),n([h(E)],st.prototype,"displayViewMat3",void 0),n([h(E)],st.prototype,"displayMat3",void 0),n([h(E)],st.prototype,"viewMat3",void 0),n([h(E)],st.prototype,"tileMat3",void 0),n([h(r)],st.prototype,"displayZoomFactor",void 0),n([h(r)],st.prototype,"requiredZoomFactor",void 0),n([h(f)],st.prototype,"tileOffset",void 0),n([h(r)],st.prototype,"currentScale",void 0),n([h(r)],st.prototype,"currentZoom",void 0),n([h(r)],st.prototype,"metersPerSRUnit",void 0),n([h(r)],st.prototype,"rotation",void 0),n([h(r)],st.prototype,"pixelRatio",void 0);let yt=class extends Pi{};n([y(0,_)],yt.prototype,"id",void 0),n([y(1,r)],yt.prototype,"bitset",void 0),n([y(2,f)],yt.prototype,"pos",void 0);let ft=class extends Ae{};n([y(14,f)],ft.prototype,"nextPos1",void 0),n([y(15,f)],ft.prototype,"nextPos2",void 0);let zt=class extends ro{};class at extends zi{clip(e,i){let o=new r(0);const s=this.storage.getFilterFlags(e);if(o=o.add(wt(2).multiply(wt(1).subtract(Ri(s,0)))),this.inside?o=o.add(wt(2).multiply(wt(1).subtract(Ri(s,1)))):this.outside?o=o.add(wt(2).multiply(Ri(s,1))):this.highlight&&(o=o.add(wt(2).multiply(wt(1).subtract(this._checkHighlight(s))))),i!=null){const a=new r(1).subtract(k(i.x,this.view.currentZoom)),l=k(i.y,this.view.currentZoom);o=o.add(new r(2).multiply(a.add(l)))}return o}getFragmentOutput(e,i,o=new r(1/255)){const s=new Ge;return s.fragColor=this._maybeWriteHittest(i)??this._maybeHighlight(e,o)??e,s}_maybeHighlight(e,i){return this.highlight?new w(e.rgb,k(i,e.a)):null}_checkHighlight(e){let i=this._checkHighlightBit(e,0);for(let o=1;o<Ys;o++)i=i.add(this._checkHighlightBit(e,o));return k(new r(.1),i.add(this.highlight.highlightAll))}_checkHighlightBit(e,i){return ir(e,i).multiply(q(this.highlight.activeReasons,i))}maybeRunHittest(e,i,o){if(this.hittestRequest==null)return null;const s=this.hittest(e,i,o);let a=M(U(s,this.hittestRequest.distance),new r(2),new r(0));const l=this.storage.getAttributeDataCoords(e.id),u=or(l);a=a.add(this.clip(e.id,e.zoomRange));const p=new w(new r(1/255),0,0,0);return{glPointSize:new r(1),glPosition:new w(u,a,1),color:p}}_maybeWriteHittest(e){return this.hittestRequest!=null?e.color:null}}n([Ht],at.prototype,"inside",void 0),n([Ht],at.prototype,"outside",void 0),n([R(Li)],at.prototype,"highlight",void 0),n([h(_t)],at.prototype,"storage",void 0),n([h(st)],at.prototype,"view",void 0),n([R(Oe)],at.prototype,"hittestRequest",void 0);let Jt=class extends H{getPatternOffsetAtTileOrigin(t,e=new r(0),i=new r(1)){const o=new f(rr).divide(t);let s=t.multiply(Ai(this.maxIntsToLocalOrigin.multiply(o))).add(this.tileOffsetFromLocalOrigin).subtract(new r(.5).multiply(t));return s=new f(s.x.multiply(i).subtract(s.y.multiply(e)),s.x.multiply(e).add(s.y.multiply(i))),Pe(s,t)}};n([h(f)],Jt.prototype,"tileOffsetFromLocalOrigin",void 0),n([h(f)],Jt.prototype,"maxIntsToLocalOrigin",void 0);let vt=class extends H{};n([h(f)],vt.prototype,"size",void 0),n([h(N)],vt.prototype,"texture",void 0);let Kt=class extends H{getColor(t,e,i){return Tt([_i(Mt(t),i),e],[_e(t,this.values.first()),this.colors.first()],[We(t,this.values.last()),this.colors.last()],[!0,()=>{const o=this.values.findIndex(p=>U(p,t)),s=this.values.get(o),a=o.subtract(1),l=this.values.get(a),u=t.subtract(l).divide(s.subtract(l));return K(this.colors.get(a),this.colors.get(o),u)}])}};n([h(Y.ofType(w,8))],Kt.prototype,"colors",void 0),n([h(Y.ofType(r,8))],Kt.prototype,"values",void 0);let $t=class extends H{getOpacity(t){return Tt([Mt(t),new r(1)],[_e(t,this.opacityValues.first()),this.opacities.first()],[We(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const e=this.opacityValues.findIndex(l=>U(l,t)),i=this.opacityValues.get(e),o=e.subtract(1),s=this.opacityValues.get(o),a=t.subtract(s).divide(i.subtract(s));return K(this.opacities.get(o),this.opacities.get(e),a)}])}};n([h(Y.ofType(r,8))],$t.prototype,"opacities",void 0),n([h(Y.ofType(r,8))],$t.prototype,"opacityValues",void 0);let ei=class extends H{getVVRotationMat4(t){return M(Mt(t),Ke.identity(),()=>{const e=this.getNormalizedAngle(t).multiply(go),i=Nt(e),o=Ut(e);return new Ke(o,i,0,0,i.multiply(new r(-1)),o,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(t){return M(Mt(t),E.identity(),()=>{const e=this.getNormalizedAngle(t).multiply(go),i=Nt(e),o=Ut(e);return new E(o,i,0,i.multiply(new r(-1)),o,0,0,0,1)})}getNormalizedAngle(t){const e=dt(this.rotationType,new r(Ci.Arithmatic));return M(e,new r(90).subtract(t),t)}};n([h(r)],ei.prototype,"rotationType",void 0);let pe=class extends H{getSize(t,e){const i=this.minMaxValueAndSize.xy,o=this.minMaxValueAndSize.zw;return M(Mt(t),e,()=>{const s=t.subtract(i.x).divide(i.y.subtract(i.x)),a=mt(s,new r(0),new r(1));return o.x.add(a.multiply(o.y.subtract(o.x)))})}};n([h(w)],pe.prototype,"minMaxValueAndSize",void 0);let te=class extends H{getSizeForViewScale(t){return Tt([_e(t,this.values.first()),this.sizes.first()],[We(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex(l=>U(l,t)),i=this.values.get(e),o=e.subtract(1),s=this.values.get(o),a=t.subtract(s).divide(i.subtract(s));return K(this.sizes.get(o),this.sizes.get(e),a)}])}};n([h(Y.ofType(r,8))],te.prototype,"sizes",void 0),n([h(Y.ofType(r,8))],te.prototype,"values",void 0);let ee=class extends H{getSize(t,e){const i=Tt([Mt(t),e],[_e(t,this.values.first()),this.sizes.first()],[We(t,this.values.last()),this.sizes.last()],[!0,()=>{const o=this.values.findIndex(p=>U(p,t)),s=this.values.get(o),a=o.subtract(1),l=this.values.get(a),u=t.subtract(l).divide(s.subtract(l));return K(this.sizes.get(a),this.sizes.get(o),u)}]);return M(Mt(i),e,i)}};n([h(Y.ofType(r,8))],ee.prototype,"sizes",void 0),n([h(Y.ofType(r,8))],ee.prototype,"values",void 0);let ce=class extends H{getSize(t,e){return M(Mt(t),e,t.multiply(this.unitValueToPixelsRatio))}};n([h(r)],ce.prototype,"unitValueToPixelsRatio",void 0);function Lo(t){return t.visualVariableSizeMinMaxValue!=null||t.visualVariableSizeScaleStops!=null||t.visualVariableSizeStops!=null||t.visualVariableSizeUnitValue!=null}function De(t,e,i){if(Lo(t)){const o=t.storage.getSizeValue(e);return t.visualVariableSizeMinMaxValue?.getSize(o,i)??t.visualVariableSizeScaleStops?.getSizeForViewScale(t.view.currentScale)??t.visualVariableSizeStops?.getSize(o,i)??t.visualVariableSizeUnitValue?.getSize(o,i)}return i}function de(t,e,i,o=new Te(!1)){if(t.visualVariableColor==null)return i;const s=t.storage.getColorValue(e);return t.visualVariableColor.getColor(s,i,o)}function me(t,e){if(t.visualVariableOpacity==null)return new r(1);const i=t.storage.getOpacityValue(e);return t.visualVariableOpacity.getOpacity(i)}function Eo(t,e){if(t.visualVariableRotation==null)return E.identity();const i=t.storage.getRotationValue(e);return t.visualVariableRotation.getVVRotationMat3(i)}function Or(t,e){if(t.visualVariableRotation==null)return new r(0);const i=t.storage.getRotationValue(e);return t.visualVariableRotation.getNormalizedAngle(i)}let jt=class extends yt{};n([y(3,f)],jt.prototype,"offset",void 0),n([y(4,w)],jt.prototype,"sizing",void 0),n([y(5,w)],jt.prototype,"value1Position2Value2",void 0),n([y(6,w)],jt.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),n([y(7,f)],jt.prototype,"zoomRange",void 0),n([y(8,r)],jt.prototype,"lineLength",void 0);let ko=class extends zt{},gt=class extends at{_vertexPreamble(t,e,i){const{id:o,offset:s,animationPointerAndBaseSizeAndReferenceSize:a,sizing:l}=t,u=a.xy,p=a.z,c=a.w,d=l.xy,m=this._getEvalParams(t,d,i);let v,g;if(t.value1Position2Value2){const F=ct(u,ot.shift,m).a,kt=t.pos,se=t.value1Position2Value2.yz,ze=t.value1Position2Value2.x,_s=t.value1Position2Value2.w,Vi=F.subtract(ze).divide(_s.subtract(ze));g=kt.add(se.subtract(kt).multiply(Vi)),v=k(new r(1),Vi).add(k(new r(0),J(Vi)))}else g=t.pos,v=new r(0);const b=l.z,x=q(t.bitset,Vt.bitset.isStroke),S=l.w,V=q(t.bitset,Vt.bitset.scaleSymbolsProportionally),A=ct(u,ot.transform,m),I=Tt([dt(q(t.bitset,Vt.bitset.isMapAligned),new r(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new r(0)]),L=new Hs(Ut(I),Nt(I.multiply(-1)),Nt(I),Ut(I)).multiply(A.xy),C=A.z.subtract(I).subtract(e.multiply(Oi)),O=A.w,D=q(t.bitset,Vt.bitset.isSDF),T=De(this,o,new r(c)).divide(new r(c));return{baseSize:p,animationPointer:u,strokeWidth:b,isOutline:x,unscaledDistanceToPx:S,scaleSymbolsProportionally:V,isSDF:D,position:this._getScreenPosition({id:o,pos:g,offset:s,referenceSize:c,translation:L,rotation:C,scale:O,vvScale:T}),evalParams:m,vvScale:T,scale:O,clip:v}}_getScreenPosition(t){const{pos:e,translation:i,rotation:o,scale:s,offset:a,id:l,vvScale:u}=t,p=Or(this,l).multiply(Math.PI/180),c=i.x.multiply(4/3),d=i.y.multiply(-1).multiply(4/3),m=Nt(p),v=Ut(p),g=v.multiply(c).add(J(m).multiply(d)),b=m.multiply(c).add(v.multiply(d)),x=Nt(o.subtract(p)),S=Ut(o.subtract(p)),V=new r(0),A=new r(1),{pixelRatio:I}=this.animationInfo,L=new E(A,V,V,V,A,V,g.multiply(I),b.multiply(I),A),C=new E(S,x.multiply(-1),V,x,S,V,0,0,A),O=s.multiply(u).multiply(I).multiply(4/3),D=C.multiply(O),T=this.animationInfo.toScreen.multiply(new _(e,1)),F=L.multiply(T).xy,kt=D.multiply(new _(a,0)).xy;return F.add(kt)}_clip(t,e){let i=super.clip(t,e);const o=_e(this._getLocalTimeOrigin(t),new r(0));return ti.forceGlobalTimeOrigin||(i=i.add(Tt([o,()=>new r(2)],[!0,()=>new r(0)]))),i}_getLocalTimeOrigin(t){return this.storage.getLocalTimeOrigin(t)}_toNdc(t){return this.animationInfo.toNdc.multiply(new _(t,1)).xy}_getEvalParams(t,e,i){const{globalTime:o,animationTextureSize:s,animationTexture:a}=this.animationInfo;return{globalTime:o,localTimeOrigin:this._getLocalTimeOrigin(t.id),animationTextureSize:s,animationTexture:a,pixelDimensions:e,lineLength:i}}_getColor(t,e){return M(dt(e.isSDF,new r(1)),this._getSDFColor(t,e),this._getSpriteColor(t,e))}_getSpriteColor(t,e){return B(this.mosaicInfo.texture,t).multiply(e.color)}_getSDFColor(t,e){const i=B(this.mosaicInfo.texture,t),o=new r(.5).subtract(Ze(i)).multiply(e.distanceToPx).multiply(bo),s=mt(new r(.5).subtract(o),new r(0),new r(1)),a=e.color.multiply(s),l=e.outlineSize.multiply(.5),u=Me(o).subtract(l),p=mt(new r(.5).subtract(u),new r(0),new r(1)),c=e.outlineColor.multiply(p);return new r(1).subtract(c.a).multiply(a).add(c)}};function ct(t,e,i){const o=t.add(new f(e,0)),s=B(i.animationTexture,o.add(.5).divide(i.animationTextureSize)).xy;return t=t.add(s),Bs({animationPointer:t,...i},w,null,a=>{const{out:l}=a;if(!l)throw new Error("out is null");return Zs({...a,out:l})})}n([h(vt)],gt.prototype,"mosaicInfo",void 0),n([h(Wt)],gt.prototype,"animationInfo",void 0),n([h(Jt)],gt.prototype,"localTileOffset",void 0),n([R(Kt)],gt.prototype,"visualVariableColor",void 0),n([R($t)],gt.prototype,"visualVariableOpacity",void 0),n([R(pe)],gt.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(te)],gt.prototype,"visualVariableSizeScaleStops",void 0),n([R(ee)],gt.prototype,"visualVariableSizeStops",void 0),n([R(ce)],gt.prototype,"visualVariableSizeUnitValue",void 0),n([R(ei)],gt.prototype,"visualVariableRotation",void 0);let Ei=class extends jt{};n([y(9,w)],Ei.prototype,"tlbr",void 0);let ii=class extends Ae{};n([y(13,f)],ii.prototype,"nextPos1",void 0),n([y(14,f)],ii.prototype,"nextPos2",void 0);let Bo=class extends ko{},Ho=class extends gt{_fragmentPoly(t){const e=Pe(t.uv,new r(1)),i=K(t.tlbr.xy,t.tlbr.zw,e);return this._getColor(i,{color:t.color,distanceToPx:t.distanceToPx,isSDF:t.isSDF,outlineColor:t.outlineColor,outlineSize:t.strokeWidth})}_vertexPoly(t){const{position:e,animationPointer:i,evalParams:o,isOutline:s,unscaledDistanceToPx:a,vvScale:l,strokeWidth:u,scaleSymbolsProportionally:p,scale:c,isSDF:d,baseSize:m,clip:v}=this._vertexPreamble(t,new r(0),t.lineLength||new r(0)),g=this._toNdc(e);let b=ct(i,ot.fromColor,o);b=new w(b.rgb.multiply(b.a),b.a);let x=ct(i,ot.toColor,o);x=new w(x.rgb.multiply(x.a),x.a);let S=ct(i,ot.colorMix,o);S=new w(S.rgb.multiply(S.a),S.a);const V=ct(i,ot.toOpacity,o).a,A=ct(i,ot.opacityMix,o).a,I=de(this,t.id,b,_i(ne(t.bitset,Vt.bitset.colorLocked),new Te(s))),L=K(I,x,S),C=me(this,t.id),O=K(C,V,A),D=L.multiply(O),T=this.clip(t.id,t.zoomRange).add(v.multiply(2)),F=a.multiply(l);return{unscaledDistanceToPx:a,vvScale:l,strokeWidth:u,scaleSymbolsProportionally:p,scale:c,isSDF:d,baseSize:m,ndc:g,color:D,z:T,isOutline:s,evalParams:o,distanceToPx:F}}};function Dr(t,e){return Qt(t,Us(e))}function ie(t,e,i){const o=i.subtract(e),s=Dr(t.subtract(e),o),a=mt(s.divide(Yt(o)),new r(0),new r(1));return $e(t,e.add(a.multiply(i.subtract(e))))}function j(t){const e=Me(t);return k(e.x.add(e.y).add(e.z),new r(1.05))}function Z(t,e,i,o){const s=new E(i.x.multiply(o.y).subtract(o.x.multiply(i.y)),o.x.multiply(e.y).subtract(e.x.multiply(o.y)),e.x.multiply(i.y).subtract(i.x.multiply(e.y)),i.y.subtract(o.y),o.y.subtract(e.y),e.y.subtract(i.y),o.x.subtract(i.x),e.x.subtract(o.x),i.x.subtract(e.x)),a=e.x.multiply(i.y.subtract(o.y)),l=i.x.multiply(o.y.subtract(e.y)),u=o.x.multiply(e.y.subtract(i.y)),p=a.add(l).add(u);return new r(1).divide(p).multiply(s.multiply(new _(1,t)))}function Ir(t,e,i,o){return dt(j(Z(t,e,i,o)),new r(1))}function oi(t,e,i,o){const s=i.subtract(e),a=o.subtract(e),l=sr(s,a),u=ao(Ti(l,new r(ar)),U(l,new r(-.05)));return Tt([ao(Ns(u),Ir(t.xy,e,i,o)),new r(-1)],[!0,()=>{const p=ie(t,e,i),c=ie(t,i,o),d=ie(t,o,e);return qt(qt(p,c),d)}])}function he(t){return t.distance.add(1)}function si(t,e,i){const{viewMat3:o,tileMat3:s}=t.view,a=o.multiply(s),l=a.multiply(new _(e.pos,1)),u=a.multiply(new _(i.nextPos1,1)),p=a.multiply(new _(i.nextPos2,1));return oi(t.hittestRequest.position,l.xy,u.xy,p.xy)}function Fr(t,e,i){return $e(t,i).subtract(e)}let ye=class extends yt{};n([y(3,w)],ye.prototype,"color",void 0),n([y(4,f)],ye.prototype,"zoomRange",void 0);let Rt=class extends at{constructor(){super(...arguments),this.type="FillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const i=me(this,t.id),o=de(this,t.id,t.color).multiply(i),s=this.view.displayViewScreenMat3.multiply(new _(t.pos.xy,1)),a=this.clip(t.id,t.zoomRange);return{glPosition:new w(s.xy,a,1),color:o,...this.maybeRunHittest(t,e,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new r(0))}hittest(t,e){return si(this,t,e)}};n([R(Kt)],Rt.prototype,"visualVariableColor",void 0),n([R($t)],Rt.prototype,"visualVariableOpacity",void 0),n([z(0,P(ye)),z(1,P(ft))],Rt.prototype,"vertex",null),n([z(0,P(zt))],Rt.prototype,"fragment",null);let oe=class extends ye{};n([y(5,w)],oe.prototype,"tlbr",void 0),n([y(6,r)],oe.prototype,"width",void 0),n([y(7,r)],oe.prototype,"height",void 0),n([y(8,f)],oe.prototype,"offset",void 0),n([y(9,f)],oe.prototype,"scale",void 0),n([y(10,r)],oe.prototype,"angle",void 0);let Lr=class extends zt{};function No(t,e,i,o,s){const a=dt(q(s,nr),wt(1)),l=Ze(new w(t,0));return M(a,no(o.divide(e.x),i.divide(e.y),0,J(i.divide(e.x)),o.divide(e.y),0,fo(lo(l,0)),fo(lo(0,l)),1),no(o.divide(e.x),i.divide(e.y),0,J(i.divide(e.x)),o.divide(e.y),0,0,0,1))}function Uo(t,e){const i=t.view.requiredZoomFactor,o=new f(e.width,e.height),s=o.multiply(e.scale).multiply(i),a=e.angle.multiply(Oi),l=Nt(a),u=Ut(a),p=No(e.id,s,l,u,e.bitset),c=t.localTileOffset.getPatternOffsetAtTileOrigin(o,l,u),d=i.multiply(e.scale).multiply(e.offset.subtract(c)).divide(s),m=new _(e.pos,1),v=p.multiply(m).xy.subtract(d),g=e.tlbr.divide(t.mosaicInfo.size.xyxy);let b=q(e.bitset,xo);return t.visualVariableColor!=null&&(b=M(Mt(t.storage.getColorValue(e.id)),new r(0),b)),{tileTextureCoord:v,tlbr:g,sampleAlphaOnly:b}}function qo(t,e){const i=Pe(e.tileTextureCoord,new r(1)),o=K(e.tlbr.xy,e.tlbr.zw,i);let s=B(t.mosaicInfo.texture,o);return s=M(U(e.sampleAlphaOnly,new r(.5)),s.aaaa,s),e.color.multiply(s)}let Ie=class extends Rt{constructor(){super(...arguments),this.type="ComplexFillShader"}vertex(t,e){return{...super.vertex(t,e),...Uo(this,t)}}fragment(t){const e=qo(this,t);return this.getFragmentOutput(e,t,new r(0))}};n([h(vt)],Ie.prototype,"mosaicInfo",void 0),n([h(Jt)],Ie.prototype,"localTileOffset",void 0),n([z(0,P(oe)),z(1,P(ft))],Ie.prototype,"vertex",null),n([z(0,P(Lr))],Ie.prototype,"fragment",null);let ki=class extends Ho{constructor(){super(...arguments),this.type="AnimatedFillShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const{distanceToPx:i,ndc:o,z:s,color:a,isOutline:l,strokeWidth:u,isSDF:p,baseSize:c,scale:d,scaleSymbolsProportionally:m}=this._vertexPoly(t),v=this.view.requiredZoomFactor,g=t.sizing.xy,b=g.multiply(v),x=new r(0),S=Nt(x),V=Ut(x),A=No(t.id,b,S,V,t.bitset),I=this.localTileOffset.getPatternOffsetAtTileOrigin(g,S,V),L=v.multiply(t.offset.subtract(I)).divide(b),C=new _(t.pos,1),O=A.multiply(C).xy.subtract(L),D=t.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new w(o,s,1),tlbr:D,uv:O,color:a.multiply(new r(1).subtract(l)),outlineColor:a.multiply(l),distanceToPx:i,strokeWidth:u.multiply(K(new r(1),d,m)),isOutline:l,isSDF:p,...this.maybeRunHittest(t,e,{pos:t.pos,size:c,sizeCorrection:new r(1),isMapAligned:new r(1),vvRotationMat3:new E(1,0,0,0,1,0,0,0,1),placementMat3:new E(1,0,0,0,1,0,0,0,1),outlineSize:new r(1),distanceToPx:i,isSDF:p})}}fragment(t){const e=this._fragmentPoly(t);return this.getFragmentOutput(e,t)}hittest(t,e,i){return si(this,t,e)}};n([z(0,P(Ei)),z(1,P(ii))],ki.prototype,"vertex",null),n([z(0,P(Bo))],ki.prototype,"fragment",null);let Ct=class extends yt{};n([y(3,w)],Ct.prototype,"color",void 0),n([y(4,f)],Ct.prototype,"offset",void 0),n([y(5,f)],Ct.prototype,"normal",void 0),n([y(6,r)],Ct.prototype,"halfWidth",void 0),n([y(7,r)],Ct.prototype,"referenceHalfWidth",void 0),n([y(8,f)],Ct.prototype,"zoomRange",void 0);let Go=class extends zt{},ri=class extends H{};function Bi(t){return St(new r(lr).multiply(k(t,new r(ur))),new r(1))}function Hi(t,e){const{halfWidth:i,normal:o}=t,s=Bi(i),a=Yt(o).multiply(i);return mt(s.multiply(i.subtract(a)).divide(e.add(s).subtract(new r(1))),new r(0),new r(1))}function Er(t,e){const{id:i,halfWidth:o,referenceHalfWidth:s}=e;if(Lo(t)){const a=new r(2).multiply(s),l=De(t,i,a);return new r(.5).multiply(o.divide(St(s,new r(pr)))).multiply(l)}return o}function ai(t,e){const{id:i,offset:o,pos:s,normal:a,zoomRange:l}=e,{displayViewScreenMat3:u,displayViewMat3:p}=t.view,c=de(t,i,e.color),d=me(t,i),m=Er(t,e),v=new r(.5).multiply(t.antialiasingControls.antialiasing),g=St(m.add(v),new r(.45)).add(new r(.1).multiply(v)),b=Bi(g).multiply(g).multiply(o),x=p.multiply(new _(b,new r(0))),S=u.multiply(new _(s,new r(1))).add(x),V=new r(2).multiply(k(m,new r(0))).add(t.clip(i,l)),A=new w(S.xy,V,1);return{color:c,opacity:d,halfWidth:g,normal:a,scaledOffset:b,scaledHalfWidth:m,glPosition:new w(A.xy,V,1)}}function ni(t,e){const{opacity:i,color:o}=t,s=Hi(t,e);return i.multiply(o).multiply(s)}n([h(r)],ri.prototype,"antialiasing",void 0),n([h(r)],ri.prototype,"blur",void 0);let bt=class extends at{constructor(){super(...arguments),this.type="LineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const i=ai(this,t);return{...i,...this.maybeRunHittest(t,e,i.halfWidth)}}fragment(t){const e=ni(t,this.antialiasingControls.blur);return this.getFragmentOutput(e,t)}hittest(t,e,i){const{viewMat3:o,tileMat3:s}=this.view,a=o.multiply(s),l=a.multiply(new _(t.pos,1)),u=a.multiply(new _(e.nextPos1,1)),p=a.multiply(new _(e.nextPos2,1)),{distance:c,smallSymbolDistance:d,smallSymbolSizeThreshold:m}=this.hittestRequest,v=k(i,m.multiply(.5)).multiply(c.subtract(d)),g=this.hittestRequest.position;return qt(ie(g,l.xy,u.xy),ie(g,l.xy,p.xy)).subtract(i).add(v)}};n([h(ri)],bt.prototype,"antialiasingControls",void 0),n([R(Kt)],bt.prototype,"visualVariableColor",void 0),n([R($t)],bt.prototype,"visualVariableOpacity",void 0),n([R(pe)],bt.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(te)],bt.prototype,"visualVariableSizeScaleStops",void 0),n([R(ee)],bt.prototype,"visualVariableSizeStops",void 0),n([R(ce)],bt.prototype,"visualVariableSizeUnitValue",void 0),n([z(0,P(Ct)),z(1,P(ft))],bt.prototype,"vertex",null),n([z(0,P(Go))],bt.prototype,"fragment",null);let li=class extends Ei{};n([y(10,r)],li.prototype,"accumulatedDistance",void 0),n([y(11,f)],li.prototype,"normal",void 0),n([y(12,f)],li.prototype,"segmentDirection",void 0);let kr=class extends Bo{},Ni=class extends Ho{constructor(){super(...arguments),this.type="AnimatedLineShader",this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const{animationPointerAndBaseSizeAndReferenceSize:i}=t,o=i.xy,{distanceToPx:s,ndc:a,z:l,color:u,isOutline:p,strokeWidth:c,isSDF:d,baseSize:m,scale:v,scaleSymbolsProportionally:g,evalParams:b}=this._vertexPoly(t),x=t.sizing.xy,S=x.x.multiply(m).divide(x.y),V=ct(o,ot.shift,b).a,A=t.accumulatedDistance.subtract(V),{normal:I}=t,L=t.normal.y,C=A.divide(this.view.displayZoomFactor).add(Qt(t.segmentDirection,t.offset)).divide(S),O=L.add(1).divide(2),D=new f(C,O),T=t.tlbr.divide(this.mosaicInfo.size.xyxy);return{glPosition:new w(a,l,1),tlbr:T,uv:D,color:u.multiply(new r(1).subtract(p)),outlineColor:u.multiply(p),distanceToPx:s,strokeWidth:c.multiply(K(new r(1),v,g)),isOutline:p,isSDF:d,halfWidth:m.divide(2),normal:I,...this.maybeRunHittest(t,e,{pos:t.pos,size:m,sizeCorrection:new r(1),isMapAligned:new r(1),vvRotationMat3:new E(1,0,0,0,1,0,0,0,1),placementMat3:new E(1,0,0,0,1,0,0,0,1),outlineSize:new r(1),distanceToPx:s,isSDF:d})}}fragment(t){const e=this._fragmentPoly(t),{halfWidth:i,normal:o}=t,s=Bi(i),a=Yt(o).multiply(i),l=mt(s.multiply(i.subtract(a)).divide(s.subtract(new r(1))),new r(0),new r(1));return this.getFragmentOutput(e.multiply(l),t)}hittest(t,e,i){const{viewMat3:o,tileMat3:s}=this.view,a=o.multiply(s),l=a.multiply(new _(t.pos,1)),u=a.multiply(new _(e.nextPos1,1)),p=a.multiply(new _(e.nextPos2,1)),{distance:c,smallSymbolDistance:d,smallSymbolSizeThreshold:m}=this.hittestRequest,v=k(i,m.multiply(.5)).multiply(c.subtract(d)),g=this.hittestRequest.position;return qt(ie(g,l.xy,u.xy),ie(g,l.xy,p.xy)).subtract(i).add(v)}};n([z(0,P(li)),z(1,P(ii))],Ni.prototype,"vertex",null),n([z(0,P(kr))],Ni.prototype,"fragment",null);let Ui=class extends jt{};n([y(9,f)],Ui.prototype,"uv",void 0),n([y(10,r)],Ui.prototype,"angle",void 0);let Fe=class extends Ae{};n([y(11,f)],Fe.prototype,"offsetNextVertex1",void 0),n([y(12,f)],Fe.prototype,"offsetNextVertex2",void 0),n([y(13,f)],Fe.prototype,"textureUVNextVertex1",void 0),n([y(14,f)],Fe.prototype,"textureUVNextVertex2",void 0);let Br=class extends ko{};function Ot(t,e,i,o){return e.multiply(t.x).add(i.multiply(t.y)).add(o.multiply(t.z))}let ui=class extends gt{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(t,e){const i=t.uv.divide(this.mosaicInfo.size),{position:o,animationPointer:s,evalParams:a,isOutline:l,unscaledDistanceToPx:u,vvScale:p,strokeWidth:c,scaleSymbolsProportionally:d,scale:m,isSDF:v,baseSize:g,clip:b}=this._vertexPreamble(t,t.angle,t.lineLength||new r(0)),x=this._toNdc(o);let S=ct(s,ot.fromColor,a);S=new w(S.rgb.multiply(S.a),S.a);let V=ct(s,ot.toColor,a);V=new w(V.rgb.multiply(V.a),V.a);let A=ct(s,ot.colorMix,a);A=new w(A.rgb.multiply(A.a),A.a);const I=ct(s,ot.toOpacity,a).a,L=ct(s,ot.opacityMix,a).a,C=de(this,t.id,S,_i(ne(t.bitset,Vt.bitset.colorLocked),new Te(l))),O=K(C,V,A),D=me(this,t.id),T=K(D,I,L),F=O.multiply(T),kt=this.clip(t.id,t.zoomRange).add(b.multiply(2)),se=u.multiply(p);return{glPosition:new w(x,kt,1),uv:i,color:F.multiply(new r(1).subtract(l)),outlineColor:F.multiply(l),distanceToPx:se,strokeWidth:c.multiply(K(new r(1),m,d)),isOutline:l,isSDF:v,...this.maybeRunHittest(t,e,{pos:t.pos,size:g,sizeCorrection:new r(1),isMapAligned:new r(1),vvRotationMat3:new E(1,0,0,0,1,0,0,0,1),placementMat3:new E(1,0,0,0,1,0,0,0,1),outlineSize:new r(1),distanceToPx:se,isSDF:v})}}fragment(t){let e=this._getColor(t.uv,{color:t.color,distanceToPx:t.distanceToPx,isSDF:t.isSDF,outlineColor:t.outlineColor,outlineSize:t.strokeWidth});return ti.spotlightAnimatedSymbols&&(e=e.add(new w(0,.3,0,.3))),this.getFragmentOutput(e,t)}hittest(t,e,i){return M(Ti(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(t,e,i),this._hittestMarker(t,e,i))}_hittestSmallMarker(t,e,i){const{position:o,distance:s,smallSymbolDistance:a}=this.hittestRequest,l=s.subtract(a),{viewMat3:u,tileMat3:p}=this.view,c=u.multiply(p).multiply(new _(i.pos,1)).xy,d=i.size.multiply(.5);return $e(c,o).subtract(d).add(l)}_hittestMarker(t,e,i){const o=this._vertexPreamble({...t},t.angle,new r(0)).position,s=this._vertexPreamble({...t,offset:e.offsetNextVertex1},t.angle,new r(0)).position,a=this._vertexPreamble({...t,offset:e.offsetNextVertex2},t.angle,new r(0)).position,l=this.hittestRequest.position,u=this.hittestRequest.distance,p=oi(l,o,s,a);return M(U(p,u),p,this._hittestSamples(o,s,a,t,e,i))}_hittestSamples(t,e,i,o,s,a){const{outlineSize:l,isSDF:u,distanceToPx:p}=a,c=this.hittestRequest.position,d=this.hittestRequest.distance,m=Z(c.add(new f(J(d),J(d))),t,e,i),v=Z(c.add(new f(0,J(d))),t,e,i),g=Z(c.add(new f(d,J(d))),t,e,i),b=Z(c.add(new f(J(d),0)),t,e,i),x=Z(c,t,e,i),S=Z(c.add(new f(d,0)),t,e,i),V=Z(c.add(new f(J(d),d)),t,e,i),A=Z(c.add(new f(0,d)),t,e,i),I=Z(c.add(new f(d,d)),t,e,i),L=o.uv.divide(this.mosaicInfo.size),C=s.textureUVNextVertex1.divide(this.mosaicInfo.size),O=s.textureUVNextVertex2.divide(this.mosaicInfo.size),D={color:new w(1,1,1,1),outlineSize:l,outlineColor:new w(1,1,1,1),isSDF:u,distanceToPx:p};let T=new r(0);return T=T.add(j(m).multiply(this._getColor(Ot(m,L,C,O),D).a)),T=T.add(j(v).multiply(this._getColor(Ot(v,L,C,O),D).a)),T=T.add(j(g).multiply(this._getColor(Ot(g,L,C,O),D).a)),T=T.add(j(b).multiply(this._getColor(Ot(b,L,C,O),D).a)),T=T.add(j(x).multiply(this._getColor(Ot(x,L,C,O),D).a)),T=T.add(j(S).multiply(this._getColor(Ot(S,L,C,O),D).a)),T=T.add(j(V).multiply(this._getColor(Ot(V,L,C,O),D).a)),T=T.add(j(A).multiply(this._getColor(Ot(A,L,C,O),D).a)),T=T.add(j(I).multiply(this._getColor(Ot(I,L,C,O),D).a)),k(T,new r(.05)).multiply(he(this.hittestRequest))}};n([z(0,P(Ui)),z(1,P(Fe))],ui.prototype,"vertex",null),n([z(0,P(Br))],ui.prototype,"fragment",null);let et=class extends qs{constructor(){super(...arguments),this.symbologyPlane=ut.FILL,this._input=null}},pi=class extends et{render(t,e){const{context:i,painter:o}=t,{target:s}=e,{freezeGlobalTime:a}=ti,l=0,u=o.textureManager.animationStore.getTexture(i,l),p=[2/t.state.size[0],0,0,0,-2/t.state.size[1],0,-1,1,1],c=Array.from(br(Vo(),p)),d=Array.from(xr(Vo(),c,s.transforms.displayViewScreenMat3)),m=e.instance.getInput(),v=o.textureManager.getMosaicInfo(i,e.textureKey,!1),{optionalAttributes:g}=m,b=g.zoomRange,x=g.value1Position2Value2,S="accumulatedDistance"in g&&g.accumulatedDistance,V="segmentDirection"in g&&g.segmentDirection,A="normal"in g&&g.normal;o.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,m.uniforms),...Q(t,e.target),mosaicInfo:v,animationInfo:{globalTime:a===!1?t.time/1e3:a,animationTextureSize:[u.descriptor.width,u.descriptor.height],animationTexture:{unit:6,texture:u},toScreen:d,toNdc:p,mapRotation:t.state.rotation,pixelRatio:t.state.pixelRatio},localTileOffset:Re(e.target)},defines:{...$(t)},optionalAttributes:{zoomRange:b,value1Position2Value2:x,accumulatedDistance:S,segmentDirection:V,normal:A},useComputeBuffer:!0}),o.setPipelineState({...tt(t)}),o.submitDraw(t,e),a===!1&&s.requestRender()}},Hr=class extends pi{constructor(){super(...arguments),this.type=W.AnimatedMarker,this.symbologyPlane=ut.MARKER,this.shaders={geometry:new ui}}},Nr=class extends pi{constructor(){super(...arguments),this.type=W.AnimatedMarkerShift,this.symbologyPlane=ut.MARKER,this.shaders={geometry:new ui}}},Ur=class extends pi{constructor(){super(...arguments),this.type=W.AnimatedFill,this.symbologyPlane=ut.FILL,this.shaders={geometry:new ki}}},qr=class extends pi{constructor(){super(...arguments),this.type=W.AnimatedLine,this.symbologyPlane=ut.LINE,this.shaders={geometry:new Ni}}},Wo=class extends Pi{};n([y(0,f)],Wo.prototype,"pos",void 0);let Gr=class extends zt{},Ko=class extends H{};n([h(r)],Ko.prototype,"dotSize",void 0);let ci=class extends H{};n([h(N)],ci.prototype,"locations",void 0),n([h(r)],ci.prototype,"pixelRatio",void 0),n([h(r)],ci.prototype,"tileZoomFactor",void 0);const Wr=1e-6;let fe=class extends zi{constructor(){super(...arguments),this.type="DotDensityPointShader"}vertex(t){const e=new E(1,0,0,0,-1,0,0,1,1).multiply(new _(t.pos.xy.divide(pt),1)),i=B(this.draw.locations,e.xy),o=St(this.instance.dotSize.divide(2),new r(1));let s=new r(0);s=s.add(k(i.a,new r(Wr)).multiply(2));let a=o.add(this.instance.dotSize);const l=this.view.displayViewScreenMat3.multiply(new _(t.pos.add(.5),1)),u=new w(l.xy,s,1),p=this.instance.dotSize.divide(a),c=new r(-1).divide(o.divide(a));return a=a.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:u,glPointSize:a,color:i,ratio:p,invEdgeRatio:c}}fragment(t){const e=Yt(t.glPointCoord.subtract(.5)).multiply(2),i=uo(new r(0),new r(1),t.invEdgeRatio.multiply(e.subtract(t.ratio)).add(1)),o=new Ge;return o.fragColor=t.color.multiply(i),o}};n([h(Ko)],fe.prototype,"instance",void 0),n([h(ci)],fe.prototype,"draw",void 0),n([h(st)],fe.prototype,"view",void 0),n([z(0,P(Wo))],fe.prototype,"vertex",null),n([z(0,P(Gr))],fe.prototype,"fragment",null);let $o=class extends yt{};n([y(3,r)],$o.prototype,"inverseArea",void 0);let di=class extends H{};n([h(Y.ofType(w,2))],di.prototype,"isActive",void 0),n([h(Y.ofType(w,8))],di.prototype,"colors",void 0),n([h(r)],di.prototype,"dotValue",void 0);let ve=class extends H{};n([h(N)],ve.prototype,"dotTexture0",void 0),n([h(N)],ve.prototype,"dotTexture1",void 0),n([h(r)],ve.prototype,"tileZoomFactor",void 0),n([h(r)],ve.prototype,"pixelRatio",void 0),n([h(r)],ve.prototype,"tileDotsOverArea",void 0);let ge=class extends at{constructor(){super(...arguments),this.type="DotDensityPolygonShader"}_dotThreshold(t,e,i){return t.divide(e).divide(i)}vertex(t){const e=new E(2/pt,0,0,0,-2/pt,0,-1,1,1).multiply(new _(t.pos,1)),i=this.clip(t.id),o=new w(e.xy,i,1),s=this.storage.getVVData(t.id).multiply(this.instance.isActive.get(0)).multiply(t.inverseArea),a=this.storage.getDataDrivenData0(t.id).multiply(this.instance.isActive.get(1)).multiply(t.inverseArea),l=this.draw.tileZoomFactor.multiply(pt).divide(this.draw.pixelRatio),u=this._dotThreshold(s,this.instance.dotValue,this.draw.tileDotsOverArea),p=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),c=t.pos.add(.5).divide(l);return{glPosition:o,color:new w(0,0,0,0),textureCoords:c,thresholds0:u,thresholds1:p}}fragment(t){const e=new Ge,i=B(this.draw.dotTexture0,t.textureCoords),o=B(this.draw.dotTexture1,t.textureCoords),s=t.thresholds0.subtract(i),a=t.thresholds1.subtract(o);let l;const u=Ke.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),p=Ke.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const c=k(new r(0),s),d=k(new r(0),a),m=Qt(c,s).add(Qt(d,a)),v=k(m,new r(0)),g=new r(1).subtract(v),b=m.add(v),x=s.multiply(c).divide(b),S=a.multiply(d).divide(b),V=u.multiply(x).add(p.multiply(S));l=g.multiply(V)}else{const c=St(vo(s),vo(a)),d=k(c,new r(0)),m=new r(1).subtract(d),v=k(c,s),g=k(c,a),b=u.multiply(v).add(p.multiply(g));l=m.multiply(b)}return e.fragColor=l,e}hittest(t){return he(this.hittestRequest)}};n([Ht],ge.prototype,"blending",void 0),n([h(di)],ge.prototype,"instance",void 0),n([h(ve)],ge.prototype,"draw",void 0),n([z(0,P($o))],ge.prototype,"vertex",null),n([z(0,P(zt))],ge.prototype,"fragment",null);const Kr={pos:{count:2,type:At.UNSIGNED_SHORT}};let $r=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(t){if(this._dotFBO==null){const e=pt,i=pt,o=new Qe(e,i);o.samplingMode=le.NEAREST,o.wrapMode=Di.CLAMP_TO_EDGE;const s=new Vr(t,new Ro(_o.DEPTH24_STENCIL8,e,i));this._dotFBO=new Co(t,o,s)}return this._dotFBO}getDotDensityMesh(t){if(this._dotMesh==null){const e=pt,i=e*e,o=2,s=new Int16Array(i*o);for(let a=0;a<e;a++)for(let l=0;l<e;l++)s[o*(l+a*e)]=l,s[o*(l+a*e)+1]=a;this._dotMesh=Fo.create(t,{primitive:Ao.POINTS,vertex:s,count:i,layout:Kr})}return this._dotMesh}getDotDensityTextures(t,e,i){if(this._dotTextureSize===e&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=e,this._seed=i),this._dotTextures===null){const o=new Os(i);this._dotTextures=[this._allocDotDensityTexture(t,e,o),this._allocDotDensityTexture(t,e,o)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let t=0;t<this._dotTextures.length;t++)this._dotTextures[t].dispose();this._dotTextures=null}}_allocDotDensityTexture(t,e,i){const o=new Float32Array(e*e*4);for(let a=0;a<o.length;a++)o[a]=i.getFloat();const s=new Qe;return s.dataType=Ce.FLOAT,s.samplingMode=le.NEAREST,s.width=e,s.height=e,new Oo(t,s,o)}},jr=class extends et{constructor(){super(...arguments),this.type=W.DotDensity,this.shaders={polygon:new ge,point:new fe,fill:new Rt},this._resources=new Map}render(t,e){zo(t)||G(t)?this._renderPolygons(t,e):this._renderDotDensity(t,e)}_renderPolygons(t,e){const{painter:i}=t;i.setShader({shader:this.shaders.fill,uniforms:{...Q(t,e.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...$(t)},optionalAttributes:{zoomRange:!1},useComputeBuffer:G(t)}),i.setPipelineState(tt(t)),i.submitDraw(t,e)}_renderDotDensity(t,e){const{context:i,painter:o,requiredLevel:s}=t,a=e.instance.getInput().uniforms,l=this._getOrCreateResourcesRecord(i),u=l.getDotDensityTextures(i,pt,a.seed),p=1/2**(s-e.target.key.level),c=pt,d=c*window.devicePixelRatio*c*window.devicePixelRatio,m=1/p*(1/p),v=a.dotScale?t.state.scale/a.dotScale:1,g=a.dotValue*v*m;o.setShader({shader:this.shaders.polygon,uniforms:{...Q(t,e.target),instance:{isActive:a.isActive,colors:a.colors,dotValue:Math.max(1,g)},draw:{dotTexture0:{unit:ho,texture:u[0]},dotTexture1:{unit:Qs,texture:u[1]},tileZoomFactor:p,pixelRatio:window.devicePixelRatio,tileDotsOverArea:d/(pt*window.devicePixelRatio*pt*window.devicePixelRatio)}},defines:{...$(t),blending:a.blending},optionalAttributes:{},useComputeBuffer:!1});const b=i.getViewport();i.setViewport(0,0,pt,pt);const x=i.getBoundFramebufferObject(),S=l.getFBO(i);i.bindFramebuffer(S),i.setClearColor(0,0,0,0),i.clear(Ye.COLOR),o.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),o.updatePipelineState(i),o.submitDraw(t,e),i.bindFramebuffer(x),i.setViewport(b.x,b.y,b.width,b.height);const V=l.getFBO(i).colorTexture,A={shader:this.shaders.point,uniforms:{view:wr(t,e.target),instance:{dotSize:a.dotSize},draw:{locations:{unit:ho,texture:V},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...$(t)},optionalAttributes:{},useComputeBuffer:!1};o.setPipelineState(tt(t)),o.submitDrawMesh(i,A,l.getDotDensityMesh(i))}shutdown(t){super.shutdown(t),this._resources.get(t)?.destroy(),this._resources.delete(t)}_getOrCreateResourcesRecord(t){let e=this._resources.get(t);return e==null&&(e=new $r,this._resources.set(t,e)),e}},Zr=class extends et{constructor(){super(...arguments),this.type=W.ComplexFill,this.shaders={geometry:new Ie}}render(t,e){const{context:i,painter:o}=t,s=e.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,s.uniforms),...Q(t,e.target),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey),localTileOffset:Re(e.target)},defines:{...$(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:G(t)}),o.setPipelineState(tt(t)),o.submitDraw(t,e)}};function be(t){const e=1/t;return{antialiasing:e,blur:0+e}}let Zt=class extends yt{};n([y(3,f)],Zt.prototype,"offset",void 0),n([y(4,w)],Zt.prototype,"color",void 0),n([y(5,f)],Zt.prototype,"normal",void 0),n([y(6,r)],Zt.prototype,"halfWidth",void 0),n([y(7,r)],Zt.prototype,"referenceHalfWidth",void 0),n([y(8,f)],Zt.prototype,"zoomRange",void 0);let jo=class extends Go{};function qi(t,e,i){const{id:o,bitset:s}=e,a=q(s,cr),l=U(a,new r(.5)),u=ai(t,e),p=M(l,u.halfWidth,new r(0)),c=me(t,o),d=de(t,o,e.color),m=M(l,M(ne(s,dr),d,e.color),d.multiply(c)),v=t.view.displayViewScreenMat3.multiply(new _(e.pos.xy,1)),g=t.clip(e.id),b=new w(v.xy,g,1),x=M(l,u.glPosition,b),S=i&&t.maybeRunHittest(e,i,l);return{isOutline:a,color:m,opacity:new r(1),halfWidth:p,normal:u.normal,glPosition:x,...S}}let Dt=class extends at{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}};n([h(ri)],Dt.prototype,"antialiasingControls",void 0),n([R(Kt)],Dt.prototype,"visualVariableColor",void 0),n([R($t)],Dt.prototype,"visualVariableOpacity",void 0),n([R(pe)],Dt.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(te)],Dt.prototype,"visualVariableSizeScaleStops",void 0),n([R(ee)],Dt.prototype,"visualVariableSizeStops",void 0),n([R(ce)],Dt.prototype,"visualVariableSizeUnitValue",void 0);class mi extends Dt{constructor(){super(...arguments),this.type="OutlineFillShader"}vertex(e,i){return qi(this,e,i)}fragment(e){const{color:i,isOutline:o}=e,s=U(o,new r(.5)),a=ni(e,this.antialiasingControls.blur),l=M(s,a,i),u=M(s,new r(1/255),new r(0));return this.getFragmentOutput(l,e,u)}hittest(e,i,o){return M(o,he(this.hittestRequest),si(this,e,i))}}n([z(0,P(Zt)),z(1,P(ft))],mi.prototype,"vertex",null),n([z(0,P(jo))],mi.prototype,"fragment",null);let Gi=class extends ye{};n([y(5,w)],Gi.prototype,"tlbr",void 0),n([y(6,r)],Gi.prototype,"inverseRasterizationScale",void 0);let Xr=class extends zt{};function Yr(t){const e=new r(1),i=new r(0);return new E(e.divide(t.x),i.divide(t.y),0,J(i.divide(t.x)),e.divide(t.y),0,0,0,1)}function Zo(t,e){const i=e.tlbr.xy,o=e.tlbr.zw,s=o.x.subtract(i.x),a=i.y.subtract(o.y),l=new f(s,a).multiply(e.inverseRasterizationScale),u=l.multiply(t.view.requiredZoomFactor),p=Yr(u),c=t.localTileOffset.getPatternOffsetAtTileOrigin(l).divide(u),d=new _(e.pos,1);return{tileTextureCoord:p.multiply(d).xy.subtract(c),tlbr:e.tlbr.divide(t.mosaicInfo.size.xyxy)}}function Xo(t,e){const i=Pe(t.tileTextureCoord,new r(1)),o=K(t.tlbr.xy,t.tlbr.zw,i),s=B(e.texture,o);return t.color.multiply(s)}class Le extends Rt{constructor(){super(...arguments),this.type="PatternFillShader"}vertex(e,i){return{...super.vertex(e,i),...Zo(this,e)}}fragment(e){const i=Xo(e,this.mosaicInfo);return this.getFragmentOutput(i,e,new r(0))}}n([h(vt)],Le.prototype,"mosaicInfo",void 0),n([h(Jt)],Le.prototype,"localTileOffset",void 0),n([z(0,P(Gi)),z(1,P(ft))],Le.prototype,"vertex",null),n([z(0,P(Xr))],Le.prototype,"fragment",null);let Wi=class extends Zt{};n([y(9,w)],Wi.prototype,"tlbr",void 0),n([y(10,r)],Wi.prototype,"inverseRasterizationScale",void 0);let Yo=class extends jo{},Ee=class extends mi{constructor(){super(...arguments),this.type="PatternOutlineFillShader"}vertex(t,e){return{...qi(this,t,e),...Zo(this,t)}}fragment(t){const{isOutline:e}=t,i=U(e,new r(.5)),o=ni(t,this.antialiasingControls.blur),s=Xo(t,this.mosaicInfo),a=M(i,o,s),l=M(i,new r(1/255),new r(0));return this.getFragmentOutput(a,t,l)}};n([h(vt)],Ee.prototype,"mosaicInfo",void 0),n([h(Jt)],Ee.prototype,"localTileOffset",void 0),n([z(0,P(Wi)),z(1,P(ft))],Ee.prototype,"vertex",null),n([z(0,P(Yo))],Ee.prototype,"fragment",null);const Qo=1/hr;let It=class extends yt{};n([y(3,w)],It.prototype,"color",void 0),n([y(4,w)],It.prototype,"tlbr",void 0),n([y(5,r)],It.prototype,"angle",void 0),n([y(6,r)],It.prototype,"aux1",void 0),n([y(7,r)],It.prototype,"aux2",void 0),n([y(8,f)],It.prototype,"aux3",void 0),n([y(9,f)],It.prototype,"aux4",void 0),n([y(10,f)],It.prototype,"zoomRange",void 0);let Qr=class extends Yo{},ke=class extends Dt{constructor(){super(...arguments),this.type="ComplexOutlineFillShader"}vertex(t,e){const{aux1:i,aux2:o,aux3:s,aux4:a}=t,l={...t,width:i,height:o,offset:s,scale:a.multiply(Qo)},u={...t,halfWidth:i,referenceHalfWidth:o,offset:s,normal:a.subtract(mr).multiply(Qo)},p=qi(this,u),c=Uo(this,l),d=U(p.isOutline,new r(.5));return{...p,...c,...this.maybeRunHittest(t,e,d)}}fragment(t){const{isOutline:e}=t,i=U(e,new r(.5)),o=ni(t,this.antialiasingControls.blur),s=qo(this,t),a=M(i,o,s),l=M(i,new r(1/255),new r(0));return this.getFragmentOutput(a,t,l)}hittest(t,e,i){return M(i,he(this.hittestRequest),si(this,t,e))}};n([h(vt)],ke.prototype,"mosaicInfo",void 0),n([h(Jt)],ke.prototype,"localTileOffset",void 0),n([z(0,P(It)),z(1,P(ft))],ke.prototype,"vertex",null),n([z(0,P(Qr))],ke.prototype,"fragment",null);let Jr=class extends et{constructor(){super(...arguments),this.type=W.ComplexOutlineFill,this.shaders={geometry:new ke}}render(t,e){const{context:i,painter:o,pixelRatio:s}=t,a=e.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,a.uniforms),...Q(t,e.target),antialiasingControls:be(s),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey),localTileOffset:Re(e.target)},defines:{...$(t)},optionalAttributes:a.optionalAttributes,useComputeBuffer:G(t)}),o.setPipelineState(tt(t)),o.submitDraw(t,e)}},ta=class extends et{constructor(){super(...arguments),this.type=W.Fill,this.shaders={geometry:new Rt}}render(t,e){const{painter:i}=t,o=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,o.uniforms),...Q(t,e.target)},defines:$(t),optionalAttributes:o.optionalAttributes,useComputeBuffer:G(t)}),i.setPipelineState(tt(t)),i.submitDraw(t,e)}},Be=class extends ye{};n([y(5,w)],Be.prototype,"tlbr",void 0),n([y(6,f)],Be.prototype,"relativePosition",void 0),n([y(7,r)],Be.prototype,"gradientMethod",void 0),n([y(8,f)],Be.prototype,"relativeGradientSize",void 0);class ea extends zt{}let hi=class extends Rt{constructor(){super(...arguments),this.type="GradientFillShader"}vertex(t,e){const{tlbr:i,relativePosition:o,gradientMethod:s,relativeGradientSize:a}=t,l=M(ne(t.bitset,mo.isAbsolute),this.view.displayZoomFactor,new r(1));return{...super.vertex(t,e),tlbr:i,relativePosition:o,gradientMethod:s,gradientSize:a.multiply(l),isDiscrete:q(t.bitset,mo.isDiscrete)}}fragment(t){const{tlbr:e,relativePosition:i,gradientMethod:o,gradientSize:s,isDiscrete:a}=t,l=M(U(a,new r(.5)),s.subtract(1),new f(0)),u=Tt([dt(o,new r(co.rectangular)),()=>{const v=Me(i).add(l).divide(s);return Xe(St(v.x,v.y))}],[dt(o,new r(co.circular)),Xe(po(Qt(i,i)).add(l.x).divide(s.x))],[!0,Xe(i.x.add(l.x).divide(s.x))]),p=new f(mt(u,new r(0),new r(1)),.5),c=K(e.xy,e.zw,p).divide(this.mosaicInfo.size),d=B(this.mosaicInfo.texture,c),m=t.color.a;return this.getFragmentOutput(d.multiply(m),t,new r(0))}};n([h(vt)],hi.prototype,"mosaicInfo",void 0),n([z(0,P(Be)),z(1,P(ft))],hi.prototype,"vertex",null),n([z(0,P(ea))],hi.prototype,"fragment",null);let ia=class extends et{constructor(){super(...arguments),this.type=W.GradientFill,this.shaders={geometry:new hi},this.symbologyPlane=ut.FILL}render(t,e){const{context:i,painter:o}=t,s=e.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,s.uniforms),...Q(t,e.target),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey)},defines:{...$(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:G(t)}),o.setPipelineState(tt(t)),o.submitDraw(t,e)}},oa=class extends et{constructor(){super(...arguments),this.type=W.OutlineFill,this.shaders={geometry:new mi}}render(t,e){const{painter:i,pixelRatio:o}=t,s=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,s.uniforms),...Q(t,e.target),antialiasingControls:be(o)},defines:{...$(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:G(t)}),i.setPipelineState(tt(t)),i.submitDraw(t,e)}},sa=class extends et{constructor(){super(...arguments),this.type=W.PatternFill,this.shaders={geometry:new Le}}render(t,e){const{context:i,painter:o}=t,s=e.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,s.uniforms),...Q(t,e.target),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey),localTileOffset:Re(e.target)},defines:{...$(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:G(t)}),o.setPipelineState(tt(t)),o.submitDraw(t,e)}},ra=class extends et{constructor(){super(...arguments),this.type=W.PatternOutlineFill,this.shaders={geometry:new Ee}}render(t,e){const{context:i,painter:o,pixelRatio:s}=t,a=e.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,a.uniforms),...Q(t,e.target),antialiasingControls:be(s),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey),localTileOffset:Re(e.target)},defines:{...$(t)},optionalAttributes:a.optionalAttributes,useComputeBuffer:G(t)}),o.setPipelineState(tt(t)),o.submitDraw(t,e)}},Ki=class{constructor(t,e,i,o){this.dataType=t,this.samplingMode=e,this.pixelFormat=i,this.internalFormat=o}};function aa(t,e){const{textureFloatLinear:i,colorBufferFloat:o}=t.capabilities,s=o?.textureFloat,a=o?.textureHalfFloat,l=o?.floatBlend,u=t.driverTest.floatBufferBlend.result;if(!s&&!a)throw new qe("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(l&&u||a))throw new qe("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(u?"":" This device claims support for EXT_float_blend, but does not actually support it."));const p=s&&l&&u,c=a,d=i,m=!!o?.R32F,v=!!o?.R16F;if(p&&d)return d||e.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new Ki(Ce.FLOAT,d?le.LINEAR:le.NEAREST,m?Gt.RED:Gt.RGBA,m?To.R32F:Gt.RGBA);if(c)return new Ki(Ce.HALF_FLOAT,le.LINEAR,v?Gt.RED:Gt.RGBA,v?To.R16F:Gt.RGBA);throw new qe("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}new Ki(Ce.HALF_FLOAT,le.NEAREST,Gt.RGBA,Gt.RGBA);const na=()=>oo.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources");let la=class{destroy(){this._accumulateFramebuffer=io(this._accumulateFramebuffer),this._resolveGradientTexture=io(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(t){if(this._qualityProfile==null){const e=aa(t,na());this._qualityProfile={...e,defines:{usesHalfFloatPrecision:e.dataType!==Ce.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(t,e,i){if(this._accumulateFramebuffer==null){const{dataType:o,samplingMode:s,pixelFormat:a,internalFormat:l}=this.loadQualityProfile(t),u=new Qe(e,i);u.pixelFormat=a,u.internalFormat=l,u.dataType=o,u.samplingMode=s,u.wrapMode=Di.CLAMP_TO_EDGE;const p=new Ro(_o.DEPTH24_STENCIL8,e,i);this._accumulateFramebuffer=new Co(t,u,p)}else{const{width:o,height:s}=this._accumulateFramebuffer;o===e&&s===i||this._accumulateFramebuffer.resize(e,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(t,e,i){if(this._resolveGradientTexture==null){const o=new Qe;o.wrapMode=Di.CLAMP_TO_EDGE,this._resolveGradientTexture=new Oo(t,o),this._prevGradientHash=null}return this._prevGradientHash!==e&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=e),this._resolveGradientTexture}};function Jo(t){return t?.25:1}let ts=class extends yt{};n([y(5,f)],ts.prototype,"offset",void 0);let ua=class extends zt{},$i=class extends H{};n([h(r)],$i.prototype,"radius",void 0),n([h(r)],$i.prototype,"isFieldActive",void 0);let He=class extends at{constructor(){super(...arguments),this.type="HeatmapAccumulateShader",this.usesHalfFloatPrecision=!1}vertex(t){const{radius:e,isFieldActive:i}=this.kernelControls,o=t.offset,s=i.multiply(this.storage.getVVData(t.id).x).add(new r(1).subtract(i)),a=this.view.displayViewScreenMat3.multiply(new _(t.pos,1)).add(this.view.displayViewMat3.multiply(new _(o,0)).multiply(e)),l=this.clip(t.id);return{glPosition:new w(a.xy,l,1),offset:o,fieldValue:s,color:new w(0),...this.maybeRunHittest(t,{},null)}}fragment(t){const{offset:e,fieldValue:i}=t,o=Yt(e),s=k(o,new r(1)),a=new r(1).subtract(o.multiply(o)),l=a.multiply(a),u=s.multiply(l).multiply(i).multiply(new r(Jo(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new w(u),t)}hittest(t){const{viewMat3:e,tileMat3:i}=this.view,o=e.multiply(i).multiply(new _(t.pos,1));return Fr(o.xy,this.kernelControls.radius,this.hittestRequest.position)}};n([Ht],He.prototype,"usesHalfFloatPrecision",void 0),n([h($i)],He.prototype,"kernelControls",void 0),n([z(0,P(ts))],He.prototype,"vertex",null),n([z(0,P(ua))],He.prototype,"fragment",null);let es=class extends Pi{};n([y(0,f)],es.prototype,"position",void 0);let pa=class extends ro{},yi=class extends H{};n([h(N)],yi.prototype,"texture",void 0),n([h(f)],yi.prototype,"minAndInvRange",void 0),n([h(r)],yi.prototype,"normalization",void 0);let is=class extends H{};n([h(N)],is.prototype,"texture",void 0);let xe=class extends zi{constructor(){super(...arguments),this.type="HeatmapResolveShader",this.usesHalfFloatPrecision=!1}vertex(t){return{glPosition:new w(t.position.multiply(2).subtract(1),1,1),uv:t.position}}fragment(t){const{accumulatedDensity:e,gradient:i}=this;let o=B(e.texture,t.uv).r.divide(new r(Jo(this.usesHalfFloatPrecision)));o=o.multiply(e.normalization),o=o.subtract(e.minAndInvRange.x).multiply(e.minAndInvRange.y);const s=B(i.texture,new f(o,.5)),a=new Ge;return a.fragColor=new w(s.rgb.multiply(s.a),s.a),a}};n([Ht],xe.prototype,"usesHalfFloatPrecision",void 0),n([h(yi)],xe.prototype,"accumulatedDensity",void 0),n([h(is)],xe.prototype,"gradient",void 0),n([z(0,P(es))],xe.prototype,"vertex",null),n([z(0,P(pa))],xe.prototype,"fragment",null);let ca=class extends et{constructor(){super(...arguments),this.type=W.Heatmap,this.drawPhase=re.MAP|re.HITTEST|re.DEBUG,this.shaders={accumulate:new He,resolve:new xe},this._isBound=!1,this._resources=new Map}shutdown(t){super.shutdown(t),this._resources.get(t)?.destroy(),this._resources.delete(t),this._prevFBO=null,this._unbind()}render(t,e){const{context:i,painter:o,state:s}=t,a=e.instance.getInput(),{isFieldActive:l}=a.uniforms,u=this._getOrCreateResourcesRecord(i),p=u.loadQualityProfile(i);G(t)||this._bind(t,u,a),o.setShader({shader:this.shaders.accumulate,uniforms:{...Q(t,e.target),kernelControls:{radius:rs(a,s),isFieldActive:l?1:0}},defines:{...$(t),...p.defines},optionalAttributes:{},useComputeBuffer:G(t)});const c=G(t)?ma:ss;o.setPipelineState(c),o.submitDraw(t,e)}getStencilReference(t){return os(t)}renderResolvePass(t,e){if(G(t))return;const{context:i,painter:o}=t,s=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!s?.initialized)return;const{defines:a}=s.loadQualityProfile(i),{minDensity:l,maxDensity:u,radius:p}=e.getInput().uniforms,c=8,d=9,m=s.accumulateFramebuffer,v=s.resolveGradientTexture,g={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:c,texture:m.colorTexture},minAndInvRange:[l,1/(u-l)],normalization:3/(p*p*Math.PI)},gradient:{texture:{unit:d,texture:v}}},defines:a,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(m.colorTexture,c),i.bindTexture(v,d),o.setPipelineState(ha),o.submitDrawMesh(i,g,o.quadMesh),this._unbind()}_getOrCreateResourcesRecord(t){let e=this._resources.get(t);return e==null&&(e=new la,this._resources.set(t,e)),e}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(t,e,i){if(this._isBound)return;const{context:o,state:s,pixelRatio:a}=t,l=o.getBoundFramebufferObject(),u=o.getViewport();this._prevFBO=l,this._prevViewport=u;const{gradient:p,gradientHash:c}=i.uniforms;e.ensureResolveGradientTexture(o,c,p);const{width:d,height:m}=u,v=da(rs(i,s),a),g=d*v,b=m*v,x=e.ensureAccumulateFBO(o,g,b);o.blitFramebuffer(l,x,Ye.STENCIL),o.bindFramebuffer(x),o.setViewport(0,0,x.width,x.height),o.setColorMask(!0,!0,!0,!0),o.setClearColor(0,0,0,0),o.clear(Ye.COLOR),this._isBound=!0}};function da(t,e){const i=e>1.5?.25:.5;return t<1/(2*i)?1:i}function os(t){return t.key.level+1}const ss={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:os,compare:ue.GEQUAL,mask:255,op:{fail:ht.KEEP,zFail:ht.KEEP,zPass:ht.REPLACE}}}},ma={...ss,stencil:!1},ha={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function rs(t,e){const{referenceScale:i,radius:o}=t.uniforms;return o*(i!==0?i/e.scale:1)}const ya=360/254;var nt;(function(t){t[t.Color=0]="Color",t[t.Outline=1]="Outline",t[t.Halo=2]="Halo"})(nt||(nt={}));class xt extends yt{}n([y(3,w)],xt.prototype,"color",void 0),n([y(4,f)],xt.prototype,"offset",void 0),n([y(5,f)],xt.prototype,"textureUV",void 0),n([y(6,f)],xt.prototype,"fontAndReferenceSize",void 0),n([y(7,w)],xt.prototype,"outlineColor",void 0),n([y(8,w)],xt.prototype,"haloColor",void 0),n([y(9,f)],xt.prototype,"outlineAndHaloSize",void 0),n([y(10,f)],xt.prototype,"zoomRange",void 0),n([y(11,r)],xt.prototype,"clipAngle",void 0),n([y(12,w)],xt.prototype,"referenceSymbol",void 0),n([y(15,r)],xt.prototype,"visibility",void 0);let ji=class extends Ae{};n([y(13,f)],ji.prototype,"offsetNextVertex1",void 0),n([y(14,f)],ji.prototype,"offsetNextVertex2",void 0);let fa=class extends zt{},rt=class extends at{constructor(){super(...arguments),this.type="TextShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=nt.Color,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(t,e){const{clipAngle:i,zoomRange:o,visibility:s}=t,a=i.multiply(ya),l=Me(this.view.rotation.subtract(a)),u=qt(new r(360).subtract(l),l);let p=new r(0);const c=Gs(this.view.currentZoom.multiply(yo)).divide(yo),d=o.x,m=o.y,v=new r(1).subtract(k(d,c)).multiply(2),g=k(new r(90),u).multiply(2),b=new r(2).multiply(new r(1).subtract(k(c,m)));return p=p.add(e.multiply(v)),p=p.add(e.multiply(g)),p=p.add(b),s&&(p=p.add(s)),p}vertex(t,e){const i=q(t.bitset,yr),o=new r(1).subtract(i);let s=t.fontAndReferenceSize[0];const a=t.fontAndReferenceSize[1];let l=s.divide(wo);const u=this.textRenderPassType===nt.Outline?t.outlineColor:this.textRenderPassType===nt.Halo?t.haloColor:this._getVertexColor(t),p=this.view.displayViewScreenMat3.multiply(new _(t.pos,1));let c=t.offset,d=new r(1),m=E.identity(),v=new f(0);if(this.isLabel){if(!t.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const A=t.referenceSymbol,I=A.xy,L=A.z,C=this._unpackDirection(A.w),O=De(this,t.id,L).divide(2),D=C.multiply(O.add(Js));v=I.add(D),c=c.add(v)}else d=De(this,t.id,a).divide(a),s=s.multiply(d),l=l.multiply(d),c=c.multiply(d),m=Eo(this,t.id),c=m.multiply(new _(c,0)).xy;const g=q(t.bitset,fr),b=this._getViewRotationMatrix(g).multiply(new _(c,0));let x=this.isLabel?this.clipLabel(t,g):this.clip(t.id,t.zoomRange);x=this.isBackgroundPass?x.add(o.multiply(2)):x.add(i.multiply(2));let S=new r(0);if(this.textRenderPassType===nt.Outline&&(x=x.add(M(dt(t.outlineAndHaloSize.x,new r(0)),new r(2),new r(0))),S=new r(t.outlineAndHaloSize.x).divide(l).divide(So)),this.textRenderPassType===nt.Halo){const A=t.outlineAndHaloSize.x,I=new r(t.outlineAndHaloSize.y);x=x.add(M(dt(I,new r(0)),new r(2),new r(0))),S=I.add(A).divide(l).divide(So)}const V=this.isLabel?U(x,new r(1)):new Te(!1);return{glPosition:new w(p.xy.add(b.xy),x,1),color:u,size:l,textureUV:t.textureUV.divide(this.mosaicInfo.size),antialiasingWidth:new r(.105*wo).divide(s).divide(this.view.pixelRatio),outlineDistanceOffset:S,...this.maybeRunHittest(t,e,{vvSizeAdjustment:d,vvRotation:m,labelOffset:v,labelClipped:V})}}_getViewRotationMatrix(t){const e=this.view.displayViewMat3,i=this.view.displayMat3,o=new r(1).subtract(t);return e.multiply(t).add(i.multiply(o))}fragment(t){const e=new r(.25),i=new r(1).subtract(e),o=B(this.mosaicInfo.texture,t.textureUV).a;let s=i.subtract(t.outlineDistanceOffset);this.highlight&&(s=s.divide(2));const a=t.antialiasingWidth,l=uo(s.subtract(a),s.add(a),o);return this.getFragmentOutput(t.color.multiply(l),t)}hittest(t,e,{vvSizeAdjustment:i,vvRotation:o,labelOffset:s,labelClipped:a}){let l,u,p;this.isLabel?(l=new _(t.offset.add(s),0),u=new _(e.offsetNextVertex1.add(s),0),p=new _(e.offsetNextVertex2.add(s),0)):(l=o.multiply(new _(t.offset.multiply(i),0)),u=o.multiply(new _(e.offsetNextVertex1.multiply(i),0)),p=o.multiply(new _(e.offsetNextVertex2.multiply(i),0)));const{viewMat3:c,tileMat3:d}=this.view,m=c.multiply(d).multiply(new _(t.pos,1)),v=m.add(d.multiply(l)).xy,g=m.add(d.multiply(u)).xy,b=m.add(d.multiply(p)).xy,x=oi(this.hittestRequest.position,v.xy,g.xy,b.xy);return this.isLabel?M(a,he(this.hittestRequest),x):x}_unpackDirection(t){const e=new Mi(t),i=Ws(e,new Mi(2)),o=Ks(e,new Mi(3));return new f(new r(i).subtract(1),new r(o).subtract(1))}_getVertexColor(t){let e=t.color;if(this.visualVariableColor){const i=this.storage.getColorValue(t.id);e=this.visualVariableColor.getColor(i,t.color,new Te(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(t.id),o=this.visualVariableOpacity.getOpacity(i);e=e.multiply(o)}return e}};n([R(Kt)],rt.prototype,"visualVariableColor",void 0),n([R($t)],rt.prototype,"visualVariableOpacity",void 0),n([R(ei)],rt.prototype,"visualVariableRotation",void 0),n([R(pe)],rt.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(te)],rt.prototype,"visualVariableSizeScaleStops",void 0),n([R(ee)],rt.prototype,"visualVariableSizeStops",void 0),n([R(ce)],rt.prototype,"visualVariableSizeUnitValue",void 0),n([h(vt)],rt.prototype,"mosaicInfo",void 0),n([Ht],rt.prototype,"textRenderPassType",void 0),n([Ht],rt.prototype,"isBackgroundPass",void 0),n([Ht],rt.prototype,"isLabel",void 0),n([z(0,P(xt)),z(1,P(ji))],rt.prototype,"vertex",null),n([z(0,P(fa))],rt.prototype,"fragment",null);let va=class extends et{constructor(){super(...arguments),this.type=W.Label,this.shaders={geometry:new rt},this.drawPhase=re.LABEL|re.LABEL_ALPHA|re.HITTEST,this.symbologyPlane=ut.TEXT}render(t,e){const{context:i,painter:o}=t,s=$(t),a={...tt(t),stencil:{write:!1,test:{ref:()=>255,compare:ue.GREATER,mask:255,op:{fail:ht.KEEP,zFail:ht.KEEP,zPass:ht.KEEP}}}},l=e.instance.getInput(),u={shader:this.shaders.geometry,uniforms:{...it(t,e.target,l.uniforms),...Q(t,e.target),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey)},defines:{...s,textRenderPassType:nt.Color,isBackgroundPass:!0,isLabel:!0},optionalAttributes:l.optionalAttributes,useComputeBuffer:G(t)};o.setPipelineState(a),o.setShader(u),o.submitDraw(t,e),o.setShader({...u,defines:{...s,textRenderPassType:nt.Halo,isBackgroundPass:!1,isLabel:!0}}),o.submitDraw(t,e),o.setShader({...u,defines:{...s,textRenderPassType:nt.Color,isBackgroundPass:!1,isLabel:!0}}),o.submitDraw(t,e)}};function ga(t){return k(new r(0),t).multiply(2).subtract(1)}class we extends Ct{}n([y(9,r)],we.prototype,"accumulatedDistance",void 0),n([y(10,r)],we.prototype,"totalLength",void 0),n([y(11,r)],we.prototype,"gradientSize",void 0),n([y(12,f)],we.prototype,"segmentDirection",void 0),n([y(13,w)],we.prototype,"tlbr",void 0);let as=class extends H{};n([h(r)],as.prototype,"isColorPass",void 0);let fi=class extends bt{constructor(){super(...arguments),this.type="GradientStrokeShader"}vertex(t,e){const{totalLength:i,gradientSize:o,segmentDirection:s,tlbr:a}=t,l=ai(this,t),u=q(t.bitset,je.isAlongLine),p=i.divide(this.view.displayZoomFactor),c=M(ne(t.bitset,je.isAbsoluteSize),()=>{const v=M(U(u,new r(.5)),p,l.halfWidth);return o.divide(v)},o),d=t.accumulatedDistance.add(Qt(s,l.scaledOffset).divide(p)),m=a.divide(this.mosaicInfo.size.xyxy);return{...l,tlbr:m,relativePositionAlongLine:d,relativeGradientSize:c,isAlongLine:q(t.bitset,je.isAlongLine),isDiscrete:q(t.bitset,je.isDiscrete),...this.maybeRunHittest(t,e,l.halfWidth)}}fragment(t){const{isAlongLine:e,isDiscrete:i,relativePositionAlongLine:o,relativeGradientSize:s,normal:a,tlbr:l}=t,u=Hi(t,this.antialiasingControls.blur),p=ga(a.y).multiply(qt(Yt(a),new r(1))),c=new r(.5).multiply(p).add(new r(.5)),d=M(U(e,new r(.5)),o,c),m=M(U(i,new r(.5)),s.subtract(1),new r(0)),v=Xe(d.add(m).divide(s)),g=K(l.xy,l.zw,new f(mt(v,new r(0),new r(1)),.5)),b=B(this.mosaicInfo.texture,g),x=t.opacity.multiply(u),S=this.getFragmentOutput(b.multiply(x),t),V=k(new r(.5),this.technique.isColorPass).multiply(Bt("gradient-depth-epsilon")),A=k(new r(0),a.y).multiply(new r(Bt("gradient-depth-bias")).subtract(V));return S.glFragDepth=mt(Yt(a).add(A),new r(0),new r(1)),S}};n([h(vt)],fi.prototype,"mosaicInfo",void 0),n([h(as)],fi.prototype,"technique",void 0),n([z(0,P(we)),z(1,P(ft))],fi.prototype,"vertex",null);let ba=class extends et{constructor(){super(...arguments),this.type=W.GradientStroke,this.shaders={geometry:new fi},this.symbologyPlane=ut.LINE}_getShaderOptions(t,e,i){const{context:o,painter:s,pixelRatio:a}=t,l=e.instance.getInput();return{shader:this.shaders.geometry,uniforms:{...it(t,e.target,l.uniforms),...Q(t,e.target),antialiasingControls:be(a),mosaicInfo:s.textureManager.getMosaicInfo(o,e.textureKey),technique:{isColorPass:i}},defines:{...$(t)},optionalAttributes:l.optionalAttributes,useComputeBuffer:G(t)}}render(t,e){const{painter:i}=t;if(G(t)||zo(t)){const a=tt(t);return i.setPipelineState(a),i.setShader(this._getShaderOptions(t,e,1)),void i.submitDraw(t,e)}t.context.setClearDepth(1),t.context.clear(Ye.DEPTH);const o={color:!1,depth:{write:{zNear:0,zFar:1},test:ue.LESS},stencil:{write:!1,test:{ref:a=>a.stencilRef,compare:ue.EQUAL,mask:255,op:{fail:ht.KEEP,zFail:ht.KEEP,zPass:ht.KEEP}}}};i.setShader(this._getShaderOptions(t,e,0)),i.setPipelineState(o),i.submitDraw(t,e);const s={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:{write:!1,test:ue.LEQUAL},stencil:{write:!1,test:{ref:a=>a.stencilRef,compare:ue.EQUAL,mask:255,op:{fail:ht.KEEP,zFail:ht.KEEP,zPass:ht.KEEP}}}};i.setShader(this._getShaderOptions(t,e,1)),i.setPipelineState(s),i.submitDraw(t,e)}},xa=class extends et{constructor(){super(...arguments),this.type=W.Line,this.shaders={geometry:new bt},this.symbologyPlane=ut.LINE}render(t,e){const{painter:i,pixelRatio:o}=t,s=e.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,s.uniforms),...Q(t,e.target),antialiasingControls:be(o)},defines:{...$(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:G(t)}),i.setPipelineState(tt(t)),i.submitDraw(t,e)}};class Se extends Ct{}n([y(9,r)],Se.prototype,"accumulatedDistance",void 0),n([y(10,f)],Se.prototype,"segmentDirection",void 0),n([y(11,r)],Se.prototype,"offsetAlongLine",void 0),n([y(12,r)],Se.prototype,"capType",void 0),n([y(13,w)],Se.prototype,"tlbr",void 0);class Zi extends bt{constructor(){super(...arguments),this.type="TexturedLineShader"}_getDistanceRatio(e,i){const o=q(e.bitset,vr);return o.multiply(St(i,new r(.25)).multiply(new r(2))).add(new r(1).subtract(o).multiply(Xt(1)))}_getSDFAlpha(e){const{halfWidth:i,normal:o,tlbr:s,patternSize:a,accumulatedDistance:l,offsetAlongLine:u,dashToPx:p,capType:c}=e,d=a.x.divide(Pr).multiply(p),m=Ai(l.add(u).divide(d)),v=K(s.xy,s.zw,new f(m,.5)),g=Ze(B(this.mosaicInfo.texture,v)).multiply(2).subtract(1).multiply(Ar).multiply(p),b=o.y.multiply(i),x=Tt([dt(c,new r(1)),g.subtract(i)],[dt(c,new r(2)),po($s(St(g,new r(0)),new r(2)).add(b.multiply(b))).subtract(i)],[!0,g]),S=mt(new r(.25).subtract(x),new r(0),new r(1));return new w(S)}_getPatternColor(e){const{halfWidth:i,normal:o,color:s,accumulatedDistance:a,patternSize:l,sampleAlphaOnly:u,tlbr:p}=e,c=l.y.multiply(new r(2).multiply(i).divide(l.x)),d=Ai(a.divide(c)),m=new r(.5).multiply(o.y).add(new r(.5)),v=K(p.xy,p.zw,new f(m,d));let g=B(this.mosaicInfo.texture,v);return this.visualVariableColor!=null&&(g=M(U(u,new r(.5)),new w(s.a),s)),g}vertex(e,i){const{segmentDirection:o,tlbr:s,bitset:a}=e,l=ai(this,e),u=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Qt(o,l.scaledOffset)),p=new f(s.z.subtract(s.x),s.w.subtract(s.y)),c=s.divide(this.mosaicInfo.size.xyxy),d=q(a,gr),m=q(a,xo),v=M(U(d,new r(.5)),this._getDistanceRatio(e,l.scaledHalfWidth),new r(1));return{...l,tlbr:c,patternSize:p,accumulatedDistance:u,isSDF:d,sampleAlphaOnly:m,dashToPx:v,offsetAlongLine:e.offsetAlongLine,capType:e.capType,...this.maybeRunHittest(e,i,l.halfWidth)}}fragment(e){const{color:i,opacity:o,isSDF:s}=e,a=Hi(e,this.antialiasingControls.blur),l=M(U(s,new r(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),u=i.multiply(o).multiply(a).multiply(l);return this.getFragmentOutput(u,e)}}n([h(vt)],Zi.prototype,"mosaicInfo",void 0),n([z(0,P(Se)),z(1,P(ft))],Zi.prototype,"vertex",null);let wa=class extends et{constructor(){super(...arguments),this.type=W.TexturedLine,this.shaders={geometry:new Zi},this.symbologyPlane=ut.LINE}render(t,e){const{context:i,painter:o,pixelRatio:s}=t,a=e.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,a.uniforms),...Q(t,e.target),antialiasingControls:be(s),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey)},defines:{...$(t)},optionalAttributes:a.optionalAttributes,useComputeBuffer:G(t)}),o.setPipelineState(tt(t)),o.submitDraw(t,e)}};class Ft extends yt{}n([y(3,w)],Ft.prototype,"color",void 0),n([y(4,w)],Ft.prototype,"outlineColor",void 0),n([y(5,f)],Ft.prototype,"offset",void 0),n([y(6,f)],Ft.prototype,"textureUV",void 0),n([y(7,w)],Ft.prototype,"sizing",void 0),n([y(8,r)],Ft.prototype,"placementAngle",void 0),n([y(9,r)],Ft.prototype,"sdfDecodeCoeff",void 0),n([y(10,f)],Ft.prototype,"zoomRange",void 0);class Ne extends Ae{}n([y(11,f)],Ne.prototype,"offsetNextVertex1",void 0),n([y(12,f)],Ne.prototype,"offsetNextVertex2",void 0),n([y(13,f)],Ne.prototype,"textureUVNextVertex1",void 0),n([y(14,f)],Ne.prototype,"textureUVNextVertex2",void 0);class Sa extends zt{}function Lt(t,e,i,o){return e.multiply(t.x).add(i.multiply(t.y)).add(o.multiply(t.z))}function Xi(t){return t.multiply(t).divide(128)}class Pt extends at{constructor(){super(...arguments),this.type="MarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,i){const o=Xi(e.sizing.x),s=Xi(e.sizing.y),a=Xi(e.sizing.z),l=e.placementAngle,u=q(e.bitset,Vt.bitset.isSDF),p=q(e.bitset,Vt.bitset.isMapAligned),c=q(e.bitset,Vt.bitset.scaleSymbolsProportionally),d=ne(e.bitset,Vt.bitset.colorLocked),m=me(this,e.id),v=de(this,e.id,e.color,d).multiply(m),g=this.view.displayViewScreenMat3.multiply(new _(e.pos.xy,1)),b=De(this,e.id,a).divide(a),x=o.multiply(b),S=e.offset.xy.multiply(b);let V=s.multiply(c.multiply(b.subtract(1)).add(1));V=qt(V,St(x.subtract(.99),new r(0)));const A=St(V,new r(1)),I=qt(V,new r(1)),L=E.fromRotation(l.multiply(Oi)),C=Eo(this,e.id),O=this._getViewRotationMatrix(p).multiply(C).multiply(L).multiply(new _(S.xy,0)),D=this.clip(e.id,e.zoomRange),T=new w(g.xy.add(O.xy),D,1),F=e.textureUV.divide(this.mosaicInfo.size),kt=e.outlineColor.multiply(I),se=q(e.bitset,Vt.bitset.overrideOutlineColor),ze=e.sdfDecodeCoeff.multiply(x);return{glPosition:T,color:v,textureUV:F,outlineColor:kt,outlineSize:A,distanceToPx:ze,isSDF:u,overrideOutlineColor:se,...this.maybeRunHittest(e,i,{pos:e.pos,size:x,sizeCorrection:b,isMapAligned:p,vvRotationMat3:C,placementMat3:L,outlineSize:A,distanceToPx:ze,isSDF:u})}}fragment(e){const i=this._getColor(e.textureUV,e);return this.getFragmentOutput(i,e)}hittest(e,i,o){return M(Ti(o.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,i,o),this._hittestMarker(e,i,o))}_getViewRotationMatrix(e){const i=this.view.displayViewMat3,o=this.view.displayMat3,s=new r(1).subtract(e);return i.multiply(e).add(o.multiply(s))}_getViewScreenMatrix(e){const i=this.view.viewMat3.multiply(this.view.tileMat3),o=this.view.tileMat3,s=new r(1).subtract(e);return i.multiply(e).add(o.multiply(s))}_getColor(e,i){return M(dt(i.isSDF,new r(1)),this._getSDFColor(e,i),this._getSpriteColor(e,i))}_getSpriteColor(e,i){return B(this.mosaicInfo.texture,e).multiply(i.color)}_getSDFColor(e,i){const o=B(this.mosaicInfo.texture,e),s=new r(.5).subtract(Ze(o)).multiply(i.distanceToPx).multiply(bo),a=mt(new r(.5).subtract(s),new r(0),new r(1)),l=i.color.multiply(a);let u=i.outlineSize;this.highlight&&(u=St(u,i.overrideOutlineColor.multiply(4)));const p=u.multiply(.5),c=Me(s).subtract(p),d=mt(new r(.5).subtract(c),new r(0),new r(1)),m=K(i.outlineColor,i.color,i.overrideOutlineColor).multiply(d);return new r(1).subtract(m.a).multiply(l).add(m)}_hittestSmallMarker(e,i,o){const{position:s,distance:a,smallSymbolDistance:l}=this.hittestRequest,u=a.subtract(l),{viewMat3:p,tileMat3:c}=this.view,d=p.multiply(c).multiply(new _(o.pos,1)).xy,m=o.size.multiply(.5);return $e(d,s).subtract(m).add(u)}_hittestMarker(e,i,o){const{pos:s,sizeCorrection:a,isMapAligned:l}=o,u=new _(e.offset.multiply(a),0),p=new _(i.offsetNextVertex1.multiply(a),0),c=new _(i.offsetNextVertex2.multiply(a),0),{viewMat3:d,tileMat3:m}=this.view,v=d.multiply(m).multiply(new _(s,1)),g=this._getViewScreenMatrix(l).multiply(o.vvRotationMat3).multiply(o.placementMat3),b=v.add(g.multiply(u)).xy,x=v.add(g.multiply(p)).xy,S=v.add(g.multiply(c)).xy,V=this.hittestRequest.position,A=this.hittestRequest.distance,I=oi(V,b,x,S);return M(U(I,A),I,this._hittestSamples(b,x,S,e,i,o))}_hittestSamples(e,i,o,s,a,l){const{outlineSize:u,isSDF:p,distanceToPx:c}=l,d=this.hittestRequest.position,m=this.hittestRequest.distance,v=Z(d.add(new f(J(m),J(m))),e,i,o),g=Z(d.add(new f(0,J(m))),e,i,o),b=Z(d.add(new f(m,J(m))),e,i,o),x=Z(d.add(new f(J(m),0)),e,i,o),S=Z(d,e,i,o),V=Z(d.add(new f(m,0)),e,i,o),A=Z(d.add(new f(J(m),m)),e,i,o),I=Z(d.add(new f(0,m)),e,i,o),L=Z(d.add(new f(m,m)),e,i,o),C=s.textureUV.divide(this.mosaicInfo.size),O=a.textureUVNextVertex1.divide(this.mosaicInfo.size),D=a.textureUVNextVertex2.divide(this.mosaicInfo.size),T={color:new w(1),outlineColor:new w(1),overrideOutlineColor:new r(1),outlineSize:u,distanceToPx:c,isSDF:p};let F=new r(0);return F=F.add(j(v).multiply(this._getColor(Lt(v,C,O,D),T).a)),F=F.add(j(g).multiply(this._getColor(Lt(g,C,O,D),T).a)),F=F.add(j(b).multiply(this._getColor(Lt(b,C,O,D),T).a)),F=F.add(j(x).multiply(this._getColor(Lt(x,C,O,D),T).a)),F=F.add(j(S).multiply(this._getColor(Lt(S,C,O,D),T).a)),F=F.add(j(V).multiply(this._getColor(Lt(V,C,O,D),T).a)),F=F.add(j(A).multiply(this._getColor(Lt(A,C,O,D),T).a)),F=F.add(j(I).multiply(this._getColor(Lt(I,C,O,D),T).a)),F=F.add(j(L).multiply(this._getColor(Lt(L,C,O,D),T).a)),k(F,new r(.05)).multiply(he(this.hittestRequest))}}n([R(Kt)],Pt.prototype,"visualVariableColor",void 0),n([R($t)],Pt.prototype,"visualVariableOpacity",void 0),n([R(ei)],Pt.prototype,"visualVariableRotation",void 0),n([R(pe)],Pt.prototype,"visualVariableSizeMinMaxValue",void 0),n([R(te)],Pt.prototype,"visualVariableSizeScaleStops",void 0),n([R(ee)],Pt.prototype,"visualVariableSizeStops",void 0),n([R(ce)],Pt.prototype,"visualVariableSizeUnitValue",void 0),n([h(vt)],Pt.prototype,"mosaicInfo",void 0),n([z(0,P(Ft)),z(1,P(Ne))],Pt.prototype,"vertex",null),n([z(0,P(Sa))],Pt.prototype,"fragment",null);let Va=class extends et{constructor(){super(...arguments),this.type=W.Marker,this.shaders={geometry:new Pt},this.symbologyPlane=ut.MARKER}render(t,e){const{context:i,painter:o}=t,s=e.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...it(t,e.target,s.uniforms),...Q(t,e.target),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey,!0)},defines:{...$(t)},optionalAttributes:s.optionalAttributes,useComputeBuffer:G(t)}),o.setPipelineState(tt(t)),o.submitDraw(t,e)}},za=class{constructor(){this.computeAttributes={}}get locationsMap(){const t=new Map;for(const e in this.locations)t.set(e,this.locations[e].index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set(Object.keys(this.options));this._optionPropertyKeys=t}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,e=Array.from(t.entries()).map(([o,s])=>`${o}.${s}`).join("."),i=Ds(e);this._locationInfo={hash:i,stringHash:e,locations:t,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const[e,i]of this.locationsMap.entries())t.set("a_"+e,i);return t}getShaderKey(t,e,i){return`${Object.keys(t).map(o=>`${o}.${t[o]}`).join(".")}.${Object.keys(i).filter(o=>i[o]).map(o=>`${o}_${i[o].toString()}`).join(".")}.${Object.keys(e).filter(o=>this.optionPropertyKeys.has(o)).join(".")}`}getProgram(t,e,i,o){let s="",a="";for(const l in i)if(i[l]){const u=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;s+=u,a+=u}return s+=this.vertexShader,a+=this.fragmentShader,new js(s,a,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(e),this._transformFeedbackBindings)}_getUniformBindings(t){const e=[];for(const i in this.required){const o=this.required[i];e.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:o.type,uniformArrayElementType:ns(o),uniformArrayLength:ls(o)})}for(const i in t){const o=this.options[i];if(t[i])for(const s in o){const a=o[s];e.push({uniformHydrated:null,shaderModulePath:`${i}.${s}`,uniformName:s,uniformType:a.type,uniformArrayElementType:ns(a),uniformArrayLength:ls(a)})}}return e}};const ns=t=>t.type==="array"?t.elementType?.type:void 0,ls=t=>t.type==="array"?t.size:void 0,Pa={hittestDist:r,hittestPos:f},Aa={filterFlags:N,animation:N,visualVariableData:N,dataDriven0:N,dataDriven1:N,dataDriven2:N,gpgpu:N,size:r},_a={displayViewScreenMat3:E,displayViewMat3:E,displayMat3:E,viewMat3:E,tileMat3:E,displayZoomFactor:r,requiredZoomFactor:r,tileOffset:f,currentScale:r,currentZoom:r,metersPerSRUnit:r};let Ta=class extends za{constructor(){super(...arguments),this.vertexShader=Do("materials/pie/pie.vert"),this.fragmentShader=Do("materials/pie/pie.frag"),this.required={...Aa,..._a,outlineWidth:r,colors:Y,defaultColor:w,othersColor:w,outlineColor:w,donutRatio:r,sectorThreshold:r},this.options={hittestUniforms:Pa,visualVariableSizeMinMaxValue:{minMaxValueAndSize:w},visualVariableSizeScaleStops:{sizes:{...Y.ofType(r,8),type:"array",elementType:r,size:8},values:{...Y.ofType(r,8),type:"array",elementType:r,size:8}},visualVariableSizeStops:{sizes:{...Y.ofType(r,8),type:"array",elementType:r,size:8},values:{...Y.ofType(r,8),type:"array",elementType:r,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:r},visualVariableOpacity:{opacities:{...Y.ofType(r,8),type:"array",elementType:r,size:8},opacityValues:{...Y.ofType(r,8),type:"array",elementType:r,size:8}},highlightUniforms:{highlightAll:r,activeReasons:r}},this.locations={pos:{index:0,type:f},id:{index:1,type:_},bitset:{index:2,type:r},offset:{index:3,type:f},texCoords:{index:4,type:f},size:{index:5,type:f},referenceSize:{index:6,type:r},zoomRange:{index:7,type:f}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(t){this.required.colors={...Y.ofType(w,t),type:"array",elementType:w,size:t}}},Ma=class extends et{constructor(){super(...arguments),this.type=W.PieChart,this.shaders={geometry:new Ta},this.symbologyPlane=ut.MARKER}render(t,e){const{painter:i}=t,{instance:o,target:s}=e,a=this.shaders.geometry,l=o.getInput(),u=l.uniforms.numberOfFields,p=G(t),c=Q(t,s),d=$(t);a.setNumberOfFields(u),i.setShader({shader:a,uniforms:{...it(t,e.target,l.uniforms.shader),...c.storage,...c.view,...c.highlight,highlightUniforms:c.highlight,hittestUniforms:c.hittestRequest?{hittestDist:c.hittestRequest?.distance,hittestPos:c.hittestRequest?.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!l.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!l.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!l.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!l.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!l.uniforms.shader.visualVariableOpacity,HITTEST:p,highlight:c.highlight?1:0,...d,numberOfFields:u},optionalAttributes:{},useComputeBuffer:p}),i.setPipelineState(tt(t)),i.submitDraw(t,e)}},Ra=class extends et{constructor(){super(...arguments),this.type=W.Text,this.shaders={geometry:new rt},this.symbologyPlane=ut.TEXT}render(t,e){const{context:i,painter:o}=t,s=$(t),a=e.instance.getInput(),l={shader:this.shaders.geometry,uniforms:{...it(t,e.target,a.uniforms),...Q(t,e.target),mosaicInfo:o.textureManager.getMosaicInfo(i,e.textureKey)},defines:{...s,isBackgroundPass:!0,isLabel:!1,textRenderPassType:nt.Color},optionalAttributes:a.optionalAttributes,useComputeBuffer:G(t)};o.setShader(l),o.setPipelineState(tt(t)),o.submitDraw(t,e),o.setShader({...l,defines:{...s,isBackgroundPass:!1,isLabel:!1,textRenderPassType:nt.Halo}}),o.submitDraw(t,e),o.setShader({...l,defines:{...s,isBackgroundPass:!1,isLabel:!1,textRenderPassType:nt.Outline}}),o.submitDraw(t,e),o.setShader({...l,defines:{...s,isBackgroundPass:!1,isLabel:!1,textRenderPassType:nt.Color}}),o.submitDraw(t,e)}};const X={fill:new ta,patternFill:new sa,complexFill:new Zr,gradientFill:new ia,outlineFill:new oa,patternOutlineFill:new ra,complexOutlineFill:new Jr,marker:new Va,pieChart:new Ma,line:new xa,texturedLine:new wa,gradientStroke:new ba,text:new Ra,label:new va,heatmap:new ca,dotDensity:new jr,animatedMarker:new Hr,animatedMarkerShift:new Nr,animatedFill:new Ur,animatedLine:new qr};function Ca(){for(const t in X)X[t].startup()}function Oa(t){for(const e in X)X[e].shutdown(t)}function vi(t,e){const i=t.slice(0,e),o=e-i.length;for(let s=0;s<o;s++){const a=i[i.length-1];i.push(a)}return i}function us(t){if(!t)return[0,0,0,0];const{r:e,g:i,b:o,a:s}=t;return[e*(s/255),i*(s/255),o*(s/255),s]}const gi=8,ps=gi-2,cs=()=>oo.getLogger("esri.views.2d.layers.features.support.rendererUtils");function ds(t){return t.map(e=>Da(e)?Ia(e.clone()):e)}function Da(t){return(t.type==="size"||t.type==="color"||t.type==="opacity")&&t.stops!=null}function Ia(t){return t.stops=Ea(t.type,t.stops??[]),t}function Ve(t,e,i){return(1-i)*t+i*e}function Fa(t,e){const[i,...o]=e,s=o.pop(),a=o[0].value,l=o[o.length-1].value,u=(l-a)/ps,p=[];for(let c=a;c<l;c+=u){let d=0;for(;c>=o[d].value;)d++;const m=o[d],v=e[d-1],g=c-v.value,b=m.value===v.value?1:g/(m.value-v.value);if(t==="color"){const x=o[d],S=e[d-1],V=x.color.clone();V.r=Ve(S.color.r,V.r,b),V.g=Ve(S.color.g,V.g,b),V.b=Ve(S.color.b,V.b,b),V.a=Ve(S.color.a,V.a,b),p.push({value:c,color:V,label:x.label})}else if(t==="size"){const x=o[d],S=e[d-1],V=so(x.size),A=Ve(so(S.size),V,b);p.push({value:c,size:A,label:x.label})}else{const x=o[d],S=Ve(e[d-1].opacity,x.opacity,b);p.push({value:c,opacity:S,label:x.label})}}return[i,...p,s]}function La(t){const[e,...i]=t,o=i.pop();for(;i.length>ps;){let s=0,a=0;for(let l=1;l<i.length;l++){const u=i[l-1],p=i[l],c=Math.abs(p.value-u.value);c>a&&(a=c,s=l)}i.splice(s,1)}return[e,...i,o]}function Ea(t,e){return e.length<=gi?e:(cs().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${gi}. Displayed stops will be simplified.`),e.length>2*gi?Fa(t,e):La(e))}function ka(){const{supportsColorBufferFloat:t,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:i}=Je();return t&&e||i}function Ba(t){if(!t)return!0;switch(t.type){case"dot-density":break;case"heatmap":if(!ka()){const e=Je(),i=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(o=>!e[o]).join(", ");return cs().errorOnce(new qe("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${i}`)),!1}}return!0}const Ha=1.25,bi=128,Na=128;function Ua(t){if(!t.stops?.length)return null;const e=t.stops.sort((a,l)=>a.value-l.value),i=vi(e,8),o=i.map(({value:a})=>a),s=i.map(({color:a})=>us(a));return{values:o,colors:s}}function qa(t){if(!t.stops?.length)return null;const e=t.stops.sort((o,s)=>o.value-s.value),i=vi(e,8);return{opacityValues:i.map(({value:o})=>o),opacities:i.map(({opacity:o})=>o)}}function Ga(t){return{rotationType:t.rotationType==="geographic"?Ci.Geographic:Ci.Arithmatic}}function Yi(t){if(!t.stops?.length)return null;if(t.stops.some(o=>o.useMaxValue||o.useMinValue))return(o,s)=>{const a=o.statisticsByLevel.get(s.key.level),l=t.stops.map(p=>({value:p.useMaxValue?a?.get(t.field)?.maxValue??0:p.useMinValue?a?.get(t.field)?.minValue??0:p.value,size:p.size?Xt(p.size):tr})).sort((p,c)=>p.value-c.value),u=vi(l,8);return{values:u.map(({value:p})=>p),sizes:u.map(({size:p})=>p)}};const e=t.stops.sort((o,s)=>o.value-s.value),i=vi(e,8);return{values:i.map(({value:o})=>o),sizes:i.map(({size:o})=>Xt(o))}}function Wa(t){return e=>{const{state:i}=e;return{unitValueToPixelsRatio:Is(i.spatialReference)/_r[t.valueUnit??"meters"]/i.resolution}}}function ms(t,e){const i=e.length;if(t<e[0].value||i===1)return e[0].size;for(let o=1;o<i;o++)if(t<e[o].value){const s=(t-e[o-1].value)/(e[o].value-e[o-1].value);return e[o-1].size+s*(e[o].size-e[o-1].size)}return e[i-1].size}function Ka(t){const{minDataValue:e,maxDataValue:i,minSize:o,maxSize:s}=t;if(typeof o=="object"&&typeof s=="object")return(a,l)=>{const u=a.state.scale,p=Xt(ms(u,o.stops)),c=Xt(ms(u,s.stops));return{minMaxValueAndSize:[e,i,p,c]}};if(typeof o=="object"||typeof s=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,i,Xt(o),Xt(s)]}}const Et={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function Qi(t,e=Na,i=Ha){if(t.visualVariableSizeMinMaxValue)return typeof t.visualVariableSizeMinMaxValue=="function"?bi:Math.max(t.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*i,e);if(t.visualVariableSizeScaleStops){if(typeof t.visualVariableSizeScaleStops=="function")return bi;const o=t.visualVariableSizeScaleStops.sizes;return Math.max(o[o.length-1]*i,e)}if(t.visualVariableSizeStops){if(typeof t.visualVariableSizeStops=="function")return bi;const o=t.visualVariableSizeStops.sizes;return Math.max(o[o.length-1]*i,e)}return t.visualVariableSizeUnitValue?2*bi:0}function $a(t){const e={...Et};if(!t||!("visualVariables"in t)||!t.visualVariables)return e;for(const i of ds(t.visualVariables))switch(i.type){case"color":e.visualVariableColor=Ua(i);break;case"opacity":e.visualVariableOpacity=qa(i);break;case"rotation":e.visualVariableRotation=Ga(i);break;case"size":switch(ja(i)){case"field-stops":e.visualVariableSizeStops=Yi(i);break;case"scale-stops":i.target==="outline"?e.visualVariableSizeOutlineScaleStops=Yi(i):e.visualVariableSizeScaleStops=Yi(i);break;case"min-max":e.visualVariableSizeMinMaxValue=Ka(i);break;case"unit-value":e.visualVariableSizeUnitValue=Wa(i)}break}return e}function ja(t){return typeof t.minDataValue=="number"&&typeof t.maxDataValue=="number"&&t.minSize!=null&&t.maxSize!=null?"min-max":t?.valueExpression==="$view.scale"&&Array.isArray(t.stops)?"scale-stops":t.field==null&&t?.valueExpression==="$view.scale"||!(Array.isArray(t.stops)||"levels"in t&&t.levels)?t.field!=null||t?.valueExpression!=="$view.scale"?"unit-value":null:"field-stops"}function hs(t){return!!(t.visualVariableSizeMinMaxValue||t.visualVariableSizeScaleStops||t.visualVariableSizeStops||t.visualVariableSizeUnitValue||t.visualVariableSizeOutlineScaleStops)}function Za(t){return!!t.visualVariableRotation}function ys(t){return t.spriteRasterizationParam?t.spriteRasterizationParam:{type:"sprite-rasterization-param",resource:{type:"CIMPictureMarker",url:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAJOgAACToAYJjBRwAAAAsSURBVEhL7c0xAQAwDASh+jf9lcCU7TDA27ECKqACKqACKqACKqACKqDjYPuLVfSmMPfafQAAAABJRU5ErkJggg==",size:16,invertBackfaceTexture:!1,scaleX:1,textureFilter:Rs.Picture},overrides:[]}}function fs(t){return t.minScale||t.maxScale?{minScale:t.minScale??0,maxScale:t.maxScale??0}:null}function lt(t){if(t==null)return null;if(Array.isArray(t)){const[e,i,o,s]=t;return[e,i,o,255*s]}return typeof t=="string"?t:{...t,defaultValue:lt(t?.defaultValue)}}async function Xa(t,e){const{cimResourceManager:i,cimAnalyzer:o,scaleExpression:s}=e.schemaOptions;await Promise.all(Ts.fetchResources(t.symbol,i,[]));const a=o.analyzeSymbolReference(t,!1),l={scaleInfo:fs(t),scaleExpression:s},u=[];for(const p of a)switch(p.type){case"marker":u.push(...Ya(p,e,l));break;case"fill":u.push(...tn(p,e,l));break;case"outlineFill":u.push(...Ja(p,e,l));break;case"gradientFill":u.push(...en(p,e,l));break;case"line":u.push(...on(p,e,l));break;case"gradientStroke":u.push(...sn(p,e,l));break;case"text":u.push(...rn(p,e,l))}return u}function Ya(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:a}=s,l=t.isOutline?{...Et,visualVariableSizeScaleStops:o.visualVariableSizeOutlineScaleStops}:{visualVariableColor:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue,visualVariableRotation:o.visualVariableRotation};if(t.animationParams){const{hasShiftAnimation:u}=t.animationParams.params,p=u?X.animatedMarkerShift:X.animatedMarker;return vs(a.ensureInstance(p,{uniforms:l,optionalAttributes:{zoomRange:!0,value1Position2Value2:t.animationParams.params.hasShiftAnimation,lineLength:u}}),t,Et,i)}return gs(a.ensureInstance(X.marker,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,o,i)}function vs(t,e,i,o){return e.animationParams?[t.createMeshInfo({pixelDimensions:e.pixelDimensions,texelDimensions:e.texelDimensions,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,sprite:ys(e),animations:e.animationParams,scaleInfo:o.scaleInfo,scaleSymbolsProportionally:e.scaleSymbolsProportionally,strokeWidth:e.outlineWidth,isMapAligned:e.alignment===Cs.MAP,colorLocked:e.colorLocked,isStroke:e.isStroke,baseSize:e.baseSize,placement:e.markerPlacement,referenceSize:e.referenceSize,angleToLine:!!e.markerPlacement&&e.markerPlacement.placement&&"angleToLine"in e.markerPlacement.placement&&e.markerPlacement.placement.angleToLine,sizeRatio:e.sizeRatio,patternHeight:null})]:[]}function xi(t,e,i,o){return e.animationParams?[t.createMeshInfo({effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,sprite:ys(e),animations:e.animationParams,scaleInfo:o.scaleInfo,scaleSymbolsProportionally:!1,strokeWidth:1,isMapAligned:!0,colorLocked:e.colorLocked||!1,isStroke:!1,baseSize:"width"in e?e.width:-1,placement:null,referenceSize:2,angleToLine:!1,sizeRatio:1,patternHeight:e.type==="fill"&&e.spriteRasterizationParam?e.height:null,joinType:"join"in e?e.join:"round",capType:"cap"in e?e.cap:"round",miterLimit:"miterLimit"in e&&e.miterLimit||2})]:[]}function gs(t,e,i,{scaleInfo:o,scaleExpression:s}){const a=hs(i);return[t.createMeshInfo({size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:lt(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:o,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:lt(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||Ms.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:s??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:a,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:Qi(i)})]}function Qa(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:a}=s,l={visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity};if(t.animationParams){const u=X.animatedFill;return xi(a.ensureInstance(u,{uniforms:{...l,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),t,Et,i)}return xs(a.ensureInstance(X.fill,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,i)}function Ja(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:a}=s;return bs(a.ensureInstance(X.outlineFill,{uniforms:{visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableSizeMinMaxValue:null,visualVariableSizeScaleStops:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,i)}function bs(t,e,i){const o=lt(e.color)??[0,0,0,0],s=lt(e.outlineColor)??[0,0,0,0];return[t.createMeshInfo({color:o,outlineColor:s,width:e.outlineWidth,referenceWidth:e.referenceWidth,capType:e.cap,joinType:e.join,miterLimit:e.miterLimit,outlineUsesColorVV:!e.outlineColorLocked,hasSizeVV:!1,scaleInfo:i.scaleInfo,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,outlineEffects:e.outlineEffects?{type:"cim-effect-infos",effectInfos:e.outlineEffects}:null})]}function xs(t,e,{scaleInfo:i}){return[t.createMeshInfo({color:lt(e.color)??[0,0,0,0],scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function tn(t,e,i){if(!t.spriteRasterizationParam)return Qa(t,e,i);const{uniforms:o,schemaOptions:s}=e,{store:a}=s,l={visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity};if(t.animationParams){const u=X.animatedFill;return xi(a.ensureInstance(u,{uniforms:{...l,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null,visualVariableSizeScaleStops:null,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,lineLength:!1}}),t,Et,i)}return ws(a.ensureInstance(X.complexFill,{uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,o.visualVariableColor!=null,i)}function ws(t,e,i,{scaleInfo:o}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const s=!!e.hasUnresolvedReplacementColor&&(!i||e.colorLocked),a=e.sampleAlphaOnly&&!s,l=e.spriteRasterizationParam;return[t.createMeshInfo({color:lt(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:a,scaleProportionally:l.resource.type==="CIMHatchFill",sprite:l,scaleInfo:o,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function en(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:a}=s;return Ss(a.ensureInstance(X.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:o.visualVariableOpacity},optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,i)}function Ss(t,e,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=e.spriteRasterizationParam;return[t.createMeshInfo({color:lt(e.color)??[0,0,0,0],angle:e.angle,gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:o,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function on(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:a}=s,l=t.isOutline?{...Et,visualVariableSizeScaleStops:o.visualVariableSizeOutlineScaleStops}:{visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue};if(t.animationParams){const{hasShiftAnimation:c}=t.animationParams.params,d=X.animatedLine;return xi(a.ensureInstance(d,{uniforms:{...l,visualVariableRotation:null},optionalAttributes:{zoomRange:!0,value1Position2Value2:!1,accumulatedDistance:!0,segmentDirection:!0,normal:!0,lineLength:c}}),t,Et,i)}const u={uniforms:l,optionalAttributes:{zoomRange:!!i.scaleInfo}},p=!!(l.visualVariableSizeMinMaxValue||l.visualVariableSizeScaleStops||l.visualVariableSizeStops||l.visualVariableSizeUnitValue);return t.spriteRasterizationParam?zs(a.ensureInstance(X.texturedLine,u),t,p,i):Vs(a.ensureInstance(X.line,u),t,p,i)}function Ji(t,e,{scaleInfo:i}){return{color:lt(t.color)??[0,0,0,0],width:t.width,referenceWidth:t.referenceWidth,capType:t.cap,joinType:t.join,miterLimit:t.miterLimit,scaleInfo:i,hasSizeVV:e,effects:t.effects?{type:"cim-effect-infos",effectInfos:t.effects}:null}}function Vs(t,e,i,o){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const s=Ji(e,i,o);return[t.createMeshInfo(s)]}function zs(t,e,i,o){const{spriteRasterizationParam:s,scaleDash:a,sampleAlphaOnly:l}=e;if(!s)throw new Error("InternalError: Sprite should be defined");return[t.createMeshInfo({...Ji(e,i,o),offsetAlongLine:e.offsetAlongLine??0,shouldScaleDash:a??!1,shouldSampleAlphaOnly:l,isSDF:s.resource.type!=="CIMPictureStroke"&&s.resource.type!=="CIMGradientStroke",sprite:s})]}function sn(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:a}=s;return Ps(a.ensureInstance(X.gradientStroke,{uniforms:t.isOutline?{...Et,visualVariableSizeScaleStops:o.visualVariableSizeOutlineScaleStops}:{visualVariableColor:null,visualVariableOpacity:o.visualVariableOpacity,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo}}),t,i)}function Ps(t,e,i){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=e.spriteRasterizationParam;return[t.createMeshInfo({...Ji(e,!1,i),gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:o,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function rn(t,e,i){const{uniforms:o,schemaOptions:s}=e,{store:a}=s;return As(a.ensureInstance(X.text,{uniforms:{visualVariableColor:t.colorLocked?null:o.visualVariableColor,visualVariableOpacity:o.visualVariableOpacity,visualVariableRotation:o.visualVariableRotation,visualVariableSizeMinMaxValue:o.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:o.visualVariableSizeScaleStops,visualVariableSizeStops:o.visualVariableSizeStops,visualVariableSizeUnitValue:o.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!i.scaleInfo,referenceSymbol:!1,clipAngle:!1,visibility:!1}}),t,o,i)}function As(t,e,i,{scaleInfo:o,scaleExpression:s}){return[t.createMeshInfo({boxBackgroundColor:lt(e.backgroundColor),boxBorderLineColor:lt(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:lt(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:lt(e.haloColor)??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:lt(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:o,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:s??1,minPixelBuffer:Qi(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,labelClassId:-1})]}function an(t,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:Je().maxTextureSize},bindings:Si(t)}}function nn(t,e){const i=Je();return{type:"multi",target:"feature",keyField:Tr,filters:e,capabilities:{maxTextureSize:i.maxTextureSize},bindings:{[Ii.TrackLine]:Si(t.trackLines.renderer),[Ii.LatestObservation]:Si(t.latestObservations.renderer),[Ii.PreviousObservation]:Si(t.previousObservations.renderer)}}}function wi(t){switch(t){case"opacity":return Ue.OPACITY;case"color":return Ue.COLOR;case"rotation":return Ue.ROTATION;case"size":return Ue.SIZE;default:return null}}function Si(t){if(!t)return[];switch(t.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return to(t);case"dot-density":return ln(t);case"pie-chart":return un(t);case"heatmap":return pn(t)}}function ln(t){const e=[];for(const i of t.attributes)e.push({binding:e.length,expression:i.valueExpression,field:i.field});return e}function un(t){const e=to(t);let i=4;for(const o of t.attributes)e.push({binding:i++,expression:o.valueExpression,field:o.field});return e}function pn({valueExpression:t,field:e}){return t||e?[{binding:0,expression:t,field:e}]:[]}function to(t){return!("visualVariables"in t)||!t.visualVariables?.length?[]:ds(t.visualVariables).map(e=>yn(e)).filter(Fs)}function cn(t){return t.valueExpression==="$view.scale"?null:{binding:wi(t.type),field:t.field,normalizationField:t.normalizationField,expression:t.valueExpression,valueRepresentation:t.valueRepresentation}}function dn(t){return{binding:wi(t.type),field:t.field,normalizationField:t.normalizationField,expression:t.valueExpression}}function mn(t){return{binding:wi(t.type),field:t.field,normalizationField:t.normalizationField,expression:t.valueExpression}}function hn(t){return{binding:wi(t.type),expression:t.valueExpression,field:t.field}}function yn(t){switch(t.type){case"size":return cn(t);case"color":return dn(t);case"opacity":return mn(t);case"rotation":return hn(t)}}class fn{constructor(){this.type="override-batch",this.messages=[],this._resovler=Es()}get promise(){return this._resovler.promise}resolve(){this._resovler.resolve()}add(e){this.messages.push(e)}}class vn{constructor(e){this.updateTracking=new Xs({debugName:"FeatureCommandQueue"}),this.process=e.process,this._queueProcessor=new Mr({concurrency:1,process:async i=>{if(i.type==="override-batch"){const o=this._nextOverrideBatch;if(o==null)throw new Error("InternalError: Override should be defined");return this._nextOverrideBatch=null,await this.process(o),void o.resolve()}return this.process(i)}})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return Ls(this.updateTracking.addPromise(this._doPush(e)))}async _doPush(e){const i=this._queueProcessor,o=i.last();switch(e.type){case"update":case"highlight":return o?.type===e.type?void 0:i.push(e);case"override":case"edit":return this._pushOverride(e)}}_pushOverride(e){return this._nextOverrideBatch==null&&(this._nextOverrideBatch=new fn,this._queueProcessor.push(this._nextOverrideBatch)),this._nextOverrideBatch.add(e),this._nextOverrideBatch.promise}}export{Ps as C,X as F,As as L,Vs as P,zs as R,gs as S,Et as a,vn as b,an as c,ws as d,hs as e,Za as f,Ss as g,xs as h,nn as i,Ba as j,to as k,ti as l,vs as m,Fo as n,Io as o,xi as p,Ca as q,Oa as r,fs as s,us as t,Xa as u,Qi as x,$a as y,bs as z};
