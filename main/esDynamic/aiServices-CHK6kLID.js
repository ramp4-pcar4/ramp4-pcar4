import{Z as j,_ as a,X as i,Y as k,H as K,s as B,i as F,eU as C,eW as O,M as I,ba as R}from"./main-6gYsRPh_.js";import"./UnknownTimeZone-Cg6zjlbh.js";import{o as Y,t as N,Y as U,p as b}from"./Dictionary-BlU901XL.js";import{t as Z}from"./commonProperties-D1Pjvz5u.js";import{r as $}from"./arcadeEnvironment-3XxdG5as.js";import{n as T}from"./enum-BVcvu-V3.js";import{a as D,f as E,s as H}from"./utils-hE7D5uZL.js";let g=class extends j{constructor(o){super(o),this.text=null,this.detectedLanguage="en",this.detectedLanguageScore=-1}};a([i({type:String,json:{write:!0}})],g.prototype,"key",void 0),a([i({type:String,json:{write:!0}})],g.prototype,"text",void 0),a([i({type:String,json:{read:{source:"detectedLanguage.language"},write:{target:"detectedLanguage.language"}}})],g.prototype,"detectedLanguage",void 0),a([i({type:Number,json:{read:{source:"detectedLanguage.score"},write:{target:"detectedLanguage.score"}}})],g.prototype,"detectedLanguageScore",void 0),a([i({type:Object,json:{write:!0}})],g.prototype,"translation",void 0),g=a([k("esri.rest.support.TranslateResult")],g);async function W(o,n,s){const t=n.toJSON();t.contents=JSON.stringify(t.contents),t.token=await D(n.portalUrl,n.apiKey,{signal:s?.signal,prompt:s?.authMode!=="no-prompt"});const r=E(o),e=H(r.query,{...s,query:t,method:"post",authMode:"anonymous"});return(await K(r.path,e)).data.results.map(l=>g.fromJSON(l))}let S=class extends j{constructor(o){super(o)}};a([i({type:String,json:{write:!0}})],S.prototype,"key",void 0),a([i({type:String,json:{write:!0}})],S.prototype,"text",void 0),S=a([k("esri.rest.support.TranslateContent")],S);let p=class extends j{constructor(o){super(o),this.to=null,this.contents=null,this.portalUrl="https://www.arcgis.com",this.translator="esri",this.from=null,this.apiKey=null,this.requestSource=null}};a([i({type:[String],json:{write:!0}})],p.prototype,"to",void 0),a([i({type:[S],json:{write:!0}})],p.prototype,"contents",void 0),a([i({type:String,json:{write:!0}})],p.prototype,"portalUrl",void 0),a([i({type:String,json:{write:!0,default:"esri"}})],p.prototype,"translator",void 0),a([i({type:String,json:{write:!0}})],p.prototype,"from",void 0),a([i(Z)],p.prototype,"apiKey",void 0),a([i({type:String,json:{name:"x-esri-request-source"}})],p.prototype,"requestSource",void 0),p=a([k("esri.rest.support.TranslateParameters")],p);class z{constructor(n,s){this.portal=n,this._debugLog=s}async translate(n){this.portal.loaded||await this.portal.load();const s=this.portal.helperServices?.aiUtilityServices;if(s==null)return{success:!1};const t=s.url+s.translateUtility;try{return n.requestSource??="arcade",{success:!0,results:(await W(t,n,{authMode:"no-prompt"})).map(r=>r.toJSON())}}catch(r){return this._debugLog!=null&&(r instanceof Error||r instanceof B)&&this._debugLog(`TranslateText error: ${r.message}`),F.getLogger("esri.arcade.functions.aiServices").error(r),{success:!1}}}}class X{constructor(n,s,t){this._parameters=n,this._maxTotalContentSize=s,this._maxContentsLength=t,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(n){const s=new Set(n.filter(e=>!this._normalizedContents.has(e.text)).map(e=>e.text));if(this._requests.length+s.size>this._maxContentsLength)return null;let t=0;for(const e of s)t+=e.length;if((t+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;const r=this._requests.length;for(const{key:e,text:l}of n)R(this._normalizedContents,l,()=>[]).push({batchIdx:r,key:e});return this._requests.push(n),this._contentsTotalSize+=t,r}async send(n){const s=[],t=[];let r=0;for(const[y,f]of this._normalizedContents)s.push(new S({key:String(r++),text:y})),t.push(f);const e=new p(this._parameters);e.contents=s;const l=await n.translate(e);if(!l.success)return Array.from(this._requests,()=>l);const x=Array.from(this._requests,()=>({success:!0,results:[]}));for(const y of l.results){const f=Number(y.key);for(const h of t[f])x[h.batchIdx].results.push({...y,key:h.key})}return x}}function L(o){const n=[...new Set(o.to)].sort(),s=o.from??null,t=o.portalUrl,r=o.translator,e=o.apiKey??null;return JSON.stringify([n,s,t,r,e])}async function P(o,n,s){try{return(await o.yieldFor(s))[n]}catch{return{success:!1}}}class M{constructor(n,s,{maxTotalContentSize:t=5e4,maxContentsLength:r=1e3}={}){this._executor=n,this._service=s,this._openBatches=new Map,this._maxTotalContentSize=t,this._maxContentsLength=r}create(n){return{translate:async s=>{const t=L(s),{contents:r,to:e,from:l,translator:x,portalUrl:y,apiKey:f}=s;if(e==null)return{success:!1};if(r==null||r.every(u=>u.text.length===0))return{success:!1};const h=this._openBatches.get(t);if(h!=null){const u=h.data.tryAdd(r);if(u!=null)return await P(n,u,h);h.send()}const d=new X({to:e,from:l,translator:x,portalUrl:y,apiKey:f},this._maxTotalContentSize,this._maxContentsLength),v=d.tryAdd(r);if(v!=null){const u=this._executor.openBatch(d,{open:w=>{this._openBatches.set(t,w)},execute:w=>w.send(this._service),close:w=>{this._openBatches.get(t)===w&&this._openBatches.delete(t)}});return await P(n,v,u)}return await this._service.translate(s)}}}}function A(o){o.mode==="async"&&(o.functions[$("TranslateText")]=function(n,s){return o.standardFunctionAsync(n,s,async(t,r,e)=>{if(Y(e,2,3,t,r),!C(e[0])&&!O(e[0])&&!N(e[0]))throw new T(t,"InvalidParameter",r);const l=U(e[0]);if(!C(e[1])&&!O(e[1])&&!N(e[1]))throw new T(t,"InvalidParameter",r);const x=U(e[1]);let y=null;if(e.length>=3){if(!C(e[2]))throw new T(t,"InvalidParameter",r);y=e[2]}const f=l.map((m,c)=>new S({key:String(c),text:m})),h=t.services?.portal??I.getDefault(),d=new p({to:x,contents:f,from:y,portalUrl:h.restUrl.replace(/\/sharing\/rest$/,"")}),v=new Map;let u=null;if(t.lrucache!=null){const m=t.lrucache;u??=L(d),d.contents=d.contents?.filter(c=>{const _=m.getCachedTranslation(u,c.text);return _==null||(v.set(c.key,{..._,key:c.key,text:c.text}),!1)})}if(d.contents?.length){const m=t.services?.translation??new z(h,t.console),c=await m.translate(d);if(!c.success)return new b({__proto__:null,success:!1});for(const _ of c.results){const q=d.contents?.find(J=>J.key===_.key)?.text;if(q==null)throw new T(null,"NeverReach",null);v.set(_.key,_),t.lrucache!=null&&(u??=L(d),t.lrucache.setCachedTranslation(u,q,{detectedLanguage:_.detectedLanguage,translation:_.translation}))}}const w=Array.from(f,m=>{const c=g.fromJSON(v.get(m.key));if(c==null)throw new T(null,"NeverReach",null);return c.text=m.text,b.convertJsonToArcade(c.toJSON(),t.timeZone??"system",!0)});return new b({__proto__:null,success:!0,results:w})})})}const G=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:M,PortalTranslationService:z,getTranslateParametersKey:L,registerFunctions:A},Symbol.toStringTag,{value:"Module"})),Q=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:M,PortalTranslationService:z,getTranslateParametersKey:L,registerFunctions:A},Symbol.toStringTag,{value:"Module"}));export{G as T,Q as a};
