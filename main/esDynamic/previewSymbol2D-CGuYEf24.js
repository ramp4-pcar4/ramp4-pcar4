import{s as W,bS as x,bh as P,ev as C}from"./main-CnDVnExo.js";import{L as E}from"./colorUtils-CkvUfuuJ.js";import{c as H}from"./fontUtils-XpKzDP9F.js";import{U as I,k as U}from"./quantizationUtils-B2004thd.js";import{u as j,y as A,g as G,f as J}from"./utils-m8U_TYuN.js";import{t as $,e as K,d as D,l as Q}from"./symbolUtils-GPZ1zOMO.js";const F="picture-fill",X="picture-marker",Y="simple-fill",_="simple-line",tt="simple-marker",et="text",at="Aa",it=$.size,z=$.maxSize,nt=$.maxOutlineSize,Z=$.lineWidth,T=225,ot=document.createElement("canvas");function O(e,t,s){if(e.type==="polygon"){const i=e.extent,u=i.width===0?1:i.width,r=i.height===0?1:i.height;e=I({originPosition:"upperLeft",scale:[u/t,r/s],translate:[i.xmin,i.ymax]},{},e);let c="";for(let l=0;l<e.rings.length;l++){const n=e.rings[l];for(let h=0;h<n.length;h++){const p=n[h][0],d=n[h][1];let a="";h===0?(a=`M${p.toString()} ${d.toString()}`,c!==""&&(a=` ${a}`),c+=a):h===n.length-1?(a=`l${p.toString()} ${d.toString()} Z`,c!==""&&(a=` ${a}`),c+=a):(a=`l${p.toString()} ${d.toString()}`,c!==""&&(a=` ${a}`),c+=a)}}return c}if(e.type==="polyline"){const i=e.extent,u=i.width===0?1:i.width,r=i.height===0?1:i.height;e=U({originPosition:"upperLeft",scale:[u/t,r/s],translate:[i.xmin,i.ymax]},{},e);let c="";for(let l=0;l<e.paths.length;l++){const n=e.paths[l];for(let h=0;h<n.length;h++){const p=n[h][0],d=n[h][1];let a="";h===0?(a=`M${p.toString()} ${d.toString()}`,c!==""&&(a=` ${a}`),c+=a):(a=`l${p.toString()} ${d.toString()}`,c!==""&&(a=` ${a}`),c+=a)}}return c}return""}function R(e,t){const s=ot.getContext("2d"),i=[];t&&(t.weight&&i.push(t.weight),t.size&&i.push(t.size+"px"),t.family&&i.push(t.family)),s.font=i.join(" ");const{width:u,actualBoundingBoxLeft:r,actualBoundingBoxRight:c,actualBoundingBoxAscent:l,actualBoundingBoxDescent:n}=s.measureText(e);return{width:Math.ceil(Math.max(u,r+c)),height:Math.ceil(l+n),x:Math.floor(r),y:Math.floor((l-n)/2)}}function k(e){const t=e?.size;return{width:t!=null&&typeof t=="object"&&"width"in t?x(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?x(t.height):null}}async function lt(e,t){const s=t.fill,i=e.color;if(s?.type==="pattern"&&i&&e.type!==F){const u=await J(s.src,i.toCss(!0));s.src=u,t.fill=s}}async function st(e,t,s,i){if(!("font"in e)||!e.font||t.shape.type!=="text")return;try{await H(e.font)}catch{}const{width:u,height:r}=k(i);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:c,height:l,x:n,y:h}=R(t.shape.text,{weight:t.font?.weight,size:t.font?.size,family:t.font?.family});s[0]=u??c,s[1]=r??l,t.shape.x=n,t.shape.y=h;let p="angle"in e?e.angle:null;if(i?.rotation!=null&&(p=(p??0)+i.rotation),p){const d=p*(Math.PI/180),a=Math.abs(Math.sin(d)),o=Math.abs(Math.cos(d));s[1]=s[0]*a+s[1]*o}}}function rt(e,t,s,i,u){if(e.haloColor!=null&&e.haloSize!=null){u.masking??=s.map(()=>[]);const r=x(e.haloSize);i[0]+=r,i[1]+=r,s.unshift([{...t,fill:null,stroke:{color:e.haloColor,width:2*r,join:"round",cap:"round"}}]),u.masking.unshift([{shape:{type:"rect",x:0,y:0,width:i[0]+2*C,height:i[1]+2*C},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}e.backgroundColor==null&&e.borderLineColor==null||(i[0]+=2*C,i[1]+=2*C,s.unshift([{shape:{type:"rect",x:0,y:0,width:i[0],height:i[1]},fill:e.backgroundColor,stroke:{color:e.borderLineColor,width:x(e.borderLineSize)}}]),u.masking?.unshift([]))}function q(e,t){return e>t?"dark":"light"}function N(e,t){const s=typeof t?.size=="number"?t?.size:null,i=s!=null?x(s):null,u=t?.maxSize!=null?x(t.maxSize):null;let r="angle"in e?e.angle:null;t?.rotation!=null&&(r=(r??0)+t.rotation);const c=j(e);let l=A(e);V(e,245)!=="dark"||t?.ignoreWhiteSymbols||(l={width:.75,...l,color:"#bdc3c7"});let n=null;const h={shape:null,fill:c,stroke:l,offset:[0,0]};l?.width&&(l.width=Math.min(l.width,nt));const p=l?.width||0;let d=t?.size!=null&&(t?.scale==null||t?.scale),a=0,o=0,S=!1;switch(e.type){case tt:{const f=e.style,{width:g,height:m}=k(t);let b=g===m&&g!=null?g:i??Math.min(x(e.size),u||z);if(t?.useMarkerSymbolSize===!0&&g!==null&&m!==null){const y=Math.min(x(e.size),u||z);b=y>g&&y>m?Math.min(g,m):y}switch(a=b,o=b,f){case"circle":h.shape={type:"circle",cx:0,cy:0,r:.5*b},d||(a+=p,o+=p);break;case"cross":h.shape={type:"path",path:[{command:"M",values:[0,.5*o]},{command:"L",values:[a,.5*o]},{command:"M",values:[.5*a,0]},{command:"L",values:[.5*a,o]}]};break;case"diamond":h.shape={type:"path",path:[{command:"M",values:[0,.5*o]},{command:"L",values:[.5*a,0]},{command:"L",values:[a,.5*o]},{command:"L",values:[.5*a,o]},{command:"Z",values:[]}]},d||(a+=p,o+=p);break;case"square":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,0]},{command:"L",values:[a,o]},{command:"L",values:[0,o]},{command:"Z",values:[]}]},d||(a+=p,o+=p),r&&(S=!0);break;case"triangle":h.shape={type:"path",path:[{command:"M",values:[.5*a,0]},{command:"L",values:[a,o]},{command:"L",values:[0,o]},{command:"Z",values:[]}]},d||(a+=p,o+=p),r&&(S=!0);break;case"x":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,o]},{command:"M",values:[a,0]},{command:"L",values:[0,o]}]},r&&(S=!0);break;case"path":h.shape={type:"path",path:e.path||""},d||(a+=p,o+=p),r&&(S=!0),d=!0}break}case _:{const{width:f,height:g}=k(t),m=G(l).reduce((v,M)=>v+M,0),b=m&&Math.ceil(Z/m),y=g??i??p,w=f??(m*b||Z);if(d=!0,t?.geometry?.type==="polyline"&&t?.geometry?.extent){a=w,o=g??a;const v=1e3,M=.15*v;n=[a,o],o=n[0]>n[1]?v*n[1]/n[0]:v,a=n[0]>n[1]?v:v*n[0]/n[1],l?.width&&(l.width=l.width*v/(n[1]>n[0]?n[1]:n[0]),l.width>M&&(l.width=M)),h.shape={type:"path",path:O(t.geometry,a,o)}}else a=t?.maxSize!=null?Math.min(w,t.maxSize):w,o=y,l&&(l.width=y),h.shape={type:"path",path:[{command:"M",values:[y/2,o/2]},{command:"L",values:[a-y/2,o/2]}]};break}case F:case Y:{const f=typeof t?.symbolConfig=="object"&&!!t?.symbolConfig?.isSquareFill,{width:g,height:m}=k(t);a=!f&&g!==m||g==null?i??it:g,o=!f&&g!==m||m==null?a:m,d||(a+=p,o+=p),d=!0,t?.geometry?.extent&&t?.geometry?.type==="polygon"?(n=[a,o],o=n[0]>n[1]?1e3*n[1]/n[0]:1e3,a=n[0]>n[1]?1e3:1e3*n[0]/n[1],h.shape={type:"path",path:O(t.geometry,a,o)}):h.shape=f?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,0]},{command:"L",values:[a,o]},{command:"L",values:[0,o]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:K.fill[0];break}case X:{const f=Math.min(x(e.width),u||z),g=Math.min(x(e.height),u||z),{width:m,height:b}=k(t),y=m===b&&m!=null?m:i??Math.max(f,g),w=e.width/e.height;a=w<=1?Math.ceil(y*w):y,o=w<=1?y:Math.ceil(y/w),h.shape={type:"image",x:-Math.round(a/2),y:-Math.round(o/2),width:a,height:o,src:e.url||""},r&&(S=!0);break}case et:{const f=e,g=t?.overrideText||f.text||at,m=f.font,{width:b,height:y}=k(t),w=y??i??Math.min(x(m.size),u||z),{width:v,height:M}=R(g,{weight:m.weight,size:w,family:m.family}),L=/[\uE600-\uE6FF]/.test(g);a=b??(L?w:v),o=L?w:M;let B=.5*(L?w:M);L&&(B+=5),h.shape={type:"text",text:g,x:f.xoffset||0,y:f.yoffset||B,align:"middle",alignBaseline:f.verticalAlignment,decoration:m&&m.decoration,rotated:f.rotated,kerning:f.kerning},h.font=m&&{size:w,style:m.style,decoration:m.decoration,weight:m.weight,family:m.family};break}}return{shapeDescriptor:h,size:[a,o],outputSize:n,renderOptions:{node:t?.node,scale:d,opacity:t?.opacity,rotations:[r],useRotationSize:S,effectView:t?.effectView,ariaLabel:t?.ariaLabel,clipBloomEffect:t?.clipBloomEffect}}}async function ht(e,t){const{shapeDescriptor:s,size:i,renderOptions:u,outputSize:r}=N(e,t);if(!s.shape)throw new W("symbolPreview: renderPreviewHTML2D","symbol not supported.");await lt(e,s),await st(e,s,i,t);const c=[[s]];if(typeof t?.symbolConfig=="object"&&t?.symbolConfig?.applyColorModulation){const n=.6*i[0];c.unshift([{...s,offset:[-n,0],fill:D(s.fill,-.3)}]),c.push([{...s,offset:[n,0],fill:D(s.fill,.3)}]),i[0]+=2*n,u.scale=!1}e.type==="text"&&rt(e,s,c,i,u);const l=Q(c,i,u);if(r&&l){const n=l.nodeName.toLowerCase()==="img"?l:l.firstChild;n.nodeName.toLowerCase()==="svg"&&n.setAttribute("viewBox",`0 0 ${i[0].toString()} ${i[1].toString()}`),n.setAttribute("width",r[0].toString()),n.setAttribute("height",r[1].toString()),r.length>2&&(n.style.setProperty("padding-left",r[2]?.toString()+"px"),n.style.setProperty("padding-right",r[2]?.toString()+"px"),n.style.setProperty("padding-top",r[3]?.toString()+"px"),n.style.setProperty("padding-bottom",r[3]?.toString()+"px"),n.style.setProperty("box-sizing","border-box"))}return l}function V(e,t=T){const s=j(e),i=A(e),u=!s||"type"in s?null:new P(s),r=i?.color?new P(i?.color):null,c=u?q(E(u),t):null,l=r?q(E(r),t):null;return l?c?c===l?c:t>=T?"light":"dark":l:c}export{V as getContrastingBackgroundTheme,N as getRenderSymbolParameters,ht as previewSymbol2D};
