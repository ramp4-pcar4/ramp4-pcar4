{"version":3,"file":"RawBlockCache-CQB27Sf4.js","sources":["../../node_modules/@arcgis/core/layers/support/rasterDatasets/EphemeralBlockCache.js","../../node_modules/@arcgis/core/layers/support/rasterDatasets/RawBlockCache.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nclass t{constructor(t=15e3,e=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=t,this._interval=Math.min(t,e)}decreaseRefCount(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.refCount--,t.refCount<=0&&(r.delete(s),t.controller&&t.controller.abort()),t.refCount}return 0}getBlock(t,e){const s=t+\"/\"+e,r=this._cachedBlocks;if(r.has(s)){const t=r.get(s);return t.ts=Date.now(),t.refCount++,r.delete(s),r.set(s,t),t.block}return null}putBlock(t,e,s,r){const i=this._cachedBlocks,c=t+\"/\"+e;if(i.has(c)){const t=i.get(c);t.ts=Date.now(),t.refCount++}else i.set(c,{block:s,ts:Date.now(),refCount:1,controller:r});this._trim(),this._updateTimer()}deleteBlock(t,e){const s=this._cachedBlocks,r=t+\"/\"+e;s.has(r)&&s.delete(r)}updateMaxSize(t){this._size=t,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const t=this._cachedBlocks;this._timer=setInterval(()=>{const e=Array.from(t),s=Date.now();for(let r=0;r<e.length&&e[r][1].ts<=s-this._duration;r++)t.delete(e[r][0]);0===t.size&&this._clearTimer()},this._interval)}_trim(){const t=this._cachedBlocks;if(-1===this._size||this._size>=t.size)return;const e=Array.from(t);for(let s=0;s<e.length-this._size;s++)t.delete(e[s][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}}export{t as default};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport e from\"../../../geometry/Point.js\";import n from\"./EphemeralBlockCache.js\";import{projectExtent as t,projectResolution as o,snapPyramid as l}from\"../rasterFunctions/rasterProjectionHelper.js\";const r=new Map,c=new n;function i(e,n,t){const o=[];return null!=n&&o.push(`sliceId=${n}`),null!=t&&o.push(`bandIds=${t.join(\",\")}`),o.length?`${e}?${o.join(\"&\")}`:e}function u(e,n){const t={extent:null,rasterInfo:n,cache:new Map},o=r.get(e);return o?(o.push(t),o.length-1):(r.set(e,[t]),0)}function a(e,n){const t=r.get(e);t&&(t[n]=null,t.some(e=>null!=e)||r.delete(e))}function f(e){r.delete(e)}function s(e,n,t){const o=r.get(e);if(!o)return null==n?c.decreaseRefCount(e,t):0;if(null==n||null==o[n])return c.decreaseRefCount(e,t);const l=o[n]?.cache,i=l?.get(t);if(l&&i){if(i.refCount--,0===i.refCount){l.delete(t);for(let e=0;e<o.length;e++)o[e]?.cache.delete(t);i.controller&&i.controller.abort()}return i.refCount}return 0}function m(e,n,t){const o=r.get(e);if(!o)return null==n?c.getBlock(e,t):null;if(null==n||null==o[n]){for(let e=0;e<o.length;e++){const n=o[e]?.cache.get(t);if(n)return n.refCount++,n.block}return c.getBlock(e,t)}const l=o[n]?.cache.get(t);if(l)return l.refCount++,l.block;for(let r=0;r<o.length;r++){if(r===n||!o[r])continue;const e=o[r]?.cache,l=e?.get(t);if(e&&l)return l.refCount++,e.set(t,l),l.block}return null}function h(e,n,t,o,l=null){const i=r.get(e);if(!i)return void(null==n&&c.putBlock(e,t,o,l));if(null==n||null==i[n])return void c.putBlock(e,t,o,l);const u={refCount:1,block:o,isResolved:!1,isRejected:!1,controller:l};o.then(()=>u.isResolved=!0).catch(()=>u.isRejected=!0),i[n]?.cache.set(t,u)}function x(e,n,t){const o=r.get(e);o?null!=n&&null!=o[n]?o[n]?.cache.delete(t):c.deleteBlock(e,t):null==n&&c.deleteBlock(e,t)}function d(e,n){const t=r.get(e);return t?t[n]??null:null}function g(n,r,c,i,u,a,f=null){const s=d(n,r);if(!s)return;const m=s.extent,{cache:h,rasterInfo:x}=s;if(m&&m.xmin===c.xmin&&m.xmax===c.xmax&&m.ymin===c.ymin&&m.ymax===c.ymax)return;i=i??0;const g=c.clone().normalize(),{spatialReference:p,transform:y}=x,k=new Set;for(let d=0;d<g.length;d++){const n=g[d];if(n.xmax-n.xmin<=i||n.ymax-n.ymin<=i)continue;let r=t(n,p,f);if(null==r)continue;if(null!=y&&(r=y.inverseTransform(r),null==r))continue;const c=new e({x:i,y:i,spatialReference:n.spatialReference});if(null==u&&!(u=o(c,p,n,f)))return;const{pyramidLevel:s,pyramidResolution:m,excessiveReading:h}=l(u,x,a||\"closest\");if(h)return;const{storageInfo:M}=x,{origin:R}=M,{x:C,y:B}=m,b=Math.max(0,Math.floor((r.xmin-R.x)/C)),j=Math.max(0,Math.floor((R.y-r.ymax)/B)),v=Math.ceil(r.width/C-.1),w=Math.ceil(r.height/B-.1),$=s>0?M.pyramidBlockWidth:M.blockWidth,I=s>0?M.pyramidBlockHeight:M.blockHeight,H=M.blockBoundary[s];if(!H)continue;const E=1,P=Math.max(H.minCol,Math.floor(b/$)-E),W=Math.max(H.minRow,Math.floor(j/I)-E),z=Math.min(H.maxCol,Math.floor((b+v-1)/$)+E),F=Math.min(H.maxRow,Math.floor((j+w-1)/I)+E);for(let e=W;e<=F;e++)for(let n=P;n<=z;n++)k.add(`${s}/${e}/${n}`)}h.forEach((e,n)=>{if(!k.has(n)){const e=h.get(n);(null==e||e.isResolved||e.isRejected)&&h.delete(n)}}),s.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}export{s as decreaseRefCount,x as deleteBlock,f as deleteRaster,m as getBlock,i as getRasterId,h as putBlock,u as register,a as unregister,g as update};\n"],"names":["t","e","s","r","i","c","n","o","u","a","l","m","h","x","d","g","f","p","y","k","M","R","C","B","b","j","v","w","$","I","H","E","P","W","z","F"],"mappings":"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","x_google_ignoreList":[0,1]}