import{gU as yt,hQ as Os,hU as z,nO as Ps,ak as Se,nP as bt,kA as Fs,he as ue,cS as wt,N as Rs,_ as c,X as v,Y as L,av as Y,fc as Ge,eB as Ne,i as Ds,c1 as de,Z as ge,az as pe,aJ as Ct,ap as Be,gv as J,g1 as Ms,cY as V,f7 as Vs,al as zs,l0 as Is,e0 as qs,lW as E,lX as Z,ky as _e,gN as St,eb as $,kv as b,nQ as Ls,ma as Tt,j7 as Hs,cR as As,dk as js,dh as Ws,ax as Es,fd as Ot,nR as Gs,jG as fe,ks as Ns,lb as Te,nS as Pt,gx as Bs,gS as Ft}from"./main-6gYsRPh_.js";import{n as f}from"./vec2f64-CkowXrDb.js";import{s as Us,n as Ue,a as ks}from"./vec4f64-DD-nkcCV.js";import{g as Qs,o as Xs}from"./projectBuffer-gVgthDoV.js";import{m as Ys,n as Js,a as Rt,o as ke,b as Oe,c as Zs,d as me,i as Dt,f as Pe,g as Mt,r as Vt,l as zt,j as G,k as N,p as Fe,q as $s,s as Qe,u as Ks,v as Xe,w as Re,_ as Ye,x as O,y as er,z as tr,t as Je,A as sr,B as rr,C as ir,D as ar,E as nr,F as or,G as hr,H as lr,I as cr,J as ur,K as dr,L as gr,M as pr,N as _r,O as fr,P as mr,Q as vr,R as xr,T as yr,U as br,V as wr,W as Cr,X as It,Y as Sr,Z as Ze,$ as qt,a0 as Tr,a1 as Or,a2 as Pr,a3 as Fr,a4 as Rr,a5 as Dr}from"./OutputColorHighlightOID.glsl-DFapDy4Y.js";import{U as Mr}from"./Indices-DYF_HXmC.js";import{t as D}from"./orientedBoundingBox-DQIgZmmC.js";import{b as Lt,i as Ht,c as $e,h as Vr,X as zr,Q as Ir,q as qr,n as Lr}from"./mat4-BV6dbHOa.js";import{S as Hr,P as Ar,D as jr}from"./sphere-DugN-wZa.js";import{m as Wr}from"./plane-BYZ-oMEJ.js";import{Q as K}from"./InterleavedLayout-DLNH5t-m.js";import{j as Er,r as Gr,A as Nr,g as Br,s as H,c as Ur,H as kr,y as Qr,E as Xr,o as At}from"./vec32-y2_p7lFt.js";import{a as Yr,s as jt,z as Jr}from"./vec42-CDRvr0BM.js";import"./lengthUtils-BmHcUR6A.js";import{t as I}from"./glsl-CfY1Aoj6.js";import{s as B}from"./ShaderBuilder-DauPte2P.js";import{T as U,d as k,r as Wt,_ as Zr}from"./renderState-CsafAKLy.js";import{h as Et}from"./triangulationUtils-D-rSmxEV.js";import{t as $r,f as Kr,l as ei}from"./RibbonLine.glsl-BH7Rb9-w.js";import{n as Ke}from"./VertexAttributeLocations-DBgVVQz-.js";import{w as ti}from"./utils-BaVnR4_x.js";import{h as si}from"./VertexArrayObject-Afv3uO4x.js";import{o as ri}from"./BufferObject-4qg9W3U8.js";import{_ as ii,R as ai,n as De}from"./enums-DDJfd4_p.js";import{h as Gt,A as et}from"./Texture-BmeYLtsX.js";import{r as ni}from"./VertexBuffer-CO7g4WaF.js";import{t as oi}from"./NestedMap-BCg8I1M1.js";import{s as ee,u as hi,c as te,e as Me}from"./BufferView-HzgIqv05.js";import{r as tt}from"./signal-CSPaA74e.js";import{j as li,v as Nt,w as Bt}from"./axisAngleDegrees-CoRNF_41.js";import{n as ci}from"./Texture-C_gycdnX.js";import{f as ui,F as di}from"./Scheduler-DIvkTrPN.js";function gi(e,t,s=null){const r=[],i=t.mapPositions,a=pi(t,r),n=a.data,o=a.indices.length,l=Mr(o);return _i(t,r,l),vi(t,r,l),fi(t,r,l),mi(t,r,a.indices,l),xi(t,r,a.indices,l),yi(t,r),bi(t,r,a.indices,l),wi(t,r,n),new Ys(e,r,i,2,s)}function pi(e,t){const{attributeData:{position:s},removeDuplicateStartEnd:r}=e,i=Ci(s)&&r,a=s.length/3-(i?1:0),n=new Array(2*(a-1)),o=i?s.slice(0,-3):s;let l=0;for(let d=0;d<a-1;d++)n[l++]=d,n[l++]=d+1;const g=new D(o,n,3,i);return t.push(["position",g]),g}function _i(e,t,s){if(e.attributeData.colorFeature!=null)return;const r=e.attributeData.color;t.push(["color",new D(r??Us,s,4)])}function fi(e,t,s){e.attributeData.normal&&t.push(["normal",new D(e.attributeData.normal,s,3)])}function mi(e,t,s,r){const i=e.attributeData.colorFeature;i!=null&&(typeof i=="number"?t.push(["colorFeatureAttribute",new D([i],r,1,!0)]):t.push(["colorFeatureAttribute",new D(i,s,1,!0)]))}function vi(e,t,s){e.attributeData.sizeFeature==null&&t.push(["size",new D([e.attributeData.size??1],s,1,!0)])}function xi(e,t,s,r){const i=e.attributeData.sizeFeature;i!=null&&(typeof i=="number"?t.push(["sizeFeatureAttribute",new D([i],r,1,!0)]):t.push(["sizeFeatureAttribute",new D(i,s,1,!0)]))}function yi(e,t){const{attributeData:{position:s,timeStamps:r}}=e;if(!r)return;const i=s.length/3,a=new Array(2*(i-1));let n=0;for(let o=0;o<i-1;o++)a[n++]=o,a[n++]=o+1;t.push(["timeStamps",new D(r,a,Oi,!0)])}function bi(e,t,s,r){const i=e.attributeData.opacityFeature;i!=null&&(typeof i=="number"?t.push(["opacityFeatureAttribute",new D([i],r,1,!0)]):t.push(["opacityFeatureAttribute",new D(i,s,1,!0)]))}function wi(e,t,s){if(e.overlayInfo==null||e.overlayInfo.renderCoordsHelper.viewingMode!==1||!e.overlayInfo.spatialReference.isGeographic)return;const r=yt(s.length),i=Os(e.overlayInfo.spatialReference);for(let _=0;_<r.length;_+=3)Qs(s,_,r,_,i);const a=s.length/3,n=Js(a+1);let o=Si,l=Ti,g=0,d=0;z(o,r[d++],r[d++]),d++,n[0]=0;for(let _=1;_<a+1;++_)_===a&&(d=0),z(l,r[d++],r[d++]),d++,g+=Ps(o,l),n[_]=g,[o,l]=[l,o];t.push(["distanceToStart",new D(n,t[0][1].indices,1,!0)])}function Ci(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}const Si=f(),Ti=f(),Oi=4;let Ut=class extends si{},kt=class{constructor(){this._extent=Se(),this.resolution=0,this.renderLocalOrigin=$r(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new Pi}get extent(){return this._extent}setExtent(e){Yr(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const t=.001*e.range;if(this._extent[0]-t<=e.min){const s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];bt(this._extent,e.range,0,s)}if(this._extent[2]+t>=e.max){const s=this.canvasGeometries.extents[this.canvasGeometries.numViews++];bt(this._extent,-e.range,0,s)}}_setupGeometryView(){this.canvasGeometries.numViews=1,Fs(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},Pi=class{constructor(){this.extents=[Se(),Se(),Se()],this.numViews=0}},Fi=class{constructor(e,t,s){this._fbos=e,this._format=t,this._name=s}get valid(){return this._handle?.getTexture()!=null}dispose(){this._handle=ue(this._handle)}get texture(){return this._handle?.getTexture()}ensureFramebuffer(e,t){this._handle&&this._handle.fbo?.width===e&&this._handle.fbo?.height===t||(this._handle?.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){e.bindFramebuffer(this._handle?.fbo)}generateMipMap(){this._handle?.getTexture()?.descriptor?.hasMipmap&&this._handle?.getTexture()?.generateMipmap()}},se=class{constructor(e,t,s,r,i=1,a=6){this.output=s,this.content=r,this.redrawOnRequest=i,this.fbo=new Fi(e,a,t)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},Ri=class{constructor(e){this.targets=[new se(e,"overlay color",0,0),new se(e,"overlay IM color",0,1),new se(e,"overlay highlight",9,2,1,3),new se(e,"overlay water",3,3,0),new se(e,"overlay occluded",0,4)],Rt()&&this.targets.push(new se(e,"overlay olid",10,5,1,5))}getTexture(e){return this.targets[e]?.fbo.texture}dispose(e){if(e!==0)for(const t of this.targets)t.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,s)=>t.valid?e|=1<<s:e,0)}},st=class extends me{constructor(){super(...arguments),this.color=wt(1,1,1)}};function Qt(){const e=new B;return e.include(ke),e.fragment.uniforms.add(new Oe("tex",t=>t.texture),new Zs("uColor",t=>t.color)),e.fragment.main.add(I`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const Di=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:st,build:Qt},Symbol.toStringTag,{value:"Module"})),Mi={required:[]};let Xt=class extends Rs{precompile(e){return!!this.acquireTechniques(e)}consumes(){return Mi}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},Vi=class extends Xt{},zi=class extends Xt{},Yt=class extends Dt{constructor(e,t){super(e,"ivec2",1,(s,r,i)=>s.setUniform2iv(e,t(r,i)))}},Ve=class extends Dt{constructor(e,t){super(e,"usampler2D",1,(s,r,i)=>s.bindTexture(e,t(r,i)))}},rt=class extends me{};function Jt(){const e=new B,{outputs:t,fragment:s}=e;return e.include(ke),s.uniforms.add(new Ve("highlightTexture",r=>r.highlightTexture)),s.constants.add("outlineWidth","int",Math.ceil(ve)),s.constants.add("cellSize","int",A),t.add("fragGrid","uvec2"),s.main.add(I`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),e}const A=32,ve=9,it=.4,Ii=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:rt,blurSize:it,build:Jt,gridCellPixelSize:A,outlineSize:ve},Symbol.toStringTag,{value:"Module"}));function at(e){const{vertex:t}=e;t.uniforms.add(new Ve("coverageTexture",s=>s.coverageTexture),new Yt("highlightRenderCellCount",s=>z(Zt,s.horizontalCellCount,s.verticalCellCount)),new Yt("highlightTextureResolution",({highlightTexture:s})=>z(Zt,s.descriptor.width,s.descriptor.height)),new Pe("highlightLevel",s=>s.highlightLevel)).constants.add("cellSize","int",A),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add(I`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),t.main.add(I`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const Zt=f();function $t(){const e=new B;e.include(at);const{fragment:t}=e;return t.uniforms.add(new Oe("blurInput",s=>s.highlightBlurTexture),new Mt("blurSize",s=>s.blurSize),new Ve("highlightTexture",s=>s.highlightTexture),new Oe("highlightOptionsTexture",s=>s.highlightOptionsTexture),new Pe("highlightLevel",s=>s.highlightLevel),new Vt("occludedIntensityFactor",s=>s.occludedFactor)),t.constants.add("inner","float",1-(ve-it)/ve),e.include(zt),t.main.add(I`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}const qi=Object.freeze(Object.defineProperty({__proto__:null,build:$t},Symbol.toStringTag,{value:"Module"}));let Kt=class extends G{constructor(e,t){super(e,t,new N(qi,()=>import("./ImageMaterial.glsl-Bbyc7v8n.js").then(s=>s.H)),Ke(Fe))}initializePipeline(){return U({blending:Wt,colorWrite:k})}},nt=class extends me{constructor(){super(...arguments),this.blurSize=f()}};function es(){const e=new B;return e.include(at),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new Mt("blurSize",t=>t.blurSize),new $s("blurInput",t=>t.blurInput)).main.add(I`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),e}const Li=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:nt,build:es},Symbol.toStringTag,{value:"Module"}));let ts=class extends G{constructor(e,t){super(e,t,new N(Li,()=>import("./ImageMaterial.glsl-Bbyc7v8n.js").then(s=>s.a)),Ke(Fe))}initializePipeline(){return U({colorWrite:k})}},ot=class extends G{constructor(e,t){super(e,t,new N(Ii,()=>import("./ImageMaterial.glsl-Bbyc7v8n.js").then(s=>s.b)),Qe)}initializePipeline(){return U({colorWrite:k})}};class Hi extends me{constructor(){super(...arguments),this.occludedFactor=ti,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}function ss(){const e=new B;e.include(at),e.include(zt);const{fragment:t}=e;return e.outputs.add("fragSingleHighlight","vec2",0),t.uniforms.add(new Ve("highlightTexture",s=>s.highlightTexture),new Pe("highlightLevel",s=>s.highlightLevel)),t.main.add(I`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}const Ai=Object.freeze(Object.defineProperty({__proto__:null,build:ss},Symbol.toStringTag,{value:"Module"}));let rs=class extends G{constructor(e,t){super(e,t,new N(Ai,()=>import("./ImageMaterial.glsl-Bbyc7v8n.js").then(s=>s.c)),Ke(Fe))}initializePipeline(){return U({colorWrite:k})}},ze=class extends Ks{constructor(){super(...arguments),this.produces=Xe.HIGHLIGHTS,this.consumes={required:[Xe.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new rt,this._passParameters=new Hi,this._highlightBlurDrawParameters=new nt,this._grid=new ji}initialize(){this.addHandles([Y(()=>this._updateOptionsTexture(),()=>{},Ge)])}destroy(){this._grid.coverage=ue(this._grid.coverage),this._grid.vao=Ne(this._grid.vao),this._passParameters.highlightOptionsTexture=ue(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){const e=new Gt(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new et(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(Wi(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(ot),this.techniques.precompile(rs),this.techniques.precompile(ts),this.techniques.precompile(Kt)}render(e){const t=e.find(({name:a})=>a===Xe.HIGHLIGHTS),{techniques:s,bindParameters:r}=this;if(!r.decorations)return t;if(!s.get(ot).compiled)return this.requestRender(1),t;const i=e.find(({name:a})=>a==="highlights").getTexture();return this._renderHighlightPostprocess(i,t),t}_prepareAndDownSample(e){this._gridUpdateResources(e);const t=this.techniques.get(ot),s=this._gridComputeCoverage(t,e),{horizontalCellCount:r,verticalCellCount:i}=s,a=this._passParameters;return a.horizontalCellCount=r,a.verticalCellCount=i,a.coverageTexture=s.coverage?.getTexture(),s}_renderGrid(e){const t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(ii.TRIANGLES,6,ai.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){const{fboCache:s,techniques:r,bindParameters:i,_passParameters:a,renderingContext:n}=this,o=r.get(rs),l=r.get(ts),g=r.get(Kt);if(!g.compiled||!l.compiled||!o.compiled)return void this.requestRender(1);a.highlightTexture=e;const d=this._prepareAndDownSample(e),{width:_,height:p}=e.descriptor;a.highlightTexture=e;const{camera:y}=i,{fullWidth:R,fullHeight:he,pixelRatio:X,fullViewport:We}=y,le=Math.ceil(R/X),ce=Math.ceil(he/X),{_highlightBlurDrawParameters:W}=this,m=this.view.stage.renderView.renderer,{highlights:C}=i;for(let we=0;we<C.length;++we){const{name:Ts}=C[we];if(!m.hasHighlight(Ts))continue;a.highlightLevel=we,n.setClearColor(0,0,0,0);const Ee=s.acquire(_,p,"single highlight",2);n.bindFramebuffer(Ee.fbo),n.setViewport(0,0,_,p),n.clear(16384),n.bindTechnique(o,i,a),this._renderGrid(d),W.blurInput=Ee.getTexture(),z(W.blurSize,1/le,0);const Ce=s.acquire(le,ce,"single highlight blur",2);n.unbindTexture(Ce.fbo?.colorTexture),n.bindFramebuffer(Ce.fbo),n.setViewport(0,0,le,ce),n.clear(16384),n.bindTechnique(l,i,a,W),this._renderGrid(d),Ee.release(),z(W.blurSize,0,1/ce),a.highlightBlurTexture=Ce.getTexture(),n.bindFramebuffer(t.fbo),n.setViewport4fv(We),n.bindTechnique(g,i,a,W),this._renderGrid(d),Ce.release()}a.coverageTexture=a.highlightTexture=null}_gridUpdateResources(e){const t=this._grid,{width:s,height:r}=e.descriptor;if(t.horizontalCellCount=Math.ceil(s/A),t.verticalCellCount=Math.ceil(r/A),t.vao)return;const i=this.renderingContext,a=ri.createIndex(i,35044,Ni);t.vao=new Ut(i,new ni(i,Fe),a)}_gridComputeCoverage(e,t){const s=this.renderingContext,r=this._grid,i=t.descriptor,a=Math.ceil(i.width/A),n=Math.ceil(i.height/A);this._downsampleDrawParameters.input=t;const{highlights:o}=this.bindParameters;r.coverage?.release();const l=this.fboCache.acquire(a,n,"highlight coverage",o.length>is?3:1);return r.coverage=l,s.bindFramebuffer(l.fbo),s.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),s.setViewport(0,0,a,n),s.screen.draw(),r}get test(){}};c([v()],ze.prototype,"produces",void 0),c([v()],ze.prototype,"consumes",void 0),ze=c([L("esri.views.3d.webgl-engine.effects.highlight.Highlight")],ze);let ji=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function Wi(e){const t=new Uint8Array(128);let s=0;for(const r of e){const i=4*s,a=4*s+64;++s;const{color:n}=r,o=r.haloColor??n;t[i+0]=n.r,t[i+1]=n.g,t[i+2]=n.b,t[i+3]=r.fillOpacity*n.a*255,t[a+0]=o.r,t[a+1]=o.g,t[a+2]=o.b,t[a+3]=r.haloOpacity*o.a*255}return t}let Ei=0;function Gi(e){let t=0;for(const r of e){const{name:i}=r;t+=i.length;const{color:a,fillOpacity:n,haloColor:o,haloOpacity:l}=r;t+=a.r+a.g+a.b+a.a+n,t+=o?o.r+o.g+o.b+o.a+l:0}const s=e.at(0);if(s){const{shadowOpacity:r,shadowDifference:i,shadowColor:a}=s;t+=r+i+a.r+a.g+a.b+a.a}return Ei+++(t>=0?0:1)}const Ni=new Uint8Array([0,1,2,2,1,3]);function Bi(e,t,s,r,i,a=0){const{highlights:n}=r,o=n.length>1?t.acquire(s.width,s.height,"highlight mix",n.length>is?3:1):null,{gl:l}=e;if(o){const d=e.getBoundFramebufferObject();e.bindFramebuffer(o.fbo),l.clearBufferuiv(l.COLOR,0,[0,0,0,0]),e.bindFramebuffer(d)}const g=o?.getTexture();r.highlightMixTexture=g,z(r.highlightMixOrigin,a,0),n.forEach((d,_)=>{if(_>0){const p=et.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(g,p),e.setActiveTexture(p),l.copyTexSubImage2D(3553,0,0,0,a,0,s.width,s.height),e.bindTexture(null,p)}e.clear(256),r.highlightLevel=_,i()}),r.highlightLevel=null,r.highlightMixTexture=null,o?.release()}const is=4;let Ui=class{constructor(e,t,s,r){this.material=e,this.output=t,this.techniques=s,this.textures=r}},ki=class{constructor(e,t,s,r){this._textures=e,this._techniques=t,this.materialChanged=s,this.requestRender=r,this._id2glMaterialRef=new oi}dispose(){this._textures.destroy()}acquire(e,t,s){if(this._ownMaterial(e),!e.produces.get(t)?.(s))return null;let r=this._id2glMaterialRef.get(s,e.id);if(r==null){const i=e.createGLMaterial(new Ui(e,s,this._techniques,this._textures));r=new Qi(i),this._id2glMaterialRef.set(s,e.id,r)}return r.ref(),r.glMaterial}release(e,t){const s=this._id2glMaterialRef.get(t,e.id);s!=null&&(s.unref(),s.referenced||(Ne(s.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&Ds.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Qi=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,ee(this._refCnt>=0)}get referenced(){return this._refCnt>0}};function Xi(e){return e!=null&&!e.readyToRun}var ht;let Ie=ht=class extends ge{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new ht({cloudCover:this.cloudCover})}};c([de({cloudy:"cloudy"}),v({json:{write:{isRequired:!0}}})],Ie.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Ie.prototype,"cloudCover",void 0),Ie=ht=c([L("esri.views.3d.environment.CloudyWeather")],Ie);var lt;let qe=lt=class extends ge{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new lt({fogStrength:this.fogStrength})}};c([de({foggy:"foggy"}),v({json:{write:{isRequired:!0}}})],qe.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],qe.prototype,"fogStrength",void 0),qe=lt=c([L("esri.views.3d.environment.FoggyWeather")],qe);var ct;let xe=ct=class extends ge{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new ct({cloudCover:this.cloudCover,precipitation:this.precipitation})}};c([de({rainy:"rainy"}),v({json:{write:{isRequired:!0}}})],xe.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],xe.prototype,"cloudCover",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],xe.prototype,"precipitation",void 0),xe=ct=c([L("esri.views.3d.environment.RainyWeather")],xe);var ut;let re=ut=class extends ge{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new ut({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};c([de({snowy:"snowy"}),v({json:{write:{isRequired:!0}}})],re.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],re.prototype,"cloudCover",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],re.prototype,"precipitation",void 0),c([v({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],re.prototype,"snowCover",void 0),re=ut=c([L("esri.views.3d.environment.SnowyWeather")],re);var dt;let Le=dt=class extends ge{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new dt({cloudCover:this.cloudCover})}};c([de({sunny:"sunny"}),v({json:{write:{isRequired:!0}}})],Le.prototype,"type",void 0),c([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Le.prototype,"cloudCover",void 0),Le=dt=c([L("esri.views.3d.environment.SunnyWeather")],Le);const He=1e4,Yi=1e5;let Ji=class{constructor(){this.startTime=0,this._data=tt(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new as,this.parallaxNew=new as,this._anchorPoint=pe(),this._fadeState=tt(0),this._fadeFactor=tt(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,s){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=s?Ct((t-this.startTime)/($i*s),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){const s=e.relativeElevation,r=this._updateAnchorPoint(e);(s>1.7*He||s<-He||r>os)&&this.opacity>0?this._startFade(0,t):this.isFading||(s>He||s<-.35*He||r>Ki*os?this.opacity>0&&this._startFade(4,t):Xi(this.data)&&(this.opacity===0?this._startFade(1,t):this.data.state===2&&(this.fadeState===2?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){const t=Er(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-Be.radius*Be.radius,0))/Math.sqrt(t),Nt(ns,this.parallax.anchorPoint,ie),Lt(this.parallax.transform,J,ie[3],Bt(ie)),Nt(ns,this.parallaxNew.anchorPoint,ie),Lt(this.parallaxNew.transform,J,ie[3],Bt(ie))}_updateAnchorPoint(e){return Nr(this._anchorPoint,e.eye),Br(this._anchorPoint,this._anchorPoint,Be.radius),this.fadeState===0&&this.data?.state===2?(H(this.parallax.anchorPoint,this._anchorPoint),0):Gr(Ur(Zi,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),H(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),H(this.parallax.anchorPoint,this._anchorPoint),H(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),H(this.parallax.anchorPoint,this._anchorPoint),H(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:H(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:Ms(this.fadeState)}}_switchReadChannels(){this.data?.state===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},as=class{constructor(){this.anchorPoint=pe(),this.radiusCurvatureCorrection=0,this.transform=V()}};const ns=wt(0,0,1),ie=li(),Zi=pe(),$i=1.25,Ki=.5,os=2e5;let ea=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new Re,this._inverseViewport=f(),this._oldLighting=new Ye,this._newLighting=new Ye,this._fadedLighting=new Ye,this._lighting=this._newLighting,this.ssr=new ta,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=f(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new Ji,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,s,r){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=s,this._newLighting.set(e),this._oldLighting.updateLegacy(),r===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},ta=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=V()}},sa=class{constructor(e,t,s){this.rctx=e,this.techniques=s,this.lastFrameCamera=new Re,this.output=0,this.renderOccludedMask=gt,this.time=Vs(0),this.bind=new ea(t),this.bind.alignPixelEnabled=!0}};const gt=13;let ye=class extends Re{constructor(){super(...arguments),this._projectionMatrix=V()}get projectionMatrix(){return this._projectionMatrix}};c([v()],ye.prototype,"_projectionMatrix",void 0),c([v({readOnly:!0})],ye.prototype,"projectionMatrix",null),ye=c([L("esri.views.3d.webgl-engine.lib.CascadeCamera")],ye);class Ae{constructor(){this.camera=new ye,this.lightMat=V()}}class ra{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}let ia=class{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new ra,this._projectionView=V(),this._projectionViewInverse=V(),this._modelViewLight=V(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Ue(),this._cascades=[new Ae,new Ae,new Ae,new Ae],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(zs("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){return this._handle?.getTexture(De)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return jt(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=ue(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Ct(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)_t[e]=this._cascades[e];return _t.length=this._numCascades,_t}start(e,t,s,r,i){ee(this.enabled);const{near:a,far:n}=ca(s);this._computeCascadeDistances(a,n,r),this._textureHeight=this._computeTextureHeight(e,i,r),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:l}=e;for(let g=0;g<this._numCascades;++g)this._constructCascade(g,l,o,t);this._lastOrigin=null,this.clear()}finish(){ee(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!kr(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||pe(),H(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){Ht(gs,this._cascades[t].lightMat,e);for(let s=0;s<16;++s)ps[16*t+s]=gs[s]}}return ps}moveSnapshot(e){ee(this.enabled),this._snapshots[e]?.release(),this._snapshots[e]=this._handle,this._handle?.setName(e===0?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){if(!this.enabled||!this._handle?.getTexture(De)?.descriptor)return;this._snapshots[e]?.release();const t=e===0?"shadow map highlight":"shadow map excluding highlight",s=this._acquireFBO(t);this._snapshots[e]=s;const r=this._handle?.fbo;if(!r||!s?.fbo)return void console.error("No FBO");const{rctx:i}=this._fbos;i.blitFramebuffer(r,s.fbo,256)}getSnapshot(e){return this.enabled?this._snapshots[e]?.getTexture(De):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:s},r,i){const a=Math.min(window.devicePixelRatio,r)/e,n=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return ci(Math.max(t,s)*a*n,this._maxTextureWidth/this._numCascades)}_ensureFbo(){this._handle?.fbo?.width===this._textureWidth&&this._handle?.fbo.height===this._textureHeight||(this._handle?.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){const t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return t.getTexture(De)?.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=ue(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){this._fbos.rctx.bindFramebuffer(this._handle?.fbo)}_constructCascade(e,t,s,r){const i=this._cascades[e],a=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],o=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),l=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);ee(o<l);for(let p=0;p<8;++p){jt(hs,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?o:l,1);const y=M[p];Jr(y,hs,this._projectionViewInverse),y[0]/=y[3],y[1]/=y[3],y[2]/=y[3]}Qr(pt,M[0]),i.camera.viewMatrix=Ht(aa,this._modelViewLight,pt);for(let p=0;p<8;++p)Xr(M[p],M[p],i.camera.viewMatrix);let g=M[0][2],d=M[0][2];for(let p=1;p<8;++p)g=Math.min(g,M[p][2]),d=Math.max(d,M[p][2]);g-=200,d+=200,i.camera.near=-d,i.camera.far=-g,la(s,r,g,d,i.camera),$e(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const _=this._textureHeight;i.camera.viewport=[e*_,0,_,_]}_setupMatrices(e,t){$e(this._projectionView,e.projectionMatrix,e.viewMatrix),Vr(this._projectionViewInverse,this._projectionView);const s=this._viewingMode===1?e.eye:At(pt,0,0,1);zr(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],s)}_computeCascadeDistances(e,t,s){const r=s?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(hi(t/e,4)),r);const i=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades);let n=e,o=e;for(let l=0;l<this._numCascades+1;++l)this._cascadeDistances[l]=Is(n,o,this.settings.splitSchemeLambda),n*=a,o+=i}get test(){}};const aa=V(),hs=Ue(),M=[];for(let e=0;e<8;++e)M.push(Ue());const ls=f(),cs=f(),na=f(),us=f(),ds=f(),pt=pe(),_t=[],gs=V(),ps=J.concat(J,J,J),P=f(),ae=f(),Q=[f(),f(),f(),f()],x=f(),ft=f(),j=f(),be=f(),ne=f(),oe=f(),je=f();function oa(e,t,s,r,i,a,n,o){z(P,0,0);for(let m=0;m<4;++m)E(P,P,e[m]);Z(P,P,.25),z(ae,0,0);for(let m=4;m<8;++m)E(ae,ae,e[m]);Z(ae,ae,.25),_e(Q[0],e[4],e[5],.5),_e(Q[1],e[5],e[6],.5),_e(Q[2],e[6],e[7],.5),_e(Q[3],e[7],e[4],.5);let l=0,g=St(Q[0],P);for(let m=1;m<4;++m){const C=St(Q[m],P);C<g&&(g=C,l=m)}$(x,Q[l],e[l+4]);const d=x[0];let _,p;x[0]=-x[1],x[1]=d,$(ft,ae,P),b(ft,x)<0&&Ls(x,x),_e(x,x,ft,s),Tt(x,x),_=p=b($(j,e[0],P),x);for(let m=1;m<8;++m){const C=b($(j,e[m],P),x);C<_?_=C:C>p&&(p=C)}Hs(r,P),Z(j,x,_-t),E(r,r,j);let y=-1,R=1,he=0,X=0;for(let m=0;m<8;++m){$(be,e[m],r),Tt(be,be);const C=x[0]*be[1]-x[1]*be[0];C>0?C>y&&(y=C,he=m):C<R&&(R=C,X=m)}te(y>0,"leftArea"),te(R<0,"rightArea"),Z(ne,x,_),E(ne,ne,P),Z(oe,x,p),E(oe,oe,P),je[0]=-x[1],je[1]=x[0];const We=Me(r,e[X],oe,E(j,oe,je),1,i),le=Me(r,e[he],oe,j,1,a),ce=Me(r,e[he],ne,E(j,ne,je),1,n),W=Me(r,e[X],ne,j,1,o);te(We,"rayRay"),te(le,"rayRay"),te(ce,"rayRay"),te(W,"rayRay")}function u(e,t){return 3*t+e}const _s=f();function T(e,t){return z(_s,e[t],e[t+3]),_s}const S=f(),h=As();function ha(e,t,s,r,i){$(S,s,r),Z(S,S,.5),h[0]=S[0],h[1]=S[1],h[2]=0,h[3]=S[1],h[4]=-S[0],h[5]=0,h[6]=S[0]*S[0]+S[1]*S[1],h[7]=S[0]*S[1]-S[1]*S[0],h[8]=1,h[u(0,2)]=-b(T(h,0),e),h[u(1,2)]=-b(T(h,1),e);let a=b(T(h,0),s)+h[u(0,2)],n=b(T(h,1),s)+h[u(1,2)],o=b(T(h,0),r)+h[u(0,2)],l=b(T(h,1),r)+h[u(1,2)];a=-(a+o)/(n+l),h[u(0,0)]+=h[u(1,0)]*a,h[u(0,1)]+=h[u(1,1)]*a,h[u(0,2)]+=h[u(1,2)]*a,a=1/(b(T(h,0),s)+h[u(0,2)]),n=1/(b(T(h,1),s)+h[u(1,2)]),h[u(0,0)]*=a,h[u(0,1)]*=a,h[u(0,2)]*=a,h[u(1,0)]*=n,h[u(1,1)]*=n,h[u(1,2)]*=n,h[u(2,0)]=h[u(1,0)],h[u(2,1)]=h[u(1,1)],h[u(2,2)]=h[u(1,2)],h[u(1,2)]+=1,a=b(T(h,1),t)+h[u(1,2)],n=b(T(h,2),t)+h[u(2,2)],o=b(T(h,1),s)+h[u(1,2)],l=b(T(h,2),s)+h[u(2,2)],a=-.5*(a/n+o/l),h[u(1,0)]+=h[u(2,0)]*a,h[u(1,1)]+=h[u(2,1)]*a,h[u(1,2)]+=h[u(2,2)]*a,a=b(T(h,1),t)+h[u(1,2)],n=b(T(h,2),t)+h[u(2,2)],o=-n/a,h[u(1,0)]*=o,h[u(1,1)]*=o,h[u(1,2)]*=o,i[0]=h[0],i[1]=h[1],i[2]=0,i[3]=h[2],i[4]=h[3],i[5]=h[4],i[6]=0,i[7]=h[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=h[6],i[13]=h[7],i[14]=0,i[15]=h[8]}function la(e,t,s,r,i){const a=1/M[0][3],n=1/M[4][3];ee(a<n);let o=a+Math.sqrt(a*n);const l=Math.sin(qs(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=l,oa(M,o,l,ls,cs,na,us,ds),ha(ls,cs,us,ds,i.projectionMatrix),i.projectionMatrix[10]=2/(s-r),i.projectionMatrix[14]=-(s+r)/(s-r)}function ca(e){let{near:t,far:s}=e;return t<2&&(t=2),s<2&&(s=2),t>=s&&(t=2,s=4),{near:t,far:s}}class fs extends G{constructor(t,s){super(t,s,new N(Di,()=>import("./ImageMaterial.glsl-Bbyc7v8n.js").then(r=>r.T)),Qe)}initializePipeline(t){return t.hasAlpha?U({blending:Wt,colorWrite:k}):U({colorWrite:k})}}let ms=class extends er{constructor(){super(...arguments),this.hasAlpha=!1}};c([O()],ms.prototype,"hasAlpha",void 0);let mt=class extends me{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}};function vs(){const e=new B;return e.include(ke),e.fragment.uniforms.add(new Oe("tex",t=>t.texture)),e.fragment.uniforms.add(new Pe("overlayIdx",t=>t.overlayIndex)),e.fragment.uniforms.add(new Vt("opacity",t=>t.opacity)),e.fragment.main.add(I`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const ua=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:mt,build:vs},Symbol.toStringTag,{value:"Module"}));let xs=class extends G{constructor(e,t){super(e,t,new N(ua,()=>import("./ImageMaterial.glsl-Bbyc7v8n.js").then(s=>s.O)),Qe)}},q=class extends Vi{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new mt,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new js,this._passParameters=new st,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new Re,this.events=new Ws,this.longitudeCyclical=null,this.produces=new Map([[18,t=>t!==9||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const e=this._view,t=e.stage,s=t.renderer.fboCache,{waterTextures:r,techniques:i}=t.renderView;this._renderContext=new sa(this._rctx,new ia(s,e.state.viewingMode),i),this.addHandles([Y(()=>r.updating,()=>this.events.emit("content-changed"),Ot),Y(()=>this._spatialReference,o=>this._localOriginFactory=new Kr(o),Ot),Es(()=>e.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),Y(()=>Gi(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,Ge),Y(()=>e.state.highlights,o=>{this._bindParameters.highlights=o,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},Ge),e.resourceController.scheduler.registerTask(ui.OVERLAY_RENDERER,this)]);const{_bindParameters:a,_camera:n}=this;n.near=1,n.far=1e4,n.relativeElevation=null,a.slot=18,a.mainDepth=null,a.camera=n,a.oitPass=0,a.updateLighting([new tr(Gs())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=Ne(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new ki(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext={...e,materials:t},this._techniques.precompile(xs)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||fe(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const t of this._renderers.values()){const s=t.getMaterialRenderer(e);if(s)return s}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),Ns(this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e))}registerDrapeSource(e,t){this._renderers.get(e)?.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(Y(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e)}removeDrapeSourceRenderer(e){if(e==null)return;const t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){return this._renderTargets?.computeValidity()??0}releaseRenderTargets(e){this._renderTargets?.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&Te(e,t=>t.drapeTargetType===1)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=Te(e,t=>t.drapeSourceType===1),this._hasDrapedRasterSource=Te(e,t=>t.drapeSourceType===0),this._hasDrapedFlowSource=Te(e,t=>t.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,s=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new Ri(this._stage.renderer.fboCache),this._overlays=[new kt,new kt]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=s}disposeOverlays(){this._overlays=null,this._renderTargets?.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(e){return e===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){const t=this._useOverlayColorInsteadOfColorNoRasterImage(e);return this._renderTargets?.getTexture(t?0:e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=fe(this._renderers,e=>e.hasOccluders)?vt:1}_processDrapeSources(e,t){let s=!1;for(const[r,i]of this._renderers){if(e.done)break;(r.destroyed||t(r))&&i.commitChanges()&&(s=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,s=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),s&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=fe(this._renderers,r=>r.hasHighlights),this.events.emit("content-changed"))}compact(e){let t=!1;for(const s of this._renderers.values()){if(e.done)break;t=s.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return fe(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(di,e=>e.updatePolicy===1)}get isEmpty(){return!Je.OVERLAY_DRAW_DEBUG_TEXTURE&&Pt(this._renderers,e=>e.isEmpty)}get hasWater(){const e=fe(this._renderers,({hasWater:t})=>t);return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}renders(e){if(Je.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==4&&e!==2)return!0;if(!this._overlays)return!1;const t=this._overlays[0];for(const i of this._overlays)i.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const s=this._renderContext.output;this._renderContext.output=this._renderTargets?.targets.find(i=>i.content===e)?.output??0,++this._techniques.precompiling;const r=this._sortedRenderers.some(({renderer:i})=>i.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.output=s,r}get mode(){return this.isEmpty?0:this.hasWater&&this.renders(3)?2:this._renderTargets?.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(s=>t=s.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const s of this._renderTargets.targets){if(s.content===1&&!this._needsColorWithoutRasterImage)continue;const{output:r}=s;this._renderContext.output=r,t.slot=r===3?19:18,r===9&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);const i=this._renderContext.renderOccludedMask;s.content===4&&(this._renderContext.renderOccludedMask=vt),this._sortedRenderers.forAll(({drapeSource:a,renderer:n})=>{s.content===1&&a.drapeSourceType===0||s.content===4&&n.hasOnlyOccluders||n.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=i,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(const r of this._overlays)r.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;const s=this.allSourcesOccluders;for(const r of this._renderTargets.targets){if(!(r.content===0&&this._hasDrapedFlowSource)&&!r.handleRenderRequest(t)||r.content===1&&!this._needsColorWithoutRasterImage||r.content===4&&s)continue;const i=this._drawTarget(0,r),a=this._drawTarget(1,r);(i||a)&&r.fbo.generateMipMap()}}_drawTarget(e,t){const s=this._overlays[e],r=s.canvasGeometries;if(r.numViews===0)return!1;const i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*s.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:a}=t;if(this.isEmpty||a===3&&!this.hasWater||!s.hasSomeSizedView())return!1;const{_rctx:n,_camera:o,_renderContext:l,_bindParameters:g}=this;if(o.pixelRatio=s.pixelRatio*i,l.output=a,g.screenToWorldRatio=this._screenToWorldRatio,g.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,g.slot=a===3?19:18,t.content===4&&(l.renderOccludedMask=vt),!this.renders(t.content))return l.renderOccludedMask=gt,!1;const{resolution:d}=s,_=e===0,p=_?0:d;if(n.setViewport(p,0,d,d),this._bindTargetFBO(t),_)if(t.output!==9)n.setClearColor(0,0,0,0),n.clear(16384);else{const{gl:y}=n;y.clearBufferuiv(y.COLOR,0,[0,0,0,0])}if(Je.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==4&&t.content!==2){this._techniques.precompile(fs,xt);const y=this._techniques.get(fs,xt);for(let R=0;R<r.numViews;R++)this._setViewParameters(r.extents[R],s),this._ensureDebugPatternResources(s.resolution,ga[e]),n.bindTechnique(y,g,this._passParameters),n.screen.draw()}if(t.output===9){const{fboCache:y}=this._stage.renderer,R=this._resolution;this._bindTargetFBO(t),Bi(n,y,{width:R,height:R},g,()=>this._renderAllGeometry(e,t),p)}else this._renderAllGeometry(e,t);return n.bindFramebuffer(null),l.renderOccludedMask=gt,!0}get allSourcesOccluders(){return Pt(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){const s=this._overlays[e],r=s.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{if(t.content===1&&i.drapeSourceType===0)return;const{fullOpacity:n}=i,o=n!=null&&n<1&&t.output===0&&this._bindTemporaryFBO();for(let l=0;l<r.numViews;l++)this._setViewParameters(r.extents[l],s),a.render(this._renderContext);if(o){this._bindTargetFBO(t),this._overlayParameters.texture=o.getTexture(),this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=e;const l=this._techniques.get(xs);this._rctx.bindTechnique(l,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release()}})}_bindTargetFBO(e){const t=this._resolution,s=2*t;e.fbo.ensureFramebuffer(s,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,s=this._stage.renderer.fboCache,r=s.acquire(t,e,"overlay tmp");return s.rctx.bindFramebuffer(r.fbo),s.rctx.clear(16384),r}get _resolution(){return this._overlays?.[0].resolution??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,s,r){this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(const{renderer:a}of this._sortedRenderers)i=a.intersect?.(e,t,s,r,i)??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this._view.map.allLayers.map(s=>s.uid),t=e.length;this._renderers.forEach((s,r)=>{const i=e.indexOf(r.layer?.uid),a=i>=0,n=r.renderGroup??(a?0:1),o=r.drapeSourcePriorityOffset??0,l=t*n+(a?i:0)+o;this._sortedRenderers.push(new da(r,s,l))}),this._sortedRenderers.sort((s,r)=>s.index-r.index)}_setViewParameters(e,t){const s=this._camera;s.viewport=[0,0,t.resolution,t.resolution],Ir(s.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],s.near,s.far),qr(s.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(At(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const s=new Uint8Array(e*e*4);let r=0;for(let a=0;a<e;a++)for(let n=0;n<e;n++){const o=Math.floor(n/10),l=Math.floor(a/10);o<2||l<2||10*o>e-20||10*l>e-20?(s[r++]=255,s[r++]=255,s[r++]=255,s[r++]=255):(s[r++]=255,s[r++]=255,s[r++]=255,s[r++]=1&o&&1&l?1&n^1&a?0:255:1&o^1&l?0:128)}const i=new Gt(e);i.samplingMode=9728,this._passParameters.texture=new et(this._rctx,i,s)}get test(){}};c([v()],q.prototype,"hasHighlights",void 0),c([v()],q.prototype,"renderOccludedFlags",void 0),c([v()],q.prototype,"_sortedDrapeSourceRenderersDirty",void 0),c([v({constructOnly:!0})],q.prototype,"parent",void 0),c([v({readOnly:!0})],q.prototype,"_techniques",null),c([v({type:Boolean,readOnly:!0})],q.prototype,"updating",null),c([v()],q.prototype,"isEmpty",null),q=c([L("esri.views.3d.terrain.OverlayRenderer")],q);class da{constructor(t,s,r){this.drapeSource=t,this.renderer=s,this.index=r}}const ga=[[1,.5,.5],[.5,.5,1]],ys=-2,vt=4,xt=new ms;xt.hasAlpha=!0;let pa=class{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=V(),this._shaderTransformation=null,this._boundingSphere=null,this.id=Bs(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){Lr(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??=V(),$e(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??=Ar(),jr(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*Wr(this.shaderTransformation)),this._boundingSphere):Hr}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};class bs extends sr{intersect(t,s,r,i,a,n){return rr(t,r,i,a,void 0,n)}intersectDraped(t,s,r,i){return ir(r[0],r[1],t,i)}}function ws(e){const t=new B,{vertex:s,fragment:r,attributes:i,varyings:a}=t,{hasVVColor:n,hasVertexColors:o}=e;return ar(s,e),t.include(nr),t.include(or,e),t.include(hr,e),t.include(lr,e),r.include(cr,e),t.include(ur,e),t.include(dr,e),i.add("position","vec3"),n&&i.add("colorFeatureAttribute","float"),o||a.add("vColor","vec4"),a.add("vpos","vec3",{invariant:!0}),s.uniforms.add(new gr("uColor",l=>l.color)),s.main.add(I`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${o?"vColor *= uColor;":n?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      gl_Position = transformPosition(proj, view, vpos);`),r.include(pr),r.main.add(I`discardBySlice(vpos);
discardByTerrainDepth();
outputColorHighlightOID(vColor, vpos, vColor.rgb);`),t}const _a=Object.freeze(Object.defineProperty({__proto__:null,build:ws},Symbol.toStringTag,{value:"Module"}));class fa extends G{constructor(t,s){super(t,s,new N(_a,()=>import("./ImageMaterial.glsl-Bbyc7v8n.js").then(r=>r.C)),Cs(s).locations)}_createPipeline(t,s){const{oitPass:r,output:i,transparent:a,cullFace:n,draped:o,hasOccludees:l,polygonOffset:g}=t,d=r===0;return U({blending:It(i)&&a?wr(r):null,culling:Zr(n),depthTest:o?null:{func:br(r)},depthWrite:yr(t),drawBuffers:xr(i,Cr(r,i)),colorWrite:k,stencilWrite:l?vr:null,stencilTest:l?s?fr:mr:null,polygonOffset:d?g?ma:null:_r(t)})}initializePipeline(t){return this._occludeePipelineState=this._createPipeline(t,!0),this._createPipeline(t,!1)}getPipeline(t){return t?this._occludeePipelineState:super.getPipeline()}}const ma={factor:1,units:1};function Cs(e){const t=K().vec3f("position");return Rt()&&t.vec4u8("olidColor"),e.hasVVColor?t.f32("colorFeatureAttribute"):t.vec4u8("color"),t.freeze()}let F=class extends Sr{constructor(){super(...arguments),this.cullFace=0,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.snowCover=!1}};c([O({count:3})],F.prototype,"cullFace",void 0),c([O()],F.prototype,"hasVertexColors",void 0),c([O()],F.prototype,"transparent",void 0),c([O()],F.prototype,"discardInvisibleFragments",void 0),c([O()],F.prototype,"polygonOffset",void 0),c([O()],F.prototype,"enableOffset",void 0),c([O()],F.prototype,"writeDepth",void 0),c([O()],F.prototype,"hasOccludees",void 0),c([O()],F.prototype,"terrainDepthTest",void 0),c([O()],F.prototype,"cullAboveTerrain",void 0),c([O()],F.prototype,"hasVVColor",void 0),c([O()],F.prototype,"draped",void 0);class va extends bs{constructor(t){super(t,ya),this._configuration=new F,this.supportsEdges=!0,this.produces=new Map([[2,s=>this._isOpaqueMaterialPass(s)],[3,s=>this._isOpaqueNoSSAODepthPass(s)],[4,s=>Ze(s)&&this._transparent&&this.parameters.writeDepth],[5,s=>qt(s)&&this._transparent&&this.parameters.writeDepth],[8,s=>Ze(s)&&this._transparent&&!this.parameters.writeDepth],[18,s=>Tr(s)]])}getConfiguration(t,s){return super.getConfiguration(t,s,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(t)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=s.hasOccludees,this._configuration.oitPass=s.oitPass,this._configuration.enableOffset=s.camera.relativeElevation<Or,this._configuration.terrainDepthTest=s.terrainDepthTest&&It(t),this._configuration.cullAboveTerrain=s.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=Pr}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(t){return this._isOpaqueMaterialPass(t)||this._isOpaqueNoSSAODepthPass(t)}_isOpaqueMaterialPass(t){return t===9||Ze(t)&&!this._transparent}_isOpaqueNoSSAODepthPass(t){return qt(t)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(t){return new xa(t)}createBufferWriter(){return new Fr(Cs(this.parameters))}}class xa extends Dr{beginSlot(t){return this.getTechnique(fa,t)}}class ya extends Rr{constructor(){super(...arguments),this.color=ks,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.draped=!1,this.discardInvisibleFragments=!1}}const w={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},ba={dash:w.dash,"dash-dot":[...w.dash,...w.dot],dot:w.dot,"long-dash":w["long-dash"],"long-dash-dot":[...w["long-dash"],...w.dot],"long-dash-dot-dot":[...w["long-dash"],...w.dot,...w.dot],none:null,"short-dash":w["short-dash"],"short-dash-dot":[...w["short-dash"],...w["short-dot"]],"short-dash-dot-dot":[...w["short-dash"],...w["short-dot"],...w["short-dot"]],"short-dot":w["short-dot"],solid:null},wa=8;function Ca(e,t){return e==null?e:{pattern:e.slice(),pixelRatio:t}}function Sa(e){return{pattern:[e,e],pixelRatio:2}}function Ta(e){return e?.type==="style"?Oa(e.style):null}function Oa(e){return e!=null?Ca(ba[e],wa):null}function Pa(e,t,s,r){const i=e.type==="polygon"?1:0,a=e.type==="polygon"?e.rings:e.paths,{position:n,outlines:o}=Et(a,!!e.hasZ,i,e.spatialReference),l=yt(n.length),g=ei(n,e.spatialReference,0,l,0,n,0,n.length/3,t,s,r),d=g!=null;return{lines:d?Ss(o,n,l):[],projectionSuccess:d,sampledElevation:g}}function Fa(e,t){const s=e.type==="polygon"?1:0,r=e.type==="polygon"?e.rings:e.paths,{position:i,outlines:a}=Et(r,!1,s),n=Xs(i,e.spatialReference,0,i,t,0);for(let o=2;o<i.length;o+=3)i[o]=ys;return{lines:n?Ss(a,i):[],projectionSuccess:n}}function Ss(e,t,s=null){const r=new Array;for(const{index:i,count:a}of e){if(a<=1)continue;const n=3*i,o=3*a;r.push({position:Ft(t,3*i,3*a),mapPositions:s!=null?Ft(s,n,o):void 0})}return r}const Ra=K().vec3f("position").freeze(),Da=K().vec3f("position").vec2f16("uv0").freeze(),Ma=K().vec3f("position").vec4u8("color").freeze(),Va=K().vec3f("position").vec2f("uv0").freeze(),za=K().vec3f("position").vec2f("uv0").vec4u8("olidColor").freeze();export{Qt as A,ys as B,mt as C,vs as D,ws as E,Yi as a,Va as b,za as c,Sa as d,Da as e,gi as f,$t as g,pa as h,bs as i,nt as j,es as k,rt as l,va as m,Ta as n,Ra as o,Fa as p,it as q,Ut as r,Pa as s,Jt as t,zi as u,Ma as v,A as w,ve as x,ss as y,st as z};
