import{eP as G,dk as k,z as j,h$ as q,i0 as K,go as Q}from"./main-6gYsRPh_.js";import{a as W,i as X}from"./MeshLocalVertexSpace-B9suo1p1.js";import{n as Z,d as ee}from"./vec3-BhlTAa4r.js";import"./workers-B0AxzjrU.js";import"./projectionUtils-CVhOpzeN.js";import"./projectBuffer-gVgthDoV.js";import"./projectVectorToVector-D420nist.js";function te(){return M??=(async()=>await(await import("./i3s-CHPDCNpE.js")).default({locateFile:e=>G(`esri/libs/i3s/${e}`)}))(),M}function re(){M=null}let M;class oe{constructor(t,r,a,s,c,i){this.layout=t,this.interleavedVertexData=r,this.indices=a,this.hasColors=s,this.hasModifications=c,this.positionData=i}}let ne=class{constructor(e,t,r,a,s,c,i){this.componentOffsets=e,this.featureIds=t,this.anchorIds=r,this.anchors=a,this.transformedGeometry=s,this.globalTrafo=c,this.obb=i}};new k({deallocator:null});async function se(e){o=await g();const t=[e.geometryBuffer];return{result:C(o,e,t),transferList:t}}async function ae(e){o=await g();const t=[e.geometryBuffer],{geometryBuffer:r}=e,a=r.byteLength,s=o._malloc(a),c=new Uint8Array(o.HEAPU8.buffer,s,a);c.set(new Uint8Array(r));const i=o.dracoDecompressPointCloudData(s,c.byteLength);if(o._free(s),i.error.length>0)throw new Error(`i3s.wasm: ${i.error}`);const m=i.featureIds?.length>0?i.featureIds.slice():null,y=i.positions.slice();return m&&t.push(m.buffer),t.push(y.buffer),{result:{positions:y,featureIds:m},transferList:t}}async function ie(e){await g(),H(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function fe(e){await g(),D(e)}async function ce(e){o=await g(),o.setLegacySchema(e.context,e.jsonSchema)}async function le(e){const{localMatrix:t,origin:r,positions:a,vertexSpace:s}=e,c=j.fromJSON(e.inSpatialReference),i=j.fromJSON(e.outSpatialReference),m=t?q(t):void 0,y=K(r);let l;const[{projectBuffer:A},{initializeProjection:S}]=await Promise.all([import("./projectBuffer-gVgthDoV.js").then(f=>f.p),import("./projectionUtils-CVhOpzeN.js").then(f=>f.p)]);await S(c,i);const h=[0,0,0];if(!A(y,c,0,h,i,0))throw new Error("Failed to project");if(s.type==="georeferenced"&&s.origin==null){if(l=new Float64Array(a.length),!A(a,c,0,l,i,0,l.length/3))throw new Error("Failed to project")}else{const f=s.type==="georeferenced"?W.fromJSON(s):X.fromJSON(s),{projectMeshVertexPositions:d}=await import("./projectMeshVertexPositions-BehiC9jL.js"),E=d({vertexAttributes:{position:a},transform:m?{localMatrix:m}:void 0,vertexSpace:f,spatialReference:c},i);if(!E)throw new Error("Failed to project");l=E}const L=l.length,[w,_,u]=h;for(let f=0;f<L;f+=3)l[f]-=w,l[f+1]-=_,l[f+2]-=u;return{result:{projected:l,original:a,projectedOrigin:h},transferList:[l.buffer,a.buffer]}}async function ue({normalMatrix:e,normals:t}){const r=new Float32Array(t.length);return Z(r,t,e),Q(e)&&ee(r,r),{result:{transformed:r,original:t},transferList:[r.buffer,t.buffer]}}function me(e){Y(e)}let B,o;function D(e){if(!o)return;const t=e.modifications,r=o._malloc(8*t.length),a=new Float64Array(o.HEAPU8.buffer,r,t.length);for(let s=0;s<t.length;++s)a[s]=t[s];o.setModifications(e.context,r,t.length,e.isGeodetic),o._free(r)}function C(e,t,r){const{context:a,globalTrafo:s,mbs:c,obbData:i,elevationOffset:m,geometryBuffer:y,geometryDescriptor:l,indexToVertexProjector:A,vertexToRenderProjector:S}=t,h=e._malloc(y.byteLength),L=33,w=e._malloc(L*Float64Array.BYTES_PER_ELEMENT),_=new Uint8Array(e.HEAPU8.buffer,h,y.byteLength);_.set(new Uint8Array(y));const u=new Float64Array(e.HEAPU8.buffer,w,L);x(u,[NaN,NaN,NaN]);let f=u.byteOffset+3*u.BYTES_PER_ELEMENT,d=new Float64Array(u.buffer,f);x(d,s),f+=16*u.BYTES_PER_ELEMENT,d=new Float64Array(u.buffer,f),x(d,c),f+=4*u.BYTES_PER_ELEMENT,i&&(d=new Float64Array(u.buffer,f),x(d,i));const E=l,J={isDraco:!1,isLegacy:!1,color:t.layouts.some(b=>b.some(p=>p.name==="color")),normal:t.needNormals&&t.layouts.some(b=>b.some(p=>p.name==="normalCompressed")),uv0:t.layouts.some(b=>b.some(p=>p.name==="uv0")),uvRegion:t.layouts.some(b=>b.some(p=>p.name==="uvRegion")),featureIndex:E.featureIndex},n=e.process(a,!!t.obbData,h,_.byteLength,E,J,w,m,A,S,t.normalReferenceFrame);if(e._free(w),e._free(h),n.error.length>0)throw new Error(`i3s.wasm: ${n.error}`);if(n.discarded)return null;const F=n.componentOffsets.length>0?n.componentOffsets.slice():null,P=n.featureIds.length>0?n.featureIds.slice():null,V=n.anchorIds.length>0?Array.from(n.anchorIds):null,$=n.anchors.length>0?Array.from(n.anchors):null,N=n.interleavedVertedData.slice().buffer,O=n.indicesType===1?new Uint16Array(n.indices.buffer,n.indices.byteOffset,n.indices.byteLength/2).slice():new Uint32Array(n.indices.buffer,n.indices.byteOffset,n.indices.byteLength/4).slice(),T=n.positions.slice(),{buffer:v,byteOffset:I,byteLength:R}=n.positionIndices,U=n.positionIndicesType===1?new Uint16Array(v,I,R/2).slice():new Uint32Array(v,I,R/4).slice(),z=new oe(t.layouts[0],N,O,n.hasColors,n.hasModifications,{data:T,indices:U});return P&&r.push(P.buffer),F&&r.push(F.buffer),r.push(N),r.push(O.buffer),r.push(T.buffer),r.push(U.buffer),new ne(F,P,V,$,z,s,n.obb)}function ye(e){return e===0?0:e===1?1:e===2?2:3}function H(e){if(!o)return;const{context:t,buffer:r}=e,a=o._malloc(r.byteLength),s=r.byteLength/Float64Array.BYTES_PER_ELEMENT,c=new Float64Array(o.HEAPU8.buffer,a,s),i=new Float64Array(r);c.set(i),o.filterOBBs(t,a,s),i.set(c),o._free(a)}function Y(e){o&&o.destroy(e)===0&&(o=null,B=null,re())}function x(e,t){for(let r=0;r<t.length;++r)e[r]=t[r]}async function he(){o||await g()}async function g(){return o||(o=await(B??=te())),o}const de={transform:(e,t)=>o&&C(o,e,t),destroy:Y};export{me as destroyContext,ae as dracoDecompressPointCloudData,ie as filterObbsForModifications,H as filterObbsForModificationsSync,he as initialize,ye as interpretObbModificationResults,se as process,le as project,ce as setLegacySchema,fe as setModifications,D as setModificationsSync,de as test,ue as transformNormals};
