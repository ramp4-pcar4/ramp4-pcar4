import{H as x,_ as E,X as L,Y as T,G as m,dh as $,$ as D}from"./main-6gYsRPh_.js";import{o as W}from"./uuid-CFz2qBzH.js";const V=W(),H=new Map,A=new Map;async function q(e,r,a){if(!e||!a)return!1;if(!r)return!0;const t=new URL(e).host;let n=H.get(t);if(!n){const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");n=(await x(d,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return n===r}async function B(e,r,a=!1){if(!e||!r)return!0;const t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=A.get(t)?.entries();if(n){for(const[d,s]of n)if(s.name===r){const c=!s.stack?.hasForwardEdits();if(!c&&a){const[{deleteForwardEdits:o},{default:u}]=await Promise.all([import("./deleteForwardEdits-Duuz4JsF.js"),import("./DeleteForwardEditsParameters-B4G5aMBr.js")]),h=await o(t,d,new u({sessionId:V,moment:s.moment}));return h.success&&s.stack?.clearForwardEdits(),h.success}return c}}return!0}function S(e,r){if(!e)return!1;const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=A.get(a)?.entries();if(t){for(const[n,d]of t)if(d.name===r)return d.lockType==="edit"}return!1}const M=new $;function P(e){return M.on("apply-edits",new WeakRef(e))}function X(e){return M.on("update-moment",new WeakRef(e))}function Y(e,r,a=null,t=!1){const n=D();return t=r==null||t,M.emit("apply-edits",{serviceUrl:e,layerId:r,gdbVersion:a,mayReceiveServiceEdits:t,result:n.promise}),n}const U=Symbol();function z(e){return e!=null&&typeof e=="object"&&U in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function I(e,r,a){const t=new URL(e).host,n=H.get(t),d=s=>!s||s===n;return d(r)&&d(a)||r===a}const C=e=>{var r;const a=e;let t=class extends a{static{r=U}constructor(...n){super(...n),this[r]=!0,this._applyEditsHandler=d=>{const{serviceUrl:s,layerId:c,gdbVersion:o,mayReceiveServiceEdits:u,result:h}=d,b=s===this.url,f=c!=null&&this.layerId!=null&&c===this.layerId,_=p(this),R=p(this)&&I(s,o,this.gdbVersion);if(!b||_&&!R||!f&&!u)return;const k=h.then(i=>{if(this.lastEditsEventDate=new Date,f&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",m(i)),i;const y=i.editedFeatures?.find(({layerId:F})=>F===this.layerId);if(y){const{adds:F,updates:v,deletes:w}=y.editedFeatures,j={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:w?w.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:v?v.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:m(i.editedFeatures),exceededTransferLimit:!1,historicMoment:m(i.historicMoment)};return this.emit("edits",j),j}const g={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:m(i.editedFeatures),exceededTransferLimit:!1,historicMoment:m(i.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(s,o,g.historicMoment)&&this.emit("edits",g),g}).then(i=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(s,o,i.historicMoment)&&(this.historicMoment=i.historicMoment),i));this.emit("apply-edits",{result:k})},this._updateMomentHandler=d=>{const{serviceUrl:s,gdbVersion:c,moment:o}=d,u=s===this.url,h=p(this),b=p(this)&&I(s,c,this.gdbVersion),f=p(this)&&!I(s,this.gdbVersion,null);u&&h&&b&&f&&"historicMoment"in this&&this.historicMoment!==o&&(this.historicMoment=o)},this.when().then(()=>{this.addHandles(P(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(X(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(n,d,s){return"historicMoment"in this&&this.historicMoment!==s&&S(n,d)}};return E([L()],t.prototype,"lastEditsEventDate",void 0),t=E([T("esri.layers.mixins.EditBusLayer")],t),t};export{C as F,S as a,Y as c,B as i,q as o,z as p,V as t};
