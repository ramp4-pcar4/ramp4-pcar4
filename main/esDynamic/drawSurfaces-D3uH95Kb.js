import{T as lt,c2 as D,lJ as Wt,z as ct,fx as Yt,O as Bt,eE as pt,$ as Jt,_ as c,X as p,Y as Z,N as ut,dh as Kt,bJ as $t,aJ as ht,h6 as N,av as S,V as X,l as dt,eM as W,cr as gt,fd as Y,a8 as B,G as mt,hA as jt,gO as Qt,cl as te}from"./main-6gYsRPh_.js";import{I as ee,x as z,U as ne,t as vt,i as ie,E as yt}from"./elevationInfoUtils-D6sSxLXV.js";import{t as se}from"./ReactiveSet-G8sJZoST.js";import{y as re}from"./diffUtils-CWKV-6UB.js";import{h as ae}from"./UpdatingHandles-CUtaE4aF.js";import{g as J,e as K,w as oe,a as le,V as ce}from"./SnappingContext-DKzwIwe8.js";import{W as R}from"./projectionUtils-CVhOpzeN.js";import{c as pe}from"./meshVertexSpaceUtils-CMg5-woj.js";import{x as H,k as ue}from"./hydratedFeatures-Bn0H0sZ5.js";import{f as M,T as $,U as he,Z as ft,V as de,W as _t,X as ge,D as me,Y as ve,j as ye,_ as xt,$ as fe,a0 as _e}from"./SketchViewModel-oZSiDZG2.js";import{v as j,c as xe,a as be}from"./quantityUtils-rkblFPCW.js";import{c as Pe,s as we,u as Se}from"./vec32-y2_p7lFt.js";import{n as G,t as Q}from"./projectVectorToVector-D420nist.js";import{N as Me}from"./geodesicUtils-8mhrMpeD.js";import{R as T,j as bt,U as Te}from"./angularMeasurementUtils-BzYk8gIS.js";import{G as Pt,f as wt}from"./Scheduler-DIvkTrPN.js";function V(t,e){return t===e||t!=null&&e!=null&&lt(t.spatialReference,e.spatialReference)&&t.x===e.x&&t.y===e.y&&t.z===e.z&&t.m===e.m}function tt(t,e,n){return t===e||t!=null&&e!=null&&lt(t.spatialReference,e.spatialReference)&&D(t.x,e.x,n)&&D(t.y,e.y,n)&&D(t.z??0,e.z??0,n)&&D(t.m??0,e.m??0,n)}function Ee(t,e,n,i,s,r){let o="geodesic",a=Me(n);const l=M();return $(t,e,i,l),l[2]=0,a&&G(l,n,l,a)||(o="euclidean",a=n),{mode:o,view:e,elevationInfo:i,hasZ:s,directionMode:r,spatialReference:t.spatialReference,measurementSR:a,origin:l}}function Ce(t,e,n){if(e==null||t==null)return;const i=Wt(n.measurementSR);if(i==null)return;const s=A(t,n);if(s==null)return;const r=j(e,i);return new de(s,r)}function Oe(t,e,n,i){if(n==null||t==null)return;const s=A(t,i);if(s==null)return;const r=T(n),o=10,a=u=>{if(u==null)return;const d=M(),m=xe(u,"degrees","geographic");return Te(d,s,i.measurementSR,o,m,i.mode)?new me(s,d):void 0},l=()=>{if(e!=null&&t!=null)return T(bt(e,t))};switch(i.directionMode){case"absolute":return a(r);case"relative":{const u=l();return u==null?void 0:a(u+r)}case"relative-bilateral":{const u=l();return u==null?void 0:_t([a(u+r),a(u-r)])}}}function St(t,e){const n=k(t,e);return n!=null?new ge(n):void 0}function Mt(t,e,n){const{context:i,longitude:s,latitude:r,direction:o,distance:a,elevation:l}=n;if(s!=null||r!=null||a!=null||l!=null||o!=null){if(s!=null||r!=null){const u=T(s),d=T(r),m=k(l,i);return new ft(u,d,m)}return Ve(t,e,n)}}function Ve(t,e,{context:n,direction:i,distance:s,elevation:r}){if(e==null)return St(r,n);const{view:o,elevationInfo:a,measurementSR:l}=n,u=$(e,o,a);if(!l||!G(u,e.spatialReference,Et,l))return;const[d,m]=Et,f=s!=null?j(s,"meters"):void 0,g=T(i),C=k(r,n),y=_=>{const w=new ve([d,m],l,f,C,_);return f==null||_==null||C==null&&n.hasZ?w:new ye(w.closestTo(u))};if(g==null)return y(void 0);const P=()=>{if(t!=null&&e!=null)return T(bt(t,e))};switch(n.directionMode){case"absolute":return y(g);case"relative":{const _=P();return _==null?void 0:y(_+g)}case"relative-bilateral":{const _=P();return _==null?void 0:_t([y(_+g),y(_-g)])}}}function Ie(t){return t.context.mode==="geodesic"?Mt(null,null,t):Tt(t)}function De(t,e,n){const{context:i,x:s,y:r,distance:o,direction:a,elevation:l}=n;return i.mode==="geodesic"?Mt(e,t,n):s!=null||r!=null?Tt(n):Ze([Ce(t,o,i),Oe(t,e,a,i),St(l,i)])}function Tt({x:t,y:e,elevation:n,context:i}){F.x=t?.value??0,F.y=e?.value??0,F.spatialReference=i.spatialReference;const s=A(F,i,He);return new ft(t!=null&&s!=null?s[0]:void 0,e!=null&&s!=null?s[1]:void 0,k(n,i))}function Ze(t){let e;for(const n of t)n&&(e=e?.intersect(n)??n);return e}function A(t,e,n=M()){const{view:i,elevationInfo:s,measurementSR:r,origin:o,mode:a}=e;if($(t,i,s,n),G(n,t.spatialReference,n,r))return a!=="geodesic"&&Pe(n,n,o),n}function ze(t,e,n,i){const{view:s,measurementSR:r,spatialReference:o,origin:a,mode:l}=n;if(l==="geodesic"?we(I,t):Se(I,t,a),G(I,r,I,o))return he(I,s,e,n,i)}function k(t,e){return Re(t,e)?.value??void 0}function Re(t,{view:e,origin:n,elevationInfo:i,hasZ:s,measurementSR:r}){if(t==null||!s)return;const o=Yt(r);if(o==null)return;const[a,l]=n,u=j(t,o),d=e?.type==="3d"?ee(e,a,l,u,r,i):u;return d!=null?be(d,o):void 0}const Et=M(),He=M(),I=M(),F=Q(0,0,0,ct.WGS84);class Ge{constructor(){this._isToolEditable=!0,this._manipulators=new Bt,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(e){this._isToolEditable=e}get length(){return this._manipulators.length}add(e,n=0){this.addMany([e],n)}addMany(e,n=0){for(const i of e){const s={manipulator:i,visibilityPredicate:n,attached:!1};this._manipulators.add(s),this._attached&&this._updateManipulatorAttachment(s)}}remove(e){for(let n=0;n<this._manipulators.length;n++)if(this._manipulators.at(n).manipulator===e){const i=this._manipulators.splice(n,1)[0];this._detachManipulator(i);break}}removeAll(){this._manipulators.forEach(e=>{this._detachManipulator(e)}),this._manipulators.removeAll()}attach(){this._manipulators.forEach(e=>{this._updateManipulatorAttachment(e)}),this._attached=!0}detach(){this._manipulators.forEach(e=>{this._detachManipulator(e)}),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach(({manipulator:e})=>e.destroy()),this._manipulators.destroy(),this._resourceContexts=null}on(e,n){return this._manipulators.on(e,i=>{n(i)})}forEach(e){for(const n of this._manipulators.items)e(n)}some(e){return this._manipulators.items.some(e)}toArray(){const e=[];return this.forEach(n=>e.push(n.manipulator)),e}intersect(e,n){let i=null,s=Number.MAX_VALUE;return this._manipulators.forEach(({manipulator:r,attached:o})=>{if(!o||!r.interactive)return;const a=r.intersectionDistance(e,n);a!=null&&a<s&&(s=a,i=r)}),i}_updateManipulatorAttachment(e){this._isManipulatorItemVisible(e)?this._attachManipulator(e):this._detachManipulator(e)}_attachManipulator(e){e.attached||(e.manipulator.attach&&e.manipulator.attach(this._resourceContexts),e.attached=!0)}_detachManipulator(e){if(!e.attached)return;const n=e.manipulator;n.grabbing=!1,n.dragging=!1,n.hovering=!1,n.selected=!1,n.detach&&n.detach(this._resourceContexts),e.attached=!1}_isManipulatorItemVisible(e){return e.visibilityPredicate===2||(this._isToolEditable?e.visibilityPredicate===0:e.visibilityPredicate===1)}}let v=class extends pt{constructor(t){super(t),this.manipulators=new Ge,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[1,!0],[0,!0]]),this._creationFinishedResolver=Jt()}get active(){return this.view!=null&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(0)}set editable(t){this.setEditableFlag(0,t)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){this.view!=null&&(this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}cancel(){this.emit("cancel")}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,e){this._editableFlags.set(t,e),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===0&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(t){return this._editableFlags.get(t)??!1}endDrag(){const t=this.view.inputManager.latestPointerInfo?.location;if(!t)return;let e=!1;this.manipulators.forEach(({manipulator:n})=>{n.dragging&&(e=!0,n.events.emit("drag",{action:"end",start:t,screenPoint:t}))}),e&&(this.view.toolViewManager.activeTool=null)}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(0)&&this.getEditableFlag(1)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized){if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};c([p({constructOnly:!0})],v.prototype,"view",void 0),c([p({readOnly:!0})],v.prototype,"active",null),c([p({value:!0})],v.prototype,"visible",null),c([p({value:!0})],v.prototype,"editable",null),c([p({readOnly:!0})],v.prototype,"manipulators",void 0),c([p({readOnly:!0})],v.prototype,"updating",null),c([p()],v.prototype,"cursor",null),c([p({readOnly:!0})],v.prototype,"automaticManipulatorSelection",void 0),c([p()],v.prototype,"hasFocusedManipulators",null),c([p()],v.prototype,"hasGrabbedManipulators",void 0),c([p()],v.prototype,"hasHoveredManipulators",void 0),c([p()],v.prototype,"firstGrabbedManipulator",void 0),c([p({readOnly:!0})],v.prototype,"created",void 0),c([p({readOnly:!0})],v.prototype,"removeIncompleteOnCancel",void 0),v=c([Z("esri.views.interactive.InteractiveToolBase")],v);const Ct="click";let x=class extends ut{constructor(t){super(t),this.events=new Kt,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0}intersectionDistance(t,e){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}};c([p()],x.prototype,"interactive",void 0),c([p()],x.prototype,"selectable",void 0),c([p()],x.prototype,"cursor",void 0),c([p()],x.prototype,"grabbing",void 0),c([p()],x.prototype,"grabbable",void 0),c([p()],x.prototype,"consumesClicks",void 0),c([p()],x.prototype,"grabbableForEvent",void 0),c([p()],x.prototype,"dragging",void 0),c([p()],x.prototype,"hovering",void 0),c([p()],x.prototype,"selected",void 0),x=c([Z("esri.views.draw.LegacyDrawManipulator")],x);function Ae(t,e){let n=null,i=null;return s=>{if(s.action==="cancel")return void(i!=null&&(i.execute({action:"cancel"}),n=null,i=null));const r={action:s.action,screenStart:s.start,screenEnd:s.screenPoint};s.action==="start"&&n==null&&(n=new E,i=new E,e(t,n,i,s.pointerType,r)),n?.execute(r),s.action==="end"&&n!=null&&(n=null,i=null)}}function L(t,e){return t.events.on("drag",Ae(t,e))}function ke(t,e){const n=[t.x,t.y,t.z??0],i=e,s=[Math.cos(i),Math.sin(i)],r=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(r===0)return null;s[0]/=r,s[1]/=r;const o=a=>{const l=(a.x-n[0])*s[0]+(a.y-n[1])*s[1];a.x=n[0]+l*s[0],a.y=n[1]+l*s[1]};return a=>(o(a.mapStart),o(a.mapEnd),{...a,axis:s})}function Ot(t){let e=null;const n=Dt();return i=>{if(i.action==="start"&&(e=Fe(t,i.mapStart.spatialReference)),e==null)return null;const s=n(i);if(!s)return null;const{translationX:r,translationY:o,translationZ:a}=s;return e.move(r,o,a,i.action),s}}function Vt(t,e){return t==null?null:t.spatialReference.equals(e)?t.clone():R(t,e)}function Fe(t,e){const n=t.operations;if(!n)return null;const i=n.data.geometry,s=ue(e);if(i.spatialReference.equals(s))return et(t,n,()=>{});if(i.type!=="mesh"){const r=Vt(i,s);if(r==null)return null;const o=i.spatialReference,a=J.fromGeometry(r,n.viewingMode);return et(t,a,()=>{const l=a.data.geometry,u=R(l,o);n.trySetGeometry(u)})}if(pe(i)){const r=Vt(i.origin,s);if(!r)return null;const o=i.spatialReference,a=J.fromGeometry(r,n.viewingMode);return et(t,n,()=>{const l=R(a.data.geometry,o),u=l.x-i.origin.x,d=l.y-i.origin.y,m=(l.z??0)-(i.origin.z??0);n.move(u,d,m)})}return null}function et(t,e,n){let i=0,s=0,r=0;return{move:(o,a,l,u)=>{u==="start"&&(i=0,s=0,r=0);const d=o-i,m=a-s,f=l-r;e.move(d,m,f),i+=d,s+=m,r+=f,n(),u==="end"&&t.endInteraction?.()}}}function Le(t,e=null,n){let i=null;const s=e==null||t.spatialReference?.equals(e)?o=>o:o=>o!=null?R(o,e):o,r={exclude:[],...n};return o=>{if(o.action==="start"&&(i=s(t.toMap(o.screenStart,r))),i==null)return null;const a=s(t.toMap(o.screenEnd,r));return a!=null?{...o,mapStart:i,mapEnd:a}:null}}function Ue(t){const e=t.map(i=>Ot(i)).filter($t),n=Dt();return i=>{const s=n(i);return e.forEach(r=>r(i)),s}}function It(t){const e=t.operations?.createResetState();return n=>(e?.remove(),n)}function qe(t){const e=t.map(n=>It(n)).filter(n=>n!=null);return n=>(e.forEach(i=>i(n)),n)}function Ne(){let t=0,e=0,n=0;return i=>{i.action==="start"&&(t=i.mapStart.x,e=i.mapStart.y,n=i.mapStart.z??0);const s=i.mapEnd.x-t,r=i.mapEnd.y-e,o=(i.mapEnd.z??0)-n;return t=i.mapEnd.x,e=i.mapEnd.y,n=i.mapEnd.z,{...i,mapDeltaX:s,mapDeltaY:r,mapDeltaZ:o,mapDeltaSpatialReference:i.mapStart.spatialReference}}}function Dt(){let t=0,e=0,n=0;return i=>{i.action==="start"&&(t=i.mapStart.x,e=i.mapStart.y,n=i.mapStart.z??0);const s=i.mapEnd.x-t,r=i.mapEnd.y-e,o=(i.mapEnd.z??0)-n;return{...i,translationX:s,translationY:r,translationZ:o}}}function Xe(){let t=0,e=0;return n=>{n.action==="start"&&(t=n.screenStart.x,e=n.screenStart.y);const i=n.screenEnd.x-t,s=n.screenEnd.y-e;return t=n.screenEnd.x,e=n.screenEnd.y,{...n,screenDeltaX:i,screenDeltaY:s}}}function We(t,e){let n=null,i=0,s=0;return r=>{if(r.action==="start"&&(n=t.toScreen?.(e),n!=null&&(n.x<0||n.x>t.width||n.y<0||n.y>t.height?n=null:(i=r.screenStart.x-n.x,s=r.screenStart.y-n.y))),n==null)return null;const o=ht(r.screenEnd.x-i,0,t.width),a=ht(r.screenEnd.y-s,0,t.height),l=N(o,a);return r.screenStart=n,r.screenEnd=l,r}}const Ye=()=>{};class E{constructor(){this.execute=Ye}next(e,n=new E){return e!=null&&(this.execute=i=>{const s=e(i);s!=null&&n.execute(s)}),n}}function Zt(t,e,n=[]){if(t.type==="2d")return s=>s;let i=null;return s=>{s.action==="start"&&(i=t.toMap(s.screenStart,{exclude:n}),i!=null&&(i.z=z(i,t,e)));const r=t.toMap(s.screenEnd,{exclude:n});r!=null&&(r.z=z(r,t,e));const o=i!=null&&r!=null?{sceneStart:i,sceneEnd:r}:null;return{...s,scenePoints:o}}}function zt(t,e,n){const i=e.elevationProvider.getElevation(t.x,t.y,t.z??0,t.spatialReference,"scene")??0,s=H(t);return s.z=i,s.hasZ=!0,s.z=z(s,e,n),s}function Be(t,e){if(t.type==="2d")return i=>i;let n=null;return i=>{i.action==="start"&&(n=zt(i.mapStart,t,e));const s=zt(i.mapEnd,t,e),r=n!=null&&s!=null?{sceneStart:n,sceneEnd:s}:null;return{...i,scenePoints:r}}}function Rt({predicate:t=()=>!0,snappingManager:e,snappingContext:n,updatingHandles:i,useZ:s=!0}){const r=new E;if(e==null)return{snappingStep:[At,r],cancelSnapping:At};let o,a=null,l=null,u=null;const d=()=>{a=X(a),e.doneSnapping(),l?.frameTask.remove(),l=null,o=dt(o),u=null},m=Je(e,s,r);let f=null,g=null,C=null;return{snappingStep:[y=>{if(!t(y))return y;const{action:P}=y;if(P==="start"){const{info:_}=y,w=Ke(e.view);if(l=$e(n,y,w),l.context.selfSnappingZ=null,!s&&_!=null){const O=Qe(n.coordinateHelper,_.handle.part);O!=null&&(l.context.selfSnappingZ={value:O,elevationInfo:n.elevationInfo??ne})}}if(l!=null){const{context:_,originalScenePos:w,originalPos:O}=l,{mapEnd:st,mapStart:rt,scenePoints:Lt}=y,U=Ht(O,nt(st,rt)),at=nt(rt,O),Ut={...y,action:"update"},qt=l.context,q=je(w,Lt),ot=e.update({point:U,scenePoint:q,context:_});if(C=ot,Gt(st,ot,at,s),f=U,g=q,P!=="end"){const{frameTask:Nt}=l;a==null&&(a=new AbortController),u=Xt=>{i.addPromise(W(m({frameTask:Nt,event:Ut,context:qt,point:U,scenePoint:q,delta:at,getLastState:()=>({point:f,scenePoint:g,updatePoint:Xt.forceUpdate?null:C})},a.signal)))},u({forceUpdate:!1}),o==null&&(o=S(()=>e.options.effectiveEnabled,()=>u?.({forceUpdate:!0})))}}return P==="end"&&d(),y},r],cancelSnapping:y=>(d(),y)}}function Je(t,e,n){return gt(async({frameTask:i,point:s,scenePoint:r,context:o,event:a,delta:l,getLastState:u},d)=>{const m=await i.schedule(()=>t.snap({point:s,scenePoint:r,context:o,signal:d}),d);if(m.valid){let f=await i.schedule(()=>m.apply(),d);const g=u();g.point!=null&&s!==g.point&&(f=t.update({point:g.point,scenePoint:g.scenePoint,context:o})),g.updatePoint!=null&&V(f,g.updatePoint)||(Gt(a.mapEnd,f,l,e),n.execute(a))}})}function Ke(t){return t.type==="3d"?t.resourceController.scheduler.registerTask(wt.SNAPPING):Pt}function $e(t,e,n){return{context:new K({editGeometryOperations:t.editGeometryOperations,elevationInfo:t.elevationInfo,pointer:t.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:t.excludeFeature,feature:t.feature,visualizer:t.visualizer}),originalPos:e.snapOrigin!=null?t.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:n}}function Ht(t,[e,n,i]){const s=H(t);return s.x+=e,s.y+=n,s.hasZ&&(s.z+=i),s}function je(t,e){return t==null||e==null?null:Ht(t,nt(e.sceneEnd,e.sceneStart))}function nt(t,e){const n=t.hasZ&&e.hasZ?t.z-e.z:0;return[t.x-e.x,t.y-e.y,n]}function Gt(t,e,[n,i,s],r){t.x=e.x+n,t.y=e.y+i,r&&t.hasZ&&e.hasZ&&(t.z=e.z+s)}function Qe(t,e){if(!t.hasZ())return null;const n=e.vertices;let i=null;for(const s of n){const r=t.getZ(s.pos);if(i!=null&&r!=null&&Math.abs(r-i)>1e-6)return null;i==null&&(i=r)}return i}function At(t){return t}let b=class extends ut{constructor(t){super(t),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=gt(async(e,n,i,s)=>{const r=this._frameTask;if(r==null)return;const o=await r.schedule(()=>n.snap({...e,context:i,signal:s}),s);o.valid&&await r.schedule(()=>{this.stagedPoint=o.apply(),e!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=n.update({...this._snapPoints,context:i}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(t){this._stagedPoint=this.constrainResult(t)}initialize(){const t=this.view.type==="3d"?this.view?.resourceController?.scheduler:null;this._frameTask=t!=null?t.registerTask(wt.SNAPPING):Pt}destroy(){this._abortController=X(this._abortController),this._frameTask=dt(this._frameTask)}update(t,e,n){this._snapPoints=t;const{point:i,scenePoint:s}=t,r=e.update({point:i,scenePoint:s,context:n});return this.stagedPoint=r,r}async snap(t,e,n){const{point:i,scenePoint:s}=t;return this.stagedPoint=e.update({point:i,scenePoint:s,context:n}),this._snapPoints=t,this._abortController==null&&(this._abortController=new AbortController),this._snap(t,e,n,this._abortController.signal)}async snapAgainNearPreviousMapPoint(t,e){this._snapPoints!=null&&await this.snap(this._snapPoints,t,e)}abort(){this._abortController=X(this._abortController),this._snapPoints=null}};c([p({constructOnly:!0})],b.prototype,"view",void 0),c([p()],b.prototype,"stagedPoint",null),c([p()],b.prototype,"constrainResult",void 0),c([p()],b.prototype,"_stagedPoint",void 0),b=c([Z("esri.views.interactive.snapping.SnappingOperation")],b);const tn="crosshair",en="progress",kt=Symbol(),Ft=Symbol();let h=class extends pt{constructor(t){super(t),this._createOperationCompleted=!1,this._hideDefaultCursor=!1,this._pointerDownStates=new se,this._stagedScreenPoint=null,this._stagedPointerType=null,this._updatingHandles=new ae,this._stagedPointerId=null,this.constraintsEnabled=!1,this.constraints=void 0,this._getPointConstraint=vt(Ie),this._getPolylineOrPolygonConstraint=vt(De),this.constraintZ=null,this.defaultZ=null,this.isDraped=!0,this.labelOptions=new xt,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.firstVertex=null,this.lastVertex=null,this.secondToLastVertex=null,t.elevationInfo==null&&(this.elevationInfo=ie(!!t.hasZ))}initializePointer(){const t=this.view.inputManager?.latestPointerInfo;t!=null&&this._updatePointer(t.location,t.id,t.type)}initialize(){const{geometryType:t,view:e}=this,n=e.spatialReference,i="viewingMode"in e.state?e.state.viewingMode:2,s=t==="segment"||t==="multipoint"?"polyline":t;this.coordinateHelper=oe(this.hasZ,this.hasM,n),this._editGeometryOperations=new J(new le(s,this.coordinateHelper),i),this._snappingOperation=new b({view:e}),this.addHandles([S(()=>({stagedPoint:this._snappingOperation.stagedPoint,constraint:this._constraint}),({stagedPoint:a,constraint:l},u)=>{const{snappingOptions:d}=this;if(d&&(d.forceDisabled=l!=null&&fe(l)),u!=null&&a===u.stagedPoint&&l!==u.constraint)return this._onKeyboardBasedChange();this._processCursor(a??this._screenToMap(this._stagedScreenPoint))},{equals:(a,l)=>a.stagedPoint===l.stagedPoint&&jt(a.constraint,l.constraint)}),S(()=>this.view.viewpoint,(a,l)=>{a&&l&&re(a,l)&&this._onKeyboardBasedChange()})]),this._activePart=new ce(n,i),this._editGeometryOperations.data.parts.push(this._activePart);const r=this.segmentLabels;r!=null&&(r.context={view:e,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions,automaticLengthMeasurementUtils:this.automaticLengthMeasurementUtils},this.addHandles(S(()=>this.labelOptions.enabled,a=>{r.visible=a},Y))),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],a=>{const l=a.vertices.map(g=>({componentIndex:0,vertexIndex:g.index,coordinates:this.coordinateHelper.vectorToArray(g.pos)})),u=l.map(g=>g.coordinates),d=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.getFirstVertex()?.pos)??null;V(d,this.firstVertex)||(this.firstVertex=d);const m=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.getLastVertex()?.pos)??null;V(m,this.lastVertex)||(this.lastVertex=m);const f=this.coordinateHelper.vectorToDehydratedPoint(this._activePart.segments.at(-1)?.leftVertex?.pos)??null;switch(V(f,this.secondToLastVertex)||(this.secondToLastVertex=f),this._processCursor(this.cursorVertex),a.type){case"vertex-add":this.emit(a.type,{...a,added:u,vertices:l});break;case"vertex-update":this.emit(a.type,{...a,updated:u,vertices:l});break;case"vertex-remove":this.emit(a.type,{...a,removed:u,vertices:l})}}));const o=this._manipulator=new x({consumesClicks:!1,grabbableForEvent:a=>this.drawingMode!=="click"||a.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(o),o.grabbable=t!=="point"&&t!=="multipoint",this.addHandles([o.events.on("immediate-click",a=>this._onImmediateClick(a)),o.events.on("immediate-double-click",a=>this._onImmediateDoubleClick(a)),S(()=>this.drawingMode,()=>{this.removeHandles(kt),this.addHandles(this._createManipulatorDragPipeline(o),kt)},Y),S(()=>({effectiveCursor:this.effectiveCursor}),({effectiveCursor:a})=>{o.cursor=a},Y)]),_e(this,()=>{const a=this.view.inputManager.latestPointerInfo?.type??"mouse",l=this._getSnappingContext(a);if(this.snappingManager!=null){const u=this._snappingOperation.snapAgainNearPreviousMapPoint(this.snappingManager,l);this._updatingHandles.addPromise(W(u))}})}destroy(){B(this.segmentLabels),B(this._snappingOperation),this._editGeometryOperations=B(this._editGeometryOperations),this._updatingHandles.destroy()}get _isDragging(){const{_stagedPointerId:t,_manipulator:e}=this;return t!=null&&this._pointerDownStates.has(t)||e.grabbing||!e.interactive}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const t=this._updateAndGetEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==t}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activePart.vertices.map(t=>this.coordinateHelper.vectorToArray(t.pos))}get _constraint(){const{constraints:t,constraintsEnabled:e}=this;if(t&&e)switch(this.geometryType){case"point":case"multipoint":return this._getPointConstraint(t);case"polygon":case"polyline":return this._getPolylineOrPolygonConstraint(this.lastVertex,this.secondToLastVertex,t)}}set drawingMode(t){this._set("drawingMode",t??Ct)}get effectiveCursor(){return this.loading?en:this._hideDefaultCursor?null:this.cursor||tn}get interactive(){return this._manipulator.interactive}set interactive(t){this._manipulator.interactive=t}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activePart.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get cursorVertex(){return this._get("cursorVertex")}get visualizationCursorVertex(){return this._stagedPointerType==="mouse"?this.cursorVertex:null}get committableVertex(){const{cursorVertex:t,lastVertex:e,firstVertex:n,geometryType:i}=this;return i==="polygon"&&tt(t,n)||tt(t,e)?null:t}get updating(){return this._updatingHandles.updating}get geometryIncludingUncommittedVertices(){const{committedVertices:t,committableVertex:e,coordinateHelper:n}=this,i=t.slice();return e!=null&&i.push(n.pointToArray(e)),i}cancel(){this.complete({aborted:!0})}commitStagedVertex(){this._snappingOperation.abort();const{committableVertex:t}=this;t!=null&&this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(t),this._activePart)}complete(t){const e=t?.aborted||!1;this._snappingOperation.abort(),this.snappingManager?.doneSnapping();const{geometryType:n,numCommittedVertices:i}=this,s=n==="multipoint"&&i===0||n==="polyline"&&i<2||n==="polygon"&&i<3;n!=="segment"&&n!=="point"||this.commitStagedVertex(),this._createOperationCompleted=!s,(this.isCompleted||e)&&(this._stagedScreenPoint=null,this._stagedPointerId=null,this._stagedPointerType=null,this._processCursor(null),this.emit("complete",{vertices:this.committedVertices.map((r,o)=>({componentIndex:0,vertexIndex:o,coordinates:r})),aborted:e,type:"complete"}))}onInputEvent(t){switch(t.type){case"pointer-down":this._pointerDownStates.add(t.pointerId);break;case"pointer-up":this._pointerDownStates.delete(t.pointerId)}switch(t.type){case"pointer-move":return this._onPointerMove(t);case"hold":return this._onHold(t)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_processCursor(t){const e=mt(this.cursorVertex),n=mt(t),i=n&&(this._updateAndGetEffectiveDrawSurface()?.constrainZ(n)??n),s=this._snapToClosingVertex(i),r=this._applyConstraints(s);tt(e,r)||(this._set("cursorVertex",r),this.segmentLabels?.set("stagedVertex",r!=null?this.coordinateHelper.pointToVector(r):null),r==null||this._stagedPointerType!=="mouse"?this.emit("cursor-remove"):this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activePart.vertices.length,coordinates:this.coordinateHelper.pointToArray(r)}],operation:"apply",type:"vertex-update"}))}_snapToClosingVertex(t){if(t==null||this._isDragging||this.geometryType!=="polygon"||this.numCommittedVertices<=2)return t;const e=this._mapToScreen(t);if(!e)return t;const n=this._activePart;return this._vertexWithinPointerDistance(n.vertices[0].pos,e)?this.firstVertex:this._vertexWithinPointerDistance(n.vertices.at(-1).pos,e)?this.lastVertex:t}_createManipulatorDragPipeline(t){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(t);case"freehand":return this._createManipulatorDragPipelineFreehand(t);case"hybrid":return this._createManipulatorDragPipelineHybrid(t)}}_createManipulatorDragPipelineClick(t){return L(t,(e,n,i,s)=>{const r=s==="touch"&&this._snappingEnabled;if(this.isCompleted||!r)return;const{snappingStep:o,cancelSnapping:a}=Rt({predicate:()=>r,snappingManager:this.snappingManager,snappingContext:new K({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,feature:this.graphic,pointer:s,visualizer:this.snappingVisualizer,drawConstraints:this.constraints}),updatingHandles:this._updatingHandles,useZ:!this._requiresScenePoint});i=i.next(l=>(r&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),l)).next(a),n.next(this._screenToMapDragEventStep()).next(l=>(l.action==="start"&&(this._processCursor(l.mapStart),(this.geometryType==="segment"||r&&!this.numCommittedVertices)&&this.commitStagedVertex()),l)).next(Zt(this.view,this.elevationInfo)).next(...o).next(l=>(r&&(this._processCursor(l.mapEnd),l.action==="end"&&this.commitStagedVertex()),l)).next(l=>(l.action==="end"&&(this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),l))})}_createManipulatorDragPipelineFreehand(t){return L(t,(e,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this._snappingOperation.abort(),this.committableVertex==null&&this._processCursor(i.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this._processCursor(i.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return i})})}_createManipulatorDragPipelineHybrid(t){return L(t,(e,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this._snappingOperation.abort(),this.addHandles(this._editGeometryOperations.createUndoGroup(),Ft),this._processCursor(i.mapStart),this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this._processCursor(i.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.removeHandles(Ft),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return i})})}get _drawAtFixedElevation(){const{constraintsEnabled:t,constraintZ:e,geometryType:n,numCommittedVertices:i}=this;return t?e!=null||n==="segment"&&i>0:(n==="segment"||n==="polygon")&&i>0}_updateAndGetEffectiveDrawSurface(){const{constraintsEnabled:t,coordinateHelper:e,drawSurface:n,elevationDrawSurface:i,snapToSceneEnabled:s}=this;if(i==null)return n;if(!this.hasZ)return i.defaultZ=null,i;const r=this.elevationInfo?.mode;let o=this.defaultZ,a=t||r==="absolute-height";return s!=null&&(a=s),r==="on-the-ground"&&(a=!1),this._drawAtFixedElevation&&(o=(t?this.constraintZ:null)??e.getZ(this._activePart.vertices[0].pos),a=!1),a?n:(i.defaultZ=o,i)}_mapToScreen(t){return this._updateAndGetEffectiveDrawSurface()?.mapToScreen(t)}_onHold(t){this._snappingOperation.abort(),this.drawingMode==="click"&&t.pointerType==="touch"&&this._snappingEnabled&&this._processCursor(t.mapPoint),t.stopPropagation()}_onImmediateClick(t){if(!(t.pointerType==="mouse"&&t.button===2||this._manipulator.dragging))try{const{drawingMode:e,geometryType:n}=this;this._stagedPointerType=t.pointerType,this._stagedScreenPoint=t.screenPoint;const i=this._screenToMap(t.screenPoint);if(i==null||i==null||e==="freehand"&&n!=="point"&&n!=="multipoint")return;if(this._snappingEnabled&&this.cursorVertex!=null||this._processCursor(i),this.committableVertex==null)return void this.complete();this.commitStagedVertex(),t.pointerType!=="mouse"&&this._processCursor(null),(e==="freehand"&&this.geometryType!=="multipoint"||n==="point"||n==="segment"&&this.numCommittedVertices===2||n==="segment"&&e==="hybrid"&&this.numCommittedVertices===1)&&this.complete()}finally{t.stopPropagation()}}_onImmediateDoubleClick(t){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),t.stopPropagation())}_onPointerMove(t){const e=N(t.x,t.y);this._updatePointer(e,t.pointerId,t.pointerType)&&t.stopPropagation()}_updatePointer(t,e,n){return this._stagedScreenPoint=t,this._stagedPointerType=n,this._stagedPointerId=e,this._isDragging?(this._snappingOperation.abort(),!1):(this._processCursorMovementRelativeToSurface(t,n),!0)}_onKeyboardBasedChange(){this._stagedPointerType==="mouse"&&this._stagedScreenPoint&&this._stagedPointerId!=null&&!this._isDragging?this._processCursorMovementRelativeToSurface(this._stagedScreenPoint,this._stagedPointerType):this._snappingOperation.abort()}_processCursorMovementRelativeToSurface(t,e){const n=this._snappingOperation,i=this._screenToMap(t),s=this._requiresScenePoint?this.drawSurface?.screenToMap(t):null;if(i==null)return this._hideDefaultCursor=!0,this._processCursor(null),void n.abort();this._hideDefaultCursor=!1;const r=this.snappingManager;if(r==null)return this._processCursor(i),void n.abort();const o=this._getSnappingContext(e);this._updatingHandles.addPromise(W(n.snap({point:i,scenePoint:s},r,o)))}_applyConstraints(t){const{_constraint:e,constraints:n}=this;if(!t||!n||!e)return t;const{context:i}=n,s=A(t,i),r=s?e.closestTo(s):void 0;if(!r)return t;const o=ze(r,t,i),a=this.view.type==="2d"||i.elevationInfo.mode!=="absolute-height";return o!=null&&a&&this.constraintZ!=null&&this.hasZ&&(o.z=this.constraintZ),o}_screenToMap(t){return t?this._updateAndGetEffectiveDrawSurface()?.screenToMap(t):null}_screenToMapDragEventStep(){let t=null;return e=>{if(e.action==="start"&&(t=this._screenToMap(e.screenStart)),t==null)return null;const n=this._screenToMap(e.screenEnd);return n!=null?{...e,mapStart:t,mapEnd:n}:null}}_vertexWithinPointerDistance(t,e){const n=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(t));return n!=null&&nn(n,e,25)}_getSnappingContext(t){const e=this._drawAtFixedElevation?this.elevationDrawSurface?.defaultZ:null;return new K({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:t,feature:this.graphic,visualizer:this.snappingVisualizer,selfSnappingZ:e!=null?{value:e,elevationInfo:this.elevationInfo}:null,drawConstraints:this.constraints})}};function nn(t,e,n){const i=t.x-e.x,s=t.y-e.y;return i*i+s*s<=n}c([p()],h.prototype,"_hideDefaultCursor",void 0),c([p()],h.prototype,"_stagedPointerId",void 0),c([p()],h.prototype,"_isDragging",null),c([p()],h.prototype,"_snappingOperation",void 0),c([p()],h.prototype,"_snappingEnabled",null),c([p({constructOnly:!0})],h.prototype,"graphic",void 0),c([p()],h.prototype,"constraintsEnabled",void 0),c([p()],h.prototype,"constraints",void 0),c([p()],h.prototype,"_constraint",null),c([p()],h.prototype,"constraintZ",void 0),c([p()],h.prototype,"defaultZ",void 0),c([p()],h.prototype,"isDraped",void 0),c([p({constructOnly:!0})],h.prototype,"automaticLengthMeasurementUtils",void 0),c([p({value:Ct})],h.prototype,"drawingMode",null),c([p({constructOnly:!0})],h.prototype,"elevationDrawSurface",void 0),c([p({constructOnly:!0})],h.prototype,"elevationInfo",void 0),c([p({constructOnly:!0,type:xt})],h.prototype,"labelOptions",void 0),c([p({constructOnly:!0})],h.prototype,"geometryType",void 0),c([p({constructOnly:!0})],h.prototype,"hasM",void 0),c([p({constructOnly:!0})],h.prototype,"hasZ",void 0),c([p()],h.prototype,"cursor",void 0),c([p()],h.prototype,"effectiveCursor",null),c([p()],h.prototype,"loading",void 0),c([p({constructOnly:!0})],h.prototype,"manipulators",void 0),c([p({constructOnly:!0})],h.prototype,"drawSurface",void 0),c([p({constructOnly:!0})],h.prototype,"segmentLabels",void 0),c([p({constructOnly:!0})],h.prototype,"snappingManager",void 0),c([p({constructOnly:!0})],h.prototype,"snappingVisualizer",void 0),c([p()],h.prototype,"snapToSceneEnabled",void 0),c([p({readOnly:!0})],h.prototype,"cursorVertex",null),c([p({readOnly:!0})],h.prototype,"visualizationCursorVertex",null),c([p()],h.prototype,"committableVertex",null),c([p()],h.prototype,"firstVertex",void 0),c([p()],h.prototype,"lastVertex",void 0),c([p()],h.prototype,"secondToLastVertex",void 0),c([p()],h.prototype,"updating",null),c([p({constructOnly:!0})],h.prototype,"view",void 0),h=c([Z("esri.views.draw.DrawOperation")],h);class sn{constructor(e,n,i,s=null){this._elevationInfo=e,this.defaultZ=n,this._view=i,this._excludeGraphics=s}screenToMap(e){const{defaultZ:n,_view:i}=this,s=i.sceneIntersectionHelper.intersectElevationFromScreen(Qt(e.x,e.y),this._elevationInfo,n??0,this._excludeGraphics);return n==null&&s!=null&&(s.z=void 0),s}mapToScreen(e){const n=Q(e.x,e.y,yt(this._view,e,this._elevationInfo),e.spatialReference);return this._view.toScreen(n)}constrainZ(e){const{defaultZ:n}=this;return n!=null&&e.z!==n&&((e=H(e)).z=n),e}}class rn{constructor(e,n,i=[]){this.view=e,this.elevationInfo=n,this.exclude=i}screenToMap(e){const n=this.view.toMap(e,{exclude:this.exclude,excludeLabels:!0});return n!=null&&(n.z=z(n,this.view,this.elevationInfo)),n}mapToScreen(e){let n=e;return this.elevationInfo!=null&&(n=Q(e.x,e.y,yt(this.view,e,this.elevationInfo),e.spatialReference)),this.view.toScreen(n)}constrainZ(e){return e}}class an{constructor(e,n=!1,i=0){this.view=e,this.hasZ=n,this.defaultZ=i,this.mapToScreen=s=>e.toScreen(s),this.screenToMap=n?s=>{const r=e.toMap(s);return r.z=i,r}:s=>e.toMap(s)}constrainZ(e){const{defaultZ:n}=this;return this.hasZ&&e.z!==n&&((e=H(e)).z=n),e}}class it{screenToMap(e){const{x:n,y:i}=e;return new te({x:n,y:i,spatialReference:it.spatialReference})}mapToScreen(e){return N(e.x,e.y)}constrainZ(e){return e}static{this.spatialReference=new ct}}export{h as A,E as D,Le as E,Xe as M,We as R,Ue as S,Zt as U,V as a,Ee as b,sn as c,Rt as d,Ot as f,It as g,an as h,rn as l,ke as m,L as p,Be as q,v as r,it as u,qe as v,Ne as z};
