import{aQ as H,_ as b,X as D,Y as te,a6 as Ne,a5 as Te,aG as Pe,Z as le,H as Me,kq as Re,i as Oe,aF as Ge,eU as j,eW as A,M as Ee,C as Ve,kQ as ze,bP as He}from"./main-6gYsRPh_.js";import{m as We}from"./TimeOnly-DMbsPjUX.js";import{t as Qe,l as de}from"./arcade-BNbfPFHY.js";import{o as v,w as _e,m as ce,B as U,p as M,g as k,Z as Be,c as De,l as ve,X as ke,z as L,T as J,H as ne,t as W,L as Je,S as q,Y as qe,a0 as ie}from"./Dictionary-BlU901XL.js";import{n as p,o as Ke,t as Ye}from"./enum-BVcvu-V3.js";import{I as Xe}from"./Feature-BzmHD5XA.js";import{v as et,R as Se,y as tt,h as ue,e as nt,i as it,s as ot,F as oe,E as at,k as rt,O as st,a as Q,I as lt,D as ae,b as Z,x as fe}from"./featureSetUtils-CXR05To_.js";import{t as dt}from"./ImmutableArray-CiJxhY8_.js";import{l as ct}from"./portalUtils-CPgfbuVo.js";import{s as ut,v as xe}from"./SpatialFilter-zTciIv6Y.js";import{N as Ae,o as me}from"./shared-kaSAj19f.js";import{L as E}from"./WhereClause-BlCUGovw.js";import Ue from"./FeatureLayer-D1M--Gf7.js";import{m as $}from"./Field-CY14G2Qc.js";import{f as ft,u as mt,s as pt}from"./utils-hE7D5uZL.js";import{s as _}from"./NetworkElement-DvGcHytX.js";new H({Clean:"clean",Dirty:"dirty"}),new H({Physical:"physical",Virtual:"virtual"}),new H({"Start and end":"start-and-end",Start:"start",Midspan:"midspan",End:"end"}),new H({startingPoint:"starting-point",barrier:"barrier",stoppingPoint:"stopping-point"}),new H({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation",path:"path",circuit:"circuit"});const Ce="{00000000-0000-0000-0000-000000000000}",R=new H({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new H({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let B=class extends _{constructor(n){super(n),this.type="telecomNetworkElement",this.firstUnit=null,this.numUnits=null}};b([D({json:{write:!1}})],B.prototype,"type",void 0),b([D({json:{write:!0}})],B.prototype,"firstUnit",void 0),b([D({json:{write:!0}})],B.prototype,"numUnits",void 0),B=b([te("esri.rest.networks.support.TelecomNetworkElement")],B);let x=class extends le{constructor(n){super(n),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(n,l){return l.fromFirstUnit||l.fromNumUnits?new B({globalId:l.fromGlobalId,networkSourceId:l.fromNetworkSourceId,terminalId:l.fromTerminalId,firstUnit:l.fromFirstUnit,numUnits:l.fromNumUnits}):new _({globalId:l.fromGlobalId,networkSourceId:l.fromNetworkSourceId,terminalId:l.fromTerminalId})}writeFromNetworkElement(n,l){if(n&&(l.fromGlobalId=n.globalId,l.fromNetworkSourceId=n.networkSourceId,l.fromTerminalId=n.terminalId,n.type==="telecomNetworkElement")){const t=n;l.fromFirstUnit=t.firstUnit,l.fromNumUnits=t.numUnits}}readToNetworkElement(n,l){return l.toFirstUnit||l.toNumUnits?new B({globalId:l.toGlobalId,networkSourceId:l.toNetworkSourceId,terminalId:l.toTerminalId,firstUnit:l.toFirstUnit,numUnits:l.toNumUnits}):new _({globalId:l.toGlobalId,networkSourceId:l.toNetworkSourceId,terminalId:l.toTerminalId})}writeToNetworkElement(n,l){if(n&&(l.toGlobalId=n.globalId,l.toNetworkSourceId=n.networkSourceId,l.toTerminalId=n.terminalId,n.type==="telecomNetworkElement")){const t=n;l.toFirstUnit=t.firstUnit,l.toNumUnits=t.numUnits}}equals(n){if(this.globalId===Ce&&n.globalId===Ce){let l=function(r,s){return r.networkSourceId===s.networkSourceId&&r.globalId===s.globalId&&r.terminalId===s.terminalId&&r.firstUnit===s.firstUnit&&r.numUnits===s.numUnits};const t=this.fromNetworkElement,o=this.toNetworkElement,w=n.fromNetworkElement,I=n.toNetworkElement,e=l(t,w),i=l(o,I);return e&&i&&this.associationType===n.associationType}return this.globalId!=null&&n.globalId!=null&&this.globalId===n.globalId}};b([D({type:String,json:{write:!0}})],x.prototype,"globalId",void 0),b([D({type:R.apiValues,json:{type:R.jsonValues,read:R.read,write:R.write}})],x.prototype,"associationType",void 0),b([D({type:_,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number},fromFirstUnit:{type:Number},fromNumUnits:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId","fromFirstUnit","fromNumUnits"]}}})],x.prototype,"fromNetworkElement",void 0),b([Ne("fromNetworkElement")],x.prototype,"readFromNetworkElement",null),b([Te("fromNetworkElement")],x.prototype,"writeFromNetworkElement",null),b([D({type:_,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number},toFirstUnit:{type:Number},toNumUnits:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId","toFirstUnit","toNumUnits"]}}})],x.prototype,"toNetworkElement",void 0),b([Ne("toNetworkElement")],x.prototype,"readToNetworkElement",null),b([Te("toNetworkElement")],x.prototype,"writeToNetworkElement",null),b([D({type:Pe,json:{write:!0}})],x.prototype,"geometry",void 0),b([D({type:String,json:{write:!0}})],x.prototype,"errorMessage",void 0),b([D({type:Number,json:{write:!0}})],x.prototype,"percentAlong",void 0),b([D({type:Number,json:{write:!0}})],x.prototype,"errorCode",void 0),b([D({type:Boolean,json:{write:!0}})],x.prototype,"isContentVisible",void 0),b([D({type:Number,json:{write:!0}})],x.prototype,"status",void 0),x=b([te("esri.rest.networks.support.Association")],x);let re=class extends le{constructor(n){super(n),this.associations=[]}};b([D({type:[x],json:{write:!0}})],re.prototype,"associations",void 0),re=b([te("esri.rest.networks.support.QueryAssociationsResult")],re);function yt(n){const{returnDeletes:l,elements:t,gdbVersion:o,moment:w}=n.toJSON();return{returnDeletes:l,elements:JSON.stringify(t.map(I=>({globalId:I.globalId,networkSourceId:I.networkSourceId,terminalId:I.terminalId}))),types:JSON.stringify(n.types.map(I=>R.toJSON(I))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:o,moment:w??Date.now()}}async function wt(n,l,t){const o=ft(n),w={...yt(l),f:"json"},I=mt({...o.query,...w}),e=pt(I,{...t,method:"post"}),i=`${o.path}/associations/query`,{data:r}=await Me(i,e),s=re.fromJSON(r);return l.types.includes("connectivity")&&Re(Oe.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://arcg.is/11Tr8a#types",version:"4.29",warnOnce:!0}),s}var pe;let V=pe=class extends le{static from(n){return Ge(pe,n)}constructor(n){super(n),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};b([D({type:Boolean,json:{write:!0}})],V.prototype,"returnDeletes",void 0),b([D({type:[_],json:{write:!0}})],V.prototype,"elements",void 0),b([D({type:[R.apiValues],json:{type:R.jsonValues,read:R.read,write:R.write}})],V.prototype,"types",void 0),b([D({type:String,json:{write:!0}})],V.prototype,"gdbVersion",void 0),b([D({type:Date,json:{type:Number,write:{writer:(n,l)=>{l.moment=n?.getTime()}}}})],V.prototype,"moment",void 0),V=pe=b([te("esri.rest.networks.support.QueryAssociationsParameters")],V);function It(n){if(n.length===1){if(A(n[0]))return de("distinct",n[0],-1);if(W(n[0]))return de("distinct",n[0].toArray(),-1)}return de("distinct",n,-1)}function ye(n,l,t){const o=n.getVariables();if(o.length>0){const w={};for(const I of o)w[I]=l.evaluateIdentifier(t,{name:I});n.parameters=w}return n}function u(n,l,t=null){for(const o in n)if(o.toLowerCase()===l.toLowerCase())return n[o];return t}function je(n){if(n===null)return null;const l={type:u(n,"type",""),name:u(n,"name","")};if(l.type==="range")l.range=u(n,"range",[]);else{l.codedValues=[];for(const t of u(n,"codedValues",[]))l.codedValues.push({name:u(t,"name",""),code:u(t,"code",null)})}return l}function we(n){if(n===null)return null;const l={},t=u(n,"wkt");t!==null&&(l.wkt=t);const o=u(n,"wkid");return o!==null&&(l.wkid=o),l}function Le(n){if(n===null)return null;const l={hasZ:u(n,"hasz",!1),hasM:u(n,"hasm",!1)},t=u(n,"spatialreference");t!=null&&(l.spatialReference=we(t));const o=u(n,"x",null);if(o!==null)return l.x=o,l.y=u(n,"y",null),l.hasZ&&(l.z=u(n,"z",null)),l.hasM&&(l.m=u(n,"m",null)),l;const w=u(n,"rings",null);if(w!==null)return l.rings=w,l;const I=u(n,"paths",null);if(I!==null)return l.paths=I,l;const e=u(n,"points",null);if(e!==null)return l.points=e,l;for(const i of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=u(n,i,null);r!==null&&(l[i]=r)}return l}function gt(n,l){for(const t of l)if(t===n)return!0;return!1}function ht(n){return!!n.layerDefinition&&!!n.featureSet&&gt(n.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&A(n.layerDefinition.fields)!==!1&&A(n.featureSet.features)!==!1}function K(n){return n?.toLowerCase()==="utc"?"UTC":n?.toLowerCase()==="unknown"?"Unknown":n}async function bt(n,l,t,o,w,I,e){const i=await n.getFeatureSetInfo();if((i?.layerId??null)===null||!w.layerIdLookup.get(i.layerId))return null;const r=n.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),s=[];switch(t){case"connected":s.push("connectivity"),s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity"),s.push("junction-edge-midspan-connectivity"),s.push("junction-junction-connectivity");break;case"container":case"content":s.push("containment");break;case"structure":case"attached":s.push("attachment");break;case"junctionedge":s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity");break;case"midspan":s.push("junction-edge-midspan-connectivity");break;default:throw new p(I,"InvalidParameter",e)}let y=null,f=!1;if(o!==null&&o!==""&&o!==void 0){for(const c of w.terminals)c.terminalName===o&&(y=c.terminalId);y===null&&(f=!0)}const d=[];if(!f){const c=new _({globalId:l.field(n.globalIdField),networkSourceId:w.layerIdLookup.get(i.layerId).sourceId,...y?{terminalId:y}:""}),m=await wt(r,new V({types:s,elements:[c]}));let S=0;for(const g of m.associations){let h=null,T="",P="";if(g.fromNetworkElement?.globalId===c.globalId?(h=g.toNetworkElement,P="to"):g.toNetworkElement?.globalId===c.globalId&&(h=g.fromNetworkElement,P="from"),!h)continue;switch(t){case"attached":if(g.associationType!=="attachment"||P!=="to")continue;break;case"structure":if(g.associationType!=="attachment"||P!=="from")continue;break;case"container":if(g.associationType!=="containment"||P!=="from")continue;break;case"content":if(g.associationType!=="containment"||P!=="to")continue;break;case"connected":break;case"junctionedge":g.associationType==="junction-edge-to-connectivity"?T="to":g.associationType==="junction-edge-from-connectivity"&&(T="from");break;case"midspan":if(g.associationType!=="junction-edge-midspan-connectivity")continue}const Y=w.sourceIdLookup.get(h.networkSourceId)?.className??"";d.push(new He({geometry:null,attributes:{objectId:S++,globalId:h.globalId,percentAlong:g.percentAlong??0,isContentVisible:g.isContentVisible?0:1,className:Y,side:T}}))}}const a=new Ue({source:d,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new $({name:"objectId",alias:"objectId",type:"oid"}),new $({name:"globalId",alias:"globalId",type:"global-id"}),new $({name:"percentAlong",alias:"percentAlong",type:"double"}),new $({name:"side",alias:"side",type:"string"}),new $({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new $({name:"className",alias:"className",type:"string"})]});return oe(a)}function Ft(n){if(n.mode==="async"){n.functions.timezone=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,1,2,t,o),_e(e[0])||ce(e[0]))return"Unknown";if(U(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?K("unknown"):K(e[0].dateFieldsTimeZone);if(!(e[1]instanceof M)||e[1].hasField("type")===!1)throw new p(t,"InvalidParameter",o);const s=e[1].field("type");if(j(s)===!1)throw new p(t,"InvalidParameter",o);switch(k(s).toLowerCase()){case"preferredtimezone":return K(e[0].preferredTimeZone);case"editfieldsinfo":return K(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return K(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&j(e[1].field("fieldname")))return K(e[0].fieldTimeZone(k(e[1].field("fieldname"))))}throw new p(t,"InvalidParameter",o)}const i=Be(e[0],De(t));if(i===null)return null;const r=i.timeZone;return r==="system"?We.systemTimeZoneCanonicalName:r.toLowerCase()==="utc"?"UTC":r.toLowerCase()==="unknown"?"Unknown":r})},n.functions.sqltimestamp=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{v(e,1,3,t,o);const i=e[0];if(ve(i)){if(e.length===1)return i.toSQLWithKeyword();if(e.length===2)return i.changeTimeZone(k(e[1])).toSQLWithKeyword();throw new p(t,"InvalidParameter",o)}if(ce(i))return i.toSQLWithKeyword();if(U(i)){if(e.length!==3)throw new p(t,"InvalidParameter",o);await i.load();const r=k(e[1]);if(ce(e[2]))return e[2].toSQLWithKeyword();if(ve(e[2])===!1)throw new p(t,"InvalidParameter",o);const s=i.fieldTimeZone(r);return s==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(s).toSQLWithKeyword()}throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"sqltimestamp",min:2,max:4}),n.functions.featuresetbyid=function(t,o){return n.standardFunctionAsync(t,o,(w,I,e)=>{if(v(e,2,4,t,o),ke(e[0])){const i=k(e[1]);let r=L(e[2],null);const s=J(L(e[3],!0));if(r===null&&(r=["*"]),A(r)===!1)throw new p(t,"InvalidParameter",o);return e[0].featureSetById(i,s,r)}throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"featuresetbyid",min:2,max:4});const l=new Ke(["datasource","parent","root"]);n.functions.getfeatureset=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,1,2,t,o),ne(e[0])){const i=e[1]==null?"datasource":l.lookup(k(e[1]));return et(e[0].fullSchema(),i,t.lrucache,t.interceptor,t.spatialReference)}throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"getfeatureset",min:1,max:2}),n.functions.featuresetbyportalitem=function(t,o){return n.standardFunctionAsync(t,o,(w,I,e)=>{if(v(e,2,5,t,o),e[0]===null)throw new p(t,"PortalRequired",o);if(e[0]instanceof Qe){const f=k(e[1]),d=k(e[2]);let a=L(e[3],null);const c=J(L(e[4],!0));if(a===null&&(a=["*"]),A(a)===!1)throw new p(t,"InvalidParameter",o);let m;return m=t.services?.portal?t.services.portal:Ee.getDefault(),m=ct(e[0],m),Se(f,d,t.spatialReference,a,c,m,t.lrucache,t.interceptor)}if(j(e[0])===!1)throw new p(t,"PortalRequired",o);const i=k(e[0]),r=k(e[1]);let s=L(e[2],null);const y=J(L(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new p(t,"InvalidParameter",o);return Se(i,r,t.spatialReference,s,y,t.services?.portal??Ee.getDefault(),t.lrucache,t.interceptor)})},n.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),n.functions.featuresetbyname=function(t,o){return n.standardFunctionAsync(t,o,(w,I,e)=>{if(v(e,2,4,t,o),ke(e[0])){const i=k(e[1]);let r=L(e[2],null);const s=J(L(e[3],!0));if(r===null&&(r=["*"]),A(r)===!1)throw new p(t,"InvalidParameter",o);return e[0].featureSetByName(i,s,r)}throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"featuresetbyname",min:2,max:4}),n.functions.featureset=function(t,o){return n.standardFunction(t,o,(w,I,e)=>{v(e,1,1,t,o);const i={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(j(e[0])){const r=JSON.parse(e[0]);r.layerDefinition!==void 0?(i.layerDefinition=r.layerDefinition,i.featureSet=r.featureSet,r.layerDefinition.spatialReference&&(i.layerDefinition.spatialReference=r.layerDefinition.spatialReference)):(i.featureSet.features=r.features,i.featureSet.geometryType=r.geometryType,i.layerDefinition.geometryType=i.featureSet.geometryType,i.layerDefinition.objectIdField=r.objectIdFieldName??"",i.layerDefinition.typeIdField=r.typeIdFieldName,i.layerDefinition.globalIdField=r.globalIdFieldName,i.layerDefinition.fields=r.fields,r.spatialReference&&(i.layerDefinition.spatialReference=r.spatialReference))}else{if(!(e[0]instanceof M))throw new p(t,"InvalidParameter",o);{const r=JSON.parse(e[0].castToText(!0)),s=u(r,"layerdefinition");if(s!==null){i.layerDefinition.geometryType=u(s,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.globalIdField=u(s,"globalidfield",""),i.layerDefinition.objectIdField=u(s,"objectidfield",""),i.layerDefinition.typeIdField=u(s,"typeidfield",""),i.layerDefinition.hasZ=u(s,"hasz",!1)===!0,i.layerDefinition.hasM=u(s,"hasm",!1)===!0;const y=u(s,"spatialreference");y&&(i.layerDefinition.spatialReference=we(y));const f=[];for(const a of u(s,"fields",[])){const c={name:u(a,"name",""),alias:u(a,"alias",""),type:u(a,"type",""),nullable:u(a,"nullable",!0),editable:u(a,"editable",!0),length:u(a,"length",null),domain:je(u(a,"domain"))};f.push(c)}i.layerDefinition.fields=f;const d=u(r,"featureset");if(d){const a={};for(const c of f)a[c.name.toLowerCase()]=c.name;for(const c of u(d,"features",[])){const m={},S=u(c,"attributes",{});for(const g in S)m[a[g.toLowerCase()]]=S[g];i.featureSet.features.push({attributes:m,geometry:Le(u(c,"geometry"))})}}}else{i.layerDefinition.hasZ=u(r,"hasz",!1)===!0,i.layerDefinition.hasM=u(r,"hasm",!1)===!0,i.layerDefinition.geometryType=u(r,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.objectIdField=u(r,"objectidfieldname",""),i.layerDefinition.typeIdField=u(r,"typeidfieldname","");const y=u(r,"spatialreference");y&&(i.layerDefinition.spatialReference=we(y));const f=[],d=u(r,"fields",null);if(!A(d))throw new p(t,"InvalidParameter",o);for(const m of d){const S={name:u(m,"name",""),alias:u(m,"alias",""),type:u(m,"type",""),nullable:u(m,"nullable",!0),editable:u(m,"editable",!0),length:u(m,"length",null),domain:je(u(m,"domain"))};f.push(S)}i.layerDefinition.fields=f;const a={};for(const m of f)a[m.name.toLowerCase()]=m.name;let c=u(r,"features",null);if(A(c))for(const m of c){const S={},g=u(m,"attributes",{});for(const h in g)S[a[h.toLowerCase()]]=g[h];i.featureSet.features.push({attributes:S,geometry:Le(u(m,"geometry",null))})}else c=null,i.featureSet.features=c}}}if(ht(i)===!1)throw new p(t,"InvalidParameter",o);return i.layerDefinition.geometryType||(i.layerDefinition.geometryType="esriGeometryNull"),tt.create(i,t.spatialReference)})},n.signatures.push({name:"featureset",min:1,max:1}),n.functions.filter=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,2,2,t,o),A(e[0])||W(e[0])){const i=[];let r,s=e[0];if(s instanceof dt&&(s=s.toArray()),!Je(e[1]))throw new p(t,"InvalidParameter",o);r=e[1].createFunction(t);for(const y of s){const f=r(y);Ve(f)?await f===!0&&i.push(y):f===!0&&i.push(y)}return i}if(U(e[0])){const i=await e[0].load(),r=E.create(e[1],{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),s=r.getVariables();if(s.length>0){const y={};for(const f of s)y[f]=n.evaluateIdentifier(t,{name:f});r.parameters=y}return new ue({parentfeatureset:e[0],whereclause:r})}throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"filter",min:2,max:2}),n.functions.orderby=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,2,2,t,o),U(e[0])){const i=new nt(e[1]);return new it({parentfeatureset:e[0],orderbyclause:i})}throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"orderby",min:2,max:2}),n.functions.top=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,2,2,t,o),U(e[0]))return new ot({parentfeatureset:e[0],topnum:e[1]});if(A(e[0]))return q(e[1])>=e[0].length?e[0].slice():e[0].slice(0,q(e[1]));if(W(e[0]))return q(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,q(e[1]));throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"top",min:2,max:2}),n.functions.first=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,1,1,t,o),U(e[0])){const i=await e[0].first(w.abortSignal);if(i!==null){const r=Xe.createFromGraphicLikeObject(i.geometry,i.attributes,e[0],t.timeZone);return r._underlyingGraphic=i,r}return i}return A(e[0])?e[0].length===0?null:e[0][0]:W(e[0])?e[0].length()===0?null:e[0].get(0):null})},n.signatures.push({name:"first",min:1,max:1}),n.functions.attachments=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{v(e,1,2,t,o);const i={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof M){if(e[1].hasField("minsize")&&(i.minsize=q(e[1].field("minsize"))),e[1].hasField("metadata")&&(i.returnMetadata=J(e[1].field("metadata"))),e[1].hasField("maxsize")&&(i.maxsize=q(e[1].field("maxsize"))),e[1].hasField("types")){const r=qe(e[1].field("types"),!1);r.length>0&&(i.types=r)}}else if(e[1]!==null)throw new p(t,"InvalidParameter",o)}if(ne(e[0])){const r=e[0]._layer;let s;if(U(r))s=r;else{if(r==null||!Ae(r))return[];s=oe(r,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await s.load(),s.queryAttachments(e[0].field(s.objectIdField),i.minsize,i.maxsize,i.types,i.returnMetadata)}if(e[0]===null)return[];throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"attachments",min:1,max:2}),n.functions.featuresetbyrelationshipname=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{v(e,2,4,t,o);const i=e[0],r=k(e[1]);let s=L(e[2],null);const y=J(L(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new p(t,"InvalidParameter",o);if(e[0]===null)return null;if(!ne(e[0]))throw new p(t,"InvalidParameter",o);const f=i._layer;let d;if(U(f))d=f;else{if(f==null||!Ae(f))return null;d=oe(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}d=await d.load();const a=d.relationshipMetaData().filter(h=>h.name===r);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return at(d,a[0],i.field(d.objectIdField),d.spatialReference,s,y,t.lrucache,t.interceptor);let c=d.serviceUrl();if(!c)return null;c=c.endsWith("/")?c+a[0].relatedTableId.toString():c+"/"+a[0].relatedTableId.toString();const m=await rt(c,d.spatialReference,s,y,t.lrucache,t.interceptor);await m.load();let S=m.relationshipMetaData();if(S=S.filter(h=>h.id===a[0].id),i.hasField(a[0].keyField)===!1||i.field(a[0].keyField)===null){const h=await d.getFeatureByObjectId(i.field(d.objectIdField),[a[0].keyField]);if(h){const T=E.create(S[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return T.parameters={id:h.attributes[a[0].keyField]},m.filter(T)}return new ut({parentfeatureset:m})}const g=E.create(S[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return g.parameters={id:i.field(a[0].keyField)},m.filter(g)})},n.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),n.functions.featuresetbyassociation=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{v(e,2,3,t,o);const i=e[0],r=Ye(k(L(e[1],""))),s=j(e[2])?k(e[2]):null;if(e[0]===null)return null;if(!ne(e[0]))throw new p(t,"InvalidParameter",o);let y=i._layer;if(y instanceof Ue&&(y=oe(y,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),y===null||U(y)===!1)return null;await y.load();const f=y.serviceUrl(),d=await st(f,t.spatialReference,!0);if(d.unVersion>=8)return await bt(y,i,r,s,d,t,o);const a=d.associations;let c=null,m=null,S=!1;if(s!==null&&s!==""&&s!==void 0){for(const N of d.terminals)N.terminalName===s&&(m=N.terminalId);m===null&&(S=!0)}const g=a.getFieldsIndex(),h=g.get("TOGLOBALID").name,T=g.get("FROMGLOBALID").name,P=g.get("TOTERMINALID").name,Y=g.get("FROMTERMINALID").name,X=g.get("FROMNETWORKSOURCEID").name,ee=g.get("TONETWORKSOURCEID").name,z=g.get("ASSOCIATIONTYPE").name,Ze=g.get("ISCONTENTVISIBLE").name,$e=g.get("OBJECTID").name;for(const N of y.fields)if(N.type==="global-id"){c=i.field(N.name);break}let O=null,Ie=new Q(new $({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),ge=new Q(new $({name:"side",alias:"side",type:"string"}),E.create("''",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));const C="globalid",he="globalId",be={};for(const N in d.lkp)be[N]=d.lkp[N].sourceId;const G=new lt(new $({name:"classname",alias:"classname",type:"string"}),null,be);let F="";switch(r){case"midspan":{F=`((${h}='${c}') OR ( ${T}='${c}')) AND (${z} IN (5))`,G.codefield=E.create(`CASE WHEN (${h}='${c}') THEN ${X} ELSE ${ee} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const N=me(Z.findField(a.fields,T));N.name=C,N.alias=C,O=new Q(N,E.create(`CASE WHEN (${T}='${c}') THEN ${h} ELSE ${T} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),Ie=d.unVersion>=4?new fe(Z.findField(a.fields,g.get("PERCENTALONG").name)):new Q(new $({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{F=`((${h}='${c}') OR ( ${T}='${c}')) AND (${z} IN (4,6))`,G.codefield=E.create(`CASE WHEN (${h}='${c}') THEN ${X} ELSE ${ee} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const N=me(Z.findField(a.fields,T));N.name=C,N.alias=C,O=new Q(N,E.create(`CASE WHEN (${T}='${c}') THEN ${h} ELSE ${T} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),ge=new Q(new $({name:"side",alias:"side",type:"string"}),E.create(`CASE WHEN (${z}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let N=`${h}='@T'`,Fe=`${T}='@T'`;m!==null&&(N+=` AND ${P}=@A`,Fe+=` AND ${Y}=@A`),F="(("+N+") OR ("+Fe+"))",F=ie(F,"@T",c??""),N=ie(N,"@T",c??""),m!==null&&(N=ie(N,"@A",m.toString()),F=ie(F,"@A",m.toString())),G.codefield=E.create("CASE WHEN "+N+` THEN ${X} ELSE ${ee} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const se=me(Z.findField(a.fields,T));se.name=C,se.alias=C,O=new Q(se,E.create("CASE WHEN "+N+` THEN ${T} ELSE ${h} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"container":F=`${h}='${c}' AND ${z} = 2`,m!==null&&(F+=` AND ${P} = `+m.toString()),G.codefield=X,F="( "+F+" )",O=new ae(Z.findField(a.fields,T),C,C);break;case"content":F=`(${T}='${c}' AND ${z} = 2)`,m!==null&&(F+=` AND ${Y} = `+m.toString()),G.codefield=ee,F="( "+F+" )",O=new ae(Z.findField(a.fields,h),C,C);break;case"structure":F=`(${h}='${c}' AND ${z} = 3)`,m!==null&&(F+=` AND ${P} = `+m.toString()),G.codefield=X,F="( "+F+" )",O=new ae(Z.findField(a.fields,T),C,he);break;case"attached":F=`(${T}='${c}' AND ${z} = 3)`,m!==null&&(F+=` AND ${Y} = `+m.toString()),G.codefield=ee,F="( "+F+" )",O=new ae(Z.findField(a.fields,h),C,he);break;default:throw new p(t,"InvalidParameter",o)}return S&&(F="1 <> 1"),new Z({parentfeatureset:a,adaptedFields:[new fe(Z.findField(a.fields,$e)),new fe(Z.findField(a.fields,Ze)),O,ge,G,Ie],extraFilter:F?E.create(F,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}):null})})},n.signatures.push({name:"featuresetbyassociation",min:2,max:6}),n.functions.groupby=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,3,3,t,o),!U(e[0]))throw new p(t,"InvalidParameter",o);const i=await e[0].load(),r=[],s=[];let y=!1,f=[];if(j(e[1]))f.push(e[1]);else if(e[1]instanceof M)f.push(e[1]);else if(A(e[1]))f=e[1];else{if(!W(e[1]))throw new p(t,"InvalidParameter",o);f=e[1].toArray()}for(const d of f)if(j(d)){const a=E.create(k(d),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),c=xe(a)===!0?k(d):"%%%%FIELDNAME";r.push({name:c,expression:a}),c==="%%%%FIELDNAME"&&(y=!0)}else{if(!(d instanceof M))throw new p(t,"InvalidParameter",o);{const a=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",c=d.hasField("expression")?d.field("expression"):"";if(a==="%%%%FIELDNAME"&&(y=!0),!a)throw new p(t,"InvalidParameter",o);r.push({name:a,expression:E.create(c||a,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(f=[],j(e[2]))f.push(e[2]);else if(A(e[2]))f=e[2];else if(W(e[2]))f=e[2].toArray();else{if(!(e[2]instanceof M))throw new p(t,"InvalidParameter",o);f.push(e[2])}for(const d of f){if(!(d instanceof M))throw new p(t,"InvalidParameter",o);{const a=d.hasField("name")?d.field("name"):"",c=d.hasField("statistic")?d.field("statistic"):"",m=d.hasField("expression")?d.field("expression"):"";if(!(a&&c&&j(c)&&m))throw new p(t,"InvalidParameter",o);s.push({name:a,statistic:c,expression:E.create(m,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(y){const d={};for(const c of i.fields)d[c.name.toLowerCase()]=1;for(const c of r)c.name!=="%%%%FIELDNAME"&&(d[c.name.toLowerCase()]=1);for(const c of s)c.name!=="%%%%FIELDNAME"&&(d[c.name.toLowerCase()]=1);let a=0;for(const c of r)if(c.name==="%%%%FIELDNAME"){for(;d["field_"+a.toString()]===1;)a++;d["field_"+a.toString()]=1,c.name="FIELD_"+a.toString()}}for(const d of r)ye(d.expression,n,t);for(const d of s)ye(d.expression,n,t);return e[0].groupby(r,s)})},n.signatures.push({name:"groupby",min:3,max:3}),n.functions.distinct=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(U(e[0])){v(e,2,2,t,o);const i=await e[0].load(),r=[];let s=[];if(j(e[1]))s.push(e[1]);else if(e[1]instanceof M)s.push(e[1]);else if(A(e[1]))s=e[1];else{if(!W(e[1]))throw new p(t,"InvalidParameter",o);s=e[1].toArray()}let y=!1;for(const f of s)if(j(f)){const d=E.create(k(f),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),a=xe(d)===!0?k(f):"%%%%FIELDNAME";r.push({name:a,expression:d}),a==="%%%%FIELDNAME"&&(y=!0)}else{if(!(f instanceof M))throw new p(t,"InvalidParameter",o);{const d=f.hasField("name")?f.field("name"):"%%%%FIELDNAME",a=f.hasField("expression")?f.field("expression"):"";if(d==="%%%%FIELDNAME"&&(y=!0),!d)throw new p(t,"InvalidParameter",o);r.push({name:d,expression:E.create(a||d,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(y){const f={};for(const a of i.fields)f[a.name.toLowerCase()]=1;for(const a of r)a.name!=="%%%%FIELDNAME"&&(f[a.name.toLowerCase()]=1);let d=0;for(const a of r)if(a.name==="%%%%FIELDNAME"){for(;f["field_"+d.toString()]===1;)d++;f["field_"+d.toString()]=1,a.name="FIELD_"+d.toString()}}for(const f of r)ye(f.expression,n,t);return e[0].groupby(r,[])}return It(e)})},n.functions.getfeaturesetinfo=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,1,1,t,o),!U(e[0]))return null;const i=await e[0].getFeatureSetInfo();return i?M.convertObjectToArcadeDictionary({layerId:i.layerId,layerName:i.layerName,itemId:i.itemId,serviceLayerUrl:i.serviceLayerUrl,webMapLayerId:i.webMapLayerId??null,webMapLayerTitle:i.webMapLayerTitle??null,className:null,objectClassId:null},De(t),!1,!1):null})},n.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),n.functions.filterbysubtypecode=function(t,o){return n.standardFunctionAsync(t,o,async(w,I,e)=>{if(v(e,2,2,t,o),U(e[0])){const i=await e[0].load(),r=e[1];if(!ze(r))throw new p(t,"InvalidParameter",o);if(i.subtypeField){const y=E.create(`${i.subtypeField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new ue({parentfeatureset:e[0],whereclause:y})}if(i.typeIdField===null||i.typeIdField==="")throw new p(t,"FeatureSetDoesNotHaveSubtypes",o);const s=E.create(`${i.typeIdField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new ue({parentfeatureset:e[0],whereclause:s})}throw new p(t,"InvalidParameter",o)})},n.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{Ft as registerFunctions};
