import{l3 as d}from"./main-CtmwM019.js";import"./preload-helper-DMGCcr4D.js";var A,x=()=>new DecompressionStream("deflate-raw");try{x(),A=async e=>{let t=x(),r=t.writable.getWriter(),n=t.readable.getReader(),o,i=[],s=0,c=0,u;for(r.write(e),r.close();!(u=await n.read()).done;)o=u.value,i.push(o),s+=o.length;return!i[1]&&o||(o=new Uint8Array(s),i.map(f=>(o.set(f,c),c+=f.length))),o}}catch{}var V=new TextDecoder,w=e=>{throw new Error("but-unzip~"+e)},v=e=>V.decode(e);function*M(e,t=A){let r=e.length-20,n=Math.max(r-65516,2);for(;(r=e.lastIndexOf(80,r-1))!==-1&&!(e[r+1]===75&&e[r+2]===5&&e[r+3]===6)&&r>n;);r===-1&&w(2);let o=(f,h)=>e.subarray(r+=f,r+=h),i=new DataView(e.buffer,e.byteOffset),s=f=>i.getUint16(f+r,!0),c=f=>i.getUint32(f+r,!0),u=s(10);for(u!==s(8)&&w(3),r=c(16);u--;){let f=s(10),h=s(30),I=s(32),R=c(20),S=c(42),j=v(o(46,s(28))),E=v(o(h,I)),k=r,y;r=S,y=o(30+s(26)+s(28),R),yield{filename:j,comment:E,read:()=>f&8?t(y):f?w(1):y},r=k}}const N=/.+\.(shp|dbf|json|prj|cpg)$/i,B=async e=>{const t={},r=[];for(const i of M(e))N.test(i.filename)&&r.push(Promise.resolve(i.read()).then(s=>t[i.filename]=s));await Promise.all(r);const n={},o=new TextDecoder;for(const[i,s]of Object.entries(t))i.slice(-3).toLowerCase()==="shp"||i.slice(-3).toLowerCase()==="dbf"?n[i]=new DataView(s.buffer,s.byteOffset,s.byteLength):n[i]=o.decode(s);return n},$=globalThis.URL,_=(e,t)=>{if(!t)return e;const r=new $(e);return r.pathname=`${r.pathname}.${t}`,r.href};async function p(e,t){const r=_(e,t),n=t==="prj"||t==="cpg";try{const o=await fetch(r);if(o.status>399)throw new Error(o.statusText);if(n)return o.text();const i=await o.arrayBuffer();return new DataView(i)}catch(o){if(n||t==="dbf")return!1;throw o}}function H(e){let t=0,r=1;const n=e.length;let o,i;const s=[e[0][0],e[0][1],e[0][0],e[0][1]];for(;r<n;)o=i||e[0],i=e[r],t+=(i[0]-o[0])*(i[1]+o[1]),r++,i[0]<s[0]&&(s[0]=i[0]),i[1]<s[1]&&(s[1]=i[1]),i[0]>s[2]&&(s[2]=i[0]),i[1]>s[3]&&(s[3]=i[1]);return{ring:e,clockWise:t>0,bbox:s,children:[]}}function C(e,t){return!(e.bbox[0]>t.bbox[0]||e.bbox[1]>t.bbox[1]||e.bbox[2]<t.bbox[2]||e.bbox[3]<t.bbox[3])}function F(e,t=!1){const r=[],n=[];for(const s of e){const c=H(s);c.clockWise!==t?r.push(c):n.push(c)}const o=[];for(const s of n){let c;for(const u of r)C(u,s)&&(c?C(c,u)&&(c=u):c=u);c?c.children.push(s.ring):o.push(s)}if(t)return{outers:r,orphens:o};if(o.length&&!t){const s=F(e,!0);if(s.orphens.length===0){const c=[];for(const u of s.outers)c.push([u.ring.toReversed()].concat(u.children.map(f=>f.toReversed())));return c}}const i=[];for(const s of r)i.push([s.ring].concat(s.children));return i}l.prototype.parsePoint=function(e){return{type:"Point",coordinates:this.parseCoord(e,0)}};l.prototype.parseZPoint=function(e){const t=this.parsePoint(e);return t.coordinates.push(e.getFloat64(16,!0)),t};l.prototype.parsePointArray=function(e,t,r){const n=[];let o=0;for(;o<r;)n.push(this.parseCoord(e,t)),t+=16,o++;return n};l.prototype.parseZPointArray=function(e,t,r,n){let o=0;for(;o<r;)n[o].push(e.getFloat64(t,!0)),o++,t+=8;return n};l.prototype.parseArrayGroup=function(e,t,r,n,o){const i=[];let s=0,c,u=0,f;for(;s<n;)s++,r+=4,c=u,s===n?u=o:u=e.getInt32(r,!0),f=u-c,f&&(i.push(this.parsePointArray(e,t,f)),t+=f<<4);return i};l.prototype.parseZArrayGroup=function(e,t,r,n){let o=0;for(;o<r;)n[o]=this.parseZPointArray(e,t,n[o].length,n[o]),t+=n[o].length<<3,o++;return n};l.prototype.parseMultiPoint=function(e){const t={},r=e.getInt32(32,!0);if(!r)return null;const n=this.parseCoord(e,0),o=this.parseCoord(e,16);t.bbox=[n[0],n[1],o[0],o[1]];const i=36;return r===1?(t.type="Point",t.coordinates=this.parseCoord(e,i)):(t.type="MultiPoint",t.coordinates=this.parsePointArray(e,i,r)),t};l.prototype.parseZMultiPoint=function(e){const t=this.parseMultiPoint(e);if(!t)return null;let r;if(t.type==="Point")return t.coordinates.push(e.getFloat64(72,!0)),t;r=t.coordinates.length;const n=52+(r<<4);return t.coordinates=this.parseZPointArray(e,n,r,t.coordinates),t};l.prototype.parsePolyline=function(e){const t={},r=e.getInt32(32,!0);if(!r)return null;const n=this.parseCoord(e,0),o=this.parseCoord(e,16);t.bbox=[n[0],n[1],o[0],o[1]];const i=e.getInt32(36,!0);let s,c;return r===1?(t.type="LineString",s=44,t.coordinates=this.parsePointArray(e,s,i)):(t.type="MultiLineString",s=40+(r<<2),c=40,t.coordinates=this.parseArrayGroup(e,s,c,r,i)),t};l.prototype.parseZPolyline=function(e){const t=this.parsePolyline(e);if(!t)return null;const r=t.coordinates.length;let n;return t.type==="LineString"?(n=60+(r<<4),t.coordinates=this.parseZPointArray(e,n,r,t.coordinates),t):(n=56+(t.coordinates.reduce(function(i,s){return i+s.length},0)<<4)+(r<<2),t.coordinates=this.parseZArrayGroup(e,n,r,t.coordinates),t)};l.prototype.polyFuncs=function(e){return e&&(e.type==="LineString"?(e.type="Polygon",e.coordinates=[e.coordinates],e):(e.coordinates=F(e.coordinates),e.coordinates.length===1?(e.type="Polygon",e.coordinates=e.coordinates[0],e):(e.type="MultiPolygon",e)))};l.prototype.parsePolygon=function(e){return this.polyFuncs(this.parsePolyline(e))};l.prototype.parseZPolygon=function(e){return this.polyFuncs(this.parseZPolyline(e))};const L={1:"parsePoint",3:"parsePolyline",5:"parsePolygon",8:"parseMultiPoint",11:"parseZPoint",13:"parseZPolyline",15:"parseZPolygon",18:"parseZMultiPoint"};function z(e){return e?function(t,r){const n=[t.getFloat64(r,!0),t.getFloat64(r+8,!0)];return e.inverse(n)}:function(t,r){return[t.getFloat64(r,!0),t.getFloat64(r+8,!0)]}}function l(e,t){if(!(this instanceof l))return new l(e,t);this.buffer=e,this.headers=this.parseHeader(),this.shpFuncs(t),this.rows=this.getRows()}l.prototype.shpFuncs=function(e){let t=this.headers.shpCode;if(t>20&&(t-=20),!(t in L))throw new Error(`I don't know shp type "${t}"`);this.parseFunc=this[L[t]],this.parseCoord=z(e)};l.prototype.getShpCode=function(){return this.parseHeader().shpCode};l.prototype.parseHeader=function(){const e=this.buffer;return{length:e.getInt32(24)<<1,version:e.getInt32(28,!0),shpCode:e.getInt32(32,!0),bbox:[e.getFloat64(36,!0),e.getFloat64(44,!0),e.getFloat64(52,!0),e.getFloat64(60,!0)]}};l.prototype.getRows=function(){let e=100;const t=this.buffer.byteLength-8,r=[];let n;for(;e<=t&&(n=this.getRow(e),!!n);)e+=8,e+=n.len,n.type?r.push(this.parseFunc(n.data)):r.push(null);return r};l.prototype.getRow=function(e){const t=this.buffer.getInt32(e),r=this.buffer.getInt32(e+4)<<1;if(r===0)return{id:t,len:r,type:0};if(!(e+r+8>this.buffer.byteLength))return{id:t,len:r,data:new DataView(this.buffer.buffer,this.buffer.byteOffset+e+12,r-4),type:this.buffer.getInt32(e+8,!0)}};function g(e,t){return new l(e,t).rows}var G=/^(?:ANSI\s)?(\d+)$/m;function O(e,t){if(!e)return n;try{new TextDecoder(e.trim())}catch{var r=G.exec(e);return r&&!t?O("windows-"+r[1],!0):(e=void 0,n)}return n;function n(o){var i=new TextDecoder(e||void 0),s=i.decode(o,{stream:!0})+i.decode();return s.replace(/\0/g,"").trim()}}function W(e){var t={};return t.lastUpdated=new Date(e.getUint8(1)+1900,e.getUint8(2),e.getUint8(3)),t.records=e.getUint32(4,!0),t.headerLen=e.getUint16(8,!0),t.recLen=e.getUint16(10,!0),t}function J(e,t,r){for(var n=[],o=32;o<t&&(n.push({name:r(new Uint8Array(e.buffer.slice(e.byteOffset+o,e.byteOffset+o+11))),dataType:String.fromCharCode(e.getUint8(o+11)),len:e.getUint8(o+16),decimal:e.getUint8(o+17)}),e.getUint8(o+32)!==13);)o+=32;return n}function X(e,t,r,n,o){const i=new Uint8Array(e.buffer.slice(e.byteOffset+t,e.byteOffset+t+r));var s=o(i);switch(n){case"N":case"F":case"O":return parseFloat(s,10);case"D":return new Date(s.slice(0,4),parseInt(s.slice(4,6),10)-1,s.slice(6,8));case"L":return s.toLowerCase()==="y"||s.toLowerCase()==="t";default:return s}}function Y(e,t,r,n){for(var o={},i=0,s=r.length,c,u;i<s;)u=r[i],c=X(e,t,u.len,u.dataType,n),t+=u.len,typeof c<"u"&&(o[u.name]=c),i++;return o}function b(e,t){for(var r=O(t),n=W(e),o=J(e,n.headerLen-1,r),i=(o.length+1<<5)+2,s=n.recLen,c=n.records,u=[];c;)u.push(Y(e,i,o,r)),i+=s,c--;return u}const q=globalThis.URL,K=e=>{if(!e)throw new Error("forgot to pass buffer");if(a(e))return new Uint8Array(e);if(a(e.buffer))return e.BYTES_PER_ELEMENT===1?e:new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("invalid buffer like object")},Q=new TextDecoder,U=e=>{if(e){if(typeof e=="string")return e;if(a(e)||ArrayBuffer.isView(e)||P(e))return Q.decode(e)}},T=e=>{if(!e)throw new Error("forgot to pass buffer");if(P(e))return e;if(a(e))return new DataView(e);if(a(e.buffer))return new DataView(e.buffer,e.byteOffset,e.byteLength);throw new Error("invalid buffer like object")};function a(e){return e instanceof globalThis.ArrayBuffer||Object.prototype.toString.call(e)==="[object ArrayBuffer]"}function P(e){return e instanceof globalThis.DataView||Object.prototype.toString.call(e)==="[object DataView]"}const m=function([e,t]){const r={};r.type="FeatureCollection",r.features=[];let n=0;const o=e.length;for(t||(t=[]);n<o;)r.features.push({type:"Feature",geometry:e[n],properties:t[n]||{}}),n++;return r},Z=async function(e,t){let r;e=K(e);const n=await B(e),o=[];t=t||[];for(r in n)r.indexOf("__MACOSX")===-1&&(r.slice(-4).toLowerCase()===".shp"?(o.push(r.slice(0,-4)),n[r.slice(0,-3)+r.slice(-3).toLowerCase()]=n[r]):r.slice(-4).toLowerCase()===".prj"?n[r.slice(0,-3)+r.slice(-3).toLowerCase()]=d(n[r]):r.slice(-5).toLowerCase()===".json"||t.indexOf(r.split(".").pop())>-1?o.push(r.slice(0,-3)+r.slice(-3).toLowerCase()):(r.slice(-4).toLowerCase()===".dbf"||r.slice(-4).toLowerCase()===".cpg")&&(n[r.slice(0,-3)+r.slice(-3).toLowerCase()]=n[r]));if(!o.length)throw new Error("no layers founds");const i=o.map(function(s){let c,u;const f=s.lastIndexOf(".");return f>-1&&s.slice(f).indexOf("json")>-1?(c=JSON.parse(n[s]),c.fileName=s.slice(0,f)):t.indexOf(s.slice(f+1))>-1?(c=n[s],c.fileName=s):(n[s+".dbf"]&&(u=b(n[s+".dbf"],n[s+".cpg"])),c=m([g(n[s+".shp"],n[s+".prj"]),u]),c.fileName=s),c});return i.length===1?i[0]:i};async function ee(e,t){const r=await p(e);return Z(r,t)}const te=async e=>{const t=await Promise.all([p(e,"shp"),p(e,"prj")]);let r=!1;try{t[1]&&(r=d(t[1]))}catch{r=!1}return g(t[0],r)},re=async e=>{const[t,r]=await Promise.all([p(e,"dbf"),p(e,"cpg")]);if(t)return b(t,r)},D=(e,t)=>new q(e,globalThis?.document?.location).pathname.slice(-4).toLowerCase()===t,ne=({shp:e,dbf:t,cpg:r,prj:n})=>{const o=[oe(e,n)];return t&&o.push(se(t,r)),m(o)},ue=async function(e,t){if(typeof e!="string"){if(a(e)||ArrayBuffer.isView(e)||P(e))return Z(e);if(e.shp)return ne(e);throw new TypeError("must be a string, some sort of Buffer, or an object with at least a .shp property")}if(D(e,".zip"))return ee(e,t);D(e,".shp")&&(e=e.slice(0,-4));const r=await Promise.all([te(e),re(e)]);return m(r)},oe=function(e,t){if(e=T(e),t=U(t),typeof t=="string")try{t=d(t)}catch{t=!1}return g(e,t)},se=function(e,t){return e=T(e),t=U(t),b(e,t)};export{m as combine,ue as default,ue as getShapefile,se as parseDbf,oe as parseShp,Z as parseZip};
