import{bU as y,bV as p}from"./main-Crkq4LWq.js";import{t as b}from"./CIMSymbolHelper-nIE1FQPf.js";import{CIMSymbolRasterizer as L}from"./CIMSymbolRasterizer-CMEs_9Y_.js";import{OverrideHelper as R}from"./OverrideHelper-CgrdFD66.js";import{z as C}from"./utils-jjGHTGcN.js";import{l as U,t as M}from"./symbolUtils-CEQ-GrIm.js";import"./preload-helper-DMGCcr4D.js";import"./BidiEngine-QXap_35O.js";import"./fontUtils-CcDLQxe3.js";import"./OptimizedGeometry-DmzaLtTI.js";import"./memoryEstimations-DknB37rc.js";import"./GeometryUtils-BGe_5xyi.js";import"./enums-_AFKM9Yk.js";import"./defaultCIMValues-CQAn2izL.js";import"./definitions-CASyCajO.js";import"./rasterizingUtils-eA7dkndo.js";import"./floatRGBA-DqTSKoin.js";import"./mat2d-D9DBP-jx.js";import"./common-DQOJ18NT.js";import"./mat2df32-Dpt2CT5P.js";import"./vec2-ChnYg_BJ.js";import"./vec2f32-CaVKkSa6.js";import"./Rect-CUzevAry.js";import"./BoundingBox-BSOANoLO.js";import"./CIMResourceManager-rvAZ2gjC.js";import"./imageUtils-rE9d6Mzq.js";import"./colorUtils-DXf65Ue7.js";import"./vec42-CKs01hkn.js";import"./vec4f64-DPb6J-GU.js";import"./FieldsIndex-Cwq_t80R.js";import"./UnknownTimeZone-CGGNrDrV.js";import"./timeZoneUtils-BHCW7jir.js";import"./ArcadeExpression-ON2N40QW.js";import"./TimeOnly-BjqJuv0j.js";import"./enum-DXEdVlyM.js";import"./callExpressionWithFeature-CtoHHKBd.js";import"./quantizationUtils-kCN6oAvL.js";import"./utils-BV55yp3A.js";import"./asyncUtils-DfTs-X0F.js";import"./jsonUtils-BKompkv5.js";import"./parser-B_oj8OEu.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-DgBklfbN.js";import"./cimSymbolUtils-TrTP_j9U.js";import"./LRUCache-BB1cebTv.js";import"./MemCache-BSBM3Sy1.js";import"./jsxFactory-Bp35jaL4.js";import"./intl-BbkIuURR.js";import"./uuid-Cl5lrJ4c.js";import"./sanitizerUtils-CJlLEeXg.js";import"./webStyleSymbolUtils-C5uFZbeR.js";import"./devEnvironmentUtils-8WtPGj6h.js";import"./styleUtils-DFM-g8fO.js";const u=new L(null),g=p(M.size),x=p(M.maxSize),S=p(M.lineWidth),q=1;async function D(m,t,a){const r=t?.size;let i=r!=null&&typeof r=="object"&&"width"in r?r.width:r,o=r!=null&&typeof r=="object"&&"height"in r?r.height:r;if(!i||!o)if(a==="esriGeometryPolygon")i=o=t.maxSize?Math.min(t.maxSize,g):g;else{const n=await E(m,t,a);n&&(i=n.width,o=n.height),a==="esriGeometryPolyline"&&(i=t.maxSize?Math.min(t.maxSize,S):S),i=i!=null&&isFinite(i)?Math.min(i,x):g,o=o!=null&&isFinite(o)?Math.max(Math.min(o,x),q):g}return t.style==="legend"&&a==="esriGeometryPolyline"&&(i=S),{width:i,height:o}}async function E(m,t={},a){const r=t.cimOptions||t;a??=r.geometryType||C(m?.data?.symbol);const{feature:i,fieldMap:o,viewParams:n}=r,l=await R.resolveSymbolOverrides(m.data,i,null,o,a,null,n);if(!l)return null;(m=m.clone()).data={type:"CIMSymbolReference",symbol:l},m.data.primitiveOverrides=void 0;const e=[];return b.fetchResources(l,u.resourceManager,e),b.fetchFonts(l,u.resourceManager,e),e.length>0&&await Promise.all(e),b.getEnvelope(l,null,u.resourceManager)}async function Et(m,t={}){const{node:a,opacity:r,symbolConfig:i}=t,o=i!=null&&typeof i=="object"&&"isSquareFill"in i&&i.isSquareFill,n=t.cimOptions||t,l=n.geometryType||C(m?.data?.symbol),e=await D(m,t,l),{feature:I,fieldMap:G}=n,O=t?.geometry||o||l!=="esriGeometryPolygon"?"preview":"legend";let v=e;const z=e;if(t?.geometry&&(l==="esriGeometryPolygon"||l==="esriGeometryPolyline")&&(y(e.width)<200||y(e.height)<200)){const j=e.width>e.height?p(200)*e.height/e.width:p(200);v={width:e.width>e.height?p(200):p(200)*e.width/e.height,height:j}}const d=await u.rasterizeCIMSymbolAsync(m,I,v,O,G,l,null,n.viewParams,n.allowScalingUp,t?.geometry?.toJSON());if(!d)return null;const{width:$,height:F}=d,h=document.createElement("canvas");h.width=$,h.height=F,h.getContext("2d").putImageData(d,0,0);const f=y(z.width),w=y(z.height),s=new Image(f,w);s.src=h.toDataURL(),s.ariaLabel=t.ariaLabel??null,s.alt=t.ariaLabel??"",r!=null&&(s.style.opacity=`${r}`);let c=s;if(t.effectView!=null){const P={shape:{type:"image",x:0,y:0,width:f,height:w,src:s.src},fill:null,stroke:null,offset:[0,0]};c=U([[P]],[f,w],t)}return a&&c&&a.appendChild(c),c}export{E as getCIMSymbolPreviewSize,Et as previewCIMSymbol};
