const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./imageryUtils-D1uJ8XrJ.js","./utils-CdOwDFje.js","./main-CtmwM019.js","./preload-helper-DMGCcr4D.js","./main-DZFs8ecF.css","./originUtils-CPX8CCAY.js","./multiOriginJSONSupportUtils-C0wm8_Yw.js","./PortalItem-DIOSqTLc.js","./jsonContext-DAOMV9eO.js","./portalItemUtils-NkZYgEQU.js","./projectionUtils-DKBF6_Ma.js","./projectBuffer-C2_ZDxbj.js","./zscale-kI9JnN2z.js","./saveUtils-M2aYeZTs.js","./datasetUtils-XUq4Xmlh.js"])))=>i.map(i=>d[i]);
import{_ as Se}from"./preload-helper-DMGCcr4D.js";import{s as k,cj as B,aI as $e,H as ie,ab as he,i as te,_ as $,Y as D,Z as ge,bJ as De,au as Te,ct as Le,n as Re,aw as Pe,bU as Ae}from"./main-CtmwM019.js";import{l as Ee}from"./MultiOriginJSONSupport-B7nIuRQF.js";import{s as Oe,o as Me}from"./GraphicOrigin-Cpvz1H-u.js";import{p as Ne}from"./BlendLayer-CndHJ5Dn.js";import{s as Ve}from"./CustomParametersMixin-BSUa6HMR.js";import{e as w,t as y,l as O,n as A,r as S,i as P,c as ve,X as ke,a as Fe}from"./xmlUtilities-CuRi_dwt.js";import{b as _e,d as Ge,l as We}from"./OperationalLayer-B3nlDQlP.js";import{j as je}from"./PortalLayer-DqCW7A9B.js";import{e as Be}from"./RasterJobHandlerMixin-DfZUXmGX.js";import{f as qe}from"./RefreshableLayer-EpBsp1kn.js";import{t as Ue}from"./ScaleRangeLayer-8ZzqKGhu.js";import{l as He}from"./TemporalLayer-cM3YuDZI.js";import{m as pe}from"./Field-Qk7kqJE_.js";import{o as ze,p as Ye}from"./rasterFieldUtils-D-BRT95j.js";import{o as ye}from"./crsUtils-DAndLU68.js";import{m as re,L as Xe}from"./RasterSymbolizer-Cs-wmamJ.js";import{U as se,w as Ze,p as Je}from"./datasetUtils-XUq4Xmlh.js";import{I as Ke}from"./vectorFieldUtils-Crjld93f.js";import{d as Qe}from"./popupUtils-CLopyg_a.js";import"./layerContainerType-CSXZNpHb.js";import"./jsonUtils-CG4V1ypX.js";import"./parser-B5KtsVQI.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-Ba1tXzxc.js";import"./TileInfo-_UuYQVlo.js";import"./TileKey-C5vnPZkd.js";import"./QueueProcessor-qttWskRC.js";import"./Queue-CI0vPdwz.js";import"./ReactiveMap-0nkT3Rr1.js";import"./signal-Btlkyg0w.js";import"./RawBlockCache-DIB_Kip4.js";import"./rasterProjectionHelper-ZbLvcUG_.js";import"./projectionUtils-DKBF6_Ma.js";import"./projectBuffer-C2_ZDxbj.js";import"./zscale-kI9JnN2z.js";import"./pixelRangeUtils-BvOub3JO.js";import"./clipUtils-ze_dZt-N.js";import"./PixelBlock-CuGGjl_n.js";import"./FeatureSet-B_ORhMuk.js";import"./rasterFunctionHelper-C9XGT7CZ.js";import"./colorUtils-D3e_O9k3.js";import"./vec42-DZ0sp4MX.js";import"./vec4f64-DPb6J-GU.js";import"./colorRamps-CDthAQF1.js";import"./ElevationInfo-C2AYR3DA.js";import"./lengthUtils-CPuXsfCi.js";import"./asyncUtils-BZq6cT_d.js";import"./PortalItem-DIOSqTLc.js";import"./portalItemUtils-NkZYgEQU.js";import"./ClassBreaksRenderer-BLpCnm-L.js";import"./commonProperties-CITTv46S.js";import"./ColorStop-ClhbS4RX.js";import"./visualVariableUtils-D_kT-o6u.js";import"./RendererLegendOptions-BL5W2r_Q.js";import"./UniqueValueRenderer-Dv7jWKCh.js";import"./diffUtils-MaI4D9Mw.js";import"./styleUtils-CodmB4wT.js";import"./workers-C6h9H2XY.js";import"./intl-BF_HwN3J.js";import"./messages-CIIwatVx.js";import"./normalizeUtils-dN75LHyP.js";import"./Cyclical-BjYazOTz.js";import"./normalizeUtilsCommon-oR7kIHq_.js";import"./utils-PyBYdGi0.js";import"./utils-CjyZX5Fj.js";import"./utils-D6aoGCcc.js";import"./cimSymbolUtils-CBOyuQ8I.js";import"./utils-DQaLv0i_.js";import"./defaultCIMValues-XI-Li77m.js";import"./LRUCache-B52YywOm.js";import"./MemCache-Dy3u4age.js";import"./ClassBreaksDefinition-B_8tKM_d.js";import"./dataUtils-Dk-tNjFC.js";import"./TimeInfo-VXhoxpJp.js";import"./timeZoneUtils-kvnFYCV8.js";import"./fieldType-CgDsR44Y.js";import"./_commonjsHelpers-DCkdB7M8.js";const et=Symbol("isWCSGraphicOrigin");var de;class tt extends Oe{get[(de=et,Me)](){return this.layer}constructor(t){super(),this[de]=!0,this.type="wcs",this.layer=t}get id(){return this.layer.id}}function Z(e){return e.endsWith("?")?e.slice(0,-1):e}function oe(e){return e.filter(({coverageSubType:t})=>t==null||t===""||/^rectified(grid|dataset)/i.test(t))}function nt(e){const t=y(e,"Service/name"),n=w(e,"Capability"),r=w(n,"GetCapabilities/Get/OnlineResource")?.getAttribute("xlink:href")??"",i=w(n,"DescribeCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",o=w(n,"GetCoverage/Get/OnlineResource")?.getAttribute("xlink:href")??"",s={getCapabilities:Z(r),describeCoverage:Z(i),getCoverage:Z(o)},a=A(e,"CoverageOfferingBrief"),p=[];for(let l=0;l<a.length;l++){const c=a[l],d=y(c,"name"),u=A(c,"pos"),m=S(u[0]),f=S(u[1]),h=new B({xmin:m[0],ymin:m[1],xmax:f[0],ymax:f[1],spatialReference:{wkid:4326}});p.push({id:d,lonLatEnvelope:h})}return{name:t,onlineResources:s,coverages:p,gridCoverages:oe(p),supportedVersions:["1.0.0"],version:"1.0.0"}}function be(e){const t={};for(let n=0;n<e.childNodes.length;n++){const r=e.childNodes[n];if(r.nodeType!==1)continue;const i=ve(r).toLowerCase();switch(i){case"title":case"abstract":t[i]=y(r);break;case"identifier":t.id=y(r);break;case"wgs84boundingbox":{const o=S(r,"LowerCorner"),s=S(r,"UpperCorner");t.lonLatEnvelope=new B({xmin:o[0],ymin:o[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(be(r))}}return t}function we(e,t){if(e.coverageSummaries)for(let n=0;n<e.coverageSummaries.length;n++)e.coverageSummaries[n].abstract=e.coverageSummaries[n].abstract||e.abstract,e.coverageSummaries[n].lonLatEnvelope=e.coverageSummaries[n].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[n].title=e.coverageSummaries[n].title||e.title,we(e.coverageSummaries[n],t);e.id!=null&&t.push(e)}function xe(e){const t=w(e.querySelector("Operation[name=GetCapabilities]"),"Get")?.getAttribute("xlink:href")||"",n=w(e.querySelector("Operation[name=DescribeCoverage]"),"Get")?.getAttribute("xlink:href")||"",r=w(e.querySelector("Operation[name=GetCoverage]"),"Get")?.getAttribute("xlink:href")||"";return{getCapabilities:Z(t),describeCoverage:Z(n),getCoverage:Z(r)}}function it(e){const t=y(e,"ServiceIdentification/Title"),n=O(e,"ServiceIdentification/ServiceTypeVersion"),r=xe(w(e,"OperationsMetadata")),i=[],o=w(e,"Contents");for(let a=0;a<o.childNodes.length;a++){const p=o.childNodes[a];p.nodeType===1&&P(p,"CoverageSummary")&&we(be(p),i)}const s=O(o,"SupportedFormat");return{name:t,onlineResources:r,coverages:i,gridCoverages:oe(i),supportedVersions:n,supportedFormats:s,version:"1.1.0"}}function st(e){const t=w(e,"ServiceIdentification"),n=y(t,"Title"),r=O(t,"ServiceTypeVersion"),i=O(t,"Profile"),o=xe(w(e,"OperationsMetadata")),s=A(e,"Contents/CoverageSummary"),a=[];for(let l=0;l<s.length;l++){const c=s[l],d=y(c,"CoverageId"),u=w(c,"WGS84BoundingBox");let m;if(u){const h=S(u,"LowerCorner"),g=S(u,"UpperCorner");m=new B({xmin:h[0],ymin:h[1],xmax:g[0],ymax:g[1],spatialReference:{wkid:4326}})}const f=y(c,"CoverageSubtype")||"RectifiedGridCoverage";a.push({id:d,lonLatEnvelope:m,coverageSubType:f})}const p=w(e,"ServiceMetadata");return{name:n,supportedVersions:r,supportedFormats:O(p,"formatSupported"),supportedInterpolations:O(p,"interpolationSupported").concat(O(p,"InterpolationSupported")),onlineResources:o,profiles:i,coverages:a,gridCoverages:oe(a),version:"2.0.1"}}function rt(e){let t=null;typeof e=="string"?t=new DOMParser().parseFromString(e,"text/xml"):t=e;const n=t.documentElement.getAttribute("version"),r=n?.slice(0,3);return r!=null&&r<"2.1"}function ot(e,t=null){let n=null;typeof e=="string"?n=new DOMParser().parseFromString(e,"text/xml"):n=e;let r=n.documentElement.getAttribute("version");r==="1.0"?r="1.0.0":r==="1.1"&&(r="1.1.0");const i=r||t||"1.0.0",o=i.slice(0,3);let s;if(o==="2.0")s=st(n);else if(o==="1.1")s=it(n);else{if(o!=="1.0")throw new k("wcsraster:parsecapabilities","the capabilities version is not supported");s=nt(n)}return s.version=i,s}function ae(e){e.variables.forEach(t=>t.dimensions.forEach(n=>n.values??=Ze(n)))}function at(e){return{requestResponseCRSs:O(e,"requestResponseCRSs").map(t=>t.split(":")[1]),nativeCRSs:O(e,"nativeCRSs").map(t=>t.split(":")[1])}}function Ce(e,t){const n=O(e,t==="1.0.0"?"interpolationMethod":"InterpolationMethod"),r=t==="1.0.0"?e.getAttribute("default"):y(e,"InterpolationMethods/Default");return r!=null?[r].concat(n.filter(i=>i.toLowerCase()!==r.toLowerCase())):n}function le(e){return e==null?["nearest"]:e.map(t=>{const n=t.toLowerCase();return n.includes("nearest")?"nearest":n.includes("linear")?"bilinear":n.includes("cubic")?"cubic":null}).filter(t=>!!t)}function lt(e){const t=A(e,"pos"),n=S(t[0]),r=S(t[1]);return new B({xmin:n[0],ymin:n[1],xmax:r[0],ymax:r[1],spatialReference:{wkid:4326}})}function ue(e,t){const n=O(e,t);return n?.length&&n[0]!==""&&!isNaN(Number(n[0]))?n.map(r=>Number(r)):null}function ut(e){const t=S(e,"MinimumValue"),n=S(e,"MaximumValue");return t.length&&n.length?t.map((r,i)=>({min:r,max:n[i],avg:-1,stddev:-1})):null}function ce(e){return e==null?null:e.every(t=>t===e[0])?e[0]:e}function ct(e){const t=[],n=A(e,"RangeSet");let r=[];for(let i=0;i<n.length;i++){const o=y(n[i],"name"),s=y(n[i],"label"),a=[],p=ue(n[i],"nullValues/singleValue"),l=A(n[i],"AxisDescription");for(let c=0;c<l.length;c++){const d=y(l[c],"name"),u=y(l[c],"label"),m=O(l[c],"singleValue");if(m.length===0){const f=y(l[c],"min"),h=y(l[c],"max"),g=Number(y(l[c],"res"))||1;if(f!==null&&h!==null)for(let v=parseInt(f,10);v<=parseInt(h,10);v+=g)m.push(v.toString())}d.toLowerCase()==="band"&&(r=m),a.push({name:d,label:u,values:m})}t.push({name:o,label:s,nullValues:p,axis:a})}return{rangeSet:t,bandNames:r}}function pt(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Y","M","D"],r=["H","M","S"],i=["Years","Months","Days","Hours","Minutes","Seconds"];let o,s,a;return t.includes("PT")?(t=t.slice(2),a=r.findIndex(p=>t.includes(p)),o=i[3+a],s=parseFloat(t.slice(0,-1))):(t=t.slice(1),a=n.findIndex(p=>t.includes(p)),a>-1&&(o=i[a]),s=parseFloat(t.slice(0,-1))),{resolution:s,units:o}}function ee(e){const t=A(e,"timeposition");if(t.length>0){const r=[];for(let i=0;i<t.length;i++)r.push(new Date(y(t[i])));return{begin:r[0],end:r[r.length-1],values:r}}const n=w(e,"timePeriod")||w(e,"TimePeriod");return n?{begin:new Date(y(n,"beginPosition")||y(n,"BeginPosition")),end:new Date(y(n,"endPosition")||y(n,"EndPosition")),...pt(y(n,"timeResolution")||y(n,"TimeResolution"))}:null}function dt(e){const t=w(e,"spatialDomain"),n=w(t,"Envelope")||w(t,"EnvelopeWithTimePeriod"),r=n.getAttribute("srsName").split(":"),i=r[r.length-1],o=A(n,"pos"),s=S(o[0]),a=S(o[1]),p=parseInt(i,10),l=isNaN(p)?null:{wkid:p},c=new B({xmin:s[0],ymin:s[1],xmax:a[0],ymax:a[1],spatialReference:l}),d=w(t,"RectifiedGrid"),u=y(d,"low").split(" "),m=y(d,"high").split(" "),f=parseInt(m[0],10)-parseInt(u[0],10)+1,h=parseInt(m[1],10)-parseInt(u[1],10)+1,g=S(t,"origin/pos"),v=A(t,"offsetVector"),b={envelope:c,columns:f,rows:h,offset:{x:parseFloat(y(v[0]).split(" ")[0]),y:parseFloat(y(v[1]).split(" ")[1])},origin:{x:g[0],y:g[1]}},C=w(e,"temporalDomain")||w(e,"TemporalDomain");return{spatialDomain:b,temporalDomain:C?ee(C):null}}function mt(e){const t={version:"1.0"};let n,r=[];for(let f=0;f<e.childNodes.length;f++){const h=e.childNodes[f];if(h.nodeType===1)if(P(h,"description"))t.description=y(h);else if(P(h,"name"))t.name=y(h);else if(P(h,"label"))t.label=y(h);else if(P(h,"supportedFormats"))t.supportedFormats=O(h,"formats");else if(P(h,"supportedCRSs"))t.supportedCRSs=at(h);else if(P(h,"supportedInterpolations"))t.supportedInterpolations=Ce(h,"1.0.0");else if(P(h,"lonLatEnvelope"))t.lonLatEnvelope=lt(h);else if(P(h,"rangeSet")){const g=ct(h);t.rangeSet=g.rangeSet,r=g.bandNames;const v=g.rangeSet[0].nullValues;v?.length&&(n=ce(v))}else P(h,"domainSet")&&(t.domainSet=dt(h))}const i=le(t.supportedInterpolations),{name:o,description:s,label:a,lonLatEnvelope:p,supportedFormats:l}=t,{spatialDomain:c}=t.domainSet,d={x:Math.abs(c.offset.x),y:Math.abs(c.offset.y)},u=ft(t.domainSet),m=new re({width:c.columns,height:c.rows,pixelSize:d,pixelType:"unknown",extent:c.envelope,spatialReference:c.envelope.spatialReference,bandCount:r.length||1,noDataValue:n,multidimensionalInfo:u});return{id:o,title:t.name,description:s||a,lonLatEnvelope:p,rasterInfo:m,bandNames:r,supportedFormats:l,supportedInterpolations:i,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function ft(e){if(!e.temporalDomain)return null;const{begin:t,end:n,values:r,units:i,resolution:o}=e.temporalDomain,s={variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:r?.map(a=>a.getTime()),hasRegularIntervals:!r,interval:o,intervalUnit:i,extent:[t.getTime(),n.getTime()]}]}]};return ae(s),s}function ht(e,t){const n=[],r=A(e,"Field");let i,o=[];for(let s=0;s<r.length;s++){const a=y(r[s],"Identifier"),p=y(r[s],"Description"),l=y(r[s],"Definition"),c=y(r[s],"Abstract"),d=y(r[s],"Title"),u=ue(r[s],"NullValue"),m=w(r[s],"AllowedValues"),f=m?ut(m):null,h=Ce(r[s],"1.1.0"),g=[],v=A(r[s],"Axis");for(let b=0;b<v.length;b++){const C=v[b].getAttribute("identifier"),I=y(v[b],"UOM"),L=y(v[b],"DataType"),q=O(v[b],"Key");t&&!C.toLowerCase().includes("band")||(o=q,i=u),g.push({identifier:C,uom:I,dataType:L,values:q,bandNoDataValues:i})}n.push({identifier:a,description:p,definition:l,abstract:c,title:d,supportedInterpolations:h,axis:g,nullValues:u,statistics:f})}return{rangeSet:n,bandNames:o,bandNoDataValues:i,statistics:n[0].statistics}}function gt(e,t){if(!t.temporalDomain)return null;const n=e.filter(i=>!i.identifier.toLowerCase().includes("field_1")&&!i.axis.some(o=>o.identifier.includes("band"))),r=[];if(n.length&&n.forEach(i=>{const o=i.axis.map(s=>{const a=s.values.map(l=>s.uom==="ISO8601"?(l=l.trim()).toLowerCase().includes("z")?new Date(l).getTime():new Date(l+"Z").getTime():parseFloat(l.trim())),p=[Math.min.apply(null,a),Math.max.apply(null,a)];return{name:s.identifier.trim(),description:"",field:s.identifier.trim(),unit:s.uom?s.uom.trim():"",hasRegularIntervals:!1,values:a,extent:p}});r.push({name:i.identifier.trim(),description:i.description?.trim()??"",unit:"",dimensions:o,statistics:i.statistics})}),t.temporalDomain){const{begin:i,end:o,values:s,units:a,resolution:p}=t.temporalDomain;r.some(l=>l.dimensions.some(c=>c.name.toLowerCase()==="stdtime"))||r.forEach(l=>{l.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:s?.map(c=>c.getTime()),hasRegularIntervals:!s,interval:p,intervalUnit:a,extent:[i.getTime(),o.getTime()]})})}if(r.length){const i={variables:r};return ae(i),i}return null}function vt(e){const t=w(e,"SpatialDomain"),n=w(t,"GridCRS"),r=y(n,"GridBaseCRS"),i=y(n,"GridOrigin"),o=i?.split(" ").map(v=>parseFloat(v))??[0,0],s=S(n,"GridOffsets"),a=A(t,"BoundingBox");let p,l,c,d;for(let v=0;v<a.length;v++){const b=a[v].getAttribute("crs")?.toLowerCase();if(b!=null){if(b.includes("imagecrs")){const C=S(a[v],"LowerCorner"),I=S(a[v],"UpperCorner");p=I[0]-C[0]+1,l=I[1]-C[1]+1}else if(b.indexOf("epsg")>0){const C=b.split(":");c=parseInt(C[C.length-1],10);const I=S(a[v],"LowerCorner"),L=S(a[v],"UpperCorner");d=new B({xmin:I[0],ymin:I[1],xmax:L[0],ymax:L[1],spatialReference:{wkid:c}})}}}const u=p>l,m=d.xmax-d.xmin>d.ymax-d.ymin;let f=!1;ye(c)&&(u===m?f=!1:(f=!0,d=new B({xmin:d.ymin,ymin:d.xmin,xmax:d.ymax,ymax:d.xmax,spatialReference:{wkid:c}})));const h={columns:p,rows:l,origin:{x:o[0],y:o[1]},offset:{x:s[0],y:s[s.length-1]},gridBaseCRS:r,envelope:d,useEPSGAxis:f},g=w(e,"temporalDomain")||w(e,"TemporalDomain");return{spatialDomain:h,temporalDomain:g?ee(g):null}}function yt(e,t){const n=[],r=[],i={supportedFormats:n,supportedCRSs:r,version:"1.1"};let o,s,a=[];for(let v=0;v<e.childNodes.length;v++){const b=e.childNodes[v];if(b.nodeType!==1)continue;const C=ve(b).toLowerCase();switch(C){case"title":case"abstract":case"identifier":i[C]=y(b);break;case"supportedformat":{const I=y(b);n.includes(I)||n.push(I)}break;case"supportedcrs":{const I=y(b);r.includes(I)||r.push(I)}break;case"range":{const I=ht(b,!!i.domain?.temporalDomain);i.range=I.rangeSet,a=I.bandNames;const{bandNoDataValues:L}=I;L?.length&&(o=ce(L)),s=I.statistics}break;case"domain":i.domain=vt(b)}}const p=le(i.range[0].supportedInterpolations),{identifier:l,abstract:c,title:d,domain:u,range:m}=i,f={x:Math.abs(u.spatialDomain.offset.x),y:Math.abs(u.spatialDomain.offset.y)},h=gt(m,u);h&&(o=m[0].nullValues,o?.length===1&&(o=o[0]));const g=new re({width:u.spatialDomain.columns,height:u.spatialDomain.rows,pixelSize:f,pixelType:"unknown",extent:u.spatialDomain.envelope,spatialReference:u.spatialDomain.envelope.spatialReference,bandCount:a.length||1,noDataValue:o,statistics:s,multidimensionalInfo:h});return{id:l,title:i.title,description:c||d,bandNames:a,rasterInfo:g,supportedFormats:n,supportedInterpolations:p,coverageDescription:i,version:t,useEPSGAxis:u.spatialDomain.useEPSGAxis}}function bt(e){const t=w(e,"Envelope")||w(e,"EnvelopeWithTimePeriod"),n=t.getAttribute("srsName"),r=n.slice(n.lastIndexOf("/")+1),i=t.getAttribute("axisLabels").split(" ").map(h=>h.trim()).filter(h=>h.trim()!==""),o=S(t,"lowerCorner"),s=S(t,"upperCorner"),a=!["y","lat","latitude","north","nor","n","b"].includes(i[0].toLowerCase());let p;const l=parseInt(r,10),c=isNaN(l)?null:{wkid:l};p=new B(a?{xmin:o[0],ymin:o[1],xmax:s[0],ymax:s[1],spatialReference:c}:{xmin:o[1],ymin:o[0],xmax:s[1],ymax:s[0],spatialReference:c});const d={mins:o,maxs:s},u=t.getAttribute("uomLabels").trim().split(" ");let m,f;if(P(t,"EnvelopeWithTimePeriod")){m=new Date(y(e,"beginPosition")||y(e,"BeginPosition")),f=new Date(y(e,"endPosition")||y(e,"EndPosition"));const h=u?.findIndex(g=>g?.toLowerCase()==="oledatetime");h>-1&&(u[h]="ISO8601")}return{envelope:p,axisLabels:i,uomLabels:u.length?u:null,envelopeAllDims:d,beginPosition:m,endPosition:f,isEastFirst:a}}function wt(e,t){const n=[],r=A(e,"DataRecord"),i=[];let o,s=[];for(let a=0;a<r.length;a++){const p=A(r[a],"field"),l=[];for(let c=0;c<p.length;c++){const d=p[c].getAttribute("name"),u=y(p[c],"description")||"",m=w(p[c],"uom")?.getAttribute("code")||"",f=S(p[c],"interval"),h=ue(p[c],"nilValue")?.[0];t&&!d.toLowerCase().includes("band")||(i.push(d),f?.length&&(o=o||[],o.push({min:f[0],max:f[1],avg:-1,stddev:-1})),s.push(h)),l.push({name:d,description:u,uom:m,allowedValues:f,nilValue:h})}n.push(l)}return s.some(a=>a!=null)||(s=null),{rangeType:n,bandNames:i,bandStats:o,bandNoDataValues:s}}function xt(e){let t=1,n="";const r=.01;return Math.abs(e-1/24)<1/24*r?n="Hours":Math.abs(e-1)<1*r?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>28-r&&e<31+r||Math.round(e/30)<12?n="Months":e>365-r&&e<366+r&&(n="Years"),{interval:t,intervalUnit:n}}function Ct(e,t,n){if(n.axisLabels.length<=2)return null;const r=[];for(let o=0;o<e.length;o++){const s=e[o];for(let a=0;a<s.length;a++)s[a].name.toLowerCase().includes("band")||r.push(s[a])}const i=[];if(r.length){const o=[];for(let s=2;s<n.axisLabels.length;s++){const a=t.uomLabels?.[s]?.trim()??"",p=n.axisLabels[s].toLowerCase().includes("time")||a.toLowerCase()==="iso8601"||a.toLowerCase()==="oledatetime";let l,c;if(p){const u=xt(n.offset[s]);l=u.interval,c=u.intervalUnit}else l=n.offset[s],c=a;const d=[];p?(d.push(se(t.envelopeAllDims.mins[s])),d.push(se(t.envelopeAllDims.maxs[s]))):(d.push(t.envelopeAllDims.mins[s]),d.push(t.envelopeAllDims.maxs[s])),o.push({name:n.axisLabels[s].trim(),description:n.axisLabels[s].trim(),unit:p?"ISO8601":a,hasRegularIntervals:!0,extent:d,interval:l,intervalUnit:c})}if(r.forEach(s=>{const{allowedValues:a}=s,p=a?.length===2?[{min:a[0],max:a[1],avg:-1,stddev:-1}]:null;i.push({name:s.name.trim(),description:s.description?.trim()??"",unit:s.uom.trim(),statistics:p,dimensions:[...o]})}),i.length){const s={variables:i};return ae(s),s}}return null}function It(e,t){const n=w(e,"RectifiedGrid"),r=S(n,"low"),i=S(n,"high"),o=[];for(let g=0;g<r.length;g++)o.push(i[g]-r[g]+1);const s=y(n,"axisLabels").split(" "),a=S(n,"origin/pos"),p=A(n,"offsetVector"),l=[];for(let g=0;g<p.length;g++){const v=S(p[g]),b=v.findIndex(C=>C!==0);l[b]=v[b]}const c=["y","lat","latitude","north","nor","n","b"];let d=!1;t?.length&&s?.length&&(d=[...t].sort((g,v)=>g<v?-1:1).join(",")===[...s].sort((g,v)=>g<v?-1:1).join(","));const u=d?s:t;let m,f,h;return c.includes(u[0].toLowerCase())?(m=o[1],f=o[0],h={y:Math.abs(l[0]),x:Math.abs(l[1])}):(m=o[0],f=o[1],h={x:Math.abs(l[0]),y:Math.abs(l[1])}),{columns:m,rows:f,origin:a,offset:l,resolution:h,gridSamples:o,axisLabels:s,hasSameAxisLabelsAsBoundedBy:d}}function St(e){const t=w(e,"EarthObservation");if(!t)return null;const n=w(t,"phenomenonTime"),r=n?ee(n):null,i=w(t,"phenomenonTime"),o=i?ee(i):null,s=y(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let a=null;if(s){const p=s.split(" ").map(l=>l.trim()).filter(l=>l!=null&&l!=="").map(Number);if(p.length){const l=[];for(let c=0;c<p.length/2;c+=2)l.push(p[c],p[c+1]);a=new $e({rings:[[l]]})}}return{observation:{phenomenonTime:r,resultTime:o,footprint:a,identifier:y(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:y(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:y(e,"metaDataProperty/EarthObservationMetaData/status")}}}function $t(e){const t={version:"2.0"};let n,r,i=[];for(let d=0;d<e.childNodes.length;d++){const u=e.childNodes[d];if(u.nodeType===1){if(P(u,"coverageId"))t.coverageId=y(u);else if(P(u,"ServiceParameters"))t.serviceParameters={supportedFormats:O(u,"nativeFormat")};else if(P(u,"boundedBy"))t.boundedBy=bt(u);else if(P(u,"rangeType")){const m=wt(u,t.boundedBy?.axisLabels.length>2||t.domainSet?.axisLabels.length>2);t.rangeType=m.rangeType,i=m.bandNames,n=m.bandStats;const{bandNoDataValues:f}=m;f?.length&&(r=ce(f))}else if(P(u,"domainSet"))t.domainSet=It(u,t.boundedBy?.axisLabels);else if(P(u,"metadata")){const m=w(u,"EOMetadata");t.eoMetadata=m?St(m):null}}}const{coverageId:o,boundedBy:s,domainSet:a,rangeType:p,serviceParameters:l}=t,c=Ct(p,s,a);return!n&&c&&(n=c?.variables[0].statistics),c!=null&&(r=p[0][0].nilValue),{id:o,title:o,description:o,bandNames:i,rasterInfo:new re({width:a.columns,height:a.rows,pixelSize:a.resolution,pixelType:"unknown",extent:s.envelope,spatialReference:s.envelope.spatialReference,bandCount:i.length||1,statistics:n,noDataValue:r,multidimensionalInfo:c}),supportedFormats:l.supportedFormats,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function Dt(e,t){let n=null;if(typeof e=="string"?n=new DOMParser().parseFromString(e,"text/xml"):n=e,t==="1.0.0")return A(n,"CoverageOffering").map(i=>mt(i));const r=A(n,"CoverageDescription");return t==="1.1.0"||t==="1.1.1"||t==="1.1.2"?r.map(i=>yt(i,t)):r.map(i=>$t(i))}async function Tt(e,t){const{version:n,customParameters:r,signal:i}=t??{},o=n?.startsWith("1.0")?"version":"acceptVersions",s={service:"WCS",request:"GetCapabilities",[o]:n,...r};try{let{data:a}=await ie(e,{query:s,responseType:"xml",signal:i});return t?.version||rt(a)||(s[o]="2.0.1",{data:a}=await ie(e,{query:s,responseType:"xml",signal:i})),ot(a)}catch(a){throw he(a)?a:new k("wcslayer:open","wcs capabilities is not valid or supported")}}async function ne(e,t){const{coverageIds:n,version:r,customParameters:i,signal:o}=t,s=r.slice(0,3),a=s==="1.0"?"coverage":s==="1.1"?"identifiers":"coverageId",p={service:"WCS",request:"DescribeCoverage",version:r,[a]:n.join(","),...i};try{const{data:l}=await ie(e,{query:p,responseType:"xml",signal:o});return Dt(l,r)}catch(l){throw he(l)?l:new k("wcslayer:open","wcs coverage description is not valid or supported")}}function Lt(e){const t=Pt(e);return t?{isMultipart:!0,data:t.boundary?Rt(e.data,t,0):null}:{isMultipart:!1,data:null}}function Rt(e,t,n=0){const r="--"+t.boundary,i=[];for(let g=0;g<r.length;g++)i.push(r.charCodeAt(g));const o=[],s=`
--`+t.boundary+"--";for(let g=0;g<s.length;g++)o.push(s.charCodeAt(g));const a=[10],p=[13,10],l=[],c=i.length,d=new Uint8Array(e,n),u=d.length-c;let m=0,f=0;for(let g=0;g<u;g++){for(f=0;f<c&&d[g+f]===i[f];f++);if(f!==c)continue;let v=!1;if(m){const b=me(d.subarray(m,g),t);l.push(b),v=!!b.isValidImage}if(g+=c-1,d[g+1]===a[0]?g+=1:d[g+1]===p[0]&&d[g+2]===p[1]&&(g+=2),m=g+1,v)break}const h=o.length;for(let g=d.length-h-10;g<d.length-h;g++){for(f=0;f<h&&d[g+f]===o[f];f++);if(f===h){l.push(me(d.subarray(m,g),t));break}}return l}function Pt(e){const t=e.getHeader?.("Content-Type")?.split(";");if(!t||!(t[0].trim()??"").startsWith("multipart/"))return null;const n={boundary:"",start:"",type:""};for(let r=1;r<t.length;r++){const i=t[r].indexOf("=");if(i>0){const o=t[r].slice(0,i).trim(),s=t[r].slice(i+1).trim();n[o]=s.startsWith('"')?s.slice(1,-1):s}}return n}function me(e,t){const n=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split(`
`),r=Math.min(n.length,7),i={contentDisposition:"inline"};let o=0;for(let s=0;s<r;s++)if(n[s].length<4)o=o+n[s].length+1;else if(n[s].slice(0,7).toLowerCase()==="content"){o=o+n[s].length+1;const a=n[s].indexOf(":");if(a===-1)continue;const p=n[s].slice(0,a).trim(),l=n[s].slice(a+1).trim();switch(p.toLowerCase()){case"content-type":i.contentType=l;break;case"content-description":i.contentDescription=l;break;case"content-transfer-encoding":i.contentTransferEncoding=l;break;case"content-id":i.contentID=l;break;case"content-disposition":i.contentDisposition=l;break;case"content-location":i.contentLocation=l}}else{if(i.contentDisposition.toLowerCase().includes("inline")&&n[s].length>=4&&i.contentType?.toLowerCase().includes("image")){let a=!0,p=e.subarray(o,e.length);if(i.contentType.toLowerCase().indexOf("tif")>0){if(i.contentTransferEncoding==="base64"){let l="";const c=p;for(let u=0;u<c.length;u+=65535){const m=c.subarray(u,u+65535>c.length-1?c.length-1:u+65535);l+=String.fromCharCode.apply(null,m)}const d=atob(l);p=new Uint8Array(d.length);for(let u=0;u<p.length;u++)p[u]=d.charCodeAt(u)}a=p[0]===73&&p[1]===73||p[0]===77&&p[1]===77}if(a){let l=p.buffer;i.contentTransferEncoding!=="base64"&&(l=new ArrayBuffer(e.length-o),p=new Uint8Array(l),p.set(e.subarray(o,e.length))),i.contentData=l,i.isValidImage=!0}break}if((t.start===""||i.contentID===t.start)&&i.contentType){if(i.contentType.includes("text")||i.contentType.includes("xml")){i.contentData=String.fromCharCode.apply(null,e.subarray(o,e.length));break}i.contentData=e.subarray(o,e.length)}}return i}const At=["nearest neighbor","bilinear","bicubic"],Et=["nearest","linear","cubic"],fe="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode",Ot="response is not a supported multipart mediaType with inline tiff",Mt="response is base64 encoded which may impact layer display performance",Nt="server returns an exception",K=new Set(["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"]);let z=class extends ke{constructor(){super(...arguments),this.datasetFormat="WCSServer",this.tileType="Raster"}get rasterId(){return`${this.url}-${this.coverageId}-${this.version}`}async fetchRawTile(e,t,n,r={}){if(this.isBlockOutside(e,t,n))return null;const{nativePixelSize:i,spatialReference:o}=this.rasterInfo,s=2**e,a=i.x*s,p=i.y*s,{blockWidth:l,blockHeight:c}=this.getBlockWidthHeight(e),{origin:d}=this.rasterInfo.storageInfo.tileInfo,u=this.getTileExtent({x:a,y:p},t,n,d,o,[l,c]),m=this.rasterInfo.extent,f=u.xmax>m.xmax,h=u.ymin<m.ymin,g=f||h;let v=u,b=l,C=c;if(g&&(v=u.clone().intersection(m),v!=null&&(f&&(b=Math.floor((v.xmax-v.xmin)/a),v.xmax=v.xmin+a*b),h&&(C=Math.floor((v.ymax-v.ymin)/p),v.ymin=v.ymax-p*C))),v==null||b<=1||C<=1)return null;const I=await this._getCoverage(v,b,C,s,r);if(!I)return null;const{coverageDescription:L}=this.coverageInfo,{noDataValue:q,multidimensionalInfo:M}=this.rasterInfo,{multidimensionalDefinition:U}=r;let j;if(M!=null&&U!=null&&U.length){const Y=U[0].variableName;L.version==="2.0"?j=L.rangeType[0].find(x=>x.name===Y)?.nilValue:L.version==="1.1"&&(j=L.range.find(x=>x.identifier===Y)?.nullValues)}const H=j??q,N=await this.decodePixelBlock(I,{width:b,height:C,planes:null,pixelType:null,tiffNoDataValue:Array.isArray(H)?H[0]:H,matchAllNoData:!0});if(N==null)return null;if(N&&(N.width!==b||N.height!==C))throw new k("wcsraster-fetch",`the response has unexpected dimension width: ${N.width}, height: {pixelBlock.height}`);return g?Ke(N,{x:0,y:0},{width:c,height:c}):N}async _open(e){const{customFetchParameters:t}=this.ioConfig,n=e?.signal,r=await Tt(this.url,{version:t?.version??this.version,customParameters:t,signal:n});if(this.capabilities=r,!this.version){let u=r.version.slice(0,3);u==="2.0"||u==="1.1"||u==="1.0"?this.version=r.version:(u=r.supportedVersions.find(m=>m==="2.0.1")||r.supportedVersions.find(m=>m.startsWith("2.0"))||r.supportedVersions.find(m=>m.startsWith("1.1"))||r.supportedVersions.find(m=>m.startsWith("1.0"))||"1.0.0",this.version=u)}const{version:i}=this;if(!K.has(i))throw new k("wcsraster-open",`unsupported WCS version ${i}`);const{gridCoverages:o}=r;if(!o.length)throw new k("wcsraster-open","cannot find rectified grid coverages");this.coverageId??=o[0].id;const{coverageId:s}=this,a=o.find(u=>u.id===s);if(a==null)throw new k("wcsraster-open",`the coverageId ${s} does not exist in capabilities`);const p=await ne(this.url,{coverageIds:[s],version:i,customParameters:t,signal:n});if(this.coverageInfo=p[0],i.startsWith("2.0")){const{coverageInfo:u}=this;u.lonLatEnvelope=a.lonLatEnvelope,u.supportedInterpolations=le(r.supportedInterpolations),this._patchDimensionValues201(s,n)}this.datasetName=this.coverageInfo.title;const{rasterInfo:l}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(l,512,512),this._set("rasterInfo",l),l.spatialReference==null)throw new k("wcsraster-open",`coverage without spatial reference is not supported: ${s}`);const{pixelType:c,bandCount:d}=await this._getPixelTypeAndBandCount(n);l.pixelType=c,l.bandCount===1&&d>1&&(l.bandCount=d),this.updateTileInfo()}async _patchDimensionValues201(e,t){const{coverageInfo:n}=this,r=n.rasterInfo.multidimensionalInfo?.variables,i=K.has("1.1.2")?"1.1.2":K.has("1.1.1")?"1.1.1":K.has("1.1.0")?"1.1.0":null,{customFetchParameters:o}=this.ioConfig;if(r&&i)try{const s=this.url.includes("/ImageServer/"),a=e.length>8&&e.startsWith("Coverage")&&s?e.slice(8):e,p=await ne(this.url,{coverageIds:[a??e],version:i,customParameters:o,signal:t}).catch(()=>{if(a)return ne(this.url,{coverageIds:[e],version:i,customParameters:o,signal:t})}),l=p?.[0].rasterInfo.multidimensionalInfo?.variables;if(l)for(const c of r){const d=l.find(({name:u})=>u===c.name);if(d?.dimensions?.length)for(let u=c.dimensions.length-1;u>=0;u--){const m=c.dimensions[u],f=d.dimensions.find(({name:h})=>h===m.name);f?f.values&&f.extent?.join(",")===m.extent?.join(",")&&(c.dimensions[u]={...m,values:f.values}):s&&c.dimensions.splice(u,1)}}}catch{}}async _getPixelTypeAndBandCount(e){const{pixelSize:t,extent:n,multidimensionalInfo:r}=this.rasterInfo,i=n.center,o=new B({xmin:i.x-t.x,xmax:i.x+t.x,ymin:i.y-t.y,ymax:i.y+t.y,spatialReference:n.spatialReference});let s=[];if(r!=null){const f=r.variables[0];s=[],f.dimensions.forEach(h=>{s.push(new Je({variableName:f.name,dimensionName:h.name,values:h.hasRegularIntervals?h.extent?.[0]:h.values?.[0],isSlice:!0}))})}const{coverageDescription:a}=this.coverageInfo,p={interpolation:"nearest",multidimensionalDefinition:s,signal:e},{version:l}=a,{ioConfig:c}=this,d=l==="2.0"&&c.allowAnyMediaType==null||l==="1.1"&&c.use2GridOffsets==null;let u;try{u=await this._getCoverage(o,2,2,1,p,!0)}catch(f){if(!d)throw f;if(l==="1.1"){if(!f.details?.isResolutionMismatch)throw f;c.use2GridOffsets=!0}}if(!u&&d&&(l==="2.0"&&(c.allowAnyMediaType=!0),u=await this._getCoverage(o,2,2,1,p),u&&te.getLogger(this).warn("wcsraster:getcoverage",fe)),!u)throw new k("wcsraster-open","unable to determine pixel type");const m=await this.decodePixelBlock(u,{width:2,height:2,planes:null,pixelType:null});if(m==null)throw new k("wcsraster-open","unable to determine pixel type");return{pixelType:m.pixelType,bandCount:m.getPlaneCount()??0}}async _getCoverage(e,t,n,r,i,o=!1){const{coverageDescription:s}=this.coverageInfo,{version:a}=s,p=a==="2.0"?this._getCoverage201Parameters(e,t,n,r,i,s):a==="1.1"?this._getCoverage110Parameters(e,t,n,i,s):this._getCoverage100Parameters(e,t,n,i),l=a==="2.0"?await this.request(this._constructWCS201Url(p),{signal:i.signal,responseType:"array-buffer"}):await this.request(this.url,{query:p,signal:i.signal,responseType:"array-buffer"});if(a==="1.0")return l.data;if(a==="2.0"&&this.ioConfig.allowAnyMediaType!==!1&&Xe(l.data)==="tiff")return o&&(this.ioConfig.allowAnyMediaType=!0,te.getLogger(this).warn("wcsraster:getcoverage",fe)),l.data;const c=Lt(l);if(c.isMultipart&&c.data){const f=c.data.find(h=>h.isValidImage);return o&&f?.contentTransferEncoding==="base64"&&te.getLogger(this).warn("wcsraster:getcoverage",Mt),f?.contentData}const d=new Uint8Array(l.data,0,Math.min(l.data.byteLength,2e3)),u=String.fromCharCode.apply(null,d).toLowerCase().includes("exception"),m=u&&String.fromCharCode.apply(null,d).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");throw u?new k("wcsraster:getcoverage",Nt,{isResolutionMismatch:m}):new k("wcsraster:getcoverage",Ot)}_getInterpolationIndex(e){return e&&this.coverageInfo.supportedInterpolations?.includes(e)?e==="nearest"?0:e==="bilinear"?1:e==="cubic"?2:0:0}_getCoverage100Parameters(e,t,n,r){const i=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,o=e.spatialReference.wkid,s=(this.coverageInfo.supportedFormats||[]).find(f=>f.toLowerCase().includes("tiff"))||"GEOTIFF",{bandIds:a,interpolation:p}=r,l=this._getInterpolationIndex(p),c=a?a.map(f=>this.coverageInfo.bandNames[f]):null,d=At[l],{multidimensionalDefinition:u}=r;let m;if(u!=null&&this.rasterInfo.multidimensionalInfo!=null){let h=u.find(g=>g.dimensionName==="StdTime")?.values;h&&h.length>0&&(Array.isArray(h[0])&&(h=h[0]),m=h.map(g=>Q(g)).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:s,crs:`EPSG:${o}`,bbox:i,width:t,height:n,time:m,interpolation:d,band:c?.join(",")}}_getCoverage110Parameters(e,t,n,r,i){const{multidimensionalDefinition:o,bandIds:s,interpolation:a}=r,p=e.spatialReference.wkid,l=`urn:ogc:def:crs:EPSG::${p}`,c=(this.coverageInfo.supportedFormats||[]).find(R=>R.toLowerCase().includes("tiff"))||"image/tiff",d=this._getInterpolationIndex(a),u=Et[d],m=a==null||this.coverageInfo.supportedInterpolations?.indexOf(a)===0,f=i.domain.spatialDomain,h=f.origin.x<=f.envelope.xmin&&f.origin.y<=f.envelope.ymin,g=e.width/t,v=e.height/n*(h?1:-1),b=h?[e.xmin,e.ymin]:[e.xmin,e.ymax],C=f.useEPSGAxis&&ye(p),I=C?`${b[1]},${b[0]}`:`${b[0]},${b[1]}`,L=this.ioConfig.use2GridOffsets,q=C?L?`${v},${g}`:`${v},0,0,${g}`:L?`${g},${v}`:`${g},0,0,${v}`,M=g/2,U=e.xmin+M,j=e.xmax-M,H=Math.abs(v)/2,N=e.ymin+H,Y=e.ymax-H,J=C?`${N},${U},${Y},${j},${l}`:`${U},${N},${j},${Y},${l}`,x=i.range.find(R=>R.axis.some(F=>F.identifier.toLowerCase().includes("band")));let G,E=x&&u&&s?m?`${x.identifier}[${x.axis[0].identifier}[${s.join(",")}]]`:`${x.identifier}:${u}[${x.axis[0].identifier}[${s.join(",")}]]`:null;if(o!=null&&o.length)for(let R=0;R<o.length;R++){let F=o[R].values;const V=o[R].dimensionName?.toLowerCase(),X=o[R].variableName?.toLowerCase(),_=i.range.find(W=>W.identifier.toLowerCase()===X);if(F.length>0){if(Array.isArray(F[0])&&(F=F[0]),V==="stdtime")G=F.map(W=>Q(W)).join(",");else if(_){const W=_.axis.find(Ie=>Ie.identifier.toLowerCase()===V);W&&(E=m?_.identifier+"["+W.identifier+"["+F.join(",")+"]]":_.identifier+":"+u+"["+W.identifier+"["+F.join(",")+"]]")}}R===o.length-1&&_&&!E&&(E=m?_.identifier:_.identifier+":"+u)}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:c,crs:`EPSG:${p}`,boundingbox:J,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:I,gridOffsets:q,gridBaseCRS:l,timeSequence:G,rangeSubset:E}}_getCoverage201Parameters(e,t,n,r,i,o){const{multidimensionalDefinition:s,interpolation:a}=i,p=this._getInterpolationIndex(a);let l=null;const{supportedInterpolations:c}=this.capabilities;if(c?.length)switch(p){case 0:l=c.find(x=>x.toLowerCase().includes("nearest"));break;case 1:l=c.find(x=>x.toLowerCase().includes("linear"));break;case 2:l=c.find(x=>x.toLowerCase().includes("cubic")||x.toLowerCase().includes("quadratic"))}const d=(this.coverageInfo.supportedFormats||[]).find(x=>x.toLowerCase().includes("tiff"))||"image/tiff",{bandNames:u}=this.coverageInfo,{boundedBy:m,domainSet:f,rangeType:h}=o,g=m.isEastFirst?0:1,v=1-g,{axisLabels:b}=m,C=b[g],I=b[v],L=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,q=L,M=[];M.push(`${C}(${e.xmin},${e.xmax})`),M.push(`${I}(${e.ymin},${e.ymax})`);const U=[];if(b.length>2)for(let x=2;x<b.length;x++){const G=f.origin[x];if(b[x].toLowerCase().includes("time")){let E=G.toString();m.uomLabels?.[x].toLowerCase().includes("ole")&&(U.push(b[x]),E=Q(G,!0)),M.push(b[x]+",http://www.opengis.net("+E+")")}else M.push(b[x]+",http://www.opengis.net("+G+")")}let j=null;if(s!=null&&s.length){const x=[];h.forEach(E=>E.forEach(R=>x.push(R.name)));const G=[];for(let E=0;E<s.length;E++){const R=b.find(V=>V===s[E].dimensionName),F=x.find(V=>V===s[E].variableName);if(G.includes(F)||G.push(F),R){let V=s[E].values;if(V.length>0){Array.isArray(V[0])&&(V=V[0]);let X="";X=R.toLowerCase().includes("time")?V.map(W=>Q(W)).join(","):V.join(",");const _=M.findIndex(W=>W.startsWith(R+",http://www.opengis.net"));_===-1&&M.push(R+",http://www.opengis.net("+X+")"),_===-1||M[_].includes("("+X+")")||M.splice(_,1,R+",http://www.opengis.net("+X+")")}}}G.length&&(j=G.join(","))}else u?.length>=2&&(j=(i.bandIds?i.bandIds.map(x=>u[x]):u).join(","));const H=M.join("&subset="),N=!o.domainSet.hasSameAxisLabelsAsBoundedBy&&this.ioConfig.allowScaleFactor!==!1,Y=N?null:`${C}(${t}),${I}(${n})`,J=N?1/r:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:j,interpolation:l,scaleSize:Y,scaleFactor:J,subset:H,format:d,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:L,subsettingcrs:q}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},n=[];return Object.keys(t).forEach(r=>{const i=t[r];i!=null&&(r==="subset"?typeof i=="string"&&i.split("&subset=").forEach(o=>{o&&n.push(`subset=${encodeURIComponent(o)}`)}):n.push(`${r}=${encodeURIComponent(i)}`))}),`${encodeURI(this.url)}?${n.join("&")}`}};function Q(e,t=!1){return(t?new Date(se(e)):new Date(e)).toISOString()}$([D({type:String,json:{write:!0}})],z.prototype,"datasetFormat",void 0),$([D({readOnly:!0})],z.prototype,"tileType",void 0),$([D({type:String,json:{write:!0}})],z.prototype,"version",void 0),$([D({type:String,json:{write:!0}})],z.prototype,"coverageId",void 0),$([D({readOnly:!0})],z.prototype,"rasterId",null),z=$([ge("esri.layers.support.rasterDatasets.WCSRaster")],z);const Vt=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let T=class extends Ne(Ue(_e(je(Ve(Fe(Be(He(qe(Ee(De(Te))))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.graphicOrigin=new tt(this),this.legendEnabled=!0,this.noData=0,this.operationalLayerType="WCS",this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this._debouncedSaveOperations=Le(async(t,n,r)=>{const{save:i,saveAs:o}=await Se(()=>import("./imageryUtils-D1uJ8XrJ.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14]),import.meta.url);switch(t){case 0:return i(this,n);case 1:return o(this,r,n)}})}normalizeCtorArgs(e,t){return typeof e=="string"?{url:e,...t}:e}load(e){const t=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WCS"]},e).catch(Re).then(()=>this._openRaster(t))),Promise.resolve(this)}get renderer(){return super.renderer}set renderer(e){super.renderer=e}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){const e=[ze("Pixel Value")],t=this.raster?.rasterInfo??this.serviceRasterInfo,n=t?.multidimensionalInfo;if(n){const r=Ye(n);e.push(...r)}return e}createPopupTemplate(e){return Qe({fields:this.rasterFields,title:this.title},e)}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,t){return this._debouncedSaveOperations(1,t,e)}async _openRaster(e){const t=new z({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await t.open({signal:e}),!t.rasterInfo)throw t.destroy(),new k("wcs-layer:load","cannot load resources on "+this.url);const{rasterInfo:n}=t;n.noDataValue==null&&(n.noDataValue=this.noData),this._set("serviceRasterInfo",n),this._set("spatialReference",n.spatialReference),this.title==null&&this.setAtOrigin("title",t.datasetName,"service"),this.coverageId==null&&this.setAtOrigin("coverageId",t.coverageInfo.id,"service"),this.version==null&&t.version&&this.setAtOrigin("version",t.version,"service"),this.setAtOrigin("tileInfo",t.rasterInfo.storageInfo.tileInfo,"service");const{multidimensionalInfo:r}=n;if(r!=null){const i=r.variables[0].dimensions.find(({name:o})=>o==="StdTime");if(i){let o=i.extent?.[0]??i.values[0];Array.isArray(o)&&(o=o[0]);let s=i.extent?.[1]??i.values[i.values.length-1];Array.isArray(s)&&(s=s[1]);const a=Vt.has(i.intervalUnit?.toLowerCase())?i.intervalUnit?.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:o,end:s},timeZone:null,interval:a?{value:i.interval,unit:a}:null})}}this.raster=t,this._configDefaultSettings(),this.addHandles(Pe(()=>this.customParameters,i=>this.raster.ioConfig.customFetchParameters=i))}};$([D({type:String,nonNullable:!0,json:{name:"wcsInfo.coverageId",write:{isRequired:!0,ignoreOrigin:!0}}})],T.prototype,"coverageId",void 0),$([D()],T.prototype,"coverageInfo",null),$([D({type:["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"],nonNullable:!0,json:{name:"wcsInfo.version",write:{isRequired:!0,ignoreOrigin:!0}}})],T.prototype,"version",void 0),$([D({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],T.prototype,"isReference",void 0),$([D({json:{read:!0,write:!0}})],T.prototype,"blendMode",void 0),$([D({readOnly:!0,clonable:!1})],T.prototype,"graphicOrigin",void 0),$([D(Ge)],T.prototype,"legendEnabled",void 0),$([D({type:["show","hide"]})],T.prototype,"listMode",void 0),$([D()],T.prototype,"noData",void 0),$([D({type:["WCS"]})],T.prototype,"operationalLayerType",void 0),$([D()],T.prototype,"raster",void 0),$([D({readOnly:!0})],T.prototype,"type",void 0),$([D(We)],T.prototype,"popupEnabled",void 0),$([D({type:Ae,json:{name:"popupInfo",write:!0}})],T.prototype,"popupTemplate",void 0),$([D({readOnly:!0})],T.prototype,"defaultPopupTemplate",null),$([D({readOnly:!0,type:[pe]})],T.prototype,"fields",void 0),$([D({readOnly:!0,type:[pe]})],T.prototype,"rasterFields",null),T=$([ge("esri.layers.WCSLayer")],T);const li=T;export{li as default};
