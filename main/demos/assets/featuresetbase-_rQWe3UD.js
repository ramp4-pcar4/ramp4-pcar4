import{aR as J,_ as b,Y as D,Z as ae,a7 as Ne,a6 as Te,aH as $e,a0 as we,H as Re,kt as Me,i as Oe,aG as Ge,eX as j,eZ as A,M as Ee,C as Ve,kT as ze,bR as He}from"./main-CtmwM019.js";import{m as We}from"./TimeOnly-BYrd6q6s.js";import{t as _e,l as le}from"./arcade-BBgWo9VK.js";import{o as v,w as Be,m as ue,B as U,p as R,g as k,Z as Je,c as De,l as ve,X as ke,z as L,T as K,H as te,t as W,L as Ke,S as Q,Y as Qe,a0 as ne}from"./Dictionary-DIDyRWej.js";import{n as y,o as qe,t as Ye}from"./enum-BshDcSFN.js";import{I as Xe}from"./Feature-SbXO3u4G.js";import{v as et,R as Se,y as tt,h as de,e as nt,i as it,s as rt,F as re,E as ot,k as at,O as st,a as H,I as lt,D as ie,b as Z,x as me}from"./featureSetUtils-DaAS3Js9.js";import{t as ut}from"./ImmutableArray-BPVd6ESQ.js";import{l as dt}from"./portalUtils-CfDrFthw.js";import{s as mt,v as xe}from"./SpatialFilter-CdAdk3HJ.js";import{N as Ae,o as ce}from"./shared-B_51gLwt.js";import{L as E}from"./WhereClause-CX4_Dr18.js";import Le from"./FeatureLayer-DBYbkoOt.js";import{m as P}from"./Field-Qk7kqJE_.js";import{f as ct,u as ft,s as pt}from"./utils-PyBYdGi0.js";import{s as B}from"./NetworkElement-D9hPIizS.js";import"./preload-helper-DMGCcr4D.js";import"./UnknownTimeZone-B7fquLC-.js";import"./arcadeEnvironment-DMxuwDuN.js";import"./aiServices-GldRxNRU.js";import"./commonProperties-DHiB1uzW.js";import"./streamLayerUtils-DFlbJ4P1.js";import"./unitConversion-BsKt_ZxW.js";import"./number-C5dztEtP.js";import"./uuid-Oe6SV2kF.js";import"./featureConversionUtils-CQ7EbBKb.js";import"./OptimizedFeature-69ue8f4g.js";import"./memoryEstimations-R8dTJqWI.js";import"./OptimizedGeometry-CYLi7ZPm.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./FieldsIndex-BfaTaUfm.js";import"./timeZoneUtils-kvnFYCV8.js";import"./MD5-MtSiOt06.js";import"./RelationshipQuery-ls8nTUVI.js";import"./Query-COoGphoa.js";import"./FeatureType-D717FchM.js";import"./FeatureTemplate-1J12NhoS.js";import"./PortalItem-DIOSqTLc.js";import"./operatorsWorkerConnection-BigrmA6M.js";import"./workers-C6h9H2XY.js";import"./Queue-CI0vPdwz.js";import"./intl-BF_HwN3J.js";import"./messages-CIIwatVx.js";import"./MultiOriginJSONSupport-B7nIuRQF.js";import"./layerContainerType-CSXZNpHb.js";import"./FormTemplate-B4JA8wQ7.js";import"./GraphicOrigin-Cpvz1H-u.js";import"./editsZScale-CJEnMqBA.js";import"./queryZScale-CrJkqKkY.js";import"./zscale-kI9JnN2z.js";import"./FeatureSet-B_ORhMuk.js";import"./APIKeyMixin-gt9C4hUv.js";import"./ArcGISService-CUnVsm8d.js";import"./BlendLayer-CndHJ5Dn.js";import"./jsonUtils-CG4V1ypX.js";import"./parser-B5KtsVQI.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-Ba1tXzxc.js";import"./CustomParametersMixin-BSUa6HMR.js";import"./DisplayFilteredLayer-BGN639L6.js";import"./scaleUtils-a7XRoboI.js";import"./displayFilterUtils-CiFXGMg6.js";import"./EditBusLayer-B80jOqdL.js";import"./FeatureEffectLayer-Dmr1OurZ.js";import"./FeatureEffect-CgInv-VA.js";import"./FeatureFilter-pwJGuGC0.js";import"./fieldType-CgDsR44Y.js";import"./FeatureLayerBase-B8GQlBZp.js";import"./HeightModelInfo-4xHEEYmq.js";import"./OperationalLayer-B3nlDQlP.js";import"./ElevationInfo-C2AYR3DA.js";import"./lengthUtils-CPuXsfCi.js";import"./labelingInfo-CdJLoto5.js";import"./asyncUtils-BZq6cT_d.js";import"./SimpleRenderer-DmSIoU9k.js";import"./commonProperties-CITTv46S.js";import"./colorRamps-CDthAQF1.js";import"./ColorStop-ClhbS4RX.js";import"./visualVariableUtils-D_kT-o6u.js";import"./UniqueValueRenderer-Dv7jWKCh.js";import"./diffUtils-MaI4D9Mw.js";import"./RendererLegendOptions-BL5W2r_Q.js";import"./styleUtils-CodmB4wT.js";import"./NormalizationBinParametersMixin-CtnfVVUk.js";import"./labelUtils-DW8GzzSE.js";import"./LayerFloorInfo-7mpr0gwB.js";import"./multiLayerServiceUtils-CqbVDfIA.js";import"./Relationship-D9UKU0DT.js";import"./serviceCapabilitiesUtils-Db1gOsp6.js";import"./infoFor3D-DhzudQro.js";import"./portalItemUtils-NkZYgEQU.js";import"./projectionUtils-DKBF6_Ma.js";import"./projectBuffer-C2_ZDxbj.js";import"./FeatureReductionLayer-5n1WsRnN.js";import"./FeatureReductionSelection-l3I6K5Qx.js";import"./jsonUtils-C--8yvkH.js";import"./typeUtils-pFgvz36j.js";import"./ClassBreaksRenderer-BLpCnm-L.js";import"./LRUCache-B52YywOm.js";import"./MemCache-Dy3u4age.js";import"./DictionaryScriptEvaluator-fEbpVylv.js";import"./Version-D0TrQevW.js";import"./ArcadeExpression-BHsVDuiI.js";import"./utils-DQaLv0i_.js";import"./defaultCIMValues-XI-Li77m.js";import"./heatmapUtils-BD7oEhAj.js";import"./vec42-DZ0sp4MX.js";import"./vec4f64-DPb6J-GU.js";import"./OrderedLayer-z-_cQBay.js";import"./OrderByInfo-BZbZuUrB.js";import"./PortalLayer-DqCW7A9B.js";import"./RefreshableLayer-EpBsp1kn.js";import"./ScaleRangeLayer-8ZzqKGhu.js";import"./TemporalLayer-cM3YuDZI.js";import"./TimeInfo-VXhoxpJp.js";import"./TrackableLayer-BpYuVEmC.js";import"./fieldProperties-nT7rCf4_.js";import"./TitleCreator-amToajmJ.js";import"./sanitizerUtils-BSv1Bmu5.js";import"./versionUtils-DBVgQtM3.js";import"./styleUtils-BMGjzn-w.js";import"./popupUtils-CLopyg_a.js";new J({Clean:"clean",Dirty:"dirty"});new J({Physical:"physical",Virtual:"virtual"});new J({"Start and end":"start-and-end",Start:"start",Midspan:"midspan",End:"end"});new J({startingPoint:"starting-point",barrier:"barrier",stoppingPoint:"stopping-point"});new J({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation",path:"path",circuit:"circuit"});const Ue="{00000000-0000-0000-0000-000000000000}",M=new J({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new J({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let _=class extends B{constructor(r){super(r),this.type="telecomNetworkElement",this.firstUnit=null,this.numUnits=null}};b([D({json:{write:!1}})],_.prototype,"type",void 0),b([D({json:{write:!0}})],_.prototype,"firstUnit",void 0),b([D({json:{write:!0}})],_.prototype,"numUnits",void 0),_=b([ae("esri.rest.networks.support.TelecomNetworkElement")],_);let x=class extends we{constructor(u){super(u),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(u,t){return t.fromFirstUnit||t.fromNumUnits?new _({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId,firstUnit:t.fromFirstUnit,numUnits:t.fromNumUnits}):new B({globalId:t.fromGlobalId,networkSourceId:t.fromNetworkSourceId,terminalId:t.fromTerminalId})}writeFromNetworkElement(u,t){if(u&&(t.fromGlobalId=u.globalId,t.fromNetworkSourceId=u.networkSourceId,t.fromTerminalId=u.terminalId,u.type==="telecomNetworkElement")){const i=u;t.fromFirstUnit=i.firstUnit,t.fromNumUnits=i.numUnits}}readToNetworkElement(u,t){return t.toFirstUnit||t.toNumUnits?new _({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId,firstUnit:t.toFirstUnit,numUnits:t.toNumUnits}):new B({globalId:t.toGlobalId,networkSourceId:t.toNetworkSourceId,terminalId:t.toTerminalId})}writeToNetworkElement(u,t){if(u&&(t.toGlobalId=u.globalId,t.toNetworkSourceId=u.networkSourceId,t.toTerminalId=u.terminalId,u.type==="telecomNetworkElement")){const i=u;t.toFirstUnit=i.firstUnit,t.toNumUnits=i.numUnits}}equals(u){if(this.globalId===Ue&&u.globalId===Ue){let t=function(s,p){return s.networkSourceId===p.networkSourceId&&s.globalId===p.globalId&&s.terminalId===p.terminalId&&s.firstUnit===p.firstUnit&&s.numUnits===p.numUnits};const i=this.fromNetworkElement,w=this.toNetworkElement,I=u.fromNetworkElement,e=u.toNetworkElement,n=t(i,I),a=t(w,e);return n&&a&&this.associationType===u.associationType}return this.globalId!=null&&u.globalId!=null&&this.globalId===u.globalId}};b([D({type:String,json:{write:!0}})],x.prototype,"globalId",void 0),b([D({type:M.apiValues,json:{type:M.jsonValues,read:M.read,write:M.write}})],x.prototype,"associationType",void 0),b([D({type:B,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number},fromFirstUnit:{type:Number},fromNumUnits:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId","fromFirstUnit","fromNumUnits"]}}})],x.prototype,"fromNetworkElement",void 0),b([Ne("fromNetworkElement")],x.prototype,"readFromNetworkElement",null),b([Te("fromNetworkElement")],x.prototype,"writeFromNetworkElement",null),b([D({type:B,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number},toFirstUnit:{type:Number},toNumUnits:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId","toFirstUnit","toNumUnits"]}}})],x.prototype,"toNetworkElement",void 0),b([Ne("toNetworkElement")],x.prototype,"readToNetworkElement",null),b([Te("toNetworkElement")],x.prototype,"writeToNetworkElement",null),b([D({type:$e,json:{write:!0}})],x.prototype,"geometry",void 0),b([D({type:String,json:{write:!0}})],x.prototype,"errorMessage",void 0),b([D({type:Number,json:{write:!0}})],x.prototype,"percentAlong",void 0),b([D({type:Number,json:{write:!0}})],x.prototype,"errorCode",void 0),b([D({type:Boolean,json:{write:!0}})],x.prototype,"isContentVisible",void 0),b([D({type:Number,json:{write:!0}})],x.prototype,"status",void 0),x=b([ae("esri.rest.networks.support.Association")],x);let oe=class extends we{constructor(u){super(u),this.associations=[]}};b([D({type:[x],json:{write:!0}})],oe.prototype,"associations",void 0),oe=b([ae("esri.rest.networks.support.QueryAssociationsResult")],oe);function yt(r){const{returnDeletes:u,elements:t,gdbVersion:i,moment:w}=r.toJSON();return{returnDeletes:u,elements:JSON.stringify(t.map(I=>({globalId:I.globalId,networkSourceId:I.networkSourceId,terminalId:I.terminalId}))),types:JSON.stringify(r.types.map(I=>M.toJSON(I))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:i,moment:w??Date.now()}}async function wt(r,u,t){const i=ct(r),w={...yt(u),f:"json"},I=ft({...i.query,...w}),e=pt(I,{...t,method:"post"}),n=`${i.path}/associations/query`,{data:a}=await Re(n,e),s=oe.fromJSON(a);return u.types.includes("connectivity")&&Me(Oe.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://arcg.is/11Tr8a#types",version:"4.29",warnOnce:!0}),s}var pe;let V=pe=class extends we{static from(r){return Ge(pe,r)}constructor(r){super(r),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};b([D({type:Boolean,json:{write:!0}})],V.prototype,"returnDeletes",void 0),b([D({type:[B],json:{write:!0}})],V.prototype,"elements",void 0),b([D({type:[M.apiValues],json:{type:M.jsonValues,read:M.read,write:M.write}})],V.prototype,"types",void 0),b([D({type:String,json:{write:!0}})],V.prototype,"gdbVersion",void 0),b([D({type:Date,json:{type:Number,write:{writer:(r,u)=>{u.moment=r?.getTime()}}}})],V.prototype,"moment",void 0),V=pe=b([ae("esri.rest.networks.support.QueryAssociationsParameters")],V);function It(r){if(r.length===1){if(A(r[0]))return le("distinct",r[0],-1);if(W(r[0]))return le("distinct",r[0].toArray(),-1)}return le("distinct",r,-1)}function fe(r,u,t){const i=r.getVariables();if(i.length>0){const w={};for(const I of i)w[I]=u.evaluateIdentifier(t,{name:I});r.parameters=w}return r}function m(r,u,t=null){for(const i in r)if(i.toLowerCase()===u.toLowerCase())return r[i];return t}function Ce(r){if(r===null)return null;const u={type:m(r,"type",""),name:m(r,"name","")};if(u.type==="range")u.range=m(r,"range",[]);else{u.codedValues=[];for(const t of m(r,"codedValues",[]))u.codedValues.push({name:m(t,"name",""),code:m(t,"code",null)})}return u}function ye(r){if(r===null)return null;const u={},t=m(r,"wkt");t!==null&&(u.wkt=t);const i=m(r,"wkid");return i!==null&&(u.wkid=i),u}function je(r){if(r===null)return null;const u={hasZ:m(r,"hasz",!1),hasM:m(r,"hasm",!1)},t=m(r,"spatialreference");t!=null&&(u.spatialReference=ye(t));const i=m(r,"x",null);if(i!==null)return u.x=i,u.y=m(r,"y",null),u.hasZ&&(u.z=m(r,"z",null)),u.hasM&&(u.m=m(r,"m",null)),u;const w=m(r,"rings",null);if(w!==null)return u.rings=w,u;const I=m(r,"paths",null);if(I!==null)return u.paths=I,u;const e=m(r,"points",null);if(e!==null)return u.points=e,u;for(const n of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const a=m(r,n,null);a!==null&&(u[n]=a)}return u}function gt(r,u){for(const t of u)if(t===r)return!0;return!1}function ht(r){return!!r.layerDefinition&&!!r.featureSet&&gt(r.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&A(r.layerDefinition.fields)!==!1&&A(r.featureSet.features)!==!1}function q(r){return r?.toLowerCase()==="utc"?"UTC":r?.toLowerCase()==="unknown"?"Unknown":r}async function bt(r,u,t,i,w,I,e){const n=await r.getFeatureSetInfo();if((n?.layerId??null)===null||!w.layerIdLookup.get(n.layerId))return null;const a=r.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),s=[];switch(t){case"connected":s.push("connectivity"),s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity"),s.push("junction-edge-midspan-connectivity"),s.push("junction-junction-connectivity");break;case"container":case"content":s.push("containment");break;case"structure":case"attached":s.push("attachment");break;case"junctionedge":s.push("junction-edge-from-connectivity"),s.push("junction-edge-to-connectivity");break;case"midspan":s.push("junction-edge-midspan-connectivity");break;default:throw new y(I,"InvalidParameter",e)}let p=null,c=!1;if(i!==null&&i!==""&&i!==void 0){for(const d of w.terminals)d.terminalName===i&&(p=d.terminalId);p===null&&(c=!0)}const l=[];if(!c){const d=new B({globalId:u.field(r.globalIdField),networkSourceId:w.layerIdLookup.get(n.layerId).sourceId,...p?{terminalId:p}:""}),f=await wt(a,new V({types:s,elements:[d]}));let S=0;for(const g of f.associations){let h=null,T="",$="";if(g.fromNetworkElement?.globalId===d.globalId?(h=g.toNetworkElement,$="to"):g.toNetworkElement?.globalId===d.globalId&&(h=g.fromNetworkElement,$="from"),!h)continue;switch(t){case"attached":if(g.associationType!=="attachment"||$!=="to")continue;break;case"structure":if(g.associationType!=="attachment"||$!=="from")continue;break;case"container":if(g.associationType!=="containment"||$!=="from")continue;break;case"content":if(g.associationType!=="containment"||$!=="to")continue;break;case"connected":break;case"junctionedge":g.associationType==="junction-edge-to-connectivity"?T="to":g.associationType==="junction-edge-from-connectivity"&&(T="from");break;case"midspan":if(g.associationType!=="junction-edge-midspan-connectivity")continue}const Y=w.sourceIdLookup.get(h.networkSourceId)?.className??"";l.push(new He({geometry:null,attributes:{objectId:S++,globalId:h.globalId,percentAlong:g.percentAlong??0,isContentVisible:g.isContentVisible?0:1,className:Y,side:T}}))}}const o=new Le({source:l,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new P({name:"objectId",alias:"objectId",type:"oid"}),new P({name:"globalId",alias:"globalId",type:"global-id"}),new P({name:"percentAlong",alias:"percentAlong",type:"double"}),new P({name:"side",alias:"side",type:"string"}),new P({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new P({name:"className",alias:"className",type:"string"})]});return re(o)}function Ri(r){if(r.mode==="async"){r.functions.timezone=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,1,2,t,i),Be(e[0])||ue(e[0]))return"Unknown";if(U(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?q("unknown"):q(e[0].dateFieldsTimeZone);if(!(e[1]instanceof R)||e[1].hasField("type")===!1)throw new y(t,"InvalidParameter",i);const s=e[1].field("type");if(j(s)===!1)throw new y(t,"InvalidParameter",i);switch(k(s).toLowerCase()){case"preferredtimezone":return q(e[0].preferredTimeZone);case"editfieldsinfo":return q(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return q(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&j(e[1].field("fieldname")))return q(e[0].fieldTimeZone(k(e[1].field("fieldname"))))}throw new y(t,"InvalidParameter",i)}const n=Je(e[0],De(t));if(n===null)return null;const a=n.timeZone;return a==="system"?We.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a.toLowerCase()==="unknown"?"Unknown":a})},r.functions.sqltimestamp=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{v(e,1,3,t,i);const n=e[0];if(ve(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(k(e[1])).toSQLWithKeyword();throw new y(t,"InvalidParameter",i)}if(ue(n))return n.toSQLWithKeyword();if(U(n)){if(e.length!==3)throw new y(t,"InvalidParameter",i);await n.load();const a=k(e[1]);if(ue(e[2]))return e[2].toSQLWithKeyword();if(ve(e[2])===!1)throw new y(t,"InvalidParameter",i);const s=n.fieldTimeZone(a);return s==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(s).toSQLWithKeyword()}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"sqltimestamp",min:2,max:4}),r.functions.featuresetbyid=function(t,i){return r.standardFunctionAsync(t,i,(w,I,e)=>{if(v(e,2,4,t,i),ke(e[0])){const n=k(e[1]);let a=L(e[2],null);const s=K(L(e[3],!0));if(a===null&&(a=["*"]),A(a)===!1)throw new y(t,"InvalidParameter",i);return e[0].featureSetById(n,s,a)}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"featuresetbyid",min:2,max:4});const u=new qe(["datasource","parent","root"]);r.functions.getfeatureset=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,1,2,t,i),te(e[0])){const n=e[1]==null?"datasource":u.lookup(k(e[1]));return et(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference)}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"getfeatureset",min:1,max:2}),r.functions.featuresetbyportalitem=function(t,i){return r.standardFunctionAsync(t,i,(w,I,e)=>{if(v(e,2,5,t,i),e[0]===null)throw new y(t,"PortalRequired",i);if(e[0]instanceof _e){const c=k(e[1]),l=k(e[2]);let o=L(e[3],null);const d=K(L(e[4],!0));if(o===null&&(o=["*"]),A(o)===!1)throw new y(t,"InvalidParameter",i);let f;return f=t.services?.portal?t.services.portal:Ee.getDefault(),f=dt(e[0],f),Se(c,l,t.spatialReference,o,d,f,t.lrucache,t.interceptor)}if(j(e[0])===!1)throw new y(t,"PortalRequired",i);const n=k(e[0]),a=k(e[1]);let s=L(e[2],null);const p=K(L(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new y(t,"InvalidParameter",i);return Se(n,a,t.spatialReference,s,p,t.services?.portal??Ee.getDefault(),t.lrucache,t.interceptor)})},r.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),r.functions.featuresetbyname=function(t,i){return r.standardFunctionAsync(t,i,(w,I,e)=>{if(v(e,2,4,t,i),ke(e[0])){const n=k(e[1]);let a=L(e[2],null);const s=K(L(e[3],!0));if(a===null&&(a=["*"]),A(a)===!1)throw new y(t,"InvalidParameter",i);return e[0].featureSetByName(n,s,a)}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"featuresetbyname",min:2,max:4}),r.functions.featureset=function(t,i){return r.standardFunction(t,i,(w,I,e)=>{v(e,1,1,t,i);const n={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(j(e[0])){const a=JSON.parse(e[0]);a.layerDefinition!==void 0?(n.layerDefinition=a.layerDefinition,n.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(n.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(n.featureSet.features=a.features,n.featureSet.geometryType=a.geometryType,n.layerDefinition.geometryType=n.featureSet.geometryType,n.layerDefinition.objectIdField=a.objectIdFieldName??"",n.layerDefinition.typeIdField=a.typeIdFieldName,n.layerDefinition.globalIdField=a.globalIdFieldName,n.layerDefinition.fields=a.fields,a.spatialReference&&(n.layerDefinition.spatialReference=a.spatialReference))}else{if(!(e[0]instanceof R))throw new y(t,"InvalidParameter",i);{const a=JSON.parse(e[0].castToText(!0)),s=m(a,"layerdefinition");if(s!==null){n.layerDefinition.geometryType=m(s,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.globalIdField=m(s,"globalidfield",""),n.layerDefinition.objectIdField=m(s,"objectidfield",""),n.layerDefinition.typeIdField=m(s,"typeidfield",""),n.layerDefinition.hasZ=m(s,"hasz",!1)===!0,n.layerDefinition.hasM=m(s,"hasm",!1)===!0;const p=m(s,"spatialreference");p&&(n.layerDefinition.spatialReference=ye(p));const c=[];for(const o of m(s,"fields",[])){const d={name:m(o,"name",""),alias:m(o,"alias",""),type:m(o,"type",""),nullable:m(o,"nullable",!0),editable:m(o,"editable",!0),length:m(o,"length",null),domain:Ce(m(o,"domain"))};c.push(d)}n.layerDefinition.fields=c;const l=m(a,"featureset");if(l){const o={};for(const d of c)o[d.name.toLowerCase()]=d.name;for(const d of m(l,"features",[])){const f={},S=m(d,"attributes",{});for(const g in S)f[o[g.toLowerCase()]]=S[g];n.featureSet.features.push({attributes:f,geometry:je(m(d,"geometry"))})}}}else{n.layerDefinition.hasZ=m(a,"hasz",!1)===!0,n.layerDefinition.hasM=m(a,"hasm",!1)===!0,n.layerDefinition.geometryType=m(a,"geometrytype",""),n.featureSet.geometryType=n.layerDefinition.geometryType,n.layerDefinition.objectIdField=m(a,"objectidfieldname",""),n.layerDefinition.typeIdField=m(a,"typeidfieldname","");const p=m(a,"spatialreference");p&&(n.layerDefinition.spatialReference=ye(p));const c=[],l=m(a,"fields",null);if(!A(l))throw new y(t,"InvalidParameter",i);for(const f of l){const S={name:m(f,"name",""),alias:m(f,"alias",""),type:m(f,"type",""),nullable:m(f,"nullable",!0),editable:m(f,"editable",!0),length:m(f,"length",null),domain:Ce(m(f,"domain"))};c.push(S)}n.layerDefinition.fields=c;const o={};for(const f of c)o[f.name.toLowerCase()]=f.name;let d=m(a,"features",null);if(A(d))for(const f of d){const S={},g=m(f,"attributes",{});for(const h in g)S[o[h.toLowerCase()]]=g[h];n.featureSet.features.push({attributes:S,geometry:je(m(f,"geometry",null))})}else d=null,n.featureSet.features=d}}}if(ht(n)===!1)throw new y(t,"InvalidParameter",i);return n.layerDefinition.geometryType||(n.layerDefinition.geometryType="esriGeometryNull"),tt.create(n,t.spatialReference)})},r.signatures.push({name:"featureset",min:1,max:1}),r.functions.filter=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,2,2,t,i),A(e[0])||W(e[0])){const n=[];let a,s=e[0];if(s instanceof ut&&(s=s.toArray()),!Ke(e[1]))throw new y(t,"InvalidParameter",i);a=e[1].createFunction(t);for(const p of s){const c=a(p);Ve(c)?await c===!0&&n.push(p):c===!0&&n.push(p)}return n}if(U(e[0])){const n=await e[0].load(),a=E.create(e[1],{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),s=a.getVariables();if(s.length>0){const p={};for(const c of s)p[c]=r.evaluateIdentifier(t,{name:c});a.parameters=p}return new de({parentfeatureset:e[0],whereclause:a})}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"filter",min:2,max:2}),r.functions.orderby=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,2,2,t,i),U(e[0])){const n=new nt(e[1]);return new it({parentfeatureset:e[0],orderbyclause:n})}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"orderby",min:2,max:2}),r.functions.top=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,2,2,t,i),U(e[0]))return new rt({parentfeatureset:e[0],topnum:e[1]});if(A(e[0]))return Q(e[1])>=e[0].length?e[0].slice():e[0].slice(0,Q(e[1]));if(W(e[0]))return Q(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,Q(e[1]));throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"top",min:2,max:2}),r.functions.first=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,1,1,t,i),U(e[0])){const n=await e[0].first(w.abortSignal);if(n!==null){const a=Xe.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return a._underlyingGraphic=n,a}return n}return A(e[0])?e[0].length===0?null:e[0][0]:W(e[0])?e[0].length()===0?null:e[0].get(0):null})},r.signatures.push({name:"first",min:1,max:1}),r.functions.attachments=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{v(e,1,2,t,i);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof R){if(e[1].hasField("minsize")&&(n.minsize=Q(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=K(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=Q(e[1].field("maxsize"))),e[1].hasField("types")){const a=Qe(e[1].field("types"),!1);a.length>0&&(n.types=a)}}else if(e[1]!==null)throw new y(t,"InvalidParameter",i)}if(te(e[0])){const a=e[0]._layer;let s;if(U(a))s=a;else{if(a==null||!Ae(a))return[];s=re(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await s.load(),s.queryAttachments(e[0].field(s.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata)}if(e[0]===null)return[];throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"attachments",min:1,max:2}),r.functions.featuresetbyrelationshipname=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{v(e,2,4,t,i);const n=e[0],a=k(e[1]);let s=L(e[2],null);const p=K(L(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new y(t,"InvalidParameter",i);if(e[0]===null)return null;if(!te(e[0]))throw new y(t,"InvalidParameter",i);const c=n._layer;let l;if(U(c))l=c;else{if(c==null||!Ae(c))return null;l=re(c,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}l=await l.load();const o=l.relationshipMetaData().filter(h=>h.name===a);if(o.length===0)return null;if(o[0].relationshipTableId!==void 0&&o[0].relationshipTableId!==null&&o[0].relationshipTableId>-1)return ot(l,o[0],n.field(l.objectIdField),l.spatialReference,s,p,t.lrucache,t.interceptor);let d=l.serviceUrl();if(!d)return null;d=d.endsWith("/")?d+o[0].relatedTableId.toString():d+"/"+o[0].relatedTableId.toString();const f=await at(d,l.spatialReference,s,p,t.lrucache,t.interceptor);await f.load();let S=f.relationshipMetaData();if(S=S.filter(h=>h.id===o[0].id),n.hasField(o[0].keyField)===!1||n.field(o[0].keyField)===null){const h=await l.getFeatureByObjectId(n.field(l.objectIdField),[o[0].keyField]);if(h){const T=E.create(S[0].keyField+"= @id",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});return T.parameters={id:h.attributes[o[0].keyField]},f.filter(T)}return new mt({parentfeatureset:f})}const g=E.create(S[0].keyField+"= @id",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});return g.parameters={id:n.field(o[0].keyField)},f.filter(g)})},r.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),r.functions.featuresetbyassociation=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{v(e,2,3,t,i);const n=e[0],a=Ye(k(L(e[1],""))),s=j(e[2])?k(e[2]):null;if(e[0]===null)return null;if(!te(e[0]))throw new y(t,"InvalidParameter",i);let p=n._layer;if(p instanceof Le&&(p=re(p,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),p===null||U(p)===!1)return null;await p.load();const c=p.serviceUrl(),l=await st(c,t.spatialReference,!0);if(l.unVersion>=8)return await bt(p,n,a,s,l,t,i);const o=l.associations;let d=null,f=null,S=!1;if(s!==null&&s!==""&&s!==void 0){for(const N of l.terminals)N.terminalName===s&&(f=N.terminalId);f===null&&(S=!0)}const g=o.getFieldsIndex(),h=g.get("TOGLOBALID").name,T=g.get("FROMGLOBALID").name,$=g.get("TOTERMINALID").name,Y=g.get("FROMTERMINALID").name,X=g.get("FROMNETWORKSOURCEID").name,ee=g.get("TONETWORKSOURCEID").name,z=g.get("ASSOCIATIONTYPE").name,Ze=g.get("ISCONTENTVISIBLE").name,Pe=g.get("OBJECTID").name;for(const N of p.fields)if(N.type==="global-id"){d=n.field(N.name);break}let O=null,Ie=new H(new P({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=new H(new P({name:"side",alias:"side",type:"string"}),E.create("''",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));const C="globalid",he="globalId",be={};for(const N in l.lkp)be[N]=l.lkp[N].sourceId;const G=new lt(new P({name:"classname",alias:"classname",type:"string"}),null,be);let F="";switch(a){case"midspan":{F=`((${h}='${d}') OR ( ${T}='${d}')) AND (${z} IN (5))`,G.codefield=E.create(`CASE WHEN (${h}='${d}') THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const N=ce(Z.findField(o.fields,T));N.name=C,N.alias=C,O=new H(N,E.create(`CASE WHEN (${T}='${d}') THEN ${h} ELSE ${T} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),Ie=l.unVersion>=4?new me(Z.findField(o.fields,g.get("PERCENTALONG").name)):new H(new P({name:"percentalong",alias:"percentalong",type:"double"}),E.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{F=`((${h}='${d}') OR ( ${T}='${d}')) AND (${z} IN (4,6))`,G.codefield=E.create(`CASE WHEN (${h}='${d}') THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const N=ce(Z.findField(o.fields,T));N.name=C,N.alias=C,O=new H(N,E.create(`CASE WHEN (${T}='${d}') THEN ${h} ELSE ${T} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=new H(new P({name:"side",alias:"side",type:"string"}),E.create(`CASE WHEN (${z}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let N=`${h}='@T'`,Fe=`${T}='@T'`;f!==null&&(N+=` AND ${$}=@A`,Fe+=` AND ${Y}=@A`),F="(("+N+") OR ("+Fe+"))",F=ne(F,"@T",d??""),N=ne(N,"@T",d??""),f!==null&&(N=ne(N,"@A",f.toString()),F=ne(F,"@A",f.toString())),G.codefield=E.create("CASE WHEN "+N+` THEN ${X} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const se=ce(Z.findField(o.fields,T));se.name=C,se.alias=C,O=new H(se,E.create("CASE WHEN "+N+` THEN ${T} ELSE ${h} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"container":F=`${h}='${d}' AND ${z} = 2`,f!==null&&(F+=` AND ${$} = `+f.toString()),G.codefield=X,F="( "+F+" )",O=new ie(Z.findField(o.fields,T),C,C);break;case"content":F=`(${T}='${d}' AND ${z} = 2)`,f!==null&&(F+=` AND ${Y} = `+f.toString()),G.codefield=ee,F="( "+F+" )",O=new ie(Z.findField(o.fields,h),C,C);break;case"structure":F=`(${h}='${d}' AND ${z} = 3)`,f!==null&&(F+=` AND ${$} = `+f.toString()),G.codefield=X,F="( "+F+" )",O=new ie(Z.findField(o.fields,T),C,he);break;case"attached":F=`(${T}='${d}' AND ${z} = 3)`,f!==null&&(F+=` AND ${Y} = `+f.toString()),G.codefield=ee,F="( "+F+" )",O=new ie(Z.findField(o.fields,h),C,he);break;default:throw new y(t,"InvalidParameter",i)}return S&&(F="1 <> 1"),new Z({parentfeatureset:o,adaptedFields:[new me(Z.findField(o.fields,Pe)),new me(Z.findField(o.fields,Ze)),O,ge,G,Ie],extraFilter:F?E.create(F,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}):null})})},r.signatures.push({name:"featuresetbyassociation",min:2,max:6}),r.functions.groupby=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,3,3,t,i),!U(e[0]))throw new y(t,"InvalidParameter",i);const n=await e[0].load(),a=[],s=[];let p=!1,c=[];if(j(e[1]))c.push(e[1]);else if(e[1]instanceof R)c.push(e[1]);else if(A(e[1]))c=e[1];else{if(!W(e[1]))throw new y(t,"InvalidParameter",i);c=e[1].toArray()}for(const l of c)if(j(l)){const o=E.create(k(l),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),d=xe(o)===!0?k(l):"%%%%FIELDNAME";a.push({name:d,expression:o}),d==="%%%%FIELDNAME"&&(p=!0)}else{if(!(l instanceof R))throw new y(t,"InvalidParameter",i);{const o=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",d=l.hasField("expression")?l.field("expression"):"";if(o==="%%%%FIELDNAME"&&(p=!0),!o)throw new y(t,"InvalidParameter",i);a.push({name:o,expression:E.create(d||o,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(c=[],j(e[2]))c.push(e[2]);else if(A(e[2]))c=e[2];else if(W(e[2]))c=e[2].toArray();else{if(!(e[2]instanceof R))throw new y(t,"InvalidParameter",i);c.push(e[2])}for(const l of c){if(!(l instanceof R))throw new y(t,"InvalidParameter",i);{const o=l.hasField("name")?l.field("name"):"",d=l.hasField("statistic")?l.field("statistic"):"",f=l.hasField("expression")?l.field("expression"):"";if(!(o&&d&&j(d)&&f))throw new y(t,"InvalidParameter",i);s.push({name:o,statistic:d,expression:E.create(f,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const l={};for(const d of n.fields)l[d.name.toLowerCase()]=1;for(const d of a)d.name!=="%%%%FIELDNAME"&&(l[d.name.toLowerCase()]=1);for(const d of s)d.name!=="%%%%FIELDNAME"&&(l[d.name.toLowerCase()]=1);let o=0;for(const d of a)if(d.name==="%%%%FIELDNAME"){for(;l["field_"+o.toString()]===1;)o++;l["field_"+o.toString()]=1,d.name="FIELD_"+o.toString()}}for(const l of a)fe(l.expression,r,t);for(const l of s)fe(l.expression,r,t);return e[0].groupby(a,s)})},r.signatures.push({name:"groupby",min:3,max:3}),r.functions.distinct=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(U(e[0])){v(e,2,2,t,i);const n=await e[0].load(),a=[];let s=[];if(j(e[1]))s.push(e[1]);else if(e[1]instanceof R)s.push(e[1]);else if(A(e[1]))s=e[1];else{if(!W(e[1]))throw new y(t,"InvalidParameter",i);s=e[1].toArray()}let p=!1;for(const c of s)if(j(c)){const l=E.create(k(c),{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC}),o=xe(l)===!0?k(c):"%%%%FIELDNAME";a.push({name:o,expression:l}),o==="%%%%FIELDNAME"&&(p=!0)}else{if(!(c instanceof R))throw new y(t,"InvalidParameter",i);{const l=c.hasField("name")?c.field("name"):"%%%%FIELDNAME",o=c.hasField("expression")?c.field("expression"):"";if(l==="%%%%FIELDNAME"&&(p=!0),!l)throw new y(t,"InvalidParameter",i);a.push({name:l,expression:E.create(o||l,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC})})}}if(p){const c={};for(const o of n.fields)c[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(c[o.name.toLowerCase()]=1);let l=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;c["field_"+l.toString()]===1;)l++;c["field_"+l.toString()]=1,o.name="FIELD_"+l.toString()}}for(const c of a)fe(c.expression,r,t);return e[0].groupby(a,[])}return It(e)})},r.functions.getfeaturesetinfo=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,1,1,t,i),!U(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?R.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},De(t),!1,!1):null})},r.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),r.functions.filterbysubtypecode=function(t,i){return r.standardFunctionAsync(t,i,async(w,I,e)=>{if(v(e,2,2,t,i),U(e[0])){const n=await e[0].load(),a=e[1];if(!ze(a))throw new y(t,"InvalidParameter",i);if(n.subtypeField){const p=E.create(`${n.subtypeField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new de({parentfeatureset:e[0],whereclause:p})}if(n.typeIdField===null||n.typeIdField==="")throw new y(t,"FeatureSetDoesNotHaveSubtypes",i);const s=E.create(`${n.typeIdField}= ${e[1]}`,{fieldsIndex:n.getFieldsIndex(),timeZone:n.dateFieldsTimeZoneDefaultUTC});return new de({parentfeatureset:e[0],whereclause:s})}throw new y(t,"InvalidParameter",i)})},r.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{Ri as registerFunctions};
