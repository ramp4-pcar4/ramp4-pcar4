const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lclayout-6cdRR6IH.js","./_commonjsHelpers-DCkdB7M8.js"])))=>i.map(i=>d[i]);
import{D as le,la as K,H as et,bc as q,s as z,bS as dt,eS as ut,a1 as tt,V as rt,i as it,e as ct,dH as Q,cj as pe,jy as $e,aI as st,_ as y,Y as h,Z as ye,iT as yt,j0 as ht,hU as ie,bC as ve,eg as mt,j_ as Se,eV as ft,dS as ee,j2 as gt,bI as bt,aH as wt,cn as Tt,au as It,L as A,bU as Et,a6 as _t}from"./main-CtmwM019.js";import{e as Nt}from"./OptimizedGeometry-CYLi7ZPm.js";import{i as Ie,r as $t,n as Ee,a as J,l as vt,V as St}from"./knowledgeGraphService-B_H0wIMy.js";import{N as de,W as se}from"./projectionUtils-DKBF6_Ma.js";import{I as ue,t as ce,_ as R,E as ne,S as _e,o as be}from"./constants-SxxbBSOD.js";import{u as Lt}from"./featureConversionUtils-CQ7EbBKb.js";import{s as Le}from"./OptimizedFeature-69ue8f4g.js";import"./GraphicsLayer-C7dUYDum.js";import{_ as Mt}from"./preload-helper-DMGCcr4D.js";import{p as V,a as Me,i as ke}from"./Relationship-DPDJm8R-.js";import{b as Z}from"./Query-COoGphoa.js";import{l as kt}from"./MultiOriginJSONSupport-B7nIuRQF.js";import{E as Dt}from"./workers-C6h9H2XY.js";import{s as nt,o as at}from"./GraphicOrigin-Cpvz1H-u.js";import{f as Ct}from"./FeatureStore-MFqN-udL.js";import{W as xt}from"./QueryEngine-tjWp4k4C.js";import{u as De}from"./clientSideDefaults-BIU6pn-N.js";import{s as Ft}from"./fieldProperties-nT7rCf4_.js";import{l as Rt,F as At}from"./FormTemplate-B4JA8wQ7.js";import{P as Ot}from"./normalizeUtils-dN75LHyP.js";import{s as jt,t as Pt}from"./QueryEngineCapabilities-DJC_YILC.js";import{a as qt}from"./FeatureTemplate-1J12NhoS.js";import{A as Y,d as ae,l as Gt}from"./labelingInfo-CdJLoto5.js";import{p as Ut,n as Ht,l as zt}from"./BlendLayer-CndHJ5Dn.js";import{a as Qt,p as Wt,l as Vt}from"./DisplayFilteredLayer-BGN639L6.js";import{c as Bt,p as Jt}from"./FeatureEffectLayer-Dmr1OurZ.js";import{f as Zt,a as Yt}from"./FeatureReductionLayer-5n1WsRnN.js";import{p as Kt,c as Xt}from"./OrderedLayer-z-_cQBay.js";import{f as er}from"./RefreshableLayer-EpBsp1kn.js";import{t as tr}from"./ScaleRangeLayer-8ZzqKGhu.js";import{l as rr,f as ir}from"./TemporalLayer-cM3YuDZI.js";import{d as sr,v as nr,j as ar,w as or,l as lr}from"./OperationalLayer-B3nlDQlP.js";import{m as oe}from"./Field-Qk7kqJE_.js";import{u as pr}from"./TimeInfo-VXhoxpJp.js";import{p as dr}from"./SimpleRenderer-DmSIoU9k.js";import{fromJSON as Ce}from"./jsonUtils-C--8yvkH.js";import{m as ur}from"./typeUtils-pFgvz36j.js";import{g as cr}from"./FeatureSet-B_ORhMuk.js";import{d as yr}from"./popupUtils-CLopyg_a.js";import{L as xe}from"./utils-D6aoGCcc.js";let hr=class{constructor(){this.version="",this.queryResult=new mr}},mr=class{constructor(){this.featureResult=new fr}},fr=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new gr,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new br,this.geometryType=null,this.spatialReference=new le,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new ot,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},gr=class{constructor(){this.name="",this.isSystemMaintained=!1}},br=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},ot=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new wr,this.translate=new Tr}},wr=class{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}},Tr=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},Ir=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},Er=class{constructor(){this.attributes=[],this.compressedGeometry=new we,this.centroid=new we,this.aggregateGeometries=[]}},we=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};const _r=["ELEMENTUID","TYPENAME"],Nr={upperLeft:0,lowerLeft:1},$r={sqlTypeBigInt:0,sqlTypeBinary:1,sqlTypeBit:2,sqlTypeChar:3,sqlTypeDate:4,sqlTypeDecimal:5,sqlTypeDouble:6,sqlTypeFloat:7,sqlTypeGeometry:8,sqlTypeGUID:9,sqlTypeInteger:10,sqlTypeLongNVarchar:11,sqlTypeLongVarbinary:12,sqlTypeLongVarchar:13,sqlTypeNChar:14,sqlTypeNVarChar:15,sqlTypeOther:16,sqlTypeReal:17,sqlTypeSmallInt:18,sqlTypeSqlXml:19,sqlTypeTime:20,sqlTypeTimestamp:21,sqlTypeTimestamp2:22,sqlTypeTinyInt:23,sqlTypeVarbinary:24,sqlTypeVarchar:25};function vr(t){const e=new hr;e.version=t.version;const r=t.get_query_result();if(r.results_type.value!==0)throw new Error("Got a non-feature collection type");const i=r.get_feature_result(),s=e.queryResult.featureResult;s.objectIdFieldName=i.objectid_field_name,s.exceededTransferLimit=i.exceeded_transfer_limit,s.hasM=i.has_m,s.hasZ=i.has_z,s.geometryType=K(Ie,i.geometry_type.value),s.globalIdFieldName=i.globalid_field_name,s.geohashFieldName=i.geohash_field_name;const n=s.uniqueIdField,l=i.unique_id_field;n.name=l.name,n.isSystemMaintained=l.isSystemMaintained;const d=s.geometryProperties,c=i.geometry_properties;d.shapeAreaFieldName=c.shapeAreaFieldName,d.shapeLengthFieldName=c.shapeLengthFieldName,d.units=c.units;const m=s.spatialReference,a=i.spatial_reference;m.wkid=a.wkid,m.latestWkid=a.latestWkid,m.vcsWkid=a.vcsWkid,m.latestVcsWkid=a.latestVcsWkid,m.wkt=a.wkt,s.transform=Lr(i.transform);const o=s.fields,p=s.fieldNameToAttributeIndexMap,u=i.fields,b=u.size();for(let _=0;_<b;_++){const N=u.get(_),L=lt(N);o.push(L),p[L.name]=_,N.delete()}u.delete();const T=s.values,g=i.values_count();for(let _=0;_<g;_++)T.push(i.get_value_at(_));const v=s.features,E=i.features,M=E.size();if(M>0){for(const _ of _r)if(p[_]===void 0)throw new Error(`Feature collection missing required attribute: ${_}`)}for(let _=0;_<M;_++){const N=new Er,L=E.get(_),j=N.attributes,G=L.attributes_count();for(let F=0;F<G;F++)j.push(L.get_attribute_at(F));const U=L.get_compressed_geometry();U&&(N.compressedGeometry=me(U),N.centroid=me(L.get_centroid()));const D=N.aggregateGeometries,C=L.aggregate_geometries,x=C.size();for(let F=0;F<x;F++){const k=C.get(F),X=me(k);D.push(X),k.delete()}C.delete(),v.push(N),L.delete()}E.delete();const $=s.geometryFields,S=i.geometry_fields,w=S.size();for(let _=0;_<w;_++){const N=S.get(_),L=Sr(N);$.push(L),N.delete()}return S.delete(),e}function me(t){const e=new we;e.geometryType=K(Ie,t.geometry_type.value);const r=[],i=[];for(let s=0;s<t.lengths.length;s++)r.push(t.lengths[s]);for(let s=0;s<t.coords.length;s++)i.push(t.coords[s]);return e.lengths=r,e.coords=i,e}function lt(t){const e=new Ir;return e.name=t.name,e.alias=t.alias,e.fieldType=K($t,t.field_type.value),e.sqlType=K($r,t.sql_type.value),e.domain=t.domain,e.defaultValue=t.default_value,e}function Sr(t){const e=lt(t);return e.geometryType=K(Ie,t.geometry_type.value),e}function Lr(t){const e=new ot;e.quantizeOriginPosition=K(Nr,t.quantizeOriginPosition.value);const r=e.scale,i=t.scale;r.xScale=i.xScale,r.yScale=i.yScale,r.mScale=i.mScale,r.zScale=i.zScale;const s=e.translate,n=t.translate;return s.xTranslate=n.xTranslate,s.yTranslate=n.yTranslate,s.mTranslate=n.mTranslate,s.zTranslate=n.zTranslate,e}async function Mr(t){const e=[],r={generateAllSublayers:!1,namedTypeDefinitions:new Map};return t.entitiesUrl&&e.push(Fe(t.entitiesUrl).then(i=>{Re(i,r)})),t.relationshipsUrl&&e.push(Fe(t.relationshipsUrl).then(i=>{Re(i,r)})),await Promise.all(e),r}async function ss(t,e){e??=!1;const r={generateAllSublayers:e,namedTypeDefinitions:new Map};return await Cr(t).then(i=>{Fr(i,r)}),r}async function ns(t){const e=await Ee(),r=new e.MapOfObjectIdentifierSets;kr(r,e,t);const i=new e.MapOfObjectIdentifierSetsEncoder;try{i.set_map_of_identifier_sets(r),i.encode();const s=i.get_encoding_result();if(s.error.error_code!==0)throw new z("knowledge-graph:layer-support-utils",s.error.error_message);const n=structuredClone(s.get_byte_buffer());return i.delete(),n}finally{r.delete()}}function kr(t,e,r){for(const[i,s]of r.namedTypeDefinitions){if(!s.members||s.useAllData)continue;const n=s.members.keys();let l=!1,d=!0;const c=new e.ObjectIdArray,m=new e.StringArray,a=new e.GlobalIdArray,o=new e.IdentifierArray,p=new e.ObjectIdentifierSet;for(const u of n)d&&(l=!isNaN(Number(u)),d=!1),l?c.add_objectid(Number(u)):(m.add_string(u),a.add_globalid(u)),o.add_identifier(u);p.set_oid_array(c),p.set_string_array(m),p.set_globalid_array(a),p.set_identifier_array(o),c.delete(),m.delete(),a.delete(),o.delete(),t.put_identifier_set(i,p),p.delete()}return t}async function Fe(t){const e=await et(t,{responseType:"array-buffer"});return Dr(await e.data)}async function Dr(t){const e=new(await Ee()).FeatureCollectionDecoder,r=e.decode(new Uint8Array(t));if(r.error_code!==0)throw new z("knowledge-graph:layer-support-utils",r.error_message);const i=e.get_feature_collection(),s=vr(i);return e.delete(),s}async function Cr(t){const e=await et(t,{responseType:"array-buffer"}),r=await e.data;return xr(new Uint8Array(r))}async function xr(t){const e=new(await Ee()).MapOfObjectIdentifierSetsDecoder,r=e.decode(new Uint8Array(t)),i=new Map;if(r.error_code!==0)throw new z("knowledge-graph:layer-support-utils",r.error_message);const s=e.get_map_of_identifier_sets(),n=s.keys,l=n.size();for(let d=0;d<l;d++){const c=n.get(d),m=s.query_identifier_set(c),a=[];if(m.id_array_type.value===1){const o=m.get_globalid_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_globalid_at(u))}else if(m.id_array_type.value===3){const o=m.get_identifier_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_identifier_at(u).toString())}else if(m.id_array_type.value===2){const o=m.get_string_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_string_at(u))}else{if(m.id_array_type.value!==0)throw new z("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const o=m.get_oid_array(),p=o.count();for(let u=0;u<p;u++)a.push(o.get_objectid_at(u).toString())}}i.set(c,a)}return e.delete(),i}function Re(t,e){if(!t?.queryResult?.featureResult)return e;const r=t.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const i of t.queryResult.featureResult.features){const s=i.attributes[r.TYPENAME],n=q(e.namedTypeDefinitions,s,()=>({useAllData:!1,members:new Map})),l=i.attributes[r.ELEMENTUID];if(i.compressedGeometry?.coords?.length>0){let d=i.compressedGeometry.lengths;i.compressedGeometry.geometryType==="esriGeometryPoint"&&(d=[]),n.members.set(l,{id:l,linkChartLocation:new Nt(d,i.compressedGeometry.coords)})}else n.members.set(l,{id:l})}return e}function Fr(t,e){for(const[r,i]of t){const s=q(e.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map}));for(const n of i)s.members.has(n)||s.members.set(n,{id:n})}return e}const as={fetchAndConvertSerializedLinkChart:t=>Mr(t)},Te=(t,e)=>{if(t.type==="column-reference")return t.column===e.systemOidFieldName?"ID(n)":`n.${t.column}`;if(t.type==="string")return`'${t.value}'`;if(t.type==="number")return`${t.value}`;if(t.type==="binary-expression"&&e.supportedSqlTypes.has(t.left.type)&&e.supportedSqlTypes.has(t.right.type)&&e.supportedSqlOperators.has(t.operator))return`${Te(t.left,e)} ${t.operator} ${Te(t.right,e)}`;if(t.type==="binary-expression"&&t.operator==="LIKE"){let r="";if(t.left.type==="function"&&t.left.args.value[0].type==="column-reference")r+=`lower(n.${t.left.args.value[0].column})`;else{if(t.left.type!=="column-reference")return e.unsupportedOperationFound=!0,"";r+=`lower(n.${t.left.column})`}if(r+=" CONTAINS (",t.right.type!=="string")return e.unsupportedOperationFound=!0,"";{let i=t.right.value;i.startsWith("%")&&(i=i.slice(1)),i.endsWith("%")&&(i=i.slice(0,-1)),r+=`'${i.toLowerCase()}')`}return r}return e.unsupportedOperationFound=!0,""};let fe=class B{constructor(){this._featureLookup=new Map}static getInstance(){return B.instance||(B.instance=new B),B.instance}static resetInstance(){B.instance&&(B.instance=null)}deleteFromStore(e){e.forEach(r=>{this._featureLookup.delete(r)})}readFromStoreByList(e){const r=[];return e.forEach(i=>{const s=this.readFromStoreById(i);s&&r.push(s)}),r}readFromStoreById(e){return this._featureLookup.get(e)??null}writeToStore(e,r,i){const s=[];return e.forEach(n=>{if(!n?.id)return;n.properties||(n.properties=[]);let l,d=null;if(i&&n.properties[i]&&(d=Lt(n.properties[i])),"originId"in n&&"destinationId"in n&&(n.properties[ue]=n.originId,n.properties[ce]=n.destinationId),n.properties[r]=n.id,n.id&&this._featureLookup.has(n.id)&&this._featureLookup.get(n.id).attributes){const c=this._featureLookup.get(n.id),m=JSON.parse(JSON.stringify(Object.assign(c.attributes,n.properties)));i&&n.properties[i]&&(m[i]=dt(n.properties[i])),l=new Le(d?JSON.parse(JSON.stringify(d)):c?.geometry?JSON.parse(JSON.stringify(c.geometry)):null,m,null,n.properties[r])}else l=new Le(d?JSON.parse(JSON.stringify(d)):null,n.properties,null,n.properties[r]);this._featureLookup.set(`${n.typeName?`${n.typeName}__${n.id}`:n.id}`,l),s.push(l)}),s}},ge,I=null;function os(){return ge||(ge=Mt(()=>import("./lclayout-6cdRR6IH.js"),__vite__mapDeps([0,1]),import.meta.url).then(t=>t.l).then(({default:t})=>t({locateFile:e=>ut(`esri/libs/linkchartlayout/${e}`)})).then(t=>{Rr(t)}),ge)}function Rr(t){I=t}const Ae={right:0,left:1,top:2,bottom:3},Oe={none:0,"start-only":1,"start-and-end":2};function Ar(t){const e={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...t?.toJSON(),eventsTicksVisualization:t?.eventsTicksVisualization??"start-and-end"};return{...e,timeDirection:{value:Ae[e.timeDirection]??Ae.right},eventsTicksVisualization:{value:Oe[e.eventsTicksVisualization]??Oe["start-and-end"]}}}function W(t,e,r,i,s,n){const l=r.length,d=s.length,c=Float64Array.BYTES_PER_ELEMENT,m=Uint32Array.BYTES_PER_ELEMENT,a=Uint8Array.BYTES_PER_ELEMENT,o=16,p=o+l*(a+2*c)+d*(2*m),u=I._malloc(p);try{const b=u+o-u%o,T=b+l*c,g=T+l*c,v=g+d*m,E=v+d*m,M=()=>[I.HEAPF64.subarray(b>>3,(b>>3)+l),I.HEAPF64.subarray(T>>3,(T>>3)+l),I.HEAPU32.subarray(g>>2,(g>>2)+d),I.HEAPU32.subarray(v>>2,(v>>2)+d),I.HEAPU8.subarray(E,E+l)],[$,S,w,_,N]=M();$.set(r),S.set(i),w.set(s),_.set(n),N.set(e);const L=t(l,E,b,T,d,g,v);let j=null,G=null;if(L.value===0){const k=I.getLayoutLinksTypes(),X=I.getLayoutLinksVerticesEndIndices(),he=I.getLayoutLinksVertices(),Ne=I.countLayoutLinksVertices();!d||k&&X?Ne&&!he?L.value=1:(j={types:new Uint8Array(I.HEAPU8.subarray(k,k+d)),vertexEndIndex:new Uint32Array(I.HEAPU32.subarray(X>>2,(X>>2)+d)),vertices:new Float64Array(I.HEAPF64.subarray(he>>3,(he>>3)+2*Ne))},G=I.getAuxiliaryGraphicElements()):L.value=1}const[U,D,C,x,F]=M();return r.set(U),i.set(D),s.set(C),n.set(x),e.set(F),{status:L.value,links:j,graphics:G}}finally{I._free(u),I.cleanupLayout()}}const je=2,Pe=1,qe=-1;var Ge,Ue,He,ze,Qe,We,Ve;(function(t){function e(){return I.getMinIdealEdgeLength()}function r(i,s,n,l,d,c,m=je,a=Pe,o=qe){return W((p,u,b,T,g,v,E)=>I.applyForceDirectedLayout(i,p,u,b,T,g,v,E,m,a,o),s,n,l,d,c)}t.getMinIdealEdgeLength=e,t.apply=r})(Ge||(Ge={})),function(t){function e(r,i,s,n,l,d,c=je,m=Pe,a=qe){return W((o,p,u,b,T,g,v)=>I.applyCommunityLayout(r,o,p,u,b,T,g,v,c,m,a),i,s,n,l,d)}t.apply=e}(Ue||(Ue={})),function(t){function e(r,i,s,n,l,d){return W((c,m,a,o,p,u,b)=>I.applySimpleLayout(r,c,m,a,o,p,u,b),i,s,n,l,d)}t.apply=e}(He||(He={})),function(t){function e(r,i,s,n,l,d){return W((c,m,a,o,p,u,b)=>I.applyHierarchicalLayout(r,c,m,a,o,p,u,b),i,s,n,l,d)}t.apply=e}(ze||(ze={})),function(t){function e(r,i,s,n,l,d){return W((c,m,a,o,p,u,b)=>I.applyRadialTreeLayout(r,c,m,a,o,p,u,b),i,s,n,l,d)}t.apply=e}(Qe||(Qe={})),function(t){function e(r,i,s,n,l,d){return W((c,m,a,o,p,u,b)=>I.applySmartTreeLayout(r,c,m,a,o,p,u,b),i,s,n,l,d)}t.apply=e}(We||(We={})),function(t){function e(r,i,s,n,l,d,c,m,a,o,p,u){return W((b,T,g,v,E,M,$)=>{if(l.length!==b)return{value:1};if(d.length!==b)return{value:1};if(a.length!==E)return{value:1};if(o.length!==E)return{value:1};const S=Float64Array.BYTES_PER_ELEMENT,w=16,_=I._malloc(w+b*S),N=I._malloc(w+b*S),L=I._malloc(w+E*S),j=I._malloc(w+E*S),G=_+w-_%w,U=N+w-N%w,D=L+w-L%w,C=j+w-j%w;try{return I.HEAPF64.subarray(G>>3,(G>>3)+b).set(l),I.HEAPF64.subarray(U>>3,(U>>3)+b).set(d),I.HEAPF64.subarray(D>>3,(D>>3)+E).set(a),I.HEAPF64.subarray(C>>3,(C>>3)+E).set(o),I.applyChronologicalLayout(r,b,T,g,v,G,U,E,M,$,D,C,p,Ar(u))}finally{I._free(_),I._free(N),I._free(L),I._free(j)}},i,s,n,c,m)}t.apply=e}(Ve||(Ve={}));tt()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"});tt()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Or=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function jr(t,e){const r=new Map;if(e.dataModel?.relationshipTypes)for(const i of e.dataModel.relationshipTypes)i.name&&r.set(i.name,[]);for(const i of t)r.has(i.typeName)&&r.get(i.typeName)?.push(i.id);return r}async function ls(t,e,r){const i=[],s=jr(t,e),n={},l=[];for(const[a,o]of s){if(o.length<1)continue;const p=`${a}_ids`;n[p]=o,l.push(`MATCH (n)-[r:${a}]->(m) WHERE id(r) in $${p} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(l.length===0)return[];const d=l.join(" UNION "),c=new V({openCypherQuery:d,bindParameters:n}),m=(await J(e,c,r?.requestOptions)).resultRowsStream.getReader();for(;;){const{done:a,value:o}=await m.read();if(a)break;for(const p of o)i.push({id:p[0],typeName:p[1]}),i.push({id:p[2],typeName:p[3]})}return i}const ps=t=>Or.get(t)??"radial-root-centric";function Pr(t){if(!t.spatialReference.isWGS84)throw new z("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return t.clone().normalize().map(e=>[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]])}let P=class extends rt{constructor(e){super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const r=new Map;e.knowledgeGraph.dataModel.entityTypes?.forEach(i=>{i.name&&(r.set(i.name,"entity"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.entityTypeNames.add(i.name),i.properties?.forEach(s=>{s.geometryType&&s.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:s.name??"",geometryType:s.geometryType})}))}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(i=>{i.name&&(r.set(i.name,"relationship"),this._processingCacheUpdatesLookup.set(i.name,[]),e.inclusionModeDefinition&&!e.inclusionModeDefinition?.generateAllSublayers||this.relationshipTypeNames.add(i.name),i.properties?.forEach(s=>{s.geometryType&&s.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(i.name,{name:s.name??"",geometryType:s.geometryType})}))}),e.inclusionModeDefinition?.namedTypeDefinitions.forEach((i,s)=>{if(r.get(s)==="entity")this.entityTypeNames.add(s);else{if(r.get(s)!=="relationship")return it.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(s);this.relationshipTypeNames.add(s)}const n=new Map;i.members?.forEach(l=>{q(this.memberIdTypeLookup,l.id,()=>new Set).add(s)}),this.sublayerCaches.set(s,n)})}addToLayer(e){e.forEach(({typeName:r,id:i})=>{if(!this.inclusionModeDefinition)throw new z("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(r)){const s=this.inclusionModeDefinition.namedTypeDefinitions.get(r);s.members||(s.members=new Map),s.members.set(i,{id:i}),q(this.memberIdTypeLookup,i,()=>new Set).add(r)}}else{const s=new Map;s.set(i,{id:i}),this.inclusionModeDefinition.namedTypeDefinitions.set(r,{useAllData:!1,members:s}),q(this.memberIdTypeLookup,i,()=>new Set).add(r)}})}getById(e){return fe.getInstance().readFromStoreById(e)}async getData(e,r,i){if(r.objectType.name&&this.inclusionModeDefinition?.namedTypeDefinitions&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(r.objectType.name))return[];let s;if(s=e||new Z({where:"1=1",outFields:["*"]}),r.parentCompositeLayer.type==="link-chart"){const n=r.parentCompositeLayer,l=this._processingCacheUpdatesLookup.get(r.objectType.name??""),d=s.outFields;d&&d.length===1&&d[0]===R&&s.where==="1=1"||await Promise.all(l??[]);const c=this.sublayerCaches.has(r.objectType.name??"")?Array.from(this.sublayerCaches.get(r.objectType.name)?.values()):[],m=[];return c.forEach(a=>{if(this.relationshipTypeNames.has(r.objectType.name)){a.geometry=n.relationshipLinkChartDiagramLookup.get(a.attributes[r.objectIdField]);const o=this.memberIdTypeLookup.get(a.attributes[ue]),p=this.memberIdTypeLookup.get(a.attributes[ce]),u=this._isEndEntitySpatial(o,a,ue),b=this._isEndEntitySpatial(p,a,ce);a.attributes[ne]=Number(u&&b)}else{a.geometry=n.entityLinkChartDiagramLookup.get(a.attributes[r.objectIdField]);const o=this.geographicLookup.get(r.objectType.name);o&&a.attributes[o.name]?a.attributes[ne]=1:a.attributes[ne]=0}a.attributes[_e]=a.geometry,m.push(a)}),m}return this.retrieveDataFromService(s,r,i)}async getConnectedRecordIds(e,r,i){const s=[];let n="";const l=this._getNamedTypeIdMapFromNodeIds(e);if(r&&r?.length!==0){for(const o of r)n=n+o+"|";n=n.slice(0,-1)}const d={},c=[];for(const[o,p]of l){const u=`${o}_ids`;d[u]=p,r&&r?.length!==0?c.push(`MATCH (n:${o}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r:${n}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):c.push(`MATCH (n:${o}) WHERE id(n) IN $${u} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!c.length)return s;const m=c.join(" UNION "),a=(await J(this.knowledgeGraph,new V({openCypherQuery:m,bindParameters:d}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:o,value:p}=await a.read();if(o)break;for(let u=0;u<p.length;u++){const b=p[u];s.push({id:b[0],typeName:b[1]}),s.push({id:b[2],typeName:b[3]})}}return s}async getRelationshipsBetweenNodes(e,r,i){const s=this._getNamedTypeIdMapFromNodeIds(e);if(s.size===0)return[];const n={relationshipExclusionIds:r,possibleConnectionEntityIds:e},l=[];for(const[a,o]of s.entries()){const p=`${a}_ids`;n[p]=o,l.push(`MATCH (n:${a}) WHERE id(n) IN $${p} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const d=l.join(" UNION "),c=[],m=(await J(this.knowledgeGraph,new V({openCypherQuery:d,bindParameters:n}),{signal:i?.signal})).resultRowsStream.getReader();for(;;){const{done:a,value:o}=await m.read();if(a)break;for(let p=0;p<o.length;p++){const u=o[p];c.push({id:u[0],typeName:u[1]})}}return c}async getRelationshipsFromNodes(e,r,i,s){const n=this._getNamedTypeIdMapFromNodeIds(e);if(n.size===0||r.length===0)return[];const l={relationshipExclusionIds:i,possibleConnectionEntityIds:r},d=[];for(const[p,u]of n.entries()){const b=`${p}_ids`;l[b]=u,d.push(`MATCH (n:${p}) WHERE id(n) IN $${b} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const c=d.join(" UNION "),m=new Map,a=(await J(this.knowledgeGraph,new V({openCypherQuery:c,bindParameters:l}),{signal:s?.signal})).resultRowsStream.getReader();for(;;){const{done:p,value:u}=await a.read();if(p)break;for(let b=0;b<u.length;b++){const T=u[b];let g=m.get(T[1]);g||(g=new Set,m.set(T[1],g)),g.add(T[0])}}const o=[];for(const[p,u]of m)for(const b of u)o.push({id:b,typeName:p});return o}async refreshCacheContent(e,r,i,s=!0,n){const l=fe.getInstance(),d=[],c=new Map,m=new Map;this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&m.set(a.name,a)}),this.knowledgeGraph.dataModel.relationshipTypes?.forEach(a=>{a.name&&m.set(a.name,a)}),e||this.inclusionModeDefinition?e?e.forEach(a=>{if(this.memberIdTypeLookup.has(a))for(const o of this.memberIdTypeLookup.get(a))c.has(o)?c.get(o)?.push(a):c.set(o,[a])}):this.inclusionModeDefinition?.namedTypeDefinitions?.forEach((a,o)=>{a.useAllData?c.set(o,null):a.members&&a.members.forEach(p=>{c.has(o)&&c.get(o)!==null?c.get(o)?.push(p.id):c.set(o,[p.id])})}):(this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&c.set(a.name,null)}),this.knowledgeGraph.dataModel.entityTypes?.forEach(a=>{a.name&&c.set(a.name,null)}));for(const[a,o]of c){const p=new Set(o),u=new Promise((b,T)=>{(async()=>{const v=new Set,E=[];let M,$="",S=!1;if(r||m.get(a)?.properties?.forEach(N=>{N.name&&v.add(N.name)}),i&&this.geographicLookup.has(a)){const N=this.geographicLookup.get(a)?.name;N&&v.add(N)}if(this.entityTypeNames.has(a))$=`MATCH (n:${a}) ${o?"WHERE id(n) IN $ids ":""}return ID(n)`,v.forEach(N=>{$+=`, n.${N}`,E.push(N)});else{if(!this.relationshipTypeNames.has(a))throw new z("knowledge-graph:layer-data-manager",`The graph type of ${a} could not be determined. Was this type set in the KG data model and inclusion definition?`);S=!0,$=`MATCH ()-[n:${a}]->() ${o?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,v.forEach(N=>{$+=`, n.${N}`,E.push(N)})}M=new V(o?{openCypherQuery:$,bindParameters:{ids:o}}:{openCypherQuery:$});const w=(await J(this.knowledgeGraph,M,{signal:n?.signal})).resultRowsStream.getReader();for(;;){const{done:N,value:L}=await w.read();if(N)break;const j=[];for(let D=0;D<L.length;D++){const C=L[D];let x=0,F=0;const k={properties:{}};for(k.id=C[x],x++,F++,S&&(k.originId=C[x],x++,F++,k.destinationId=C[x],x++,F++,q(this.nodeConnectionsLookup,k.originId,()=>new Set).add(k.id),q(this.nodeConnectionsLookup,k.destinationId,()=>new Set).add(k.id),q(this.relationshipConnectionsLookup,k.id,()=>[k.originId,k.destinationId]));x<C.length;x++)k.properties[E[x-F]]=C[x];p.delete(k.id),j.push(k)}const G=l.writeToStore(j,R,this.geographicLookup.get(a)?.name);this.sublayerCaches.has(a)||this.sublayerCaches.set(a,new Map),s&&!this.inclusionModeDefinition?.namedTypeDefinitions.has(a)&&this.inclusionModeDefinition?.namedTypeDefinitions.set(a,{useAllData:!1,members:new Map}),s&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members&&(this.inclusionModeDefinition.namedTypeDefinitions.get(a).members=new Map);const U=this.sublayerCaches.get(a);G.forEach(D=>{U?.set(D.attributes[R],D),s&&!this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.has(D.attributes[R])&&(this.inclusionModeDefinition?.namedTypeDefinitions.get(a).members.set(D.attributes[R],{id:D.attributes[R]}),q(this.memberIdTypeLookup,D.attributes[R],()=>new Set).add(a))})}const _=this.inclusionModeDefinition?.namedTypeDefinitions.get(a);if(_)for(const N of p)_.members?.delete(N)})().then(()=>{b(null)}).catch(v=>{v.name==="AbortError"?b(null):T(v)})});d.push(u),this._processingCacheUpdatesLookup.get(a)?.push(u)}if(await Promise.all(d),n?.signal?.aborted)throw ct()}removeFromLayer(e){const r=new Set,i=new Set(e.map(s=>s.id));for(const s of e)r.add(s.typeName),this.memberIdTypeLookup.get(s.id)?.size===1?this.memberIdTypeLookup.delete(s.id):this.memberIdTypeLookup.get(s.id)?.delete(s.typeName),this.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,l)=>{l===s.typeName&&n.members?.has(s.id)&&n.members.delete(s.id)});r.forEach(s=>{this.sublayerCaches.get(s)?.forEach((n,l)=>{i.has(l)&&this.sublayerCaches.get(s)?.delete(l)})})}async retrieveDataFromService(e,r,i){const s=fe.getInstance(),n=new Set,l=[];let d,c="",m=[];const a=r.graphType==="relationship",o=this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData,p=r.parentCompositeLayer.sublayerIdsCache.get(r.objectType.name);let u=!o&&p?Array.from(p).sort():null;if(this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData)this.inclusionModeDefinition?.namedTypeDefinitions?.get(r.objectType.name)?.useAllData&&e.objectIds!=null&&(u=e.objectIds);else if(e.objectIds!=null&&u&&u.length>0){const T=e.objectIds;e.objectIds=u.filter(g=>T.includes(g))}else if(e.objectIds!=null)u=e.objectIds;else{if(this.inclusionModeDefinition?.namedTypeDefinitions.has(r.objectType.name)&&(!this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name)?.members||this.inclusionModeDefinition.namedTypeDefinitions.get(r.objectType.name)?.members?.size<1))return e.objectIds=[],[];e.objectIds=u}if(e.outFields!=null){const T=e.outFields;T.includes("*")?r.fields.forEach(g=>{n.add(g.name)}):T.forEach(g=>{g!==R&&g!==r.geometryFieldName&&n.add(g)})}if(e.geometry!=null){const T=e.geometry;let g;const v=r.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,E=v?.spatialReference,M=v?.serviceCapabilities?.geometryCapabilities;let $=M?.geometryMaxBoundingRectangleSizeX,S=M?.geometryMaxBoundingRectangleSizeY;if(T.type==="point"){let w=T;w.spatialReference?.isWGS84||(await de(w.spatialReference,Q),w=se(w,Q)),g=new pe({spatialReference:Q,xmin:w.x-1e-4,ymin:w.y-1e-4,xmax:w.x+1e-4,ymax:w.y+1e-4})}else T?.extent?.spatialReference&&!T.spatialReference?.isWGS84?(await de(T.extent.spatialReference,Q),g=se(T.extent,Q)):g=T.extent;if($&&S&&E){if(E.wkid!==4326){const w=new pe({spatialReference:E,xmax:$,ymax:S}),_=se(w,Q);$=_.xmax,S=_.ymax}if(g.xmax-g.xmin>$)throw new z("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${$}° latitude, limit exceeded`);if(g.ymax-g.ymin>S)throw new z("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${S}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const w=await $e(e.where.toUpperCase(),r.fieldsIndex);r.fields.forEach(_=>{w.fieldNames.includes(_.name)&&n.add(_.name)})}c=a?`Match ()-[n:${r.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${r.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${r.geometryFieldName}) return ID(n)`,r.geometryFieldName&&n.add(r.geometryFieldName),n.forEach(w=>{c+=`, n.${w}`,l.push(w)}),d=new V({openCypherQuery:c,bindParameters:{param_filter_geom:new st({rings:Pr(g)})}})}else{let T="";if(e.where!=null&&e.where!=="1=1"){const E=await $e(e.where,r.fieldsIndex);r.fields.forEach($=>{E.fieldNames.includes($.name)&&n.add($.name)});const M={systemOidFieldName:R,supportedSqlTypes:new Set(["column-reference","string","number","binary-expression"]),supportedSqlOperators:new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]),unsupportedOperationFound:!1};T=Te(E.parseTree,M),M.unsupportedOperationFound&&(T="")}let g="";g=a?`Match ()-[n:${r.objectType.name}]->()`:`Match (n:${r.objectType.name})`;let v=!1;u&&(v=!0,g+=" WHERE ID(n) IN $ids"),T&&(g+=v?" AND":" WHERE",g+=` ${T}`),g+=" return ID(n)",a&&(g+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&r.geometryFieldName&&n.add(r.geometryFieldName),n.forEach(E=>{g+=`, n.${E}`,l.push(E)}),d=new V(u?{openCypherQuery:g,bindParameters:{ids:u}}:{openCypherQuery:g})}const b=(await J(r.parentCompositeLayer.dataManager.knowledgeGraph,d,i)).resultRowsStream.getReader();for(;;){const{done:T,value:g}=await b.read();if(T)break;const v=[];for(let E=0;E<g.length;E++){const M=g[E];let $=0,S=0;const w={properties:{}};for(w.id=M[$],$++,S++,a&&(w.originId=M[$],$++,S++,w.destinationId=M[$],$++,S++);$<M.length;$++)w.properties[l[$-S]]=M[$];v.push(w)}m=m.concat(s.writeToStore(v,R,r.parentCompositeLayer.dataManager.geographicLookup.get(r.objectType.name)?.name))}return m}_isEndEntitySpatial(e,r,i){for(const s of e??[])if(this.entityTypeNames.has(s)){const n=this.geographicLookup.get(s),l=n&&this.sublayerCaches.get(s)?.get(r.attributes[i]);if(n&&l?.attributes[n.name])return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const r=new Map;return e.forEach(i=>{if(this.memberIdTypeLookup.has(i))for(const s of this.memberIdTypeLookup.get(i)){if(!this.entityTypeNames.has(s))return;r.has(s)?r.get(s)?.push(i):r.set(s,[i])}}),r}};y([h()],P.prototype,"knowledgeGraph",void 0),y([h()],P.prototype,"inclusionModeDefinition",void 0),y([h()],P.prototype,"entityTypeNames",void 0),y([h()],P.prototype,"relationshipTypeNames",void 0),y([h()],P.prototype,"geographicLookup",void 0),y([h()],P.prototype,"sublayerCaches",void 0),y([h()],P.prototype,"nodeConnectionsLookup",void 0),y([h()],P.prototype,"relationshipConnectionsLookup",void 0),y([h()],P.prototype,"memberIdTypeLookup",void 0),P=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],P);const qr=Symbol("isKnowledgeGraphGraphicOriginSymbol");var Be;class Gr extends nt{get[(Be=qr,yt)](){return this.sublayer}get[ht](){return this.sublayer}get[at](){return this.sublayer}constructor(e,r){super(),this[Be]=!0,this.type="knowledge-graph",this.layer=e,this.sublayer=r}get id(){return this.layer.id}}const Ur=Symbol("isLinkChartGraphicOriginSymbol");var Je;class Hr extends nt{get[(Je=Ur,at)](){return this.layer}constructor(e,r){super(),this[Je]=!0,this.type="link-chart",this.layer=e,this.sublayer=r}get id(){return`${this.layer.id}:__${this.sublayer.id}__`}}const Ze=Ft(),zr=t=>{const e=t;let r=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return y([h(Ze.fields)],r.prototype,"fields",void 0),y([h(Ze.fieldsIndex)],r.prototype,"fieldsIndex",void 0),r=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],r),r},Qr=Rt;let H=class extends rt{constructor(t){super(t),this.entityAdds=void 0,this.entityUpdates=void 0,this.entityDeletes=void 0,this.relationshipAdds=void 0,this.relationshipUpdates=void 0,this.relationshipDeletes=void 0,this.options=void 0}};y([h()],H.prototype,"entityAdds",void 0),y([h()],H.prototype,"entityUpdates",void 0),y([h()],H.prototype,"entityDeletes",void 0),y([h()],H.prototype,"relationshipAdds",void 0),y([h()],H.prototype,"relationshipUpdates",void 0),y([h()],H.prototype,"relationshipDeletes",void 0),y([h()],H.prototype,"options",void 0),H=y([ye("esri.rest.knowledgeGraph.GraphApplyEdits")],H);const Wr={initializeLayersFromClientData:async(t,e,r)=>{if(e||(e=[...t.layers,...t.tables].map(n=>n.graphTypeName)),e?.length===0)return;const i=new Map;for(const n of e)i.set(n,Ye(t,n));const s=await vt(t.dataManager.knowledgeGraph,Array.from(i.values()),{requestOptions:{signal:r?.signal}});for(const n of[...t.layers,...t.tables]){const l=n.objectType.name;if(l==null)continue;const d=s.get(Ye(t,l));if(d){const c=JSON.parse(d);c===null||typeof c!="object"||c.hasOwnProperty("showLabels")||(c.showLabels=!1),n.read(c,{origin:"service"})}}}},Ye=(t,e)=>t.type==="knowledge-graph"?`${e}/Map`:`${e}/LinkChart/LinkChartSubLayer`;async function us(t,e,r){return Wr.initializeLayersFromClientData(t,e,r)}const Ke=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Vr="#8f8f82";function Br(t){return t<0||t>=Ke.length?new ve(Vr):new ve(Ke[t])}function Jr(t){const e=t.toArray();return new mt({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:e},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:e}]}}]}]}}})}function Zr(t){let e="ESRI__ID",r=4;for(const i of t)if(i.name){if(i.name.toLowerCase()==="name"){e=i.name;break}i.name.toLowerCase().includes("name")?(e=i.name,r=2):i.fieldType==="esriFieldTypeString"&&r>3&&(e=i.name,r=3)}return e}function Yr(t,e,r){const i={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},s=new Y({labelExpressionInfo:new ae({expression:r==="ESRI__ID"?`${e}`:`$feature.${r}`}),labelPlacement:"above-center",symbol:new ie(i)}),n=new Y({labelExpressionInfo:new ae({expression:`'${e}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new ie({...i,yoffset:"12px"})});return t==="entity"?[s]:[n]}function Kr(t,e,r){const i={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},s=r==="ESRI__ID"?`${t}`:`$feature.${r}`;return e==="point"?[new Y({labelExpressionInfo:new ae({expression:s}),labelPlacement:"above-center",symbol:new ie(i)})]:e==="polyline"?[new Y({labelExpressionInfo:new ae({expression:s}),labelPlacement:"center-along",repeatLabel:!0,symbol:new ie(i)})]:e==="polygon"?[new Y({labelExpressionInfo:new ae({expression:s}),labelPlacement:"always-horizontal",symbol:new ie(i)})]:null}const Xr={capabilities:[],allowGeometryUpdates:!1,serviceCapabilities:{geometryCapabilities:{supportsZValues:!1,supportsMValues:!1}}};function ei(t){const{capabilities:e,allowGeometryUpdates:r,serviceCapabilities:{geometryCapabilities:{supportsZValues:i,supportsMValues:s}}}=t?.serviceDefinition||Xr,n=t?.dataModel.arcgisManaged?e:e.filter(d=>d==="Query"),l=new Set(n);return{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:s,supportsZ:i},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:l.has("Create"),supportsDelete:l.has("Delete"),supportsEditing:l.has("Editing"),supportsChangeTracking:!1,supportsQuery:l.has("Query"),supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:l.has("Update"),supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:Pt,queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},queryAttributeBins:jt,editing:{supportsGeometryUpdate:!!t?.dataModel.arcgisManaged&&r,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsDeleteByAnonymous:!1,supportsDeleteByOthers:l.has("Delete"),supportsUpdateByAnonymous:!1,supportsUpdateByOthers:l.has("Update"),supportsAsyncApplyEdits:!1,zDefault:void 0}}}async function ti(t,e){const r=new H,i=e.graphTypeName,s=e.graphType,n=e.parentCompositeLayer.type==="knowledge-graph"?e.geometryFieldName:null,l=!!e.fieldsIndex.get(n)?.editable,d=a=>{const o={...a};for(const p of e.fields)p.editable||delete o[p.name];for(const p of Object.keys(a))p.includes("ESRI__")&&delete o[p];return o},c=async a=>{await de(a.spatialReference,le.WGS84);const o=se(a,le.WGS84);return o.type==="point"?o.normalize():(await Ot(o))[0]};for(const a of t.addFeatures??[]){const o=d(a.attributes);Se(a.sourceLayer)&&a.sourceLayer.graphTypeName===i&&(s==="entity"?(r.entityAdds||(r.entityAdds=[]),n&&a.geometry&&(o[n]=await c(a.geometry)),r.entityAdds.push(new Me({properties:o,typeName:i}))):(r.relationshipAdds||(r.relationshipAdds=[]),r.relationshipAdds.push(new ke({properties:o,typeName:i}))))}for(const a of t.updateFeatures??[]){const o=a.attributes[R],p=d(a.attributes);Se(a.sourceLayer)&&a.sourceLayer.graphTypeName===i&&(s==="entity"?(r.entityUpdates||(r.entityUpdates=[]),n&&l&&a.geometry&&(p[n]=await c(a.geometry)),r.entityUpdates.push(new Me({id:o,properties:p,typeName:i}))):(r.relationshipUpdates||(r.relationshipUpdates=[]),r.relationshipUpdates.push(new ke({id:o,properties:p,typeName:i}))))}const m=new Map;for(const a of t.deleteFeatures??[])if(ft(a)){const o=a,p=q(m,o.sourceLayer.graphTypeName,()=>({typeName:o.sourceLayer.graphTypeName,ids:[]}));o.sourceLayer.graphTypeName===i&&p.ids.push(o.attributes[R])}else a.objectId&&typeof a.objectId=="string"&&q(m,i,()=>({typeName:i,ids:[]})).ids.push(a.objectId);for(const a of m.values())a.ids.length>0&&(s==="entity"?(r.entityDeletes||(r.entityDeletes=[]),r.entityDeletes.push({typeName:a.typeName,ids:a.ids})):(r.relationshipDeletes||(r.relationshipDeletes=[]),r.relationshipDeletes.push({typeName:a.typeName,ids:a.ids})));return r}function ri(t,e){const r={addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]};for(const i of t.editResults)if(i.typeName===e){for(const s of i.adds)r.addFeatureResults.push({objectId:s.id,globalId:s.id});for(const s of i.updates)r.updateFeatureResults.push({objectId:s.id,globalId:s.id});for(const s of i.deletes)r.deleteFeatureResults.push({objectId:s.id,globalId:s.id})}return r}function ii(t){if(!t.objectType)return null;const e=[];for(const r of t.fields)!r.name.includes("ESRI__")&&r.editable&&r.type!=="geometry"&&e.push(new Qr({fieldName:r.name}));return new At({elements:e})}function si(t){if(!t.objectType)return null;let e=null;switch(t.geometryType){case"point":case"multipoint":e="point";break;case"polyline":e="line";break;case"polygon":e="polygon";break;default:e=null}return[new qt({name:t.graphTypeName,drawingTool:e,prototype:{}})]}function O(t){if(!t.json)return t;t.json.write=Xe(t.json.write);const e=t.json.origins;if(!e)return t;let r;for(r in e){const i=e[r];i&&(i.write=Xe(i.write))}return t}function Xe(t){return typeof t=="object"&&t?(t.enabled!==!1&&(t.overridePolicy=ni(t)),t):t===!0?te():t}function ni(t){const{target:e,writer:r,overridePolicy:i,...s}=t;return function(n,l){const d=pt.call(this,n,l);return d.enabled?{...s,...d}:d}}function te(){return{overridePolicy:pt}}function pt(t,e){const r=!!this.geometryType;let i={enabled:r};return r&&(i={...i,...re.call(this,t,e)}),i}function re(t,e){return{ignoreOrigin:this.originIdOf(e)>0}}let f=class extends zr(Qt(Zt(Bt(Ut(Kt(rr(tr(er(kt(It)))))))))){constructor(t){super(t),this.blendMode="normal",this.charts=null,this.definitionExpression=null,this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=R,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const e=new MessageChannel;return new Dt(e.port1,{channel:e,client:{queryFeatures:(r,i={})=>{const s=Z.fromJSON(r);return this.queryFeaturesJSON(s,i)}}}),[e.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get capabilities(){return this.parent?this.parent.sublayerCapabilities:ei(null)}get userHasUpdateItemPrivileges(){return!!this.parent?.userHasUpdateItemPrivileges}get editingEnabled(){return this._isOverridden("editingEnabled")?this._get("editingEnabled"):this.capabilities.operations.supportsEditing}set editingEnabled(t){this._overrideIfSome("editingEnabled",t)}get isTable(){return this.parentCompositeLayer.type!=="link-chart"&&this.geometryFieldName==null}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(t){const e=this._normalizeFeatureReduction(t);this._set("featureReduction",e)}get fields(){const t=[];return this.objectType?.properties?.forEach(e=>{const r=e.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":e.fieldType;t.push(oe.fromJSON({name:e.name,type:r,alias:e.alias,defaultValue:e.defaultValue,editable:e.editable,nullable:e.nullable}))}),t.push(oe.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),oe.fromJSON({name:be,type:"esriFieldTypeInteger",alias:be,editable:!1}),oe.fromJSON({name:ne,type:"esriFieldTypeInteger",alias:ne,editable:!1})),t}get formTemplate(){return this._isOverridden("formTemplate")?this._get("formTemplate"):ii(this)}set formTemplate(t){this._overrideIfSome("formTemplate",t)}get geometryType(){if(this.parentCompositeLayer?.type==="link-chart")return this.graphType==="relationship"?"polyline":"point";const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.geometryType;return e&&e!=="esriGeometryNull"?ee.fromJSON(e):null}get geometryFieldName(){return this.parentCompositeLayer?.type==="link-chart"?_e:this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name)?.name??null}get graphicOrigin(){if(!this.parent)return null;switch(this.parent.type){case"knowledge-graph":return new Gr(this.parent,this);case"link-chart":return new Hr(this.parent,this)}}get graphTypeName(){return this.objectType?.name}set graphTypeName(t){this._set("graphTypeName",t)}get hasM(){const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.name;return(e?this.objectType?.properties?.[e]:null)?.hasM??!1}get hasZ(){const t=this.parentCompositeLayer?.dataManager.geographicLookup.get(this.objectType?.name),e=t?.name;return(e?this.objectType?.properties?.[e]:null)?.hasZ??!1}set labelingInfo(t){this._set("labelingInfo",t)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const t=this.objectType.properties?Zr(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?Yr(this.graphType,this.graphTypeName,t):Kr(this.graphTypeName,this.geometryType,t)}set renderer(t){gt(t,this.fieldsIndex),this._set("renderer",t)}get renderer(){if(this._isOverridden("renderer"))return this._get("renderer");const t=this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel,e=[...t?.entityTypes??[],...t?.relationshipTypes??[]].map(s=>s.name).indexOf(this.graphTypeName),r=Br(e);if(this.parentCompositeLayer?.type==="link-chart"){if(this.graphType==="relationship")return new dr({type:"simple",symbol:Jr(r)});const s=Ce(De(ee.toJSON("point")).renderer);return xe(s.symbol,r),s}const i=Ce(De(ee.toJSON(this.geometryType)).renderer);return xe(i.symbol,r),i}get spatialReference(){return this.parentCompositeLayer?.dataManager?.knowledgeGraph?.dataModel?.spatialReference??le.WGS84}get templates(){return this._isOverridden("templates")?this._get("templates"):si(this)}set templates(t){this._overrideIfSome("templates",t)}set timeInfo(t){this._set("timeInfo",t)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(t){this._set("title",t)}writeTitle(t,e){e.title=t??"Layer"}createPopupTemplate(t){return yr(this,t)}createQuery(){return new Z({where:"1=1",outFields:["*"]})}getField(t){return this.fieldsIndex.get(t)}getFieldDomain(t,e){return null}async queryFeatures(t,e){await this.load();const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(t),s=this.graphicOrigin,n=cr.fromJSON(await i.executeQuery(r.toJSON(),e?.signal));return n.features.forEach(l=>{l.sourceLayer=this,l.origin=s}),n}async queryFeaturesJSON(t,e){await this.load();const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(t);return await i.executeQuery(r.toJSON(),e?.signal)}async queryFeatureCount(t,e){await this.load();const{resolvedQuery:r,queryEngine:i}=await this._setupQueryObjects(t);return i.executeQueryForCount(r.toJSON(),e?.signal)}async queryExtent(t={},e){await this.load();const r={...t,returnGeometry:!0},{resolvedQuery:i,queryEngine:s}=await this._setupQueryObjects(r),n=await s.executeQueryForExtent(i.toJSON(),e?.signal);let l;return l=n.extent?.xmin!=null&&n.extent?.xmax!=null&&n.extent?.ymin!=null&&n.extent?.ymax!=null?new pe(n.extent):new pe,{count:n.count,extent:l}}async queryObjectIds(t,e){await this.load();const r=Z.from(t);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const s=await this.parentCompositeLayer.dataManager.getData(r,this,e);i=this.loadQueryEngine(s)}return await i.executeQueryForIds(r.toJSON(),e?.signal)}async applyEdits(t){if(!this.parentCompositeLayer.dataManager.knowledgeGraph)throw new z("knowledge-graph-sublayer:no-knowledge-graph","ApplyEdits cannot be executed because the parent does not have a Knowledge Graph model.  This is usually caused by the layer not yet being loaded");const e=await ti(t,this);e.options={cascadeDelete:!0,cascadeProvenanceDelete:!!this.parent?.knowledgeGraph.serviceDefinition.supportsProvenance||void 0};const r=await St(this.parentCompositeLayer.dataManager.knowledgeGraph,e),i=ri(r,this.graphTypeName),s={addedFeatures:i.addFeatureResults,updatedFeatures:i.updateFeatureResults,deletedFeatures:i.deleteFeatureResults,addedAttachments:i.addAttachmentResults,deletedAttachments:i.deleteAttachmentResults,updatedAttachments:i.updateAttachmentResults,exceededTransferLimit:!1,historicMoment:new Date,edits:void 0};return this.emit("edits",s),this.emit("apply-edits",{result:Promise.resolve(s)}),this.parentCompositeLayer.type==="link-chart"&&await this.parentCompositeLayer.refreshLinkChartCache([...s.addedFeatures.map(n=>n.globalId),...s.updatedFeatures.map(n=>n.globalId),...s.deletedFeatures.map(n=>n.globalId)]),i}loadQueryEngine(t){const e=new Ct({geometryType:ee.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new xt({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:ee.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:this.timeInfo?.toJSON(),featureStore:e});return r.featureStore.addMany(t),r}async refreshCachedQueryEngine(){const t=await this.parentCompositeLayer.dataManager.getData(new Z({where:"1=1",outFields:[R]}),this);this._cachedQueryEngine=this.loadQueryEngine(t)}load(t){return this.addResolvingPromise(this.parent.load(t).then(()=>bt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(t,e){const r=Z.from(t),i=r.geometry;if(i&&!i.spatialReference?.isWGS84&&(await de(i.spatialReference,Q),r.geometry=se(i instanceof st||i instanceof wt||i instanceof Tt?i:i.extent,Q)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:r,queryEngine:this._cachedQueryEngine};const s=await this.parentCompositeLayer.dataManager.getData(r,this,e);return{resolvedQuery:r,queryEngine:this.loadQueryEngine(s)}}};function ai(t,e,r){const i=[["ESRI__AGGREGATION_COUNT",be],["ESRI__ORIGIN_ID",ue],["ESRI__DESTINATION_ID",ce],["ESRI__LAYOUT_GEOMETRY",_e]];try{for(const s of t)for(const[n,l]of i)s.labelExpression=s.labelExpression?.replaceAll(n,l),s.labelExpressionInfo?.expression&&(s.labelExpressionInfo.expression=s.labelExpressionInfo.expression.replaceAll(n,l))}catch(s){it.getLogger(this).warn("Error updating labelingInfo",s)}return Gt(t,e,r)}y([h(O(A(Ht)))],f.prototype,"blendMode",void 0),y([h({readOnly:!0})],f.prototype,"capabilities",null),y([h({readOnly:!0})],f.prototype,"userHasUpdateItemPrivileges",null),y([h({type:Boolean})],f.prototype,"editingEnabled",null),y([h()],f.prototype,"isTable",null),y([h({json:{origins:{"web-scene":{write:!1}},write:te()}})],f.prototype,"charts",void 0),y([h({readOnly:!0})],f.prototype,"defaultPopupTemplate",null),y([h({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],f.prototype,"definitionExpression",void 0),y([h(O(A(Wt)))],f.prototype,"displayFilterEnabled",void 0),y([h(O(A(Vt)))],f.prototype,"displayFilterInfo",void 0),y([h(O(A(zt)))],f.prototype,"effect",void 0),y([h()],f.prototype,"elevationInfo",void 0),y([h(O(A(Jt)))],f.prototype,"featureEffect",void 0),y([h(O(A(Yt)))],f.prototype,"featureReduction",null),y([h()],f.prototype,"fields",null),y([h()],f.prototype,"formTemplate",null),y([h()],f.prototype,"geometryType",null),y([h()],f.prototype,"geometryFieldName",null),y([h({readOnly:!0})],f.prototype,"graphicOrigin",null),y([h({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],f.prototype,"graphType",void 0),y([h({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],f.prototype,"graphTypeName",null),y([h()],f.prototype,"hasM",null),y([h()],f.prototype,"hasZ",null),y([h({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],f.prototype,"id",void 0),y([h({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],f.prototype,"labelsVisible",void 0),y([h({type:[Y],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:ai,write:te()}})],f.prototype,"labelingInfo",null),y([h({readOnly:!0,json:{read:!1,write:{writer(t,e){switch(this.parentCompositeLayer?.type){case"link-chart":e.layerType="LinkChartSubLayer";break;case"knowledge-graph":e.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],f.prototype,"layerType",void 0),y([h(O(A(sr)))],f.prototype,"legendEnabled",void 0),y([h(O(A(nr)))],f.prototype,"maxScale",void 0),y([h(O(A(ar)))],f.prototype,"minScale",void 0),y([h()],f.prototype,"objectIdField",void 0),y([h()],f.prototype,"objectType",void 0),y([h(O(A(or)))],f.prototype,"opacity",void 0),y([h(O(A(Xt)))],f.prototype,"orderBy",void 0),y([h({clonable:!1})],f.prototype,"parent",void 0),y([h()],f.prototype,"parentCompositeLayer",void 0),y([h(O(A(lr)))],f.prototype,"popupEnabled",void 0),y([h({type:Et,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],f.prototype,"popupTemplate",void 0),y([h({type:Number,json:{write:{overridePolicy:re}}})],f.prototype,"refreshInterval",void 0),y([h({types:ur,json:{name:"layerDefinition.drawingInfo.renderer",write:te()}})],f.prototype,"renderer",null),y([h()],f.prototype,"source",void 0),y([h()],f.prototype,"spatialReference",null),y([h()],f.prototype,"templates",null),y([h({type:pr,json:{name:"layerDefinition.timeInfo",write:{overridePolicy:re},origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:re}},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:re}}}}})],f.prototype,"timeInfo",null),y([h({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],f.prototype,"title",null),y([_t("title")],f.prototype,"writeTitle",null),y([h({json:{read:!1}})],f.prototype,"type",void 0),y([h(O(A(ir)))],f.prototype,"useViewTime",void 0),y([h({type:Boolean,json:{name:"visibility",write:te()}})],f.prototype,"visible",void 0),f=y([ye("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],f);export{He as A,ps as C,ei as F,as as I,us as L,f as N,ze as P,P as a,Ve as b,Qe as c,We as d,Ue as e,ss as f,ls as g,fe as o,Ge as p,os as r,ns as w};
