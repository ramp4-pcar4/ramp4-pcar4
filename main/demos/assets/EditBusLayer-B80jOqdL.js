const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./deleteForwardEdits-DNJKDM9v.js","./main-CtmwM019.js","./preload-helper-DMGCcr4D.js","./main-DZFs8ecF.css","./utils-PyBYdGi0.js","./DeleteForwardEditsParameters-CK6jJT3P.js"])))=>i.map(i=>d[i]);
import{H as R,_ as E,Y as U,Z as k,L as m,dk as T,$ as x}from"./main-CtmwM019.js";import{_ as j}from"./preload-helper-DMGCcr4D.js";import{o as D}from"./uuid-Oe6SV2kF.js";const P=D(),V=new Map,A=new Map;async function Z(e,r,a){if(!e||!a)return!1;if(!r)return!0;const t=new URL(e).host;let n=V.get(t);if(!n){const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");n=(await R(d,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return n===r}async function z(e,r,a=!1){if(!e||!r)return!0;const t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=A.get(t)?.entries();if(n){for(const[d,s]of n)if(s.name===r){const c=!s.stack?.hasForwardEdits();if(!c&&a){const[{deleteForwardEdits:o},{default:h}]=await Promise.all([j(()=>import("./deleteForwardEdits-DNJKDM9v.js"),__vite__mapDeps([0,1,2,3,4]),import.meta.url),j(()=>import("./DeleteForwardEditsParameters-CK6jJT3P.js"),__vite__mapDeps([5,1,2,3]),import.meta.url)]),u=await o(t,d,new h({sessionId:P,moment:s.moment}));return u.success&&s.stack?.clearForwardEdits(),u.success}return c}}return!0}function O(e,r){if(!e)return!1;const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=A.get(a)?.entries();if(t){for(const[n,d]of t)if(d.name===r)return d.lockType==="edit"}return!1}const M=new T;function W(e){return M.on("apply-edits",new WeakRef(e))}function q(e){return M.on("update-moment",new WeakRef(e))}function C(e,r,a=null,t=!1){const n=x();return t=r==null||t,M.emit("apply-edits",{serviceUrl:e,layerId:r,gdbVersion:a,mayReceiveServiceEdits:t,result:n.promise}),n}const H=Symbol();function G(e){return e!=null&&typeof e=="object"&&H in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function I(e,r,a){const t=new URL(e).host,n=V.get(t),d=s=>!s||s===n;return d(r)&&d(a)||r===a}const J=e=>{var r;const a=e;let t=class extends a{static{r=H}constructor(...n){super(...n),this[r]=!0,this._applyEditsHandler=d=>{const{serviceUrl:s,layerId:c,gdbVersion:o,mayReceiveServiceEdits:h,result:u}=d,b=s===this.url,f=c!=null&&this.layerId!=null&&c===this.layerId,$=p(this),S=p(this)&&I(s,o,this.gdbVersion);if(!b||$&&!S||!f&&!h)return;const L=u.then(i=>{if(this.lastEditsEventDate=new Date,f&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",m(i)),i;const y=i.editedFeatures?.find(({layerId:F})=>F===this.layerId);if(y){const{adds:F,updates:_,deletes:v}=y.editedFeatures,w={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:F?F.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:v?v.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:_?_.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:m(i.editedFeatures),exceededTransferLimit:!1,historicMoment:m(i.historicMoment)};return this.emit("edits",w),w}const g={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:m(i.editedFeatures),exceededTransferLimit:!1,historicMoment:m(i.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(s,o,g.historicMoment)&&this.emit("edits",g),g}).then(i=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(s,o,i.historicMoment)&&(this.historicMoment=i.historicMoment),i));this.emit("apply-edits",{result:L})},this._updateMomentHandler=d=>{const{serviceUrl:s,gdbVersion:c,moment:o}=d,h=s===this.url,u=p(this),b=p(this)&&I(s,c,this.gdbVersion),f=p(this)&&!I(s,this.gdbVersion,null);h&&u&&b&&f&&"historicMoment"in this&&this.historicMoment!==o&&(this.historicMoment=o)},this.when().then(()=>{this.addHandles(W(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(q(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(n,d,s){return"historicMoment"in this&&this.historicMoment!==s&&O(n,d)}};return E([U()],t.prototype,"lastEditsEventDate",void 0),t=E([k("esri.layers.mixins.EditBusLayer")],t),t};export{J as F,O as a,C as c,z as i,Z as o,G as p,P as t};
