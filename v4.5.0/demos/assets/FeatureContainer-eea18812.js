import { d2 as l$1, b as e$1, r as r$1, eV as l, eW as u, bD as $$1, eX as m, eY as e$2, eZ as D } from './main-5658cd6e.js';
import { G } from './AttributeStoreView-2c6b7676.js';
import { i } from './TileContainer-76cc62ef.js';
import { z, $ } from './color-6132b2c2.js';
import { e, c as c$1 } from './utils-6a1fc53c.js';

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
function c(e,t){const i=t.length;if(e<t[0].value||1===i)return t[0].size;for(let s=1;s<i;s++)if(e<t[s].value){const i=(e-t[s-1].value)/(t[s].value-t[s-1].value);return t[s-1].size+i*(t[s].size-t[s-1].size)}return t[i-1].size}class h{constructor(){this.symbolLevels=[],this.vvColorValues=new Float32Array(8),this.vvColors=new Float32Array(32),this.vvOpacityValues=new Float32Array(8),this.vvOpacities=new Float32Array(8),this.vvSizeMinMaxValue=new Float32Array(4),this.outsideLabelsVisible=!1,this._vvMaterialParameters={vvSizeEnabled:!1,vvColorEnabled:!1,vvRotationEnabled:!1,vvRotationType:"geographic",vvOpacityEnabled:!1},this._technique=e;}getSizeVVFieldStops(i){const s=this._vvSizeFieldStops;if(s)switch(s.type){case"static":return s;case"level-dependent":return l$1(s.levels[i],(()=>{let e=1/0,a=0;for(const t in s.levels){const s=parseFloat(t),r=Math.abs(i-s);r<e&&(e=r,a=s);}if(e===1/0)return {sizes:new Float32Array([0,0,0,0,0,0]),values:new Float32Array([0,0,0,0,0,0])};const r=2**((i-a)/2),l=e$1(s.levels[a]),o=new Float32Array(l.values);return o[2]*=r,o[3]*=r,{sizes:e$1(l.sizes),values:o}}));default:return}}get vvMaterialParameters(){return this._vvMaterialParameters}update(e){r$1(this._vvInfo)&&this._updateVisualVariables(this._vvInfo.vvRanges,e);}setInfo(e,t,i){this._updateEffects(i),this._vvInfo=t,this._technique=c$1(e),this.rendererSchema=this._technique.createOrUpdateRendererSchema(this.rendererSchema,e);}getVariation(){return {...this._technique.getVariation(this.rendererSchema),outsideLabelsVisible:this.outsideLabelsVisible,supportsTextureFloat:l("2d").supportsTextureFloat}}getVariationHash(){return this._technique.getVariationHash(this.rendererSchema)<<1|(this.outsideLabelsVisible?1:0)}_updateEffects(e){r$1(e)?this.outsideLabelsVisible=e.excludedLabelsVisible:this.outsideLabelsVisible=!1;}_updateVisualVariables(e,t){const i=this._vvMaterialParameters;if(i.vvOpacityEnabled=!1,i.vvSizeEnabled=!1,i.vvColorEnabled=!1,i.vvRotationEnabled=!1,!e)return;const n=e.size;if(n){if(i.vvSizeEnabled=!0,n.minMaxValue){const e=n.minMaxValue;let i,a;if(z(e.minSize)&&z(e.maxSize))if($(e.minSize)&&$(e.maxSize))i=u(e.minSize),a=u(e.maxSize);else {const r=t.scale;i=u(c(r,e.minSize.stops)),a=u(c(r,e.maxSize.stops));}this.vvSizeMinMaxValue.set([e.minDataValue,e.maxDataValue,i,a]);}if(n.scaleStops&&(this.vvSizeScaleStopsValue=u(c(t.scale,n.scaleStops.stops))),n.unitValue){const e=$$1(t.spatialReference)/m[n.unitValue.unit];this.vvSizeUnitValueToPixelsRatio=e/t.resolution;}n.fieldStops&&(this._vvSizeFieldStops=n.fieldStops);}const v=e.color;v&&(i.vvColorEnabled=!0,this.vvColorValues.set(v.values),this.vvColors.set(v.colors));const u$1=e.opacity;u$1&&(i.vvOpacityEnabled=!0,this.vvOpacityValues.set(u$1.values),this.vvOpacities.set(u$1.opacities));const h=e.rotation;h&&(i.vvRotationEnabled=!0,i.vvRotationType=h.type);}}

/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.26/esri/copyright.txt for details.
*/
class o extends i{constructor(e){super(e),this._rendererInfo=new h,this._materialItemsRequestQueue=new e$2,this.attributeView=new G((()=>this.onAttributeStoreUpdate()));}destroy(){this.children.forEach((e=>e.destroy())),this.removeAllChildren(),this.attributeView.destroy(),this._materialItemsRequestQueue.clear();}setRendererInfo(e,t,r){this._rendererInfo.setInfo(e,t,r),this.requestRender();}async getMaterialItems(t,r){if(!t||0===t.length)return [];const s=D();return this._materialItemsRequestQueue.push({items:t,abortOptions:r,resolver:s}),this.requestRender(),s.promise}doRender(e){if(e.context.capabilities.enable("textureFloat"),e.context.capabilities.enable("vao"),this._materialItemsRequestQueue.length>0){let t=this._materialItemsRequestQueue.pop();for(;t;)this._processMaterialItemRequest(e,t),t=this._materialItemsRequestQueue.pop();}super.doRender(e);}renderChildren(e){for(const t of this.children)t.commit(e);this._rendererInfo.update(e.state),super.renderChildren(e);}updateTransforms(e){if(this.children.some((e=>e.hasData)))for(const t of this.children)t.setTransform(e);}createRenderParams(e){const t=super.createRenderParams(e);return t.rendererInfo=this._rendererInfo,t.attributeView=this.attributeView,t}onAttributeStoreUpdate(){}_processMaterialItemRequest(e,{items:t,abortOptions:r,resolver:s}){const{painter:i,pixelRatio:o}=e,a=t.map((e=>i.textureManager.rasterizeItem(e.symbol,o,e.glyphIds,r)));Promise.all(a).then((e=>{if(!this.stage)return void s.reject();const r=e.map(((e,r)=>({id:t[r].id,mosaicItem:e})));s.resolve(r);}),s.reject);}}

export { o };
