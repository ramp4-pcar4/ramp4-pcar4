import{bt as h,bu as f,bv as L,a1 as ve,e9 as Me,Q as g,eg as ct,bx as _e,aY as dt,b1 as pt,c8 as K,b2 as ht,s as O,G as x,f7 as ft,aK as oe,J as le,X as ue,aL as D,aM as yt,hZ as Ae,f2 as mt,d4 as gt,j2 as bt,qX as q,b0 as Pe,qY as St,d2 as J,gM as we,eo as ke,en as vt,el as _t,qZ as ce,q_ as wt,qE as j,q$ as de,r0 as It,j3 as Vt,T as Z,fr as pe,gY as X,nX as Ft,r1 as Ne,r2 as xt,cc as he,hG as Et,c9 as Ue,cb as Be,mZ as Le,fv as fe,r3 as De,d1 as Rt,r4 as Je,r5 as Ot,r6 as je,r7 as Ct,r8 as zt,l_ as ye,r9 as Ie,ra as Tt,pm as He,gL as Y,Z as qt,gG as Qe,iq as Mt,a8 as At,ci as Pt,bh as $e,bn as kt,cd as Nt,ch as Ut,rb as Bt,dm as Ge,rc as We,c7 as Ke,rd as Lt}from"./main-DCIX61zy.js";import{a as Ze}from"./Container-C-rqKhNk.js";import{i as Dt}from"./timeSupport-m80hv0JM.js";import{j as Jt,y as jt}from"./LayerView-DONYuvqR.js";import{i as Xe,r as Ye,n as Ht}from"./TechniqueInstance-DBGJNG3B.js";import{T as S,d as ee,M as E,e as me,h as k,f as te,g as Ve,x as ge,c as Fe,j as M,k as Qt,b as $t}from"./FeatureCommandQueue-F8dH-mVd.js";import{e as xe,k as H,as as Gt,at as Wt}from"./UpdateTracking2D-swFQJIjy.js";import{t as et}from"./CircularArray-DaQg3PQl.js";import{c as Kt}from"./WGLContainer-whJgsi2t.js";import{a as Zt}from"./SDFHelper-DaBS7X2-.js";import"./LabelMetric-DpMX58iW.js";import{e as Xt}from"./HighlightCounter-DFWq7PnG.js";import{p as Ee,n as Yt}from"./popupUtils-CGEHI2En.js";import{i as ei}from"./RefreshableLayerView-D30wcOhz.js";let be=class extends ve{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer?.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};h([f({type:Boolean})],be.prototype,"isAggregate",void 0),be=h([L("esri.AggregateGraphic")],be);const Re=be;let v=class extends Me{constructor(e){super(e),this._filter=null,this.duration=g("mapview-transitions-duration"),this._excludedEffectView=new Ze(e),this._includedEffectView=new Ze(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}get transitioningToEmpty(){return!this._excludedEffectView.final&&!this._includedEffectView.final}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransition(){this._includedEffectView.endTransition(),this._excludedEffectView.endTransition(),this._filter=null}_transitionTo(e){const t=this._get("featureEffect"),i=e,s=i?.includedEffect,r=i?.excludedEffect,a=this._includedEffectView.canTransitionTo(s)&&this._excludedEffectView.canTransitionTo(r);this._includedEffectView.effect=s,this._excludedEffectView.effect=r,this._set("featureEffect",i),this._filter=i?.filter||t?.filter||null,a||this.endTransition()}};h([f()],v.prototype,"_filter",void 0),h([f()],v.prototype,"_excludedEffectView",void 0),h([f()],v.prototype,"_includedEffectView",void 0),h([f()],v.prototype,"duration",void 0),h([f()],v.prototype,"excludedEffects",null),h([f()],v.prototype,"featureEffect",null),h([f()],v.prototype,"filter",null),h([f()],v.prototype,"hasEffects",null),h([f()],v.prototype,"includedEffects",null),h([f({value:0})],v.prototype,"scale",null),h([f()],v.prototype,"transitioning",null),h([f()],v.prototype,"transitioningToEmpty",null),v=h([L("esri.layers.effects.FeatureEffectView")],v);const ti=v;let ie=class extends _e{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){const i=dt.fromJSON(t.spatialReference),s=[];for(let r=0;r<e.length;r++){const a=e[r],n=Re.fromJSON(a),o=a.geometry?.spatialReference;n.geometry==null||o||(n.geometry.spatialReference=i);const l=a.aggregateGeometries,u=n.aggregateGeometries;if(l&&u!=null)for(const d in u){const c=u[d],p=l[d],y=p?.spatialReference;c==null||y||(c.spatialReference=i)}s.push(n)}return s}};h([f({type:[Re],json:{write:!0}})],ie.prototype,"features",void 0),h([ct("features")],ie.prototype,"readFeatures",null),ie=h([L("esri.rest.support.AggregateFeatureSet")],ie);const ii=ie;let si=class{constructor(){this._instanceById=new Map}destroy(){this._instanceById.clear()}get size(){return this._instanceById.size}entries(){return this._instanceById.entries()}updateStart(){this._instanceByIdNext=new Map}updateEnd(){if(!this._instanceByIdNext)throw new Error("InternalError: Found updateEnd call without corresponding updateStart");for(const e of this._instanceById.keys())this._instanceByIdNext.has(e)||this._instanceById.delete(e);for(const[e,t]of this._instanceByIdNext.entries()){const i=this._instanceById.get(e);i?i.setInput(t.getInput()):this._instanceById.set(e,t)}this._instanceByIdNext=null}values(){return this._instanceById.values()}ensureInstance(e,t){let i;if(typeof t=="object"&&"optionalAttributes"in t&&"uniforms"in t){i=`${e.type}${JSON.stringify(t.optionalAttributes)}`;const r=t.uniforms;if(typeof r=="object")for(const a in r)i+=`${a}.${r[a]!=null}`}else i=`${e.type}.${JSON.stringify(t)}`;const s=pt(i);if(this._instanceByIdNext){const r=new Xe(Ye(s),e,t);return this._instanceByIdNext.set(s,r),r}if(!this._instanceById.has(s)){const r=new Xe(Ye(s),e,t);this._instanceById.set(s,r)}return this._instanceById.get(s)}getInstance(e){return this._instanceById.get(e)}};const ri=1e3;let ai=class{constructor(e,t,i,s){this.getStage=e,this.getSubscriptionVersion=t,this.version=i,this._tileInfoView=s,this._pendingUpdates=new et(ri),this._locked=!1,this._tiles=new Map}destroy(){for(const e of this.tiles())e.destroy();this._pendingUpdates.clear(),this._tiles.clear()}tiles(){return this._tiles.values()}size(){return this._tiles.size}setTiles(e){this._tiles.clear();for(const t of e)this._tiles.set(t.key.id,t)}lockUploads(){this._locked=!0}unlockUploads(){this._locked=!1,this.flush()}enqueueUpdate(e){this._pendingUpdates.enqueue(e)}update(e){if(!this._locked)for(;this._pendingUpdates.size;){const t=this._pendingUpdates.peek();if(t==null||t.inner.attributeEpoch>e)break;this._updateTile(t),this._pendingUpdates.dequeue()}}removeTile(e){const t=this._tiles.get(e);g("esri-2d-update-debug")&&console.debug(`Tile[${e}] RenderState.removeTile`),t?.destroy(),this._tiles.delete(e)}isTileDone(e){const t=this._tiles.get(e.id);return!!t&&t.isReady}flush(){for(;this._pendingUpdates.size;){const e=this._pendingUpdates.dequeue();e!=null&&this._updateTile(e)}for(const e of this._tiles.values())e.upload()}_updateTile(e){const{inner:t,objectIdMap:i}=e,s=this.getSubscriptionVersion(t.id);if(s!==t.subscriptionVesrion){if(g("esri-2d-update-debug")){const o=`${t.subscriptionVesrion} != ${s}`;console.debug(`Version[${o}] Tile[${t.id}] FeatureContainer - Dropping message, outdated version]`,t)}return}if(g("esri-2d-update-debug")){const o=t.debugInfo?.chunkId??"<EnsureEnd>";console.debug(`Version[${t.version}] Tile[${t.id}] Chunk[${o}] RenderState.updateTile [${t.type}]`,t)}const r=this._ensureTile(t.id);if(t.type==="update"){const[o,...l]=t.modify;r.onMessage({type:"update",modify:o,remove:t.remove,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});for(const u of l){const d=this._tiles.get(u.tileId);d&&d.onMessage({type:"update",modify:u,remove:t.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:i})}return}if(t.append==null)return void r.onMessage({type:"append",clear:t.clear,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});const[a,...n]=t.append;r.onMessage({type:"append",clear:t.clear,append:a,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});for(const o of n){const l=this._tiles.get(o.tileId);l&&l.onMessage({type:"update",modify:o,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:i})}}_ensureTile(e){if(!this._tiles.has(e)){const t=this._createTile(e);this._copyPixelBufferedEntitiesInto(t),this._tiles.set(e,t)}return this._tiles.get(e)}_createTile(e){g("esri-2d-update-debug")&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);const t=new K(e),i=this._tileInfoView.getTileBounds(ht(),t),s=this._tileInfoView.getTileResolution(t.level),r=new Kt(t,s,i[0],i[3],!0);if(r.stage=this.getStage(),!r.stage){const a=new O("featurelayerview:webgl","Cannot create tile with empty stage");x.getLogger("esri.views.2d.layers.features.RenderState").error(a)}return r}_copyPixelBufferedEntitiesInto(e){let t=7;const i=this._tileInfoView.getLODInfoAt(e.key);for(let s=-1;s<=1;s++)for(let r=-1;r<=1;r++){if(s===0&&r===0)continue;const a=e.key.getNormalizedNeighbor(r,s,i).id,n=this._tiles.get(a);if(n!=null){const o=1<<t;e.copyPixelBufferedEntitesFrom(n,o,r,s)}t--}}},ni=class{constructor(e,t){this.id=e,this.version=t,this._resolver=ue(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}},oi=class extends Ht{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new ft,this._hitTestsRequests=[],this._store=new si,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._layerView=e,this.addTransitionable(this._layerView.featureEffectView)}renderChildren(e){if(this._updateAttributeView(),this._renderState?.update(this.attributeView.currentEpoch),this._renderState){const t=Array.from(this._renderState.tiles()).filter(i=>i.needsUpload);t.length&&(t[Math.floor(Math.random()*t.length)].upload(),t.length>=2&&this.requestRender());for(const i of this._renderState.tiles())i.tryReady(this.attributeView.currentEpoch)&&(this._subscriptions.get(i.key.id)?.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this.requestRender())}for(const t of this.children)t.setTransform(e.state);switch(super.renderChildren(e),e.drawPhase){case oe.MAP:return this._renderMapPhase(e);case oe.HIGHLIGHT:return this._renderHighlightPhase(e);case oe.LABEL:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight()}get _layer(){return this._layerView.layer}_getHeatmapInstance(e){if(this._instanceStore==null||!(e.drawPhase&S.heatmap.drawPhase))return null;for(const t of this._instanceStore.values())if(li(t))return t;return null}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter(e=>this._visibleTiles.has(e.key.id)):[]}updateAttributeView(e){this.requestRender(),this.attributeView.requestUpdate(e),this.hasLabels&&this._layerView.view.labelManager.requestUpdate()}updateSubscriptions(e){for(const{tileId:t,version:i}of e.subscribe)if(this._subscriptions.has(t))this._subscriptions.get(t).version=i;else{const s=new ni(t,i);this._subscriptions.set(t,s),this.updatingHandles.addPromise(s.promise)}for(const t of e.unsubscribe)this._subscriptions.get(t)?.destroy(),this._subscriptions.delete(t),this.removeTile(t)}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}async updateRenderState(e){g("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),this._renderStateNext=new ai(()=>this._stage,t=>this._subscriptions.get(t)?.version,e,this.tileInfoView)}getDisplayStatistics(e,t){const i=this._statisticsByLevel.get(e);return i?i.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let i=this._statisticsByLevel.get(e);i||(i=new Map,this._statisticsByLevel.set(e,i));for(const s of t)i.set(s.fieldName,{minValue:s.minValue,maxValue:s.maxValue})}editStart(){this._renderState?.lockUploads(),this.attributeView.lockTextureUploads(),this._lockStatisticUpdates=!0}editEnd(){this._renderState?.unlockUploads(),this.attributeView.unlockTextureUploads(),this._lockStatisticUpdates=!1;for(const e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this.requestRender()}swapRenderState(){this._renderStateNext&&(g("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`),this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderStateNext=null),this._renderState&&this._renderState.flush(),this.requestRender()}setVisibleTiles(e){this._visibleTiles=e}async onMessage(e,t){le(t);const i=e.inner;if(!this._subscriptions.has(i.id))return;const s=this._subscriptions.get(i.id);if(s.version!==i.subscriptionVesrion){if(g("esri-2d-update-debug")){const a=`${i.subscriptionVesrion} != ${s.version}`;console.debug(`Version[${a}] Tile[${i.id}] FeatureContainer - Dropping message, outdated version]`,i)}return}const r=this._renderStateNext??this._renderState;if(!r)throw new Error("InternalError: No renderState defined");r.version!==i.version&&console.error(`InternalError: Version mismatch. [renderState: ${r.version}, message: ${i.version}]`),r.enqueueUpdate(e),this.requestRender(),this._layerView.view.labelManager.requestUpdate(),this._layerView.requestUpdate()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let t=this._hitTestsRequests.find(({x:s,y:r})=>s===e.x&&r===e.y);const i=ue();return t?t.resolvers.push(i):(t={x:e.x,y:e.y,resolvers:[i]},this._hitTestsRequests.push(t)),this.requestRender(),i.promise}getSortKeys(e){const t=new Set(e),i=new Map;for(const s of this.children)if(s.getSortKeys(t).forEach((r,a)=>i.set(a,r)),i.size===t.size)break;return i}get hasAnimation(){return this.hasLabels}doRender(e){const{minScale:t,maxScale:i}=this._layer.effectiveScaleRange,s=e.state.scale;s<=(t||1/0)&&s>=i&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){if(this._getHeatmapInstance(e)==null)super.setStencilReference(e);else for(const t of this.children)t.stencilRef=S.heatmap.getStencilReference(t)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,D.All),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&yt(e,!1,t=>{this._renderFeatures(t,D.Highlight)})}_renderLabelPhase(e){this._renderFeatures(e,D.All)}_renderInsideEffect(e){const t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,D.InsideEffect),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind()}_renderOutsideEffect(e){const t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,D.OutsideEffect),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind()}_renderHittest(e){const{context:t}=e,i=e.painter.effects.hittest,s=t.getBoundFramebufferObject(),r=t.getViewport(),a=e.passOptions,n=e.drawPhase;i.bind(e),e.passOptions=i.createOptions(e,this._hitTestsRequests),e.drawPhase=oe.HITTEST;const{distance:o,smallSymbolDistance:l}=e.passOptions,u=Math.max(o,l);for(const d of this.children)d.visible&&d.containsScreenPoint(e.state,e.passOptions.position,2*u)&&this._renderTile(d,e,D.All);i.draw(e),i.unbind(),t.bindFramebuffer(s),t.restoreViewport(r),e.passOptions=a,e.drawPhase=n}_renderFeatures(e,t){const i=this._getHeatmapInstance(e);i!=null?this._renderHeatmapFeatures(e,t,i):this._renderGeometryFeatures(e,t)}_renderGeometryFeatures(e,t){for(const i of this.children)i.visible&&this._renderTile(i,e,t)}_renderHeatmapFeatures(e,t,i){for(const s of this.children)s.visible&&this._renderTile(s,e,t,xe.Heatmap);i.techniqueRef.renderResolvePass(e,i)}_renderTile(e,t,i,s){const r=g("featurelayer-force-marker-text-draw-order")?Ae.STRICT_MARKERS_AND_TEXT:Ae.BATCHING,a=e.getDisplayList(this._instanceStore,r);t.selection=i,a?.render(t,s)}};function li(e){return e.techniqueRef.type===xe.Heatmap}async function ui(e){const t=await mt("FeaturePipelineWorker",{client:e,strategy:"dedicated"});return new ci(t)}let ci=class{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy("features"),this.aggregates=this._connection.createInvokeProxy("aggregates"),this.streamMessenger=this._connection.createInvokeProxy("streamMessenger")}destroy(){this._connection.destroy()}get closed(){return this._connection.closed}};const di=10;let C=class extends Me{constructor(){super(...arguments),this.events=new gt,this._updatingStrategy=!0,this._tileToEvent=new bt,this._fetchStatus={outstanding:0,done:0}}get hasAllFeatures(){return this._hasAllData()&&(this._strategyInfo?.willQueryAllFeatures??!1)}get hasAllFeaturesInView(){return this._hasAllData()}get hasFullGeometries(){return this._hasAllData()&&(this._strategyInfo?.willQueryFullResolutionGeometry??!1)}onEvent(e){switch(e.type){case"subscribe":case"unsubscribe":case"loaded":case"error":this._handleTileEvent(e);break;case"updateStrategyStart":this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=e.about;break;case"updateStrategyEnd":this._updatingStrategy=!1;break;case"updateFieldsStart":this._fetchStatus={done:0,outstanding:0};break;case"updateFieldsEnd":break;case"updateFieldsError":this.events.emit("error",e);break;case"fetchStart":this._fetchStatus.outstanding+=1,this.events.emit("status",this._fetchStatus);break;case"fetchEnd":this._fetchStatus.done+=1,this.events.emit("status",this._fetchStatus),e.done&&(this._fetchStatus={done:0,outstanding:0})}}_hasAllData(){return!this._updatingStrategy&&this._hasAllTileData()}_hasAllTileData(){for(const e of this._tileToEvent.values())if(e.peekLast()?.type!=="loaded")return!1;return!0}_handleTileEvent(e){switch(e.type){case"subscribe":{const t=new et(di);t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case"unsubscribe":this._tileToEvent.delete(e.tile);break;case"loaded":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case"error":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t),this.events.emit("error",e);break}}}};h([f({readOnly:!0})],C.prototype,"hasAllFeatures",null),h([f({readOnly:!0})],C.prototype,"hasAllFeaturesInView",null),h([f({readOnly:!0})],C.prototype,"hasFullGeometries",null),h([f()],C.prototype,"_updatingStrategy",void 0),h([f()],C.prototype,"_strategyInfo",void 0),h([f()],C.prototype,"_tileToEvent",void 0),C=h([L("esri.views.2d.layers.features.FeatureSourceEventLog")],C);function R(e){switch(e.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":return"esriGeometryPolygon";case"multipatch":return"esriGeometryMultiPatch";case"multipoint":return"esriGeometryMultipoint";default:return null}}function _(e,t){const i=e.featureReduction;return i&&i.type!=="selection"&&(!("maxScale"in i)||!i.maxScale||i.maxScale<t.scale)?i:null}const pi=Math.PI;function tt(e,t){switch(t.transformationType){case q.Additive:return hi(e,t);case q.Constant:return fi(t,e);case q.ClampedLinear:return yi(e,t);case q.Proportional:return mi(e,t);case q.Stops:return gi(e,t);case q.RealWorldSize:return bi(e,t);case q.Identity:return e;case q.Unknown:return null}}function F(e,t){return typeof e=="number"?e:tt(t,e)}function hi(e,t){return e+(F(t.minSize,e)||t.minDataValue)}function fi(e,t){const i=e.stops;let s=i?.length&&i[0].size;return s==null&&(s=e.minSize),F(s,t)}function yi(e,t){const i=t.minDataValue,s=t.maxDataValue,r=(e-i)/(s-i),a=F(t.minSize,e),n=F(t.maxSize,e);return e<=i?a:e>=s?n:a+r*(n-a)}function mi(e,t){const i=e/t.minDataValue,s=F(t.minSize,e),r=F(t.maxSize,e);let a=null;return a=i*s,Pe(a,s,r)}function gi(e,t){const[i,s,r]=Si(e,t.cache.ipData);if(i===s)return F(t.stops[i].size,e);{const a=F(t.stops[i].size,e);return a+(F(t.stops[s].size,e)-a)*r}}function bi(e,t){const i=St[t.valueUnit],s=F(t.minSize,e),r=F(t.maxSize,e),{valueRepresentation:a}=t;let n=null;return n=a==="area"?2*Math.sqrt(e/pi)/i:a==="radius"||a==="distance"?2*e/i:e/i,Pe(n,s,r)}function Si(e,t){if(!t)return;let i=0,s=t.length-1;return t.some((r,a)=>e<r?(s=a,!0):(i=a,!1)),[i,s,(e-t[i])/(t[s]-t[i])]}function z(e){return(e.labelsVisible&&e.labelingInfo?.every(t=>t.deconflictionStrategy!=="none"))??!1}function N(e,t){const i=_(e,t);if(i?.labelsVisible&&i.labelingInfo?.length)return i.labelingInfo.every(s=>s.deconflictionStrategy!=="none")}function vi(e){return t=>J(tt(t,e))}function A(e){const t=e!=null&&"visualVariables"in e&&e.visualVariables;if(!t)return null;for(const i of t)if(i.type==="size")return vi(i);return null}function U(e,t,i,s){const r=e.subtypeCode!=null?`${e.subtypeField} = ${e.subtypeCode}`:null,a=we(e.definitionExpression,r),n=e.customParameters??{};return s&&(n.token=s),{type:"feature",mutable:{sourceRefreshVersion:i,availableFields:t.availableFields,dataFilter:{queryScaleRanges:e.queryScaleRanges??[],definitionExpression:a,gdbVersion:e.gdbVersion,historicMoment:e.historicMoment?.getTime(),timeExtent:e.timeExtent?.toJSON(),customParameters:n}}}}function _i(e,t,i=0){if(t==null)return e[i]=0,e[i+1]=0,e[i+2]=0,void(e[i+3]=0);const{r:s,g:r,b:a,a:n}=t;e[i]=s*n/255,e[i+1]=r*n/255,e[i+2]=a*n/255,e[i+3]=n}async function T(e,t){if(!e)return[];switch(e.type){case"simple-fill":return Ce(e,t);case"picture-fill":return zi(e,t);case"simple-marker":return st(e,t);case"picture-marker":return Fi(e,t);case"simple-line":return Q(e,t,!1);case"text":return Ei(e,t);case"label":return Ri(e,t);case"cim":return ee(e.data,t);case"web-style":{const i=await e.fetchCIMSymbol();return ee(i.data,t)}case"line-3d":return x.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-line`),Q(new _t,t,!1);case"point-3d":return x.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-marker`),st(new vt,t);case"polygon-3d":return x.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-fill`),Ce(new ke,t);case"mesh-3d":case"label-3d":return x.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Ignoring`),[];case"CIMSymbolReference":throw new Error("InternalError: CIMSymbolReference should already be resolved")}}async function wi(e,t){const{schemaOptions:i}=t,{store:s}=i,r=new Array(ce),a=new Array(ce/4);for(let c=0;c<ce;c++){const p=c<e.attributes.length?e.attributes[c].color:null;r[c]=[0,0,0,0],_i(r[c],p)}for(let c=0;c<ce/4;c++)a[c]=[0,0,0,0],a[c][0]=4*c<e.attributes.length?1:0,a[c][1]=4*c+1<e.attributes.length?1:0,a[c][2]=4*c+2<e.attributes.length?1:0,a[c][3]=4*c+3<e.attributes.length?1:0;const n={uniforms:{isActive:a,colors:r,dotValue:e.dotValue,dotScale:e.referenceScale,blending:e.dotBlendingEnabled,dotSize:e.dotSize,seed:e.seed},optionalAttributes:{}},o=s.ensureInstance(S.dotDensity,n).createMeshInfo({effects:null}),l=[],u=new ke({color:e.backgroundColor??[0,0,0,0],outline:null}),d=await T(u,t);if(l.push(...d),l.push(o),e.outline){const c=Q(e.outline,t,!0);l.push(...c)}return l}async function Ii(e,t){const{store:i}=t,{radius:s,minDensity:r,maxDensity:a,referenceScale:n,field:o,valueExpression:l,colorStops:u}=e,d=wt(u);return[i.ensureInstance(S.heatmap,{uniforms:{radius:J(s),minDensity:r,maxDensity:a,referenceScale:n,isFieldActive:!(!o&&!l),gradient:d,gradientHash:d.join(",")},optionalAttributes:{}}).createMeshInfo({effects:null})]}async function Vi(e,t){const{store:i}=t,s=e.outline?.width||0,r=E(e),a=i.ensureInstance(S.pieChart,{uniforms:{shader:{outlineWidth:Math.round(J(s)),defaultColor:me(e.defaultColor),outlineColor:me(e.outline?.color),othersColor:me(e.othersCategory?.color),donutRatio:e.holePercentage,sectorThreshold:e.othersCategory?.threshold||0,colors:e.attributes.map(n=>me(n.color)),visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,hittestUniforms:null},numberOfFields:e.attributes.length},optionalAttributes:{}}).createMeshInfo({size:e.size,outlineWidth:s,effects:null,scaleInfo:null,minPixelBuffer:k(r)});return[...e.backgroundFillSymbol?await Ce(e.backgroundFillSymbol,{schemaOptions:t,path:"",uniforms:ge}):[],a]}function it(e){if(e.style==="path"){if(e.path==null)throw new Error("Symbol with a style of type path must define a path");return{type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:e.path,asFill:!0}}}const t=H.fromSimpleMarker(e);if("outline"in e&&e.outline&&e.outline.style!=="none"&&e.outline.style!=="solid"){if(!t||!t.symbolLayers)throw new Error("Error handling marker! ");return{type:"sprite-rasterization-param",resource:t.symbolLayers[0],overrides:[]}}return{type:"sprite-rasterization-param",resource:Zt(t),overrides:[]}}async function st(e,t){const{uniforms:i,schemaOptions:s}=t,{store:r}=s;if(e.style==="path"||e.outline&&e.outline.style!=="solid"&&e.outline.style!=="none"){const p=H.fromSimpleMarker(e);if(!p||!p.symbolLayers)throw new Error("Error handling marker! ");if(i.visualVariableRotation&&(p.angleAlignment="Map"),e.style!=="path"){const y=p.symbolLayers[0];if(te(t.uniforms)){const m=k(t.uniforms,0,1);if(m>y.size){const I=m/y.size;y.size=m;const V=y.markerGraphics?.[0].symbol;(V.symbolLayers&&V.symbolLayers[0]).width*=I}}}return ee({type:"CIMSymbolReference",symbol:p},t)}const a=r.ensureInstance(S.marker,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),n=it(e);let o=e.color?.toArray()??[0,0,0,0];n.resource.type==="CIMVectorMarker"&&(o=[255,255,255,255]);const l=e.style==="triangle"?124/116:1,u=e.size,d=u*l,c=i.visualVariableColor!=null&&(e.style==="cross"||e.style==="x");return[a.createMeshInfo({type:"simple",color:o,height:u,width:d,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:Ve(i)?j.MAP:j.SCREEN,outlineColor:e.outline?.color?.toArray()??[0,0,0,0],outlineSize:e.outline?.width??1,referenceSize:u,sprite:n,overrideOutlineColor:c,hasSizeVV:te(i),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:k(i)})]}function Fi(e,t){const{uniforms:i,schemaOptions:s}=t,{store:r}=s,a=r.ensureInstance(S.marker,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),n=H.createPictureMarkerRasterizationParam(e);return n?[a.createMeshInfo({type:"picture",color:[255,255,255,255],height:e.height,width:e.width,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:Ve(i)?j.MAP:j.SCREEN,outlineColor:null,outlineSize:0,referenceSize:e.height,sprite:n,overrideOutlineColor:!1,hasSizeVV:te(i),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:k(i)})]:[]}function xi(e,t,i){const{uniforms:s,schemaOptions:r}=i,{store:a}=r,n=a.ensureInstance(S.marker,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),o=it(e),l=6,u=l*t.width,d=u,c=e.color?.toArray()??t.color?.toArray()??[0,0,0,0],p=e.style==="cross"||e.style==="x";let y;switch(e.placement){case"begin-end":y=de.Both;break;case"begin":y=de.JustBegin;break;case"end":y=de.JustEnd;break;default:y=de.None}const m={type:"cim-marker-placement-param",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:y,offsetAlongLine:0},overrides:[]};return[n.createMeshInfo({type:"simple",color:c,height:d,width:u,offsetX:0,offsetY:0,angle:0,alignment:Ve(s)?j.MAP:j.SCREEN,outlineColor:c,outlineSize:p?t.width:0,referenceSize:d/l,sprite:o,overrideOutlineColor:p&&s.visualVariableColor!=null,hasSizeVV:te(s),placement:m,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:k(s)})]}function Ei(e,t){const{uniforms:i,schemaOptions:s}=t,{store:r}=s;return[r.ensureInstance(S.text,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1,clipAngle:!1,referenceSymbol:!1}}).createMeshInfo({boxBackgroundColor:e.backgroundColor?.toArray(),boxBorderLineColor:e.borderLineColor?.toArray(),boxBorderLineSize:e.borderLineSize??0,color:e.color?.toArray()??[0,0,0,0],offsetX:e.xoffset,offsetY:e.yoffset,postAngle:e.angle,fontSize:e.font.size,decoration:e.font.decoration,haloColor:e.haloColor?.toArray()??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:[0,0,0,0],outlineSize:0,lineWidth:e.lineWidth,lineHeightRatio:e.lineHeight,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:e.font.toJSON(),textString:e.text,symbol:H.createCIMTextSymbolfromTextSymbol(e)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:k(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null})]}function Ri(e,t){const{schemaOptions:i,uniforms:s}=t,{store:r}=i,a=e.symbol,{allowOverrun:n,repeatLabel:o,repeatLabelDistance:l}=e,u={maxScale:e.maxScale??0,minScale:e.minScale??0},d=r.ensureInstance(S.label,{uniforms:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!0,clipAngle:!0,referenceSymbol:!0}}),c=e.labelPlacement,[p,y]=Gt(c);return[d.createMeshInfo({boxBackgroundColor:a.backgroundColor?.toArray(),boxBorderLineColor:a.borderLineColor?.toArray(),boxBorderLineSize:a.borderLineSize??0,color:a.color?.toArray()??[0,0,0,0],offsetX:a.xoffset,offsetY:a.yoffset,postAngle:a.angle,fontSize:a.font.size,decoration:a.font.decoration,outlineColor:[0,0,0,0],outlineSize:0,haloColor:a.haloColor?.toArray()??[0,0,0,0],haloSize:a.haloSize??0,lineWidth:a.lineWidth,lineHeightRatio:a.lineHeight,horizontalAlignment:p,verticalAlignment:y,repeatLabel:o,repeatLabelDistance:J(l),allowOverrun:n,labelPosition:e.labelPosition,scaleInfo:u,minPixelBuffer:k(s),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:a.font.toJSON(),textString:a.text,symbol:H.createCIMTextSymbolfromTextSymbol(a),primitiveName:"label-override"},useLegacyLabelEvaluationRules:e.labelExpressionInfo?.expression==null,overrides:[{type:"CIMPrimitiveOverride",valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.labelExpressionInfo?.expression??e.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1})]}function Oe(e,t){const i=e.width;return{outlineColor:e.color?.toArray()||[0,0,0,1],width:i,referenceWidth:i,capType:e.cap??"round",joinType:e.join??"round",miterLimit:e.miterLimit,hasSizeVV:t}}function Oi(e,t){const{uniforms:i,schemaOptions:s}=t,{store:r}=s,a=e.color?.toArray()??[0,0,0,0],n={type:"sprite-rasterization-param",resource:{type:"fill-style",style:e.style},overrides:[]};if(e.outline?.style==="solid")return[r.ensureInstance(S.patternOutlineFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,...Oe(e.outline,!!i.visualVariableSizeOutlineScaleStops),sprite:n,scaleInfo:null,effects:null})];const o=[],l=r.ensureInstance(S.patternFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:e.color?.toArray()??[0,0,0,0],sprite:n,scaleInfo:null,effects:null});return o.push(l),e.outline&&o.push(...Q(e.outline,t,!0)),o}function Ci(e,t){const{uniforms:i,schemaOptions:s}=t,{store:r}=s,a=e.color?.toArray()??[0,0,0,0];if(e.style!=="none"&&e.outline?.style==="solid")return[r.ensureInstance(S.outlineFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,...Oe(e.outline,!!i.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null})];const n=[];if(e.style!=="none"){const o=r.ensureInstance(S.fill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,scaleInfo:null,effects:null});n.push(o)}return e.outline&&n.push(...Q(e.outline,t,!0)),n}async function Ce(e,t){if(e.type==="cim")return ee(e.data,t);const{style:i}=e;return i&&i!=="none"&&i!=="solid"?Oi(e,t):Ci(e,t)}function zi(e,t){const{outline:i}=e,{uniforms:s,schemaOptions:r}=t,{store:a}=r,n=[],o=H.createPictureFillRasterizationParam(e);if(!o)return[];const{width:l,height:u,xoffset:d,yoffset:c,xscale:p,yscale:y}=e,m={color:[255,255,255,255],sprite:o,height:u,aspectRatio:l/u,offsetX:d,offsetY:c,scaleX:p,scaleY:y,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if(i?.style==="solid")return[a.ensureInstance(S.complexOutlineFill,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({...m,...Oe(i,!!s.visualVariableSizeOutlineScaleStops)})];const I=a.ensureInstance(S.complexFill,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!1}});return n.push(I.createMeshInfo(m)),i&&n.push(...Q(i,t,!0)),n}function Q(e,t,i){const{color:s,style:r,width:a,cap:n,join:o}=e,{schemaOptions:l}=t,{store:u}=l,d=[],c=i?{...ge,visualVariableSizeScaleStops:t.uniforms.visualVariableSizeOutlineScaleStops}:t.uniforms,p={uniforms:{visualVariableColor:c.visualVariableColor,visualVariableOpacity:c.visualVariableOpacity,visualVariableSizeMinMaxValue:c.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:c.visualVariableSizeScaleStops,visualVariableSizeStops:c.visualVariableSizeStops,visualVariableSizeUnitValue:c.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1}},y={color:s?.toArray()??[0,0,0,0],width:a,referenceWidth:a,capType:n,joinType:o,miterLimit:e.miterLimit,hasSizeVV:te(c),effects:null,scaleInfo:null};if(r==null||r==="solid"){const m=u.ensureInstance(S.line,p).createMeshInfo(y);d.push(m)}else if(r!=="none"){const m=u.ensureInstance(S.texturedLine,p).createMeshInfo({...y,offsetAlongLine:0,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:Wt(r,n)},overrides:[]}});d.push(m)}return e.marker!=null&&d.push(...xi(e.marker,e,t)),d}async function se(e,t,i){const s=t.labelsVisible&&t.labelingInfo||[],r=R(t),a=It(s,r);return{type:"label",classes:await Promise.all(a.map((n,o)=>Ti(e,n,o,i)))}}async function Ti(e,t,i,s){const r=await T(t,{path:`${i}`,schemaOptions:e,uniforms:s});return{maxScale:t.maxScale,minScale:t.minScale,expression:t.labelExpressionInfo?.expression??t.labelExpression,where:t.where,meshes:r}}async function re(e,t){if(!t)return{type:"simple",meshes:[]};switch(t.type){case"simple":return qi(e,t);case"dot-density":return Mi(e,t);case"class-breaks":return Ai(e,t);case"unique-value":return Pi(e,t);case"dictionary":return ki(t);case"heatmap":return Ni(e,t);case"pie-chart":return Ui(e,t)}}async function qi(e,t){const i=t.getSymbols(),s=i.length?i[0]:null,r=E(t);return{type:"simple",meshes:await T(s,{schemaOptions:e,uniforms:r,path:"renderer.symbol"})}}async function Mi(e,t){const i=E(t);return{type:"dot-density",meshes:await wi(t,{schemaOptions:e,uniforms:i,path:"renderer.symbol"})}}async function Ai(e,t){const i=E(t),s=t.backgroundFillSymbol,r=t.normalizationType,a=r==="log"?"esriNormalizeByLog":r==="percent-of-total"?"esriNormalizeByPercentOfTotal":r==="field"?"esriNormalizeByField":null,n=t.classBreakInfos.map(async d=>({meshes:await T(d.symbol,{path:`renderer-stop-${d.minValue}-${d.maxValue}`,schemaOptions:e,uniforms:i}),min:d.minValue,max:d.maxValue})),o=(await Promise.all(n)).sort((d,c)=>d.min-c.min),l=await T(s,{schemaOptions:e,path:"renderer.backgroundFill",uniforms:{...ge,visualVariableSizeOutlineScaleStops:i.visualVariableSizeOutlineScaleStops}}),u=await T(t.defaultSymbol,{schemaOptions:e,path:"renderer.defaultSymbol",uniforms:i});return{type:"interval",field:t.field,expression:t.valueExpression,backgroundFill:l,defaultSymbol:u,intervals:o,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,normalizationType:a,isMaxInclusive:t.isMaxInclusive}}async function Pi(e,t){const i=[],s=E(t),r=await T(t.backgroundFillSymbol,{schemaOptions:e,path:"renderer.backgroundFill",uniforms:{...ge,visualVariableSizeOutlineScaleStops:s.visualVariableSizeOutlineScaleStops}}),a=await T(t.defaultSymbol,{schemaOptions:e,path:"renderer.defaultSymbol",uniforms:s});for(const n of t.uniqueValueInfos??[]){const o=await T(n.symbol,{path:`renderer-unique-value-${n.value}`,schemaOptions:e,uniforms:s});i.push({value:""+n.value,symbol:o})}return{type:"map",field:t.field,expression:t.valueExpression,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,backgroundFill:r,defaultSymbol:a,map:i}}function ki(e){const t=E(e),i=e.scaleExpression,s=i!=null&&i!=="1"?{valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.scaleExpression,returnType:"Numeric"},defaultValue:1}:void 0;return{type:"dictionary",fieldMap:e.fieldMap,scaleExpression:s,visualVariableUniforms:t}}async function Ni(e,t){return{type:"heatmap",meshes:await Ii(t,e)}}async function Ui(e,t){return{type:"pie-chart",meshes:await Vi(t,e)}}async function Bi(e,t){const i=t.renderer,s=E(i);return{symbology:await re(e,i),labels:await se(e,t,s)}}async function P(e,t,i,s){const r=i.featureReduction;if(r)switch(r.type){case"binning":return Di(r,e,t,i,s);case"cluster":return Ji(r,e,t,i,s)}const a=ji(i.orderBy,i.renderer,i.objectIdField),n=Fe(i.renderer,t.filters),o=await Bi(e,i),l=ze(o.symbology);return{storage:n,mesh:{properties:{sortKey:a,timeZone:t.timeZone,returnMeshObjectId:l,displayRefreshVersion:s},strategy:{type:"feature"},factory:o}}}function rt(e,t){return e.fields.map(i=>({...i.toJSON(),type:Li(i,t)}))}function Li(e,t){const{onStatisticExpression:i,onStatisticField:s,statisticType:r}=e;switch(r){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(i){const{returnType:n}=i;return n?n==="string"?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const a=t.find(n=>n.name===s);return a?a.type:"esriFieldTypeString"}}}async function Di(e,t,i,s,r){const a=rt(e,s.fields),n=e.renderer,o=await re(t,n),l=Fe(n,[null,null]),u=E(n),d=await se(t,{geometryType:"polygon",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},u),c=ze(o),p=e.binType==="geohash"?{type:"geohash",fixBinLevel:e.fixedBinLevel??3}:{type:"grid",size:J(e.size),fixedBinLevel:e.fixedBinLevel};return{storage:l,mesh:{properties:{sortKey:null,timeZone:i.timeZone,returnMeshObjectId:c,displayRefreshVersion:r},strategy:{type:"binning",fields:a,index:p,featureFilter:i.filters[0]},factory:{labels:d,symbology:o}}}}async function Ji(e,t,i,s,r){const a=rt(e,s.fields),n={type:"cluster",feature:await re(t,e.effectiveFeatureRenderer),cluster:await re(t,e.effectiveClusterRenderer)},o=E(e.effectiveFeatureRenderer),l={type:"cluster",feature:await se(t,s,o),cluster:await se(t,{geometryType:"point",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},o)},u=Fe(e.effectiveFeatureRenderer,[null,null]),d=ze(n);return{storage:u,mesh:{properties:{sortKey:null,timeZone:i.timeZone,displayRefreshVersion:r,returnMeshObjectId:d},strategy:{type:"cluster",fields:a,featureFilter:i.filters[0],clusterRadius:J(e.clusterRadius/2)},factory:{labels:l,symbology:n}}}}function ji(e,t,i){const s=t!=null&&t.type==="unique-value"&&t.orderByClassesEnabled;if(e!=="default"||s||(e=[new Vt({field:i,order:"descending"})]),e!=="default"&&e?.length){e.length;const r=e[0],a=r.order==="ascending"?"asc":"desc";return r.field?{field:r.field,order:a}:r.valueExpression?{expression:r.valueExpression,order:a}:null}return s?{byRenderer:!0,order:"asc"}:null}function ae(e){return e.techniqueType===xe.AnimatedMarker}function ze(e){return!!(e.type==="simple"&&e.meshes.some(ae)||e.type==="interval"&&(e.intervals.some(t=>t.meshes.some(ae))||e.backgroundFill.some(ae))||e.type==="map"&&(e.map.some(t=>t.symbol.some(ae))||e.backgroundFill.some(ae)))}let Hi=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=z(t);return[{vvEvaluators:{0:A(t.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:i,editingInfo:s,objectIdField:r,globalIdField:a,datesInUnknownTimezone:n,orderBy:o,parsedUrl:l}=t,u=t.fieldsIndex.toJSON(),d=R(t),c=t.timeInfo?.toJSON(),p=t.spatialReference.toJSON(),y=Z(l);let m=r;if(o?.length){const I=!o[0].valueExpression&&o[0].field;I&&(m=I)}return{type:"feature-service",source:y,isSourceHosted:pe(y.path),orderByFields:m,outSpatialReference:e.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:n,globalIdField:a,fieldsIndex:u,geometryType:d,objectIdField:r,timeInfo:c,spatialReference:p,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:s?.lastEditDate?.getTime(),snapshotInfo:null}}}createSourceSchema(e,t){const{definitionExpression:i,customParameters:s,timeExtent:r,apiKey:a}=this.layer;return U({definitionExpression:i,customParameters:s,timeExtent:r},e,t,a)}createProcessorSchema(e,t,i){const{fields:s,geometryType:r,orderBy:a,objectIdField:n,renderer:o,labelingInfo:l,labelsVisible:u}=this.layer,d={featureReduction:null,fields:s.map(c=>c.toJSON()),geometryType:r,labelingInfo:l,labelsVisible:u,objectIdField:n,orderBy:a??"default",renderer:o?.clone()};return P(e,t,d,i)}get hasRequiredSupport(){return M(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:i,apiKey:s,renderer:r}=t,a=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(t.customParameters),o=JSON.stringify(t.orderBy);return{outFields:this.layer.outFields,apiKey:s,customParameters:n,definitionExpression:i,labelingInfo:a,orderBy:o,renderer:r}}setGraphicOrigin(e){e.origin={type:"catalog",layer:this.layer}}};function Te(e,t){const i=e.extent,s=t?.clone().intersection(i),r=s!=null?s.width*s.height:0,a=t?t.width*t.height:0,n=a===0?0:r/a,o=g("featurelayer-snapshot-point-coverage");return!isNaN(n)&&n>=o}function $(e,t){return e.floorInfo!=null&&(e.floorInfo.viewAllLevelIds.length>0||t.floors.length>0)}function qe(e,t,i){const s=Qi(e,t?.where,i);return s&&(t??=new X,t.where=s),t}function Qi(e,t,i){if(e.floorInfo==null||!i.floors?.length)return t;let s=i.floors;const{floorField:r,viewAllLevelIds:a}=e.floorInfo;a.length&&(s=a);const n=s.filter(l=>l!=="").map(l=>"'"+l+"'");if(n.push("''"),t?.includes(r)){let l=new RegExp("AND \\("+r+".*NULL\\)","g");t=t.replace(l,""),l=new RegExp("\\("+r+".*NULL\\)","g"),t=(t=t.replace(l,"")).replaceAll(/\s+/g," ").trim()}let o="("+r+" IN ({ids}) OR "+r+" IS NULL)";return o=o.replace("{ids}",n.join(", ")),we(t,o)}let $i=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t,e)??z(t);return[{vvEvaluators:{0:A(t.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:i,editingInfo:s,objectIdField:r,typeIdField:a,globalIdField:n,datesInUnknownTimezone:o,orderBy:l,subtypeField:u,refreshInterval:d}=t,c=t.fieldsIndex.toJSON(),p=R(t),y=t.timeInfo?.toJSON(),m=t.spatialReference.toJSON(),I=t.types?.map(B=>B.toJSON()),V=Z(this.layer.parsedUrl);this.layer.dynamicDataSource&&(V.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let W=this.layer.objectIdField;if(l?.length){const B=!l[0].valueExpression&&l[0].field;B&&(W=B)}const Se=s?.lastEditDate==null&&d>0,ne=!!g("featurelayer-snapshot-enabled")&&t.geometryType==="point"&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!Se,ut=ne&&Te(e,t.fullExtent);return{type:"feature-service",source:V,isSourceHosted:pe(V.path),orderByFields:W,outSpatialReference:e.spatialReference.toJSON(),metadata:{typeIdField:a??void 0,types:I,timeReferenceUnknownClient:o,subtypeField:u,globalIdField:n,fieldsIndex:c,geometryType:p,objectIdField:r,timeInfo:y,spatialReference:m,subtypes:this.layer.subtypes?.map(B=>B.toJSON())},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:s?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:ne,supportsSnapshotMaxThreshold:ut,snapshotCountThresholds:{min:g("featurelayer-snapshot-point-min-threshold"),max:g("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:i,customParameters:s,gdbVersion:r,historicMoment:a,subtypeCode:n,subtypeField:o,timeExtent:l,apiKey:u}=this.layer;return U({definitionExpression:i,customParameters:s,gdbVersion:r,historicMoment:a,subtypeCode:n,subtypeField:o,timeExtent:l},e,t,u)}createProcessorSchema(e,t,i){const{fields:s,renderer:r,geometryType:a,labelingInfo:n,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,d={fields:s.map(c=>c.toJSON()),renderer:r?.clone(),featureReduction:_(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return P(e,t,d,i)}get hasRequiredSupport(){return M(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return $(this.layer,e)}addFilters(e,t){return qe(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:i,renderer:s,gdbVersion:r,apiKey:a,subtypeCode:n}=t,o=this.layer.labelsVisible?this.layer.labelingInfo:null,l=t.historicMoment?.getTime()??void 0,u=JSON.stringify(t.customParameters),d=_(t,e),c=JSON.stringify(t.orderBy),p=$(this.layer,e)?e.floors:null;return{outFields:this.layer.outFields,apiKey:a,customParameters:u,definitionExpression:i,featureReduction:d,floors:p,gdbVersion:r,historicMoment:l,labelingInfo:o,orderBy:c,renderer:s,subtypeCode:n}}};function Gi(e){if(!("openPorts"in e))throw new O("source-not-supported")}class at{constructor(t){this.layer=t}getLabelingDeconflictionInfo(t){const i=this.layer,s=N(i,t)??z(i);return[{vvEvaluators:{0:A(i.renderer)},deconflictionEnabled:s}]}async createServiceOptions(t){const i=this.layer,{capabilities:s,objectIdField:r}=i,a=i.fieldsIndex.toJSON(),n=R(i),o=i.timeInfo?.toJSON(),l=i.spatialReference.toJSON();return Gi(i.source),{type:"memory",source:await i.source.openPorts(),orderByFields:r,outSpatialReference:t.spatialReference.toJSON(),metadata:{fieldsIndex:a,geometryType:n,objectIdField:r,timeInfo:o,spatialReference:l,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:null},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(t,i){const{definitionExpression:s,timeExtent:r}=this.layer;return U({definitionExpression:s,timeExtent:r,customParameters:null},t,i,null)}createProcessorSchema(t,i,s){const{fields:r,renderer:a,geometryType:n,labelingInfo:o,labelsVisible:l,orderBy:u,objectIdField:d}=this.layer,c={fields:r.map(p=>p.toJSON()),renderer:a?.clone(),featureReduction:_(this.layer,i),geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:d,orderBy:u??"default"};return P(t,i,c,s)}get hasRequiredSupport(){return M(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(t){const i=this.layer,{definitionExpression:s,renderer:r}=i,a=this.layer.labelsVisible?this.layer.labelingInfo:null,n=_(i,t),o=JSON.stringify(i.orderBy);return{outFields:this.layer.outFields,orderBy:o,definitionExpression:s,renderer:r,labelingInfo:a,featureReduction:n}}}class Wi{constructor(t){this.layer=t}getLabelingDeconflictionInfo(t){const i=this.layer,s=N(i,t)??z(i);return[{vvEvaluators:{0:A(i.renderer)},deconflictionEnabled:s}]}async createServiceOptions(t){const i=this.layer,{capabilities:s,objectIdField:r}=i,a=i.fieldsIndex.toJSON(),n=R(i),o=i.spatialReference.toJSON();return{type:"memory",source:await i.source.openPorts(),orderByFields:r,outSpatialReference:t.spatialReference.toJSON(),metadata:{fieldsIndex:a,geometryType:n,objectIdField:r,spatialReference:o,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:i.timeInfo?.toJSON(),timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(t,i){const{definitionExpression:s}=this.layer;return U({definitionExpression:s,customParameters:null},t,i,null)}createProcessorSchema(t,i,s){const{fields:r,renderer:a,geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:u}=this.layer,d={fields:r.map(c=>c.toJSON()),renderer:a?.clone(),featureReduction:_(this.layer,i),geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:u,orderBy:"default"};return P(t,i,d,s)}get hasRequiredSupport(){return M(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(t){const i=this.layer,{definitionExpression:s,renderer:r}=i;return{definitionExpression:s,renderer:r,labelingInfo:this.layer.labelsVisible?this.layer.labelingInfo:null,featureReduction:_(i,t)}}}let Ki=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t,e)??z(t);return[{vvEvaluators:{0:A(t.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:i,objectIdField:s}=t,r=t.fieldsIndex.toJSON(),a=R(t),n=t.timeInfo?.toJSON(),o=t.spatialReference.toJSON(),l=t.source.getSource(),u=this.layer.objectIdField,d=Z(i);return d.query.maxRecordCount=l.maxRecordCount,{type:"ogc",source:l,orderByFields:u,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:r,geometryType:a,objectIdField:s,timeInfo:n,spatialReference:o,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:d.query.maxRecordCount,supportsCompactGeometry:d.query.supportsCompactGeometry,supportsDefaultSpatialReference:d.query.supportsDefaultSpatialReference,supportsFormatPBF:d.query.supportsFormatPBF,supportsMaxRecordCountFactor:d.query.supportsMaxRecordCountFactor,supportsQuantization:d.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}}createSourceSchema(e,t){const{customParameters:i,timeExtent:s,apiKey:r}=this.layer;return U({customParameters:i,timeExtent:s},e,t,r)}createProcessorSchema(e,t,i){const{fields:s,renderer:r,geometryType:a,labelingInfo:n,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,d={fields:s.map(c=>c.toJSON()),renderer:r?.clone(),featureReduction:_(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return P(e,t,d,i)}get hasRequiredSupport(){return M(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{renderer:i,apiKey:s}=t,r=this.layer.labelsVisible?this.layer.labelingInfo:null;return{apiKey:s,customParameters:JSON.stringify(t.customParameters),featureReduction:_(t,e),labelingInfo:r,orderBy:JSON.stringify(t.orderBy),renderer:i}}},Zi=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t,e)??z(t);return[{vvEvaluators:{0:A(t.renderer)},deconflictionEnabled:i}]}async createServiceOptions(e){const t=this.layer,{capabilities:i,objectIdField:s,globalIdField:r,orderBy:a,refreshInterval:n}=t,o=t.fieldsIndex.toJSON(),l=R(t),u=t.timeInfo?.toJSON(),d=t.spatialReference.toJSON(),c=Z(this.layer.parsedUrl);let p=this.layer.objectIdField;if(a?.length){const V=!a[0].valueExpression&&a[0].field;V&&(p=V)}const y=n>0,m=!!g("featurelayer-snapshot-enabled")&&t.geometryType==="point"&&i?.query.supportsPagination&&!i?.operations.supportsEditing&&!y,I=m&&Te(e,t.fullExtent);return{type:"feature-service",source:c,isSourceHosted:pe(c.path),orderByFields:p,outSpatialReference:e.spatialReference.toJSON(),metadata:{globalIdField:r,fieldsIndex:o,geometryType:l,objectIdField:s,timeInfo:u,spatialReference:d,timeReferenceUnknownClient:!1,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,lastEditDate:null,snapshotInfo:{supportsSnapshotMinThreshold:m,supportsSnapshotMaxThreshold:I,snapshotCountThresholds:{min:g("featurelayer-snapshot-point-min-threshold"),max:g("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(e,t){const{definitionExpression:i,customParameters:s,timeExtent:r}=this.layer;return U({definitionExpression:i,customParameters:s,timeExtent:r},e,t,null)}createProcessorSchema(e,t,i){const{fields:s,renderer:r,geometryType:a,labelingInfo:n,labelsVisible:o,orderBy:l,objectIdField:u}=this.layer,d={fields:s.map(c=>c.toJSON()),renderer:r?.clone(),featureReduction:_(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,orderBy:l??"default"};return P(e,t,d,i)}get hasRequiredSupport(){return M(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return $(this.layer,e)}addFilters(e,t){return qe(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:i,renderer:s,outFields:r}=t,a=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(t.customParameters),o=_(t,e);return{outFields:r,orderBy:JSON.stringify(t.orderBy),definitionExpression:i,renderer:s,labelingInfo:a,featureReduction:o,customParameters:n,floors:$(this.layer,e)?e.floors:null}}},Xi=class{constructor(e){this.layer=e}get hasRequiredSupport(){return M(this.layer.renderer)}get timeOptions(){return null}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t,e)??z(t);return[{vvEvaluators:{0:A(t.renderer)},deconflictionEnabled:i}]}getUpdateHashProperties(e){const t=this.layer,{renderer:i}=t,s=this.layer.labelsVisible?this.layer.labelingInfo:null,r=JSON.stringify(t.customParameters),a=_(t,e),n=JSON.stringify(t.orderBy);return{outFields:this.layer.outFields,labelingInfo:s,featureReduction:a,customParameters:r,orderBy:n,renderer:i}}async createServiceOptions(e){const t=R(this.layer);return{type:"parquet",source:{urls:this.layer.urls.items},outSpatialReference:e.spatialReference.toJSON(),geometryInfo:this.layer.source.geometryInfo,metadata:{spatialReference:this.layer.spatialReference,fieldsIndex:this.layer.fieldsIndex.toJSON(),objectIdField:this.layer.objectIdField,geometryType:t,types:null,subtypes:null,timeInfo:null,typeIdField:null,subtypeField:null,globalIdField:null,timeReferenceUnknownClient:null}}}createSourceSchema(e,t){return{type:"parquet",mutable:{sourceRefreshVersion:t,availableFields:e.availableFields,dataFilter:{customParameters:this.layer.customParameters??null}}}}createProcessorSchema(e,t,i){const s={fields:this.layer.fields.map(r=>r.toJSON()),renderer:this.layer.renderer?.clone(),featureReduction:_(this.layer,t),geometryType:this.layer.geometryType,labelingInfo:this.layer.labelingInfo,labelsVisible:this.layer.labelsVisible,objectIdField:this.layer.objectIdField,orderBy:this.layer.orderBy};return P(e,t,s,i)}};class Yi{constructor(t){this.layer=t}getLabelingDeconflictionInfo(t){const i=this.layer,s=N(i,t)??z(i);return[{vvEvaluators:{0:A(i.renderer)},deconflictionEnabled:s}]}async createServiceOptions(t){const i=this.layer,{objectIdField:s}=i,r=R(i),a=i.timeInfo?.toJSON()||null,n=i.spatialReference?i.spatialReference.toJSON():null;return{type:"stream",source:this.layer.parsedUrl,outSpatialReference:t.spatialReference.toJSON(),metadata:{fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:r,objectIdField:s,timeInfo:a,timeReferenceUnknownClient:null,spatialReference:n,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}}createSourceSchema(t,i){const{definitionExpression:s,geometryDefinition:r,customParameters:a}=this.layer;return{type:"stream",mutable:{sourceRefreshVersion:i,availableFields:t.availableFields,dataFilter:{geometryDefinition:r?.toJSON(),definitionExpression:s,customParameters:a??null,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(t,i,s){const{fields:r,renderer:a,geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:u}=this.layer,d={fields:r.map(c=>c.toJSON()),renderer:a?.clone(),featureReduction:_(this.layer,i),geometryType:n,labelingInfo:o,labelsVisible:l,objectIdField:u,orderBy:"default"};return P(t,i,d,s)}get hasRequiredSupport(){return M(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(t){const i=this.layer,{definitionExpression:s,renderer:r}=i,a=this.layer.labelsVisible?this.layer.labelingInfo:null,n=JSON.stringify(i.customParameters);return{definitionExpression:s,renderer:r,labelingInfo:a,featureReduction:_(i,t),customParameters:n,geometryDefinition:i.geometryDefinition,definitionExpressoin:i.definitionExpression}}}async function es(e,{subtypeField:t,sublayers:i}){const s=await Promise.all(i.map(({renderer:r})=>re(e,r)));return{type:"subtype",subtypeField:t,renderers:i.reduce((r,{subtypeCode:a},n)=>({...r,[a]:s[n]}),{})}}function ts(e,t){const i=Ft();return{type:"subtype",filters:e.filters,capabilities:{maxTextureSize:i.maxTextureSize},subtypeField:t.subtypeField,target:"feature",bindings:t.sublayers.reduce((s,{renderer:r,subtypeCode:a})=>{const n=Qt(r);return{...s,[a]:n}},{})}}async function is(e,{subtypeField:t,sublayers:i}){const s=await Promise.all(i.map(r=>{const a=E(r.renderer),n={...r,geometryType:r.geometryType??null};return se(e,n,a)}));return{type:"subtype",subtypeField:t,renderers:i.reduce((r,{subtypeCode:a},n)=>({...r,[a]:s[n]}),{})}}async function ss(e,t,i,s){return{storage:ts(t,i),mesh:{properties:{timeZone:t.timeZone,displayRefreshVersion:s,returnMeshObjectId:!1,sortKey:null},strategy:{type:"feature"},factory:{symbology:await es(e,i),labels:await is(e,i)}}}}class rs{constructor(t){this.layer=t}getLabelingDeconflictionInfo(t){return[{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every(i=>z(i))}]}async createServiceOptions(t){const i=this.layer,{capabilities:s,datesInUnknownTimezone:r,editingInfo:a,globalIdField:n,objectIdField:o,refreshInterval:l,subtypeField:u}=i,d=i.fieldsIndex.toJSON(),c=R(i),p=i.timeInfo?.toJSON(),y=i.spatialReference.toJSON(),m=Z(this.layer.parsedUrl),I=o,V=a?.lastEditDate==null&&l>0,W=!!g("featurelayer-snapshot-enabled")&&i.geometryType==="point"&&s?.query.supportsPagination&&!s?.operations.supportsEditing&&!V,Se=W&&Te(t,i.fullExtent);return{type:"feature-service",source:m,isSourceHosted:pe(m.path),orderByFields:I,outSpatialReference:t.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:r,subtypeField:u,globalIdField:n,fieldsIndex:d,geometryType:c,objectIdField:o,timeInfo:p,spatialReference:y,subtypes:this.layer.subtypes?.map(ne=>ne.toJSON()),typeIdField:null,types:null},queryMetadata:{maxRecordCount:s.query.maxRecordCount,supportsCompactGeometry:s.query.supportsCompactGeometry,supportsDefaultSpatialReference:s.query.supportsDefaultSpatialReference,supportsFormatPBF:s.query.supportsFormatPBF,supportsMaxRecordCountFactor:s.query.supportsMaxRecordCountFactor,supportsQuantization:s.query.supportsQuantization,lastEditDate:a?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:W,supportsSnapshotMaxThreshold:Se,snapshotCountThresholds:{min:g("featurelayer-snapshot-point-min-threshold"),max:g("featurelayer-snapshot-point-max-threshold")}}}}}createSourceSchema(t,i){const{definitionExpression:s,customParameters:r,gdbVersion:a,historicMoment:n,subtypeField:o,timeExtent:l,apiKey:u}=this.layer,d={queryScaleRanges:this.layer.sublayers.items.map(c=>({subtypeCode:c.subtypeCode,minScale:c.minScale,maxScale:c.maxScale})),definitionExpression:s,customParameters:r,gdbVersion:a,historicMoment:n,subtypeField:o,timeExtent:l};return U(d,t,i,u)}createProcessorSchema(t,i,s){const r={subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,a=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:a.labelingInfo,labelsVisible:a.labelsVisible,renderer:a.renderer,subtypeCode:a.subtypeCode,orderBy:null}))};return ss(t,i,r,s)}hasFilters(t){return $(this.layer,t)||as(this.layer,t)}addFilters(t,i){t=qe(this.layer,t,i);const s=this.layer.sublayers.filter(a=>!nt(a,i)).map(a=>a.subtypeCode);if(!s.length)return t;t??=new X;const r=`NOT ${this.layer.subtypeField} IN (${s.join(",")})`;return t.where=we(t.where,r),t}get hasRequiredSupport(){return!0}get timeOptions(){return this.layer}getUpdateHashProperties(t){const i=this.layer,{definitionExpression:s,gdbVersion:r,apiKey:a}=i,n=i.historicMoment?.getTime()??void 0,o=JSON.stringify(i.customParameters),l=$(this.layer,t)?t.floors:null,u=this.layer.sublayers.map(({renderer:d,labelsVisible:c,labelingInfo:p,visible:y})=>({renderer:d,labelsVisible:c,labelingInfo:p,visible:y}));return{outFields:this.layer.outFields,gdbVersion:r,definitionExpression:s,historicMoment:n,customParameters:o,apiKey:a,sublayers:u,floors:l}}setGraphicOrigin(t){const i=this.layer.fieldsIndex.get(this.layer.subtypeField),s=t.attributes[i.name],r=this.layer.sublayers.find(a=>a.subtypeCode===s);t.layer=t.sourceLayer=r}}function as(e,t){return e.sublayers.some(i=>!nt(i,t))}function nt(e,t){return e.visible&&(e.minScale===0||Ne(t.scale,e.minScale)||t.scale<e.minScale)&&(e.maxScale===0||Ne(t.scale,e.maxScale)||t.scale>e.maxScale)}async function b(e,t){try{return await e}catch(i){if(i.name!=="no-queryEngine")throw i;return t}}function G(e,t){const i=new Set;for(const s of e instanceof Set?e.values():e.keys())t.has(s)||i.add(s);return i}class ns{constructor(t,i,s){const r=s?t.getTileCoverage(s,0,!0,"closest"):null,a=t.getTileCoverage(i,0,!0,"closest");if(this._tileKeys=new Map,r)for(const n of r.keys())this._tileKeys.set(n.id,n);if(a)for(const n of a.keys())this._tileKeys.set(n.id,n)}get coverageSet(){return new Set(this._tileKeys.keys())}keys(){return this._tileKeys.values()}}class os{constructor(t){this.version=t}}class ls{constructor(t){this._subscriptions=new Map,this._visible=new Set,this._paused=new Set,this._version=0,this._config=t}destroy(){}get _coverageSet(){return this._coverage?.coverageSet??new Set}suspend(){this._suspendedOverage=this._coverage,this._coverage=null,this._updateSubscriptions()}resume(){this._coverage==null&&(this._coverage=this._suspendedOverage,this._suspendedOverage=null,this._updateSubscriptions())}update(t,i){return this._version=(this._version+1)%Number.MAX_SAFE_INTEGER,this._updateCoverage(t,i),this._updateSubscriptions(),new Set(this._visible)}_updateCoverage(t,i){this._coverage=new ns(this._config.tileInfoView,t,i)}_updateSubscriptions(){const t=this._coverageSet,i=this._updateVisibility(),s=G(i,t),r=G(this._subscriptions,i),a=G(t,this._subscriptions),n=G(r,t),o=G(s,n),l=G(o,this._paused);this._visible=i;for(const u of a.values())this._subscriptions.set(u,new os(this._version));for(const u of l.values())this._paused.add(u);for(const u of n.values())this._subscriptions.delete(u),this._paused.delete(u);(a.size||n.size||l.size)&&this._sendUpdateSubscriptions(a,n,l)}_sendUpdateSubscriptions(t,i,s){const r=Array.from(t.values()).map(a=>({tileId:a,version:this._subscriptions.get(a).version}));this._config.updateSubscriptions({subscribe:r,unsubscribe:Array.from(i.values()),pause:Array.from(s.values())})}_updateVisibility(){const t=new Set,i=new Set;if(!this._coverage)return t;for(const a of this._coverage.keys()){if(this._config.isDone(a)){t.add(a.id);continue}this._addVisibleParent(t,i,a)||this._addVisibleChildren(t,a)||t.add(a.id)}const s=new K(0,0,0,0),r=new K(0,0,0,0);for(const a of i){s.id=a;for(const n of t)r.id=n,s.containsChild(r)&&t.delete(n)}return t}_addVisibleParent(t,i,s){let r=!1;for(const a of this._visible.values())new K(a).containsChild(s)&&(t.add(a),i.add(a),r=!0);return r}_addVisibleChildren(t,i){let s=!1;for(const r of this._visible.values()){const a=new K(r);i.containsChild(a)&&(t.add(r),s=!0)}return s}}const us=e=>{let t=class extends e{constructor(...i){super(...i),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([he(()=>{const i=this.layer;return[i&&"elevationInfo"in i?i.elevationInfo?.featureExpressionInfo:null,i&&"displayField"in i?i.displayField:null,i&&"timeInfo"in i&&i.timeInfo,i&&"renderer"in i&&i.renderer,i&&"labelingInfo"in i&&i.labelingInfo,i&&"floorInfo"in i&&i.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),Et),Ue(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),Ue(()=>{const i=this.layer;return i&&"sublayers"in i?i.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){if(!this.layer)return[];const{layer:i,layer:{fieldsIndex:s},requiredFields:r}=this;return"outFields"in i&&i.outFields?Be(s,[...Le(s,i.outFields),...r]):Be(s,r)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(i){this._override("featureEffect",i)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(i){x.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(i){throw new Error("missing implementation")}createQuery(){const i={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},s=this.filter!=null?this.filter.createQuery(i):new fe(i);if("floorInfo"in this.layer&&this.layer.floorInfo){const r=De(this);r!=null&&(s.where=s.where?`(${s.where}) AND (${r})`:r)}return this.timeExtent!=null&&(s.timeExtent=s.timeExtent!=null?s.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),s}createAggregateQuery(){const i={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new fe(i)}queryFeatures(i,s){throw new Error("missing implementation")}queryObjectIds(i,s){throw new Error("missing implementation")}queryFeatureCount(i,s){throw new Error("missing implementation")}queryExtent(i,s){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(i,s){return this._validateFetchPopupFeatures(i,s),this._fetchPopupFeatures(i,s)}_loadArcadeModules(i){return i.expressionInfos?.length||Array.isArray(i.content)&&i.content.some(s=>s.type==="expression")?Rt():Promise.resolve()}_handleRequiredFieldsChange(){const i=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",i),i.then(()=>{this._updatingRequiredFieldsPromise===i&&this._set("_updatingRequiredFieldsPromise",null)})}async _updateRequiredFields(){if(!this.layer||!this.view)return;const i=this.view.type==="3d",{layer:s,layer:{fieldsIndex:r,objectIdField:a}}=this,n="renderer"in s&&s.renderer,o="orderBy"in s&&s.orderBy,l="featureReduction"in s?s.featureReduction:null,u=new Set,d=await Promise.allSettled([n?n.collectRequiredFields(u,r):null,Je(u,s),i&&"elevationInfo"in s?Ot(u,s):null,this.filter!=null?je(u,s,this.filter):null,i||this.featureEffect==null?null:je(u,s,this.featureEffect.filter),!i&&l?Ct(u,s,l):null,!i&&o?zt(u,s,o):null]);if("timeInfo"in s&&s.timeInfo&&this.timeExtent&&ye(u,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"floorInfo"in s&&s.floorInfo&&ye(u,s.fieldsIndex,[s.floorInfo.floorField]),s.type==="feature"&&i&&s.infoFor3D!=null&&(s.globalIdField==null&&x.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),ye(u,s.fieldsIndex,[s.globalIdField])),s.type==="subtype-group"){Ie(u,r,s.subtypeField);const p=s.sublayers.map(y=>Promise.all([y.renderer?.collectRequiredFields(u,r),Je(u,y)]));await Promise.allSettled(p)}if(s.type==="catalog-footprint"&&s.parent){const p=s.parent;ye(u,r,[p.itemNameField,p.itemSourceField,p.itemTypeField,p.maxScaleField,p.minScaleField])}for(const p of d)p.status==="rejected"&&x.getLogger(this).error(p.reason);Ie(u,r,a),i&&"displayField"in s&&s.displayField&&Ie(u,r,s.displayField);const c=Array.from(u).sort();this._set("requiredFields",c)}_validateFetchPopupFeatures(i,s){if(s!=null)for(const r of i){const a=r.origin&&"layer"in r.origin?r.origin.layer:r.layer;if("popupEnabled"in a&&!a.popupEnabled)throw new O("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if(r.isAggregate){const n="featureReduction"in a?a.featureReduction:null;if(!(n&&"popupTemplate"in n&&n.popupEnabled&&n.popupTemplate))throw new O("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a})}else if("popupTemplate"in a&&!Ee(a,s))throw new O("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})}}_popupFeatureHasRequiredFields(i,s){return Tt(s,i)}async _fetchPopupFeatures(i,s){const r=new Array(i.length),a=new Map,n=await this._createPopupQuery(i.map(o=>o.origin?.layer??o.layer),s);for(let o=0;o<i.length;o++){const l=i[o];if(l.isAggregate){r[o]=l;continue}const u=l.origin?.layer??l.layer;if(!u||!("popupEnabled"in u))continue;const d=Le(this.layer.fieldsIndex,n.outFields),c=Ee(u,s);if(c==null)continue;const p=await this._loadArcadeModules(c);le(s),p&&p.arcadeUtils.hasGeometryOperations(c)||!this._popupFeatureHasRequiredFields(l,d)?a.set(l.getObjectId(),{graphic:l,index:o}):r[o]=l}if(this.layer.type==="stream"||this.layer.type==="parquet"||a.size===0)return r.filter(Boolean);n.objectIds=Array.from(a.keys());try{const o=await this.layer.queryFeatures(n,s);for(const l of o.features){const{graphic:{geometry:u,origin:d},index:c}=a.get(l.getObjectId());l.geometry||=u,l.origin=d,r[c]=l}}catch{}return r.filter(Boolean)}async _createPopupQuery(i,s){const r=this.layer.createQuery(),a=new Set;let n=!1;const o=i??[this.layer];for(const l of o){if(!("popupEnabled"in l))continue;const u=Ee(l,s);if(u==null)continue;const d=await this._loadArcadeModules(u);le(s);const c=d&&d.arcadeUtils.hasGeometryOperations(u);n=!(this.layer.geometryType!=="point"&&!c);const p=await Yt(this.layer,u);le(s);for(const y of p)a.add(y)}if(r.returnGeometry=n,r.returnZ=n,r.returnM=n,r.outFields=Array.from(a),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){const l=De(this);l!=null&&(r.where=r.where?`(${r.where}) AND (${l})`:l)}return r}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return h([f()],t.prototype,"_updatingRequiredFieldsPromise",void 0),h([f({readOnly:!0})],t.prototype,"availableFields",null),h([f({readOnly:!0})],t.prototype,"dataUpdating",void 0),h([f({type:xt})],t.prototype,"featureEffect",null),h([f({type:X})],t.prototype,"filter",void 0),h([f()],t.prototype,"layer",void 0),h([f({type:Number})],t.prototype,"maximumNumberOfFeatures",null),h([f({readOnly:!0,type:Boolean})],t.prototype,"maximumNumberOfFeaturesExceeded",null),h([f({readOnly:!0})],t.prototype,"requiredFields",void 0),h([f()],t.prototype,"suspended",void 0),h([f()],t.prototype,"view",void 0),t=h([L("esri.views.layers.FeatureLayerView")],t),t};function cs(e,t){const i=new Set;return e&&e.forEach(s=>i.add(s)),t&&t.forEach(s=>i.add(s)),i.has("*")?["*"]:Array.from(i)}const ot=4294967294;let w=class extends us(ei(Jt(jt))){constructor(){super(...arguments),this._commandsQueue=new $t({process:e=>{switch(e.type){case"edit-by-feature":case"edit-by-id":return this._doEdit(e);case"update":return this._doUpdate();case"highlight":return this._updateHighlights()}}}),this._visibilityOverrides=new Set,this._highlightCounter=new Xt,this._lastAvailableFields=[],this._lastTargetState=null,this.eventLog=new C,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._fields=null,this.featureEffectView=new ti}destroy(){this._workerProxy?.destroy(),this._workerAttached.reject(He()),this._commandsQueue.destroy()}initialize(){this._workerAttached=ue(),Y(this._workerAttached.promise),this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransition()}async _initProxy(){const e=this.layer;if("isTable"in e&&e.isTable)throw new O("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e});if(e.geometryType==="mesh")throw new O("featurelayerview:geometry-type-not-supported",`Geometry type of ${e.geometryType} is not supported`,{layer:e});if((e.type==="feature"||e.type==="subtype-group")&&qt(e)?.operations.supportsQuery===!1)throw new O("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});this._workerProxy&&this._workerProxy.destroy();const t=this._createClientOptions();this._workerProxy=await ui(t)}async _attachProxy(){const e={service:await this.layerAdapter.createServiceOptions(this.view),tileInfoJSON:this.view?.featuresTilingScheme?.tileInfo?.toJSON()};let t=[];Array.isArray(e.service.source)&&(t=e.service.source);try{await this._workerProxy.pipeline.onAttach(e,{transferList:t}),this._workerAttached.resolve()}catch(i){this._workerAttached.reject(He()),Qe(i)}}async _detachProxy(){return this._workerProxy.pipeline.onDetach()}async getWorker(){return await this._workerAttached.promise,this._workerProxy}get hasAllFeatures(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllFeatures}get hasAllFeaturesInView(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllFeaturesInView}get hasFullGeometries(){return this.layer.visible&&!this.suspended&&this.eventLog.hasFullGeometries}get labelingCollisionInfos(){const e=this.layerAdapter.getLabelingDeconflictionInfo(this.view),t=this.layer.geometryType,i=!this.suspended;return e.map(({vvEvaluators:s,deconflictionEnabled:r})=>({container:this.featureContainer,vvEvaluators:s,deconflictionEnabled:r,geometryType:t,visible:i}))}get layerAdapter(){switch(this.layer.type){case"feature":return this.layer.source.type==="memory"?new at(this.layer):new $i(this.layer);case"geojson":case"csv":case"wfs":return new at(this.layer);case"parquet":return new Xi(this.layer);case"subtype-group":return new rs(this.layer);case"ogc-feature":return new Ki(this.layer);case"stream":return new Yi(this.layer);case"oriented-imagery":return new Zi(this.layer);case"knowledge-graph-sublayer":return new Wi(this.layer);case"catalog-footprint":return new Hi(this.layer);default:Mt(this.layer)}return null}get timeExtent(){return Dt(this.layerAdapter.timeOptions,this.view?.timeExtent,this._get("timeExtent"))}getDisplayStatistics(e,t){return this.featureContainer?.getDisplayStatistics(e,t)}async queryHeatmapStatistics(e){return(await this.getWorker()).pipeline.queryHeatmapStatistics(e)}highlight(e,t="default"){let i;e instanceof ve?i=[e.getObjectId()]:typeof e=="number"||typeof e=="string"?i=[e]:At.isCollection(e)&&e.length>0?i=e.map(r=>r?.getObjectId()).toArray():Array.isArray(e)&&e.length>0&&(i=typeof e[0]=="number"||typeof e[0]=="string"?e:e.map(r=>r?.getObjectId()));const s=i?.filter(Pt);return s?.length?(this._addHighlights(s,t),$e(()=>this._removeHighlights(s,t))):$e()}getHighlightIds(){return Array.from(this._highlightCounter.ids())}hasHighlight(){return!this._highlightCounter.empty}async hitTest(e,t){const i=await this.featureContainer.hitTest(t);if(i.length===0)return null;const s=await this.getWorker(),{features:r,aggregates:a}=await s.pipeline.getDisplayFeatures(i),n=this.featureContainer.getSortKeys(i),o=({displayId:l},{displayId:u})=>n.has(l)&&n.has(u)?n.get(l)-n.get(u):l-u;return r.sort(o).reverse(),a.sort(o).reverse(),[...a.map(l=>this._createGraphicHit(e,Re.fromJSON(l))),...r.map(l=>this._createGraphicHit(e,ve.fromJSON(l)))]}async queryStatistics(){const e=await this.getWorker();return b(e.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})}async querySummaryStatistics(e,t,i){const s=await this.getWorker(),r={...t,scale:this.view.scale},a=s.features.executeQueryForSummaryStatistics(this._cleanUpQuery(e),r,i);return b(a,{})}async queryAggregateSummaryStatistics(e,t,i){const s={...t,scale:this.view.scale},r=(await this.getWorker()).aggregates.executeQueryForSummaryStatistics(this._cleanUpAggregateQuery(e),s,i);return b(r,{})}async queryUniqueValues(e,t,i){const s=await this.getWorker(),r={...t,scale:this.view.scale},a=s.features.executeQueryForUniqueValues(this._cleanUpQuery(e),r,i);return b(a,{uniqueValueInfos:[]})}async queryAggregateUniqueValues(e,t,i){const s=await this.getWorker(),r={...t,scale:this.view.scale},a=s.aggregates.executeQueryForUniqueValues(this._cleanUpAggregateQuery(e),r,i);return b(a,{uniqueValueInfos:[]})}async queryClassBreaks(e,t,i){const s=await this.getWorker(),r={...t,scale:this.view.scale},a=s.features.executeQueryForClassBreaks(this._cleanUpQuery(e),r,i);return b(a,{classBreakInfos:[]})}async queryAggregateClassBreaks(e,t,i){const s=await this.getWorker(),r={...t,scale:this.view.scale},a=s.aggregates.executeQueryForClassBreaks(this._cleanUpAggregateQuery(e),r,i);return b(a,{classBreakInfos:[]})}async queryHistogram(e,t,i){const s=await this.getWorker(),r={...t,scale:this.view.scale},a=s.features.executeQueryForHistogram(this._cleanUpQuery(e),r,i);return b(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}async queryAggregateHistogram(e,t,i){const s=await this.getWorker(),r={...t,scale:this.view.scale},a=s.aggregates.executeQueryForHistogram(this._cleanUpAggregateQuery(e),r,i);return b(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then(i=>{const s=_e.fromJSON(i);return s.features.forEach(r=>this._setLayersForFeature(r)),s})}async queryVisibleFeatures(e,t){const i=(await this.getWorker()).pipeline.queryVisibleFeatures(this._cleanUpQuery(e),t),s=await b(i,{features:[]}),r=_e.fromJSON(s);return r.features.forEach(a=>this._setLayersForFeature(a)),r}async queryAggregates(e,t){const i=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t),s=await b(i,{features:[]}),r=ii.fromJSON(s);return r.features.forEach(a=>this._setLayersForFeature(a)),r}async queryAggregateIds(e,t){const i=(await this.getWorker()).aggregates.executeQueryForIds(this._cleanUpAggregateQuery(e),t);return b(i,[])}async queryAggregateCount(e,t){const i=(await this.getWorker()).aggregates.executeQueryForCount(this._cleanUpAggregateQuery(e),t);return b(i,0)}async queryAggregateJSON(e,t){const i=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t);return b(i,{features:[]})}async queryFeaturesJSON(e,t){const i=(await this.getWorker()).features.executeQuery(this._cleanUpQuery(e),t);return b(i,{features:[]})}async queryObjectIds(e,t){const i=(await this.getWorker()).features.executeQueryForIds(this._cleanUpQuery(e),t);return b(i,[])}async queryFeatureCount(e,t){const i=(await this.getWorker()).features.executeQueryForCount(this._cleanUpQuery(e),t);return b(i,0)}async queryExtent(e,t){const i=(await this.getWorker()).features.executeQueryForExtent(this._cleanUpQuery(e),t),s=await b(i,{count:0,extent:null});return{count:s.count,extent:kt.fromJSON(s.extent)}}async getSampleFeatures(e){return(await this.getWorker()).pipeline.getSampleFeatures(e)}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._subscriptionManager)return;this.view.animation&&!this._lastTargetState&&(this._lastTargetState=e.state.clone()),!this.view.animation&&this._lastTargetState&&(this._lastTargetState=null);const t=this._subscriptionManager.update(e.targetState,this._lastTargetState);this.featureContainer.setVisibleTiles(t)}attach(){g("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.attach"),Y(this._updatingHandles.addPromise(this._workerAttached.promise)),Y(this._attachProxy()),this.featureContainer=new oi(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._subscriptionManager=new ls({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:e=>{this.featureContainer.updateSubscriptions(e),Y(this._updatingHandles.addPromise(this.getWorker().then(t=>t.pipeline.updateSubscriptions(e))))},isDone:e=>this.featureContainer.isDone(e)}),this.requestUpdate(),this.addAttachHandles([he(()=>JSON.stringify({displayRefreshVersion:this._displayRefreshVersion,timeExtent:this.timeExtent,clips:this.clips,filter:this.filter,featureEffect:this.featureEffect,sourceRefreshVersion:this._sourceRefreshVersion,timeZone:this.view.timeZone,effect:this.featureEffect,...this.layerAdapter.getUpdateHashProperties(this.view)}),()=>this._update(),Nt),he(()=>this.updateSuspended,e=>{e||(this._subscriptionManager.resume(),this.view.labelManager.requestUpdate())}),he(()=>this.visible,e=>{this.view.labelManager.requestUpdate()})]),this.layer.type!=="stream"&&this.layer.type!=="parquet"&&this.layer.type!=="catalog-footprint"&&this.addAttachHandles(this.layer.on("edits",e=>this._edit(e)))}detach(){g("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.detach"),this._detachProxy(),this._fields=null,this.featureContainer.destroy(),this.featureContainer=null,this._commandsQueue.clear(),this.container.removeAllChildren(),this._subscriptionManager=Ut(this._subscriptionManager),this._workerProxy.pipeline.onDetach(),this._workerAttached=ue(),Y(this._workerAttached.promise),this._lastAvailableFields=[],this._lastSchema=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const e="renderer"in this.layer&&this.layer.renderer!=null,t=this._commandsQueue.updateTracking.updating,i=this._updatingRequiredFieldsPromise!=null,s=this.featureContainer.updatingHandles.updating,r=this.updateRequested||e&&(t||i)||s||this._pipelineUpdating||this.dataUpdating;if(g("esri-2d-log-updating")){console.log(`Updating FLV2D (${this.layer.id}): ${r}
  -> updateRequested ${this.updateRequested}
  -> hasRenderer ${e}
  -> updatingRequiredFields ${i}
  -> hasPendingCommand ${t}
  -> dataUpdating ${this.dataUpdating}
  -> processing ${this._pipelineUpdating}
  -> updatingContainer ${s}
`);for(const a of this.featureContainer.subscriptions())console.log(`    -> Tile[${a.id}] Done: ${a.done}`)}return r}_createClientOptions(){const e=this;return{get container(){return e.featureContainer},setUpdating:t=>{this._set("_pipelineUpdating",t.pipeline),this._set("dataUpdating",t.data)},emitEvent:t=>{this.emit(t.name,t.event)},get eventLog(){return e.eventLog},fetch:t=>Promise.all(t.map(i=>e.view.stage.painter.textureManager.rasterizeItem(i))),fetchDictionary:t=>Promise.all(t.map(i=>this._fetchDictionaryRequest(i)))}}async _fetchDictionaryRequest(e){try{if(this.layer.type==="subtype-group")throw new Error("InternalError: SubtypeGroupLayer does not support dictionary renderer");const t=this.layer.renderer;if(!t||t.type!=="dictionary")throw new Error("InternalError: Expected layer to have a DictionaryRenderer");const i=this._lastSchema.processor.mesh.factory.symbology;if(i.type!=="dictionary")throw new Error("InternalError: Expected schema to be of type 'dictionary'");const s={cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,store:this.featureContainer.instanceStore,scaleExpression:i.scaleExpression};this._fields||(this._fields=this.layer.fields.map(n=>n.toJSON()));const r=i.visualVariableUniforms,a=await t.getSymbolAsync(e.feature,{fields:this._fields});return!a||!a.data?{type:"dictionary-response",meshes:[]}:{type:"dictionary-response",meshes:await ee(a.data,{uniforms:r,path:"renderer",schemaOptions:s})}}catch{return{type:"dictionary-response",meshes:[]}}}_cleanUpQuery(e){const t=fe.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t.toJSON()}_cleanUpAggregateQuery(e){const t=fe.from(e)||this.createAggregateQuery();t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference);const i=t.objectIds??[];for(const s of t.aggregateIds??[])i.push(s);return t.objectIds=i,t.aggregateIds=[],t.toJSON()}async _update(){return this._commandsQueue.push({type:"update"})}async _edit(e){if(this.updateSuspended)return void this._subscriptionManager.suspend();const t=this._getEffectiveEdit(e);return t?this._commandsQueue.push(t).catch(Qe):void 0}async doRefresh(e){this.attached&&(this.updateSuspended&&e||(e?this.incrementSourceRefreshVersion():this.incrementDisplayRefreshVersion()))}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%ot+1}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%ot+1}_getEffectiveEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,i=e.deletedFeatures.some(o=>o.objectId===-1||!o.objectId),s=t&&this.availableFields.includes(t);if(i&&!s)return x.getLogger(this).error(new O("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null;const r=this.layer,a=e.historicMoment?.getTime()??null,n="layerId"in r&&e.editedFeatures?.find(o=>o.layerId===r.layerId);if(n&&this._canEditByFeature(n)){const o=Bt(this.layer.geometryType),{adds:l,deletes:u,updates:d}=n.editedFeatures,c=this.layer.objectIdField,p=l.map(m=>Ge(m,o,!1,!1)),y=d.map(m=>Ge(m.current,o,!1,!1));return{type:"edit-by-feature",added:p,removed:u.map(m=>"attributes"in m?{globalId:t?m.attributes[t]:null,objectId:c?m.attributes[c]:null}:m),updated:y,historicMoment:a}}return{type:"edit-by-id",added:e.addedFeatures,updated:e.updatedFeatures,removed:e.deletedFeatures,historicMoment:a}}_canEditByFeature(e){const{adds:t,updates:i}=e.editedFeatures;return t.every(s=>this.view.spatialReference.equals(s.geometry?.spatialReference))&&i.every(s=>this.view.spatialReference.equals(s.current.geometry?.spatialReference))}async _doUpdate(){"featureReduction"in this.layer&&this.layer.featureReduction&&this.layer.featureReduction!==this._lastFeatureReduction&&(this.layer.featureReduction=this.layer.featureReduction?.clone(),this._lastFeatureReduction=this.layer.featureReduction);try{if(await this._updateRequiredFields(),this.destroyed||!this.layerAdapter?.hasRequiredSupport||!this._subscriptionManager)return;const e=this.featureContainer.instanceStore;this.featureContainer.attributeView.lockTextureUploads(),e.updateStart();const t=this.featureEffect,i={store:e,cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},s=this._createViewSchemaConfig(),r={source:this.layerAdapter.createSourceSchema(s,this._sourceRefreshVersion),processor:await this.layerAdapter.createProcessorSchema(i,s,this._displayRefreshVersion)},a=We(this._lastSchema?.source.mutable,r.source.mutable)||We(this._lastSchema?.processor,r.processor);if(!a)return this.featureContainer.requestRender(),this.featureContainer.attributeView.unlockTextureUploads(),e.updateEnd(),void(this.featureEffectView.featureEffect=t);this._lastSchema=r,this._fields=null;const n=Math.round(performance.now());g("esri-2d-update-debug")&&console.debug(`Id[${this.layer.uid}] Version[${n}] FeatureLayerView2D._doUpdate`,{changes:a}),await(await this.getWorker()).pipeline.updateSchema(r,n),e.updateEnd(),this.featureEffectView.featureEffect=t,this.featureEffectView.endTransition(),this.featureContainer.restartAllAnimations(),this.featureContainer.attributeView.unlockTextureUploads(),this.featureContainer.swapRenderState(),this.featureContainer.requestRender(),g("esri-2d-update-debug")&&console.debug(`Version[${n}] FeatureLayerView2D.updateEnd`),this.requestUpdate()}catch(e){g("esri-2d-update-debug")&&console.error("Encountered an error during update",e)}}async _doEdit(e){const t=await this.getWorker();try{this.featureContainer.editStart(),await t.pipeline.onEdits(e),this.featureContainer.editEnd()}catch(i){Ke(i)}}get hasFilter(){const e=this.layerAdapter.hasFilters?.(this.view)??!1;return this.filter!=null||this.timeExtent!=null||this._visibilityOverrides.size>0||e}_getEffectiveAvailableFields(e){const t=cs(this._lastAvailableFields,e);return this._lastAvailableFields=t,Lt(this.layer.fieldsIndex,t)}_createViewSchemaConfig(){const e=[ds(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter),this.featureEffect?.filter?.toJSON()??null];return{availableFields:this._getEffectiveAvailableFields(this.availableFields),filters:e,scale:this.view.scale,timeZone:this.view.timeZone}}_addHighlights(e,t){this._highlightCounter.addGroup(e,t),this._commandsQueue.push({type:"highlight"})}_removeHighlights(e,t){this._highlightCounter.deleteGroup(e,t),this._commandsQueue.push({type:"highlight"})}async _updateHighlights(){const e=[];for(const s of this._highlightCounter.ids()){const r=this._highlightCounter.getHighlightGroups(s),a=this._getHighlightBits(r);e.push({objectId:s,highlightFlags:a})}const t=await this.getWorker();if(this.destroyed)return;const i=t.pipeline.updateHighlight({highlights:e}).catch(s=>{Ke(s)||x.getLogger(this).error(s)});this._updatingHandles.addPromise(i)}_setLayersForFeature(e){e.layer=e.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin&&this.layerAdapter.setGraphicOrigin(e)}_createGraphicHit(e,t){return this._setLayersForFeature(t),t.geometry!=null&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};function ds(e,t,i,s,r){r&&(r=r.clone());const a=r!=null?r.timeExtent:null,n=i!=null&&a!=null?i.intersection(a):i||a;n&&(r??=new X,r.timeExtent=n),r=t.addFilters?.(r,e)??r;let o=r?.toJSON()??null;return s.size&&(o??=new X().toJSON(),o.hiddenIds=Array.from(s)),o}h([f()],w.prototype,"_commandsQueue",void 0),h([f()],w.prototype,"_sourceRefreshVersion",void 0),h([f()],w.prototype,"_displayRefreshVersion",void 0),h([f({readOnly:!0})],w.prototype,"_pipelineUpdating",void 0),h([f({readOnly:!0})],w.prototype,"hasAllFeatures",null),h([f({readOnly:!0})],w.prototype,"hasAllFeaturesInView",null),h([f({readOnly:!0})],w.prototype,"hasFullGeometries",null),h([f()],w.prototype,"featureEffectView",void 0),h([f()],w.prototype,"labelingCollisionInfos",null),h([f()],w.prototype,"layerAdapter",null),h([f({readOnly:!0})],w.prototype,"timeExtent",null),h([f()],w.prototype,"updating",void 0),w=h([L("esri.views.2d.layers.FeatureLayerView2D")],w);const lt=w,ps=Object.freeze(Object.defineProperty({__proto__:null,default:lt},Symbol.toStringTag,{value:"Module"}));export{ps as F,b as n,lt as r};
