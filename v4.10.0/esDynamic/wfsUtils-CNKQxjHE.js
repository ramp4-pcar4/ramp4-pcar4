import{U as g,dH as V,s as c,dI as j,dJ as C,dK as E,dL as h,aY as R,a5 as $,dM as Y,cl as W,bl as y,dN as X,dO as z,bn as q,da as _,de as T}from"./main-DCIX61zy.js";import{u as J}from"./geojson-C0tfEHKN.js";import{o as F,n as w}from"./xmlUtils-TLuV3CJ7.js";const S="xlink:href",m="2.0.0",x="__esri_wfs_id__",H="wfs-layer:getWFSLayerTypeInfo-error",K="wfs-layer:empty-service",k="wfs-layer:feature-type-not-found",Q="wfs-layer:geojson-not-supported",B="wfs-layer:kvp-encoding-not-supported",Z="wfs-layer:malformed-json",P="wfs-layer:unknown-geometry-type",ee="wfs-layer:unknown-field-type",te="wfs-layer:unsupported-spatial-reference",re="wfs-layer:unsupported-wfs-version";async function ne(r,t){const e=ae((await g(r,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetCapabilities",VERSION:m,...t?.customParameters},signal:t?.signal})).data);return ie(r,e),e}function ae(r){const t=U(r);he(t),D(t);const e=t.firstElementChild,n=V(ue(e));return{operations:oe(e),get featureTypes(){return Array.from(n())},readFeatureTypes:n}}const se=["json","application/json","geojson","application/json; subtype=geojson","application/geo+json"];function A(r){for(const t of se){const e=r.findIndex(n=>n.toLowerCase()===t);if(e>=0)return r[e]}return null}function oe(r){let t=!1;const e={GetCapabilities:{url:""},DescribeFeatureType:{url:""},GetFeature:{url:"",outputFormat:null,supportsPagination:!1}},n=[],s=[];if(F(r,{OperationsMetadata:{Parameter:a=>{if(a.getAttribute("name")==="outputFormat")return{AllowedValues:{Value:({textContent:o})=>{o&&n.push(o)}}}},Operation:a=>{switch(a.getAttribute("name")){case"GetCapabilities":return{DCP:{HTTP:{Get:o=>{e.GetCapabilities.url=o.getAttribute(S)}}}};case"DescribeFeatureType":return{DCP:{HTTP:{Get:o=>{e.DescribeFeatureType.url=o.getAttribute(S)}}}};case"GetFeature":return{DCP:{HTTP:{Get:o=>{e.GetFeature.url=o.getAttribute(S)}}},Parameter:o=>{if(o.getAttribute("name")==="outputFormat")return{AllowedValues:{Value:({textContent:i})=>{i&&s.push(i)}}}}}}},Constraint:a=>{switch(a.getAttribute("name")){case"KVPEncoding":return{DefaultValue:o=>{t=o.textContent.toLowerCase()==="true"}};case"ImplementsResultPaging":return{DefaultValue:o=>{e.GetFeature.supportsPagination=o.textContent.toLowerCase()==="true"}}}}}}),e.GetFeature.outputFormat=A(s)??A(n),!t)throw new c(B,"WFS service doesn't support key/value pair (KVP) encoding");if(e.GetFeature.outputFormat==null)throw new c(Q,"WFS service doesn't support GeoJSON output format");return e}function ie(r,t){j(r)&&(C(r,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=E(t.operations.DescribeFeatureType.url)),C(r,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=E(t.operations.GetFeature.url)))}function N(r){const t=parseInt(r.textContent?.match(/(?<wkid>\d+$)/i)?.groups?.wkid??"",10);if(!Number.isNaN(t))return t}function ue(r){return w(r,{FeatureTypeList:{FeatureType:t=>{const e={typeName:"undefined:undefined",name:"",title:"",description:"",extent:null,namespacePrefix:"",namespaceUri:"",defaultSpatialReference:4326,supportedSpatialReferences:[]},n=new Set;return F(t,{Name:s=>{const{name:a,prefix:o}=b(s.textContent);e.typeName=`${o}:${a}`,e.name=a,e.namespacePrefix=o,e.namespaceUri=s.lookupNamespaceURI(o)},Abstract:s=>{e.description=s.textContent},Title:s=>{e.title=s.textContent},WGS84BoundingBox:s=>{e.extent=q.fromJSON(pe(s))},DefaultCRS:s=>{const a=N(s);a&&(e.defaultSpatialReference=a,n.add(a))},OtherCRS:s=>{const a=N(s);a&&n.add(a)}}),e.title||(e.title=e.name),n.add(4326),e.supportedSpatialReferences.push(...n),e}}})}function pe(r){let t,e,n,s;for(const a of r.children)switch(a.localName){case"LowerCorner":[t,e]=a.textContent.split(" ").map(o=>Number.parseFloat(o));break;case"UpperCorner":[n,s]=a.textContent.split(" ").map(o=>Number.parseFloat(o))}return{xmin:t,ymin:e,xmax:n,ymax:s,spatialReference:_}}function v(r,t,e){return h(r,n=>e?n.name===t&&n.namespaceUri===e:n.typeName===t||n.name===t)}async function le(r,t,e,n={}){const{featureType:s,extent:a}=await ce(r,t,e,n),{spatialReference:o}=L(r.operations.GetFeature.url,s,n.spatialReference),{fields:i,geometryType:u,swapXY:p,objectIdField:l,geometryField:d}=await de(r,s,o,n);return{url:r.operations.GetCapabilities.url,name:s.name,namespaceUri:s.namespaceUri,fields:i,geometryField:d,geometryType:u,objectIdField:l,spatialReference:n.spatialReference??new R({wkid:s.defaultSpatialReference}),extent:a,swapXY:p,wfsCapabilities:r,customParameters:n.customParameters}}async function ce(r,t,e,n={}){const s=r.readFeatureTypes(),a=t?v(s,t,e):s.next().value,{spatialReference:o=new R({wkid:a?.defaultSpatialReference})}=n;if(a==null)throw t?new c(k,`The type '${t}' could not be found in the service`):new c(K,"The service is empty");let i=a.extent;if(i&&!$(i.spatialReference,o))try{await Y(i.spatialReference,o,void 0,n),i=W(i,o)}catch{throw new c(te,"Projection not supported")}return{extent:i,spatialReference:o,featureType:a}}async function de(r,t,e,n={}){const{typeName:s}=t,[a,o]=await Promise.allSettled([me(r.operations.DescribeFeatureType.url,s,n),ye(r,s,e,n)]),i=f=>new c(H,`An error occurred while getting info about the feature type '${s}'`,{error:f});if(a.status==="rejected")throw i(a.reason);if(o.status==="rejected")throw i(o.reason);const{fields:u,errors:p}=a.value??{},l=a.value?.geometryType||o.value?.geometryType,d=o.value?.swapXY??!1;if(l==null)throw new c(P,`The geometry type could not be determined for type '${s}`,{typeName:s,geometryType:l,fields:u,errors:p});return{...G(u??[]),geometryType:l,swapXY:d}}function G(r){const t=r.find(n=>n.type==="geometry");let e=r.find(n=>n.type==="oid");return r=r.filter(n=>n.type!=="geometry"),e||(e=new y({name:x,type:"oid",alias:x}),r.unshift(e)),{geometryField:t?.name??null,objectIdField:e.name,fields:r}}async function ye(r,t,e,n={}){let s,a=!1;const[o,i]=await Promise.all([I(r.operations.GetFeature.url,t,e,r.operations.GetFeature.outputFormat,{...n,count:1}),g(r.operations.GetFeature.url,{responseType:"text",query:M(t,e,void 0,{...n,count:1}),signal:n?.signal})]),u=o.type==="FeatureCollection"&&o.features[0]?.geometry;if(u){let p;switch(s=X.fromJSON(J(u.type)),u.type){case"Point":p=u.coordinates;break;case"LineString":case"MultiPoint":p=u.coordinates[0];break;case"MultiLineString":case"Polygon":p=u.coordinates[0][0];break;case"MultiPolygon":p=u.coordinates[0][0][0]}const l=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(i.data);if(l){const d=p[0].toFixed(3),f=p[1].toFixed(3),O=parseFloat(l[1]).toFixed(3);d===parseFloat(l[2]).toFixed(3)&&f===O&&(a=!0)}}return{geometryType:s,swapXY:a}}async function me(r,t,e){return fe(t,(await g(r,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:m,TYPENAME:t,TYPENAMES:t,...e?.customParameters},signal:e?.signal})).data)}function fe(r,t){const{name:e}=b(r),n=U(t);D(n);const s=h(w(n.firstElementChild,{element:a=>a}),a=>a.getAttribute("name")===e);if(s!=null){const a=s.getAttribute("type"),o=a?h(w(n.firstElementChild,{complexType:i=>i}),i=>i.getAttribute("name")===b(a).name):h(w(s,{complexType:i=>i}),()=>!0);if(o)return we(o)}throw new c(k,`Type '${r}' not found in document`,{document:new XMLSerializer().serializeToString(n)})}const ge=new Set(["objectid","fid"]);function we(r){const t=[],e=[];let n;const s=w(r,{complexContent:{extension:{sequence:{element:a=>a}}}});for(const a of s){const o=a.getAttribute("name");if(!o)continue;let i,u;if(a.hasAttribute("type")?i=b(a.getAttribute("type")).name:F(a,{simpleType:{restriction:d=>(i=b(d.getAttribute("base")).name,{maxLength:f=>{u=+f.getAttribute("value")}})}}),!i)continue;const p=a.getAttribute("nillable")==="true";let l=!1;switch(i.toLowerCase()){case"integer":case"nonpositiveinteger":case"negativeinteger":case"long":case"int":case"short":case"byte":case"nonnegativeinteger":case"unsignedlong":case"unsignedint":case"unsignedshort":case"unsignedbyte":case"positiveinteger":e.push(new y({name:o,alias:o,type:"integer",nullable:p,length:T("integer")}));break;case"float":case"double":case"decimal":e.push(new y({name:o,alias:o,type:"double",nullable:p,length:T("double")}));break;case"boolean":case"string":case"gyearmonth":case"gyear":case"gmonthday":case"gday":case"gmonth":case"anyuri":case"qname":case"notation":case"normalizedstring":case"token":case"language":case"idrefs":case"entities":case"nmtoken":case"nmtokens":case"name":case"ncname":case"id":case"idref":case"entity":case"duration":case"time":e.push(new y({name:o,alias:o,type:"string",nullable:p,length:u??T("string")}));break;case"datetime":case"date":e.push(new y({name:o,alias:o,type:"date",nullable:p,length:u??T("date")}));break;case"pointpropertytype":n="point",l=!0;break;case"multipointpropertytype":n="multipoint",l=!0;break;case"curvepropertytype":case"multicurvepropertytype":case"multilinestringpropertytype":n="polyline",l=!0;break;case"surfacepropertytype":case"multisurfacepropertytype":case"multipolygonpropertytype":n="polygon",l=!0;break;case"geometrypropertytype":case"multigeometrypropertytype":l=!0,t.push(new c(P,`geometry type '${i}' is not supported`,{type:new XMLSerializer().serializeToString(r)}));break;default:t.push(new c(ee,`Unknown field type '${i}'`,{type:new XMLSerializer().serializeToString(r)}))}l&&e.push(new y({name:o,alias:o,type:"geometry",nullable:p}))}for(const a of e)if(a.type==="integer"&&!a.nullable&&ge.has(a.name.toLowerCase())){a.type="oid";break}return{geometryType:n,fields:e,errors:t}}async function I(r,t,e,n,s){let{data:a}=await g(r,{responseType:"text",query:M(t,e,n,s),signal:s?.signal});a=a.replaceAll(/": +(-?\d+),(\d+)(,)?/g,'": $1.$2$3');try{return JSON.parse(a)}catch(o){throw new c(Z,"Error while parsing the\xA0response",{response:a,error:o})}}function M(r,t,e,n){const s=typeof t=="number"?t:t.wkid;return{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:m,TYPENAMES:r,OUTPUTFORMAT:e,SRSNAME:"EPSG:"+s,STARTINDEX:n?.startIndex,COUNT:n?.count,...n?.customParameters}}async function be(r,t,e){const n=await g(r,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:m,TYPENAMES:t,RESULTTYPE:"hits",...e?.customParameters},signal:e?.signal}),s=/numberMatched=["'](?<numberMatched>\d+)["']/gi.exec(n.data);if(s?.groups)return+s.groups.numberMatched}function U(r){return new DOMParser().parseFromString(r.trim(),"text/xml")}function b(r){const[t,e]=r.split(":");return{prefix:e?t:"",name:e??t}}function he(r){const t=r.firstElementChild?.getAttribute("version");if(t&&t!==m)throw new c(re,`Unsupported WFS version ${t}. Supported version: ${m}`)}function D(r){let t="",e="";if(F(r.firstElementChild,{Exception:n=>(t=n.getAttribute("exceptionCode"),{ExceptionText:s=>{e=s.textContent}})}),t)throw new c(`wfs-layer:${t}`,e)}function L(r,t,e){const n={wkid:t.defaultSpatialReference},s=e?.wkid!=null?{wkid:e.wkid}:n;return{spatialReference:s,getFeatureSpatialReference:z(r)||s.wkid&&t.supportedSpatialReferences.includes(s.wkid)?{wkid:s.wkid}:{wkid:t.defaultSpatialReference}}}export{I as K,x as S,le as W,v as Y,be as e,L as o,ne as v,G as z};
