{"version":3,"file":"layersLoader-BOdP4LjI.js","sources":["../../node_modules/@arcgis/core/portal/support/layersLoader.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.31/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{parse as t}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as r}from\"../../layers/support/fetchService.js\";import{LayerLoadContext as a}from\"../../layers/support/LayerLoadContext.js\";import{populateGroupLayer as o}from\"../../layers/support/layersCreator.js\";import{layerLookupMap as n}from\"../../layers/support/lazyLayerLoader.js\";import s from\"../Portal.js\";import{createForItemRead as i}from\"./jsonContext.js\";import{getFirstLayerOrTable as l,preprocessFSItemData as c,populateSceneServiceItemData as u,getNumLayersAndTables as p,createSublayerData as y,instanceTypeToLayerType as f,getSublayersByLayerType as m,layerTypeToLayerModuleType as d}from\"./loadUtils.js\";import{hasTypeKeyword as w}from\"./portalItemUtils.js\";import{loadStyleRenderer as h}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as I}from\"../../support/requestPresets.js\";async function g(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),b(e),e.validateItem&&e.validateItem(r),L(e,t)}function b(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function L(e,t){const r=e.instance,o=r.portalItem;if(!o)return;const{url:n,title:s}=o,l=i(o,\"portal-item\");if(\"group\"===r.type)return S(r,l,e);n&&\"media\"!==r.type&&r.read({url:n},l);const c=new a,u=await M(e,c,t);return u&&r.read(u,l),r.resourceReferences={portalItem:o,paths:l.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:s},l),h(r,l)}async function S(t,r,a){const o=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:s}=o;if(\"Group Layer\"===s){if(!w(o,\"Map\"))throw new e(\"portal:invalid-layer-item-typekeyword\",\"'Group Layer' item without 'Map' type keyword is not supported\");return T(t)}return t.read({title:n},r),v(t,a)}async function T(e){const t=e.portalItem,r=await t.fetchData(\"json\");if(!r)return;const a=i(t,\"web-map\");e.read(r,a),await o(e,r,{context:a}),e.resourceReferences={portalItem:t,paths:a.readResourcePaths??[]}}async function v(t,r){let o;const{portalItem:n}=t;if(!n)return;const s=n.type,i=r.layerModuleTypeMap;switch(s){case\"Feature Service\":case\"Feature Collection\":o=i.FeatureLayer;break;case\"Stream Service\":o=i.StreamLayer;break;case\"Scene Service\":o=i.SceneLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const y=new a;let[f,m]=await Promise.all([o(),M(r,y)]),d=()=>f;if(\"Feature Service\"===s){const e=l(m)?.customParameters;m=n.url?await c(m,n.url,y):{},d=await E(m,i)||d;const r=await k(n.url,{customParameters:e,loadContext:y});return await F(t,d,m,r)}return\"Scene Service\"===s&&n.url&&(m=await u(n,m,y)),p(m)>0?await F(t,d,m):await j(t,d)}async function j(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await I(r.url);a&&F(e,t,{layers:a.layers?.map(y),tables:a.tables?.map(y)})}async function F(e,t,r,a){let o=r.layers||[];const s=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type?(o.forEach(((e,t)=>{e.id=t,\"Table\"===e?.layerDefinition?.type&&s.push(e)})),o=o.filter((e=>\"Table\"!==e?.layerDefinition?.type))):(o.reverse(),s.reverse()),o.forEach((o=>{const n=a?.(o);if(n||!a){const a=P(e,t(o),r,o,n);e.add(a)}})),s.length){const t=await n.FeatureLayer();s.forEach((o=>{const n=a?.(o);if(n||!a){const a=P(e,t,r,o,n);e.tables.add(a)}}))}}function P(e,t,r,a,o){const n=e.portalItem,i={portalItem:n.clone(),layerId:a.id};null!=a.url&&(i.url=a.url);const l=new t(i);if(\"sourceJSON\"in l&&(l.sourceJSON=o),\"subtype-group\"!==l.type&&\"catalog\"!==l.type&&(l.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===n.type){const e={origin:\"portal-item\",portal:n.portal||s.getDefault()};l.read(a,e);const t=r.showLegend;null!=t&&l.read({showLegend:t},e)}return l}async function M(e,t,r){if(!1===e.supportsData)return;const a=e.instance,o=a.portalItem;if(!o)return;let n=null;try{n=await o.fetchData(\"json\",r)}catch(s){}if(D(a)){let e=null;const r=await x(o,n,t);if((n?.layers||n?.tables)&&r>0){if(null==a.layerId){const e=f(a.type),t=e?m(n,e)[0]:l(n);t&&(a.layerId=t.id)}e=C(n,a),\"OrientedImageryLayer\"===e?.layerType&&\"oriented-imagery\"===a.type&&a.supportedSourceTypes.add(\"Feature Layer\"),e&&null!=n.showLegend&&(e.showLegend=n.showLegend)}return r>1&&\"sublayerTitleMode\"in a&&\"service-name\"!==a.sublayerTitleMode&&(a.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function x(e,r,a){if(r?.layers&&r?.tables)return p(r);const o=t(e.url);if(!o)return 1;const n=await a.fetchServiceMetadata(o.url.path,{customParameters:l(r)?.customParameters}).catch((()=>null));return(r?.layers?.length??n?.layers?.length??0)+(r?.tables?.length??n?.tables?.length??0)}function C(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&G(a,t)?a:null}function D(e){return\"stream\"!==e.type&&\"layerId\"in e}function G(e,t){const r=\"layerType\"in e&&e.layerType,{type:a}=t;return!(\"feature\"===a&&r&&\"ArcGISFeatureLayer\"!==e.layerType||\"catalog\"===a&&!r||\"oriented-imagery\"===a&&!r||\"subtype-group\"===a&&!r)}async function k(e,t){const{layersJSON:a}=await r(e,t);if(!a)return null;const o=[...a.layers,...a.tables];return e=>o.find((t=>t.id===e.id))}async function E(e,t){const{layers:r}=e;if(!r?.length)return;const a=new Set,o=[];for(const{layerType:i}of r){const e=i??\"ArcGISFeatureLayer\";if(a.has(e))continue;a.add(e);const r=t[d(e)];o.push(r())}const n=await Promise.all(o),s=new Map;return Array.from(a).forEach(((e,t)=>{s.set(e,n[t])})),({layerType:e})=>{const t=e??\"ArcGISFeatureLayer\";return s.get(t)}}export{g as load};\n"],"names":["g","e","t","b","L","r","o","n","l","i","S","c","a","u","M","h","s","w","T","v","y","f","m","d","E","k","F","p","j","I","P","D","x","C","G"],"mappings":"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","x_google_ignoreList":[0]}