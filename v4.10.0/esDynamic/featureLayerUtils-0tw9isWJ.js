import{L as S,c as w,h as N,d as O,l as R,a as d,i as x,u as f,f as c}from"./main-DCIX61zy.js";import{P as D,$ as J}from"./utils-2iHN6TbU.js";import{t as M,a as Y,i as _}from"./fetchService-DhIYtzwD.js";const m="Feature Service",p="feature-layer-utils",$=`${p}-save`,g=`${p}-save-as`;function I(e){return{isValid:S(e)&&(!("dynamicDataSource"in e)||!e.dynamicDataSource),errorMessage:"Feature layer should be a layer or table in a map or feature service"}}function E(e){const a=[],r=[];for(const{layer:t,layerJSON:o}of e)t.isTable?r.push(o):a.push(o);return{layers:a,tables:r}}function T(e){return E([e])}async function F(e,a){return/\/\d+\/?$/.test(e.url)?T(a[0]):G(a,e)}async function G(e,a){if(e.reverse(),!a)return E(e);const r=await K(a,e);for(const t of e)v(t.layer,t.layerJSON,r);return U(r,e),r}async function K(e,a){let r=await e.fetchData("json");if(j(r))return r;r||={},B(r);const{layer:{url:t,customParameters:o,apiKey:n}}=a[0];return await V(r,{url:t??"",customParameters:o,apiKey:n},a.map(s=>s.layer.layerId)),r}function j(e){return!!(e&&Array.isArray(e.layers)&&Array.isArray(e.tables))}function B(e){e.layers||=[],e.tables||=[]}function U(e,a){const r=[],t=[];for(const{layer:o}of a){const{isTable:n,layerId:s}=o;n?t.push(s):r.push(s)}h(e.layers,r),h(e.tables,t)}function h(e,a){if(e.length<2)return;const r=[];for(const{id:t}of e)r.push(t);w(r.sort(A),a.slice().sort(A))&&e.sort((t,o)=>{const n=a.indexOf(t.id),s=a.indexOf(o.id);return n<s?-1:n>s?1:0})}function A(e,a){return e<a?-1:e>a?1:0}async function V(e,a,r){const{url:t,customParameters:o,apiKey:n}=a,{serviceJSON:s,layersJSON:i}=await M(t,{customParameters:o,apiKey:n}),l=b(e.layers,s.layers,r),u=b(e.tables,s.tables,r);e.layers=l.itemResources,e.tables=u.itemResources;const y=[...l.added,...u.added],P=i?[...i.layers,...i.tables]:[];await k(e,y,t,P)}function b(e,a,r){const t=N(e,a,(n,s)=>n.id===s.id);e=e.filter(n=>!t.removed.some(s=>s.id===n.id));const o=t.added;return o.forEach(({id:n})=>{e.push({id:n})}),{itemResources:e,added:o.filter(({id:n})=>!r.includes(n))}}async function k(e,a,r,t){const o=await q(a),n=a.map(({id:s,type:i})=>new(o.get(i))({url:r,layerId:s,sourceJSON:t.find(({id:l})=>l===s)}));await Promise.allSettled(n.map(s=>s.load())),n.forEach(s=>{const{layerId:i,loaded:l,defaultPopupTemplate:u}=s;if(!l||u==null)return;const y={id:i,popupInfo:u.toJSON()};s.operationalLayerType!=="ArcGISFeatureLayer"&&(y.layerType=s.operationalLayerType),v(s,y,e)})}async function q(e){const a=[];e.forEach(({type:o})=>{const n=_(o),s=Y[n];a.push(s())});const r=await Promise.all(a),t=new Map;return e.forEach(({type:o},n)=>{t.set(o,r[n])}),t}function v(e,a,r){e.isTable?L(r.tables,a):L(r.layers,a)}function L(e,a){const r=e.findIndex(({id:t})=>t===a.id);r===-1?e.push(a):e[r]=a}function z(e,a){const r=e.layers.some(t=>t.layerType==="OrientedImageryLayer");f(a,c.ORIENTED_IMAGERY_LAYER,r)}function C(e,a){const r=e.some(t=>t.type==="oriented-imagery");f(a,c.ORIENTED_IMAGERY_LAYER,r)}async function X(e,a,r){z(r,a)}async function Z(e,a){const{url:r,layerId:t,title:o,fullExtent:n,isTable:s}=e,i=O(r);a.url=(i?.serverType==="FeatureServer"?r:`${r}/${t}`)??null,a.title||=o,a.extent=null,s||n==null||(a.extent=await R(n)),d(a,c.METADATA),d(a,c.MULTI_LAYER),x(a,c.SINGLE_LAYER),f(a,c.TABLE,s),C([e],a)}async function H(e,a){return D({layer:e,itemType:m,validateLayer:I,createItemData:(r,t)=>F(t,[r]),errorNamePrefix:$,setItemProperties:X},a)}async function Q(e,a,r){return J({layer:e,itemType:m,validateLayer:I,createItemData:(t,o)=>Promise.resolve(T(t)),errorNamePrefix:g,newItem:a,setItemProperties:Z},r)}export{H as save,Q as saveAs};
