import{ds as ee,b as R,f8 as h,b_ as M,f9 as te,i as ne,c_ as re,bK as ie,r as F,bb as ae,bM as U,al as oe}from"./main-pOgmbpmS.js";import{s as le,l as T,c as w}from"./messages-DIIGODWw.js";import{x as j,U as se}from"./utils-dFbb1tu-.js";import{h as ue}from"./timeZoneUtils-D0kcW4pX.js";const fe="esri.widgets.Feature.support.featureUtils",N=()=>ne.getLogger(fe),de=/href=(""|'')/gi,ce=/(\{([^{\r\n]+)\})/g,pe=/'/g,S=/^\s*expression\//i,ye=/(\n)/gi,me=/[\u00A0-\u9999<>&]/gim,be=/href\s*=\s*(?:"([^"]+)"|'([^']+)')/gi,Ie=/^(?:mailto:|tel:)/,$="relationships/",D=ee("short-date-short-time");function ge(e){if(e!=null)return(e.sourceLayer||e.layer)??void 0}async function he({type:e,value:t,event:n}){try{return typeof t=="function"?t(n):await t}catch(r){return void N().error("error",`An error occurred when calling the "${e}" function`,{error:r,graphic:n.graphic,value:t})}}function Fe(e=""){if(e)return!Ie.test(e.trim().toLowerCase())}function L(e){return!!e&&S.test(e)}function Te(e,t){if(!t||!L(t)||!e)return;const n=t.replace(S,"").toLowerCase();return e.find(({name:r})=>r.toLowerCase()===n)}function C({fieldInfo:e,graphic:t}){return!(!e?.fieldName||L(e.fieldName)||b(e.fieldName)||t?.isAggregate||t?.popupTemplate)}function we({expressionInfos:e,fieldInfo:t,graphic:n,isContentFieldInfos:r,layer:a}){if(!t?.fieldName)return null;const i=Te(e,t.fieldName);if(i)return i.title||null;if(h(a)&&C({fieldInfo:t,graphic:n})){const o=a.getFieldAlias(t.fieldName);return r?t.label||o||t.fieldName:o||t.fieldName}return t.label||t.fieldName}function z({fieldInfo:e,isContentFieldInfos:t,layer:n}){if(!e?.fieldName)return null;if(h(n)){const r=n.popupTemplate||n.fieldConfigurations?n.getFieldConfiguration(e.fieldName)?.fieldFormat:te(e,n.getField(e.fieldName));return t&&e.fieldFormat||r}return null}function Ne(e,t){return`{${t.get(e.toLowerCase())?.fieldName||e}}`}function Le(e){return e.replaceAll(de,"")}function x(e,t){const n=A(t,e);return n?n.name:e}function Ce(e,t){return e&&e.map(n=>x(n,t))}function A(e,t){return e&&typeof e.getField=="function"&&t?e.getField(t)??null:null}function O(e){return`${e}`.trim()}function xe({attributes:e,globalAttributes:t,layer:n,text:r,expressionAttributes:a,fieldInfoMap:i}){return r?G({formattedAttributes:t,template:Ze(r,{...t,...a,...e},n),fieldInfoMap:i}):""}function G({formattedAttributes:e,template:t,fieldInfoMap:n}){return O(Le(F(F(t,r=>Ne(r,n)),e)))}function Ae(e,t,n=!1){const r=t[e];if(typeof r=="string"){const a=(n?encodeURIComponent(r):r).replaceAll(pe,"%27");t[e]=a}}function qe(e,t=!1){const n={...e};return Object.keys(n).forEach(r=>Ae(r,n,t)),n}function ve(e,t,n){const r=(t=O(t))&&!t.startsWith("{");return F(e,qe(n,r||!1))}function Q(e,t){return e.replaceAll(ce,(n,r,a)=>{const i=A(t,a);return i?`{${i.name}}`:r})}function Ze(e,t,n){const r=Q(e,n);return r&&r.replaceAll(be,(a,i,o)=>ve(a,i||o,t))}function ke(e,t){const n=t?.fieldFormat?.type==="number"||t?.format&&t.format.dateFormat==null&&(t.format.places!=null||t.format.digitSeparator!=null);if(typeof e=="string"&&n){const r=Number(e);if(!isNaN(r))return r}return e}function _(e){return e!=null&&typeof e=="object"&&"fieldsIndex"in e&&"geometryType"in e&&"getField"in e&&"load"in e&&"loaded"in e&&"objectIdField"in e&&"spatialReference"in e&&"type"in e&&(e.type==="feature"||e.type==="scene"||e.type==="subtype-group"||e.type==="subtype-sublayer"||e.type==="sublayer")&&"when"in e}function H(e){return e!=null&&typeof e=="object"&&"createQuery"in e&&"queryFeatureCount"in e&&"queryObjectIds"in e&&"queryRelatedFeatures"in e&&"queryRelatedFeaturesCount"in e&&"relationships"in e}function q(e){return _(e)&&H(e)}function Ee(e){return!(!(e&&typeof e=="object"&&"createQuery"in e&&"getField"in e&&"queryFeatureCount"in e&&"queryFeatures"in e&&"queryObjectIds"in e&&"capabilities"in e&&"fields"in e&&"fieldsIndex"in e&&"type"in e)||e.type!=="feature"&&e.type!=="subtype-group"&&e.type!=="subtype-sublayer"&&e.type!=="sublayer"||!("when"in e))&&(e.type==="subtype-sublayer"&&"parent"in e&&e.parent&&typeof e.parent=="object"?"globalIdField"in e.parent:"globalIdField"in e)}function Re(e){return!!e&&typeof e=="object"&&"sourceLayer"in e&&q(e.sourceLayer)}function P(e,t){const{fieldInfos:n,fieldName:r,graphic:a,isContentFieldInfos:i,layer:o,preventPlacesFormatting:u,timeZone:s}=t,l=K(n,r),c=A(o,r),f=h(o)&&C({fieldInfo:l,graphic:a}),d=f?null:l?.format,p=f?z({fieldInfo:l,layer:o,isContentFieldInfos:i}):null,I=p?.type==="number";if(l&&!M(r)){const m=c?.type,g=p?.type==="date-time",E=d?.dateFormat;if(m==="date"||m==="date-only"||m==="time-only"||m==="timestamp-offset"||g||E)return j(e,{format:g?void 0:E,fieldFormat:g?p:void 0,fieldType:m,timeZoneOptions:{layerTimeZone:o&&"preferredTimeZone"in o?o.preferredTimeZone:null,viewTimeZone:s,datesInUnknownTimezone:!(!o||!("datesInUnknownTimezone"in o))&&!!o.datesInUnknownTimezone}})}if(typeof e=="string"&&M(r)&&d)return Me(e,d);if(typeof(e=ke(e,{format:I?void 0:d,fieldFormat:I?p:void 0}))=="string"||e==null||d==null&&p==null)return Z(e);const k=I?le(p):d?T(d):void 0;return w(e,u?{...k,minimumFractionDigits:0,maximumFractionDigits:20}:k)}function Me(e,t){return e=e.trim(),/\d{2}-\d{2}/.test(e)?e:e.includes(",")?v(e,",",", ",t):e.includes(";")?v(e,";","; ",t):e.includes(" ")?v(e," "," ",t):w(Number(e),T(t))}function v(e,t,n,r){return e.trim().split(t).map(a=>w(Number(a),T(r))).join(n)}function K(e,t){if(e?.length&&t)return e.find(n=>n.fieldName?.toLowerCase()===t.toLowerCase())}function Ue({fieldName:e,graphic:t,layer:n}){if(b(e)||!n||typeof n.getFeatureType!="function")return null;const{typeIdField:r}=n;if(!r||e!==r)return null;const a=n.getFeatureType(t);return a?a.name:null}function je({fieldName:e,value:t,graphic:n,layer:r}){if(b(e)||!r||typeof r.getFieldDomain!="function")return null;const a=n&&r.getFieldDomain(e,{feature:n,excludeImpliedDomains:oe("esri-widget-legacy-field-domain-calculation")});return a&&a.type==="coded-value"?a.getName(t):null}function Se(e,t,n,r){const{creatorField:a,creationDateField:i,editorField:o,editDateField:u}=e;if(!t)return;const s=ue(r&&"preferredTimeZone"in r?r.preferredTimeZone:null,!(!r||!("datesInUnknownTimezone"in r))&&!!r.datesInUnknownTimezone,n,D,"date"),l={...D,...s},c=t[u];if(typeof c=="number"){const d=t[o];return{type:"edit",date:R(c,l),user:d}}const f=t[i];if(typeof f=="number"){const d=t[a];return{type:"create",date:R(f,l),user:d}}return null}function $e(e,t){const n=new Map;if(!e)return n;for(const r of e){if(!r.fieldName)continue;const a=x(r.fieldName,t);r.fieldName=a,n.set(a.toLowerCase(),r)}return n}function De(e){const t=[];if(!e)return t;const{fieldInfos:n,content:r}=e;return n&&t.push(...n),r&&Array.isArray(r)&&r.forEach(a=>{if(a.type==="fields"){const i=a?.fieldInfos;i&&t.push(...i)}}),t}function ze(e){return e.replaceAll(me,t=>`&#${t.charCodeAt(0)};`)}function Z(e){return typeof e=="string"?e.replaceAll(ye,'<br class="esri-text-new-line" />'):e}function V(e){const{fieldInfoMap:t,fieldInfos:n,fieldName:r,graphic:a,isContentFieldInfos:i,layer:o,timeZone:u,value:s}=e;if(s==null)return"";const l=je({fieldName:r,value:s,graphic:a,layer:o});if(l)return l;const c=Ue({fieldName:r,graphic:a,layer:o});if(c)return c;if(t.get(r.toLowerCase()))return P(s,{fieldInfos:n||Array.from(t.values()),fieldName:r,graphic:a,isContentFieldInfos:i,layer:o,timeZone:u});const f=o?.fieldsIndex?.get(r);return f&&(se(f)||ae(f))?j(s,{fieldType:f.type,timeZoneOptions:{layerTimeZone:o&&"preferredTimeZone"in o?o.preferredTimeZone:null,viewTimeZone:u,datesInUnknownTimezone:!(!o||!("datesInUnknownTimezone"in o))&&!!o.datesInUnknownTimezone}}):Z(s)}function Oe({attributes:e,fieldInfoMap:t,fieldInfos:n,graphic:r,isContentFieldInfos:a,layer:i,relatedInfos:o,timeZone:u}){const s={};return o?.forEach(l=>Pe({attributes:s,relatedInfo:l,fieldInfoMap:t,fieldInfos:n,layer:i,timeZone:u})),e&&Object.keys(e).forEach(l=>{const c=e[l];s[l]=V({fieldInfoMap:t,fieldInfos:n,fieldName:l,graphic:r,isContentFieldInfos:a,layer:i,timeZone:u,value:c})}),s}async function W(e,t){const{layer:n,graphic:r,outFields:a,objectIds:i,returnGeometry:o,spatialReference:u}=e,s=i[0];if(typeof s!="number"&&typeof s!="string"){const c="Could not query required fields for the specified feature. The feature's ID is invalid.",f={layer:n,graphic:r,objectId:s,requiredFields:a};return N().warn(c,f),null}if(!re(n)?.operations?.supportsQuery){const c="The specified layer cannot be queried. The following fields will not be available.",f={layer:n,graphic:r,requiredFields:a,returnGeometry:o};return N().warn(c,f),null}const l=n.createQuery();return l.objectIds=i,l.outFields=a?.length?a:[n.objectIdField],l.returnGeometry=!!o,l.returnZ=!!o,l.returnM=!!o,l.outSpatialReference=u,(await n.queryFeatures(l,t)).features[0]}async function Ge(e){if(!e.expressionInfos?.length)return!1;const t=await U(),{arcadeUtils:{hasGeometryFunctions:n}}=t;return n(e)}async function Qe(e){if(!e.expressionInfos?.length)return!1;const t=await U(),{arcadeUtils:{requiresTrack:n}}=t;return n(e)}async function _e({graphic:e,popupTemplate:t,layer:n,spatialReference:r},a){if(!n||!t||(typeof n.load=="function"&&await n.load(a),!e.attributes))return;const i=n.objectIdField,o=e.attributes[i];if(o==null)return;const u=[o],s=new Set(await t.getRequiredFields(n.fieldsIndex));n.timeInfo?.trackIdField==null||s.has(n.timeInfo.trackIdField)||await Qe(t)&&s.add(n.timeInfo.trackIdField);const l=ie(e,s),c=l?[]:s.has(i)?[...s]:[...s,i],f=t.returnGeometry||await Ge(t);if(l&&!f)return;const d=await W({layer:n,graphic:e,outFields:c,objectIds:u,returnGeometry:f,spatialReference:r},a);d&&(d.geometry&&(e.geometry=d.geometry),d.attributes&&(e.attributes={...e.attributes,...d.attributes}))}function b(e=""){return!!e&&e.includes($)}function He(e){return e?`${$}${e.layerId}/${e.fieldName}`:""}function B({attributes:e,graphic:t,relatedInfo:n,fieldInfos:r,fieldInfoMap:a,layer:i,timeZone:o}){e&&t&&n&&Object.keys(t.attributes).forEach(u=>{const s=He({layerId:n.relation.id.toString(),fieldName:u}),l=t.attributes[u];e[s]=V({fieldName:s,fieldInfos:r,fieldInfoMap:a,layer:i,value:l,graphic:t,timeZone:o})})}function Pe({attributes:e,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i}){e&&t&&(t.relatedFeatures?.forEach(o=>B({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i})),t.relatedStatsFeatures?.forEach(o=>B({attributes:e,graphic:o,relatedInfo:t,fieldInfoMap:n,fieldInfos:r,layer:a,timeZone:i})))}const J=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},X=({layer:e,method:t,query:n,definitionExpression:r})=>{if(!e.capabilities?.query?.supportsCacheHint||t==="attachments")return;const a=n.where!=null?n.where:null,i=n.geometry!=null?n.geometry:null;J(r)||J(a)||i?.type==="extent"||n.resultType==="tile"||(n.cacheHint=!0)},Ke=({query:e,layer:t,method:n})=>{X({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})},Ve=({queryPayload:e,layer:t,method:n})=>{X({layer:t,method:n,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression??""}`})};function We(e,t,n){return e&&t&&n?t.type==="sublayer"?y({layers:t.layer?.allSublayers,map:e,relatedLayer:t,relationship:n})||y({layers:t.layer?.subtables,map:e,relatedLayer:t,relationship:n}):y({layers:e.allLayers,map:e,relatedLayer:t,relationship:n})||y({layers:e.allTables,map:e,relatedLayer:t,relationship:n}):null}function Be(e,t){return e&&"utilityNetworks"in e&&t?e.utilityNetworks?.find(n=>n.isUtilityLayer(t)):null}function Y(e,t){return e?.allTables.find(n=>n.type==="feature"&&n.layerId===t.id&&n.url===t.layer?.url)}function y({map:e,relationship:t,relationship:{relatedTableId:n},relatedLayer:r,layers:a}){if(!a)return null;for(const i of a){if(i.type==="map-image"){const u=y({layers:i.sublayers,map:e,relatedLayer:r,relationship:t})||y({layers:i.subtables,map:e,relatedLayer:r,relationship:t});if(u)return u;continue}if(!q(i))continue;if(r.type==="sublayer"){if(i!==r&&i.id===n)return i.isTable?Y(e,i):i;continue}const o=r.type==="scene"&&r.associatedLayer?r.associatedLayer.url:r.url;if(!o)return null;if(i.type!=="sublayer"){if(i!==r&&i.url===o&&i.layerId===n)return i}else if(i!==r&&i.layer?.url===o&&i.id===n)return i.isTable?Y(e,i):i}return null}export{Z as applyTextFormattingHTML,$e as createFieldInfoMap,We as findRelatedLayer,Be as findUtilityNetwork,Q as fixTokens,Oe as formatAttributes,Se as formatEditInfo,P as formatValueToFieldInfo,De as getAllFieldInfos,z as getFieldFormat,K as getFieldInfo,we as getFieldInfoLabel,x as getFixedFieldName,Ce as getFixedFieldNames,ge as getSourceLayer,he as graphicCallback,ze as htmlEntities,Ee as isAssociatedFeatureSupportedLayer,L as isExpressionField,_ as isFeatureSupportedLayer,Re as isGraphicForRelatableFeatureSupportedLayer,q as isRelatableFeatureSupportedLayer,H as isRelatableLayer,b as isRelatedField,C as isSupportedContext,Ke as preLayerQueryCallback,Ve as preRequestCallback,W as querySourceLayer,_e as queryUpdatedFeature,Fe as shouldOpenInNewTab,G as substituteAttributes,xe as substituteFieldsInLinksAndAttributes};
