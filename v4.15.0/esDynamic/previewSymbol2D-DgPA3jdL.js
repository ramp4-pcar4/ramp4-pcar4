import{s as U,ca as b,bA as P,ei as $,fm as C}from"./main-pOgmbpmS.js";import{E}from"./colorUtils-CnWjIacC.js";import{c as W}from"./fontUtils-CiZXvzWI.js";import{U as G,k as J}from"./quantizationUtils-Gg7wbGX3.js";import{y as A}from"./densifyCurvedGeometry-CD88C7qb.js";import{u as F,y as j,g as K,f as Q}from"./utils-CInxUSqV.js";import{t as V,h as D}from"./previewUtils-DnhmEl-z.js";import{l as X}from"./symbolUtils-CvLuEhBs.js";const Z="picture-fill",Y="picture-marker",_="simple-fill",tt="simple-line",et="simple-marker",nt="text",ot="Aa",at=22,L=120,it=80,T=50,R=225,lt=document.createElement("canvas");function q(e,t,s){const{extent:o}=e;if(!o)return"";const u=o.width||1,r=o.height||1;if(e.type==="polygon"){const h=e.clone();$(h)&&(h.rings=A(h,{minSegmentsPerCurve:128}).rings),G({originPosition:"upperLeft",scale:[u/t,r/s],translate:[o.xmin,o.ymax]},h,h);let l="";for(let n=0;n<h.rings.length;n++){const p=h.rings[n];for(let c=0;c<p.length;c++){const f=p[c][0],a=p[c][1],i=c===0?"M":"l",M=c===p.length-1?" Z":"";l+=`${l!==""?" ":""}${i}${f.toString()} ${a.toString()}${M}`}}return l}if(e.type==="polyline"){const h=e.clone();$(h)&&(h.paths=A(h,{minSegmentsPerCurve:128}).paths),J({originPosition:"upperLeft",scale:[u/t,r/s],translate:[o.xmin,o.ymax]},h,h);let l="";for(let n=0;n<h.paths.length;n++){const p=h.paths[n];for(let c=0;c<p.length;c++){const f=p[c][0],a=p[c][1];l+=`${l!==""?" ":""}${c===0?"M":"l"}${f.toString()} ${a.toString()}`}}return l}return""}function N(e,t){const s=lt.getContext("2d"),o=[];t&&(t.weight&&o.push(t.weight),t.size&&o.push(t.size+"px"),t.family&&o.push(t.family)),s.font=o.join(" ");const{width:u,actualBoundingBoxLeft:r,actualBoundingBoxRight:h,actualBoundingBoxAscent:l,actualBoundingBoxDescent:n}=s.measureText(e);return{width:Math.ceil(Math.max(u,r+h)),height:Math.ceil(l+n),x:Math.floor(r),y:Math.floor((l-n)/2)}}function S(e){const t=e?.size;return{width:t!=null&&typeof t=="object"&&"width"in t?b(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?b(t.height):null}}async function st(e,t){const s=t.fill,o=e.color;if(s?.type==="pattern"&&o&&e.type!==Z){const u=await Q(s.src,o.toCss(!0));s.src=u,t.fill=s}}async function rt(e,t,s,o){if(!("font"in e)||!e.font||t.shape.type!=="text")return;try{await W(e.font)}catch{}const{width:u,height:r}=S(o);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:h,height:l,x:n,y:p}=N(t.shape.text,{weight:t.font?.weight,size:t.font?.size,family:t.font?.family});s[0]=u??h,s[1]=r??l,t.shape.x=n,t.shape.y=p;let c="angle"in e?e.angle:null;if(o?.rotation!=null&&(c=(c??0)+o.rotation),c){const f=c*(Math.PI/180),a=Math.abs(Math.sin(f)),i=Math.abs(Math.cos(f));s[1]=s[0]*a+s[1]*i}}}function ht(e,t,s,o,u){if(e.haloColor!=null&&e.haloSize!=null){u.masking??=s.map(()=>[]);const r=b(e.haloSize);o[0]+=r,o[1]+=r,s.unshift([{...t,fill:null,stroke:{color:e.haloColor,width:2*r,join:"round",cap:"round"}}]),u.masking.unshift([{shape:{type:"rect",x:0,y:0,width:o[0]+2*C,height:o[1]+2*C},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}e.backgroundColor==null&&e.borderLineColor==null||(o[0]+=2*C,o[1]+=2*C,s.unshift([{shape:{type:"rect",x:0,y:0,width:o[0],height:o[1]},fill:e.backgroundColor,stroke:{color:e.borderLineColor,width:b(e.borderLineSize)}}]),u.masking?.unshift([]))}function O(e,t){return e>t?"dark":"light"}function H(e,t){const s=typeof t?.size=="number"?t?.size:null,o=s!=null?b(s):null,u=t?.maxSize!=null?b(t.maxSize):null;let r="angle"in e?e.angle:null;t?.rotation!=null&&(r=(r??0)+t.rotation);const h=F(e);let l=j(e);I(e,245)!=="dark"||t?.ignoreWhiteSymbols||(l={width:.75,...l,color:"#bdc3c7"});let n=null;const p={shape:null,fill:h,stroke:l,offset:[0,0]};l?.width&&(l.width=Math.min(l.width,it));const c=l?.width||0;let f=t?.size!=null&&(t?.scale==null||t?.scale),a=0,i=0,M=!1;switch(e.type){case et:{const g=e.style,{width:d,height:m}=S(t);let x=d===m&&d!=null?d:o??Math.min(b(e.size),u||L);if(t?.useMarkerSymbolSize===!0&&d!==null&&m!==null){const y=Math.min(b(e.size),u||L);x=y>d&&y>m?Math.min(d,m):y}switch(a=x,i=x,g){case"circle":p.shape={type:"circle",cx:0,cy:0,r:.5*x},f||(a+=c,i+=c);break;case"cross":p.shape={type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[a,.5*i]},{command:"M",values:[.5*a,0]},{command:"L",values:[.5*a,i]}]};break;case"diamond":p.shape={type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[.5*a,0]},{command:"L",values:[a,.5*i]},{command:"L",values:[.5*a,i]},{command:"Z",values:[]}]},f||(a+=c,i+=c);break;case"square":p.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,0]},{command:"L",values:[a,i]},{command:"L",values:[0,i]},{command:"Z",values:[]}]},f||(a+=c,i+=c),r&&(M=!0);break;case"triangle":p.shape={type:"path",path:[{command:"M",values:[.5*a,0]},{command:"L",values:[a,i]},{command:"L",values:[0,i]},{command:"Z",values:[]}]},f||(a+=c,i+=c),r&&(M=!0);break;case"x":p.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,i]},{command:"M",values:[a,0]},{command:"L",values:[0,i]}]},r&&(M=!0);break;case"path":p.shape={type:"path",path:e.path||""},f||(a+=c,i+=c),r&&(M=!0),f=!0}break}case tt:{const{width:g,height:d}=S(t),m=K(l).reduce((v,k)=>v+k,0),x=m&&Math.ceil(T/m),y=d??o??c,w=g??(m*x||T);if(f=!0,t?.geometry?.type==="polyline"&&t?.geometry?.extent){a=w,i=d??a;const v=1e3,k=.15*v;n=[a,i],i=n[0]>n[1]?v*n[1]/n[0]:v,a=n[0]>n[1]?v:v*n[0]/n[1],l?.width&&(l.width=l.width*v/(n[1]>n[0]?n[1]:n[0]),l.width>k&&(l.width=k)),p.shape={type:"path",path:q(t.geometry,a,i)}}else a=t?.maxSize!=null?Math.min(w,t.maxSize):w,i=y,l&&(l.width=y),p.shape={type:"path",path:[{command:"M",values:[y/2,i/2]},{command:"L",values:[a-y/2,i/2]}]};break}case Z:case _:{const g=typeof t?.symbolConfig=="object"&&!!t?.symbolConfig?.isSquareFill,{width:d,height:m}=S(t);a=!g&&d!==m||d==null?o??at:d,i=!g&&d!==m||m==null?a:m,f||(a+=c,i+=c),f=!0,t?.geometry?.extent&&t?.geometry?.type==="polygon"?(n=[a,i],i=n[0]>n[1]?1e3*n[1]/n[0]:1e3,a=n[0]>n[1]?1e3:1e3*n[0]/n[1],p.shape={type:"path",path:q(t.geometry,a,i)}):p.shape=g?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[a,0]},{command:"L",values:[a,i]},{command:"L",values:[0,i]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:V.fill[0];break}case Y:{const g=Math.min(b(e.width),u||L),d=Math.min(b(e.height),u||L),{width:m,height:x}=S(t),y=m===x&&m!=null?m:o??Math.max(g,d),w=e.width/e.height;a=w<=1?Math.ceil(y*w):y,i=w<=1?y:Math.ceil(y/w),p.shape={type:"image",x:-Math.round(a/2),y:-Math.round(i/2),width:a,height:i,src:e.url||""},r&&(M=!0);break}case nt:{const g=e,d=t?.overrideText||g.text||ot,m=g.font,{width:x,height:y}=S(t),w=y??o??Math.min(b(m.size),u||L),{width:v,height:k}=N(d,{weight:m.weight,size:w,family:m.family}),z=/[\uE600-\uE6FF]/.test(d);a=x??(z?w:v),i=z?w:k;let B=.5*(z?w:k);z&&(B+=5),p.shape={type:"text",text:d,x:g.xoffset||0,y:g.yoffset||B,align:"middle",alignBaseline:g.verticalAlignment,decoration:m&&m.decoration,rotated:g.rotated,kerning:g.kerning},p.font=m&&{size:w,style:m.style,decoration:m.decoration,weight:m.weight,family:m.family};break}}return{shapeDescriptor:p,size:[a,i],outputSize:n,renderOptions:{node:t?.node,scale:f,opacity:t?.opacity,rotations:[r],useRotationSize:M,cssEffectFilter:t?.cssEffectFilter,ariaLabel:t?.ariaLabel,clipBloomEffect:t?.clipBloomEffect}}}async function ct(e,t){const{shapeDescriptor:s,size:o,renderOptions:u,outputSize:r}=H(e,t);if(!s.shape)throw new U("symbolPreview: renderPreviewHTML2D","symbol not supported.");await st(e,s),await rt(e,s,o,t);const h=[[s]];if(typeof t?.symbolConfig=="object"&&t?.symbolConfig?.applyColorModulation){const n=.6*o[0];h.unshift([{...s,offset:[-n,0],fill:D(s.fill,-.3)}]),h.push([{...s,offset:[n,0],fill:D(s.fill,.3)}]),o[0]+=2*n,u.scale=!1}e.type==="text"&&ht(e,s,h,o,u);const l=X(h,o,u);if(r&&l){const n=l.nodeName.toLowerCase()==="img"?l:l.firstChild;n.nodeName.toLowerCase()==="svg"&&n.setAttribute("viewBox",`0 0 ${o[0].toString()} ${o[1].toString()}`),n.setAttribute("width",r[0].toString()),n.setAttribute("height",r[1].toString()),r.length>2&&(n.style.setProperty("padding-left",r[2]?.toString()+"px"),n.style.setProperty("padding-right",r[2]?.toString()+"px"),n.style.setProperty("padding-top",r[3]?.toString()+"px"),n.style.setProperty("padding-bottom",r[3]?.toString()+"px"),n.style.setProperty("box-sizing","border-box"))}return l}function I(e,t=R){const s=F(e),o=j(e),u=!s||"type"in s?null:new P(s),r=o?.color?new P(o?.color):null,h=u?O(E(u),t):null,l=r?O(E(r),t):null;return l?h?h===l?h:t>=R?"light":"dark":l:h}export{I as getContrastingBackgroundTheme,H as getRenderSymbolParameters,ct as previewSymbol2D};
