import{M as x,eU as g,eW as y,d$ as W,eV as b,y as U,ab as z,z as I,eX as J,eY as K}from"./main-pOgmbpmS.js";import{t as Q}from"./arcade-BfSjh4Mb.js";import{o as k,g as G,k as V,z as T,p as P,c as j,l as q,m as B,w as C,K as L,U as D}from"./Dictionary-CseTEM8p.js";import{n as l}from"./enum-BsF4Zles.js";import{l as X}from"./portalUtils-D9m6Ziij.js";import{L as Y,W as $,G as E}from"./projectionUtils-BiGIzqtS.js";import H from"./PortalItem-B7BjAhJH.js";import{p as O,n as Z}from"./project-BAv3BY4o.js";import{p as _,a as ee,e as re,i as te,b as ae}from"./Relationship-DRoxX28X.js";let p=null;async function ne(e){const r=z.geometryServiceUrl??"";if(!r){E()||await Y();for(const t of e)t.container[t.indexer]=$(t.container[t.indexer],I.WGS84);return}const a=e.map(t=>t.container[t.indexer]),i=new O({geometries:a,outSpatialReference:I.WGS84}),s=await Z(r,i);for(let t=0;t<s.length;t++){const n=e[t];n.container[n.indexer]=s[t]}}async function F(e,r){const a=new H({portal:e,id:r});return await a.load(),p===null&&(p=await import("./knowledgeGraphService-CxFK2x8D.js").then(i=>i.k)),await p.fetchKnowledgeGraph(a.url)}function S(e,r,a,i,s){if(e===null)return null;if(g(e)||W(e))return e;if(q(e)||q(e))return e.toJSDate();if(B(e))return e.toStorageFormat();if(C(e))return e.toStorageString();if(L(e)){const t={};for(const n of e.keys())t[n]=S(e.field(n),r,a,i,s),t[n]instanceof b&&s.push({container:t,indexer:n});return t}if(y(e)){const t=e.map(n=>S(n,r,a,i,s));for(let n=0;n<t.length;n++)t[n]instanceof b&&s.push({container:t,indexer:n});return t}return D(e)?e.spatialReference.isWGS84?e:e.spatialReference.isWebMercator&&r?U(e):e:void 0}function ie(e,r){if(!e)return e;if(e.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return K(e);if(e.spatialReference.equals(r.spatialReference))return e;throw new l(r,"WrongSpatialReference",null)}function v(e,r){if(!e)return null;const a={};for(const i in e)a[i]=f(e[i],r);return a}function f(e,r){return e===null?null:y(e)?e.map(a=>f(a,r)):e instanceof ee?{graphTypeName:e.typeName,id:e.id,graphType:"entity",properties:v(e.properties,r)}:e instanceof re?{graphType:"object",properties:v(e.properties,r)}:e instanceof te?{graphTypeName:e.typeName,id:e.id,graphType:"relationship",originId:e.originId??null,destinationId:e.destinationId??null,properties:v(e.properties,r)}:e instanceof ae?{graphType:"path",path:e.path?e.path.map(a=>f(a,r)):null}:D(e)?ie(e,r):g(e)||W(e)||J(e)?e:null}function oe(e){e.mode==="async"&&(e.functions.knowledgegraphbyportalitem=function(r,a){return e.standardFunctionAsync(r,a,(i,s,t)=>{if(k(t,2,2,r,a),t[0]===null)throw new l(r,"PortalRequired",a);if(t[0]instanceof Q){const m=G(t[1]);let u;return u=r.services?.portal?r.services.portal:x.getDefault(),F(X(t[0],u),m)}if(g(t[0])===!1)throw new l(r,"InvalidParameter",a);const n=G(t[0]);return F(r.services?.portal??x.getDefault(),n)})},e.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),e.functions.querygraph=function(r,a){return e.standardFunctionAsync(r,a,async(i,s,t)=>{k(t,2,4,r,a);const n=t[0];if(!V(n))throw new l(r,"InvalidParameter",a);const m=t[1];if(!g(m))throw new l(r,"InvalidParameter",a);p===null&&(p=await import("./knowledgeGraphService-CxFK2x8D.js").then(o=>o.k));let u=null;const d=T(t[2],null);if(!(d instanceof P||d===null))throw new l(r,"InvalidParameter",a);if(d){let o=[];u=S(d,!0,!1,r,o),o=o.filter(c=>!c.container[c.indexer].spatialReference.isWGS84),o.length>0&&await ne(o)}const N=T(t[3],!1),R=new _({openCypherQuery:m,bindParameters:u,provenanceBehavior:N?"include":"exclude"});(n?.serviceDefinition?.currentVersion??11.3)>11.2&&(R.outputSpatialReference=r.spatialReference);const A=(await p.executeQueryStreaming(n,R)).resultRowsStream.getReader(),w=[];try{for(;;){const{done:o,value:c}=await A.read();if(o)break;if(y(c))for(const h of c)w.push(f(h,r));else{const h=[];for(const M of c)h.push(f(c[M],r));w.push(h)}}}catch(o){throw o}return P.convertJsonToArcade(w,j(r),!1,!0)})},e.signatures.push({name:"querygraph",min:2,max:4}))}export{oe as registerFunctions};
