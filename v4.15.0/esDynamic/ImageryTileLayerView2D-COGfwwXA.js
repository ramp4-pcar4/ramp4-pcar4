import{eB as F,i7 as li,i8 as Dt,i9 as ui,jd as ci,hW as ts,_ as u,ic as J,oa as ct,h_ as hi,al as ss,ak as is,N as pi,cr as di,ch as mi,a_ as gi,cl as fi,aa as Le,i as je,X as P,Y as Ee,g2 as rs,bA as yi,hY as xi,av as He,s as wi,bP as bi,ay as _i,fc as os,ai as as}from"./main-pOgmbpmS.js";import{t as ns,c as ls}from"./datasetUtils-D3trDUW-.js";import{v as Ti,i as vi,d as Ci}from"./RasterVFDisplayObject-DgBPpiAF.js";import{b as Si}from"./LayerView2D-BkQnW8KL.js";import{l as Ri}from"./pixelRangeUtils-DcEknavd.js";import{h as Pi}from"./clipUtils-Ce9YB0_o.js";import{i as ee,S as Fi}from"./vectorFieldUtils-Bk7I4EnV.js";import{e as Ne,m as Ii,A as us}from"./MapView-Dxa4uaGw.js";import{r as ht}from"./vec2f32-hTAvipMV.js";import{e as zi}from"./Container-B57WFxfc.js";import{i as Mi,s as ki,u as Di,o as Ot}from"./rasterUtils-CoOHW3BB.js";import{b as cs}from"./WGLContainer-CX32E4rN.js";import{n as hs}from"./TileContainer-CsPWmB24.js";import{P as Te,_ as y,d as I,V as T,N as S,Z as M,x as D,C as d,v as ve,f as Ce,c as _,m,U as O,g as X,i as Se,j as z,I as Re,t as We,X as $e,A as oe,k as Ze,z as ae,T as Bt,e as Z,$ as Oi,a0 as ps,Y as w,p as Y,B as ds,w as Q,a1 as j,r as me,n as v,a2 as ne,q as te,D as Vt,Q as E,F as se,W as le,a3 as Pe,a as ms,K as pt,s as H,b as Fe,a4 as ge,a5 as Bi,G as fe,a6 as Vi,a7 as Ai,a8 as Gi,a9 as qi,aa as Ui,ab as Li,ac as ji,ad as Ei,ae as Hi,af as Ni,ag as Wi,ah as $i,u as Zi,ai as Qi,M as Yi,aj as Ji,ak as Xi,al as Ki,am as er,an as tr,ao as sr,H as ir,ap as At,aq as rr,y as or,ar,as as nr,at as lr}from"./GraphShaderModule-D8i3TIcc.js";import{e as gs}from"./utils-CS2SzBG-.js";import{g as Qe,J as Gt,E as Ie}from"./utils-B1AriLcY.js";import{H as dt}from"./constants-CWFGCPkc.js";import{t as fs}from"./capabilities-BaKzUyhi.js";import{U as ye,P as ze,D as L,C as Me,E as K,N as ie}from"./enums-DDJfd4_p.js";import{m as mt}from"./FramebufferObject-CVFiq-un.js";import{A as gt,h as ft}from"./Texture-DxZPAhdk.js";import{m as ur}from"./bitmapUtils-8rqn7JBC.js";import{o as N}from"./definitions-DVO21zOC.js";import{h as cr}from"./UpdatingHandles-DqTXFuC9.js";import{c as hr}from"./PixelBlock-DKNwVpro.js";import{z as ys}from"./TileInfo-BuafbSCG.js";import{g as xs,a as ws,i as pr,u as dr}from"./RawBlockCache-BeHS6RgO.js";import{$ as mr,m as gr,v as fr,u as bs,I as yr}from"./rasterProjectionHelper-BBjiO_a9.js";import{r as _s,h as xr,p as wr}from"./Tile-n_hJkiiJ.js";import"./TileKey-CKc2_PQR.js";import{f as br}from"./Scheduler-W6yolxj_.js";import{b as _r}from"./utils-Cri6ie95.js";import{r as qt}from"./highlightOptionsUtils-CLH8o-m5.js";import{V as Tr,i as Ye,a as vr}from"./rasterFieldUtils-CG-rcC8E.js";import{i as Cr}from"./timeSupport-DUPD8kJK.js";import{n as Sr}from"./popupUtils-jsSZR3q-.js";import{d as Rr}from"./LayerView-CP_O_RTc.js";import{i as Pr}from"./RefreshableLayerView-DXcnSAEn.js";const Fr={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let Ir=class extends zi{constructor(t=null,e=null,s=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._maskTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this._highlightTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._highlighted=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._mask=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=t,this.transformGrid=e,this.interpolation=s}destroy(){super.destroy(),this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(t){this._processedTexture!==t&&(this._disposeTextures(!0),this._processedTexture=t)}get highlightTexture(){return this._highlightTexture}set highlightTexture(t){this._highlightTexture!==t&&(this._highlightTexture?.dispose(),this._highlightTexture=t),t==null&&(this._highlighted=!1)}get rasterTexture(){return this._rasterTexture}set rasterTexture(t){this._rasterTexture!==t&&(this._rasterTexture?.dispose(),this._rasterTexture=t),t==null&&(this.projected=!1)}get processed(){return this._processed}set processed(t){this._processed=t,t||(this.processedTexture=F(this.processedTexture),this.invalidateTexture())}get highlighted(){return this._highlighted}get symbolizerParameters(){return this._symbolizerParameters||Fr}set symbolizerParameters(t){this._symbolizerParameters!==t&&(this._symbolizerParameters=t,this._colormapTextureInvalidated=!0)}get source(){return this._source}set source(t){this._source!==t&&(this._source=t,this._rasterTexture&&(this._rasterTexture=F(this._rasterTexture),this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this._maskTexture=F(this._maskTexture))}get suspended(){return this._suspended}set suspended(t){this._suspended&&!t&&this.stage&&(this.ready(),this.requestRender()),this._suspended=t}get bandIds(){return this._bandIds}set bandIds(t){this._bandIds=t,this._isBandIdsChanged(t)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode(this._getTextureSamplingMethod(t||"nearest")==="bilinear"?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid!==t&&(this._transformGrid=t,this._transformGridTexture=F(this._transformGridTexture))}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}getRasterTextureSize(t=!1){const e=t||this.projected;return[e?this.width:this.source?.width||this.width,e?this.height:this.source?.height||this.height]}getRasterCellSize(){const t=this.rawPixelData?.srcPixelSize,{projected:e,resolution:s}=this;return t&&!e?[t.x,t.y]:[s,s]}_createTransforms(){return{displayViewScreenMat3:Ne()}}setTransform(t){const e=li(this.transforms.displayViewScreenMat3),[s,i]=t.toScreenNoRotation([0,0],[this.x,this.y]),o=this.resolution/this.pixelRatio/t.resolution,r=o*this.width,a=o*this.height,n=Math.PI*this.rotation/180;Dt(e,e,ht(s,i)),Dt(e,e,ht(r/2,a/2)),ui(e,e,-n),Dt(e,e,ht(-r/2,-a/2)),ci(e,e,ht(r,a)),ts(this.transforms.displayViewScreenMat3,t.displayViewMat3,e)}getTextures({forProcessing:t=!1,useProcessedTexture:e=!1}={}){const s=e?this._processedTexture??this._rasterTexture:this._rasterTexture,i=[],o=[];return s?(this._transformGridTexture&&!this.projected&&(o.push(this._transformGridTexture),i.push("u_transformGrid")),o.push(s),i.push("u_image"),!this._colormapTexture||!e&&t||(o.push(this._colormapTexture),i.push("u_colormap")),this._maskTexture&&(o.push(this._maskTexture),i.push("u_mask")),{names:i,textures:o}):{names:i,textures:o}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:t}){if(!this.stage)return void this._disposeTextures();const e=this._isValidSource(this.source);e&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(t)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(t),this._rasterTexture&&(e?(this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Mi(t,this.transformGrid)),this._mask&&!this._maskTexture&&(this._maskTexture=ki(t,this._mask,[this.width,this.height]))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(t=!0){t&&(this._highlighted=this.highlightTexture!=null);const{functionTextures:e}=this;e.length!==0&&(this.processedTexture=e.shift(),e.forEach(s=>s?.dispose()),e.length=0,this.processed=!!this.processedTexture)}_createOrDestroyRasterTexture(t){const e=this.source?.extractBands(this.bandIds);if(!this._isValidSource(e))return void(this._rasterTexture&&(this._rasterTexture=F(this._rasterTexture),this._rasterTextureBandIds=null));const s=!this._isBandIdsChanged(this.bandIds);if(this._rasterTexture){if(s)return;this._rasterTexture=F(this._rasterTexture),this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!t.capabilities.textureFloatLinear;const i=this._getTextureSamplingMethod(this.interpolation),o=this.isRendereredSource;this._rasterTexture=Di(t,e,i,o),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdsChanged(t){const e=this._rasterTextureBandIds;return!(e==null&&t==null||e&&t&&e.join("")===t.join(""))}_isValidSource(t){return t!=null&&t.pixels?.length>0}_getTextureSamplingMethod(t){const{type:e}=this.symbolizerParameters,s=e==="lut"&&!this.symbolizerParameters.isClassBreaks||e==="hillshade"||e==="stretch"&&this.symbolizerParameters.bandCount===1;return!this._supportsBilinearTexture||s||t!=="bilinear"&&t!=="cubic"?"nearest":"bilinear"}_updateColormapTexture(t){const e=this._colormap,s=this.symbolizerParameters.colormap;return s?e?s.length!==e.length||s.some((i,o)=>i!==e[o])?(this._colormapTexture&&(this._colormapTexture=F(this._colormapTexture)),this._colormapTexture=Ot(t,s),void(this._colormap=s)):void 0:(this._colormapTexture=Ot(t,s),void(this._colormap=s)):(this._colormapTexture&&(this._colormapTexture=F(this._colormapTexture)),void(this._colormap=null))}_disposeTextures(t=!1){t?this.projected&&(this._transformGridTexture=F(this._transformGridTexture)):(this._rasterTexture=F(this._rasterTexture),this._colormapTexture=F(this._colormapTexture),this._transformGridTexture=F(this._transformGridTexture),this._maskTexture=F(this._maskTexture),this._rasterTextureBandIds=null,this._colormap=null,this._colormapTextureInvalidated=!0),this._processedTexture=F(this._processedTexture),this._highlightTexture=F(this._highlightTexture)}},zr=class extends cs{constructor(t,e,s,i,o,r,a=null){super(t,e,s,i,o,r),this.bitmap=null,this.bitmap=new Ir(a,null,null),this.bitmap.coordScale=[o,r],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}setTransform(t){super.setTransform(t),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}_createTransforms(){return{displayViewScreenMat3:Ne(),tileMat3:Ne()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}},Ts=class extends Se{};u([Ce(0,_)],Ts.prototype,"position",void 0);let Mr=class extends Re{},Je=class extends z{};u([m(O)],Je.prototype,"inputTexture",void 0),u([m(O)],Je.prototype,"sumTexture",void 0),u([m(O)],Je.prototype,"numOfNoDataTexture",void 0),u([m(d)],Je.prototype,"numTexels",void 0);let yt=class extends Te{constructor(){super(...arguments),this.type="TextureStatisticsDiffShader"}vertex(t){const e=t.position;return{uv:e,glPosition:new y(Qe(e),0,1)}}fragment(t){const{inputTexture:e,numOfNoDataTexture:s,sumTexture:i}=this.config,o=new ve,r=I(e,t.uv),a=T(i,new M(0,0),new S(0)),n=T(s,new M(0,0),new S(0)).r,l=this.config.numTexels.subtract(n),c=a.divide(l),h=D(r.a,new d(0)),p=new d(1).subtract(h).multiply(r.subtract(c));return o.fragColor=p.multiply(p),o}};u([m(Je)],yt.prototype,"config",void 0),u([J(0,X(Ts))],yt.prototype,"vertex",null),u([J(0,X(Mr))],yt.prototype,"fragment",null);let vs=class extends Se{};u([Ce(0,_)],vs.prototype,"position",void 0);let kr=class extends Re{},pe=class extends z{};u([m(O)],pe.prototype,"minTexture",void 0),u([m(O)],pe.prototype,"maxTexture",void 0),u([m(O)],pe.prototype,"sumTexture",void 0),u([m(O)],pe.prototype,"numOfNoDataTexture",void 0),u([m(S)],pe.prototype,"width",void 0),u([m(S)],pe.prototype,"height",void 0),u([m(S)],pe.prototype,"isFirstPass",void 0);let xt=class extends Te{constructor(){super(...arguments),this.type="TextureStatisticsMinMaxSumShader"}vertex(t){const e=t.position;return{uv:e,glPosition:new y(Qe(e),0,1)}}fragment(t){const e=new ve,{minTexture:s,maxTexture:i,sumTexture:o,numOfNoDataTexture:r}=this.config,a=t.glFragCoord.xy,n=new M(a.multiply(2)),l=new S(0),c=T(s,n,l),h=T(s,n.add(new M(-1,0)),l),p=T(s,n.add(new M(0,-1)),l),f=T(s,n.add(new M(-1,-1)),l),g=Xe(Xe(c,Xe(h,new y(dt))),Xe(p,Xe(f,new y(dt)))),x=T(i,n,l),b=T(i,n.add(new M(-1,0)),l),C=T(i,n.add(new M(0,-1)),l),k=T(i,n.add(new M(-1,-1)),l),R=Ke(Ke(x,Ke(b,new y(-dt))),Ke(C,Ke(k,new y(-dt)))),U=T(o,n,l),$=T(o,n.add(new M(-1,0)),l),Ue=T(o,n.add(new M(0,-1)),l),lt=T(o,n.add(new M(-1,-1)),l),kt=Gt(wt(U),wt($),wt(Ue),wt(lt)),_e=T(r,n,l),re=T(r,n.add(new M(-1,0)),l),oi=T(r,n.add(new M(0,-1)),l),ai=T(r,n.add(new M(-1,-1)),l),ut=new d(this.config.isFirstPass),ni=Gt(bt(_e,ut),bt(re,ut),bt(oi,ut),bt(ai,ut));return e.fragData0=g,e.fragData1=R,e.fragData2=kt,e.fragData3=ni,e}};function Xe(t,e){const s=D(t.a,new d(0));return We(t,e).multiply(new d(1).subtract(s)).add(e.multiply(s))}function Ke(t,e){const s=D(t.a,new d(0));return $e(t,e).multiply(new d(1).subtract(s)).add(e.multiply(s))}function wt(t){const e=D(t.a,new d(0)),s=new d(1).subtract(e);return t.multiply(s)}function bt(t,e){const s=D(t.a,new d(0)),i=new d(1).subtract(e);return e.multiply(s).multiply(new y(1)).add(i.multiply(t))}u([m(pe)],xt.prototype,"config",void 0),u([J(0,X(vs))],xt.prototype,"vertex",null),u([J(0,X(kr))],xt.prototype,"fragment",null);let Cs=class extends Se{};u([Ce(0,_)],Cs.prototype,"position",void 0);let Dr=class extends Re{},xe=class extends z{};u([m(O)],xe.prototype,"minTexture",void 0),u([m(O)],xe.prototype,"maxTexture",void 0),u([m(O)],xe.prototype,"sumTexture",void 0),u([m(O)],xe.prototype,"numOfNoDataTexture",void 0),u([m(O)],xe.prototype,"diffSqTexture",void 0),u([m(d)],xe.prototype,"numTexels",void 0);let _t=class extends Te{constructor(){super(...arguments),this.type="TextureStatisticsStdDevShader"}vertex(t){const e=t.position;return{uv:e,glPosition:new y(Qe(e),0,1)}}fragment(t){const e=new ve,{minTexture:s,maxTexture:i,numOfNoDataTexture:o,sumTexture:r,diffSqTexture:a}=this.config,n=t.glFragCoord.xy,l=new M(n),c=new S(0),h=T(s,l,c),p=T(i,l,c),f=T(r,l,c),g=T(o,l,c).r,x=T(a,l,c),b=this.config.numTexels.subtract(g),C=f.divide(b),k=x.divide(b),R=oe(k);return e.fragData0=h,e.fragData1=p,e.fragData2=C,e.fragData3=R,e}};u([m(xe)],_t.prototype,"config",void 0),u([J(0,X(Cs))],_t.prototype,"vertex",null),u([J(0,X(Dr))],_t.prototype,"fragment",null);let Ss=class extends Se{};u([Ce(0,_)],Ss.prototype,"position",void 0);let Or=class extends Re{},Tt=class extends z{};u([m(O)],Tt.prototype,"sumTexture",void 0),u([m(S)],Tt.prototype,"width",void 0),u([m(S)],Tt.prototype,"height",void 0);class vt extends Te{constructor(){super(...arguments),this.type="TextureStatisticsSumOfSquaredDiffShader"}vertex(e){const s=e.position;return{uv:s,glPosition:new y(Qe(s),0,1)}}fragment(e){const s=new ve,{sumTexture:i}=this.config,o=e.glFragCoord.xy,r=new M(o.multiply(2)),a=new S(0),n=T(i,r,a),l=T(i,r.add(new M(-1,0)),a),c=T(i,r.add(new M(0,-1)),a),h=T(i,r.add(new M(-1,-1)),a),p=Gt(n,l,c,h);return s.fragData0=p,s.fragData1=new y(0),s.fragData2=new y(0),s.fragData3=new y(0),s}}u([m(Tt)],vt.prototype,"config",void 0),u([J(0,X(Ss))],vt.prototype,"vertex",null),u([J(0,X(Or))],vt.prototype,"fragment",null);const Ut=1048576;class Br extends Ze{constructor(){super(...arguments),this.type=32,this._width=0,this._height=0,this._framebuffers=null,this._minTexture=null,this._maxTexture=null,this._sumTexture=null,this._numOfNoDataTexture=null,this._resultsFramebuffer=null,this._startFramebuffer=null,this._diffFramebuffer=null,this._scaleFbo=null,this.shaders={textureStatisticsMinMaxSum:new xt,textureStatisticsSum:new vt,textureStatisticsDiff:new yt,textureStatisticsStdDev:new _t}}dispose(){this.shaders.textureStatisticsMinMaxSum=null,this._framebuffers&&(this._framebuffers.forEach(e=>F(e)),this._framebuffers=null),F(this._resultsFramebuffer),F(this._startFramebuffer),F(this._diffFramebuffer),F(this._scaleFbo),F(this._minTexture),F(this._maxTexture),F(this._sumTexture),F(this._numOfNoDataTexture)}get minValuesTexture(){return this._minTexture||null}get maxValuesTexture(){return this._maxTexture||null}get meanValuesTexture(){return this._resultsFramebuffer?.getColorTexture(ye)||null}get stdDevValuesTexture(){return this._resultsFramebuffer?.getColorTexture(ze)||null}get statsFbo(){return this._resultsFramebuffer}render(e,s){const{context:i,painter:o}=e;let r=s.fbo.width,a=s.fbo.height,n=s.fbo;const l=i.gl,c=i.getBoundFramebufferObject();if(r*a>Ut||!ct(r)||!ct(a)){const g=r/a;if(r*a>Ut){const x=Math.max(Math.floor(Math.sqrt(Ut/g)),1);r=Math.max(Math.floor(g*x),1),a=x}if(ct(r)||(r=Rs(r)),ct(a)||(a=Rs(a)),this._scaleFbo)this._scaleFbo.resize(r,a);else{const{dataType:x,internalFormat:b}=s.fbo.getColorTexture(L).descriptor,C=b??K.RGBA8;this._scaleFbo=et(i,r,a,x,C)}i.bindFramebuffer(this._scaleFbo),i.setViewport(0,0,r,a),o.blitTexture(i,n.getColorTexture(L),9728),n=this._scaleFbo}this._updateResources(e,n),o.setPipelineState({...gs,color:{write:[!0,!0,!0,!0],blendMode:"none"}});const h=this._applyReductionPass(e);l.readBuffer(l.COLOR_ATTACHMENT3),h.copyToTexture(0,0,1,1,0,0,this._numOfNoDataTexture),l.readBuffer(l.COLOR_ATTACHMENT2),h.copyToTexture(0,0,1,1,0,0,this._sumTexture),l.readBuffer(l.COLOR_ATTACHMENT1),h.copyToTexture(0,0,1,1,0,0,this._maxTexture),l.readBuffer(l.COLOR_ATTACHMENT0),h.copyToTexture(0,0,1,1,0,0,this._minTexture);const p=s.fbo.getColorTexture(L);if(!p)throw new Error("Start buffer color texture is not available, cannot compute diff.");this._computeDiff(e,p,this._sumTexture,this._numOfNoDataTexture,r,a);const f=this._applySecondReductionPass(e,r,a).getColorTexture(L);this._computeSdtDev(e,this._minTexture,this._maxTexture,this._sumTexture,this._numOfNoDataTexture,f,r,a),i.bindFramebuffer(c),i.setViewport(0,0,s.fbo.width,s.fbo.height),i.setDrawBuffers([L]),o.setPipelineState(gs)}_applyReductionPass(e){const{context:s,painter:i}=e,o=this.shaders.textureStatisticsMinMaxSum,r=this._framebuffers;if(r===null)throw new Error("Framebuffers are not initialized, cannot apply reduction pass.");s.setDrawBuffers([L,Me,ye]);const a=this._startFramebuffer;let n=a.getColorTexture(L),l=a.getColorTexture(Me),c=a.getColorTexture(ye),h=a.getColorTexture(ze);const p=r;let f=0;for(const g of p){s.setViewport(0,0,g.width,g.height),s.bindFramebuffer(g),s.setClearColor(0,0,0,0),s.clear(16384);const x={shader:o,uniforms:{config:{minTexture:{texture:n,unit:1},maxTexture:{texture:l,unit:2},sumTexture:{texture:c,unit:3},numOfNoDataTexture:{texture:h,unit:4},width:g.width,height:g.height,isFirstPass:f===0?1:0}},defines:null,optionalAttributes:null,useComputeBuffer:!1};i.submitDrawMesh(s,x,i.quadMesh),n=g.getColorTexture(L),l=g.getColorTexture(Me),c=g.getColorTexture(ye),h=g.getColorTexture(ze),f++}return r.at(-1)}_applySecondReductionPass(e,s,i){const{context:o,painter:r}=e,a=this.shaders.textureStatisticsSum,n=this._framebuffers;if(n===null||this._diffFramebuffer==null)throw new Error("Framebuffers are not initialized, cannot apply reduction pass.");o.setDrawBuffers([L]);let l=this._diffFramebuffer.getColorTexture(L);const c=n;for(const h of c){o.setViewport(0,0,h.width,h.height),o.bindFramebuffer(h),o.setClearColor(0,0,0,0),o.clear(16384);const p={shader:a,uniforms:{config:{sumTexture:{texture:l,unit:2},width:h.width,height:h.height}},defines:null,optionalAttributes:null,useComputeBuffer:!1};r.submitDrawMesh(o,p,r.quadMesh),l=h.getColorTexture(L)}return n.at(-1)}_updateResources(e,s){const{context:i}=e,o=s.width,r=s.height;if(this._startFramebuffer===null){if(!fs().supportsColorBufferFloat)throw new Error("WebGL does not support color buffer float, cannot compute texture statistics.");const n=s.getColorTexture(L);if(!n)throw new Error("Input FBO does not have a color attachment 0, cannot compute texture statistics.");const l=n.descriptor,{dataType:c,internalFormat:h}=l,p=et(i,o,r,c,h??K.RGBA8,4),f=p.getColorTexture(L),g=p.getColorTexture(Me),x=p.getColorTexture(ye),b=p.getColorTexture(ze);s.copyToTexture(0,0,o,r,0,0,f),s.copyToTexture(0,0,o,r,0,0,g),s.copyToTexture(0,0,o,r,0,0,x),s.copyToTexture(0,0,o,r,0,0,b),this._startFramebuffer=p,this._diffFramebuffer=et(i,o,r,ie.FLOAT,K.RGBA32F),this._resultsFramebuffer=et(i,1,1,ie.FLOAT,K.RGBA32F,4),this._minTexture=ke(i,1,1,ie.FLOAT,K.RGBA32F),this._maxTexture=ke(i,1,1,ie.FLOAT,K.RGBA32F),this._sumTexture=ke(i,1,1,ie.FLOAT,K.RGBA32F),this._numOfNoDataTexture=ke(i,1,1,ie.FLOAT,K.R32F)}else{const n=this._startFramebuffer;n.resize(o,r);const l=n.getColorTexture(L),c=n.getColorTexture(Me),h=n.getColorTexture(ye),p=n.getColorTexture(ze);s.copyToTexture(0,0,o,r,0,0,l),s.copyToTexture(0,0,o,r,0,0,c),s.copyToTexture(0,0,o,r,0,0,h),s.copyToTexture(0,0,o,r,0,0,p),this._diffFramebuffer.resize(o,r)}if(this._width===o&&this._height===r&&this._framebuffers!==null)return;const a=(this._framebuffers||[]).reverse();this._framebuffers=null,this._width=o,this._height=r,this._framebuffers=this._updateFramebuffers(i,o,r,a,4)}_updateFramebuffers(e,s,i,o,r=1){const a=[];let n=s,l=i;for(;n>1||l>1;){const c=Math.max(1,Math.floor(n/2)),h=Math.max(1,Math.floor(l/2)),p=Vr(e,c,h,o,r);a.push(p),n=c,l=h}return a.at(-1),o.forEach(c=>F(c)),o.length=0,a}_computeDiff(e,s,i,o,r,a){const{context:n,painter:l}=e;n.bindFramebuffer(this._diffFramebuffer),n.setDrawBuffers([L]),n.setViewport(0,0,r,a),n.setClearColor(0,0,0,0),n.clear(16384);const c={shader:this.shaders.textureStatisticsDiff,uniforms:{config:{inputTexture:{texture:s,unit:1},sumTexture:{texture:i,unit:2},numOfNoDataTexture:{texture:o,unit:3},numTexels:r*a}},defines:null,optionalAttributes:null,useComputeBuffer:!1};l.submitDrawMesh(n,c,l.quadMesh)}_computeSdtDev(e,s,i,o,r,a,n,l){const{context:c,painter:h}=e;c.bindFramebuffer(this._resultsFramebuffer),c.setDrawBuffers([L,Me,ye,ze]),c.setViewport(0,0,1,1),c.setClearColor(0,0,0,0),c.clear(16384);const p={shader:this.shaders.textureStatisticsStdDev,uniforms:{config:{minTexture:{texture:s,unit:1},maxTexture:{texture:i,unit:2},sumTexture:{texture:o,unit:3},numOfNoDataTexture:{texture:r,unit:4},diffSqTexture:{texture:a,unit:5},numTexels:n*l}},defines:null,optionalAttributes:null,useComputeBuffer:!1};h.submitDrawMesh(c,p,h.quadMesh)}}function Vr(t,e,s,i,o=1){let r=i.pop();return r!==void 0?r.resize(e,s):r=et(t,e,s,ie.FLOAT,K.RGBA32F,o),r}function et(t,e,s,i,o,r=1){if(r<1||r>4)throw new Error("Number of color attachments must be between 1 and 4.");const a=new mt(t,ke(t,e,s,i,o));for(let n=1;n<r;n++){const l=ke(t,e,s,i,o);a.attachColorTexture(l,L+n)}return a}function ke(t,e,s,i,o){const r=new ft(e,s);return r.samplingMode=9728,r.wrapMode=33071,r.pixelFormat=6408,r.dataType=i,r.internalFormat=o,new gt(t,r)}function Rs(t){const e=hi(t),s=e/2;return Math.abs(e-t)<Math.abs(s-t)?e:s}function Ps(t,e){const s=new ft(t,e);return s.internalFormat=K.RGBA32F,s.samplingMode=9728,s.dataType=ie.FLOAT,s.isImmutable=!0,s.wrapMode=33071,s}function Ar(t,e,s){const i=Ps(e,s);return new gt(t,i)}function Fs(t,e,s){const i=Ps(e,s);return new mt(t,i)}function Ct(t){const{symbolizerParameters:e}=t,{type:s}=e,i=s==="lut"?"nearest":t.interpolation,o=i==="bilinear"&&s!=="lut"&&(s!=="stretch"||e.bandCount===1);return{bilinear:o,bicubic:i==="cubic",nearestOnEdge:o}}function Gr(t,e,s,i){const o=ae(e.multiply(s)),r=new M(new S(o.x),new S(o.y)),a=new M(r.x.add(1),r.y),n=new M(r.x,r.y.add(1)),l=new M(r.x.add(1),r.y.add(1)),c=T(t,r,new S(0)),h=T(t,a,new S(0)),p=T(t,n,new S(0)),f=T(t,l,new S(0)),g=Bt(e.multiply(s)),x=Z(c,h,g.x),b=Z(p,f,g.x),C=Z(x,b,g.y);if(!i)return C;const k=new y(c.a,h.a,p.a,f.a),R=k.xy.multiply(k.zw),U=ae(R.x.multiply(R.y).add(.5)),$=C.multiply(U),Ue=Ie(U).multiply(I(t,e));return $.add(Ue)}let tt=class extends z{};function qr(t,e){const s=I(e.transformTexture,t);return new _(s.r,s.g)}function Ur(t,e){const{transformTexture:s,targetImageSize:i,transformSpacing:o}=e,r=ae(t.multiply(i)),a=new _(4,1),n=ae(r.divide(o)).multiply(a),l=Bt(r.add(new _(.5,.5)).divide(o)),c=new M(ps(n.x),ps(n.y)),h=new w(l,1);return Y(ds(l.x,l.y),Lr(s,c,h),jr(s,c,h))}function Lr(t,e,s){const i=T(t,e,new S(0)),o=new M(e.x.add(1),e.y),r=T(t,o,new S(0));return new _(Q(i.rgb,s),Q(r.rgb,s))}function jr(t,e,s){const i=new M(e.x.add(2),e.y),o=T(t,i,new S(0)),r=new M(e.x.add(3),e.y),a=T(t,r,new S(0));return new _(Q(o.rgb,s),Q(a.rgb,s))}function Er(t){const e=D(new _(-1e-5,-1e-5),t).multiply(D(t,new _(1.00001,1.00001))),s=Ie(e.x.multiply(e.y));return new Oi(s)}function Is(t,e,s=!1){return e?s?qr(t,e):Ur(t,e):t}function zs(t,e,s){const{bicubic:i=!1,bilinear:o=!1,nearestOnEdge:r=!1}=s??{};return i||o?i?ur(e.texture,t,e.srcImageSize):Gr(e.texture,t,e.srcImageSize,r):I(e.texture,t)}u([m(O)],tt.prototype,"transformTexture",void 0),u([m(_)],tt.prototype,"targetImageSize",void 0),u([m(_)],tt.prototype,"transformSpacing",void 0),u([m(_)],tt.prototype,"transformGridSize",void 0);let Ms=class extends Se{};u([Ce(0,_)],Ms.prototype,"position",void 0);let Hr=class extends Re{};class De extends z{}u([m(O)],De.prototype,"texture",void 0),u([m(me)],De.prototype,"dvsMat3",void 0),u([m(_)],De.prototype,"coordScale",void 0),u([m(_)],De.prototype,"srcImageSize",void 0),u([m(d)],De.prototype,"opacity",void 0);let ks=class extends z{};u([m(O)],ks.prototype,"maskTexture",void 0);let Ds=class extends z{};u([m(O)],Ds.prototype,"highlightTexture",void 0);let G=class extends Te{constructor(){super(...arguments),this.applyProjection=!0,this.lookupProjection=!1,this.bilinear=!1,this.bicubic=!1,this.nearestOnEdge=!1,this.applyPixelMask=!1,this.applyPixelHighlights=!1}vertex(t){const e=t.position,{dvsMat3:s,coordScale:i}=this.config,o=s.multiply(new w(e.multiply(i),1));return{uv:e,glPosition:new y(o,1)}}fragment(t){const e=new ve,s=Is(t.uv,this.applyProjection?this.projectionConfig:void 0,this.lookupProjection);let i=this._colorize(s,t.uv);this.applyPixelHighlights&&(i=this._highlightPixels(t.uv,i));const o=Y(Er(s),new y(0),i);let r=o.a.multiply(this.config.opacity);if(this.applyPixelMask){const a=this._getPixelMask(t.uv);r=r.multiply(a)}return e.fragColor=new y(o.rgb,1).multiply(r),e}_getPixel(t){const{config:e,bicubic:s,bilinear:i,nearestOnEdge:o}=this;return zs(t,e,{bicubic:s,bilinear:i,nearestOnEdge:o})}_getPixelMask(t){const{maskTexture:e}=this.pixelMaskConfig,s=I(e,t);return j(s.a)}_highlightPixels(t,e){const{highlightTexture:s}=this.highlightConfig,i=I(s,t),o=j(i.a);return Z(e,i,o)}};u([v],G.prototype,"applyProjection",void 0),u([v],G.prototype,"lookupProjection",void 0),u([v],G.prototype,"bilinear",void 0),u([v],G.prototype,"bicubic",void 0),u([v],G.prototype,"nearestOnEdge",void 0),u([v],G.prototype,"applyPixelMask",void 0),u([v],G.prototype,"applyPixelHighlights",void 0),u([m(De)],G.prototype,"config",void 0),u([ne(tt)],G.prototype,"projectionConfig",void 0),u([ne(ks)],G.prototype,"pixelMaskConfig",void 0),u([ne(Ds)],G.prototype,"highlightConfig",void 0),u([J(0,X(Ms))],G.prototype,"vertex",null),u([J(0,X(Hr))],G.prototype,"fragment",null);let de=class extends z{};function st(t,e,s,i=!0){const{colormapTexture:o,colormapOffset:r,colormapMaxIndex:a}=s,n=t.r.multiply(e).subtract(r),l=te(n,new d(0),a),c=new _(l.add(.5).divide(a.add(1)),0),h=I(o,c),p=new y(h.rgb,h.a.multiply(t.a));if(i)return p;const f=D(new d(0),n).multiply(D(n,s.colormapMaxIndex));return p.multiply(f)}u([m(O)],de.prototype,"colormapTexture",void 0),u([m(d)],de.prototype,"colormapOffset",void 0),u([m(d)],de.prototype,"colormapMaxIndex",void 0);let Os=class extends G{constructor(){super(...arguments),this.type="RasterColorizerLUTShader"}_colorize(t){const e=this._getPixel(t);return st(e,new d(1),this.colormapConfig,!1)}};u([m(de)],Os.prototype,"colormapConfig",void 0);function Bs(t){const e=new y(0,-.3333333333333333,.6666666666666666,-1),s=Y(Vt(t.y,t.z),new y(t.zy,e.wz),new y(t.yz,e.xy)),i=Y(Vt(t.x,s.x),new y(s.xyw,t.x),new y(t.x,s.yzx)),o=i.x.subtract(We(i.w,i.y)),r=new d(1e-10),a=i.w.subtract(i.y),n=o.multiply(6).add(r),l=E(a.divide(n).add(i.z)),c=i.x.add(r),h=We(o.divide(c),new d(1));return new w(l,h,i.x)}function Vs(t){const e=new y(1,.6666666666666666,.3333333333333333,3),s=E(Bt(t.xxx.add(e.xyz)).multiply(6).subtract(e.www)),i=te(s.subtract(e.xxx),new w(0,0,0),new w(1));return t.z.multiply(Z(e.xxx,i,t.y))}let ue=class extends z{};function W(t){const e=E(t),s=D(e,new _(1,1)).multiply(e),i=new d(2).subtract(e),o=D(new d(1),e).multiply(i);return s.add(o)}function it(t,e,s){const i=new d(1).divide(s),o=I(t,W(i.multiply(new _(-1,-1)).add(e))),r=I(t,W(i.multiply(new _(0,-1)).add(e))),a=I(t,W(i.multiply(new _(1,-1)).add(e))),n=I(t,W(i.multiply(new _(-1,0)).add(e))),l=I(t,W(e)),c=I(t,W(i.multiply(new _(1,0)).add(e))),h=I(t,W(i.multiply(new _(-1,1)).add(e))),p=I(t,W(i.multiply(new _(0,1)).add(e))),f=I(t,W(i.multiply(new _(1,1)).add(e))),g=new y(o.a,r.a,a.a,n.a),x=new y(c.a,h.a,p.a,f.a),b=g.multiply(x),C=b.xy.multiply(b.zw),k=C.x.multiply(C.y).multiply(l.a),R=new se(new d(0),10);return R[0]=o.r,R[1]=r.r,R[2]=a.r,R[3]=n.r,R[4]=l.r,R[5]=c.r,R[6]=h.r,R[7]=p.r,R[8]=f.r,R[9]=k,R}function Lt(t,e){const s=new y(t[5],t[3],t[7],t[1]).multiply(2),i=new w(t[2],s[0],t[8]),o=new w(t[0],s[1],t[6]),r=Q(i.subtract(o),new w(1)),a=new w(t[6],s[2],t[8]),n=new w(t[0],s[3],t[2]),l=Q(a.subtract(n),new w(1));return new _(r,l).multiply(e)}function As(t,e,s){const{factor:i}=e,o=Lt(t,i),r=oe(Q(o,o).add(1)),a=t[9],{sinZsinAs:n,sinZcosAs:l,cosZs:c,weights:h}=e;if(!s){const x=jt({sinZsinA:n[0],sinZcosA:l[0],cosZ:c[0],weights:new d(1),dzxy:o,dzd:r});return new y(x,x,x,a)}const p=jt({sinZsinA:new w(n[0],n[1],n[2]),sinZcosA:new w(l[0],l[1],l[2]),cosZ:new w(c[0],c[1],c[2]),weights:new w(h[0],h[1],h[2]),dzxy:o,dzd:r}),f=jt({sinZsinA:new w(n[3],n[4],n[5]),sinZcosA:new w(l[3],l[5],l[5]),cosZ:new w(c[3],c[4],c[5]),weights:new w(h[3],h[4],h[5]),dzxy:o,dzd:r}),g=Q(p.add(f),new w(1));return new y(g,g,g,a)}function jt(t){const e=t.sinZsinA.multiply(t.dzxy.y),s=t.sinZcosA.multiply(t.dzxy.x),i=e.subtract(s),o=t.cosZ.add(i).divide(t.dzd);return o.multiply(D(new d(0),o)).multiply(t.weights)}function Gs(t,e){const{pixelSizeFactor:s}=t,i=[t.factor[0]/e[0],t.factor[1]/e[1]];if(s>0){const{zFactor:o,pixelSizePower:r,gcsFactor:a}=t,n=e[0]*a,l=e[1]*a;i[0]=(o+n**r*s)/(8*n),i[1]=(o+l**r*s)/(8*l)}return i}u([m(se.ofType(d,6))],ue.prototype,"sinZcosAs",void 0),u([m(se.ofType(d,6))],ue.prototype,"sinZsinAs",void 0),u([m(se.ofType(d,6))],ue.prototype,"cosZs",void 0),u([m(se.ofType(d,6))],ue.prototype,"weights",void 0),u([m(d)],ue.prototype,"minValue",void 0),u([m(d)],ue.prototype,"maxValue",void 0),u([m(_)],ue.prototype,"factor",void 0);let rt=class extends G{constructor(){super(...arguments),this.type="RasterColorizerShadedReliefShader",this.applyColormap=!1,this.isMultidirectional=!1}_colorize(t){const{texture:e}=this.config,s=it(e,t,this.config.srcImageSize),i=As(s,this.hillshadeConfig,this.isMultidirectional);if(!this.applyColormap)return new y(i.x,i.x,i.x,i.a);const{minValue:o,maxValue:r}=this.hillshadeConfig,a=this._getPixel(t),n=r.subtract(o),l=a.r.subtract(o),c=te(l.divide(n),new d(0),new d(1)),h=st(new y(c,c,c,1),new d(255),this.colormapConfig),p=Bs(h.xyz),f=Vs(new w(p.xy,i.x));return new y(f,h.a.multiply(i.a))}};u([v],rt.prototype,"applyColormap",void 0),u([v],rt.prototype,"isMultidirectional",void 0),u([m(ue)],rt.prototype,"hillshadeConfig",void 0),u([ne(de)],rt.prototype,"colormapConfig",void 0);function B(t){const e=j(t),s=t.add(E(e).subtract(1));return e.multiply(e).divide(s)}function Oe(t){return new y(ae(t.rgb.add(.5)),t.a)}function qs(t,e){return D(e.x,t).multiply(D(t,e.y))}function Nr(t,e){let s=new w(0,0,0);const i=new w(t);for(let o=0;o<ee/3;o++){const r=6*o,a=new w(e[r],e[r+2],e[r+4]),n=new w(e[r+1],e[r+3],e[r+5]);s=s.add(D(a,i).multiply(D(i,n)))}return j(Q(s,new w(1,1,1)))}function Wr(t,e,s){const i=new w(t);let o=new w(0,0,0),r=new d(0);for(let a=0;a<s/3;a++){const n=9*a,l=new w(e[n],e[n+3],e[n+6]),c=new w(e[n+1],e[n+4],e[n+7]),h=D(l,i).multiply(D(i,c)),p=new w(e[n+2],e[n+5],e[n+8]);r=Z(r,p.x,h.x),r=Z(r,p.y,h.y),r=Z(r,p.z,h.z),o=o.add(h)}return{mapValue:r,includeMask:j(Q(o,new w(1,1,1)))}}let ce=class extends z{};u([m(d)],ce.prototype,"minOutput",void 0),u([m(d)],ce.prototype,"maxOutput",void 0),u([m(w)],ce.prototype,"minCutOff",void 0),u([m(w)],ce.prototype,"maxCutOff",void 0),u([m(w)],ce.prototype,"factor",void 0),u([m(w)],ce.prototype,"gamma",void 0),u([m(w)],ce.prototype,"gammaCorrection",void 0);class Be extends z{}function Us(t,e){const{minCutOff:s,maxCutOff:i,factor:o,minOutput:r}=e;return te(t,s,i).subtract(s).multiply(o).add(r)}function Ls(t,e){const{minCutOff:s,maxCutOff:i,minOutput:o,maxOutput:r,gamma:a,gammaCorrection:n}=e,l=te(t,s,i).subtract(s),c=i.subtract(s),h=l.divide(c),p=D(new d(1),a),f=j(a.subtract(1)),g=r.subtract(o),x=new w(1),b=le(x.divide(g),h.multiply(n)),C=Ie(p.multiply(f).multiply(b)),k=le(h,x.divide(a)),R=C.multiply(g).multiply(k).add(o);return te(R,o,r)}function js(t,e,s,i=255){const o=s?Ls(t.rgb,e).divide(i):Us(t.rgb,e);return new y(o,t.a)}function $r(t,e,s,i,o){const r=new M(0,0),a=new S(0);let n=T(s.minTexture,r,a).rgb,l=T(s.maxTexture,r,a).rgb;if(o){const x=T(s.meanTexture,r,a).rgb,b=T(s.stddevTexture,r,a).rgb.multiply(s.numberOfStandardDeviations);n=$e(n,x.subtract(b)),l=We(l,x.add(b))}const c=l.subtract(n),h=new w(B(c.x),B(c.y),B(c.z)),p=e.maxOutput.subtract(e.minOutput).multiply(h),f={...e,minCutOff:n,maxCutOff:l,factor:p},g=i?Ls(t.rgb,f).divide(255):Us(t.rgb,f);return new y(g,t.a)}u([m(O)],Be.prototype,"minTexture",void 0),u([m(O)],Be.prototype,"maxTexture",void 0),u([m(O)],Be.prototype,"meanTexture",void 0),u([m(O)],Be.prototype,"stddevTexture",void 0),u([m(d)],Be.prototype,"numberOfStandardDeviations",void 0);let he=class extends G{constructor(){super(...arguments),this.type="RasterColorizerStretchShader",this.isMultiband=!0,this.applyColormap=!1,this.useGamma=!1,this.noOp=!1,this.draStretchType=0}_colorize(t){const e=this._getPixel(t);if(this.noOp)return e;const{draStretchType:s,stretchConfig:i,useGamma:o,statisticsConfig:r}=this;let a=s===0?js(e,i,o):$r(e,i,r,o,s===2);if(this.isMultiband)return a;if(a=new y(a.rrr,a.a),this.applyColormap){const n=this.useGamma?255:1;a=st(a,new d(n),this.colormapConfig)}return a}};u([v],he.prototype,"isMultiband",void 0),u([v],he.prototype,"applyColormap",void 0),u([v],he.prototype,"useGamma",void 0),u([v],he.prototype,"noOp",void 0),u([v],he.prototype,"draStretchType",void 0),u([m(ce)],he.prototype,"stretchConfig",void 0),u([ne(de)],he.prototype,"colormapConfig",void 0),u([ne(Be)],he.prototype,"statisticsConfig",void 0);const Zr=160,Qr=new Set(["f32","f64","u16","s16","u32","s32"]);let Yr=class extends Ze{constructor(){super(...arguments),this.name="BrushRasterColorizer",this.type=0,this.shaders={lut:new Os,stretch:new he,shadedRelief:new rt},this._mosaicFbo=null,this._statisticsTechnique=null,this._draTimer=0}shutdown(t){super.shutdown(t),this._mosaicFbo=F(this._mosaicFbo),this._statisticsTechnique=F(this._statisticsTechnique)}render(t,e){const s=e.bitmaps.some(Et);s||(this._mosaicFbo=F(this._mosaicFbo),this._statisticsTechnique=F(this._statisticsTechnique));const i=s?this._computeStatisticsTextures(t,e):void 0;for(const o of e.bitmaps){if(!o.source||o.suspended)continue;t.timeline.begin(this.name);const{painter:r}=t;r.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}}),o.updateTexture(t),o.updateProcessedTexture();const{type:a}=o.symbolizerParameters,n=a==="stretch"?this._getStretchOptions(o,i):a==="lut"?this._getLutOptions(o):this._getShadedReliefOptions(o);o.interpolation!=="bilinear"||t.context.capabilities.textureFloatLinear||(n.defines.bilinear=!0),r.submitDrawMesh(t.context,n,r.quadMesh,o),t.timeline.end(this.name)}}_computeStatisticsTextures(t,e){this._statisticsTechnique??=new Br;const s=this._statisticsTechnique;let i=ss("esri-2d-dra-delay");if(i==null){const o=e.bitmaps.find(Et),{stretchType:r,bandCount:a}=o.symbolizerParameters,{pixelType:n}=o.source;r==="minMax"&&a>=3&&Qr.has(n)&&(i=Zr)}if(i){const o=performance.now();(o-this._draTimer>=i||t.stationary||!s.minValuesTexture)&&(this._mosaic(t,e),s.render(t,{fbo:this._mosaicFbo}),this._draTimer=o)}else this._mosaic(t,e),s.render(t,{fbo:this._mosaicFbo});return{minTexture:s.minValuesTexture,maxTexture:s.maxValuesTexture,meanTexture:s.meanValuesTexture,stddevTexture:s.stdDevValuesTexture}}_mosaic(t,e){const{context:s,painter:i}=t,o=s.getBoundFramebufferObject();if(this._mosaicFbo)this._mosaicFbo.resize(o.width,o.height);else{const a=Jr(s,o.width,o.height);this._mosaicFbo=new mt(s,a)}s.bindFramebuffer(this._mosaicFbo);const r="RasterColorizerMosaic";for(const a of e.bitmaps){if(!Et(a))continue;t.timeline.begin(r),i.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}});const n=a.interpolation;a.interpolation="nearest",a.updateTexture(t),a.updateProcessedTexture();const l=this._getStretchOptions(a);l.defines.noOp=!0,i.submitDrawMesh(t.context,l,i.quadMesh,a),a.interpolation=n,t.timeline.end(r)}s.bindFramebuffer(o)}_getLutOptions(t){const{config:e,projectionConfig:s,colormapConfig:i,pixelMaskConfig:o,highlightConfig:r,projectionDefines:a}=this._getCommonConfig(t),n=Ct(t);return{shader:this.shaders.lut,uniforms:{projectionConfig:s,config:e,colormapConfig:i,pixelMaskConfig:o,highlightConfig:r},defines:{...a,...n,applyPixelMask:!!o,applyPixelHighlights:!!r},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(t,e){const s=t.symbolizerParameters,{config:i,projectionConfig:o,colormapConfig:r,pixelMaskConfig:a,highlightConfig:n,projectionDefines:l,textureUnit:c}=this._getCommonConfig(t),h=Ct(t),p=e?{minTexture:{texture:e.minTexture,unit:c},maxTexture:{texture:e.maxTexture,unit:c+1},meanTexture:{texture:e.meanTexture,unit:c+2},stddevTexture:{texture:e.stddevTexture,unit:c+3},numberOfStandardDeviations:s.numberOfStandardDeviations||2}:void 0,f=e?s.stretchType==="standardDeviation"?2:1:0;return{shader:this.shaders.stretch,uniforms:{projectionConfig:o,config:i,stretchConfig:s,colormapConfig:r,pixelMaskConfig:a,highlightConfig:n,statisticsConfig:p},defines:{...l,...h,isMultiband:s.bandCount>1,applyColormap:!!r,useGamma:s.useGamma,noOp:t.isRendereredSource&&!t.processed,applyPixelMask:!!a,applyPixelHighlights:!!n,draStretchType:f},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(t){const e=t.symbolizerParameters,{config:s,projectionConfig:i,colormapConfig:o,pixelMaskConfig:r,highlightConfig:a,projectionDefines:n}=this._getCommonConfig(t),l=Ct(t);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:i,config:s,hillshadeConfig:e,colormapConfig:o,pixelMaskConfig:r,highlightConfig:a},defines:{...n,...l,isMultidirectional:e.hillshadeType>0,applyColormap:!!o,applyPixelMask:!!r,applyPixelHighlights:!!a},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(t){const{coordScale:e,computedOpacity:s,transforms:i}=t,{names:o,textures:r}=t.getTextures({useProcessedTexture:t.processed}),a=r[o.indexOf("u_image")],n=t.getRasterTextureSize();let l=0;const c={texture:{texture:a,unit:l++},dvsMat3:i.displayViewScreenMat3,coordScale:e,srcImageSize:n,opacity:s},h=r[o.indexOf("u_transformGrid")],{transformGrid:p}=t,f=!(!h||!p),g=f?{transformTexture:{texture:h,unit:l++},targetImageSize:[t.width,t.height],transformSpacing:p.spacing,transformGridSize:p.size}:void 0,x=r[o.indexOf("u_colormap")],{colormap:b,colormapOffset:C}=t.symbolizerParameters,k=x&&b?{colormapTexture:{texture:x,unit:l++},colormapOffset:C??0,colormapMaxIndex:b.length/4-1}:void 0,R=r[o.indexOf("u_mask")],U=R?{maskTexture:{texture:R,unit:l++}}:void 0,{highlightTexture:$}=t;return{config:c,projectionConfig:g,colormapConfig:k,pixelMaskConfig:U,highlightConfig:$?{highlightTexture:{texture:$,unit:l++}}:void 0,projectionDefines:{applyProjection:f,lookupProjection:f&&p.spacing[0]===1},textureUnit:l}}};function Jr(t,e,s){const i=new ft(e,s);return i.internalFormat=K.RGBA32F,i.samplingMode=9728,i.dataType=ie.FLOAT,i.wrapMode=33071,new gt(t,i)}function Et(t){return!t.suspended&&t.source!=null&&!t.isRendereredSource&&t.symbolizerParameters.type==="stretch"&&!!t.symbolizerParameters.dynamicRangeAdjustment}let St=class extends z{};u([m(se.ofType(d,2*ee))],St.prototype,"ranges",void 0),u([m(me)],St.prototype,"bandSwap",void 0),u([m(y)],St.prototype,"color",void 0);let Ht=class extends G{constructor(){super(...arguments),this.type="RasterRangeHighlightShader",this.hasExistingHighlights=!1}_colorize(t,e){const s=this._getPixel(t),{ranges:i,color:o,bandSwap:r}=this.rangeHighlightConfig,a=r.multiply(s.rgb).x,n=Nr(a,i).multiply(j(s.a)),l=Z(new y(0),o,n);if(this.hasExistingHighlights){const{highlightTexture:c}=this.highlightConfig,h=I(c,e);return Z(h,l,n)}return l}};u([v],Ht.prototype,"hasExistingHighlights",void 0),u([m(St)],Ht.prototype,"rangeHighlightConfig",void 0);let Xr=class extends Ze{constructor(){super(...arguments),this.name="BrushRasterHighlight",this.type=2,this.shaders={range:new Ht}}shutdown(t){super.shutdown(t),this._fbo?.dispose(),this._fbo=void 0}render(t,e){const{context:s}=t;if(!this._fbo){const a=Es(t.context,N,N);this._fbo=new mt(s,a)}const i=s.getBoundFramebufferObject(),o=s.getViewport(),{pixelHighlightOptions:r}=t;for(const a of e.bitmaps){if(!r||!a.source||a.highlighted||a.suspended||a.isRendereredSource)continue;const n=a.bandIds?.length?a.bandIds.indexOf(r.bandId):0;if(n<0||n>2)continue;t.timeline.begin(this.name);const{painter:l}=t;l.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),a.updateTexture(t),a.updateProcessedTexture(!1);const{config:c,projectionConfig:h,highlightConfig:p,projectionDefines:f}=this._getCommonConfig(a),g=Ct(a);a.interpolation!=="bilinear"||t.context.capabilities.textureFloatLinear||(g.bilinear=!0);const x=new Float32Array(9);x[3*n]=1;const b={...r,bandSwap:x},C={shader:this.shaders.range,uniforms:{projectionConfig:h,config:c,rangeHighlightConfig:b,highlightConfig:p},defines:{...f,...g,applyPixelMask:!1,applyPixelHighlights:!1,hasExistingHighlights:!!p},optionalAttributes:null,useComputeBuffer:!1};s.bindFramebuffer(this._fbo),s.setViewport(0,0,N,N),l.submitDrawMesh(t.context,C,l.quadMesh);const k=Es(t.context,N,N);this._fbo.copyToTexture(0,0,N,N,0,0,k),a.highlightTexture=k,t.timeline.end(this.name)}s.bindFramebuffer(i),s.setViewport(o.x,o.y,o.width,o.height)}_getCommonConfig(t){const{names:e,textures:s}=t.getTextures({forProcessing:!0,useProcessedTexture:t.processed}),i=s[e.indexOf("u_image")],o=t.getRasterTextureSize(),r={texture:{texture:i,unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:o,opacity:1},a=s[e.indexOf("u_transformGrid")],{transformGrid:n}=t,l=!(!a||!n),c=l?{transformTexture:{texture:a,unit:1},targetImageSize:[t.width,t.height],transformSpacing:n.spacing,transformGridSize:n.size}:void 0,{highlightTexture:h}=t;return{config:r,projectionConfig:c,highlightConfig:h?{highlightTexture:{texture:h,unit:2}}:void 0,projectionDefines:{applyProjection:l,lookupProjection:l&&n.spacing[0]===1}}}};function Es(t,e,s){const i=new ft(e,s);return i.internalFormat=K.RGBA8,i.samplingMode=9728,i.dataType=ie.UNSIGNED_BYTE,i.isImmutable=!0,i.wrapMode=33071,new gt(t,i)}let A=class extends Ze{shutdown(t){super.shutdown(t),this._fbo?.dispose(),this._fbo=void 0}render(t,e){const{rasterFunction:s}=t;if(!s)return;const{context:i}=t,o="indexedColormap"in s.parameters?Ot(i,s.parameters.indexedColormap):void 0,r=s.name==="Reproject",a=i.getBoundFramebufferObject(),n=i.getViewport();for(const l of e.bitmaps){const c=r?!(l.rasterTexture&&l.projected):!l.processed;if(!l.source||!c||l.suspended)continue;t.timeline.begin(this.name);const{painter:h}=t;h.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),r||(l.processedTexture=F(l.processedTexture)),l.updateTexture(t);const[p,f]=l.getRasterTextureSize(r),g=p===N&&f===N,x=g?e.processorFbo:Fs(i,p,f);i.bindFramebuffer(x),i.setViewport(0,0,x.width,x.height),this._process(t,l,o);const b=Ar(t.context,p,f);if(x.copyToTexture(0,0,p,f,0,0,b),r)l.rasterTexture=b;else{const C=t.hasBranches?s.id:0;l.functionTextures[C]?.dispose(),l.functionTextures[C]=b}g||x.dispose(),t.timeline.end(this.name)}o?.dispose(),i.bindFramebuffer(a),i.setViewport(n.x,n.y,n.width,n.height)}_getCommonConfig(t,e){const{rasterFunction:s,hasBranches:i}=t,{raster:o,rasters:r}=s.parameters,a=i?o?.id??r?.find(c=>c.name!=="Constant")?.id??-1:0,n=e.functionTextures[a]??e.rasterTexture,l=s.name==="Reproject";return{texture:{texture:n,unit:0},srcImageSize:e.getRasterTextureSize(l)}}_getMultipleInputConfig(t,e){return e?.length?e.length===2?{twoRasterConfig:this._getTwoInputConfig(e,t)}:e.length===3?{threeRasterConfig:this._getThreeInputConfig(e,t)}:{}:{}}_getConstantCount(t){return t?.filter(e=>e.name==="Constant").length??0}_getTextures(t,e){return t.filter(s=>s.name!=="Constant").map(s=>s.id!=null&&s.name!=="Identity"?e.functionTextures[s.id]:e.rasterTexture)}_getTwoInputConfig(t,e){const s=this._getTextures(t,e),i=s[1]?{texture:s[1],unit:1}:void 0,o=t.findIndex(a=>a.name==="Constant"),r=o===0?new Float32Array([0,1,0,1,0,0,0,0,0]):new Float32Array([1,0,0,0,1,0,0,0,0]);return{image1:i,image1Const:o>-1?t[o].parameters.value:0,imageSwap:r}}_getThreeInputConfig(t,e){const s=this._getTextures(t,e);let i=0,o=0,r=new Float32Array([1,0,0,0,1,0,0,0,1]);const a=s[1]?{texture:s[1],unit:1}:void 0,n=s[2]?{texture:s[2],unit:2}:void 0,l=[];if(t.forEach((c,h)=>c.name==="Constant"&&l.push(h)),l.length===1)i=t[l[0]].parameters.value,r=l[0]===0?new Float32Array([0,1,0,0,0,1,1,0,0]):l[0]===1?new Float32Array([1,0,0,0,0,1,0,1,0]):new Float32Array([1,0,0,0,1,0,0,0,1]);else if(l.length===2){i=t[l[0]].parameters.value,o=t[l[1]].parameters.value;const c=t.findIndex(h=>h.name!=="Constant");r=c===0?new Float32Array([1,0,0,0,1,0,0,0,1]):c===1?new Float32Array([0,1,0,1,0,0,0,0,1]):new Float32Array([0,0,1,1,0,0,0,1,0])}return{image1:a,image2:n,image1Const:i,image2Const:o,imageSwap:r}}},Hs=class extends Se{};u([Ce(0,_)],Hs.prototype,"position",void 0);class Kr extends Re{}let Nt=class extends z{};u([m(O)],Nt.prototype,"texture",void 0),u([m(_)],Nt.prototype,"srcImageSize",void 0);let V=class extends Te{vertex(t){return{uv:t.position,glPosition:new y(Qe(t.position),0,1)}}fragment(t){const e=new ve,s=Is(t.uv),i=this._process(s);return e.fragColor=new y(i.rgb,1).multiply(i.a),e}_getPixel(t){return zs(t,this.config)}};u([m(Nt)],V.prototype,"config",void 0),u([J(0,X(Hs))],V.prototype,"vertex",null),u([J(0,X(Kr))],V.prototype,"fragment",null);let Ns=class extends z{};u([m(_)],Ns.prototype,"cellSize",void 0);let Ws=class extends V{constructor(){super(...arguments),this.type="AspectShader"}_process(t){const{texture:e}=this.config,s=it(e,t,this.config.srcImageSize),i=new _(1).divide(this.aspectConfig.cellSize.multiply(8)),{x:o,y:r}=Lt(s,i),a=Pe(r),n=s[9].multiply(j(E(o).add(E(a)))),l=E(j(o)),c=new d(3.14159265359),h=new d(0),p=D(h,a).multiply(.5).multiply(c).add(D(a,h).multiply(1.5).multiply(c)),f=ms(new d(2.5).multiply(c).add(pt(a,Pe(o))),new d(2).multiply(c)),g=Z(p,f,l).multiply(180).divide(c);return new y(g,g,g,n)}};u([m(Ns)],Ws.prototype,"aspectConfig",void 0);let eo=class extends A{constructor(){super(...arguments),this.name="RasterAspectProcessor",this.type=3,this.shaders={aspect:new Ws}}_process(t,e){const s={cellSize:e.getRasterCellSize()},i=this._getCommonConfig(t,e),o={shader:this.shaders.aspect,uniforms:{config:i,aspectConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:r,context:a}=t;r.submitDrawMesh(a,o,r.quadMesh)}},$s=class extends z{};u([m(me)],$s.prototype,"bandIndexMat3",void 0);let Zs=class extends z{};u([m(w)],Zs.prototype,"adjustments",void 0);let ot=class extends V{constructor(){super(...arguments),this.type="BandArithmeticShader",this.isOutputRounded=!1}_process(t){const e=this._getPixel(t),s=this.bandArithmeticConfig.bandIndexMat3.multiply(e.rgb),i=this._processIndex(s),o=new y(i,i,i,e.a);return this.isOutputRounded?Oe(o):o}_processIndex(t){const{r:e,g:s}=t,i=this.adjustmentConfig?.adjustments;switch(this.indexType){case"ndxi":{const o=e.subtract(s),r=e.add(s);return o.multiply(B(r))}case"sr":return e.multiply(B(s));case"ci":return e.multiply(B(s)).subtract(1);case"savi":{const{x:o}=i,r=e.subtract(s),a=e.add(s).add(o);return r.multiply(B(a)).multiply(o.add(1))}case"tsavi":{const{x:o,y:r,z:a}=i,n=a.multiply(o.multiply(o).add(1)).subtract(r.multiply(o)),l=o.multiply(e.subtract(o.multiply(s)).subtract(r)),c=r.multiply(e).add(s).add(n);return l.multiply(B(c))}case"msavi":{const o=e.multiply(2).add(1),r=o.multiply(o).subtract(e.subtract(s).multiply(8));return o.subtract(oe(r)).multiply(.5)}case"gemi":{const o=e.multiply(e).subtract(s.multiply(s)).multiply(2).add(e.multiply(1.5)).add(s.multiply(.5)),r=e.add(s).add(.5),a=o.multiply(B(r)),n=a.multiply(Ie(a.multiply(.25))),l=s.subtract(.125).multiply(B(Ie(s)));return n.subtract(l)}case"pvi":{const{x:o,y:r}=i,a=oe(o.multiply(o).add(1));return e.subtract(s.multiply(o)).subtract(r).multiply(B(a))}case"vari":{const o=t.g.subtract(t.r),r=t.g.add(t.r).subtract(t.b);return o.multiply(B(r))}case"rtvicore":return e.subtract(s).multiply(100).subtract(e.subtract(t.b).multiply(10));case"bai":{const o=le(new d(.1).subtract(s),new d(2)),r=le(new d(.06).subtract(e),new d(2));return B(o.add(r))}case"evi":{const o=t.b,r=e.add(s.multiply(6)).subtract(o.multiply(7.5)).add(1);return e.subtract(s).multiply(2.5).multiply(B(r))}case"wndwi":{const{r:o,g:r,b:a}=t,n=i.x,l=n.multiply(r),c=n.multiply(a),h=o.add(l).add(a).subtract(c);return o.subtract(l).subtract(a).add(c).multiply(B(h))}case"mtvi":{const o=t.b,r=le(e.multiply(2).add(1),new d(2)),a=e.multiply(6).subtract(oe(s).multiply(5)),n=oe(r.subtract(a).subtract(.5)),l=e.subtract(o).multiply(1.2),c=s.subtract(o).multiply(2.5);return l.subtract(c).multiply(1.5).multiply(B(n))}default:return e}}};u([v],ot.prototype,"indexType",void 0),u([v],ot.prototype,"isOutputRounded",void 0),u([m($s)],ot.prototype,"bandArithmeticConfig",void 0),u([ne(Zs)],ot.prototype,"adjustmentConfig",void 0);let to=class extends A{constructor(){super(...arguments),this.name="RasterBandArithmeticProcessor",this.type=4,this.shaders={bandArithmetic:new ot}}_process(t,e){const s=t.rasterFunction.parameters,i={indexType:s.indexType,isOutputRounded:s.isOutputRounded},o={bandIndexMat3:s.bandIndexMat3},r=s.adjustments?{adjustments:[...s.adjustments]}:void 0,a=this._getCommonConfig(t,e),n={shader:this.shaders.bandArithmetic,uniforms:{config:a,bandArithmeticConfig:o,adjustmentConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=t;l.submitDrawMesh(c,n,l.quadMesh)}},Qs=class extends V{constructor(){super(...arguments),this.type="ColormapToRGBShader"}_process(t){const e=this._getPixel(t),s=st(e,new d(1),this.colormapConfig,!1);return new y(s.xyz.multiply(255),s.a)}};u([m(de)],Qs.prototype,"colormapConfig",void 0);let so=class extends A{constructor(){super(...arguments),this.name="RasterColormapToRGBProcessor",this.type=5,this.shaders={colormapToRGB:new Qs}}_process(t,e,s){const i=t.rasterFunction.parameters,o={colormapTexture:{texture:s,unit:1},colormapOffset:i.offset,colormapMaxIndex:i.indexedColormap.length/4-1},r=this._getCommonConfig(t,e),a={shader:this.shaders.colormapToRGB,uniforms:{config:r,colormapConfig:o},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}},Rt=class extends z{};u([m(O)],Rt.prototype,"image1",void 0),u([m(d)],Rt.prototype,"image1Const",void 0),u([m(me)],Rt.prototype,"imageSwap",void 0);let Ve=class extends z{};u([m(O)],Ve.prototype,"image1",void 0),u([m(O)],Ve.prototype,"image2",void 0),u([m(d)],Ve.prototype,"image1Const",void 0),u([m(d)],Ve.prototype,"image2Const",void 0),u([m(me)],Ve.prototype,"imageSwap",void 0);const Wt=t=>{const e=t;class s extends e{constructor(){super(...arguments),this.constantCount=0,this.imageCount=1}_getRasterValues(o){const{imageCount:r}=this;if(r===1){const a=I(this.config.texture,o);return{a:a.r,b:a.g,c:a.b,alpha:a.a}}if(r===2){const a=this._getTwoValues(o);return{a:a.a,b:a.b,c:a.b,alpha:a.alpha}}return this._getThreeValues(o)}_getTwoValues(o){const r=I(this.config.texture,o);if(this.constantCount===1){const{imageSwap:l,image1Const:c}=this.twoRasterConfig,h=l.multiply(new w(r.r,c,0));return{a:h.x,b:h.y,alpha:r.a}}const{image1:a}=this.twoRasterConfig,n=I(a,o);return{a:r.r,b:n.r,alpha:r.a.multiply(n.a)}}_getThreeValues(o){const r=I(this.config.texture,o),{imageSwap:a,image1:n,image2:l,image1Const:c,image2Const:h}=this.threeRasterConfig;if(this.constantCount===2){const g=a.multiply(new w(r.r,c,h));return{a:g.x,b:g.y,c:g.z,alpha:r.a}}if(this.constantCount===1){const g=I(n,o),x=a.multiply(new w(r.r,g.r,c));return{a:x.x,b:x.y,c:x.z,alpha:r.a.multiply(g.a)}}const p=I(n,o),f=I(l,o);return{a:r.r,b:p.r,c:f.r,alpha:r.a.multiply(p.a).multiply(f.a)}}}return u([v],s.prototype,"constantCount",void 0),u([v],s.prototype,"imageCount",void 0),u([ne(Rt)],s.prototype,"twoRasterConfig",void 0),u([ne(Ve)],s.prototype,"threeRasterConfig",void 0),s};let io=class extends Wt(V){constructor(){super(...arguments),this.type="CompositeBandShader"}_process(t){const{a:e,b:s,c:i,alpha:o}=this._getRasterValues(t);return new y(e,s,i,o)}},ro=class extends A{constructor(){super(...arguments),this.name="RasterCompositeBandProcessor",this.type=6,this.shaders={compositeBand:new io}}_process(t,e){const{rasters:s}=t.rasterFunction.parameters,i={constantCount:this._getConstantCount(s),imageCount:s?.length??1},o=this._getMultipleInputConfig(e,s),r=this._getCommonConfig(t,e),a={shader:this.shaders.compositeBand,uniforms:{config:r,...o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}};class $t extends z{}u([m(_)],$t.prototype,"domainRange",void 0);class Pt extends Wt(V){constructor(){super(...arguments),this.type="LocalShader",this.isOutputRounded=!1}_process(e){if(this.operationName==="conditional")return this._conditional(e);const{a:s,b:i,alpha:o}=this._getRasterValues(e),{value:r,alpha:a}=this._compute(s,i,o);return this._processResult(r,a)}_processResult(e,s){const i=qs(e,this.domainRangeConfig.domainRange),o=new y(e,e,e,s).multiply(i);return this.isOutputRounded?Oe(o):o}_compute(e,s,i){const{operationName:o}=this;let r;switch(o){case"plus":r=e.add(s);break;case"minus":r=e.subtract(s);break;case"times":r=e.multiply(s);break;case"divide":case"floatdivide":r=e.multiply(B(s)),i=i.multiply(H(E(j(s))));break;case"floordivide":r=ae(e.multiply(B(s))),i=i.multiply(H(E(j(s))));break;case"square":r=e.multiply(e);break;case"sqrt":r=oe(e);break;case"power":r=le(e,s);break;case"ln":r=Y(fe(e,new d(0)),rr(e),new d(0)),i=i.multiply(this._isAboveZero(e));break;case"log10":r=Y(fe(e,new d(0)),At(e).multiply(B(At(new d(10)))),new d(0)),i=i.multiply(this._isAboveZero(e));break;case"log2":r=Y(fe(e,new d(0)),At(e),new d(0)),i=i.multiply(this._isAboveZero(e));break;case"exp":r=ir(e);break;case"exp10":r=le(new d(10),e);break;case"exp2":r=le(new d(2),e);break;case"rounddown":r=ae(e);break;case"roundup":r=sr(e);break;case"int":r=j(e).multiply(ae(E(e)));break;case"mod":r=ms(e,s);break;case"negate":r=Pe(e);break;case"abs":r=E(e);break;case"acos":{const a=this._isAbsBiggerThanOne(e);r=Y(a,new d(0),tr(e)),i=Y(a,new d(0),i);break}case"acosh":r=er(e);break;case"asin":{const a=this._isAbsBiggerThanOne(e);r=Y(a,new d(0),Ki(e)),i=Y(a,new d(0),i);break}case"asinh":r=Xi(e);break;case"atan":r=pt(e);break;case"atanh":{const a=this._isAbsBiggerThanOne(e);r=Y(a,new d(0),Ji(e)),i=Y(a,new d(0),i);break}case"atan2":r=pt(e,s);break;case"cos":r=Yi(e);break;case"cosh":r=Qi(e);break;case"sin":r=Zi(e);break;case"sinh":r=$i(e);break;case"tan":r=Wi(e);break;case"tanh":r=Ni(e);break;case"bitwiseand":r=new d(Hi(new S(e),new S(s)));break;case"bitwiseor":r=new d(Ei(new S(e),new S(s)));break;case"bitwiseleftshift":r=new d(ji(new S(e),new S(s)));break;case"bitwiserightshift":r=new d(Li(new S(e),new S(s)));break;case"bitwisenot":r=new d(Ui(new S(e)));break;case"bitwisexor":r=new d(qi(new S(e),new S(s)));break;case"booleanand":r=H(Gi(ge(e,new d(0)),ge(s,new d(0))));break;case"booleanor":r=H(Ai(ge(e,new d(0)),ge(s,new d(0))));break;case"booleannot":r=H(Fe(e,new d(0)));break;case"booleanxor":r=H(Vi(ge(e,new d(0)),ge(s,new d(0))));break;case"greaterthan":r=H(fe(e,s));break;case"greaterthanequal":r=H(Bi(e,s));break;case"lessthan":r=H(Vt(e,s));break;case"lessthanequal":r=H(ds(e,s));break;case"equalto":r=H(Fe(e,s));break;case"notequal":r=H(ge(e,s));break;case"isnull":r=H(Fe(i,new d(0))),i=new d(1);break;case"setnull":{const a=H(Fe(e,new d(0)));r=a.multiply(s),i=i.multiply(a);break}default:r=e}return{value:r,alpha:i}}_conditional(e){const{a:s,b:i,c:o,alpha:r}=this._getRasterValues(e),a=new d(E(j(s))),n=Z(o,i,a);return this._processResult(n,r)}_isAboveZero(e){return H(fe(e,new d(0)))}_isAbsBiggerThanOne(e){return fe(E(e),new d(1))}}u([v],Pt.prototype,"operationName",void 0),u([v],Pt.prototype,"isOutputRounded",void 0),u([m($t)],Pt.prototype,"domainRangeConfig",void 0);let Ft=class extends Wt(V){constructor(){super(...arguments),this.type="ComputeChangeShader",this.isOutputRounded=!1}_process(t){const{a:e,b:s,alpha:i}=this._getRasterValues(t);let o=e.subtract(s);this.method==="relative-difference"&&(o=o.multiply(B($e(E(e),E(s)))));const r=qs(o,this.domainRangeConfig.domainRange),a=new y(o,o,o,i).multiply(r);return this.isOutputRounded?Oe(a):a}};u([v],Ft.prototype,"method",void 0),u([v],Ft.prototype,"isOutputRounded",void 0),u([m($t)],Ft.prototype,"domainRangeConfig",void 0);let oo=class extends A{constructor(){super(...arguments),this.name="RasterComputeChangeProcessor",this.type=7,this.shaders={computeChange:new Ft}}_process(t,e){const s=t.rasterFunction.parameters,{rasters:i}=s,o={constantCount:this._getConstantCount(i),imageCount:i.length,method:s.method,isOutputRounded:s.isOutputRounded},r={domainRange:s.domainRange},{twoRasterConfig:a}=this._getMultipleInputConfig(e,i),n=this._getCommonConfig(t,e),l={shader:this.shaders.computeChange,uniforms:{config:n,domainRangeConfig:r,twoRasterConfig:a},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,l,c.quadMesh)}},Zt=class extends z{};u([m(d)],Zt.prototype,"contrastOffset",void 0),u([m(d)],Zt.prototype,"brightnessOffset",void 0);let Ys=class extends V{constructor(){super(...arguments),this.type="ContrastBrightnessShader"}_process(t){const{rgb:e,a:s}=this._getPixel(t),{contrastOffset:i,brightnessOffset:o}=this.contrastBrightnessConfig,r=new d(255),a=new d(128),n=e.multiply(200),l=r.multiply(100),c=r.multiply(2).multiply(o),h=n.subtract(l).add(c),p=or([Fe(i,new d(-100)),new w(a)],[Fe(i,new d(100)),j(h).add(1).divide(2).multiply(r)],[fe(i,new d(0)),h.divide(new d(100).subtract(i).multiply(2)).add(a)],[!0,h.multiply(i.add(100)).divide(2e4).add(a)]);return Oe(new y(p,s))}};u([m(Zt)],Ys.prototype,"contrastBrightnessConfig",void 0);let ao=class extends A{constructor(){super(...arguments),this.name="RasterContrastBrightnessProcessor",this.type=8,this.shaders={contrastBrightness:new Ys}}_process(t,e){const s=this._getCommonConfig(t,e),i=t.rasterFunction.parameters,o={shader:this.shaders.contrastBrightness,uniforms:{config:s,contrastBrightnessConfig:i},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:r,context:a}=t;r.submitDrawMesh(a,o,r.quadMesh)}};class Qt extends z{}u([m(nr.ofType(d,5,5,!0))],Qt.prototype,"kernel",void 0),u([m(_)],Qt.prototype,"clampRange",void 0);let It=class extends V{constructor(){super(...arguments),this.type="ConvolutionShader",this.rows=3,this.cols=3}_process(t){const{rows:e,cols:s}=this,i=new _(Math.floor(e/2),Math.floor(s/2)),{texture:o,srcImageSize:r}=this.config,a=new d(1).divide(r),{kernel:n}=this.convolutionConfig,l=ar(n,{initialValue:new y(0,0,0,1),xRange:[0,e],yRange:[0,s],callback:(h,p,f,g)=>{const x=new _(new d(f),new d(g)).subtract(i).multiply(a),b=I(o,W(t.add(x))),C=b.rgb.multiply(p).add(h.rgb),k=b.a.multiply(h.a);return new y(C,k)}}),{clampRange:c}=this.convolutionConfig;return new y(te(l.rgb,c.x,c.y),1).multiply(l.a)}};u([v],It.prototype,"rows",void 0),u([v],It.prototype,"cols",void 0),u([m(Qt)],It.prototype,"convolutionConfig",void 0);let no=class extends A{constructor(){super(...arguments),this.name="RasterConvolutionProcessor",this.type=9,this.shaders={convolution:new It}}_process(t,e){const s=t.rasterFunction.parameters,i={rows:s.kernelRows,cols:s.kernelCols},o={kernel:[...s.kernel],clampRange:s.clampRange},r=this._getCommonConfig(t,e),a={shader:this.shaders.convolution,uniforms:{config:r,convolutionConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}},Js=class extends z{};u([m(d)],Js.prototype,"zlFactor",void 0);let Yt=class extends V{constructor(){super(...arguments),this.type="CurvatureShader"}_process(t){const{texture:e}=this.config,s=it(e,t,this.config.srcImageSize),i=s[3].add(s[5]).multiply(.5).subtract(s[4]),o=s[1].add(s[7]).multiply(.5).subtract(s[4]),{zlFactor:r}=this.curvatureConfig,{curvatureType:a}=this;let n;if(a==="standard")n=Pe(r).multiply(i.add(o));else{const l=s[2].subtract(s[0]).add(s[6]).subtract(s[8]).divide(4),c=s[5].subtract(s[3]).divide(2),h=s[1].subtract(s[7]).divide(2),p=c.multiply(c),f=h.multiply(h),g=c.multiply(h),x=r.divide(p.add(f));n=a==="profile"?Q(new w(i,o,l),new w(p,f,g)).multiply(x):Q(new w(i,o,Pe(l)),new w(f,p,g)).multiply(Pe(x))}return new y(n,n,n,s[9])}};u([v],Yt.prototype,"curvatureType",void 0),u([m(Js)],Yt.prototype,"curvatureConfig",void 0);let lo=class extends A{constructor(){super(...arguments),this.name="RasterCurvatureProcessor",this.type=10,this.shaders={curvature:new Yt}}_process(t,e){const s=t.rasterFunction.parameters,i={curvatureType:s.curvatureType},o=e.getRasterCellSize(),r={zlFactor:200*s.zFactor/o[0]/o[1]},a=this._getCommonConfig(t,e),n={shader:this.shaders.curvature,uniforms:{config:a,curvatureConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=t;l.submitDrawMesh(c,n,l.quadMesh)}},Xs=class extends z{};u([m(me)],Xs.prototype,"bandIndexMat3",void 0);let Ks=class extends V{constructor(){super(...arguments),this.type="ExtractBandShader"}_process(t){const e=this._getPixel(t),s=this.extractBandConfig.bandIndexMat3.multiply(e.rgb);return new y(s,e.a)}};u([m(Xs)],Ks.prototype,"extractBandConfig",void 0);let uo=class extends A{constructor(){super(...arguments),this.name="RasterExtractBandProcessor",this.type=11,this.shaders={extractBand:new Ks}}_process(t,e){const s={bandIndexMat3:t.rasterFunction.parameters.bandIndexMat3},i=this._getCommonConfig(t,e),o={shader:this.shaders.extractBand,uniforms:{config:i,extractBandConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:r,context:a}=t;r.submitDrawMesh(a,o,r.quadMesh)}},ei=class extends z{};u([m(_)],ei.prototype,"clampRange",void 0);class Ae extends V{constructor(){super(...arguments),this.type="FocalStatisticsShader",this.rows=3,this.cols=3,this.fill=!1}_process(e){const s=this._process1(e),i=D(new d(1),s.a);if(!this.fill)return this._clamp(s.rgb,i);const o=this._getPixel(e),r=Z(s.rgb,o.rgb,o.a);return this._clamp(r,i)}_clamp(e,s){const{clampRange:i}=this.focalStatisticsConfig;return new y(te(e,i.x,i.y),1).multiply(s)}_process1(e){const{texture:s,srcImageSize:i}=this.config,{rows:o,cols:r}=this,a=new _(Math.floor(o/2),Math.floor(r/2)),n=new d(1).divide(i),l=this._getPixel(e),{statisticsType:c}=this,h=c==="min"||c==="max"?new y(l.rgb,0):new y(0,0,0,0);switch(c){case"min":return this._stat(o,r,h,(p,f,g)=>{const x=new _(new d(f),new d(g)).subtract(a).multiply(n),b=I(s,W(e.add(x))),C=We(p.rgb,b.rgb);return new y(C,p.a.add(b.a))});case"max":return this._stat(o,r,h,(p,f,g)=>{const x=new _(new d(f),new d(g)).subtract(a).multiply(n),b=I(s,W(e.add(x))),C=$e(p.rgb,b.rgb);return new y(C,p.a.add(b.a))});case"mean":{const p=this._stat(o,r,h,(g,x,b)=>{const C=new _(new d(x),new d(b)).subtract(a).multiply(n),k=I(s,W(e.add(C))),R=g.rgb.add(k.rgb.multiply(k.a));return new y(R,g.a.add(k.a))}),f=p.rgb.multiply(B(p.a));return new y(f,p.a)}case"stddev":{const p=this._stat(o,r,h,(b,C,k)=>{const R=new _(new d(C),new d(k)).subtract(a).multiply(n),U=I(s,W(e.add(R))),$=b.rgb.add(U.rgb.multiply(U.a));return new y($,b.a.add(U.a))}),f=this._stat(o,r,h,(b,C,k)=>{const R=new _(new d(C),new d(k)).subtract(a).multiply(n),U=I(s,W(e.add(R))),$=b.rgb.add(U.a.multiply(U.rgb).multiply(U.rgb));return new y($,b.a.add(U.a))}),g=B(f.a),x=oe(f.subtract(p.multiply(p).multiply(g)).multiply(g));return new y(x.rgb,p.a)}default:return l}}_stat(e=3,s=3,i,o){const r=new S(0).setMutable().setDebugName("StatColIterator"),a=new S(0).setMutable().setDebugName("StatRowIterator"),n=i.setMutable().setDebugName("StatAccumulator"),l=o(n,r,a).setDebugName("StatPredicate");return lr({iterX:r,iterY:a,accumulator:n},y,l,({out:c,iterX:h,iterY:p,accumulator:f,subgraph:g})=>`
  for (${p} = 0; ${p} < ${e}; ${p}++) {
    for (${h} = 0; ${h} < ${s}; ${h}++) {
  
    ${g.body}
  
    ${f} = ${g.varName};
    }
  }
  ${c} = ${f};
  `).setDebugName("statBody")}}u([v],Ae.prototype,"rows",void 0),u([v],Ae.prototype,"cols",void 0),u([v],Ae.prototype,"statisticsType",void 0),u([v],Ae.prototype,"fill",void 0),u([m(ei)],Ae.prototype,"focalStatisticsConfig",void 0);class co extends A{constructor(){super(...arguments),this.name="RasterFocalStatisticsProcessor",this.type=21,this.shaders={focalStatistics:new Ae}}_process(e,s){const i=e.rasterFunction.parameters,o={rows:i.kernelRows,cols:i.kernelCols,statisticsType:i.statisticsType,fill:i.fillNoDataOnly},r={clampRange:i.clampRange},a=this._getCommonConfig(e,s),n={shader:this.shaders.focalStatistics,uniforms:{config:a,focalStatisticsConfig:r},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}}class ti extends z{}u([m(w)],ti.prototype,"weights",void 0);let si=class extends V{constructor(){super(...arguments),this.type="GrayscaleShader"}_process(t){const e=this._getPixel(t),{weights:s}=this.grayscaleConfig,i=Q(s,e.rgb);return new y(i,i,i,e.a)}};u([m(ti)],si.prototype,"grayscaleConfig",void 0);let ho=class extends A{constructor(){super(...arguments),this.name="RasterGrayscaleProcessor",this.type=12,this.shaders={grayscale:new si}}_process(t,e){const s={weights:t.rasterFunction.parameters.weights},i=this._getCommonConfig(t,e),o={shader:this.shaders.grayscale,uniforms:{config:i,grayscaleConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:r,context:a}=t;r.submitDrawMesh(a,o,r.quadMesh)}},zt=class extends V{constructor(){super(...arguments),this.type="HillshadeShader",this.isMultidirectional=!1}_process(t){const{texture:e}=this.config,s=it(e,t,this.config.srcImageSize),i=As(s,this.hillshadeConfig,this.isMultidirectional);return new y(i.rgb.multiply(255),i.a)}};u([v],zt.prototype,"isMultidirectional",void 0),u([m(ue)],zt.prototype,"hillshadeConfig",void 0);let po=class extends A{constructor(){super(...arguments),this.name="RasterHillshadeProcessor",this.type=13,this.shaders={hillshade:new zt}}_process(t,e){const s=t.rasterFunction.parameters,i={isMultidirectional:s.hillshadeType>0},o=e.getRasterCellSize(),r=Gs(s,o),a={...s,factor:r,minValue:0,maxValue:8e3},n=this._getCommonConfig(t,e),l={shader:this.shaders.hillshade,uniforms:{config:n,hillshadeConfig:a},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,l,c.quadMesh)}},mo=class extends A{constructor(){super(...arguments),this.name="RasterLocalProcessor",this.type=14,this.shaders={local:new Pt}}_process(t,e){const s=t.rasterFunction.parameters,i={constantCount:this._getConstantCount(s.rasters),imageCount:s.imageCount,operationName:s.operationName,isOutputRounded:s.isOutputRounded},o={domainRange:s.domainRange},r=s.operationName==="conditional"?s.rasters:s.rasters?.slice(0,2),a=this._getMultipleInputConfig(e,r),n=this._getCommonConfig(t,e),l={shader:this.shaders.local,uniforms:{config:n,domainRangeConfig:o,...a},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,l,c.quadMesh)}};class Jt extends z{}u([m(se.ofType(d,6))],Jt.prototype,"includedRanges",void 0),u([m(se.ofType(d,ee))],Jt.prototype,"noDataValues",void 0);let Xt=class extends V{constructor(){super(...arguments),this.type="MaskShader",this.isMultiband=!0}_process(t){const e=this._getPixel(t),s=this._computeNoDataFactor(e.r),i=this._computeRangeFactor(e.rgb);let o;if(this.isMultiband){const r=this._computeNoDataFactor(e.g),a=this._computeNoDataFactor(e.b),n=new w(s,r,a).multiply(i);o=n.x.multiply(n.y).multiply(n.z)}else o=s.multiply(i.x);return e.multiply(o)}_computeNoDataFactor(t){const{noDataValues:e}=this.maskConfig;let s=new w(1);for(let i=0;i<ee/3;i++){const o=3*i,r=new w(e[o+0],e[o+1],e[o+2]),a=E(j(r.subtract(t)));s=s.multiply(a)}return s.x.multiply(s.y).multiply(s.z)}_computeRangeFactor(t){const{includedRanges:e}=this.maskConfig,s=new w(e[0],e[2],e[4]),i=new w(e[1],e[3],e[5]);return D(s,t).multiply(D(t,i))}};u([v],Xt.prototype,"isMultiband",void 0),u([m(Jt)],Xt.prototype,"maskConfig",void 0);let go=class extends A{constructor(){super(...arguments),this.name="RasterMaskProcessor",this.type=15,this.shaders={mask:new Xt}}_process(t,e){const s=t.rasterFunction.parameters,i={isMultiband:s.bandCount>1},o={includedRanges:[...s.includedRanges],noDataValues:[...s.noDataValues]},r=this._getCommonConfig(t,e),a={shader:this.shaders.mask,uniforms:{config:r,maskConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}};class ii extends z{}u([m(me)],ii.prototype,"bandIndexMat3",void 0);class Kt extends V{constructor(){super(...arguments),this.type="NDVIShader",this.scaled=!0}_process(e){const s=this._getPixel(e),{r:i,g:o}=this.ndviConfig.bandIndexMat3.multiply(s.rgb),r=i.subtract(o),a=i.add(o),n=r.multiply(B(a));if(!this.scaled)return new y(n,n,n,s.a);const l=ae(n.multiply(100).add(100.5));return new y(l,l,l,s.a)}}u([v],Kt.prototype,"scaled",void 0),u([m(ii)],Kt.prototype,"ndviConfig",void 0);let fo=class extends A{constructor(){super(...arguments),this.name="RasterNDVIProcessor",this.type=16,this.shaders={ndvi:new Kt}}_process(t,e){const s=t.rasterFunction.parameters,i={scaled:s.scaled},o={bandIndexMat3:s.bandIndexMat3},r=this._getCommonConfig(t,e),a={shader:this.shaders.ndvi,uniforms:{config:r,ndviConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}};class Ge extends z{}u([m(se.ofType(d,3*ee))],Ge.prototype,"rangeMaps",void 0),u([m(se.ofType(d,2*ee))],Ge.prototype,"noDataRanges",void 0),u([m(d)],Ge.prototype,"unmatchMask",void 0),u([m(d)],Ge.prototype,"replacementValue",void 0),u([m(_)],Ge.prototype,"clampRange",void 0);class es extends V{constructor(){super(...arguments),this.type="RemapShader"}_process(e){const s=this._getPixel(e),{rangeMaps:i,unmatchMask:o,clampRange:r,replacementValue:a}=this.remapConfig,{mapValue:n,includeMask:l}=Wr(s.r,i,ee),c=this.replaceUnmatched?a:o.multiply(s.r),h=Z(c,n,l),p=te(h,r.x,r.y),f=this._computeNoDataFactor(s.rrr).multiply($e(o,l));return new y(p,p,p,s.a).multiply(f)}_computeNoDataFactor(e){const{noDataRanges:s}=this.remapConfig;let i=new w(0,0,0);for(let o=0;o<ee/3;o++){const r=6*o,a=new w(s[r],s[r+2],s[r+4]),n=new w(s[r+1],s[r+3],s[r+5]);i=i.add(D(a,e).multiply(D(e,n)))}return Ie(j(Q(i,new w(1,1,1))))}}u([m(Ge)],es.prototype,"remapConfig",void 0),u([v],es.prototype,"replaceUnmatched",void 0);class yo extends A{constructor(){super(...arguments),this.name="RasterRemapProcessor",this.type=17,this.shaders={remap:new es}}_process(e,s){const i=e.rasterFunction.parameters,o={replaceUnmatched:i.allowUnmatched&&i.replacementValue!=null},r={rangeMaps:[...i.rangeMaps],noDataRanges:[...i.noDataRanges],unmatchMask:i.allowUnmatched?1:0,replacementValue:i.replacementValue??0,clampRange:i.clampRange},a=this._getCommonConfig(e,s),n={shader:this.shaders.remap,uniforms:{config:a,remapConfig:r},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}}let xo=class extends G{constructor(){super(...arguments),this.type="ReprojectShader"}_colorize(t){return this._getPixel(t)}},wo=class extends A{constructor(){super(...arguments),this.name="RasterReprojectProcessor",this.type=18,this.shaders={reproject:new xo}}_process(t,e){const s=t.rasterFunction.parameters,i=this._getInterpolationDefines(e.interpolation,!!s.requireNNEdge),{config:o,projectionConfig:r,projectionDefines:a}=this._getReprojectConfig(e),n={shader:this.shaders.reproject,uniforms:{config:o,projectionConfig:r},defines:{...a,...i,applyPixelMask:!1,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1},{interpolation:l}=e;e.interpolation="nearest";const{painter:c,context:h}=t;c.submitDrawMesh(h,n,c.quadMesh),e.interpolation=l,e.projected=!0}_getReprojectConfig(t){const{source:e}=t,{names:s,textures:i}=t.getTextures({forProcessing:!0}),o={texture:{texture:i[s.indexOf("u_image")],unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:[e.width,e.height],opacity:1},r=i[s.indexOf("u_transformGrid")],{transformGrid:a}=t,n=!(!r||!a);return{config:o,projectionConfig:n?{transformTexture:{texture:r,unit:1},targetImageSize:[t.width,t.height],transformSpacing:a.spacing,transformGridSize:a.size}:void 0,projectionDefines:{applyProjection:n,lookupProjection:n&&a.spacing[0]===1}}}_getInterpolationDefines(t,e){const s=t==="bilinear"&&e;return{bilinear:s,bicubic:t==="cubic",nearestOnEdge:s}}};class ri extends zt{constructor(){super(...arguments),this.type="ShadedReliefShader"}_process(e){const s=super._process(e),{minValue:i,maxValue:o}=this.hillshadeConfig,r=this._getPixel(e),a=o.subtract(i),n=r.r.subtract(i),l=te(n.divide(a),new d(0),new d(1)),c=st(new y(l,l,l,1),new d(255),this.colormapConfig),h=Bs(c.xyz),p=Vs(new w(h.xy,s.x.divide(255))).multiply(255);return new y(p,c.a.multiply(s.a))}}u([m(de)],ri.prototype,"colormapConfig",void 0);let bo=class extends A{constructor(){super(...arguments),this.name="RasterShadedReliefProcessor",this.type=19,this.shaders={shadedRelief:new ri}}_process(t,e,s){const i=t.rasterFunction.parameters,o={isMultidirectional:i.hillshadeType>0},r=e.getRasterCellSize(),a=Gs(i,r),n={...i,factor:a},l={colormapTexture:{texture:s,unit:1},colormapOffset:i.offset,colormapMaxIndex:i.indexedColormap.length/4-1},c=this._getCommonConfig(t,e),h={shader:this.shaders.shadedRelief,uniforms:{config:c,hillshadeConfig:n,colormapConfig:l},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:p,context:f}=t;p.submitDrawMesh(f,h,p.quadMesh)}},at=class extends z{};u([m(d)],at.prototype,"pixelSizePower",void 0),u([m(d)],at.prototype,"pixelSizeFactor",void 0),u([m(d)],at.prototype,"zFactor",void 0),u([m(_)],at.prototype,"cellSize",void 0);let Mt=class extends V{constructor(){super(...arguments),this.type="SlopeShader",this.isOutputRounded=!1,this.percentRise=!1}_process(t){const{cellSize:e,pixelSizePower:s,pixelSizeFactor:i,zFactor:o}=this.slopeConfig,r=le(e,new _(s)).multiply(i).add(o).divide(e.multiply(8)),{texture:a}=this.config,n=it(a,t,this.config.srcImageSize),{x:l,y:c}=Lt(n,r),h=oe(l.multiply(l).add(c.multiply(c))),p=this.percentRise?h.multiply(100):pt(h).multiply(57.2957795),f=new y(p,p,p,n[9]);return this.isOutputRounded?Oe(f):f}};u([v],Mt.prototype,"isOutputRounded",void 0),u([v],Mt.prototype,"percentRise",void 0),u([m(at)],Mt.prototype,"slopeConfig",void 0);let _o=class extends A{constructor(){super(...arguments),this.name="RasterSlopeProcessor",this.type=20,this.shaders={slope:new Mt}}_process(t,e){const s=t.rasterFunction.parameters,i={isOutputRounded:s.isOutputRounded,percentRise:s.slopeType==="percent-rise"},o={cellSize:e.getRasterCellSize(),pixelSizePower:s.slopeType==="adjusted"?s.pixelSizePower:0,pixelSizeFactor:s.slopeType==="adjusted"?s.pixelSizeFactor:0,zFactor:s.zFactor},r=this._getCommonConfig(t,e),a={shader:this.shaders.slope,uniforms:{config:r,slopeConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}};class nt extends V{constructor(){super(...arguments),this.type="StretchShader",this.isMultiband=!0,this.isOutputRounded=!1,this.useGamma=!1}_process(e){const s=this._getPixel(e);let i=js(s,this.stretchConfig,this.useGamma,1);return this.isMultiband||(i=new y(i.rrr,i.a)),this.isOutputRounded?Oe(i):i}}u([v],nt.prototype,"isMultiband",void 0),u([v],nt.prototype,"isOutputRounded",void 0),u([v],nt.prototype,"useGamma",void 0),u([m(ce)],nt.prototype,"stretchConfig",void 0);class To extends A{constructor(){super(...arguments),this.name="RasterStretchProcessor",this.type=22,this.shaders={stretch:new nt}}_process(e,s){const i=e.rasterFunction.parameters,o={isMultiband:i.bandCount>1,isOutputRounded:i.isOutputRounded,useGamma:i.useGamma},r=this._getCommonConfig(e,s),a={shader:this.shaders.stretch,uniforms:{config:r,stretchConfig:i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=e;n.submitDrawMesh(l,a,n.quadMesh)}}const vo=new Map([["Aspect",eo],["BandArithmetic",to],["ColormapToRGB",so],["CompositeBand",ro],["ComputeChange",oo],["ContrastBrightness",ao],["Convolution",no],["Curvature",lo],["ExtractBand",uo],["Grayscale",ho],["Hillshade",po],["Local",mo],["Mask",go],["NDVI",fo],["Remap",yo],["Reproject",wo],["ShadedRelief",bo],["Slope",_o],["Statistics",co],["Stretch",To]]);class Co extends Ze{constructor(){super(...arguments),this.type=1,this.shaders={},this._techniques=new Map}shutdown(e){super.shutdown(e),this._fbo?.dispose(),this._fbo=void 0;for(const s of this._techniques.values())s.shutdown();this._techniques.clear()}render(e,s){this._fbo??=Fs(e.context,N,N);let{name:i}=e.rasterFunction;if(i==="Arithmetic"&&(i="Local"),!this._techniques.has(i)){const o=vo.get(i);if(!o)return;this._techniques.set(i,new o)}this._techniques.get(i).render(e,{...s,processorFbo:this._fbo})}}class So extends hs{constructor(){super(...arguments),this.isCustomTilingScheme=!1}get pixelHighlights(){return this._pixelHighlights}set pixelHighlights(e){this._pixelHighlights=e,this.children.forEach(({bitmap:s})=>s.highlightTexture=null),this.requestRender()}createTile(e){const s=this._getTileBounds(e),[i,o]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(e.level);return new zr(e,r,s[0],s[3],i,o)}onAttach(){super.onAttach(),this._colorizerTechnique=new Yr,this._processorTechnique=new Co,this._highlightTechnique=new Xr}onDetach(){super.onDetach(),this._colorizerTechnique?.shutdown(),this._colorizerTechnique=void 0,this._processorTechnique?.shutdown(),this._processorTechnique=void 0,this._highlightTechnique?.shutdown(),this._highlightTechnique=void 0}doRender(e){if(!this.visible||e.drawPhase!==1||!this._colorizerTechnique)return;const{rasterFunctionChain:s}=this;if(s?.functions?.length){if(!this._processorTechnique)return;const{functions:o,hasBranches:r}=s;for(const a of o){if(a.name==="Constant"||a.name==="Identity")continue;e.rasterFunction=a,e.hasBranches=r,super.doRender(e);const n=this.children.map(l=>l.bitmap);this._processorTechnique.render(e,{bitmaps:n})}}if(this._pixelHighlights?.length&&this._highlightTechnique)for(const o of this._pixelHighlights){e.pixelHighlightOptions=o,super.doRender(e);const r=this.children.map(a=>a.bitmap);this._highlightTechnique.render(e,{bitmaps:r})}e.rasterFunction=null,e.pixelHighlightOptions=void 0,super.doRender(e);const i=this.children.map(o=>o.bitmap);this._colorizerTechnique.render(e,{bitmaps:i})}_getTileBounds(e){const s=this.tileInfoView.getTileBounds(is(),e);if(this.isCustomTilingScheme&&e.world){const{tileInfo:i}=this.tileInfoView,o=Ii(i.spatialReference);if(o){const r=i.lodAt(e.level);if(!r)return s;const{resolution:a}=r,n=a*i.size[0];s[0]=o*e.world+i.origin.x+e.col*n,s[2]=s[0]+n}}return s}}const Ro=[0,0];let q=class extends pi{constructor(){super(...arguments),this._updatingHandles=new cr,this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState="na",this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=di(async(t={})=>{const e=this._rasterFunctionState,s=t.reprocess||e==="gpu"&&!this.canUseWebGLForProcessing||e==="cpu"&&this.canUseWebGLForProcessing;if(s&&(await this._updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters()),!this.previousLOD||this.layerView.suspended)return;const i=this._rasterFunctionState,{type:o}=this;return t.refetch||o!=="raster"&&s||i==="cpu"||e==="cpu"?this._updatingHandles.addPromise(this.doRefresh()):this._updatingHandles.addPromise(this._redrawImage(t.signal))})}destroy(){this._updatingHandles.destroy()}get canUseWebGLForProcessing(){return!1}get canUseLocalSymbolizerParams(){return(this.canUseWebGLForProcessing||this.type==="rasterVF")&&!this.layerView.hasTilingEffects}get isCPUBasedDRA(){const{renderer:t}=this.layer;return t?.type==="raster-stretch"&&t.dynamicRangeAdjustment&&(!this.canUseWebGLForProcessing||!(t.stretchType==="min-max"||t.stretchType==="standard-deviation"))}get useWebGLForProcessing(){return this._get("useWebGLForProcessing")??!0}set useWebGLForProcessing(t){this._set("useWebGLForProcessing",t)}get useProgressiveUpdate(){return this._get("useProgressiveUpdate")??!0}set useProgressiveUpdate(t){if(this._tileStrategy&&this.useProgressiveUpdate!==t){this._tileStrategy.destroy(),this.container.removeAllChildren();const e=this._getCacheSize(t);this._tileStrategy=new _s({cachePolicy:"purge",acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),cacheSize:e,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",t),this.layerView.requestUpdate()}}update(t){this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume();const{extent:e,resolution:s,scale:i}=t.state,o=this._tileInfoView.getClosestInfoForScale(i);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const r=this._srcResolutions[o.level],a="toJSON"in e?e:mi.fromJSON(e);xs(this._blockCacheRegistryUrl,this._blockCacheRegistryId,a,s,r,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,this.previousLOD?.level!==o.level&&(this.previousLOD=o,this._symbolizerParams!=null&&this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.isCPUBasedDRA&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,this._fetchQueue.length===0&&this._redrawImage(this._abortController.signal).then(()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()}));const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(t),this.layerView.requestUpdate()}get updating(){return this._globalUpdateRequested||this._updatingHandles?.updating}attach(){const t=fs();this._maxIndexedColormapSize=4*(t.maxTextureSize||4096),this._initializeTileInfo(),this._tileInfoView=new xr(this.layerView.tileInfo,this.layerView.fullExtent);const e=this._computeFetchConcurrency();this._fetchQueue=new wr({tileInfoView:this._tileInfoView,concurrency:e,process:(i,o)=>this._fetchTile(i,o),priority:br.MAPVIEW_FETCH_QUEUE,scheduler:this.scheduler});const s=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new _s({cachePolicy:"purge",acquireTile:i=>this.acquireTile(i),releaseTile:i=>this.releaseTile(i),cacheSize:s,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,ws(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(t){const e=this.container.createTile(t);return this._updatingHandles.addPromise(this._enqueueTileFetch(e)),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,e}releaseTile(t){this._fetchQueue.abort(t.key.id),this.container.removeChild(t),t.once("detach",()=>{t.destroy(),this.layerView.requestUpdate()}),this.layerView.requestUpdate()}createEmptyTilePixelBlock(t=null){const e=t==null||t.join(",")===this._tileInfoView.tileInfo.size.join(",");if(e&&this._emptyTilePixelBlock!=null)return this._emptyTilePixelBlock;t=t||this._tileInfoView.tileInfo.size;const[s,i]=t,o=new hr({width:s,height:i,pixels:[new Uint8Array(s*i)],mask:new Uint8Array(s*i),pixelType:"u8"});return e&&(this._emptyTilePixelBlock=o),o}_getBandIds(){if(this.container&&(!("rasterFunctionChain"in this.container)||!this.container.rasterFunctionChain))return this.layer.bandIds;const{bandIds:t,raster:e}=this.layer,s="rasterFunction"in e?e.rasterFunction.rawInputBandIds:null;return t?.length&&s?.length&&e.rasterInfo.bandCount!==1?t.map(i=>s[Math.min(i,s.length-1)]):"rasterFunction"in e?s:t}updateRasterFunctionParameters(){}_fetchTile(t,e){const s=this._getFetchOptions(t.level,e.signal);return this.fetchTile(t,s)}_getFetchOptions(t,e){const{canUseWebGLForProcessing:s}=this,{layerView:i}=this,{tileInfo:o}=i,r=!o.isWrappable&&mr(i.view.spatialReference)!=null,a=s&&this.layer.raster.hasUniqueSourceStorageInfo,{layer:n}=this.layerView,l=n.serviceRasterInfo?.storageInfo.isBsqTile?n.getRawDisplayBandIds():void 0;return{allowPartialFill:!0,datumTransformation:i.datumTransformation,interpolation:s?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:a,skipRasterFunction:this.type==="raster"&&this.container.rasterFunctionChain!=null,signal:e,srcResolution:this._srcResolutions[t],timeExtent:i.timeExtent,tileInfo:o,bandIds:l,disableWrapAround:r}}_getCacheSize(t){return t?40:0}_initializeTileInfo(){const{layerView:t}=this,e=t.view.spatialReference;if(this._canUseLayerLODs()){const{origin:c,lods:h}=this.layer.tileInfo,p=h.map(({scale:g})=>g),f=ys.create({spatialReference:e,size:N,scales:p,origin:c});return t.set("tileInfo",f),void(this._srcResolutions=h.map(({resolution:g})=>({x:g,y:g})))}const{scales:s,srcResolutions:i,isCustomTilingScheme:o}=gr(this.layer.serviceRasterInfo,e,{tileSize:N,alignGlobalDatasetWithAGOL:!0}),r=ys.create({spatialReference:e,size:N,scales:s}),a=r.origin.x===0;gi(t.fullExtent);const{xmin:n,ymax:l}=t.fullExtent;(a||o&&r.origin.x>n)&&(r.origin=new fi({x:n,y:l,spatialReference:e})),this._isCustomTilingScheme=o,t.set("tileInfo",r),this._srcResolutions=i??[]}_canUseLayerLODs(){const{layer:t,layerView:e}=this;if(t.raster.tileType!=="Map")return!1;const{lods:s}=t.tileInfo,i=e.view.constraints?.effectiveLODs;return i?.length===s.length&&i.every(({scale:o},r)=>Math.abs(o-s[r].scale)<.001)}_computeFetchConcurrency(){const{blockBoundary:t}=this.layer.serviceRasterInfo.storageInfo,e=t[t.length-1];return(e.maxCol-e.minCol+1)*(e.maxRow-e.minRow+1)>64?2:10}async _enqueueTileFetch(t,e){if(!this._fetchQueue.has(t.key.id)){try{let s=t.once("detach",()=>s=void 0);const i=await this._fetchQueue.push(t.key),o=this._getBandIds();let r=!this.useProgressiveUpdate||this.isCPUBasedDRA&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&this._fetchQueue.length===0){r=!1;try{await this._redrawImage(this._abortController?.signal)}catch(l){Le(l)&&je.getLogger(this).error(l)}this._globalUpdateRequested=!1}if(!s)return;this.canUseLocalSymbolizerParams&&this._symbolizerParams==null&&this._updateSymbolizerParams();const a=this._tileInfoView.getTileCoords(Ro,t.key),n=this._tileInfoView.getTileResolution(t.key);await this.updateTileSource(t,{source:i,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:r,bandIds:o,coords:a,resolution:n}),s&&(t.once("attach",()=>this.layerView.requestUpdate()),this.container.addChild(t),s.remove())}catch(s){Le(s)||je.getLogger(this).error(s)}this.layerView.requestUpdate()}}async _redrawImage(t){if(!this.attached||this.container.children.length===0||(await this.layer.updateRenderer(),this.isCPUBasedDRA?await this._updateGlobalSymbolizerParams(t):(this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._globalSymbolizerParams=null),!this.attached||t?.aborted))return;const e=this.container.children.map(async s=>this.updateTileSymbolizerParameters(s,{local:this._symbolizerParams,global:this._globalSymbolizerParams},t));await Promise.allSettled(e),this.attached&&!t?.aborted&&this.container.requestRender()}async _updateGlobalSymbolizerParams(t){const e=this._getFetchOptions(this.previousLOD.level,t),s=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,{...e,interpolation:"nearest",requestRawData:!1,skipRasterFunction:!1});if(!s?.pixelBlock)return;const{resolution:i}=this.previousLOD,{isBsqTile:o}=this.layer.raster.rasterInfo.storageInfo,r=o?null:this._getBandIds(),a=this.layer.symbolizer.generateWebGLParameters({pixelBlock:s.pixelBlock.extractBands(r),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:i,y:i},bandIds:r});!this.canUseWebGLForProcessing&&a&&a.type==="stretch"&&this.layer.renderer&&this.layer.renderer.type==="raster-stretch"&&(a.factor=a.factor.map(n=>255*n),a.minOutput=Math.round(255*a.minOutput),a.maxOutput=Math.round(255*a.maxOutput)),this._globalSymbolizerParams=a}_updateSymbolizerParams(){const{resolution:t}=this.previousLOD,e=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:e})}_updateBlockCacheRegistry(t=!1){const{layer:e,layerView:s}=this,{raster:i}=e,{multidimensionalDefinition:o}=e.normalizeRasterFetchOptions({multidimensionalDefinition:e.multidimensionalDefinition,timeExtent:s.timeExtent}),r=i.rasterInfo.multidimensionalInfo?i.getSliceIndex(o):null,a=i.rasterInfo.storageInfo.isBsqTile?e.getRawDisplayBandIds():null,n=pr(i.rasterId,r,a);if(n!==this._blockCacheRegistryUrl){if(this._blockCacheRegistryUrl!=null&&ws(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=dr(n,i.rasterInfo),t){const{view:l}=s,c=this._tileInfoView.getClosestInfoForScale(l.scale),h=this._srcResolutions[c.level];xs(n,this._blockCacheRegistryId,l.extent,l.resolution,h,i.ioConfig.sampling)}this._blockCacheRegistryUrl=n}}async doRefresh(){if(!this.attached||!this.previousLOD||this.layerView.suspended)return;await this.layer.updateRenderer(),this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const t=[];this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,this._tileStrategy.refresh(e=>t.push(this._enqueueTileFetch(e))),await this._updatingHandles.addPromise(Promise.allSettled(t))}};u([P()],q.prototype,"_globalUpdateRequested",void 0),u([P()],q.prototype,"attached",void 0),u([P()],q.prototype,"canUseWebGLForProcessing",null),u([P()],q.prototype,"canUseLocalSymbolizerParams",null),u([P()],q.prototype,"isCPUBasedDRA",null),u([P()],q.prototype,"container",void 0),u([P()],q.prototype,"layer",void 0),u([P()],q.prototype,"layerView",void 0),u([P()],q.prototype,"scheduler",void 0),u([P()],q.prototype,"type",void 0),u([P()],q.prototype,"useWebGLForProcessing",null),u([P()],q.prototype,"useProgressiveUpdate",null),u([P()],q.prototype,"timeExtent",void 0),u([P()],q.prototype,"updating",null),q=u([Ee("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],q);let we=class extends q{constructor(){super(...arguments),this.type="raster"}get canUseWebGLForProcessing(){const{loaded:t,symbolizer:e}=this.layer;if(!t||!e)return!1;const s=e.lookup.colormapLut?.indexedColormap,i=s&&s.length>this._maxIndexedColormapSize,o=Ri(this.layer.serviceRasterInfo);return!(ss("ios")&&o>4)&&this.useWebGLForProcessing&&e.canRenderInWebGL&&!i&&!(this.layer.interpolation==="majority"&&us(this.layer))}attach(){super.attach(),this.container=new So(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}fetchTile(t,e){return this.layer.fetchTile(t.level,t.row,t.col,e)}updateRasterFunctionParameters(){const{raster:t,type:e}=this.layer,{container:s}=this;if(t.datasetFormat!=="Function"||e==="wcs")return s.rasterFunctionChain=null,s.children.forEach(f=>{const{bitmap:g}=f;g&&(g.suspended=!0,g.processed=!1,g.projected&&(g.invalidateTexture(),g.rasterTexture=null))}),void(this._rasterFunctionState="na");const i=this._rasterFunctionState,{rasterFunction:o,primaryRasters:r}=t,a=o.supportsGPU&&(!r||r.rasters.length<=1),n=a?o.flatWebGLFunctionChain:null,{renderer:l}=this.layer,c=!a||!n?.functions.length||l?.type==="raster-stretch"&&l.dynamicRangeAdjustment||!this.canUseWebGLForProcessing;s.rasterFunctionChain=c?null:this._addProjection(n);const h=o==null?"na":s.rasterFunctionChain?"gpu":"cpu",p=i===h||i==="na"&&h==="cpu"&&n?.functions?.length===0;s.children.forEach(f=>{const{bitmap:g}=f;g&&(g.suspended=!p,g.processed=!1,g.processedTexture=null)}),this._rasterFunctionState=h}async updateTileSource(t,e){const s=this._getBandIds(),i=this._getLayerInterpolation(),{canUseWebGLForProcessing:o}=this,{source:r,globalSymbolizerParams:a,suspended:n,coords:l,resolution:c}=e,h=this.isCPUBasedDRA?a:e.symbolizerParams,{bitmap:p}=t;if([p.x,p.y]=l,p.resolution=c,r?.pixelBlock!=null){const x={extent:r.extent,pixelBlock:r.pixelBlock,srcPixelSize:r.srcTilePixelSize};if(p.rawPixelData=x,o)p.source=r.pixelBlock,p.isRendereredSource=!1;else{const b=await this.layer.applyRenderer(x,a?.type==="stretch"?a:void 0);p.source=b,p.isRendereredSource=!0}p.symbolizerParameters=o?h:null,p.transformGrid=o?r.transformGrid:null}else{const x=this.createEmptyTilePixelBlock();p.source=x,p.symbolizerParameters=o?h:null,p.transformGrid=null}const{isBsqTile:f}=this.layer.raster.rasterInfo.storageInfo;p.bandIds=o&&!f?s:null,p.width=this._tileInfoView.tileInfo.size[0],p.height=this._tileInfoView.tileInfo.size[1],p.interpolation=i,p.suspended=n;const{raster:g}=this.layer;if(ns(g)){const x=g.getClippingGeometry(this.layerView.view.spatialReference);if(x){const b=g.getTileExtentFromTileInfo(t.key.level,t.key.row,t.key.col,this._tileInfoView.tileInfo);b&&(p.mask=Pi({srcExtent:b,geometry:x,size:[p.width,p.height]}))}}p.invalidateTexture()}async updateTileSymbolizerParameters(t,e,s){const{local:i,global:o}=e,r=this._getBandIds(),a=this._getLayerInterpolation(),{canUseWebGLForProcessing:n}=this,{bitmap:l}=t,{rawPixelData:c}=l;n||c==null?(l.isRendereredSource&&c!=null&&(l.source=c.pixelBlock),l.isRendereredSource=!1):(l.source=await this.layer.applyRenderer(c,o?.type==="stretch"?o:void 0,{signal:s}),l.isRendereredSource=!0),l.symbolizerParameters=n?this.layerView.hasTilingEffects?o:i:null;const{isBsqTile:h}=this.layer.raster.rasterInfo.storageInfo;l.bandIds=n&&!h?r:null,l.interpolation=a,l.suspended=!1}updateHighlightOptions(t){if(!t.length)return void(this.container.pixelHighlights=void 0);const e=[],{highlights:s}=this.layerView.view;t.sort((i,o)=>s.findIndex(({name:r})=>r===qt(o.options))-s.findIndex(({name:r})=>r===qt(i.options)));for(const{target:i,options:o}of t){const{pixelRanges:r}=i,a=Array.from({length:2*ee},()=>0);for(let p=0;p<r.length;p++)a[2*p]=r[p][0],a[2*p+1]=r[p][1];for(let p=r.length;p<ee;p++)a[2*p]=rs,a[2*p+1]=-rs;const n=i.bandId??0,l=qt(o),c=s.find(p=>p.name===l)?.color??_r,h=yi.toUnitRGBA(c);e.push({ranges:a,bandId:n,color:h})}this.container.pixelHighlights=e}_getLayerInterpolation(){const{interpolation:t,renderer:e}=this.layer;if(!e)return t;const s=e.type;return s==="raster-colormap"||s==="unique-value"?"nearest":e.type==="raster-stretch"&&e.colorRamp!=null?t==="bilinear"||t==="cubic"?"bilinear":"nearest":t}_addProjection(t){return t?.functions?.length&&!t.hasFocalFunction&&t.functions.unshift({name:"Reproject",parameters:{targetImageSize:this._tileInfoView.tileInfo.size,requireNNEdge:t.isSourceSingleBand},pixelType:"f32",id:0,isNoopProcess:!1}),t}};u([P()],we.prototype,"canUseWebGLForProcessing",null),u([P()],we.prototype,"container",void 0),u([P()],we.prototype,"layer",void 0),u([P()],we.prototype,"type",void 0),we=u([Ee("esri.views.2d.layers.imagery.ImageryTileView2D")],we);class Po extends cs{constructor(e,s,i,o,r,a,n=null){super(e,s,i,o,r,a),this.tileData=new Ti(n),this.tileData.coordScale=[r,a],this.tileData.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{displayViewScreenMat3:Ne(),tileMat3:Ne()}}setTransform(e){super.setTransform(e);const s=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[o,r]=this.tileData.offset,a=[this.x+o*this.resolution,this.y-r*this.resolution],[n,l]=e.toScreenNoRotation([0,0],a),{symbolTileSize:c}=this.tileData.symbolizerParameters,h=Math.round((this.width-this.tileData.offset[0])/c)*c,p=Math.round((this.height-this.tileData.offset[1])/c)*c,f=h/this.rangeX*s,g=p/this.rangeY*s;xi(i,f,0,0,0,g,0,n,l,1),ts(this.transforms.displayViewScreenMat3,e.displayViewMat3,i),this.tileData.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class Fo extends hs{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(e){const s=this.tileInfoView.getTileBounds(is(),e),[i,o]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(e.level);return new Po(e,r,s[0],s[3],i,o)}prepareRenderPasses(e){const s=e.registerRenderPass({name:"imagery (vf tile)",brushes:[vi],target:()=>this.children.map(i=>i.tileData),drawPhase:1});return[...super.prepareRenderPasses(e),s]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(s=>{e.renderPass=s,super.doRender(e)})}}let qe=class extends q{constructor(){super(...arguments),this._handle=null,this.type="rasterVF"}async fetchTile(t,e){e={...e,interpolation:"nearest",requestProjectedLocalDirections:!0};const s=await this.layer.fetchTile(t.level,t.row,t.col,e);return this.layer.serviceRasterInfo?.dataType==="vector-magdir"&&s?.pixelBlock&&(s.pixelBlock=await this.layer.convertVectorFieldData(s.pixelBlock,"vector-magdir",e)),s}updateTileSource(t,e){const s=e.symbolizerParams,{tileData:i}=t;i.key=t.key,i.width=this._tileInfoView.tileInfo.size[0],i.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:o}=s,{source:r}=e;if(i.offset=this._getTileSymbolOffset(i.key,o),r?.pixelBlock!=null){const a={extent:r.extent,pixelBlock:r.pixelBlock};i.rawPixelData=a,i.symbolizerParameters=s,i.source=this._sampleVectorFieldData(r.pixelBlock,s,i.offset)}else{const a=[Math.round((this._tileInfoView.tileInfo.size[0]-i.offset[0])/o),Math.round((this._tileInfoView.tileInfo.size[1]-i.offset[1])/o)],n=this.createEmptyTilePixelBlock(a);i.source=n,i.symbolizerParameters=s}return i.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(t,e){const s=e.local,{symbolTileSize:i}=s,{tileData:o}=t;o.offset=this._getTileSymbolOffset(o.key,i);const r=o.symbolizerParameters.symbolTileSize;o.symbolizerParameters=s;const a=o.rawPixelData?.pixelBlock;return a!=null&&r!==i&&(o.source=this._sampleVectorFieldData(a,o.symbolizerParameters,o.offset)),Promise.resolve()}attach(){super.attach(),this.container=new Fo(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=He(()=>this.layer.renderer,t=>this._updateSymbolType(t))}detach(){super.detach(),this.container.removeAllChildren(),this._handle?.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(t,e){const s=t.col*this._tileInfoView.tileInfo.size[0]%e,i=t.row*this._tileInfoView.tileInfo.size[1]%e;return[s>e/2?e-s:-s,i>e/2?e-i:-i]}_sampleVectorFieldData(t,e,s){const{symbolTileSize:i}=e;return Fi(t,"vector-uv",i,s)}_updateSymbolType(t){t?.type==="vector-field"&&(this.container.symbolTypes=t.style==="wind-barb"?["scalar","triangle"]:t.style==="simple-scalar"?["scalar"]:["triangle"])}};u([P()],qe.prototype,"container",void 0),u([P()],qe.prototype,"layer",void 0),u([P()],qe.prototype,"type",void 0),qe=u([Ee("esri.views.2d.layers.imagery.VectorFieldTileView2D")],qe);const Io=t=>{const e=t;let s=class extends e{constructor(...i){super(...i),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){return Cr(this.layer,this.view?.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){const{renderer:i}=this.layer;return!!(i?.type==="raster-stretch"&&i.dynamicRangeAdjustment&&!(i.stretchType==="min-max"||i.stretchType==="standard-deviation"))}get datumTransformation(){try{return this.layer.loaded?fr(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(i){try{return!this.layer.loaded||!!bs(this.layer.serviceRasterInfo,i)}catch{return!1}}async fetchPopupFeaturesAtLocation(i,o){const{layer:r}=this;if(!i)throw new wi("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const{popupEnabled:a}=r,n=Sr(r,o);if(!a||n==null)return[];const l=[],{value:c,magdirValue:h,processedValue:p}=await r.identify(i,{timeExtent:this.timeExtent,signal:o?.signal});let f="";if(c?.length){f=r.type==="imagery-tile"&&r.hasStandardTime()&&c[0]!=null?c.map($=>r.getStandardTimeValue($)).join(", "):c.join(", ");const g={ObjectId:0};g[Ye.servicePixelValue]=r.type==="imagery-tile"&&ns(r.raster)?p?.join(", "):f,g[Ye.rawServicePixelValue]=f;const x=r.raster?.rasterInfo??r.serviceRasterInfo,b=x?.attributeTable;if(b!=null){const{fields:$,features:Ue}=b,lt=$.find(({name:re})=>re.toLowerCase()==="value"),kt=g[Ye.servicePixelValue],_e=lt?Ue.find(re=>String(re.attributes[lt.name])===kt):null;if(_e)for(const re in _e.attributes)_e.attributes.hasOwnProperty(re)&&(g[vr+re]=_e.attributes[re])}const C=x?.dataType;C!=="vector-magdir"&&C!=="vector-uv"||(g[Ye.magnitude]=h?.[0],g[Ye.direction]=h?.[1]);const{multidimensionalDefinition:k}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});Tr(r.rasterFields,g,k);const{graphicOrigin:R}=r,U=new bi({geometry:this.fullExtent?.clone(),attributes:g,layer:r,origin:R,sourceLayer:r});l.push(U)}return l}async getSourceScale(){return await this.layer.load(),yr(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return bs(this.layer.serviceRasterInfo,this.view.spatialReference)}};return u([P()],s.prototype,"fullExtent",null),u([P()],s.prototype,"layer",void 0),u([P({readOnly:!0})],s.prototype,"timeExtent",null),u([P()],s.prototype,"tileInfo",void 0),u([P({readOnly:!0})],s.prototype,"hasTilingEffects",null),u([P()],s.prototype,"datumTransformation",null),s=u([Ee("esri.views.layers.ImageryTileLayerView")],s),s};let be=class extends Io(Pr(Si(Rr))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this._pixelHighlights=[],this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(t){this._useWebGLForProcessing=t,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=t)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(t){this._useProgressiveUpdate=t,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=t)}get displayParameters(){const{layer:t}=this,e=this._get("displayParameters");return t.renderer&&t.visible?{bandIds:t.bandIds,renderer:t.renderer,interpolation:t.interpolation,multidimensionalDefinition:t.multidimensionalDefinition,rasterFunction:t.type==="imagery-tile"?t.rasterFunction:null}:e}update(t){this.subview?.update(t),this.notifyChange("updating")}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([He(()=>this.displayParameters,(t,e)=>{const s=t.interpolation!==e?.interpolation&&(t.interpolation==="majority"||e?.interpolation==="majority")&&us(this.layer),i=!!this.layer.serviceRasterInfo?.storageInfo?.isBsqTile&&t.bandIds?.join()!==e?.bandIds?.join(),o=t.renderer!==e?.renderer&&this._getSubviewType(e?.renderer)!==this._getSubviewType(t.renderer);o&&this._updateSubview();const r=t.multidimensionalDefinition!==e?.multidimensionalDefinition,a=t.rasterFunction!==e?.rasterFunction,n=a&&!this._useWebGLForProcessing,l=r||s||o||n||i;this.subview.redrawOrRefetch({refetch:l,reprocess:a}).catch(c=>{Le(c)||je.getLogger(this).error(c)}),this.notifyChange("updating")}),He(()=>this.layer.multidimensionalSubset??null,(t,e)=>{const{multidimensionalDefinition:s}=this.layer;s!=null&&ls(s,t)!==ls(s,e)&&(this.subview.redrawOrRefetch({refetch:!0}).catch(i=>{Le(i)||je.getLogger(this).error(i)}),this.notifyChange("updating"))},_i),He(()=>this.timeExtent,()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch(t=>{Le(t)||je.getLogger(this).error(t)})},os),He(()=>this.view.highlights.items.map(({name:t,color:e})=>({name:t,color:e})),()=>this._updateHighlightOptions(this.subview),os)])}detach(){this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}highlight(t,e){if(!t.pixelRanges?.length)return as();const s={target:{...t},options:{...e}};return this._pixelHighlights.push(s),this._updateHighlightOptions(this.subview),as(()=>{const i=this._pixelHighlights.indexOf(s);i!==-1&&(this._pixelHighlights.splice(i,1),this._updateHighlightOptions(this.subview))})}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){const{renderer:t}=this.layer;if(!t)return;const e=this._getSubviewType(t);if(this.subview){if(this.subview.type===e)return void this._attachSubview(this.subview);this._detachSubview(this.subview),this.subview?.destroy(),this.subview=null}const{layer:s}=this;let i;if(i=e==="rasterVF"?new qe({layer:s,layerView:this,scheduler:this.scheduler}):e==="flow"?new Ci({layer:s,layerView:this,scheduler:this.scheduler}):new we({layer:s,layerView:this,scheduler:this.scheduler}),"useWebGLForProcessing"in i&&(i.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in i&&(i.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in i){const{subview:o}=this;i.previousLOD=o&&"previousLOD"in o?o.previousLOD:null}this._attachSubview(i),this._updateHighlightOptions(i),this.subview=i,this.requestUpdate()}_attachSubview(t){t&&!t.attached&&(t.attach(),t.attached=!0,this.container.addChildAt(t.container,0))}_detachSubview(t){t?.attached&&(this.container.removeChild(t.container),t.detach(),t.attached=!1)}_getSubviewType(t){const e=t?.type;return e==="vector-field"?"rasterVF":e==="flow"?"flow":"raster"}_updateHighlightOptions(t){t?.type==="raster"&&t.updateHighlightOptions(this._pixelHighlights)}};u([P()],be.prototype,"subview",void 0),u([P()],be.prototype,"useWebGLForProcessing",null),u([P()],be.prototype,"useProgressiveUpdate",null),u([P({readOnly:!0})],be.prototype,"displayParameters",null),be=u([Ee("esri.views.2d.layers.ImageryTileLayerView2D")],be);const zo=be;export{zo as default};
