import{eP as R,s as y,gx as U,dh as b,bs as M,hm as B,e3 as g,gH as c,am as V,a9 as w,j8 as O,a as X,d as k,eB as G,l as N}from"./main-pOgmbpmS.js";import{r as W}from"./videoUtils-D3vHZ3je.js";import{t as z}from"./requestImageUtils-DRw8o-h_.js";import{Y as h}from"./enums-DDJfd4_p.js";import{A as T,_ as K,h as j,n as q}from"./Texture-DxZPAhdk.js";import{S as Y}from"./OutputColorHighlightOID.glsl-CzaQ5Ix1.js";import{s as $}from"./BufferView-BSD7Eom9.js";function J(){return F??=(async()=>{const i=await import("./basis_transcoder-qOMORVob.js"),e=await i.default({locateFile:t=>R(`esri/libs/basisu/${t}`)});return e.initializeBasis(),e})(),F}let F,o=null,x=null;async function A(){return x==null&&(x=J(),o=await x),x}function Q(i,e){if(o==null)return i.byteLength;const t=new o.BasisFile(new Uint8Array(i)),a=D(t)?C(t.getNumLevels(0),t.getHasAlpha(),t.getImageWidth(0,0),t.getImageHeight(0,0),e):0;return t.close(),t.delete(),a}function Z(i,e){if(o==null)return i.byteLength;const t=new o.KTX2File(new Uint8Array(i)),a=I(t)?C(t.getLevels(),t.getHasAlpha(),t.getWidth(),t.getHeight(),e):0;return t.close(),t.delete(),a}function C(i,e,t,a,r){const s=K(e?h.COMPRESSED_RGBA8_ETC2_EAC:h.COMPRESSED_RGB8_ETC2),n=r&&i>1?(4**i-1)/(3*4**(i-1)):1;return Math.ceil(t*a*s*n)}function D(i){return i.getNumImages()>=1&&!i.isUASTC()}function I(i){return i.getFaces()>=1&&i.isETC1S()}async function ee(i,e,t){o==null&&(o=await A());const a=new o.BasisFile(new Uint8Array(t));if(!D(a))return null;a.startTranscoding();const r=v(i,e,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(s,n)=>a.getImageTranscodedSizeInBytes(0,s,n),(s,n,l)=>a.transcodeImage(l,0,s,n,0,0));return a.close(),a.delete(),r}async function te(i,e,t){o==null&&(o=await A());const a=new o.KTX2File(new Uint8Array(t));if(!I(a))return null;a.startTranscoding();const r=v(i,e,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(s,n)=>a.getImageTranscodedSizeInBytes(s,0,0,n),(s,n,l)=>a.transcodeImage(l,s,0,0,n,0,-1,-1));return a.close(),a.delete(),r}function v(i,e,t,a,r,s,n,l){const{compressedTextureETC:d,compressedTextureS3TC:f}=i.capabilities,[p,L]=d?a?[1,h.COMPRESSED_RGBA8_ETC2_EAC]:[0,h.COMPRESSED_RGB8_ETC2]:f?a?[3,h.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,h.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],P=e.hasMipmap?t:Math.min(1,t),_=[];for(let u=0;u<P;u++)_.push(new Uint8Array(n(u,p))),l(u,p,_[u]);return e.internalFormat=L,e.hasMipmap=_.length>1,e.samplingMode=e.hasMipmap?9987:9729,e.width=r,e.height=s,new T(i,e,{type:"compressed",levels:_})}const m=16;function E(i,e){return e=Math.floor(e/m)*m,Math.min(Math.round(i/m)*m,e)}function ae(i,e){return e=Math.floor(e/m)*m,Math.min(Math.ceil(i/m)*m,e)}function ie(i,e){const[t,a]=re(i,e);return i.width===t&&i.height===a?i:S(i,t,a)}function re({width:i,height:e},{maxPreferredTexturePixels:t,maxTextureSize:a}){const r=Math.max(i,e),s=i*e;if(r<=a&&s<=t)return[i,e];const n=Math.min(Math.sqrt(t/s),a/r);return[E(Math.round(i*n),a),E(Math.round(e*n),a)]}function S(i,e,t){if(i instanceof ImageData)return S(se(i),e,t);const a=document.createElement("canvas");return a.width=e,a.height=t,a.getContext("2d").drawImage(i,0,0,a.width,a.height),a}function se(i){const e=document.createElement("canvas");e.width=i.width,e.height=i.height;const t=e.getContext("2d");if(t==null)throw new y("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return t.putImageData(i,0,0),e}class ne{constructor(e,t){this._data=e,this.id=U(),this.events=new b,this._parameters={...le,...t},this._startPreload(e)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(e){e instanceof HTMLVideoElement?(this.update=t=>this._update(e,t),this._startPreloadVideoElement(e)):e instanceof HTMLImageElement&&this._startPreloadImageElement(e)}_startPreloadVideoElement(e){if(!(M(e.src)||e.preload==="auto"&&e.crossOrigin)&&(e.preload="auto",e.crossOrigin="anonymous",e.src=e.src,e.paused&&e.autoplay)){const t=[];W(e,a=>t.push(a)).then(()=>{e.play()}).finally(()=>t.forEach(a=>a.remove()))}}_startPreloadImageElement(e){B(e.src)||M(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}_createDescriptor(e){const t=new j;return t.wrapMode=this._parameters.wrap??10497,t.flipped=!this._parameters.noUnpackFlip,t.samplingMode=this._parameters.mipmap?9987:9729,t.hasMipmap=!!this._parameters.mipmap,t.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,t.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?e.parameters.maxMaxAnisotropy:1),t.dataType=this._parameters.dataType??t.dataType,t.pixelFormat=this._parameters.pixelFormat??t.pixelFormat,t.internalFormat=this._parameters.internalFormat??t.internalFormat,t}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){return this._glTexture?.usedMemory||oe(this._data,this._parameters)}load(e){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const t=this._data;return t==null?(this._glTexture=new T(e,this._createDescriptor(e),null),this._glTexture):(this._emptyTexture=e.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof t=="string"?this._loadFromURL(e,t):t instanceof Image?this._loadFromImageElement(e,t):t instanceof HTMLVideoElement?this._loadFromVideoElement(e,t):t instanceof ImageData||t instanceof HTMLCanvasElement?this._loadFromImage(e,t):g(t)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(e,t):c(t)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(e,new Uint8Array(t)):(c(t)||g(t))&&this._parameters.encoding==="image/ktx2"?this._loadFromKTX2(e,t):(c(t)||g(t))&&this._parameters.encoding==="image/x.basis"?this._loadFromBasis(e,t):c(t)?this._loadFromPixelData(e,new Uint8Array(t)):V(t)?this._loadFromPixelData(e,t):null)}_update(e,t){return this._glTexture==null||e.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||t===e.currentTime?t:(this._glTexture.setData(e),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),e.currentTime)}_loadFromDDSData(e,t){return this._glTexture=Y(e,this._createDescriptor(e),t),this._emptyTexture=null,this._glTexture}_loadFromKTX2(e,t){return this._loadAsync(()=>te(e,this._createDescriptor(e),t).then(a=>(this._glTexture=a,a)))}_loadFromBasis(e,t){return this._loadAsync(()=>ee(e,this._createDescriptor(e),t).then(a=>(this._glTexture=a,a)))}_loadFromPixelData(e,t){$(this._parameters.width>0&&this._parameters.height>0);const a=this._createDescriptor(e);return a.pixelFormat!==6407&&a.pixelFormat!==6408||(a.compress=this._parameters.compressionOptions),a.width=this._parameters.width??0,a.height=this._parameters.height??0,this._glTexture=new T(e,a,t),this._glTexture}_loadFromURL(e,t){return this._loadAsync(async a=>{const r=await z(t,{signal:a});return w(a),this._loadFromImage(e,r)})}_loadFromImageElement(e,t){return t.complete?this._loadFromImage(e,t):this._loadAsync(async a=>{const r=await O(t,t.src,!1,a);return w(a),this._loadFromImage(e,r)})}_loadFromVideoElement(e,t){return t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(e,t):this._loadFromVideoElementAsync(e,t)}_loadFromVideoElementAsync(e,t){return this._loadAsync(a=>new Promise((r,s)=>{const n=()=>{t.removeEventListener("loadeddata",l),t.removeEventListener("error",d),N(f)},l=()=>{t.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(n(),r(this._loadFromImage(e,t)))},d=p=>{n(),s(p||new y("texture:load-error","Failed to load video"))};t.addEventListener("loadeddata",l),t.addEventListener("error",d);const f=X(a,()=>d(k()))}))}_loadFromImage(e,t){let a=t;a instanceof HTMLVideoElement||(a=ie(a,e.parameters));const r=H(a);this._parameters.width=r.width,this._parameters.height=r.height;const s=this._createDescriptor(e);return s.width=r.width,s.height=r.height,s.compress=this._parameters.compressionOptions,this._glTexture=new T(e,s,a),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(e){const t=new AbortController;this._loadingController=t;const a=e(t.signal);this._loadingPromise=a;const r=()=>{this._loadingController===t&&(this._loadingController=null),this._loadingPromise===a&&(this._loadingPromise=null),this._emptyTexture=null};return a.then(r,r),a}unload(){if(this._glTexture=G(this._glTexture),this._emptyTexture=null,this._loadingController!=null){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}}function oe(i,e){if(i==null)return 0;if(c(i)||g(i))return e.encoding==="image/ktx2"?Z(i,!!e.mipmap):e.encoding==="image/x.basis"?Q(i,!!e.mipmap):i.byteLength;const{width:t,height:a}=i instanceof Image||i instanceof ImageData||i instanceof HTMLCanvasElement||i instanceof HTMLVideoElement?H(i):e,r=e.pixelFormat??6408,s=q(r);return(e.mipmap?4/3:1)*t*a*s||0}function H(i){return i instanceof HTMLVideoElement?{width:i.videoWidth,height:i.videoHeight}:i}const le={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{ne as M,E as n,ae as r};
