import{_ as s,c1 as D,X as a,Y as c,Z as N,by as S,gk as H,O as g,aa as z,i as f,a8 as A,fa as W,l8 as Z,s as X,a9 as C,G as x,a5 as Y,l9 as K,cd as I,kZ as Q,bA as G,bH as V,dy as F,o as ee,H as te,a6 as re,la as se,cA as $,eE as oe,aw as ae,cy as E}from"./main-pOgmbpmS.js";import{a as q,F as b}from"./Basemap-XroID39J.js";import{l as T}from"./CollectionFlattener-N3CrRpZy.js";import{l as ie}from"./loadAll-C40Qqo36.js";import{n as ne}from"./uuid-CFz2qBzH.js";import{j as le}from"./persistable-29FJ__0o.js";import{l as h}from"./PolygonCollection-Byo-KqAe.js";import{e as pe}from"./editableLayers-C7GC9VXf.js";import"./mat4f32-BdRMyjXW.js";import"./mat4-BBA0NsiW.js";import{n as de,a as ye,t as ce}from"./TablesMixin-Vo2YH5LD.js";var j;let v=j=class extends N{constructor(e){super(e),this.type="none"}clone(){return new j({type:this.type})}};s([D({none:"none",stayAbove:"stay-above"}),a({json:{write:{isRequired:!0}}})],v.prototype,"type",void 0),v=j=s([c("esri.ground.NavigationConstraint")],v);const R=Symbol("GroundInstance");function ue(e){return e!=null&&typeof e=="object"&&R in e}var B,_;let i=_=class extends S(H){static{B=R}constructor(e){super(e),this[B]=!0,this.parent=null,this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new g;const t=o=>{const{parent:l}=o;l&&l!==this&&"remove"in l&&l.remove?.(o),o.parent=this,o.type!=="elevation"&&o.type!=="base-elevation"&&f.getLogger(this).error(`Layer '${o.title}, id:${o.id}' of type '${o.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},r=o=>{o.parent=null};this.addHandles([this.layers.on("after-add",o=>t(o.item)),this.layers.on("after-remove",o=>r(o.item))]),this.allLayers=new T({getCollections:()=>[this.layers,this.parent?.basemap?.groundLayers]})}removeChildLayer(e){this.layers.remove(e)}initialize(){this.when().catch(e=>{z(e)||f.getLogger(this).error("#load()","Failed to load ground",e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}get integratedMeshGround(){const e=this.parent?.basemap?.groundLayers.at(0);return e?.replacesTerrain?e:null}destroy(){const e=this.layers.removeAll();for(const t of e)A(t);this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e={...e}).resourceInfo),e}get loaded(){return super.loaded}get layers(){return this._get("layers")}set layers(e){this._set("layers",W(e,this._get("layers")))}writeLayers(e,t,r,o){const l=[];e&&(o={...o,layerContainerType:"ground"},e.forEach(p=>{if("write"in p){const y={};Z(p)().write(y,o)&&l.push(y)}else o?.messages&&o.messages.push(new X("layer:unsupported",`Layers (${p.title}, ${p.id}) of type '${p.declaredClass}' cannot be persisted in the ground`,{layer:p}))})),t.layers=l}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return ie(this,e=>{e(this.layers)})}async queryElevation(e,t){await this.load({signal:t?.signal});const{queryAll:r}=await import("./ElevationQuery-D-TbY28k.js");return C(t),r(this.layers.filter(M).toArray(),e,t)}async createElevationSampler(e,t){await this.load({signal:t?.signal});const{createSampler:r}=await import("./ElevationQuery-D-TbY28k.js");return C(t),r(this.layers.filter(M).toArray(),e,t)}clone(){const e={opacity:this.opacity,surfaceColor:x(this.surfaceColor),navigationConstraint:x(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new _({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){const t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):Promise.resolve()}async _loadLayersFromJSON(e,t,r){const o=t?.origin||"web-scene",l=t?.portal||null,p=t?.url||null,{populateOperationalLayers:y}=await import("./layersCreator-BJQfPuFW.js");C(r);const u=[];if(e.layers&&Array.isArray(e.layers)){const k={context:{origin:o,url:p,portal:l,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};u.push(y(this.layers,e.layers,k))}await Promise.allSettled(u)}};function M(e){return e&&"createElevationSampler"in e}s([a()],i.prototype,"parent",void 0),s([a()],i.prototype,"integratedMeshGround",null),s([a({json:{read:!1,write:{isRequired:!0}}})],i.prototype,"layers",null),s([a()],i.prototype,"allLayers",void 0),s([Y("layers")],i.prototype,"writeLayers",null),s([a({readOnly:!0})],i.prototype,"resourceInfo",void 0),s([a({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:I,read:{reader:K,source:"transparency"},write:{writer:(e,t)=>{t.transparency=Q(e)},target:"transparency"}}})],i.prototype,"opacity",void 0),s([a({type:G,json:{type:[I],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],i.prototype,"surfaceColor",void 0),s([a({type:v,json:{write:!0}})],i.prototype,"navigationConstraint",void 0),i=_=s([c("esri.Ground")],i);const w=i;let L=class extends V(N){constructor(e){super(e),this.color=null}};s([a({type:G,json:{type:[I],write:!0}})],L.prototype,"color",void 0),L=s([c("esri.effects.FocusAreaOutline")],L);const he=L;let d=class extends S(F){constructor(e){super(e),this.id=`focusarea-${ne()}`,this.title=null,this.enabled=!0,this.outline=null,this.geometries=new h}readGeometries(e,t,r){Array.isArray(e)?this.geometries=h.fromJSON(e,r):r.origin!=="web-scene"&&r.origin!=="portal-item"||r.hooks?.onAfterLoad?.(()=>this._loadGeometries(ee(e,r),r))}async _loadGeometries(e,t){const r=await te(e,{responseType:"json"});this.geometries=h.fromJSON(r.data,t)}};s([a({type:String,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}}),a()],d.prototype,"id",void 0),s([a({type:String,json:{write:!0}})],d.prototype,"title",void 0),s([a({type:Boolean,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}}})],d.prototype,"enabled",void 0),s([a({type:he,json:{write:!0}})],d.prototype,"outline",void 0),s([a({type:h,nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}},clonable:e=>new h(e.items.map(t=>t.clone()))}),le({origins:["web-scene","portal-item"],type:"resource",prefix:"geometries",contentAddressed:!0})],d.prototype,"geometries",void 0),s([re(["web-scene","portal-item","service"],"geometries")],d.prototype,"readGeometries",null),d=s([c("esri.effects.FocusArea")],d);const me=d;let m=class extends S(F){constructor(e){super(e),this.areas=new g,this.style="bright"}};s([a({type:g.ofType(me),nonNullable:!0,json:{write:!0,origins:{"web-scene":{write:{isRequired:!0}}}},clonable:e=>new g(e.items.map(t=>t.clone()))})],m.prototype,"areas",void 0),s([a({type:["bright","dark"],nonNullable:!0,json:{write:!0}})],m.prototype,"style",void 0),m=s([c("esri.effects.FocusAreas")],m);const P=m,O=()=>f.getLogger("esri.support.basemapUtils");function ge(){return{}}function fe(e){for(const t in e){const r=e[t];r&&!r.destroyed&&r.destroy(),delete e[t]}}function be(e,t){let r;if(typeof e=="string"){const o=e in q,l=!o&&e.includes("/");if(!o&&!l){if(se())O().warn(`Unable to find basemap definition for: ${e}. See available styles at https://developers.arcgis.com/rest/basemap-styles/`);else{const p=Object.entries(q).filter(([y,u])=>u.classic||u.is3d).map(([y])=>`"${y}"`).sort().join(", ");O().warn(`Unable to find basemap definition for: ${e}. Try one of these: ${p}`)}return null}t&&(r=t[e]),r||(r=o?b.fromId(e):new b({style:{id:e}}),t&&(t[e]=r))}else r=$(b,e);return r?.destroyed&&(O().warn("The provided basemap is already destroyed",{basemap:r}),r=null),r}const J={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function ve(e){let t=null;if(typeof e=="string")if(e in J){const r=J[e];t=new w({resourceInfo:{data:{layers:[r]}}})}else f.getLogger("esri.support.groundUtils").warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`);else t=$(w,e);return t}let n=class extends de(ye(oe)){constructor(e){super(e),this.allLayers=new T({getCollections:()=>[this.basemap?.baseLayers,this.basemap?.groundLayers,this.ground?.layers,this.layers,this.basemap?.referenceLayers],getChildrenFunction:t=>"layers"in t?t.layers:null}),this.focusAreas=new P,this.allTables=ce(this),this.basemap=null,this.editableLayers=new T({getCollections:()=>[this.allLayers],itemFilterFunction:pe}),this.ground=new w,this._basemapCache=ge(),this.addHandles(ae(()=>this.ground,(t,r)=>{r?.parent===this&&(r.parent=null),t.parent=this},{sync:!0}))}destroy(){fe(this._basemapCache),this._basemapCache=null,this.focusAreas.destroy(),this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),this.basemap=A(this.basemap),A(this.ground),this._set("ground",null)}castBasemap(e){return be(e,this._basemapCache)}castGround(e){return ve(e)??this._get("ground")}findLayerById(e){return this.allLayers.find(t=>t.id===e)}findTableById(e){return this.allTables.find(t=>t.id===e)}};s([a({readOnly:!0,dependsOn:[]})],n.prototype,"allLayers",void 0),s([a({type:P,nonNullable:!0,json:{write:{overridePolicy:e=>({enabled:e.areas.length>0,ignoreOrigin:!0})}}})],n.prototype,"focusAreas",void 0),s([a({readOnly:!0})],n.prototype,"allTables",void 0),s([a({type:b,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],n.prototype,"basemap",void 0),s([E("basemap")],n.prototype,"castBasemap",null),s([a({readOnly:!0})],n.prototype,"editableLayers",void 0),s([a({type:w,nonNullable:!0})],n.prototype,"ground",void 0),s([E("ground")],n.prototype,"castGround",null),s([a()],n.prototype,"undoRedo",void 0),n=s([c("esri.Map")],n);const U=n,we=Object.freeze(Object.defineProperty({__proto__:null,default:U},Symbol.toStringTag,{value:"Module"}));export{U as L,we as M,ue as o};
