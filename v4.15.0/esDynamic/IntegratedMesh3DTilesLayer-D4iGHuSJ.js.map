{"version":3,"file":"IntegratedMesh3DTilesLayer-D4iGHuSJ.js","sources":["../../node_modules/@arcgis/core/layers/IntegratedMesh3DTilesLayer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport{__decorate as e}from\"tslib\";import t from\"../request.js\";import o from\"../core/Error.js\";import r from\"../core/Logger.js\";import{MultiOriginJSONMixin as i}from\"../core/MultiOriginJSONSupport.js\";import{throwIfAbortError as s}from\"../core/promiseUtils.js\";import{on as n,sync as a}from\"../core/reactiveUtils.js\";import{property as l}from\"../core/accessorSupport/decorators/property.js\";import\"../core/has.js\";import\"../core/RandomLCG.js\";import{reader as p}from\"../core/accessorSupport/decorators/reader.js\";import{subclass as m}from\"../core/accessorSupport/decorators/subclass.js\";import{persistable as c}from\"../core/accessorSupport/decorators/persistable.js\";import d from\"../geometry/Extent.js\";import u from\"../geometry/SpatialReference.js\";import h from\"./Layer.js\";import{APIKeyMixin as f}from\"./mixins/APIKeyMixin.js\";import{ArcGISService as y}from\"./mixins/ArcGISService.js\";import{CustomParametersMixin as g}from\"./mixins/CustomParametersMixin.js\";import{OperationalLayer as _}from\"./mixins/OperationalLayer.js\";import{PortalLayer as S}from\"./mixins/PortalLayer.js\";import{ScaleRangeLayer as j}from\"./mixins/ScaleRangeLayer.js\";import{elevationInfo as T,url as v}from\"./support/commonProperties.js\";import w from\"./support/SceneModifications.js\";import{initFullExtent as x}from\"./support/tiles3DUtils.js\";import L from\"../portal/Portal.js\";import{logInvalidElevationInfoWarning as b,elevationModeRequiredMessage as P,featureExpressionUnsupportedMessage as I}from\"../support/elevationInfoUtils.js\";import{f as k}from\"../chunks/persistableUrlUtils.js\";import{isBasemap as R}from\"../support/userTypeGuards/isBasemap.js\";let D=class extends(y(_(S(j(i(g(f(h)))))))){readModifications(e,t,o){this._modificationsSource={url:k(e,o),context:o}}initialize(){this.addHandles(n(()=>this.modifications,\"after-changes\",()=>this.modifications=this.modifications,a))}constructor(e){super(e),this.operationalLayerType=\"IntegratedMesh3DTilesLayer\",this.modifications=null,this._modificationsSource=null,this.spatialReference=new u({wkid:4326,vcsWkid:115700}),this.fullExtent=new d(-180,-90,180,90,this.spatialReference),this.url=null,this.type=\"integrated-mesh-3dtiles\",this.path=null,this.minScale=0,this.maxScale=0,this._rootTilesetJSON=null,this._rootTileset=null,this._key=null,this._session=null,this._rootRequestPromise=null}set elevationInfo(e){null!=e&&\"absolute-height\"!==e.mode||this._set(\"elevationInfo\",e),this._validateElevationInfo(e)}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}get rootTilesetJSON(){return this._rootTilesetJSON}get rootTileset(){return this._rootTileset}get key(){return this._key}get session(){return this._session}_findSessionParameter(e){const t=[e];for(;t?.length>0;){const e=t.pop();if(!e)return;for(const[r,i]of Object.entries(e)){if(\"uri\"===r)try{const e=new URL(\"https://tmp\"+i).searchParams.get(\"session\");if(e)return e}catch(o){}\"object\"==typeof i&&null!==i&&t.push(i)}}return null}async requestRootAndSession(e){const i=(e,t)=>new o(\"3dtiles-init:\"+e,t);return this._rootRequestPromise||(this._rootRequestPromise=new Promise((o,n)=>{this.url||n(i(\"url-missing\",\"Layer url missing\")),this._key=this.customParameters?this.customParameters.key:null;new Promise((e,o)=>{if(this.replacesTerrain&&!this._key){const r=this.portalItem?.portal||this.parent?.portalItem?.portal||L.getDefault();r.signIn().then(()=>{r.g3dTilesEnabled?t(r.restUrl+\"/portals/self/modules/g3dtiles\",{responseType:\"json\",query:{f:\"json\"}}).then(t=>{this._key=t.data.keyString,e()},()=>o(i(\"g3dtiles-key-error\",\"Error fetching Google 3D Tiles key from portal\"))):o(i(\"g3dTilesEnabled-false\",\"Google 3D Tiles are not enabled on Portal \"+r.url))},()=>o(i(\"sign-in-failed\",\"Error signing in to Portal\")))}else e()}).then(()=>{t(this.url,{query:this._key?{key:this._key,token:this.apiKey}:{token:this.apiKey},responseType:\"array-buffer\",signal:e}).then(e=>{try{this._rootTilesetJSON=JSON.parse((new TextDecoder).decode(e.data))}catch(t){return void n(i(\"root-parse-failed\",\"Error parsing root tile, details: \"+t))}this._rootTilesetJSON?(this._session=this._findSessionParameter(this._rootTilesetJSON),this._rootTileset=e.data,this.fullExtent=x(this._rootTilesetJSON),o(),this._rootRequestPromise=null):n(i(\"root-is-null\",\"Root tile is null.\"))},e=>{s(e),n(i(\"root-load-failed\",\"Error loading root tile\")),this._rootRequestPromise=null,r.getLogger(\"IntegratedMesh3DTilesLayer\").error(\"Layer loading failed\",e)})},e=>n(e))})),this._rootRequestPromise}async _doLoad(e){const t=null!=e?e.signal:null;if(this._isUsedAsGroundLayer)throw new o(\"3dtiles-init:not-supported-in-groundlayers\",\"Layer is not supported in basemap.\");try{await this.loadFromPortal({supportedTypes:[\"3DTiles Service\"],validateItem:e=>{if(e.typeKeywords?.includes(\"IntegratedMesh\"))return!0;throw new o(\"portal:invalid-layer-item-type\",\"Invalid layer item, expected '${expectedType}' \",{expectedType:\"3DTiles Service containing IntegratedMesh\"})}},e)}catch(r){s(r)}if(null!=this._modificationsSource){const t=await w.fromUrl(this._modificationsSource.url,this.spatialReference,e);this.setAtOrigin(\"modifications\",t,this._modificationsSource.context.origin),this._modificationsSource=null}await this.requestRootAndSession(t)}beforeSave(){if(null!=this._modificationsSource)return this.load().then(()=>{},()=>{})}get hasAttributionData(){return!1}async fetchAttributionData(){return{}}_validateElevationInfo(e){const t=\"Integrated mesh 3d tiles layers\";b(r.getLogger(this),P(t,\"absolute-height\",e)),b(r.getLogger(this),I(t,e))}get replacesTerrain(){return!1}get _isUsedAsGroundLayer(){return R(this.parent)}get hasGoogleUrl(){return!!this.url?.match(/.+\\.googleapis.com/)}};e([l({type:[\"IntegratedMesh3DTilesLayer\"]})],D.prototype,\"operationalLayerType\",void 0),e([l({type:w,clonable:e=>e.clone()}),c({origins:[\"web-scene\",\"portal-item\"],type:\"resource\",prefix:\"modifications\"})],D.prototype,\"modifications\",void 0),e([p([\"web-scene\",\"portal-item\"],\"modifications\")],D.prototype,\"readModifications\",null),e([l({type:u})],D.prototype,\"spatialReference\",void 0),e([l({type:d})],D.prototype,\"fullExtent\",void 0),e([l(T)],D.prototype,\"elevationInfo\",null),e([l({type:[\"show\",\"hide\"]})],D.prototype,\"listMode\",void 0),e([l(v)],D.prototype,\"url\",void 0),e([l({readOnly:!0})],D.prototype,\"type\",void 0),e([l({type:String,json:{origins:{\"web-scene\":{read:!0,write:!0},\"portal-item\":{read:!0,write:!0}},read:!1}})],D.prototype,\"path\",void 0),e([l({type:Number,json:{name:\"layerDefinition.minScale\",write:!0,origins:{service:{read:!1,write:!1}}}})],D.prototype,\"minScale\",void 0),e([l({type:Number,json:{name:\"layerDefinition.maxScale\",write:!0,origins:{service:{read:!1,write:!1}}}})],D.prototype,\"maxScale\",void 0),e([l()],D.prototype,\"replacesTerrain\",null),e([l()],D.prototype,\"_isUsedAsGroundLayer\",null),e([l()],D.prototype,\"hasGoogleUrl\",null),D=e([m(\"esri.layers.IntegratedMesh3DTilesLayer\")],D);const O=D;export{O as default};\n"],"names":["D","y","_","S","j","i","g","f","h","t","o","k","n","a","u","d","e","r","L","x","s","w","b","P","I","R","l","c","p","T","v","m","O"],"mappings":"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","x_google_ignoreList":[0]}