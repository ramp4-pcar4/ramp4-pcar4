import{iQ as W,bH as ee,Z as I,_ as n,X as a,Y as h,G as c,j9 as f,au as M,c1 as $,bS as k,fY as N,a5 as _,a6 as w,k_ as te,d7 as ie,i as re,s as se,al as L,av as ne,ay as ae}from"./main-pOgmbpmS.js";import{s as oe}from"./GraphicOrigin-CdlK6np3.js";import{a as le}from"./layerContainerType-CJrPp4UB.js";import{s as x,p as O}from"./FeatureReductionSelection-5QSE4HY9.js";import{p as q,l as B}from"./OperationalLayer-CDc3-6Qw.js";import{t as J,A as P}from"./labelingInfo-8vWSgQgG.js";import{read as F}from"./jsonUtils-BYfNDtR0.js";import{m as U}from"./typeUtils-DqfxYaWO.js";import{p as V}from"./SimpleRenderer-DR8lcC8P.js";import{c as ue,V as pe,l as T}from"./commonProperties-D1pK6VpB.js";import{x as D}from"./MD5-CXHDUqXT.js";class de extends oe{constructor(s){super(),this.type="aggregate",this.featureReductionProvider=s}get id(){return this.featureReductionProvider.id}get[W](){const s=this.featureReductionProvider.featureReduction;return s&&"popupTemplate"in s?s:null}}let y=class extends ee(I){constructor(i){super(i),this.expression=null,this.title=null,this.returnType=null}};n([a({type:String,json:{write:!0}})],y.prototype,"expression",void 0),n([a({type:String,json:{write:!0}})],y.prototype,"title",void 0),n([a({type:String,json:{write:!0}})],y.prototype,"returnType",void 0),y=n([h("esri.layers.support.ExpressionInfo")],y);var z;let d=class extends I{static{z=this}constructor(i){super(i),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new z({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:c(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};n([a({type:Boolean,json:{write:!0}})],d.prototype,"isAutoGenerated",void 0),n([a({type:String,json:{write:!0}})],d.prototype,"name",void 0),n([a({type:String,json:{write:!0}})],d.prototype,"alias",void 0),n([a({type:String,json:{write:!0}})],d.prototype,"onStatisticField",void 0),n([a({type:y,json:{write:!0}})],d.prototype,"onStatisticExpression",void 0),n([a({type:String,json:{write:!0}})],d.prototype,"statisticType",void 0),d=z=n([h("esri.layers.support.AggregateField")],d);var j;let p=j=class extends x{constructor(i){super(i),this.type="binning",this.binType="geohash",this.fixedBinLevel=null,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.size=f("12px"),this.fields=[],this.renderer=null}writeFields(i,s,e){const r=i.filter(t=>t.statisticType!=="avg_angle").map(t=>t.toJSON());M(e,r,s)}readRenderer(i,s,e){const r=s.drawingInfo?.renderer;return r?F(r,s,e)??void 0:J(s,e)}clone(){return new j({fields:c(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate),renderer:c(this.renderer),binType:c(this.binType),size:this.size})}};n([$({binning:"binning"})],p.prototype,"type",void 0),n([$({geohash:"geohash",square:"square"}),a({type:["geohash","square"]})],p.prototype,"binType",void 0),n([a({type:Number,json:{write:!0}})],p.prototype,"fixedBinLevel",void 0),n([a({type:[P],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],p.prototype,"labelingInfo",void 0),n([a(q)],p.prototype,"labelsVisible",void 0),n([a({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],p.prototype,"maxScale",void 0),n([a(B)],p.prototype,"popupEnabled",void 0),n([a({type:k,json:{name:"popupInfo",write:!0}})],p.prototype,"popupTemplate",void 0),n([a({cast:i=>i==="auto"?i:N(f(i))})],p.prototype,"size",void 0),n([a({type:[d],json:{write:!0}})],p.prototype,"fields",void 0),n([_("fields")],p.prototype,"writeFields",null),n([a({types:U,json:{write:{target:"drawingInfo.renderer"}}})],p.prototype,"renderer",void 0),n([w("renderer",["drawingInfo.renderer"])],p.prototype,"readRenderer",null),p=j=n([h("esri.layers.support.FeatureReductionBinning")],p);var G;function H(i){return i.type==="simple"&&!i.visualVariables?.length}let l=G=class extends I{constructor(i){super(i),this.type="cluster",this.clusterRadius=f("80px"),this.clusterMinSize=f("12px"),this.clusterMaxSize=f("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=[]}readRenderer(i,s,e){const r=s.drawingInfo?.renderer;return r?.authoringInfo?.isAutoGenerated?null:r?H(r)?null:F(r,s,e)??void 0:J(s,e)}readSymbol(i,s,e){const r=s.drawingInfo?.renderer;return r?.authoringInfo?.isAutoGenerated?null:r&&H(r)?F(r,s,e)?.symbol:null}writeSymbol(i,s,e,r){const t=this.renderer?.authoringInfo?.isAutoGenerated;if(!this.renderer||t){const o=new V({symbol:i});s.drawingInfo={renderer:o.write({},r)}}}writeFields(i,s,e){const r=i.filter(t=>t.statisticType!=="avg_angle").map(t=>t.toJSON());M(e,r,s)}readFields(i,s,e){return i.filter(r=>!r.isAutoGenerated).map(r=>d.fromJSON(r))}clone(){return new G({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,fields:c(this.fields),maxScale:this.maxScale,renderer:c(this.renderer),symbol:c(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate)})}};n([a({type:["cluster"],readOnly:!0,json:{write:!0}})],l.prototype,"type",void 0),n([a({cast:i=>i==="auto"?i:N(f(i)),json:{write:!0}})],l.prototype,"clusterRadius",void 0),n([a({type:Number,cast:f,json:{write:!0}})],l.prototype,"clusterMinSize",void 0),n([a({type:Number,cast:f,json:{write:!0}})],l.prototype,"clusterMaxSize",void 0),n([a({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],l.prototype,"maxScale",void 0),n([a(B)],l.prototype,"popupEnabled",void 0),n([a({type:k,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],l.prototype,"popupTemplate",void 0),n([a({types:U,json:{write:{target:"drawingInfo.renderer"}}})],l.prototype,"renderer",void 0),n([w("renderer",["drawingInfo.renderer"])],l.prototype,"readRenderer",null),n([a({types:te})],l.prototype,"symbol",void 0),n([w("symbol",["drawingInfo.renderer"])],l.prototype,"readSymbol",null),n([_("symbol")],l.prototype,"writeSymbol",null),n([a({type:[P],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],l.prototype,"labelingInfo",void 0),n([a(q)],l.prototype,"labelsVisible",void 0),n([a({type:[d],json:{write:!0}})],l.prototype,"fields",void 0),n([_("fields")],l.prototype,"writeFields",null),n([w("fields")],l.prototype,"readFields",null),l=G=n([h("esri.layers.support.FeatureReductionCluster")],l);const Y={key:"type",base:x,typeMap:{cluster:l,binning:p}},Q={types:{key:"type",base:x,typeMap:{selection:O,cluster:l,binning:p}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:Y},"portal-item":{types:Y},"web-scene":{types:{key:"type",base:x,typeMap:{selection:O}},name:"layerDefinition.featureReduction",write:{allowNull:!0,layerContainerTypes:le}}}}},ce=()=>re.getLogger("esri.views.2d.layers.support.clusterUtils");L.add("esri-cluster-arcade-enabled",!0);const fe=L("esri-cluster-arcade-enabled"),ye=new Set(["simple-line","simple-fill","picture-fill"]);function X(i,s){let e=s.clone();if(!me(e))return e;if(s.symbols.some(r=>ye.has(r.type))&&(e=new V({symbol:new ie})),e.authoringInfo||(e.authoringInfo=new ue),e.authoringInfo.isAutoGenerated=!0,"visualVariables"in e){const r=(e.visualVariables||[]).filter(t=>t.valueExpression!=="$view.scale");r.forEach(t=>{t.type==="rotation"?t.field?t.field=m(i,t.field,"avg_angle","number"):t.valueExpression&&(t.field=v(i,t.valueExpression,"avg_angle","number"),t.valueExpression=null):t.normalizationField?(t.field=m(i,t.field,"avg_norm","number",t.normalizationField),t.normalizationField=null):t.field?t.field=m(i,t.field,"avg","number"):t.valueExpression&&(t.field=v(i,t.valueExpression,"avg","number"),t.valueExpression=null)}),e.visualVariables=r}switch(e.type){case"simple":break;case"pie-chart":for(const r of e.attributes)r.field?r.field=m(i,r.field,"sum","number"):r.valueExpression&&(r.field=v(i,r.valueExpression,"sum","number"),r.valueExpression=null);break;case"unique-value":e.field?e.field=m(i,e.field,"mode","string"):e.valueExpression&&(e.field=v(i,e.valueExpression,"mode","string"),e.valueExpression=null);break;case"class-breaks":e.normalizationField?(e.field=m(i,e.field,"avg_norm","number",e.normalizationField),e.normalizationField=null):e.field?e.field=m(i,e.field,"avg","number"):e.valueExpression&&(e.field=v(i,e.valueExpression,"avg","number"),e.valueExpression=null)}return e}const me=i=>{const s=e=>ce().error(new se("Unsupported-renderer",e,{renderer:i}));if(!i)return!1;switch(i.type){case"unique-value":if(i.field2||i.field3)return s("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(i.normalizationField){const e=i.normalizationType;if(e!=="field")return s(`FeatureReductionCluster does not support a normalizationType of ${e}`),!1}break;case"simple":case"pie-chart":break;default:return s(`FeatureReductionCluster does not support renderers of type ${i.type}`),!1}if(!fe){if("valueExpression"in i&&i.valueExpression)return s("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in i&&i.visualVariables||[]).some(e=>!(!("valueExpression"in e)||!e.valueExpression)))return s("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function be(i,s,e){switch(i){case"sum":return`cluster_sum_${s}`;case"avg":case"avg_angle":return`cluster_avg_${s}`;case"mode":return`cluster_type_${s}`;case"avg_norm":{const r=e,t="field",o=s.toLowerCase()+",norm:"+t+","+r.toLowerCase();return"cluster_avg_"+D(o)}}}function v(i,s,e,r){const t=D(s),o=e==="mode"?`cluster_type_${t}`:e==="sum"?`cluster_sum_${t}`:`cluster_avg_${t}`;return i.some(u=>u.name===o)||i.push(new d({name:o,isAutoGenerated:!0,onStatisticExpression:new y({expression:s,returnType:r}),statisticType:e})),o}function m(i,s,e,r,t){if(s==="cluster_count"||i.some(u=>u.name===s))return s;const o=be(e,s,t);return i.some(u=>u.name===o)||(e==="avg_norm"?i.push(new d({name:o,isAutoGenerated:!0,onStatisticExpression:new y({expression:`$feature.${s} / $feature.${t}`,returnType:r}),statisticType:"avg"})):i.push(new d({name:o,isAutoGenerated:!0,onStatisticField:s,statisticType:e}))),o}const he=i=>{const s=i;let e=class extends s{constructor(...r){super(...r),this.aggregateGraphicOrigin=new de(this),this.addHandles(ne(()=>this.renderer,()=>{if(this.featureReduction){const t=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",t)}},ae))}set featureReduction(r){const t=this._normalizeFeatureReduction(r);this._set("featureReduction",t)}set renderer(r){}_withClusterVariable(r,t,o){const u=r.clone();return"visualVariables"in u&&(u.visualVariables||(u.visualVariables=[]),u.visualVariables.some(S=>S.type==="size")||u.visualVariables.push(new pe({field:"cluster_count",stops:[new T({value:1}),new T({useMinValue:!0,size:t}),new T({useMaxValue:!0,size:o})]}))),u}_normalizeFeatureReduction(r){if(r?.type!=="cluster")return r;const t=r.clone(),o=[new d({name:"cluster_count",alias:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],u=(t.fields??[]).filter(b=>!b.isAutoGenerated),S=r.renderer&&!r.renderer.authoringInfo?.isAutoGenerated,{clusterMinSize:R,clusterMaxSize:E}=t;if(S){t.fields=[...o,...u];const b=this._withClusterVariable(t.renderer,R,E);return t.effectiveFeatureRenderer=b,t.effectiveClusterRenderer=b,t}if(r.symbol){if(t.fields=[...o,...u],t.renderer=null,!this.renderer)return t.effectiveFeatureRenderer=null,t.effectiveClusterRenderer=null,t;const b=X(o,this.renderer),g=this._withClusterVariable(b,R,E),Z="visualVariables"in g&&g.visualVariables?g.visualVariables:[],K=new V({symbol:r.symbol,visualVariables:Z});return t.fields=[...o,...u],t.effectiveFeatureRenderer=g,t.effectiveClusterRenderer=K,t}if(!this.renderer)return r;const A=X(o,this.renderer);t.fields=[...o,...u],t.renderer=A;const C=this._withClusterVariable(A,R,E);return t.effectiveFeatureRenderer=C,t.effectiveClusterRenderer=C,t}};return n([a({readOnly:!0,clonable:!1})],e.prototype,"aggregateGraphicOrigin",void 0),n([a(Q)],e.prototype,"featureReduction",null),e=n([h("esri.layers.mixins.FeatureReductionLayer")],e),e};export{Q as a,he as f,d as n};
