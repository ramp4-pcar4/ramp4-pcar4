{"version":3,"file":"knowledgegraph-CJHmNeCG.js","sources":["../../node_modules/@arcgis/core/arcade/functions/knowledgegraph.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.34/esri/copyright.txt for details.\n*/\nimport e from\"../../config.js\";import r from\"../ArcadePortal.js\";import t from\"../Dictionary.js\";import{ArcadeExecutionError as n}from\"../executionError.js\";import{B as o,u as a,o as i,J as s,K as p,e as l,f as c,g as f,n as u,h as m}from\"../../chunks/languageUtils.js\";import{getPortal as d}from\"../portalUtils.js\";import h from\"../../geometry/Geometry.js\";import{load as g,project as w,isLoaded as y}from\"../../geometry/projectionUtils.js\";import j from\"../../geometry/SpatialReference.js\";import{webMercatorToGeographic as S,geographicToWebMercator as v}from\"../../geometry/support/webMercatorUtils.js\";import R from\"../../portal/Portal.js\";import G from\"../../portal/PortalItem.js\";import{project as x}from\"../../rest/geometryService/project.js\";import k from\"../../rest/knowledgeGraph/Entity.js\";import P from\"../../rest/knowledgeGraph/GraphQueryStreaming.js\";import b from\"../../rest/knowledgeGraph/ObjectValue.js\";import I from\"../../rest/knowledgeGraph/Path.js\";import W from\"../../rest/knowledgeGraph/Relationship.js\";import D from\"../../rest/support/ProjectParameters.js\";import{isString as T,isArray as U,isNumber as q,isDate as A}from\"../../support/guards.js\";let J=null;async function N(r){const t=e.geometryServiceUrl??\"\";if(!t){y()||await g();for(const e of r)e.container[e.indexer]=w(e.container[e.indexer],j.WGS84);return}const n=r.map(e=>e.container[e.indexer]),o=new D({geometries:n,outSpatialReference:j.WGS84}),a=await x(t,o);for(let e=0;e<a.length;e++){const t=r[e];t.container[t.indexer]=a[e]}}async function F(e,r){const t=new G({portal:e,id:r});return await t.load(),null===J&&(J=await import(\"../../rest/knowledgeGraphService.js\")),await J.fetchKnowledgeGraph(t.url)}function M(e,r,t,n,o){if(null===e)return null;if(T(e)||q(e))return e;if(l(e))return e.toJSDate();if(l(e))return e.toJSDate();if(c(e))return e.toStorageFormat();if(f(e))return e.toStorageString();if(u(e)){const a={};for(const i of e.keys())a[i]=M(e.field(i),r,t,n,o),a[i]instanceof h&&o.push({container:a,indexer:i});return a}if(U(e)){const a=e.map(e=>M(e,r,t,n,o));for(let e=0;e<a.length;e++)a[e]instanceof h&&o.push({container:a,indexer:e});return a}return m(e)?e.spatialReference.isWGS84?e:e.spatialReference.isWebMercator&&r?S(e):e:void 0}function Q(e,r){if(!e)return e;if(e.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return v(e);if(e.spatialReference.equals(r.spatialReference))return e;throw new n(r,\"WrongSpatialReference\",null)}function B(e,r){if(!e)return null;const t={};for(const n in e)t[n]=E(e[n],r);return t}function E(e,r){return null===e?null:U(e)?e.map(e=>E(e,r)):e instanceof k?{graphTypeName:e.typeName,id:e.id,graphType:\"entity\",properties:B(e.properties,r)}:e instanceof b?{graphType:\"object\",properties:B(e.properties,r)}:e instanceof W?{graphTypeName:e.typeName,id:e.id,graphType:\"relationship\",originId:e.originId??null,destinationId:e.destinationId??null,properties:B(e.properties,r)}:e instanceof I?{graphType:\"path\",path:e.path?e.path.map(e=>E(e,r)):null}:m(e)?Q(e,r):T(e)||q(e)||A(e)?e:null}function K(e){\"async\"===e.mode&&(e.functions.knowledgegraphbyportalitem=function(t,i){return e.standardFunctionAsync(t,i,(e,s,p)=>{if(o(p,2,2,t,i),null===p[0])throw new n(t,\"PortalRequired\",i);if(p[0]instanceof r){const e=a(p[1]);let r;r=t.services?.portal?t.services.portal:R.getDefault();return F(d(p[0],r),e)}if(!1===T(p[0]))throw new n(t,\"InvalidParameter\",i);const l=a(p[0]);return F(t.services?.portal??R.getDefault(),l)})},e.signatures.push({name:\"knowledgegraphbyportalitem\",min:2,max:2}),e.functions.querygraph=function(r,a){return e.standardFunctionAsync(r,a,async(e,l,c)=>{o(c,2,4,r,a);const f=c[0];if(!i(f))throw new n(r,\"InvalidParameter\",a);const u=c[1];if(!T(u))throw new n(r,\"InvalidParameter\",a);null===J&&(J=await import(\"../../rest/knowledgeGraphService.js\"));let m=null;const d=s(c[2],null);if(!(d instanceof t||null===d))throw new n(r,\"InvalidParameter\",a);if(d){let e=[];m=M(d,!0,!1,r,e),e=e.filter(e=>!e.container[e.indexer].spatialReference.isWGS84),e.length>0&&await N(e)}const h=s(c[3],!1),g=new P({openCypherQuery:u,bindParameters:m,provenanceBehavior:h?\"include\":\"exclude\"});(f?.serviceDefinition?.currentVersion??11.3)>11.2&&(g.outputSpatialReference=r.spatialReference);const w=(await J.executeQueryStreaming(f,g)).resultRowsStream.getReader(),y=[];try{for(;;){const{done:e,value:t}=await w.read();if(e)break;if(U(t))for(const n of t)y.push(E(n,r));else{const e=[];for(const n of t)e.push(E(t[n],r));y.push(e)}}}catch(j){throw j}return t.convertJsonToArcade(y,p(r),!1,!0)})},e.signatures.push({name:\"querygraph\",min:2,max:4}))}export{K as registerFunctions};\n"],"names":["J","N","r","t","e","y","g","w","j","n","o","D","a","x","F","G","M","T","q","l","c","f","u","i","h","U","m","S","Q","v","B","E","k","b","W","I","A","K","p","R","d","s","P"],"mappings":"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","x_google_ignoreList":[0]}