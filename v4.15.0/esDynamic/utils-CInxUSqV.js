import{bA as u,ca as f,eP as E,H as R,S as d,g3 as m,g4 as M,g5 as N,cb as O}from"./main-pOgmbpmS.js";import{a as C}from"./asyncUtils-CwlZsPSF.js";import{i as H}from"./jsonUtils-CH-MwIcY.js";import{u as w,S as P}from"./cimSymbolUtils-54cd34Xk.js";import{e as q}from"./LRUCache-JS_AGRnP.js";const g="picture-fill",k="simple-fill",D="simple-line",x="simple-marker",I="text",J="cim",L=new Map([["dash",[4,3]],["dashdot",[4,3,1,3]],["dot",[1,3]],["longdash",[8,3]],["longdashdot",[8,3,1,3]],["longdashdotdot",[8,3,1,3,1,3]],["shortdash",[4,1]],["shortdashdot",[4,1,1,1]],["shortdashdotdot",[4,1,1,1,1,1]],["shortdot",[1,1]],["solid",[]]]),v=new q(1e3);function T(e){const r=e.style;let o=null;if(e)switch(e.type){case x:r!=="cross"&&r!=="x"&&(o=e.color);break;case k:r&&r!=="solid"?r!=="none"&&(o={type:"pattern",x:0,y:0,src:E(`esri/symbols/patterns/${r}.png`),width:5,height:5}):o=e.color;break;case g:o={type:"pattern",src:e.url,width:f(e.width)*e.xscale,height:f(e.height)*e.yscale,x:f(e.xoffset),y:f(e.yoffset)};break;case I:o=e.color;break;case J:o=w(e)}return o}function U(e,r){const o=e+"-"+r,t=v.get(o);return t!=null?Promise.resolve(t):R(e,{responseType:"image"}).then(a=>{const n=a.data,l=n.naturalWidth,s=n.naturalHeight,i=document.createElement("canvas");i.width=l,i.height=s;const c=i.getContext("2d");c.fillStyle=r,c.fillRect(0,0,l,s),c.globalCompositeOperation="destination-in",c.drawImage(n,0,0);const b=i.toDataURL();return v.put(o,b),b})}function p(e){if(!e)return null;let r=null;switch(e.type){case k:case g:case x:r=p(e.outline);break;case D:{const o=f(e.width);e.style!=null&&e.style!=="none"&&o!==0&&(r={color:e.color,style:z(e.style),width:o,cap:e.cap,join:e.join==="miter"?f(e.miterLimit):e.join},r.dashArray=j(r).join(",")||"none");break}default:r=null}return r}function j(e){if(!e?.style)return[];const{dashArray:r,style:o,width:t}=e;if(typeof r=="string"&&r!=="none")return r.split(",").map(l=>Number(l));const a=t??0,n=L.has(o)?L.get(o).map(l=>l*a):[];if(e.cap!=="butt")for(const[l,s]of n.entries())n[l]=l%2==1?s+a:Math.max(s-a,1);return n}const z=(()=>{const e={};return r=>{if(e[r])return e[r];const o=r.replaceAll("-","");return e[r]=o,o}})(),W=new u([128,128,128]);function $(e){const r=e.symbolLayers?.at(-1);if(r&&"outline"in r)return r?.outline?.size}function B(e){return e?d(e)?$(e)??0:O(p(e)?.width):0}function F(e){if(e==null||!("symbolLayers"in e)||e.symbolLayers==null)return!1;switch(e.type){case"point-3d":return e.symbolLayers.some(r=>r.type==="object");case"line-3d":return e.symbolLayers.some(r=>r.type==="path");case"polygon-3d":return e.symbolLayers.some(r=>r.type==="object"||r.type==="extrude");default:return!1}}function G(e){return e.resource?.href??""}function K(e,r){if(!e)return null;let o=null;return d(e)?o=Q(e):m(e)&&(o=e.type==="cim"?w(e):e.color?new u(e.color):null),o?h(o,r):null}function Q(e){const r=e.symbolLayers;if(!r)return null;let o=null;return r.forEach(t=>{t.type==="object"&&t.resource?.href||(o=t.type==="water"?t.color:t.material?t.material.color:null)}),o?new u(o):null}function h(e,r){if(r==null||e==null)return e;const o=e.toRgba();return o[3]=o[3]*r,new u(o)}function V(e,r,o){const t=e.symbolLayers;if(!t)return;const a=(n,l=!1)=>{let s=r??n??null;return o?.override!=null&&(!s&&l&&(s=new u([255,255,255])),s&&(s.a=o.override)),h(s,o?.add)};t.forEach(n=>{if(n.type==="water")return void(n.color=h(n.color,o?.add));const l=n.material!=null?n.material.color:null,s=a(l,n.type==="icon"&&n.resource?.href!=null);n.material==null?n.material=new M({color:s}):n.material.color=s,"outline"in n&&n.outline?.color&&o?.add!=null&&(n.outline.color=h(n.outline.color,o.add)),"marker"in n&&n.marker!=null&&(n.marker.color=a(n.marker.color))})}function X(e,r,o){r=r??e.color,o?.override!=null&&r&&(r.a=o.override),r&&(e.color=h(r,o?.add)),"outline"in e&&e.outline?.color&&(e.outline.color=h(e.outline.color,o?.add))}function _(e,r,o){e&&(r||o!=null)&&(r&&(r=new u(r)),d(e)?V(e,r,o):m(e)&&X(e,r,o))}async function Y(e,r){const o=e.symbolLayers;o&&await C(o,async t=>Z(t,r))}async function Z(e,r){switch(e.type){case"extrude":re(e,r);break;case"icon":case"line":case"text":ee(e,r);break;case"path":te(e,r);break;case"object":await oe(e,r)}}function ee(e,r){const o=S(r);o!=null&&(e.size=o)}function S(e){for(const r of e)if(typeof r=="number")return r;return null}function re(e,r){const o=r[2];typeof o=="number"&&(e.size=o)}async function oe(e,r){const{resourceSize:o,symbolSize:t}=await ne(e),a=A(r,o,t);a!=null&&(e.width=y(r[0],t[0],o[0],a),e.depth=y(r[1],t[1],o[1],a),e.height=y(r[2],t[2],o[2],a))}function te(e,r){const o=A(r,N,[e.width,void 0,e.height]);o!=null&&(e.width=y(r[0],e.width,1,o),e.height=y(r[2],e.height,1,o))}function A(e,r,o){for(let t=0;t<3;t++){const a=e[t];switch(a){case"symbol-value":{const n=o[t];return n!=null?n/r[t]:1}case"proportional":break;default:if(a&&r[t])return a/r[t]}}return null}async function ne(e){const{computeObjectLayerResourceSize:r}=await import("./symbolLayerUtils-DnLMDT2I.js"),o=await r(e,10),{width:t,height:a,depth:n}=e,l=[t,n,a];let s=1;for(let i=0;i<3;i++){const c=l[i];if(c!=null){s=c/o[i];break}}for(let i=0;i<3;i++)l[i]==null&&(l[i]=o[i]*s);return{resourceSize:o,symbolSize:l}}function y(e,r,o,t){switch(e){case"proportional":return o*t;case"symbol-value":return r??o;default:return e}}function ae(e,r){const o=S(r);if(o!=null)switch(e.type){case"simple-marker":e.size=o;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=o,e.height=o*t):(e.width=o*t,e.height=o);break}case"simple-line":e.width=o;break;case"text":e.font.size=o}}async function le(e,r){if(e&&r)return d(e)?Y(e,r):void(m(e)&&ae(e,r))}function se(e,r,o){if(e&&r!=null){if(d(e)){const t=e.symbolLayers;t&&t.forEach(a=>{if(a.type==="object")switch(o){case"tilt":a.tilt=(a.tilt??0)+r;break;case"roll":a.roll=(a.roll??0)+r;break;default:a.heading=(a.heading??0)+r}a.type==="icon"&&(a.angle+=r)})}else if(m(e))switch(e.type){case"simple-marker":case"picture-marker":case"text":e.angle+=r;break;case"cim":P(e,r,!0)}}}function ie(e,r){if(!e)return null;const o=e.effects.map(t=>t.toJSON());return H(o)}function ce(e){return e!=null&&e.type==="polygon-3d"&&e.symbolLayers.some(r=>r.type==="extrude")}export{ce as A,_ as L,le as M,se as N,K as a,W as b,G as d,U as f,j as g,F as h,B as m,ie as q,T as u,z as w,p as y};
