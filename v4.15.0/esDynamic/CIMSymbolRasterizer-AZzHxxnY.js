import{aX as k,aW as F}from"./main-pOgmbpmS.js";import{i as T}from"./CIMResourceManager-Y5dmX2cK.js";import{Y as G,a as q,m as A}from"./CIMSymbolHelper-iXuDnu-M.js";import{OverrideHelper as B}from"./OverrideHelper-BYwjO2Dx.js";import{T as I,R as D}from"./rasterizingUtils-DK8j8z_t.js";import{O as z}from"./utils-CIm5uQvO.js";const j=96/72;class H{constructor(o){this._spatialReference=o,this._imageDataCanvas=null,this._cimResourceManager=new T}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(o,a,l,C,g,s,m,c,b,R){if(!o)return null;const{data:w}=o;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;const{symbol:_}=w;s||(s=z(_));const n=await B.resolveSymbolOverrides(w,a,this._spatialReference,g,s,m,c),u=this._cimResourceManager,x=[];G.fetchResources(n,u,x),G.fetchFonts(n,u,x),x.length>0&&await Promise.all(x);const{width:t,height:h}=l;let y=E(s,t,h,C,R);const e=G.getEnvelope(n,y,u);if(!e)return null;e.x===1/0&&(e.x=t+2),e.y===1/0&&(e.y=-h/2),e.width===-1/0&&(e.width=t),e.height===-1/0&&(e.height=h);let d=1,S=0,v=0;switch(_.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;e.width>t&&(i=t/e.width);let r=1;e.height>h&&(r=h/e.height),C==="preview"&&(e.width<t&&(i=t/e.width),e.height<h&&(r=h/e.height)),d=Math.min(i,r),S=e.x+e.width/2,v=e.y+e.height/2}break;case"CIMLineSymbol":if(R){v=e.y+e.height/2,S=e.x+e.width/2;const i=e.width-t,r=e.height-h;y={paths:I(y.paths,{xmin:-1*e.width/2+i,xmax:e.width/2-i,ymin:-1*e.height/2+r,ymax:e.height/2-r,width:e.width-2*i,height:e.height-2*r})}}else{(b||e.height>h)&&(d=h/e.height),v=e.y+e.height/2;const i=e.x*d+t/2,r=(e.x+e.width)*d+t/2,M=k(y)?y.paths:F(y)?y.rings:null;if(M===null)throw new Error("Bad geometry, can't rasterise symbol!");M[0][0][0]-=i/d,M[0][2][0]-=(r-t)/d}break;case"CIMPolygonSymbol":if(R){v=e.y+e.height/2,S=e.x+e.width/2;const i=e.width-t,r=e.height-h;y={paths:I(y.rings,{xmin:-1*e.width/2+i,xmax:e.width/2-i,ymin:-1*e.height/2+r,ymax:e.height/2-r,width:e.width-2*i,height:e.height-2*r})}}else{S=e.x+e.width/2,v=e.y+e.height/2;const i=e.x*d+t/2,r=(e.x+e.width)*d+t/2,M=e.y*d+h/2,P=(e.y+e.height)*d+h/2,{rings:f}=y;i<0&&(f[0][0][0]-=i,f[0][3][0]-=i,f[0][4][0]-=i),M<0&&(f[0][0][1]+=M,f[0][1][1]+=M,f[0][4][1]+=M),r>t&&(f[0][1][0]-=r-t,f[0][2][0]-=r-t),P>h&&(f[0][2][1]+=P-h,f[0][3][1]+=P-h)}}const O={type:"cim",data:{type:"CIMSymbolReference",symbol:n}};return this.rasterize(O,t,h,S,v,d,s,1,y)}rasterize(o,a,l,C,g,s,m,c=0,b=null,R=window.devicePixelRatio||1){const{data:w}=o;if(!w||w.type!=="CIMSymbolReference"||!w.symbol)return null;const{symbol:_}=w,n=this._canvas,u=R*j;n.width=a*u,n.height=l*u,m||(m=z(_)),b||(b=E(m,a,l,"legend")),n.width+=2*c,n.height+=2*c;const x=n.getContext("2d",{willReadFrequently:!0}),t=q.createIdentity();return t.translate(-C,-g),t.scale(s*u,-s*u),t.translate(a*u/2+c,l*u/2+c),x.clearRect(0,0,n.width,n.height),new A(x,this._cimResourceManager,t,!0).drawSymbol(_,b),x.getImageData(0,0,n.width,n.height)}}function K(p,o,a,l){return o==="esriGeometryPolygon"?{rings:D(I(p.rings,{xmin:0,ymin:0,width:a,height:l}),-1*a/2,-1*l/2)}:o==="esriGeometryPolyline"?{paths:D(I(p.paths,{xmin:0,ymin:0,width:a,height:l}),-1*a/2,-1*l/2)}:null}function E(p,o,a,l,C){const g=-o/2+1,s=o/2-1,m=a/2-1,c=-a/2+1;if(C&&(p==="esriGeometryPolygon"||p==="esriGeometryPolyline")){const b=K(C,p,o,a);if(b)return b}switch(p){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[g,0],[0,0],[s,0]]]};default:return l==="legend"?{rings:[[[g,m],[s,0],[s,c],[g,c],[g,m]]]}:{rings:[[[g,m],[s,m],[s,c],[g,c],[g,m]]]}}}export{H as CIMSymbolRasterizer};
