import{k$ as g}from"./main-pOgmbpmS.js";var C,x=()=>new DecompressionStream("deflate-raw");try{x(),C=async t=>{let r=x(),e=r.writable.getWriter(),n=r.readable.getReader(),o,i=[],s=0,a=0,c;for(e.write(t),e.close();!(c=await n.read()).done;)o=c.value,i.push(o),s+=o.length;return!i[1]&&o||(o=new Uint8Array(s),i.map(f=>(o.set(f,a),a+=f.length))),o}}catch{}var k=new TextDecoder,w=t=>{throw new Error("but-unzip~"+t)},A=t=>k.decode(t);function*$(t,r=C){let e=t.length-20,n=Math.max(e-65516,2);for(;(e=t.lastIndexOf(80,e-1))!==-1&&!(t[e+1]===75&&t[e+2]===5&&t[e+3]===6)&&e>n;);e===-1&&w(2);let o=(f,y)=>t.subarray(e+=f,e+=y),i=new DataView(t.buffer,t.byteOffset),s=f=>i.getUint16(f+e,!0),a=f=>i.getUint32(f+e,!0),c=s(10);for(c!==s(8)&&w(3),e=a(16);c--;){let f=s(10),y=s(30),E=s(32),M=a(20),R=a(42),V=A(o(46,s(28))),B=A(o(y,E)),N=e,d;e=R,d=o(30+s(26)+s(28),M),yield{filename:V,comment:B,read:()=>f&8?r(d):f?w(1):d},e=N}}const G=/.+\.(shp|dbf|json|prj|cpg)$/i,_=async t=>{const r={},e=[];for(const i of $(t))G.test(i.filename)&&e.push(Promise.resolve(i.read()).then(s=>r[i.filename]=s));await Promise.all(e);const n={},o=new TextDecoder;for(const[i,s]of Object.entries(r))i.slice(-3).toLowerCase()==="shp"||i.slice(-3).toLowerCase()==="dbf"?n[i]=new DataView(s.buffer,s.byteOffset,s.byteLength):n[i]=o.decode(s);return n},H=globalThis.URL,W=(t,r)=>{if(!r)return t;const e=new H(t);return e.pathname=`${e.pathname}.${r}`,e.href};async function l(t,r){const e=W(t,r),n=r==="prj"||r==="cpg";try{const o=await fetch(e);if(o.status>399)throw new Error(o.statusText);if(n)return o.text();const i=await o.arrayBuffer();return new DataView(i)}catch(o){if(n||r==="dbf")return!1;throw o}}function z(t){let r=0,e=1;const n=t.length;let o,i;const s=[t[0][0],t[0][1],t[0][0],t[0][1]];for(;e<n;)o=i||t[0],i=t[e],r+=(i[0]-o[0])*(i[1]+o[1]),e++,i[0]<s[0]&&(s[0]=i[0]),i[1]<s[1]&&(s[1]=i[1]),i[0]>s[2]&&(s[2]=i[0]),i[1]>s[3]&&(s[3]=i[1]);return{ring:t,clockWise:r>0,bbox:s,children:[]}}function F(t,r){return!(t.bbox[0]>r.bbox[0]||t.bbox[1]>r.bbox[1]||t.bbox[2]<r.bbox[2]||t.bbox[3]<r.bbox[3])}function O(t,r=!1){const e=[],n=[];for(const s of t){const a=z(s);a.clockWise!==r?e.push(a):n.push(a)}const o=[];for(const s of n){let a;for(const c of e)F(c,s)&&(a?F(a,c)&&(a=c):a=c);a?a.children.push(s.ring):o.push(s)}if(r)return{outers:e,orphens:o};if(o.length&&!r){const s=O(t,!0);if(s.orphens.length===0){const a=[];for(const c of s.outers)a.push([c.ring.toReversed()].concat(c.children.map(f=>f.toReversed())));return a}}const i=[];for(const s of e)i.push([s.ring].concat(s.children));return i}u.prototype.parsePoint=function(t){return{type:"Point",coordinates:this.parseCoord(t,0)}},u.prototype.parseZPoint=function(t){const r=this.parsePoint(t);return r.coordinates.push(t.getFloat64(16,!0)),r},u.prototype.parsePointArray=function(t,r,e){const n=[];let o=0;for(;o<e;)n.push(this.parseCoord(t,r)),r+=16,o++;return n},u.prototype.parseZPointArray=function(t,r,e,n){let o=0;for(;o<e;)n[o].push(t.getFloat64(r,!0)),o++,r+=8;return n},u.prototype.parseArrayGroup=function(t,r,e,n,o){const i=[];let s=0,a,c=0,f;for(;s<n;)s++,e+=4,a=c,s===n?c=o:c=t.getInt32(e,!0),f=c-a,f&&(i.push(this.parsePointArray(t,r,f)),r+=f<<4);return i},u.prototype.parseZArrayGroup=function(t,r,e,n){let o=0;for(;o<e;)n[o]=this.parseZPointArray(t,r,n[o].length,n[o]),r+=n[o].length<<3,o++;return n},u.prototype.parseMultiPoint=function(t){const r={},e=t.getInt32(32,!0);if(!e)return null;const n=this.parseCoord(t,0),o=this.parseCoord(t,16);r.bbox=[n[0],n[1],o[0],o[1]];const i=36;return e===1?(r.type="Point",r.coordinates=this.parseCoord(t,i)):(r.type="MultiPoint",r.coordinates=this.parsePointArray(t,i,e)),r},u.prototype.parseZMultiPoint=function(t){const r=this.parseMultiPoint(t);if(!r)return null;let e;if(r.type==="Point")return r.coordinates.push(t.getFloat64(72,!0)),r;e=r.coordinates.length;const n=52+(e<<4);return r.coordinates=this.parseZPointArray(t,n,e,r.coordinates),r},u.prototype.parsePolyline=function(t){const r={},e=t.getInt32(32,!0);if(!e)return null;const n=this.parseCoord(t,0),o=this.parseCoord(t,16);r.bbox=[n[0],n[1],o[0],o[1]];const i=t.getInt32(36,!0);let s,a;return e===1?(r.type="LineString",s=44,r.coordinates=this.parsePointArray(t,s,i)):(r.type="MultiLineString",s=40+(e<<2),a=40,r.coordinates=this.parseArrayGroup(t,s,a,e,i)),r},u.prototype.parseZPolyline=function(t){const r=this.parsePolyline(t);if(!r)return null;const e=r.coordinates.length;let n;return r.type==="LineString"?(n=60+(e<<4),r.coordinates=this.parseZPointArray(t,n,e,r.coordinates),r):(n=56+(r.coordinates.reduce(function(o,i){return o+i.length},0)<<4)+(e<<2),r.coordinates=this.parseZArrayGroup(t,n,e,r.coordinates),r)},u.prototype.polyFuncs=function(t){return t&&(t.type==="LineString"?(t.type="Polygon",t.coordinates=[t.coordinates],t):(t.coordinates=O(t.coordinates),t.coordinates.length===1?(t.type="Polygon",t.coordinates=t.coordinates[0],t):(t.type="MultiPolygon",t)))},u.prototype.parsePolygon=function(t){return this.polyFuncs(this.parsePolyline(t))},u.prototype.parseZPolygon=function(t){return this.polyFuncs(this.parseZPolyline(t))};const v={1:"parsePoint",3:"parsePolyline",5:"parsePolygon",8:"parseMultiPoint",11:"parseZPoint",13:"parseZPolyline",15:"parseZPolygon",18:"parseZMultiPoint"};function J(t){return t?function(r,e){const n=[r.getFloat64(e,!0),r.getFloat64(e+8,!0)];return t.inverse(n)}:function(r,e){return[r.getFloat64(e,!0),r.getFloat64(e+8,!0)]}}function u(t,r){if(!(this instanceof u))return new u(t,r);this.buffer=t,this.headers=this.parseHeader(),this.shpFuncs(r),this.rows=this.getRows()}u.prototype.shpFuncs=function(t){let r=this.headers.shpCode;if(r>20&&(r-=20),!(r in v))throw new Error(`I don't know shp type "${r}"`);this.parseFunc=this[v[r]],this.parseCoord=J(t)},u.prototype.getShpCode=function(){return this.parseHeader().shpCode},u.prototype.parseHeader=function(){const t=this.buffer;return{length:t.getInt32(24)<<1,version:t.getInt32(28,!0),shpCode:t.getInt32(32,!0),bbox:[t.getFloat64(36,!0),t.getFloat64(44,!0),t.getFloat64(52,!0),t.getFloat64(60,!0)]}},u.prototype.getRows=function(){let t=100;const r=this.buffer.byteLength-8,e=[];let n;for(;t<=r&&(n=this.getRow(t),!!n);)t+=8,t+=n.len,n.type?e.push(this.parseFunc(n.data)):e.push(null);return e},u.prototype.getRow=function(t){const r=this.buffer.getInt32(t),e=this.buffer.getInt32(t+4)<<1;if(e===0)return{id:r,len:e,type:0};if(!(t+e+8>this.buffer.byteLength))return{id:r,len:e,data:new DataView(this.buffer.buffer,this.buffer.byteOffset+t+12,e-4),type:this.buffer.getInt32(t+8,!0)}};function b(t,r){return new u(t,r).rows}var X=/^(?:ANSI\s)?(\d+)$/m;function U(t,r){if(!t)return n;try{new TextDecoder(t.trim())}catch{var e=X.exec(t);return e&&!r?U("windows-"+e[1],!0):(t=void 0,n)}return n;function n(o){var i=new TextDecoder(t||void 0),s=i.decode(o,{stream:!0})+i.decode();return s.replace(/\0/g,"").trim()}}function Y(t){var r={};return r.lastUpdated=new Date(t.getUint8(1)+1900,t.getUint8(2),t.getUint8(3)),r.records=t.getUint32(4,!0),r.headerLen=t.getUint16(8,!0),r.recLen=t.getUint16(10,!0),r}function q(t,r,e){for(var n=[],o=32;o<r&&(n.push({name:e(new Uint8Array(t.buffer.slice(t.byteOffset+o,t.byteOffset+o+11))),dataType:String.fromCharCode(t.getUint8(o+11)),len:t.getUint8(o+16),decimal:t.getUint8(o+17)}),t.getUint8(o+32)!==13);)o+=32;return n}function K(t,r,e,n,o){const i=new Uint8Array(t.buffer.slice(t.byteOffset+r,t.byteOffset+r+e));var s=o(i);switch(n){case"N":case"F":case"O":return parseFloat(s,10);case"D":return new Date(s.slice(0,4),parseInt(s.slice(4,6),10)-1,s.slice(6,8));case"L":return s.toLowerCase()==="y"||s.toLowerCase()==="t";default:return s}}function Q(t,r,e,n){for(var o={},i=0,s=e.length,a,c;i<s;)c=e[i],a=K(t,r,c.len,c.dataType,n),r+=c.len,typeof a<"u"&&(o[c.name]=a),i++;return o}function P(t,r){for(var e=U(r),n=Y(t),o=q(t,n.headerLen-1,e),i=(o.length+1<<5)+2,s=n.recLen,a=n.records,c=[];a;)c.push(Q(t,i,o,e)),i+=s,a--;return c}const tt=globalThis.URL,rt=t=>{if(!t)throw new Error("forgot to pass buffer");if(p(t))return new Uint8Array(t);if(p(t.buffer))return t.BYTES_PER_ELEMENT===1?t:new Uint8Array(t.buffer,t.byteOffset,t.byteLength);throw new Error("invalid buffer like object")},et=new TextDecoder,D=t=>{if(t){if(typeof t=="string")return t;if(p(t)||ArrayBuffer.isView(t)||m(t))return et.decode(t)}},j=t=>{if(!t)throw new Error("forgot to pass buffer");if(m(t))return t;if(p(t))return new DataView(t);if(p(t.buffer))return new DataView(t.buffer,t.byteOffset,t.byteLength);throw new Error("invalid buffer like object")};function p(t){return t instanceof globalThis.ArrayBuffer||Object.prototype.toString.call(t)==="[object ArrayBuffer]"}function m(t){return t instanceof globalThis.DataView||Object.prototype.toString.call(t)==="[object DataView]"}const h=function([t,r]){const e={};e.type="FeatureCollection",e.features=[];let n=0;const o=t.length;for(r||(r=[]);n<o;)e.features.push({type:"Feature",geometry:t[n],properties:r[n]||{}}),n++;return e},L=async function(t,r){let e;t=rt(t);const n=await _(t),o=[];r=r||[];for(e in n)e.indexOf("__MACOSX")===-1&&(e.slice(-4).toLowerCase()===".shp"?(o.push(e.slice(0,-4)),n[e.slice(0,-3)+e.slice(-3).toLowerCase()]=n[e]):e.slice(-4).toLowerCase()===".prj"?n[e.slice(0,-3)+e.slice(-3).toLowerCase()]=g(n[e]):e.slice(-5).toLowerCase()===".json"||r.indexOf(e.split(".").pop())>-1?o.push(e.slice(0,-3)+e.slice(-3).toLowerCase()):(e.slice(-4).toLowerCase()===".dbf"||e.slice(-4).toLowerCase()===".cpg")&&(n[e.slice(0,-3)+e.slice(-3).toLowerCase()]=n[e]));if(!o.length)throw new Error("no layers founds");const i=o.map(function(s){let a,c;const f=s.lastIndexOf(".");return f>-1&&s.slice(f).indexOf("json")>-1?(a=JSON.parse(n[s]),a.fileName=s.slice(0,f)):r.indexOf(s.slice(f+1))>-1?(a=n[s],a.fileName=s):(n[s+".dbf"]&&(c=P(n[s+".dbf"],n[s+".cpg"])),a=h([b(n[s+".shp"],n[s+".prj"]),c]),a.fileName=s),a});return i.length===1?i[0]:i};async function nt(t,r){const e=await l(t);return L(e,r)}const ot=async t=>{const r=await Promise.all([l(t,"shp"),l(t,"prj")]);let e=!1;try{r[1]&&(e=g(r[1]))}catch{e=!1}return b(r[0],e)},st=async t=>{const[r,e]=await Promise.all([l(t,"dbf"),l(t,"cpg")]);if(r)return P(r,e)},T=(t,r)=>new tt(t,globalThis?.document?.location).pathname.slice(-4).toLowerCase()===r,it=({shp:t,dbf:r,cpg:e,prj:n})=>{const o=[I(t,n)];return r&&o.push(S(r,e)),h(o)},Z=async function(t,r){if(typeof t!="string"){if(p(t)||ArrayBuffer.isView(t)||m(t))return L(t);if(t.shp)return it(t);throw new TypeError("must be a string, some sort of Buffer, or an object with at least a .shp property")}if(T(t,".zip"))return nt(t,r);T(t,".shp")&&(t=t.slice(0,-4));const e=await Promise.all([ot(t),st(t)]);return h(e)},I=function(t,r){if(t=j(t),r=D(r),typeof r=="string")try{r=g(r)}catch{r=!1}return b(t,r)},S=function(t,r){return t=j(t),r=D(r),P(t,r)};export{h as combine,Z as default,Z as getShapefile,S as parseDbf,I as parseShp,L as parseZip};
