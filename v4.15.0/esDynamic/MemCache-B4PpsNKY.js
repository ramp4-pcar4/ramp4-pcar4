import{al as f}from"./main-pOgmbpmS.js";const _=-3,m=_-1,y=!!f("esri-tests-disable-gpu-memory-measurements");class b{get size(){return this._size}constructor(s=10485760){this._maxSize=s,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._users=new Map,this._sizeLimits=new Map}destroy(){this.clearAll(),this._sizeLimits.clear(),this._users.clear(),this._db=null}register(s){this._users.set(s.id.slice(0,-1),s)}deregister(s){this.clear(s),this._sizeLimits.delete(s),this._users.delete(s.id.slice(0,-1))}get maxSize(){return this._maxSize}set maxSize(s){this._maxSize=Math.max(s,-1),this._checkSize()}getSize(s,t){return this._db.get(s.id+t)?.size??0}put(s,t,e,h,n){t=s.id+t;const i=this._db.get(t);if(i&&(this._size-=i.size,s.size-=i.size,this._db.delete(t),i.entry!==e&&this._notifyRemove(t,i.entry,i.size,0)),h>this._maxSize)return void this._notifyRemove(t,e,h,0);if(e===void 0)return void console.warn("Refusing to cache undefined entry ");if(!h||h<0)return y||console.warn(`Refusing to cache entry with size ${h} for key ${t}`),void this._notifyRemove(t,e,0,0);const r=1+Math.max(n,m)-_;this._db.set(t,new g(e,h,r)),this._size+=h,s.size+=h,this._checkSize()}updateSize(s,t){t=s.id+t;const e=this._db.get(t);if(!e)return;this._size-=e.size,s.size-=e.size;let h=e.entry.usedMemory;for(;h>this._maxSize;){const n=this._notifyRemove(t,e.entry,h,1);if(!(n!=null&&n>0))return void this._db.delete(t);h=n}e.size=h,this._size+=h,s.size+=h,this._checkSize()}pop(s,t){t=s.id+t;const e=this._db.get(t);if(e)return this._size-=e.size,s.size-=e.size,this._db.delete(t),++this._hit,e.entry;++this._miss}get(s,t){t=s.id+t;const e=this._db.get(t);if(e!==void 0)return this._db.delete(t),e.lives=e.lifetime,this._db.set(t,e),++this._hit,e.entry;++this._miss}peek(s,t){const e=this._db.get(s.id+t);return e?++this._hit:++this._miss,e?.entry}get performanceInfo(){const s={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},t={},e=new Array;this._db.forEach((i,r)=>{const o=i.lifetime;e[o]=(e[o]||0)+i.size,this._users.forEach(d=>{const{id:l,name:a}=d;if(r.startsWith(l)){const u=t[a]||0;t[a]=u+i.size}})});const h={};this._users.forEach(i=>{const r=i.name;if("hitRate"in i&&typeof i.hitRate=="number"&&!isNaN(i.hitRate)&&i.hitRate>0){const o=t[r]||0;t[r]=o,h[r]=Math.round(100*i.hitRate)+"%"}else h[r]="0%"});const n=Object.keys(t);n.sort((i,r)=>t[r]-t[i]),n.forEach(i=>s[i]=Math.round(t[i]/2**20)+"MB / "+h[i]);for(let i=e.length-1;i>=0;--i){const r=e[i];r&&(s["Priority "+(i+_-1)]=Math.round(r/this._size*100)+"%")}return s}resetStats(){this._hit=this._miss=0,this._users.forEach(s=>s.resetHitRate())}clear(s){const t=s.id;this._db.forEach((e,h)=>{h.startsWith(t)&&(this._size-=e.size,this._db.delete(h),this._notifyRemove(h,e.entry,e.size,0))}),s.size=0}clearAll(){this._db.forEach((s,t)=>this._notifyRemove(t,s.entry,s.size,0)),this._users.forEach(s=>s.size=0),this._size=0,this._db.clear()}*values(s){for(const[t,e]of this._db)t.startsWith(s.id)&&(yield e.entry)}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(s,t,e,h){const n=this._users.get(s.split(c)[0])?.removeFunc,i=n?.(t,h,e);return typeof i=="number"?i:null}_checkSize(){this._sizeLimits.forEach((s,t)=>this._checkSizeLimits(s,t)),this._checkSizeLimits(this.maxSize)}setMaxSize(s,t){t==null||t<=0?this._sizeLimits.delete(s):this._sizeLimits.set(s,t)}_checkSizeLimits(s,t){const e=t??this;if(e.size<=s)return;const h=t?.id;let n=!0;for(;n;){n=!1;for(const[i,r]of this._db)if(r.lifetime===0&&(!h||i.startsWith(h))){const o=t??this._users.get(i.split(c)[0]);if(this._purgeItem(i,r,o),e.size<=.9*s)return;n||=this._db.has(i)}}for(const[i,r]of this._db)if(!h||i.startsWith(h)){const o=t??this._users.get(i.split(c)[0]);if(this._purgeItem(i,r,o),e.size<=.9*s)return}}_purgeItem(s,t,e){if(this._db.delete(s),t.lives<=1){this._size-=t.size,e&&(e.size-=t.size);const h=this._notifyRemove(s,t.entry,t.size,1);h!=null&&h>0&&(this._size+=h,e&&(e.size+=h),t.lives=t.lifetime,t.size=h,this._db.set(s,t))}else--t.lives,this._db.set(s,t)}}class g{constructor(s,t,e){this.entry=s,this.size=t,this.lifetime=e,this.lives=e}}const c=":";export{b as h,_ as t};
