import{d as C}from"./asyncUtils-CwlZsPSF.js";import{O as h,ax as v,eK as y,eL as b,d as I,eM as p,eN as M}from"./main-pOgmbpmS.js";function _(n,t,s){const o=s?.createCollection?.()??new h,i=s?.recycleItems?new w:null,c=(e,a=0)=>{if(!e?.length)return;const r=o.splice(a,e.length);i?i.processRemoved(e):r.forEach(u)},l=(e,a=0)=>{if(!e?.length)return;const r=[];for(const m of e){const d=i?.use(m);if(d)r.push(d);else{const f=t(m);i?.register(m,f),r.push(f)}}o.addMany(r,a)},g=v(n,"after-splice",({added:e,start:a,removed:r})=>{c(r,a),l(e,a)},{sync:!0,onListenerRemove:e=>c(e.items),onListenerAdd:e=>l(e.items)});return o.addHandles(g),o}class w{constructor(){this._originalToMapped=new Map,this._removedItemCandidates=new Set,this._garbageCollectionQueued=!1}processRemoved(t){if(!t?.length)return;const{_removedItemCandidates:s}=this;for(const o of t)this._getItem(o)?.markRemoved()&&(s.add(o),this._queueGarbageCollection())}use(t){const s=this._getItem(t);return s&&(s.removed=!1),s?.item}register(t,s){this._originalToMapped.set(t,new R(s))}_getItem(t){return this._originalToMapped.get(t)}_queueGarbageCollection(){this._garbageCollectionQueued||(this._garbageCollectionQueued=!0,queueMicrotask(()=>this._garbageCollectCandidates()))}_garbageCollectCandidates(){this._garbageCollectionQueued=!1;const{_removedItemCandidates:t}=this,s=Array.from(t);t.clear(),s.forEach(o=>this._garbageCollectIfRemoved(o))}_garbageCollectIfRemoved(t){const{_originalToMapped:s}=this,o=this._getItem(t);o?.removed&&(u(o.item),s.delete(t))}}class R{constructor(t){this.item=t,this.removed=!1}markRemoved(){return this.removed=!0,!0}}function u(n){typeof n=="object"&&n&&("destroy"in n&&typeof n.destroy=="function"?n.destroy():y(n))}function T(n,t,s){const o=new h,i=_(n,e=>C(async a=>{const r=await t(e,a);if(b(a))throw u(r),I();return r}),s),c=()=>null,l=async e=>{const a=await e.promise,r=i.indexOf(e);r<0||o.splice(r,1,a)};o.addMany(i.items.map(c));for(const e of i)p(l(e));const g=i.on("after-splice",({added:e,start:a,deleteCount:r})=>{const m=o.splice(a,r);for(const d of m)u(d);if(e?.length){o.addMany(e.map(c),a);for(const d of e)p(l(d))}});return o.addHandles([M(i),g]),o}export{_ as c,T as u};
