import{bj as E,bU as x,s as N,ey as C}from"./main-6eEsl9OJ.js";import{L as j}from"./colorUtils-D1om_hYv.js";import{c as V}from"./fontUtils-CwhMXwvH.js";import{U as W,k as H}from"./quantizationUtils-j62jcfjD.js";import{u as T,y as q,g as I,f as G}from"./utils-8sNkJo3w.js";import{t as B,e as J,d as A,l as K}from"./symbolUtils-w6NHQbUN.js";import"./preload-helper-B76NpbEU.js";import"./vec42-CKs01hkn.js";import"./common-DQOJ18NT.js";import"./vec4f64-DPb6J-GU.js";import"./asyncUtils-SHsCTXd3.js";import"./jsonUtils-DIh9yTg7.js";import"./parser-C27q64z5.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-DL3nuHcq.js";import"./cimSymbolUtils-B04pXcN-.js";import"./utils-BV7DBUkI.js";import"./defaultCIMValues-CQAn2izL.js";import"./enums-_AFKM9Yk.js";import"./LRUCache-BB1cebTv.js";import"./MemCache-BSBM3Sy1.js";import"./jsxFactory-vcCo5QL-.js";import"./intl-Dk1N7wZP.js";import"./uuid-Cl5lrJ4c.js";import"./sanitizerUtils-CJlLEeXg.js";import"./mat2df32-Dpt2CT5P.js";import"./mat2d-D9DBP-jx.js";import"./webStyleSymbolUtils-DtjPYFJD.js";import"./devEnvironmentUtils-8WtPGj6h.js";import"./styleUtils-DkahzbXB.js";const O="picture-fill",Q="picture-marker",X="simple-fill",Y="simple-line",_="simple-marker",$="text",tt="Aa",et=B.size,z=B.maxSize,it=B.maxOutlineSize,D=B.lineWidth,F=225,ot=document.createElement("canvas");function Z(e,t,s){if(e.type==="polygon"){const o=e.extent,p=o.width===0?1:o.width,r=o.height===0?1:o.height;e=W({originPosition:"upperLeft",scale:[p/t,r/s],translate:[o.xmin,o.ymax]},{},e);let m="";for(let l=0;l<e.rings.length;l++){const n=e.rings[l];for(let h=0;h<n.length;h++){const u=n[h][0],d=n[h][1];let i="";h===0?(i=`M${u.toString()} ${d.toString()}`,m!==""&&(i=` ${i}`),m+=i):h===n.length-1?(i=`l${u.toString()} ${d.toString()} Z`,m!==""&&(i=` ${i}`),m+=i):(i=`l${u.toString()} ${d.toString()}`,m!==""&&(i=` ${i}`),m+=i)}}return m}if(e.type==="polyline"){const o=e.extent,p=o.width===0?1:o.width,r=o.height===0?1:o.height;e=H({originPosition:"upperLeft",scale:[p/t,r/s],translate:[o.xmin,o.ymax]},{},e);let m="";for(let l=0;l<e.paths.length;l++){const n=e.paths[l];for(let h=0;h<n.length;h++){const u=n[h][0],d=n[h][1];let i="";h===0?(i=`M${u.toString()} ${d.toString()}`,m!==""&&(i=` ${i}`),m+=i):(i=`l${u.toString()} ${d.toString()}`,m!==""&&(i=` ${i}`),m+=i)}}return m}return""}function R(e,t){const s=ot.getContext("2d"),o=[];t&&(t.weight&&o.push(t.weight),t.size&&o.push(t.size+"px"),t.family&&o.push(t.family)),s.font=o.join(" ");const{width:p,actualBoundingBoxLeft:r,actualBoundingBoxRight:m,actualBoundingBoxAscent:l,actualBoundingBoxDescent:n}=s.measureText(e);return{width:Math.ceil(Math.max(p,r+m)),height:Math.ceil(l+n),x:Math.floor(r),y:Math.floor((l-n)/2)}}function k(e){const t=e?.size;return{width:t!=null&&typeof t=="object"&&"width"in t?x(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?x(t.height):null}}async function nt(e,t){const s=t.fill,o=e.color;if(s?.type==="pattern"&&o&&e.type!==O){const p=await G(s.src,o.toCss(!0));s.src=p,t.fill=s}}async function at(e,t,s,o){if(!("font"in e)||!e.font||t.shape.type!=="text")return;try{await V(e.font)}catch{}const{width:p,height:r}=k(o);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:m,height:l,x:n,y:h}=R(t.shape.text,{weight:t.font?.weight,size:t.font?.size,family:t.font?.family});s[0]=p??m,s[1]=r??l,t.shape.x=n,t.shape.y=h;let u="angle"in e?e.angle:null;if(o?.rotation!=null&&(u=(u??0)+o.rotation),u){const d=u*(Math.PI/180),i=Math.abs(Math.sin(d)),a=Math.abs(Math.cos(d));s[1]=s[0]*i+s[1]*a}}}function lt(e,t,s,o,p){if(e.haloColor!=null&&e.haloSize!=null){p.masking??=s.map(()=>[]);const r=x(e.haloSize);o[0]+=r,o[1]+=r,s.unshift([{...t,fill:null,stroke:{color:e.haloColor,width:2*r,join:"round",cap:"round"}}]),p.masking.unshift([{shape:{type:"rect",x:0,y:0,width:o[0]+2*C,height:o[1]+2*C},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}e.backgroundColor==null&&e.borderLineColor==null||(o[0]+=2*C,o[1]+=2*C,s.unshift([{shape:{type:"rect",x:0,y:0,width:o[0],height:o[1]},fill:e.backgroundColor,stroke:{color:e.borderLineColor,width:x(e.borderLineSize)}}]),p.masking?.unshift([]))}function U(e,t){return e>t?"dark":"light"}function st(e,t){const s=typeof t?.size=="number"?t?.size:null,o=s!=null?x(s):null,p=t?.maxSize!=null?x(t.maxSize):null;let r="angle"in e?e.angle:null;t?.rotation!=null&&(r=(r??0)+t.rotation);const m=T(e);let l=q(e);rt(e,245)!=="dark"||t?.ignoreWhiteSymbols||(l={width:.75,...l,color:"#bdc3c7"});let n=null;const h={shape:null,fill:m,stroke:l,offset:[0,0]};l?.width&&(l.width=Math.min(l.width,it));const u=l?.width||0;let d=t?.size!=null&&(t?.scale==null||t?.scale),i=0,a=0,S=!1;switch(e.type){case _:{const f=e.style,{width:g,height:c}=k(t);let b=g===c&&g!=null?g:o??Math.min(x(e.size),p||z);if(t?.useMarkerSymbolSize===!0&&g!==null&&c!==null){const y=Math.min(x(e.size),p||z);b=y>g&&y>c?Math.min(g,c):y}switch(i=b,a=b,f){case"circle":h.shape={type:"circle",cx:0,cy:0,r:.5*b},d||(i+=u,a+=u);break;case"cross":h.shape={type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[i,.5*a]},{command:"M",values:[.5*i,0]},{command:"L",values:[.5*i,a]}]};break;case"diamond":h.shape={type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[.5*i,0]},{command:"L",values:[i,.5*a]},{command:"L",values:[.5*i,a]},{command:"Z",values:[]}]},d||(i+=u,a+=u);break;case"square":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,0]},{command:"L",values:[i,a]},{command:"L",values:[0,a]},{command:"Z",values:[]}]},d||(i+=u,a+=u),r&&(S=!0);break;case"triangle":h.shape={type:"path",path:[{command:"M",values:[.5*i,0]},{command:"L",values:[i,a]},{command:"L",values:[0,a]},{command:"Z",values:[]}]},d||(i+=u,a+=u),r&&(S=!0);break;case"x":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,a]},{command:"M",values:[i,0]},{command:"L",values:[0,a]}]},r&&(S=!0);break;case"path":h.shape={type:"path",path:e.path||""},d||(i+=u,a+=u),r&&(S=!0),d=!0}break}case Y:{const{width:f,height:g}=k(t),c=I(l).reduce((v,M)=>v+M,0),b=c&&Math.ceil(D/c),y=g??o??u,w=f??(c*b||D);if(d=!0,t?.geometry?.type==="polyline"&&t?.geometry?.extent){i=w,a=g??i;const v=1e3,M=.15*v;n=[i,a],a=n[0]>n[1]?v*n[1]/n[0]:v,i=n[0]>n[1]?v:v*n[0]/n[1],l?.width&&(l.width=l.width*v/(n[1]>n[0]?n[1]:n[0]),l.width>M&&(l.width=M)),h.shape={type:"path",path:Z(t.geometry,i,a)}}else i=t?.maxSize!=null?Math.min(w,t.maxSize):w,a=y,l&&(l.width=y),h.shape={type:"path",path:[{command:"M",values:[y/2,a/2]},{command:"L",values:[i-y/2,a/2]}]};break}case O:case X:{const f=typeof t?.symbolConfig=="object"&&!!t?.symbolConfig?.isSquareFill,{width:g,height:c}=k(t);i=!f&&g!==c||g==null?o??et:g,a=!f&&g!==c||c==null?i:c,d||(i+=u,a+=u),d=!0,t?.geometry?.extent&&t?.geometry?.type==="polygon"?(n=[i,a],a=n[0]>n[1]?1e3*n[1]/n[0]:1e3,i=n[0]>n[1]?1e3:1e3*n[0]/n[1],h.shape={type:"path",path:Z(t.geometry,i,a)}):h.shape=f?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[i,0]},{command:"L",values:[i,a]},{command:"L",values:[0,a]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:J.fill[0];break}case Q:{const f=Math.min(x(e.width),p||z),g=Math.min(x(e.height),p||z),{width:c,height:b}=k(t),y=c===b&&c!=null?c:o??Math.max(f,g),w=e.width/e.height;i=w<=1?Math.ceil(y*w):y,a=w<=1?y:Math.ceil(y/w),h.shape={type:"image",x:-Math.round(i/2),y:-Math.round(a/2),width:i,height:a,src:e.url||""},r&&(S=!0);break}case $:{const f=e,g=t?.overrideText||f.text||tt,c=f.font,{width:b,height:y}=k(t),w=y??o??Math.min(x(c.size),p||z),{width:v,height:M}=R(g,{weight:c.weight,size:w,family:c.family}),L=/[\uE600-\uE6FF]/.test(g);i=b??(L?w:v),a=L?w:M;let P=.5*(L?w:M);L&&(P+=5),h.shape={type:"text",text:g,x:f.xoffset||0,y:f.yoffset||P,align:"middle",alignBaseline:f.verticalAlignment,decoration:c&&c.decoration,rotated:f.rotated,kerning:f.kerning},h.font=c&&{size:w,style:c.style,decoration:c.decoration,weight:c.weight,family:c.family};break}}return{shapeDescriptor:h,size:[i,a],outputSize:n,renderOptions:{node:t?.node,scale:d,opacity:t?.opacity,rotations:[r],useRotationSize:S,effectView:t?.effectView,ariaLabel:t?.ariaLabel,clipBloomEffect:t?.clipBloomEffect}}}async function Ot(e,t){const{shapeDescriptor:s,size:o,renderOptions:p,outputSize:r}=st(e,t);if(!s.shape)throw new N("symbolPreview: renderPreviewHTML2D","symbol not supported.");await nt(e,s),await at(e,s,o,t);const m=[[s]];if(typeof t?.symbolConfig=="object"&&t?.symbolConfig?.applyColorModulation){const n=.6*o[0];m.unshift([{...s,offset:[-n,0],fill:A(s.fill,-.3)}]),m.push([{...s,offset:[n,0],fill:A(s.fill,.3)}]),o[0]+=2*n,p.scale=!1}e.type==="text"&&lt(e,s,m,o,p);const l=K(m,o,p);if(r&&l){const n=l.nodeName.toLowerCase()==="img"?l:l.firstChild;n.nodeName.toLowerCase()==="svg"&&n.setAttribute("viewBox",`0 0 ${o[0].toString()} ${o[1].toString()}`),n.setAttribute("width",r[0].toString()),n.setAttribute("height",r[1].toString()),r.length>2&&(n.style.setProperty("padding-left",r[2]?.toString()+"px"),n.style.setProperty("padding-right",r[2]?.toString()+"px"),n.style.setProperty("padding-top",r[3]?.toString()+"px"),n.style.setProperty("padding-bottom",r[3]?.toString()+"px"),n.style.setProperty("box-sizing","border-box"))}return l}function rt(e,t=F){const s=T(e),o=q(e),p=!s||"type"in s?null:new E(s),r=o?.color?new E(o?.color):null,m=p?U(j(p),t):null,l=r?U(j(r),t):null;return l?m?m===l?m:t>=F?"light":"dark":l:m}export{rt as getContrastingBackgroundTheme,st as getRenderSymbolParameters,Ot as previewSymbol2D};
