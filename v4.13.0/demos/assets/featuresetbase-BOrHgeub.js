import{ay as we,q as F,v as D,x as ae,H as Ne,G as Ee,an as Re,z as Ie,$ as Me,i$ as Oe,i as Ge,am as Ve,d_ as L,dZ as C,Y as ve,S as ze,j0 as He,bx as Je}from"./main-6eEsl9OJ.js";import{h as We}from"./TimeOnly-C1MWI3zZ.js";import{t as qe,D as Ke,l as le}from"./arcade--ugU4jnO.js";import{a as k,A as _e,z as ue,K as j,j as M,p as S,S as Be,i as De,y as ke,X as Se,q as Z,T as _,$ as te,b as W,G as Qe,N as B,V as Xe,Z as ne}from"./aiServices-CY5ayKbv.js";import{a as p,r as y,e as Ye,o as et}from"./enum-DjCgFROZ.js";import{R as tt,q as xe,p as nt,c as de,e as it,a as rt,b as ot,N as re,j as at,F as st,E as lt,L as J,B as ut,d as ie,f as $,k as ce}from"./featureSetUtils-W8hV-8X6.js";import{t as dt}from"./ImmutableArray-BPVd6ESQ.js";import{l as ct}from"./portalUtils-PGxtWSpY.js";import{u as mt,O as Ae}from"./SpatialFilter-3CkkBfgT.js";import{x as Ce,s as me}from"./shared-C3O93oAv.js";import{R as v}from"./WhereClause-Dv3x-MsT.js";import Ze from"./FeatureLayer-B1MnbWtG.js";import{m as P}from"./Field-CzUupKXc.js";import{f as ft,u as pt,s as yt}from"./utils-DSziZ_FA.js";import{s as K}from"./NetworkElement-BJ_oE6R5.js";import"./preload-helper-B76NpbEU.js";import"./UnknownTimeZone-ZLOR0Bi8.js";import"./featureConversionUtils-qJGwMYPr.js";import"./OptimizedFeature-DHftxjFm.js";import"./memoryEstimations-5hBnZCeh.js";import"./OptimizedGeometry-OYT6ACAY.js";import"./OptimizedFeatureSet-BR8EEvDc.js";import"./FieldsIndex-CRdljKn6.js";import"./timeZoneUtils-DmTpvLBr.js";import"./unitConversion-HPy-1Vfr.js";import"./number-BtRhnL1q.js";import"./uuid-Cl5lrJ4c.js";import"./commonProperties-DHiB1uzW.js";import"./MD5-MtSiOt06.js";import"./RelationshipQuery-BJHKxrzH.js";import"./Query-BQgZ7-at.js";import"./TimeExtent-DG27ZQvz.js";import"./FeatureType-CoKquuAr.js";import"./FeatureTemplate-U3P7jiAe.js";import"./Layer-DzZVuRQg.js";import"./PortalItem-8NBch2N-.js";import"./operatorsWorkerConnection-DDzoV8pC.js";import"./workers-m_rvw_QY.js";import"./Queue-DXtZaugk.js";import"./intl-Dk1N7wZP.js";import"./MultiOriginJSONSupport-Co5qTMH7.js";import"./layerContainerType-C5CzMsLd.js";import"./FeatureLayerBase-BMRrZ9we.js";import"./HeightModelInfo-JPXqCMoM.js";import"./OperationalLayer-DPy11VYP.js";import"./ElevationInfo-Dh54MbB6.js";import"./lengthUtils-DL53yBUT.js";import"./labelingInfo-DcSEjCI1.js";import"./asyncUtils-SHsCTXd3.js";import"./SimpleRenderer-CYj4Tzam.js";import"./commonProperties-ClpAoODy.js";import"./colorRamps-CKB7alIQ.js";import"./ColorStop-i4pxY5LE.js";import"./visualVariableUtils-Q9XaDxnO.js";import"./UniqueValueRenderer-C4s1PHAc.js";import"./diffUtils-BBoLSBHW.js";import"./RendererLegendOptions-BVVQbSEI.js";import"./styleUtils-DkahzbXB.js";import"./NormalizationBinParametersMixin-Dfo-UXv2.js";import"./labelUtils-C6yvQiEz.js";import"./LayerFloorInfo-CDcpg9U7.js";import"./Relationship-Bs1Yiz6F.js";import"./serviceCapabilitiesUtils-D0vZJ1w2.js";import"./infoFor3D-DhzudQro.js";import"./portalItemUtils-DES5WVek.js";import"./projectionUtils-BoGsVCso.js";import"./editsZScale-DnIrA7Ba.js";import"./queryZScale-2CgD0kOl.js";import"./FeatureSet-Brpa8p2L.js";import"./APIKeyMixin-ChUD2mxe.js";import"./ArcGISService-B_5_Lp9I.js";import"./BlendLayer-Ck8n336O.js";import"./jsonUtils-DIh9yTg7.js";import"./parser-C27q64z5.js";import"./mat4f32-Djp3mnm5.js";import"./mat4-DL3nuHcq.js";import"./common-DQOJ18NT.js";import"./CustomParametersMixin-DtqTEY_r.js";import"./DisplayFilteredLayer-DBbno1JO.js";import"./scaleUtils-DbIWZ4jS.js";import"./displayFilterUtils-BomPJvlq.js";import"./EditBusLayer-DPKrQ7hl.js";import"./FeatureEffectLayer-BOH1JMG6.js";import"./FeatureEffect-DQseNN2l.js";import"./FeatureFilter-DC96N5sf.js";import"./fieldType-B4FIlvI-.js";import"./FeatureReductionLayer-C-r_Ys9m.js";import"./FeatureReductionSelection-DYywfSvI.js";import"./jsonUtils-DS7WiS7O.js";import"./typeUtils-BHaCxg3_.js";import"./ClassBreaksRenderer-CFWq_Bnc.js";import"./LRUCache-BB1cebTv.js";import"./MemCache-BSBM3Sy1.js";import"./DictionaryScriptEvaluator-D49tDkyF.js";import"./Version-DkcAnD6Q.js";import"./ArcadeExpression-CYMFQJdI.js";import"./utils-BV7DBUkI.js";import"./defaultCIMValues-CQAn2izL.js";import"./enums-_AFKM9Yk.js";import"./heatmapUtils-eUEoMYnq.js";import"./vec42-CKs01hkn.js";import"./vec4f64-DPb6J-GU.js";import"./OrderedLayer-lZi2QsQ3.js";import"./OrderByInfo-BuTcfGSR.js";import"./PortalLayer-CNZn_9Ud.js";import"./RefreshableLayer-WBFfTNo4.js";import"./ScaleRangeLayer-BjLqqFXw.js";import"./TemporalLayer-CkjYEXTj.js";import"./TimeInfo-CmpDscoM.js";import"./TrackableLayer-B96hXRO_.js";import"./fieldProperties-C388kZ5z.js";import"./TitleCreator-DcbQ6Sil.js";import"./versionUtils-BIyNCpWh.js";import"./styleUtils-DEvcoecU.js";import"./popupUtils-BUD8sQLV.js";import"./interfaces-CL2NbQte.js";var je;(function(n){n[n.RTJunctionJunctionConnectivity=1]="RTJunctionJunctionConnectivity",n[n.RTContainment=2]="RTContainment",n[n.RTAttachment=3]="RTAttachment",n[n.RTJunctionEdgeConnectivity=4]="RTJunctionEdgeConnectivity",n[n.RTEdgeJunctionEdgeConnectivity=5]="RTEdgeJunctionEdgeConnectivity"})(je||(je={}));new we({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation",path:"path",circuit:"circuit"});const O=new we({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new we({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let q=class extends K{constructor(n){super(n),this.type="telecomNetworkElement",this.firstUnit=null,this.numUnits=null}};F([D({json:{write:!1}})],q.prototype,"type",void 0),F([D({json:{write:!0}})],q.prototype,"firstUnit",void 0),F([D({json:{write:!0}})],q.prototype,"numUnits",void 0),q=F([ae("esri.rest.networks.support.TelecomNetworkElement")],q);let A=class extends Ie{constructor(n){super(n),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(n,s){return s.fromFirstUnit||s.fromNumUnits?new q({globalId:s.fromGlobalId,networkSourceId:s.fromNetworkSourceId,terminalId:s.fromTerminalId,firstUnit:s.fromFirstUnit,numUnits:s.fromNumUnits}):new K({globalId:s.fromGlobalId,networkSourceId:s.fromNetworkSourceId,terminalId:s.fromTerminalId})}writeFromNetworkElement(n,s){if(n&&(s.fromGlobalId=n.globalId,s.fromNetworkSourceId=n.networkSourceId,s.fromTerminalId=n.terminalId,n.type==="telecomNetworkElement")){const t=n;s.fromFirstUnit=t.firstUnit,s.fromNumUnits=t.numUnits}}readToNetworkElement(n,s){return s.toFirstUnit||s.toNumUnits?new q({globalId:s.toGlobalId,networkSourceId:s.toNetworkSourceId,terminalId:s.toTerminalId,firstUnit:s.toFirstUnit,numUnits:s.toNumUnits}):new K({globalId:s.toGlobalId,networkSourceId:s.toNetworkSourceId,terminalId:s.toTerminalId})}writeToNetworkElement(n,s){if(n&&(s.toGlobalId=n.globalId,s.toNetworkSourceId=n.networkSourceId,s.toTerminalId=n.terminalId,n.type==="telecomNetworkElement")){const t=n;s.toFirstUnit=t.firstUnit,s.toNumUnits=t.numUnits}}};F([D({type:String,json:{write:!0}})],A.prototype,"globalId",void 0),F([D({type:O.apiValues,json:{type:O.jsonValues,read:O.read,write:O.write}})],A.prototype,"associationType",void 0),F([D({type:K,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number},fromFirstUnit:{type:Number},fromNumUnits:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId","fromFirstUnit","fromNumUnits"]}}})],A.prototype,"fromNetworkElement",void 0),F([Ne("fromNetworkElement")],A.prototype,"readFromNetworkElement",null),F([Ee("fromNetworkElement")],A.prototype,"writeFromNetworkElement",null),F([D({type:K,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number},toFirstUnit:{type:Number},toNumUnits:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId","toFirstUnit","toNumUnits"]}}})],A.prototype,"toNetworkElement",void 0),F([Ne("toNetworkElement")],A.prototype,"readToNetworkElement",null),F([Ee("toNetworkElement")],A.prototype,"writeToNetworkElement",null),F([D({type:Re,json:{write:!0}})],A.prototype,"geometry",void 0),F([D({type:String,json:{write:!0}})],A.prototype,"errorMessage",void 0),F([D({type:Number,json:{write:!0}})],A.prototype,"percentAlong",void 0),F([D({type:Number,json:{write:!0}})],A.prototype,"errorCode",void 0),F([D({type:Boolean,json:{write:!0}})],A.prototype,"isContentVisible",void 0),F([D({type:Number,json:{write:!0}})],A.prototype,"status",void 0),A=F([ae("esri.rest.networks.support.Association")],A);let oe=class extends Ie{constructor(s){super(s),this.associations=[]}};F([D({type:[A],json:{write:!0}})],oe.prototype,"associations",void 0),oe=F([ae("esri.rest.networks.support.QueryAssociationsResult")],oe);function wt(n){const{returnDeletes:s,elements:t,gdbVersion:r,moment:I}=n.toJSON();return{returnDeletes:s,elements:JSON.stringify(t.map(g=>({globalId:g.globalId,networkSourceId:g.networkSourceId,terminalId:g.terminalId}))),types:JSON.stringify(n.types.map(g=>O.toJSON(g))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:r,moment:I??Date.now()}}async function It(n,s,t){const r=ft(n),I={...wt(s),f:"json"},g=pt({...r.query,...I}),e=yt(g,{...t,method:"post"}),i=`${r.path}/associations/query`,{data:a}=await Me(i,e),l=oe.fromJSON(a);return s.types.includes("connectivity")&&Oe(Ge.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://arcg.is/11Tr8a#types",version:"4.29",warnOnce:!0}),l}var pe;let z=pe=class extends Ie{static from(n){return Ve(pe,n)}constructor(n){super(n),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};F([D({type:Boolean,json:{write:!0}})],z.prototype,"returnDeletes",void 0),F([D({type:[K],json:{write:!0}})],z.prototype,"elements",void 0),F([D({type:[O.apiValues],json:{type:O.jsonValues,read:O.read,write:O.write}})],z.prototype,"types",void 0),F([D({type:String,json:{write:!0}})],z.prototype,"gdbVersion",void 0),F([D({type:Date,json:{type:Number,write:{writer:(n,s)=>{s.moment=n?.getTime()}}}})],z.prototype,"moment",void 0),z=pe=F([ae("esri.rest.networks.support.QueryAssociationsParameters")],z);function gt(n){if(n.length===1){if(C(n[0]))return le("distinct",n[0],-1);if(W(n[0]))return le("distinct",n[0].toArray(),-1)}return le("distinct",n,-1)}function fe(n,s,t){const r=n.getVariables();if(r.length>0){const I={};for(const g of r)I[g]=s.evaluateIdentifier(t,{name:g});n.parameters=I}return n}function c(n,s,t=null){for(const r in n)if(r.toLowerCase()===s.toLowerCase())return n[r];return t}function Ue(n){if(n===null)return null;const s={type:c(n,"type",""),name:c(n,"name","")};if(s.type==="range")s.range=c(n,"range",[]);else{s.codedValues=[];for(const t of c(n,"codedValues",[]))s.codedValues.push({name:c(t,"name",""),code:c(t,"code",null)})}return s}function ye(n){if(n===null)return null;const s={},t=c(n,"wkt");t!==null&&(s.wkt=t);const r=c(n,"wkid");return r!==null&&(s.wkid=r),s}function Le(n){if(n===null)return null;const s={hasZ:c(n,"hasz",!1),hasM:c(n,"hasm",!1)},t=c(n,"spatialreference");t!=null&&(s.spatialReference=ye(t));const r=c(n,"x",null);if(r!==null)return s.x=r,s.y=c(n,"y",null),s.hasZ&&(s.z=c(n,"z",null)),s.hasM&&(s.m=c(n,"m",null)),s;const I=c(n,"rings",null);if(I!==null)return s.rings=I,s;const g=c(n,"paths",null);if(g!==null)return s.paths=g,s;const e=c(n,"points",null);if(e!==null)return s.points=e,s;for(const i of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const a=c(n,i,null);a!==null&&(s[i]=a)}return s}function ht(n,s){for(const t of s)if(t===n)return!0;return!1}function bt(n){return!!n.layerDefinition&&!!n.featureSet&&ht(n.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&C(n.layerDefinition.fields)!==!1&&C(n.featureSet.features)!==!1}function Q(n){return n?.toLowerCase()==="utc"?"UTC":n?.toLowerCase()==="unknown"?"Unknown":n}async function Ft(n,s,t,r,I,g,e){const i=await n.getFeatureSetInfo();if((i?.layerId??null)===null||!I.layerIdLookup.get(i.layerId))return null;const a=n.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),l=[];switch(t){case"connected":l.push("connectivity"),l.push("junction-edge-from-connectivity"),l.push("junction-edge-to-connectivity"),l.push("junction-edge-midspan-connectivity"),l.push("junction-junction-connectivity");break;case"container":case"content":l.push("containment");break;case"structure":case"attached":l.push("attachment");break;case"junctionedge":l.push("junction-edge-from-connectivity"),l.push("junction-edge-to-connectivity");break;case"midspan":l.push("junction-edge-midspan-connectivity");break;default:throw new p(g,y.InvalidParameter,e)}let w=null,m=!1;if(r!==null&&r!==""&&r!==void 0){for(const d of I.terminals)d.terminalName===r&&(w=d.terminalId);w===null&&(m=!0)}const u=[];if(!m){const d=new K({globalId:s.field(n.globalIdField),networkSourceId:I.layerIdLookup.get(i.layerId).sourceId,...w?{terminalId:w}:""}),f=await It(a,new z({types:l,elements:[d]}));let x=0;for(const h of f.associations){let b=null,E="",R="";if(h.fromNetworkElement?.globalId===d.globalId?(b=h.toNetworkElement,R="to"):h.toNetworkElement?.globalId===d.globalId&&(b=h.fromNetworkElement,R="from"),!b)continue;switch(t){case"attached":if(h.associationType!=="attachment"||R!=="to")continue;break;case"structure":if(h.associationType!=="attachment"||R!=="from")continue;break;case"container":if(h.associationType!=="containment"||R!=="from")continue;break;case"content":if(h.associationType!=="containment"||R!=="to")continue;break;case"connected":break;case"junctionedge":h.associationType==="junction-edge-to-connectivity"?E="to":h.associationType==="junction-edge-from-connectivity"&&(E="from");break;case"midspan":if(h.associationType!=="junction-edge-midspan-connectivity")continue}const X=I.sourceIdLookup.get(b.networkSourceId)?.className??"";u.push(new Je({geometry:null,attributes:{objectId:x++,globalId:b.globalId,percentAlong:h.percentAlong??0,isContentVisible:h.isContentVisible?0:1,className:X,side:E}}))}}const o=new Ze({source:u,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new P({name:"objectId",alias:"objectId",type:"oid"}),new P({name:"globalId",alias:"globalId",type:"global-id"}),new P({name:"percentAlong",alias:"percentAlong",type:"double"}),new P({name:"side",alias:"side",type:"string"}),new P({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new P({name:"className",alias:"className",type:"string"})]});return re(o)}function ji(n){if(n.mode==="async"){n.functions.timezone=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,1,2,t,r),_e(e[0])||ue(e[0]))return"Unknown";if(j(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?Q("unknown"):Q(e[0].dateFieldsTimeZone);if(!(e[1]instanceof M)||e[1].hasField("type")===!1)throw new p(t,y.InvalidParameter,r);const l=e[1].field("type");if(L(l)===!1)throw new p(t,y.InvalidParameter,r);switch(S(l).toLowerCase()){case"preferredtimezone":return Q(e[0].preferredTimeZone);case"editfieldsinfo":return Q(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return Q(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&L(e[1].field("fieldname")))return Q(e[0].fieldTimeZone(S(e[1].field("fieldname"))))}throw new p(t,y.InvalidParameter,r)}const i=Be(e[0],De(t));if(i===null)return null;const a=i.timeZone;return a==="system"?We.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a.toLowerCase()==="unknown"?"Unknown":a})},n.functions.sqltimestamp=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{k(e,1,3,t,r);const i=e[0];if(ke(i)){if(e.length===1)return i.toSQLWithKeyword();if(e.length===2)return i.changeTimeZone(S(e[1])).toSQLWithKeyword();throw new p(t,y.InvalidParameter,r)}if(ue(i))return i.toSQLWithKeyword();if(j(i)){if(e.length!==3)throw new p(t,y.InvalidParameter,r);await i.load();const a=S(e[1]);if(ue(e[2]))return e[2].toSQLWithKeyword();if(ke(e[2])===!1)throw new p(t,y.InvalidParameter,r);const l=i.fieldTimeZone(a);return l==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(l).toSQLWithKeyword()}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"sqltimestamp",min:2,max:4}),n.functions.featuresetbyid=function(t,r){return n.standardFunctionAsync(t,r,(I,g,e)=>{if(k(e,2,4,t,r),Se(e[0])){const i=S(e[1]);let a=Z(e[2],null);const l=_(Z(e[3],!0));if(a===null&&(a=["*"]),C(a)===!1)throw new p(t,y.InvalidParameter,r);return e[0].featureSetById(i,l,a)}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"featuresetbyid",min:2,max:4});const s=new Ye(["datasource","parent","root"]);n.functions.getfeatureset=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,1,2,t,r),te(e[0])){const i=e[1]==null?"datasource":s.lookup(S(e[1]));return tt(e[0].fullSchema(),i,t.lrucache,t.interceptor,t.spatialReference)}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"getfeatureset",min:1,max:2}),n.functions.featuresetbyportalitem=function(t,r){return n.standardFunctionAsync(t,r,(I,g,e)=>{if(k(e,2,5,t,r),e[0]===null)throw new p(t,y.PortalRequired,r);if(e[0]instanceof qe){const m=S(e[1]),u=S(e[2]);let o=Z(e[3],null);const d=_(Z(e[4],!0));if(o===null&&(o=["*"]),C(o)===!1)throw new p(t,y.InvalidParameter,r);let f;return f=t.services?.portal?t.services.portal:ve.getDefault(),f=ct(e[0],f),xe(m,u,t.spatialReference,o,d,f,t.lrucache,t.interceptor)}if(L(e[0])===!1)throw new p(t,y.PortalRequired,r);const i=S(e[0]),a=S(e[1]);let l=Z(e[2],null);const w=_(Z(e[3],!0));if(l===null&&(l=["*"]),C(l)===!1)throw new p(t,y.InvalidParameter,r);return xe(i,a,t.spatialReference,l,w,t.services?.portal??ve.getDefault(),t.lrucache,t.interceptor)})},n.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),n.functions.featuresetbyname=function(t,r){return n.standardFunctionAsync(t,r,(I,g,e)=>{if(k(e,2,4,t,r),Se(e[0])){const i=S(e[1]);let a=Z(e[2],null);const l=_(Z(e[3],!0));if(a===null&&(a=["*"]),C(a)===!1)throw new p(t,y.InvalidParameter,r);return e[0].featureSetByName(i,l,a)}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"featuresetbyname",min:2,max:4}),n.functions.featureset=function(t,r){return n.standardFunction(t,r,(I,g,e)=>{k(e,1,1,t,r);const i={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(L(e[0])){const a=JSON.parse(e[0]);a.layerDefinition!==void 0?(i.layerDefinition=a.layerDefinition,i.featureSet=a.featureSet,a.layerDefinition.spatialReference&&(i.layerDefinition.spatialReference=a.layerDefinition.spatialReference)):(i.featureSet.features=a.features,i.featureSet.geometryType=a.geometryType,i.layerDefinition.geometryType=i.featureSet.geometryType,i.layerDefinition.objectIdField=a.objectIdFieldName??"",i.layerDefinition.typeIdField=a.typeIdFieldName,i.layerDefinition.globalIdField=a.globalIdFieldName,i.layerDefinition.fields=a.fields,a.spatialReference&&(i.layerDefinition.spatialReference=a.spatialReference))}else{if(!(e[0]instanceof M))throw new p(t,y.InvalidParameter,r);{const a=JSON.parse(e[0].castToText(!0)),l=c(a,"layerdefinition");if(l!==null){i.layerDefinition.geometryType=c(l,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.globalIdField=c(l,"globalidfield",""),i.layerDefinition.objectIdField=c(l,"objectidfield",""),i.layerDefinition.typeIdField=c(l,"typeidfield",""),i.layerDefinition.hasZ=c(l,"hasz",!1)===!0,i.layerDefinition.hasM=c(l,"hasm",!1)===!0;const w=c(l,"spatialreference");w&&(i.layerDefinition.spatialReference=ye(w));const m=[];for(const o of c(l,"fields",[])){const d={name:c(o,"name",""),alias:c(o,"alias",""),type:c(o,"type",""),nullable:c(o,"nullable",!0),editable:c(o,"editable",!0),length:c(o,"length",null),domain:Ue(c(o,"domain"))};m.push(d)}i.layerDefinition.fields=m;const u=c(a,"featureset");if(u){const o={};for(const d of m)o[d.name.toLowerCase()]=d.name;for(const d of c(u,"features",[])){const f={},x=c(d,"attributes",{});for(const h in x)f[o[h.toLowerCase()]]=x[h];i.featureSet.features.push({attributes:f,geometry:Le(c(d,"geometry"))})}}}else{i.layerDefinition.hasZ=c(a,"hasz",!1)===!0,i.layerDefinition.hasM=c(a,"hasm",!1)===!0,i.layerDefinition.geometryType=c(a,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.objectIdField=c(a,"objectidfieldname",""),i.layerDefinition.typeIdField=c(a,"typeidfieldname","");const w=c(a,"spatialreference");w&&(i.layerDefinition.spatialReference=ye(w));const m=[],u=c(a,"fields",null);if(!C(u))throw new p(t,y.InvalidParameter,r);for(const f of u){const x={name:c(f,"name",""),alias:c(f,"alias",""),type:c(f,"type",""),nullable:c(f,"nullable",!0),editable:c(f,"editable",!0),length:c(f,"length",null),domain:Ue(c(f,"domain"))};m.push(x)}i.layerDefinition.fields=m;const o={};for(const f of m)o[f.name.toLowerCase()]=f.name;let d=c(a,"features",null);if(C(d))for(const f of d){const x={},h=c(f,"attributes",{});for(const b in h)x[o[b.toLowerCase()]]=h[b];i.featureSet.features.push({attributes:x,geometry:Le(c(f,"geometry",null))})}else d=null,i.featureSet.features=d}}}if(bt(i)===!1)throw new p(t,y.InvalidParameter,r);return i.layerDefinition.geometryType||(i.layerDefinition.geometryType="esriGeometryNull"),nt.create(i,t.spatialReference)})},n.signatures.push({name:"featureset",min:1,max:1}),n.functions.filter=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,2,2,t,r),C(e[0])||W(e[0])){const i=[];let a,l=e[0];if(l instanceof dt&&(l=l.toArray()),!Qe(e[1]))throw new p(t,y.InvalidParameter,r);a=e[1].createFunction(t);for(const w of l){const m=a(w);ze(m)?await m===!0&&i.push(w):m===!0&&i.push(w)}return i}if(j(e[0])){const i=await e[0].load(),a=v.create(e[1],{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),l=a.getVariables();if(l.length>0){const w={};for(const m of l)w[m]=n.evaluateIdentifier(t,{name:m});a.parameters=w}return new de({parentfeatureset:e[0],whereclause:a})}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"filter",min:2,max:2}),n.functions.orderby=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,2,2,t,r),j(e[0])){const i=new it(e[1]);return new rt({parentfeatureset:e[0],orderbyclause:i})}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"orderby",min:2,max:2}),n.functions.top=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,2,2,t,r),j(e[0]))return new ot({parentfeatureset:e[0],topnum:e[1]});if(C(e[0]))return B(e[1])>=e[0].length?e[0].slice():e[0].slice(0,B(e[1]));if(W(e[0]))return B(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,B(e[1]));throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"top",min:2,max:2}),n.functions.first=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,1,1,t,r),j(e[0])){const i=await e[0].first(I.abortSignal);if(i!==null){const a=Ke.createFromGraphicLikeObject(i.geometry,i.attributes,e[0],t.timeZone);return a._underlyingGraphic=i,a}return i}return C(e[0])?e[0].length===0?null:e[0][0]:W(e[0])?e[0].length()===0?null:e[0].get(0):null})},n.signatures.push({name:"first",min:1,max:1}),n.functions.attachments=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{k(e,1,2,t,r);const i={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof M){if(e[1].hasField("minsize")&&(i.minsize=B(e[1].field("minsize"))),e[1].hasField("metadata")&&(i.returnMetadata=_(e[1].field("metadata"))),e[1].hasField("maxsize")&&(i.maxsize=B(e[1].field("maxsize"))),e[1].hasField("types")){const a=Xe(e[1].field("types"),!1);a.length>0&&(i.types=a)}}else if(e[1]!==null)throw new p(t,y.InvalidParameter,r)}if(te(e[0])){const a=e[0]._layer;let l;if(j(a))l=a;else{if(a==null||!Ce(a))return[];l=re(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await l.load(),l.queryAttachments(e[0].field(l.objectIdField),i.minsize,i.maxsize,i.types,i.returnMetadata)}if(e[0]===null)return[];throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"attachments",min:1,max:2}),n.functions.featuresetbyrelationshipname=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{k(e,2,4,t,r);const i=e[0],a=S(e[1]);let l=Z(e[2],null);const w=_(Z(e[3],!0));if(l===null&&(l=["*"]),C(l)===!1)throw new p(t,y.InvalidParameter,r);if(e[0]===null)return null;if(!te(e[0]))throw new p(t,y.InvalidParameter,r);const m=i._layer;let u;if(j(m))u=m;else{if(m==null||!Ce(m))return null;u=re(m,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}u=await u.load();const o=u.relationshipMetaData().filter(b=>b.name===a);if(o.length===0)return null;if(o[0].relationshipTableId!==void 0&&o[0].relationshipTableId!==null&&o[0].relationshipTableId>-1)return at(u,o[0],i.field(u.objectIdField),u.spatialReference,l,w,t.lrucache,t.interceptor);let d=u.serviceUrl();if(!d)return null;d=d.charAt(d.length-1)==="/"?d+o[0].relatedTableId.toString():d+"/"+o[0].relatedTableId.toString();const f=await st(d,u.spatialReference,l,w,t.lrucache,t.interceptor);await f.load();let x=f.relationshipMetaData();if(x=x.filter(b=>b.id===o[0].id),i.hasField(o[0].keyField)===!1||i.field(o[0].keyField)===null){const b=await u.getFeatureByObjectId(i.field(u.objectIdField),[o[0].keyField]);if(b){const E=v.create(x[0].keyField+"= @id",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});return E.parameters={id:b.attributes[o[0].keyField]},f.filter(E)}return new mt({parentfeatureset:f})}const h=v.create(x[0].keyField+"= @id",{fieldsIndex:f.getFieldsIndex(),timeZone:f.dateFieldsTimeZoneDefaultUTC});return h.parameters={id:i.field(o[0].keyField)},f.filter(h)})},n.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),n.functions.featuresetbyassociation=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{k(e,2,3,t,r);const i=e[0],a=et(S(Z(e[1],""))),l=L(e[2])?S(e[2]):null;if(e[0]===null)return null;if(!te(e[0]))throw new p(t,y.InvalidParameter,r);let w=i._layer;if(w instanceof Ze&&(w=re(w,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),w===null||j(w)===!1)return null;await w.load();const m=w.serviceUrl(),u=await lt(m,t.spatialReference,!0);if(u.unVersion>=8)return await Ft(w,i,a,l,u,t,r);const o=u.associations;let d=null,f=null,x=!1;if(l!==null&&l!==""&&l!==void 0){for(const N of u.terminals)N.terminalName===l&&(f=N.terminalId);f===null&&(x=!0)}const h=o.getFieldsIndex(),b=h.get("TOGLOBALID").name,E=h.get("FROMGLOBALID").name,R=h.get("TOTERMINALID").name,X=h.get("FROMTERMINALID").name,Y=h.get("FROMNETWORKSOURCEID").name,ee=h.get("TONETWORKSOURCEID").name,H=h.get("ASSOCIATIONTYPE").name,$e=h.get("ISCONTENTVISIBLE").name,Pe=h.get("OBJECTID").name;for(const N of w.fields)if(N.type==="global-id"){d=i.field(N.name);break}let G=null,ge=new J(new P({name:"percentalong",alias:"percentalong",type:"double"}),v.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),he=new J(new P({name:"side",alias:"side",type:"string"}),v.create("''",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));const U="globalid",be="globalId",Fe={};for(const N in u.lkp)Fe[N]=u.lkp[N].sourceId;const V=new ut(new P({name:"classname",alias:"classname",type:"string"}),null,Fe);let T="";switch(a){case"midspan":{T=`((${b}='${d}') OR ( ${E}='${d}')) AND (${H} IN (5))`,V.codefield=v.create(`CASE WHEN (${b}='${d}') THEN ${Y} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const N=me($.findField(o.fields,E));N.name=U,N.alias=U,G=new J(N,v.create(`CASE WHEN (${E}='${d}') THEN ${b} ELSE ${E} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),ge=u.unVersion>=4?new ce($.findField(o.fields,h.get("PERCENTALONG").name)):new J(new P({name:"percentalong",alias:"percentalong",type:"double"}),v.create("0",{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{T=`((${b}='${d}') OR ( ${E}='${d}')) AND (${H} IN (4,6))`,V.codefield=v.create(`CASE WHEN (${b}='${d}') THEN ${Y} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const N=me($.findField(o.fields,E));N.name=U,N.alias=U,G=new J(N,v.create(`CASE WHEN (${E}='${d}') THEN ${b} ELSE ${E} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC})),he=new J(new P({name:"side",alias:"side",type:"string"}),v.create(`CASE WHEN (${H}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let N=`${b}='@T'`,Te=`${E}='@T'`;f!==null&&(N+=` AND ${R}=@A`,Te+=` AND ${X}=@A`),T="(("+N+") OR ("+Te+"))",T=ne(T,"@T",d??""),N=ne(N,"@T",d??""),f!==null&&(N=ne(N,"@A",f.toString()),T=ne(T,"@A",f.toString())),V.codefield=v.create("CASE WHEN "+N+` THEN ${Y} ELSE ${ee} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC});const se=me($.findField(o.fields,E));se.name=U,se.alias=U,G=new J(se,v.create("CASE WHEN "+N+` THEN ${E} ELSE ${b} END`,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}));break}case"container":T=`${b}='${d}' AND ${H} = 2`,f!==null&&(T+=` AND ${R} = `+f.toString()),V.codefield=Y,T="( "+T+" )",G=new ie($.findField(o.fields,E),U,U);break;case"content":T=`(${E}='${d}' AND ${H} = 2)`,f!==null&&(T+=` AND ${X} = `+f.toString()),V.codefield=ee,T="( "+T+" )",G=new ie($.findField(o.fields,b),U,U);break;case"structure":T=`(${b}='${d}' AND ${H} = 3)`,f!==null&&(T+=` AND ${R} = `+f.toString()),V.codefield=Y,T="( "+T+" )",G=new ie($.findField(o.fields,E),U,be);break;case"attached":T=`(${E}='${d}' AND ${H} = 3)`,f!==null&&(T+=` AND ${X} = `+f.toString()),V.codefield=ee,T="( "+T+" )",G=new ie($.findField(o.fields,b),U,be);break;default:throw new p(t,y.InvalidParameter,r)}return x&&(T="1 <> 1"),new $({parentfeatureset:o,adaptedFields:[new ce($.findField(o.fields,Pe)),new ce($.findField(o.fields,$e)),G,he,V,ge],extraFilter:T?v.create(T,{fieldsIndex:o.getFieldsIndex(),timeZone:o.dateFieldsTimeZoneDefaultUTC}):null})})},n.signatures.push({name:"featuresetbyassociation",min:2,max:6}),n.functions.groupby=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,3,3,t,r),!j(e[0]))throw new p(t,y.InvalidParameter,r);const i=await e[0].load(),a=[],l=[];let w=!1,m=[];if(L(e[1]))m.push(e[1]);else if(e[1]instanceof M)m.push(e[1]);else if(C(e[1]))m=e[1];else{if(!W(e[1]))throw new p(t,y.InvalidParameter,r);m=e[1].toArray()}for(const u of m)if(L(u)){const o=v.create(S(u),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),d=Ae(o)===!0?S(u):"%%%%FIELDNAME";a.push({name:d,expression:o}),d==="%%%%FIELDNAME"&&(w=!0)}else{if(!(u instanceof M))throw new p(t,y.InvalidParameter,r);{const o=u.hasField("name")?u.field("name"):"%%%%FIELDNAME",d=u.hasField("expression")?u.field("expression"):"";if(o==="%%%%FIELDNAME"&&(w=!0),!o)throw new p(t,y.InvalidParameter,r);a.push({name:o,expression:v.create(d||o,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(m=[],L(e[2]))m.push(e[2]);else if(C(e[2]))m=e[2];else if(W(e[2]))m=e[2].toArray();else{if(!(e[2]instanceof M))throw new p(t,y.InvalidParameter,r);m.push(e[2])}for(const u of m){if(!(u instanceof M))throw new p(t,y.InvalidParameter,r);{const o=u.hasField("name")?u.field("name"):"",d=u.hasField("statistic")?u.field("statistic"):"",f=u.hasField("expression")?u.field("expression"):"";if(!(o&&d&&L(d)&&f))throw new p(t,y.InvalidParameter,r);l.push({name:o,statistic:d,expression:v.create(f,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(w){const u={};for(const d of i.fields)u[d.name.toLowerCase()]=1;for(const d of a)d.name!=="%%%%FIELDNAME"&&(u[d.name.toLowerCase()]=1);for(const d of l)d.name!=="%%%%FIELDNAME"&&(u[d.name.toLowerCase()]=1);let o=0;for(const d of a)if(d.name==="%%%%FIELDNAME"){for(;u["field_"+o.toString()]===1;)o++;u["field_"+o.toString()]=1,d.name="FIELD_"+o.toString()}}for(const u of a)fe(u.expression,n,t);for(const u of l)fe(u.expression,n,t);return e[0].groupby(a,l)})},n.signatures.push({name:"groupby",min:3,max:3}),n.functions.distinct=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(j(e[0])){k(e,2,2,t,r);const i=await e[0].load(),a=[];let l=[];if(L(e[1]))l.push(e[1]);else if(e[1]instanceof M)l.push(e[1]);else if(C(e[1]))l=e[1];else{if(!W(e[1]))throw new p(t,y.InvalidParameter,r);l=e[1].toArray()}let w=!1;for(const m of l)if(L(m)){const u=v.create(S(m),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),o=Ae(u)===!0?S(m):"%%%%FIELDNAME";a.push({name:o,expression:u}),o==="%%%%FIELDNAME"&&(w=!0)}else{if(!(m instanceof M))throw new p(t,y.InvalidParameter,r);{const u=m.hasField("name")?m.field("name"):"%%%%FIELDNAME",o=m.hasField("expression")?m.field("expression"):"";if(u==="%%%%FIELDNAME"&&(w=!0),!u)throw new p(t,y.InvalidParameter,r);a.push({name:u,expression:v.create(o||u,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(w){const m={};for(const o of i.fields)m[o.name.toLowerCase()]=1;for(const o of a)o.name!=="%%%%FIELDNAME"&&(m[o.name.toLowerCase()]=1);let u=0;for(const o of a)if(o.name==="%%%%FIELDNAME"){for(;m["field_"+u.toString()]===1;)u++;m["field_"+u.toString()]=1,o.name="FIELD_"+u.toString()}}for(const m of a)fe(m.expression,n,t);return e[0].groupby(a,[])}return gt(e)})},n.functions.getfeaturesetinfo=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,1,1,t,r),!j(e[0]))return null;const i=await e[0].getFeatureSetInfo();return i?M.convertObjectToArcadeDictionary({layerId:i.layerId,layerName:i.layerName,itemId:i.itemId,serviceLayerUrl:i.serviceLayerUrl,webMapLayerId:i.webMapLayerId??null,webMapLayerTitle:i.webMapLayerTitle??null,className:null,objectClassId:null},De(t),!1,!1):null})},n.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),n.functions.filterbysubtypecode=function(t,r){return n.standardFunctionAsync(t,r,async(I,g,e)=>{if(k(e,2,2,t,r),j(e[0])){const i=await e[0].load(),a=e[1];if(!He(a))throw new p(t,y.InvalidParameter,r);if(i.subtypeField){const w=v.create(`${i.subtypeField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new de({parentfeatureset:e[0],whereclause:w})}if(i.typeIdField===null||i.typeIdField==="")throw new p(t,y.FeatureSetDoesNotHaveSubtypes,r);const l=v.create(`${i.typeIdField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new de({parentfeatureset:e[0],whereclause:l})}throw new p(t,y.InvalidParameter,r)})},n.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{ji as registerFunctions};
