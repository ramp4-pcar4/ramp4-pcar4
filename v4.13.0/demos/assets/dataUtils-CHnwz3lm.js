import{z as Dt,s as Rt,f as Lt,i as Y,q as O,v as z,c8 as jt,x as Et,ii as mt,ay as qt,aq as et,N as Nt,ij as Ut,cw as Gt,c1 as Ot,dC as Wt}from"./main-6eEsl9OJ.js";import{u as ut}from"./pixelRangeUtils-BvOub3JO.js";let Pt=class{constructor(e=null,n=null,s=null){this.minValue=e,this.maxValue=n,this.noDataValue=s}};var H;let F=H=class extends Dt{static createEmptyBand(t,e){return new(H.getPixelArrayConstructor(t))(e)}static combineBandMasks(t){if(t.length<2)return t[0];const e=t[0].length,n=new Uint8Array(e).fill(255);for(let s=0;s<t.length;s++){const r=t[s];for(let i=0;i<e;i++)r[i]||(n[i]=0)}return n}static getPixelArrayConstructor(t){let e;switch(t){case"u1":case"u2":case"u4":case"u8":e=Uint8Array;break;case"u16":e=Uint16Array;break;case"u32":e=Uint32Array;break;case"s8":e=Int8Array;break;case"s16":e=Int16Array;break;case"s32":e=Int32Array;break;case"f32":case"c64":case"c128":case"unknown":e=Float32Array;break;case"f64":e=Float64Array}return e}constructor(t){super(t),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(t){if(!t)return"f32";let e=t.toLowerCase();return["u1","u2","u4"].includes(e)?e="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(e)||(e="f32"),e}getPlaneCount(){return this.pixels?.length}addData(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new Rt("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(t.pixels),this.statistics.push(t.statistics??new Pt)}getAsRGBA(){const t=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(t);break;default:this._fillFrom8Bit(t)}return new Uint8ClampedArray(t)}getAsRGBAFloat(){const t=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(t),t}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map(n=>zt(n,this.mask));const t=this.mask;let e=0;if(t!=null)for(let n=0;n<t.length;n++)t[n]&&e++;else e=this.width*this.height;this.validPixelCount=e}clamp(t){if(!t||t==="f64"||t==="f32"||!this.pixels)return;const[e,n]=ut(t),s=this.pixels,r=this.width*this.height,i=s.length;let l,c,a;const o=[];for(let h=0;h<i;h++){a=H.createEmptyBand(t,r),l=s[h];for(let f=0;f<r;f++)c=l[f],a[f]=c>n?n:c<e?e:c;o.push(a)}this.pixels=o,this.pixelType=t}extractBands(t){const{pixels:e,statistics:n}=this;if(t==null||t.length===0||!e||e.length===0)return this;const s=e.length,r=t.some(f=>f>=e.length),i=s===t.length&&!t.some((f,d)=>f!==d);if(r||i)return this;const l=this.bandMasks?.length===s?t.map(f=>this.bandMasks[f]):void 0;let{mask:c,validPixelCount:a}=this;const{width:o,height:h}=this;return l?.length&&(c=H.combineBandMasks(l),a=c.filter(f=>!!f).length),new H({pixelType:this.pixelType,width:o,height:h,mask:c,bandMasks:l,validPixelCount:a,maskIsAlpha:this.maskIsAlpha,pixels:t.map(f=>e[f]),statistics:n&&t.map(f=>n[f])})}clone(){const t=new H({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});let e;this.mask!=null&&(t.mask=new Uint8Array(this.mask)),this.bandMasks&&(t.bandMasks=this.bandMasks.map(s=>new Uint8Array(s)));const n=H.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){t.pixels=[];const s=!!this.pixels[0].slice;for(e=0;e<this.pixels.length;e++)t.pixels[e]=s?this.pixels[e].slice():new n(this.pixels[e])}if(this.statistics)for(t.statistics=[],e=0;e<this.statistics.length;e++)t.statistics[e]=Lt(this.statistics[e]);return t.premultiplyAlpha=this.premultiplyAlpha,t}_fillFrom8Bit(t){const{mask:e,maskIsAlpha:n,premultiplyAlpha:s,pixels:r}=this;if(!t||!r?.length)return void Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let i,l,c,a;i=l=c=r[0],r.length>=3?(l=r[1],c=r[2]):r.length===2&&(l=r[1]);const o=new Uint32Array(t),h=this.width*this.height;if(i.length===h)if(e!=null&&e.length===h)if(n)for(a=0;a<h;a++){const f=e[a];if(f){const d=f/255;o[a]=s?f<<24|c[a]*d<<16|l[a]*d<<8|i[a]*d:f<<24|c[a]<<16|l[a]<<8|i[a]}}else for(a=0;a<h;a++)e[a]&&(o[a]=255<<24|c[a]<<16|l[a]<<8|i[a]);else for(a=0;a<h;a++)o[a]=255<<24|c[a]<<16|l[a]<<8|i[a];else Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(t){const{pixels:e,mask:n,statistics:s}=this;if(!t||!e?.length)return void Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const r=this.pixelType;let i=1,l=0,c=1;if(s&&s.length>0){for(const g of s)if(g.minValue!=null&&(l=Math.min(l,g.minValue)),g.maxValue!=null&&g.minValue!=null){const m=g.maxValue-g.minValue;c=Math.max(c,m)}i=255/c}else{let g=255;r==="s8"?(l=-128,g=127):r==="u16"?g=65535:r==="s16"?(l=-32768,g=32767):r==="u32"?g=4294967295:r==="s32"?(l=-2147483648,g=2147483647):r==="f32"?(l=-34e38,g=34e38):r==="f64"&&(l=-Number.MAX_VALUE,g=Number.MAX_VALUE),i=255/(g-l)}const a=new Uint32Array(t),o=this.width*this.height;let h,f,d,u,p;if(h=f=d=e[0],h.length!==o)return Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(e.length>=2)if(f=e[1],e.length>=3&&(d=e[2]),n!=null&&n.length===o)for(u=0;u<o;u++)n[u]&&(a[u]=255<<24|(d[u]-l)*i<<16|(f[u]-l)*i<<8|(h[u]-l)*i);else for(u=0;u<o;u++)a[u]=255<<24|(d[u]-l)*i<<16|(f[u]-l)*i<<8|(h[u]-l)*i;else if(n!=null&&n.length===o)for(u=0;u<o;u++)p=(h[u]-l)*i,n[u]&&(a[u]=255<<24|p<<16|p<<8|p);else for(u=0;u<o;u++)p=(h[u]-l)*i,a[u]=255<<24|p<<16|p<<8|p}_fillFrom32Bit(t){const{pixels:e,mask:n}=this;if(!t||!e?.length)return Y.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let s,r,i,l;s=r=i=e[0],e.length>=3?(r=e[1],i=e[2]):e.length===2&&(r=e[1]);const c=this.width*this.height;if(s.length!==c)return Y.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let a=0;if(n!=null&&n.length===c)for(l=0;l<c;l++)t[a++]=s[l],t[a++]=r[l],t[a++]=i[l],t[a++]=1&n[l];else for(l=0;l<c;l++)t[a++]=s[l],t[a++]=r[l],t[a++]=i[l],t[a++]=1}};function zt(t,e){let n=1/0,s=-1/0;const r=t.length;let i,l=0;if(e!=null)for(i=0;i<r;i++)e[i]&&(l=t[i],n=l<n?l:n,s=l>s?l:s);else for(i=0;i<r;i++)l=t[i],n=l<n?l:n,s=l>s?l:s;return new Pt(n,s)}O([z({json:{write:!0}})],F.prototype,"width",void 0),O([z({json:{write:!0}})],F.prototype,"height",void 0),O([z({json:{write:!0}})],F.prototype,"pixelType",void 0),O([jt("pixelType")],F.prototype,"castPixelType",null),O([z({json:{write:!0}})],F.prototype,"validPixelCount",void 0),O([z({json:{write:!0}})],F.prototype,"mask",void 0),O([z({json:{write:!0}})],F.prototype,"maskIsAlpha",void 0),O([z({json:{write:!0}})],F.prototype,"pixels",void 0),O([z()],F.prototype,"premultiplyAlpha",void 0),O([z({json:{write:!0}})],F.prototype,"statistics",void 0),O([z({json:{write:!0}})],F.prototype,"depthCount",void 0),O([z({json:{write:!0}})],F.prototype,"noDataValues",void 0),O([z({json:{write:!0}})],F.prototype,"bandMasks",void 0),F=H=O([Et("esri.layers.support.PixelBlock")],F);var gt,xt;(function(t){t[t.matchAny=0]="matchAny",t[t.matchAll=1]="matchAll"})(gt||(gt={})),function(t){t[t.bestMatch=0]="bestMatch",t[t.fail=1]="fail"}(xt||(xt={}));const wt=9;function R(t){return t!=null&&t.pixels?.length>0}function xe(t){if(!t?.length||t.some(h=>!R(h)))return null;if(t.length===1)return t[0]?.clone()??null;const e=t,{width:n,height:s,pixelType:r}=e[0];if(e.some(h=>h.width!==n||h.height!==s))return null;const i=e.map(({mask:h})=>h).filter(h=>h!=null);let l=null;i.length&&(l=new Uint8Array(n*s),l.set(i[0]),i.length>1&&It(i.slice(1),l));const c=[];e.forEach(({pixels:h})=>c.push(...h));const a=e.map(({statistics:h})=>h).filter(h=>h?.length),o=[];return a.forEach(h=>o.push(...h)),new F({pixelType:r,width:n,height:s,mask:l,pixels:c,statistics:o.length?o:null})}function we(t){if(!t)return;const e=t.colormap;if(!e||e.length===0)return;const n=e.sort((a,o)=>a[0]-o[0]),s=n[0][0]<0?n[0][0]:0,r=Math.max(256,n[n.length-1][0]-s+1),i=new Uint8Array(4*r),l=[],c=n[0].length===5;if(r>65536)return n.forEach(a=>{l[a[0]-s]=c?a.slice(1):a.slice(1).concat([255])}),{indexed2DColormap:l,offset:s,alphaSpecified:c};if(t.fillUnspecified){let a=n[0];for(let o=a[0]-s,h=0;o<r;o++)i[4*o]=a[1],i[4*o+1]=a[2],i[4*o+2]=a[3],i[4*o+3]=c?a[4]:255,o===a[0]-s&&(a=h===n.length-1?a:n[++h])}else for(let a=0;a<n.length;a++){const o=n[a],h=4*(o[0]-s);i[h]=o[1],i[h+1]=o[2],i[h+2]=o[3],i[h+3]=c?o[4]:255}return{indexedColormap:i,offset:s,alphaSpecified:c}}function ye(t,e){if(!R(t)||!e||!e.indexedColormap&&!e.indexed2DColormap)return t;const n=t.clone(),s=n.pixels;let r=n.mask;const i=n.width*n.height;if(s.length!==1)return t;const{indexedColormap:l,indexed2DColormap:c,offset:a,alphaSpecified:o}=e,h=s[0],f=new Uint8Array(h.length),d=new Uint8Array(h.length),u=new Uint8Array(h.length);let p,g=0;if(l){const m=l.length-1;if(r!=null)for(let w=0;w<i;w++)r[w]&&(g=4*(h[w]-a),g<a||g>m?r[w]=0:(f[w]=l[g],d[w]=l[g+1],u[w]=l[g+2],r[w]=l[g+3]));else{r=new Uint8Array(i);for(let w=0;w<i;w++)g=4*(h[w]-a),g<a||g>m?r[w]=0:(f[w]=l[g],d[w]=l[g+1],u[w]=l[g+2],r[w]=l[g+3]);n.mask=r}}else if(c)if(r!=null)for(let m=0;m<i;m++)r[m]&&(p=c[h[m]],f[m]=p[0],d[m]=p[1],u[m]=p[2],r[m]=p[3]);else{r=new Uint8Array(i);for(let m=0;m<i;m++)p=c[h[m]],f[m]=p[0],d[m]=p[1],u[m]=p[2],r[m]=p[3];n.mask=r}return n.pixels=[f,d,u],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=o,n}function ke(t,e){if(!R(t))return null;const{pixels:n,mask:s}=t,r=n.length;let i=e.lut;const{offset:l}=e;i&&i[0].length===1&&(i=n.map(()=>i));const c=[],a=e.outputPixelType||"u8";for(let h=0;h<r;h++){const f=Tt(n[h],s,i[h],l||0,a);c.push(f)}const o=new F({width:t.width,height:t.height,pixels:c,mask:s,pixelType:a});return o.updateStatistics(),o}function Tt(t,e,n,s,r){const i=t.length,l=F.createEmptyBand(r,i);if(e)for(let c=0;c<i;c++)e[c]&&(l[c]=n[t[c]-s]);else for(let c=0;c<i;c++)l[c]=n[t[c]-s];return l}function Me(t,e){if(!R(t))return null;const n=t.clone(),{pixels:s}=n,r=n.width*n.height,i=e.length,l=Math.floor(i/2),c=e[Math.floor(l)],a=s[0],o=new Uint8Array(r),h=new Uint8Array(r),f=new Uint8Array(r);let d=n.mask;const u=e[0].mappedColor.length===4;d||(d=new Uint8Array(r),d.fill(u?255:1),n.mask=d);for(let p=0;p<r;p++)if(d[p]){const g=a[p];let m=!1,w=l,y=c,M=0,A=i-1;for(;A-M>1;){if(g===y.value){m=!0;break}g>y.value?M=w:A=w,w=Math.floor((M+A)/2),y=e[Math.floor(w)]}m||(g===e[M].value?(y=e[M],m=!0):g===e[A].value?(y=e[A],m=!0):g<e[M].value?m=!1:g>e[M].value&&(g<e[A].value?(y=e[M],m=!0):A===i-1?m=!1:(y=e[A],m=!0))),m?(o[p]=y.mappedColor[0],h[p]=y.mappedColor[1],f[p]=y.mappedColor[2],d[p]=y.mappedColor[3]):o[p]=h[p]=f[p]=d[p]=0}return n.pixels=[o,h,f],n.mask=d,n.pixelType="u8",n.maskIsAlpha=u,n}function Ae(t,e,n=!1){const r=new Float32Array(3*wt),i=e.length;for(let l=0;l<wt;l++)r[3*l]=t[2*l]??mt-1,r[3*l+1]=t[2*l+1]??mt,r[3*l+2]=e[l]??0,l<i&&(l>0&&(r[3*l]-=1e-5),t[2*l+1]!==t[2*l]&&(l<i-1||!n)&&(r[3*l+1]-=1e-5));return r}function be(t,e){if(!R(t))return null;const{width:n,height:s}=t,{inputRanges:r,outputValues:i,outputPixelType:l,noDataRanges:c,allowUnmatched:a,replacementValue:o,isLastInputRangeInclusive:h}=e,f=t.pixels[0],d=F.createEmptyBand(l,f.length),u=t.mask,p=new Uint8Array(n*s);u?p.set(u):p.fill(255);const g=t.pixelType.startsWith("f")?1e-6:0,m=r.map(x=>x-g);m[0]=r[0],m[m.length-1]=r[r.length-1]+(h?1e-6:0);const w=r.length/2,[y,M]=ut(l);for(let x=0;x<s;x++)for(let k=0;k<n;k++){const U=x*n+k;if(p[U]){const b=f[U];let T=!1;for(let P=w-1;P>=0;P--)if(b===r[2*P]||b>m[2*P]&&b<m[2*P+1]){d[U]=i[P],T=!0;break}T||(a?d[U]=b>M?M:b<y?y:o??b:p[U]=0)}}const A=c?.length;if(A)for(let x=0;x<s;x++)for(let k=0;k<n;k++){const U=x*n+k;if(!u||u[U]){const b=f[U];for(let T=0;T<A;T+=2)if(b>=c[T]&&b<=c[T+1]){d[U]=0,p[U]=0;break}}}return new F({width:n,height:s,pixelType:l,pixels:[d],mask:p})}function yt(t,e,n,s){const r=n!=null&&n.length>=2?new Set(n):null,i=n?.length===1?n[0]:null,l=!!e?.length;for(let c=0;c<t.length;c++)if(s[c]){const a=t[c];if(l){let o=!1;for(let h=0;h<e.length;h+=2)if(a>=e[h]&&a<=e[h+1]){o=!0;break}o||(s[c]=0)}s[c]&&(a===i||r?.has(a))&&(s[c]=0)}}function kt(t,e){const n=t[0].length;for(let s=0;s<n;s++)if(e[s]){let r=!1;for(let i=0;i<t.length;i++)if(t[i][s]){r=!0;break}r||(e[s]=0)}}function It(t,e){const n=t[0].length;for(let s=0;s<n;s++)if(e[s]){let r=!1;for(let i=0;i<t.length;i++)if(t[i][s]===0){r=!0;break}r&&(e[s]=0)}}function ve(t,e){if(!R(t))return null;const{width:n,height:s,pixels:r}=t,i=n*s,l=new Uint8Array(i);t.mask?l.set(t.mask):l.fill(255);const c=r.length,{includedRanges:a,noDataValues:o,outputPixelType:h,matchAll:f,lookups:d}=e;if(d){const u=[];for(let p=0;p<c;p++){const g=d[p],m=Tt(r[p],l,g.lut,g.offset||0,"u8");u.push(m)}u.length===1?l.set(u[0]):f?kt(u,l):It(u,l)}else if(f){const u=[];for(let p=0;p<c;p++){const g=new Uint8Array(i);g.set(l),yt(r[p],a?.slice(2*p,2*p+2),o?.[p],g),u.push(g)}u.length===1?l.set(u[0]):kt(u,l)}else for(let u=0;u<c;u++)yt(r[u],a?.slice(2*u,2*u+2),o?.[u],l);return new F({width:n,height:s,pixelType:h,pixels:r,mask:l})}function Ue(t){const{srcPixelType:e,inputRanges:n,outputValues:s,allowUnmatched:r,noDataRanges:i,isLastInputRangeInclusive:l,outputPixelType:c}=t;if(e!=="u8"&&e!=="s8"&&e!=="u16"&&e!=="s16")return null;const a=e.includes("16")?65536:256,o=e.includes("s")?-a/2:0,h=F.createEmptyBand(c,a),f=new Uint8Array(a);r&&f.fill(255);const[d,u]=ut(c);if(n?.length&&s?.length){const g=n.map(m=>m-1e-6);g[0]=n[0],l&&(g[g.length-1]=n[n.length-1]);for(let m=0;m<g.length;m++){const w=s[m]>u?u:s[m]<d?d:s[m],y=Math.ceil(g[2*m]-o),M=n[2*m+1]===n[2*m]?y:Math.floor(g[2*m+1]-o);for(let A=y;A<=M;A++)h[A]=w,f[A]=255}}if(i?.length)for(let p=0;p<i.length;p++){const g=Math.ceil(i[2*p]-o),m=Math.floor(i[2*p+1]-o);for(let w=g;w<=m;w++)f[w]=0}return{lut:h,offset:o,mask:f}}function Pe(t,e,n){if(t!=="u8"&&t!=="s8"&&t!=="u16"&&t!=="s16")return null;const s=t.includes("16")?65536:256,r=t.includes("s")?-s/2:0,i=new Uint8Array(s);if(e)for(let l=0;l<e.length;l++){const c=Math.ceil(e[2*l]-r),a=Math.floor(e[2*l+1]-r);for(let o=c;o<=a;o++)i[o]=255}else i.fill(255);if(n)for(let l=0;l<n.length;l++)i[n[l]-r]=0;return{lut:i,offset:r}}function Jt(t,e,n,s,r,i,l,c){return{xmin:r<=n*t?0:r<n*t+t?r-n*t:t,ymin:i<=s*e?0:i<s*e+e?i-s*e:e,xmax:r+l<=n*t?0:r+l<n*t+t?r+l-n*t:t,ymax:i+c<=s*e?0:i+c<s*e+e?i+c-s*e:e}}function Te(t,e){if(!t||t.length===0)return null;const n=t.find(p=>p.pixelBlock);if(n?.pixelBlock==null)return null;const s=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,r=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,i=.01*Math.min(s,r),l=t.sort((p,g)=>Math.abs(p.extent.ymax-g.extent.ymax)>i?g.extent.ymax-p.extent.ymax:Math.abs(p.extent.xmin-g.extent.xmin)>i?p.extent.xmin-g.extent.xmin:0),c=Math.min.apply(null,l.map(p=>p.extent.xmin)),a=Math.min.apply(null,l.map(p=>p.extent.ymin)),o=Math.max.apply(null,l.map(p=>p.extent.xmax)),h=Math.max.apply(null,l.map(p=>p.extent.ymax)),f={x:Math.round((e.xmin-c)/s),y:Math.round((h-e.ymax)/r)},d={width:Math.round((o-c)/s),height:Math.round((h-a)/r)},u={width:Math.round((e.xmax-e.xmin)/s),height:Math.round((e.ymax-e.ymin)/r)};return Math.round(d.width/n.pixelBlock.width)*Math.round(d.height/n.pixelBlock.height)!==l.length||f.x<0||f.y<0||d.width<u.width||d.height<u.height?null:{extent:e,pixelBlock:Xt(l.map(p=>p.pixelBlock),d,{clipOffset:f,clipSize:u})}}function ht(t,e,n,s,r,i){const{width:l,height:c}=n.block,{x:a,y:o}=n.offset,{width:h,height:f}=n.mosaic,d=Jt(l,c,s,r,a,o,h,f);let u=0,p=0;if(i){const g=i.hasGCSSShiftTransform?360:i.halfWorldWidth??0,m=l*i.resolutionX,w=i.startX+s*m;w<g&&w+m>g?p=i.rightPadding:w>=g&&(u=i.leftMargin-i.rightPadding,p=0)}if(d.xmax-=p,typeof e!="number")for(let g=d.ymin;g<d.ymax;g++){const m=(r*c+g-o)*h+(s*l-a)+u,w=g*l;for(let y=d.xmin;y<d.xmax;y++)t[m+y]=e[w+y]}else for(let g=d.ymin;g<d.ymax;g++){const m=(r*c+g-o)*h+(s*l-a)+u;for(let w=d.xmin;w<d.xmax;w++)t[m+w]=e}}function Xt(t,e,n={}){const{clipOffset:s,clipSize:r,alignmentInfo:i,blockWidths:l}=n;if(l)return Ht(t,e,{blockWidths:l});const c=t.find(P=>R(P));if(c==null)return null;const a=r?r.width:e.width,o=r?r.height:e.height,h=c.width,f=c.height,d=e.width/h,u=e.height/f,p={offset:s||{x:0,y:0},mosaic:r||e,block:{width:h,height:f}},g=c.pixelType,m=F.getPixelArrayConstructor(g),w=c.pixels.length,y=[];let M,A;for(let P=0;P<w;P++){A=new m(a*o);for(let I=0;I<u;I++)for(let v=0;v<d;v++){const B=t[I*d+v];R(B)&&(M=B.pixels[P],ht(A,M,p,v,I,i))}y.push(A)}const x=t.some(P=>P==null||P.mask!=null&&P.mask.length>0),k=t.some(P=>P?.bandMasks&&P.bandMasks.length>1),U=x?new Uint8Array(a*o):void 0,b=k?[]:void 0;if(U){for(let P=0;P<u;P++)for(let I=0;I<d;I++){const v=t[P*d+I],B=v!=null?v.mask:null;ht(U,B??(v?255:0),p,I,P,i)}if(b)for(let P=0;P<w;P++){const I=new Uint8Array(a*o);for(let v=0;v<u;v++)for(let B=0;B<d;B++){const _=t[v*d+B],S=_?.bandMasks?.[P]??_?.mask;ht(I,S??(_?255:0),p,B,v,i)}b.push(I)}}const T=new F({width:a,height:o,pixels:y,pixelType:g,bandMasks:b,mask:U});return T.updateStatistics(),T}function Ht(t,e,n){const s=t.find(m=>m!=null);if(s==null)return null;const r=t.some(m=>m==null||!!m.mask),{width:i,height:l}=e,c=r?new Uint8Array(i*l):null,{blockWidths:a}=n,o=[],h=s.getPlaneCount(),f=F.getPixelArrayConstructor(s.pixelType);if(r)for(let m=0,w=0;m<t.length;w+=a[m],m++){const y=t[m];if(!R(y))continue;const M=y.mask;for(let A=0;A<l;A++)for(let x=0;x<a[m];x++)c[A*i+x+w]=M==null?255:M[A*y.width+x]}const d=t.some(m=>m?.bandMasks&&m.bandMasks.length>1),u=d?[]:void 0,p=i*l;for(let m=0;m<h;m++){const w=new f(p),y=d?new Uint8Array(p):void 0;for(let M=0,A=0;M<t.length;A+=a[M],M++){const x=t[M];if(!R(x))continue;const k=x.pixels[m];if(k!=null){for(let U=0;U<l;U++)for(let b=0;b<a[M];b++)w[U*i+b+A]=k[U*x.width+b];if(y){const U=x.bandMasks?.[m]??x.mask;for(let b=0;b<l;b++)for(let T=0;T<a[M];T++)y[b*i+T+A]=U?U[b*x.width+T]:255}}}o.push(w),u&&y&&u.push(y)}const g=new F({width:i,height:l,mask:c,bandMasks:u,pixels:o,pixelType:s.pixelType});return g.updateStatistics(),g}function Ie(t,e,n){if(!R(t))return null;const{width:s,height:r}=t,i=e.x,l=e.y,c=n.width+i,a=n.height+l;if(i<0||l<0||c>s||a>r||i===0&&l===0&&c===s&&a===r)return t;t.mask||(t.mask=new Uint8Array(s*r));const o=t.mask;for(let h=0;h<r;h++){const f=h*s;for(let d=0;d<s;d++)o[f+d]=h<l||h>=a||d<i||d>=c?0:1}return t.updateStatistics(),t}function Kt(t){if(!R(t))return null;const e=t.clone(),{width:n,height:s,pixels:r}=t,i=r[0],l=e.pixels[0],c=t.mask;for(let a=2;a<s-1;a++){const o=new Map;for(let f=a-2;f<a+2;f++)for(let d=0;d<4;d++){const u=f*n+d;lt(o,i[u],c?c[u]:1)}l[a*n]=Mt(o),l[a*n+1]=l[a*n+2]=l[a*n];let h=3;for(;h<n-1;h++){let f=(a-2)*n+h+1;lt(o,i[f],c?c[f]:1),f=(a-1)*n+h+1,lt(o,i[f],c?c[f]:1),f=a*n+h+1,lt(o,i[f],c?c[f]:1),f=(a+1)*n+h+1,lt(o,i[f],c?c[f]:1),f=(a-2)*n+h-3,st(o,i[f],c?c[f]:1),f=(a-1)*n+h-3,st(o,i[f],c?c[f]:1),f=a*n+h-3,st(o,i[f],c?c[f]:1),f=(a+1)*n+h-3,st(o,i[f],c?c[f]:1),l[a*n+h]=Mt(o)}l[a*n+h+1]=l[a*n+h]}for(let a=0;a<n;a++)l[a]=l[n+a]=l[2*n+a],l[(s-1)*n+a]=l[(s-2)*n+a];return e.updateStatistics(),e}function Mt(t){if(t.size===0)return 0;let e=0,n=-1,s=0;const r=t.keys();let i=r.next();for(;!i.done;)s=t.get(i.value),s>e&&(n=i.value,e=s),i=r.next();return n}function st(t,e,n){if(n===0)return;const s=t.get(e);s===1?t.delete(e):t.set(e,s-1)}function lt(t,e,n){n!==0&&t.set(e,t.has(e)?t.get(e)+1:1)}function $t(t,e,n){let{x:s,y:r}=e;const{width:i,height:l}=n;if(s===0&&r===0&&l===t.height&&i===t.width)return t;const{width:c,height:a}=t,o=Math.max(0,r),h=Math.max(0,s),f=Math.min(s+i,c),d=Math.min(r+l,a);if(f<0||d<0||!R(t))return null;s=Math.max(0,-s),r=Math.max(0,-r);const{pixels:u}=t,p=i*l,g=u.length,m=[];for(let A=0;A<g;A++){const x=u[A],k=F.createEmptyBand(t.pixelType,p);for(let U=o;U<d;U++){const b=U*c;let T=(U+r-o)*i+s;for(let P=h;P<f;P++)k[T++]=x[b+P]}m.push(k)}const w=new Uint8Array(p),y=t.mask;for(let A=o;A<d;A++){const x=A*c;let k=(A+r-o)*i+s;for(let U=h;U<f;U++)w[k++]=y?y[x+U]:1}const M=new F({width:n.width,height:n.height,pixelType:t.pixelType,pixels:m,mask:w});return M.updateStatistics(),M}function Bt(t,e=!0){if(!R(t))return null;const{pixels:n,width:s,height:r,mask:i,pixelType:l}=t,c=[],a=Math.round(s/2),o=Math.round(r/2),h=r-1,f=s-1;for(let u=0;u<n.length;u++){const p=n[u],g=F.createEmptyBand(l,a*o);let m=0;for(let w=0;w<r;w+=2)for(let y=0;y<s;y+=2){const M=p[w*s+y];if(e){const A=y===f?M:p[w*s+y+1],x=w===h?M:p[w*s+y+s],k=y===f?x:w===h?A:p[w*s+y+s+1];g[m++]=(M+A+x+k)/4}else g[m++]=M}c.push(g)}let d=null;if(i!=null){d=new Uint8Array(a*o);let u=0;for(let p=0;p<r;p+=2)for(let g=0;g<s;g+=2){const m=i[p*s+g];if(e){const w=g===f?m:i[p*s+g+1],y=p===h?m:i[p*s+g+s],M=g===f?y:p===h?w:i[p*s+g+s+1];d[u++]=m*w*y*M?1:0}else d[u++]=m}}return new F({width:a,height:o,pixelType:l,pixels:c,mask:d})}function $e(t,e,n=0,s=!0){if(!R(t))return null;const{width:r,height:i}=e;let{width:l,height:c}=t;const a=new Map,o={x:0,y:0},h=1+n;let f=t;for(let d=0;d<h;d++){const u=Math.ceil(l/r),p=Math.ceil(c/i);for(let g=0;g<p;g++){o.y=g*i;for(let m=0;m<u;m++){o.x=m*r;const w=$t(f,o,e);a.set(`${d}/${g}/${m}`,w)}}d<h-1&&(f=Bt(f,s)),l=Math.round(l/2),c=Math.round(c/2)}return a}function Be(t){const{pixelBlock:e,tileSize:n,level:s,row:r,col:i,useBilinear:l}=t;if(!R(e))return null;const{width:c,height:a}=n,o=2**s,h=o*c,f=o*a;let d=$t(e,{y:r*f,x:i*h},{width:h,height:f});if(!d)return null;for(let u=s;u>0;u--)d=Bt(d,l);return d}function St(t,e,n,s,r=0){const{width:i,height:l}=t,{width:c,height:a}=e,o=s.cols,h=s.rows,f=Math.ceil(c/o-.1/o),d=Math.ceil(a/h-.1/h);let u,p,g,m,w,y,M;const A=f*o,x=A*d*h,k=new Float32Array(x),U=new Float32Array(x),b=new Uint32Array(x),T=new Uint32Array(x);let P,I,v=0;for(let B=0;B<d;B++)for(let _=0;_<f;_++){u=12*(B*f+_),p=n[u],g=n[u+1],m=n[u+2],w=n[u+3],y=n[u+4],M=n[u+5];for(let S=0;S<h;S++){v=(B*h+S)*A+_*o,I=(S+.5)/h;for(let $=0;$<S;$++)P=($+.5)/o,k[v+$]=(p*P+g*I+m)*i+r,U[v+$]=(w*P+y*I+M)*l+r,b[v+$]=Math.floor(k[v+$]),T[v+$]=Math.floor(U[v+$])}u+=6,p=n[u],g=n[u+1],m=n[u+2],w=n[u+3],y=n[u+4],M=n[u+5];for(let S=0;S<h;S++){v=(B*h+S)*A+_*o,I=(S+.5)/h;for(let $=S;$<o;$++)P=($+.5)/o,k[v+$]=(p*P+g*I+m)*i+r,U[v+$]=(w*P+y*I+M)*l+r,b[v+$]=Math.floor(k[v+$]),T[v+$]=Math.floor(U[v+$])}}return{offsets_x:k,offsets_y:U,offsets_xi:b,offsets_yi:T,gridWidth:A}}function Se(t,e){const{coefficients:n,spacing:s}=e,{offsets_x:r,offsets_y:i,gridWidth:l}=St(t,t,n,{rows:s[0],cols:s[1]}),{width:c,height:a}=t,o=new Float32Array(c*a),h=180/Math.PI;for(let f=0;f<a;f++)for(let d=0;d<c;d++){const u=f*l+d,p=f===0?u:u-l,g=f===a-1?u:u+l,m=r[p]-r[g],w=i[g]-i[p];if(isNaN(m)||isNaN(w))o[f*c+d]=90;else{let y=Math.atan2(w,m)*h;y=(360+y)%360,o[f*c+d]=y}}return o}function Fe(t,e,n,s,r="nearest"){if(!R(t))return null;r==="majority"&&(t=Kt(t));const{pixels:i,mask:l,bandMasks:c,pixelType:a}=t,o=t.width,h=t.height,f=F.getPixelArrayConstructor(a),d=i.length,{width:u,height:p}=e;let g=!1;for(let v=0;v<n.length;v+=3)n[v]===-1&&n[v+1]===-1&&n[v+2]===-1&&(g=!0);const{offsets_x:m,offsets_y:w,offsets_xi:y,offsets_yi:M,gridWidth:A}=St({width:o,height:h},e,n,s,r==="majority"?.5:0);let x;const k=(v,B,_,S)=>{const $=v instanceof Float32Array||v instanceof Float64Array?0:.5;for(let C=0;C<p;C++){x=C*A;for(let V=0;V<u;V++){if(m[x]<0||w[x]<0)v[C*u+V]=0;else if(S)v[C*u+V]=B[y[x]+M[x]*o];else{const E=Math.floor(m[x]),G=Math.floor(w[x]),L=Math.ceil(m[x]),N=Math.ceil(w[x]),W=m[x]-E,X=w[x]-G;if(!_||_[E+G*o]&&_[L+G*o]&&_[E+N*o]&&_[L+N*o]){const tt=(1-W)*B[E+G*o]+W*B[L+G*o],K=(1-W)*B[E+N*o]+W*B[L+N*o];v[C*u+V]=(1-X)*tt+X*K+$}else v[C*u+V]=B[y[x]+M[x]*o]}x++}}},U=[];let b;const T=c?.length===d,P=[];for(let v=0;v<d;v++){if(T){const B=new Uint8Array(u*p);k(B,c[v],c[v],!0),P.push(B)}b=new f(u*p),k(b,i[v],T?c[v]:l,r==="nearest"||r==="majority"),U.push(b)}const I=new F({width:u,height:p,pixelType:a,pixels:U,bandMasks:T?P:void 0});if(l!=null)I.mask=new Uint8Array(u*p),k(I.mask,l,l,!0);else if(g){I.mask=new Uint8Array(u*p);for(let v=0;v<u*p;v++)I.mask[v]=m[v]<0||w[v]<0?0:1}return I.updateStatistics(),I}const Z=new Map;Z.set("meter-per-second",1),Z.set("kilometer-per-hour",.277778),Z.set("knots",.514444),Z.set("feet-per-second",.3048),Z.set("mile-per-hour",.44704);const ft=180/Math.PI,pt=5,ot=new qt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function dt(t,e){return Z.get(t)/Z.get(e)||1}function Ft(t){return(450-t)%360}function Ct(t,e="geographic"){const[n,s]=t,r=Math.sqrt(n*n+s*s);let i=Math.atan2(s,n)*ft;return i=(360+i)%360,e==="geographic"&&(i=Ft(i)),[r,i]}function Qt(t,e="geographic"){let n=t[1];e==="geographic"&&(n=Ft(n)),n%=360;const s=t[0];return[s*Math.cos(n/ft),s*Math.sin(n/ft)]}function Ce(t,e,n,s="geographic"){if(!R(t)||n==null)return t;const r=e==="vector-magdir"?t.clone():At(t,e),i=r.pixels[1];for(let l=0;l<i.length;l++)i[l]=s==="geographic"?(i[l]+n[l]+270)%360:(i[l]+360-n[l])%360;return e==="vector-magdir"?r:At(r,"vector-magdir")}function At(t,e,n="geographic",s=1){if(!R(t))return t;const{pixels:r,width:i,height:l}=t,c=i*l,a=r[0],o=r[1],h=t.pixelType.startsWith("f")?t.pixelType:"f32",f=F.createEmptyBand(h,c),d=F.createEmptyBand(h,c);let u=0;for(let g=0;g<l;g++)for(let m=0;m<i;m++)e==="vector-uv"?([f[u],d[u]]=Ct([a[u],o[u]],n),f[u]*=s):([f[u],d[u]]=Qt([a[u],o[u]],n),f[u]*=s,d[u]*=s),u++;const p=new F({pixelType:h,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[f,d]});return p.updateStatistics(),p}function Ve(t,e,n=1){if(n===1||!R(t))return t;const s=t.clone(),{pixels:r,width:i,height:l}=s,c=r[0];r[1];let a=0;for(let o=0;o<l;o++)for(let h=0;h<i;h++)c[a]*=n,a++;return s.updateStatistics(),s}function _e(t,e,n,s,r){if(r==null||!r.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/s),height:Math.round(n/s),resolution:t.width/e};const i=r.xmin,l=r.ymax,c=(t.xmax-t.xmin)/e*s,a=(t.ymax-t.ymin)/n*s,o=(c+a)/2;return t.xmin=i+Math.floor((t.xmin-i)/c)*c,t.xmax=i+Math.ceil((t.xmax-i)/c)*c,t.ymin=l+Math.floor((t.ymin-l)/a)*a,t.ymax=l+Math.ceil((t.ymax-l)/a)*a,{extent:t,width:Math.round(t.width/c),height:Math.round(t.height/a),resolution:o}}const Yt=Vt(0,0,0);function Vt(t=0,e=0,n=Math.PI,s=!0){s&&(n=(2*Math.PI-n)%(2*Math.PI));const r=s?-1:1,i=13*r,l=-7*r,c=-2*r,a=-16*r,o=21.75,[h,f]=q(0,e+i,n,o),[d,u]=q(t-5.5,e+l,n,o),[p,g]=q(t+5.5,e+l,n,o),[m,w]=q(t-1.5,e+c,n,o),[y,M]=q(t+1.5,e+c,n,o),[A,x]=q(t-1.5,e+a,n,o),[k,U]=q(t+1.5,e+a,n,o);return[h,f,d,u,m,w,y,M,p,g,A,x,k,U]}function Zt(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const s=10,r=n?-1:1,i=5*r,l=20*r,c=25*r,a=45,o=0,h=0,f=2,d=0,u=f*r,p=n?1:-1,g=s/2*p;let[m,w]=[o+g,h-l],[y,M]=[m+f*p,w],[A,x]=[y-d*p,M+u],[k,U]=[o-g,h-c],[b,T]=[k+d*p,U-u],P=Math.ceil(t/pt),I=Math.floor(P/10);P-=8*I;const v=[],B=[];for(let W=0;W<P/2;W++,I--){I<=0&&P%2==1&&W===(P-1)/2&&(k=o,b=k+d*p,U=(U+w)/2,T=U-u);const[X,tt]=q(k,U,e,a);if(I>0){const[K,nt]=q(y,U,e,a),[it,D]=q(m,w,e,a);v.push(K),v.push(nt),v.push(X),v.push(tt),v.push(it),v.push(D)}else{const[K,nt]=q(y,M,e,a),[it,D]=q(A,x,e,a),[j,at]=q(b,T,e,a);B.push(X),B.push(tt),B.push(j),B.push(at),B.push(it),B.push(D),B.push(K),B.push(nt)}U+=i,w+=i,M+=i,x+=i,T+=i}const[_,S]=q(o+g,h+l,e,a),$=(s/2+f)*p,[C,V]=q(o+$,h+l,e,a),[E,G]=q(o+g,h-c,e,a),[L,N]=q(o+$,h-c,e,a);return{pennants:v,barbs:B,shaft:[_,S,C,V,E,G,L,N]}}function q(t,e,n,s=1){const r=Math.sqrt(t*t+e*e)/s,i=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[r,(2*Math.PI+i-n)%(2*Math.PI)]}const rt=[0,1,3,6,10,16,21,27,33,40,47,55,63],te=[0,.5,1,1.5,2],ee=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function Q(t,e,n,s){const r=dt(s||"knots",n);let i;for(i=1;i<e.length;i++)if(i===e.length-1){if(t<e[i]*r)break}else if(t<=e[i]*r)break;return Math.min(i-1,e.length-2)}function ne(t,e,n,s,r){let i=0;switch(e){case"beaufort_kn":i=Q(t,rt,"knots",n);break;case"beaufort_km":i=Q(t,rt,"kilometer-per-hour",n);break;case"beaufort_ft":i=Q(t,rt,"feet-per-second",n);break;case"beaufort_m":i=Q(t,rt,"meter-per-second",n);break;case"classified_arrow":i=Q(t,r??[],s,n);break;case"ocean_current_m":i=Q(t,te,"meter-per-second",n);break;case"ocean_current_kn":i=Q(t,ee,"knots",n)}return i}function ie(t,e){const{style:n,inputUnit:s,outputUnit:r,breakValues:i}=e,l=ot.fromJSON(s),c=ot.fromJSON(r),a=42,o=15;let h=0,f=0;const{width:d,height:u,mask:p}=t,g=t.pixels[0],m=t.pixels[1],w=p!=null?p.filter(x=>x>0).length:d*u,y=new Float32Array(w*a),M=new Uint32Array(o*w),A=e.invertDirection?Vt(0,0,0,!1):Yt;for(let x=0;x<u;x++)for(let k=0;k<d;k++){const U=x*d+k;if(!p||p[x*d+k]){const b=(m[U]+360)%360/180*Math.PI,T=ne(g[U],n,l,c,i);for(let I=0;I<A.length;I+=2)y[h++]=(k+.5)/d,y[h++]=(x+.5)/u,y[h++]=A[I],y[h++]=A[I+1]+b,y[h++]=T,y[h++]=g[U];const P=7*(h/a-1);M[f++]=P,M[f++]=P+1,M[f++]=P+2,M[f++]=P+0,M[f++]=P+4,M[f++]=P+3,M[f++]=P+0,M[f++]=P+2,M[f++]=P+3,M[f++]=P+2,M[f++]=P+5,M[f++]=P+3,M[f++]=P+5,M[f++]=P+6,M[f++]=P+3}}return{vertexData:y,indexData:M}}const ct=[];function le(t,e){if(ct.length===0)for(let u=0;u<30;u++)ct.push(Zt(5*u,0,!e.invertDirection));const n=dt(ot.fromJSON(e.inputUnit),"knots"),{width:s,height:r,mask:i}=t,l=t.pixels[0],c=t.pixels[1],a=6,o=[],h=[];let f=0,d=0;for(let u=0;u<r;u++)for(let p=0;p<s;p++){const g=u*s+p,m=l[g]*n;if((!i||i[u*s+p])&&m>=pt){const w=(c[g]+360)%360/180*Math.PI,{pennants:y,barbs:M,shaft:A}=ct[Math.min(Math.floor(m/5),29)];if(y.length+M.length===0)continue;let x=o.length/a;const k=(p+.5)/s,U=(u+.5)/r;for(let b=0;b<y.length;b+=2)o[f++]=k,o[f++]=U,o[f++]=y[b],o[f++]=y[b+1]+w,o[f++]=0,o[f++]=m;for(let b=0;b<M.length;b+=2)o[f++]=k,o[f++]=U,o[f++]=M[b],o[f++]=M[b+1]+w,o[f++]=0,o[f++]=m;for(let b=0;b<A.length;b+=2)o[f++]=k,o[f++]=U,o[f++]=A[b],o[f++]=A[b+1]+w,o[f++]=0,o[f++]=m;for(let b=0;b<y.length/6;b++)h[d++]=x,h[d++]=x+1,h[d++]=x+2,x+=3;for(let b=0;b<M.length/8;b++)h[d++]=x,h[d++]=x+1,h[d++]=x+2,h[d++]=x+1,h[d++]=x+2,h[d++]=x+3,x+=4;h[d++]=x+0,h[d++]=x+1,h[d++]=x+2,h[d++]=x+1,h[d++]=x+3,h[d++]=x+2,x+=4}}return{vertexData:new Float32Array(o),indexData:new Uint32Array(h)}}function se(t,e){let s=0,r=0;const{width:i,height:l,mask:c}=t,a=t.pixels[0],o=[],h=[],f=dt(ot.fromJSON(e.inputUnit),"knots"),d=e.style==="wind_speed"?pt:Number.MAX_VALUE;for(let u=0;u<l;u++)for(let p=0;p<i;p++){const g=a[u*i+p]*f;if((!c||c[u*i+p])&&g<d){for(let w=0;w<4;w++)o[s++]=(p+.5)/i,o[s++]=(u+.5)/l,o[s++]=w<2?-.5:.5,o[s++]=w%2==0?-.5:.5,o[s++]=0,o[s++]=g;const m=4*(s/24-1);h[r++]=m,h[r++]=m+1,h[r++]=m+2,h[r++]=m+1,h[r++]=m+2,h[r++]=m+3}}return{vertexData:new Float32Array(o),indexData:new Uint32Array(h)}}function De(t,e){return e.style==="simple_scalar"?se(t,e):e.style==="wind_speed"?le(t,e):ie(t,e)}function Re(t,e,n,s=[0,0],r=.5){const{width:i,height:l,mask:c}=t,[a,o]=t.pixels,[h,f]=s,d=Math.round((i-h)/n),u=Math.round((l-f)/n),p=d*u,g=new Float32Array(p),m=new Float32Array(p),w=new Uint8Array(p);for(let M=0;M<u;M++)for(let A=0;A<d;A++){let x=0;const k=M*d+A,U=Math.max(0,M*n+f),b=Math.max(0,A*n+h),T=Math.min(l,U+n),P=Math.min(i,b+n);for(let I=U;I<T;I++)for(let v=b;v<P;v++){const B=I*i+v;if(!c||c[B]){x++;const _=[a[B],o[B]],[S,$]=_;g[k]+=S,m[k]+=$}}if(x>=(T-U)*(P-b)*(1-r)){w[k]=1;const[I,v]=Ct([g[k]/x,m[k]/x]);g[k]=I,m[k]=v}else w[k]=0,g[k]=0,m[k]=0}const y=new F({width:d,height:u,pixels:[g,m],mask:w});return y.updateStatistics(),y}const J=()=>Y.getLogger("esri.views.2d.engine.flow.dataUtils"),re=10;async function Le(t,e,n,s){const r=performance.now(),i=oe(e,n),l=performance.now(),c=he(e,i,n.width,n.height),a=performance.now(),o=fe(c),h=performance.now(),f=t==="Streamlines"?ue(o,re):pe(o),d=performance.now();return et("esri-2d-profiler")&&(J().info("I.1","_createFlowFieldFromData (ms)",Math.round(l-r)),J().info("I.2","_getStreamlines (ms)",Math.round(a-l)),J().info("I.3","createAnimatedLinesData (ms)",Math.round(h-a)),J().info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(d-h)),J().info("I.5","createFlowMesh (ms)",Math.round(d-r)),J().info("I.6","Mesh size (bytes)",f.vertexData.buffer.byteLength+f.indexData.buffer.byteLength)),await Promise.resolve(),Nt(s),f}function oe(t,e){const n=ce(e.data,e.width,e.height,t.smoothing);return t.interpolate?(s,r)=>{const i=Math.floor(s),l=Math.floor(r);if(i<0||i>=e.width)return[0,0];if(l<0||l>=e.height)return[0,0];const c=s-i,a=r-l,o=i,h=l,f=i<e.width-1?i+1:i,d=l<e.height-1?l+1:l,u=n[2*(h*e.width+o)],p=n[2*(h*e.width+f)],g=n[2*(d*e.width+o)],m=n[2*(d*e.width+f)],w=n[2*(h*e.width+o)+1],y=n[2*(h*e.width+f)+1];return[(u*(1-a)+g*a)*(1-c)+(p*(1-a)+m*a)*c,(w*(1-a)+n[2*(d*e.width+o)+1]*a)*(1-c)+(y*(1-a)+n[2*(d*e.width+f)+1]*a)*c]}:(s,r)=>{const i=Math.round(s),l=Math.round(r);return i<0||i>=e.width||l<0||l>=e.height?[0,0]:[n[2*(l*e.width+i)],n[2*(l*e.width+i)+1]]}}function ae(t,e,n,s,r,i,l,c,a){const o=[];let h=n,f=s,d=0,[u,p]=e(h,f);u*=t.velocityScale,p*=t.velocityScale;const g=Math.sqrt(u*u+p*p);let m,w;o.push({x:h,y:f,t:d,speed:g});for(let y=0;y<t.verticesPerLine;y++){let[M,A]=e(h,f);M*=t.velocityScale,A*=t.velocityScale;const x=Math.sqrt(M*M+A*A);if(x<t.minSpeedThreshold)return o;const k=M/x,U=A/x;if(h+=k*t.segmentLength,f+=U*t.segmentLength,d+=t.segmentLength/x,Math.acos(k*m+U*w)>t.maxTurnAngle)return o;if(t.collisions){const b=Math.round(h*a),T=Math.round(f*a);if(b<0||b>l-1||T<0||T>c-1)return o;const P=i[T*l+b];if(P!==-1&&P!==r)return o;i[T*l+b]=r}o.push({x:h,y:f,t:d,speed:x}),m=k,w=U}return o}function he(t,e,n,s){const r=[],i=new Ut,l=1/Math.max(t.lineCollisionWidth,1),c=Math.round(n*l),a=Math.round(s*l),o=new Int32Array(c*a);for(let f=0;f<o.length;f++)o[f]=-1;const h=[];for(let f=0;f<s;f+=t.lineSpacing)for(let d=0;d<n;d+=t.lineSpacing)h.push({x:d,y:f,sort:i.getFloat()});h.sort((f,d)=>f.sort-d.sort);for(const{x:f,y:d}of h)if(i.getFloat()<t.density){const u=ae(t,e,f,d,r.length,o,c,a,l);if(u.length<2)continue;r.push(u)}return r}function ce(t,e,n,s){if(s===0)return t;const r=Math.round(3*s),i=new Array(2*r+1);let l=0;for(let o=-r;o<=r;o++){const h=Math.exp(-o*o/(s*s));i[o+r]=h,l+=h}for(let o=-r;o<=r;o++)i[o+r]/=l;const c=new Float32Array(t.length);for(let o=0;o<n;o++)for(let h=0;h<e;h++){let f=0,d=0;for(let u=-r;u<=r;u++){if(h+u<0||h+u>=e)continue;const p=i[u+r];f+=p*t[2*(o*e+(h+u))],d+=p*t[2*(o*e+(h+u))+1]}c[2*(o*e+h)]=f,c[2*(o*e+h)+1]=d}const a=new Float32Array(t.length);for(let o=0;o<e;o++)for(let h=0;h<n;h++){let f=0,d=0;for(let u=-r;u<=r;u++){if(h+u<0||h+u>=n)continue;const p=i[u+r];f+=p*c[2*((h+u)*e+o)],d+=p*c[2*((h+u)*e+o)+1]}a[2*(h*e+o)]=f,a[2*(h*e+o)+1]=d}return a}function fe(t,e){const n=new Ut,s=t.reduce((a,o)=>a+o.length,0),r=new Float32Array(4*s),i=new Array(t.length);let l=0,c=0;for(const a of t){const o=l;for(const h of a)r[4*l]=h.x,r[4*l+1]=h.y,r[4*l+2]=h.t,r[4*l+3]=h.speed,l++;i[c++]={startVertex:o,numberOfVertices:a.length,totalTime:a[a.length-1].t,timeSeed:n.getFloat()}}return{lineVertices:r,lineDescriptors:i}}function ue(t,e){const{lineVertices:s,lineDescriptors:r}=t;let i=0,l=0;for(const u of r)i+=2*u.numberOfVertices,l+=6*(u.numberOfVertices-1);const c=new Float32Array(i*9),a=new Uint32Array(l);let o=0,h=0;function f(){a[h++]=o-2,a[h++]=o,a[h++]=o-1,a[h++]=o,a[h++]=o+1,a[h++]=o-1}function d(u,p,g,m,w,y,M,A){const x=o*9;let k=0;c[x+k++]=u,c[x+k++]=p,c[x+k++]=1,c[x+k++]=g,c[x+k++]=y,c[x+k++]=M,c[x+k++]=m/2,c[x+k++]=w/2,c[x+k++]=A,o++,c[x+k++]=u,c[x+k++]=p,c[x+k++]=-1,c[x+k++]=g,c[x+k++]=y,c[x+k++]=M,c[x+k++]=-m/2,c[x+k++]=-w/2,c[x+k++]=A,o++}for(const u of r){const{totalTime:p,timeSeed:g}=u;let m=null,w=null,y=null,M=null,A=null,x=null;for(let k=0;k<u.numberOfVertices;k++){const U=s[4*(u.startVertex+k)],b=s[4*(u.startVertex+k)+1],T=s[4*(u.startVertex+k)+2],P=s[4*(u.startVertex+k)+3];let I=null,v=null,B=null,_=null;if(k>0){I=U-m,v=b-w;const S=Math.sqrt(I*I+v*v);if(I/=S,v/=S,k>1){let $=I+A,C=v+x;const V=Math.sqrt($*$+C*C);$/=V,C/=V;const E=Math.min(1/($*I+C*v),e);$*=E,C*=E,B=-C,_=$}else B=-v,_=I;B!==null&&_!==null&&(d(m,w,y,B,_,p,g,P),f())}m=U,w=b,y=T,A=I,x=v,M=P}d(m,w,y,-x,A,p,g,M)}return{vertexData:c,indexData:a}}function pe(t){const{lineVertices:r,lineDescriptors:i}=t;let l=0,c=0;for(const S of i){const $=S.numberOfVertices-1;l+=4*$*2,c+=6*$*2}const a=new Float32Array(l*16),o=new Uint32Array(c);let h,f,d,u,p,g,m,w,y,M,A,x,k,U,b=0,T=0;function P(){o[T++]=b-8,o[T++]=b-7,o[T++]=b-6,o[T++]=b-7,o[T++]=b-5,o[T++]=b-6,o[T++]=b-4,o[T++]=b-3,o[T++]=b-2,o[T++]=b-3,o[T++]=b-1,o[T++]=b-2}function I(S,$,C,V,E,G,L,N,W,X,tt,K,nt,it){const D=b*16;let j=0;for(const at of[1,2])for(const _t of[1,2,3,4])a[D+j++]=S,a[D+j++]=$,a[D+j++]=C,a[D+j++]=V,a[D+j++]=L,a[D+j++]=N,a[D+j++]=W,a[D+j++]=X,a[D+j++]=at,a[D+j++]=_t,a[D+j++]=nt,a[D+j++]=it,a[D+j++]=E/2,a[D+j++]=G/2,a[D+j++]=tt/2,a[D+j++]=K/2,b++}function v(S,$){let C=y+A,V=M+x;const E=Math.sqrt(C*C+V*V);C/=E,V/=E;const G=y*C+M*V;C/=G,V/=G;let L=A+k,N=x+U;const W=Math.sqrt(L*L+N*N);L/=W,N/=W;const X=A*L+x*N;L/=X,N/=X,I(h,f,d,u,-V,C,p,g,m,w,-N,L,S,$),P()}function B(S,$,C,V,E,G){if(y=A,M=x,A=k,x=U,y==null&&M==null&&(y=A,M=x),p!=null&&g!=null){k=S-p,U=$-g;const L=Math.sqrt(k*k+U*U);k/=L,U/=L}y!=null&&M!=null&&v(E,G),h=p,f=g,d=m,u=w,p=S,g=$,m=C,w=V}function _(S,$){y=A,M=x,A=k,x=U,y==null&&M==null&&(y=A,M=x),y!=null&&M!=null&&v(S,$)}for(const S of i){h=null,f=null,d=null,u=null,p=null,g=null,m=null,w=null,y=null,M=null,A=null,x=null,k=null,U=null;const{totalTime:$,timeSeed:C}=S;for(let V=0;V<S.numberOfVertices;V++)B(r[4*(S.startVertex+V)],r[4*(S.startVertex+V)+1],r[4*(S.startVertex+V)+2],r[4*(S.startVertex+V)+3],$,C);_($,C)}return{vertexData:a,indexData:o}}function bt(t,e){const n=e.pixels,{width:s,height:r}=e,i=new Float32Array(s*r*2),l=e.mask||new Uint8Array(s*r*2);if(e.mask||l.fill(255),t==="vector-uv")for(let c=0;c<s*r;c++)i[2*c]=n[0][c],i[2*c+1]=-n[1][c];else if(t==="vector-magdir")for(let c=0;c<s*r;c++){const a=n[0][c],o=Wt(n[1][c]),h=Math.cos(o-Math.PI/2),f=Math.sin(o-Math.PI/2);i[2*c]=h*a,i[2*c+1]=f*a}return{data:i,mask:l,width:s,height:r}}async function je(t,e,n,s,r,i){const l=performance.now(),c=Gt(e.spatialReference);if(!c){const A=await vt(t,e,n,s,r,i);return et("esri-2d-profiler")&&J().info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-l)),et("esri-2d-profiler")&&J().info("I.9","Number of parts",1),A}const[a,o]=c.valid,h=o-a,f=Math.ceil(e.width/h),d=e.width/f,u=Math.round(n/f);let p=e.xmin;const g=[],m=performance.now();for(let A=0;A<f;A++){const x=new Ot({xmin:p,xmax:p+d,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});g.push(vt(t,x,u,s,r,i)),p+=d}const w=await Promise.all(g);et("esri-2d-profiler")&&J().info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-m)),et("esri-2d-profiler")&&J().info("I.9","Number of parts",w.length);const y={data:new Float32Array(n*s*2),mask:new Uint8Array(n*s),width:n,height:s};let M=0;for(const A of w){for(let x=0;x<A.height;x++)for(let k=0;k<A.width;k++)M+k>=n||(y.data[2*(x*n+M+k)]=A.data[2*(x*A.width+k)],y.data[2*(x*n+M+k)+1]=A.data[2*(x*A.width+k)+1],y.mask[x*n+M+k]=A.mask[x*A.width+k]);M+=A.width}return et("esri-2d-profiler")&&J().info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-l)),y}async function vt(t,e,n,s,r,i){const l={requestProjectedLocalDirections:!0,signal:i};if(r!=null&&(l.timeExtent=r),t.type==="imagery"){await t.load({signal:i});const a=await t.internalFetchImage(e,n,s,l);return a?.pixelData?.pixelBlock==null?{data:new Float32Array(n*s*2),mask:new Uint8Array(n*s),width:n,height:s}:bt(t.rasterInfo.dataType,a.pixelData.pixelBlock)}await t.load({signal:i});const c=await t.fetchPixels(e,n,s,l);return c?.pixelBlock==null?{data:new Float32Array(n*s*2),mask:new Uint8Array(n*s),width:n,height:s}:bt(t.serviceRasterInfo.dataType,c.pixelBlock)}export{Ae as A,Ie as B,Fe as D,$e as I,Pe as M,Be as R,Re as S,Xt as T,Te as U,$t as W,se as _,De as a,ot as b,F as c,dt as d,Pt as e,At as f,je as g,ye as h,Me as i,Se as j,ke as k,Ct as l,_e as m,we as n,xe as o,Ve as p,xt as q,R as r,Le as s,gt as t,Ce as u,wt as v,ve as w,Ue as x,Tt as y,be as z};
