import{bh as m,bl as te,ds as F,h as a,a0 as z,fd as _,v as i,x as r,H as B,z as g,c6 as ie,B as E,fb as se,i as P,du as V,el as re,bJ as R,bV as oe,bn as T,dt as J,fe as ne,i7 as G,bp as le}from"./main-BFDurRCu.js";import{j as U}from"./ClassBreaksRenderer-Bq2XGpfI.js";import{v as M,a as S,g as ae,n as pe,c as ue,f as ye,u as ce}from"./commonProperties-CJLeiNuA.js";import{e as de}from"./LRUCache-DPWdPNTF.js";import{s as he}from"./DictionaryScriptEvaluator-DW5hOK9A.js";import{_ as me}from"./ArcadeExpression-XjY3x7KV.js";import{J as fe}from"./utils-BfXZnjCE.js";import{a as be,e as ge,c as ve}from"./heatmapUtils-DRTN9U3a.js";import{u as we}from"./RendererLegendOptions-Bil_IDab.js";import{m as Z}from"./SimpleRenderer-C1YRhRzu.js";import{$ as K}from"./UniqueValueRenderer-CLXHFtg9.js";class N{static parse(t,s,o){const n=[],l=[],y=t.split(";");for(let h=0;h<y.length;h++){const u=y[h];if(u){if(u.includes("po:")){const b=u.slice(3).split("|");if(b.length===3){const[I,D,ee]=b,$=Se(I,D,ee);$&&l.push($)}}else if(u.includes("|")){for(const b of u.split("|"))if(s.has(b)){n.push(b);break}}else if(s.has(u))n.push(u);else if(h===0){n.length=0,n.push(je(o));break}}}return new N(n,l)}constructor(t,s){this.partNames=t,this.overrides=s}}function xe(e,t){if(e==="DashTemplate")return t.split(" ").map(s=>Number(s));if(e==="Color"){const s=new m(t).toRgba();return[s[0],s[1],s[2],255*s[3]]}return Number(t)}function Se(e,t,s){return{primitiveName:e,propertyName:t,value:xe(t,s),defaultValue:null}}function je(e){switch(e){case"esriGeometryPolyline":return"Invalid_L";case"esriGeometryPolygon":return"Invalid_A";default:return"Invalid_P"}}const Ie={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};let Q=class{constructor(e,t,s,o){this.url=e,this.fieldMap=s,this.dictionaryInfo=o,this._symbolPartCache=new de(100);const n=async()=>he.from(await o,t,s);this._evaluator=n()}async getSymbolAsync(e,t,s=!0){const o=await this._evaluator,n=t?.fields??me(e.attributes),l=o.createDictionaryFieldsIndex(n),y=o.evaluate(e,t?.scale??0,l,t?.spatialReference);if(y==null)return null;const h=te(e.geometry),u=N.parse(y,o.itemNames,h),b=h==="esriGeometryPoint"&&!e.geometry?.hasZ;return await this._cimPartsToCIMSymbol(e,u.partNames,u.overrides,b,t,s,l)}async getSymbolForControlString(e,t,s){const o=await this._evaluator,n=N.parse(e,o.itemNames,t),l=t==="esriGeometryPoint"&&!s,y=W(await Promise.all(n.partNames.map(h=>this._getSymbolPart(h))),n.overrides,l);return new F({data:y})}async _cimPartsToCIMSymbol(e,t,s,o,n,l,y){const h=t.map(I=>this._getSymbolPart(I,n));let u=await Promise.all(h);if(l&&this.fieldMap&&u.length>0){const{OverrideHelper:I}=await import("./OverrideHelper-DgyARgwI.js");u=a(u);for(const D of u)I.applyDictionaryTextOverrides(D,e,this.fieldMap,y,fe(D))}const b=W(u,s,o);return new F({data:b})}async _fetchSymbolPart(e,t){const s=await this.dictionaryInfo,o=(this.url+"/"+s.cimRefTemplateUrl).replaceAll(/\{itemName\}/gi,e),{data:n}=await z(o,{responseType:"json",query:{f:"json"},...t});return n}async _getSymbolPart(e,t){let s=this._symbolPartCache.get(e);return s||(s=this._fetchSymbolPart(e,t),this._symbolPartCache.put(e,s)),s}};function W(e,t,s){if(!e||e.length===0)return null;const o={...e[0]};if(e.length>1){o.effects=null,o.symbolLayers=[];for(const n of e){const l=n;if(l.effects!=null)for(const y of l.symbolLayers)y.effects==null?y.effects=l.effects:y.effects.unshift(...l.effects);o.symbolLayers.unshift(...l.symbolLayers)}}return s&&(o.callout=Ie),{type:"CIMSymbolReference",symbol:o,primitiveOverrides:t}}var O;let f=O=class extends M(S){constructor(e){super(e),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){const e=this.getDictionaryInfo();return new Q(this.url,this.config,this.fieldMap??{},e)}writeData(e,t){e&&(t.scalingExpressionInfo={expression:e,returnType:"number"})}writeVisualVariables(e,t,s,o){o?.origin||super.writeVisualVariables(e,t,s,o)}clone(){return new O({config:a(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:a(this.fieldMap),url:a(this.url),visualVariables:a(this.visualVariables)})}async getSymbolAsync(e,t,s=!0){return this._loader.getSymbolAsync(e,t,s)}async getSymbolForControlString(e,t,s){return this._loader.getSymbolForControlString(e,t,s)}getDictionaryInfo(){return this._dictionaryInfoPromise||(this._dictionaryInfoPromise=this._fetchDictionaryInfo()),this._dictionaryInfoPromise}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t),this.scaleExpression&&await _(e,t,this.scaleExpression);for(const s in this.fieldMap){const o=this.fieldMap[s];t.has(o)&&e.add(o)}}get arcadeRequired(){return!0}getSymbol(){return null}get symbols(){return[]}getAttributeHash(){return this.visualVariables?.reduce((e,t)=>e+t.getAttributeHash(),"")??""}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}async _fetchDictionaryInfo(){const{data:e}=await z(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"}});return e}};i([r({type:Q})],f.prototype,"_loader",null),i([r({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],f.prototype,"config",void 0),i([r({type:Object,json:{write:!0}})],f.prototype,"fieldMap",void 0),i([r({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],f.prototype,"scaleExpression",void 0),i([B("scaleExpression")],f.prototype,"writeData",null),i([r({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],f.prototype,"scaleExpressionTitle",void 0),i([r({type:String,json:{write:!0}})],f.prototype,"url",void 0),i([B("visualVariables")],f.prototype,"writeVisualVariables",null),f=O=i([g("esri.renderers.DictionaryRenderer")],f);var q;let v=q=class extends E{constructor(e){super(e),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(e){return e==null?e:typeof e=="function"?(P.getLogger(this).error(".field: field must be a string value"),null):se(e)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){return new q({color:this.color?.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};i([r({type:m,json:{type:[Number],write:!0}})],v.prototype,"color",void 0),i([r({type:String,json:{write:!0}})],v.prototype,"field",void 0),i([ie("field")],v.prototype,"castField",null),i([r({type:String,json:{write:!0}})],v.prototype,"label",void 0),i([r({type:String,json:{write:!0}})],v.prototype,"valueExpression",void 0),i([r({type:String,json:{write:!0}})],v.prototype,"valueExpressionTitle",void 0),v=q=i([g("esri.renderers.support.AttributeColorInfo")],v);const X=v;var L;let C=L=class extends E{constructor(){super(...arguments),this.unit=null}clone(){return new L({unit:this.unit})}};i([r({type:String,json:{write:!0}})],C.prototype,"unit",void 0),C=L=i([g("esri.renderers.support.DotDensityLegendOptions")],C);const Ee=C;var k;let c=k=class extends M(S){constructor(e){super(e),this.attributes=null,this.backgroundColor=new m([0,0,0,0]),this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new V,this.dotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(e){if(this.referenceScale==null)return this.dotValue;const t=e/this.referenceScale*this.dotValue;return t<1?1:t}getSymbol(){return new re({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}get symbols(){return[this.getSymbol()]}getAttributeHash(){return this.attributes?.reduce((e,t)=>e+t.getAttributeHash(),"")??""}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new k({attributes:a(this.attributes),backgroundColor:a(this.backgroundColor),dotBlendingEnabled:a(this.dotBlendingEnabled),dotShape:a(this.dotShape),dotSize:a(this.dotSize),dotValue:a(this.dotValue),legendOptions:a(this.legendOptions),outline:a(this.outline),referenceScale:a(this.referenceScale),seed:a(this.seed),visualVariables:a(this.visualVariables),authoringInfo:a(this.authoringInfo)})}getControllerHash(){return`${this.attributes?.map(e=>e.field||e.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t);for(const s of this.attributes??[])s.valueExpression&&await _(e,t,s.valueExpression),s.field&&e.add(s.field)}};i([r({type:[X],json:{write:!0}})],c.prototype,"attributes",void 0),i([r({type:m,json:{write:!0}})],c.prototype,"backgroundColor",void 0),i([r({type:Boolean,json:{write:!0}})],c.prototype,"dotBlendingEnabled",void 0),i([r({type:String,json:{write:!1}})],c.prototype,"dotShape",void 0),i([r({type:Number,json:{write:!0}})],c.prototype,"dotSize",void 0),i([r({type:Ee,json:{write:!0}})],c.prototype,"legendOptions",void 0),i([r({type:V,json:{default:null,write:!0}})],c.prototype,"outline",void 0),i([r({type:Number,json:{write:!0}})],c.prototype,"dotValue",void 0),i([r({type:Number,json:{write:!0}})],c.prototype,"referenceScale",void 0),i([r({type:Number,json:{write:!0}})],c.prototype,"seed",void 0),i([R({dotDensity:"dot-density"})],c.prototype,"type",void 0),c=k=i([g("esri.renderers.DotDensityRenderer")],c);var A;let w=A=class extends E{constructor(e){super(e),this.color=null,this.ratio=null}clone(){return new A({color:this.color&&this.color.clone(),ratio:this.ratio})}};i([r({type:m,json:{type:[oe],default:null,write:{isRequired:!0}}})],w.prototype,"color",void 0),i([r({type:Number,json:{write:{isRequired:!0}}})],w.prototype,"ratio",void 0),w=A=i([g("esri.renderers.support.HeatmapColorStop")],w);let j=class extends T.ClonableMixin(E){constructor(){super(...arguments),this.minLabel=null,this.maxLabel=null,this.title=null}};i([r({type:String,json:{write:!0}})],j.prototype,"minLabel",void 0),i([r({type:String,json:{write:!0}})],j.prototype,"maxLabel",void 0),i([r({type:String,json:{write:!0}})],j.prototype,"title",void 0),j=i([g("esri.renderers.support.HeatmapLegendOptions")],j);var H;function Y(e){if(e!=null){const{maxDensity:t,minDensity:s,radius:o}=e;if(t!=null||s!=null||o!=null){const{blurRadius:n,maxPixelIntensity:l,minPixelIntensity:y,...h}=e;return h}}return e}let p=H=class extends S{constructor(e){super(e),this.authoringInfo=null,this.colorStops=[new w({ratio:0,color:new m("rgba(255, 140, 0, 0)")}),new w({ratio:.75,color:new m("rgba(255, 140, 0, 1)")}),new w({ratio:.9,color:new m("rgba(255, 0,   0, 1)")})],this.field=null,this.legendOptions=null,this.maxDensity=.04,this.minDensity=0,this.radius=18,this.referenceScale=0,this.type="heatmap",this.valueExpression=null,this.valueExpressionTitle=null}normalizeCtorArgs(e){return Y(e)}get blurRadius(){return be(this.radius)}set blurRadius(e){const t=this.maxPixelIntensity,s=this.minPixelIntensity;this._set("radius",ge(e)),this._set("maxDensity",t*this._pixelIntensityToDensity),this._set("minDensity",s*this._pixelIntensityToDensity)}get maxPixelIntensity(){return this.maxDensity/this._pixelIntensityToDensity}set maxPixelIntensity(e){this._set("maxDensity",e*this._pixelIntensityToDensity)}get minPixelIntensity(){return this.minDensity/this._pixelIntensityToDensity}set minPixelIntensity(e){this._set("minDensity",e*this._pixelIntensityToDensity)}get _pixelIntensityToDensity(){return 24/(ve**2*this.blurRadius**4)}read(e,t){e=Y(e),super.read(e,t)}getSymbol(){return new J}async getSymbolAsync(){return this.getSymbol()}get symbols(){return[this.getSymbol()]}async collectRequiredFields(e,t){const s=this.field,o=this.valueExpression;s&&typeof s=="string"&&ne(e,t,s),o&&typeof o=="string"&&await _(e,t,o)}getAttributeHash(){return""}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new H({authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),colorStops:a(this.colorStops),field:this.field,legendOptions:a(this.legendOptions),maxDensity:this.maxDensity,minDensity:this.minDensity,radius:this.radius,referenceScale:this.referenceScale,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};i([r({type:ae,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],p.prototype,"authoringInfo",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],p.prototype,"blurRadius",null),i([r({type:[w],json:{write:{isRequired:!0}}})],p.prototype,"colorStops",void 0),i([r({type:String,json:{write:!0}})],p.prototype,"field",void 0),i([r({type:j,json:{write:!0}})],p.prototype,"legendOptions",void 0),i([r({type:Number,json:{write:!0}})],p.prototype,"maxDensity",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],p.prototype,"maxPixelIntensity",null),i([r({type:Number,json:{write:!0}})],p.prototype,"minDensity",void 0),i([r({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],p.prototype,"minPixelIntensity",null),i([r({type:Number,cast:G,json:{write:!0}})],p.prototype,"radius",void 0),i([r({type:Number,range:{min:0},json:{default:0,write:!0}})],p.prototype,"referenceScale",void 0),i([R({heatmap:"heatmap"})],p.prototype,"type",void 0),i([r({type:String,json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],p.prototype,"valueExpression",void 0),i([r({type:String})],p.prototype,"valueExpressionTitle",void 0),i([r({readOnly:!0})],p.prototype,"_pixelIntensityToDensity",null),p=H=i([g("esri.renderers.HeatmapRenderer")],p);let x=class extends T.ClonableMixin(E){constructor(){super(...arguments),this.color=new m([0,0,0,0]),this.label=null,this.threshold=0}};i([r({type:m,json:{write:!0}})],x.prototype,"color",void 0),i([r({type:String,json:{write:!0}})],x.prototype,"label",void 0),i([r({type:Number,range:{min:0,max:1},json:{write:!0}})],x.prototype,"threshold",void 0),x=i([g("esri.renderers.support.OthersCategory")],x);const De={base:ce,key:"type",typeMap:{size:ye,opacity:ue}};let d=class extends M(T.ClonableMixin(S)){constructor(e){super(e),this.attributes=null,this.backgroundFillSymbol=null,this.defaultColor=new m([0,0,0,0]),this.defaultLabel=null,this.holePercentage=0,this.othersCategory=new x,this.legendOptions=null,this.outline=null,this.size=12,this.type="pie-chart",this.visualVariables=null}getSymbol(){return new J({size:this.size?this.size/2+(this.outline?.width||0):0})}async getSymbolAsync(){return this.getSymbol()}get symbols(){return[this.getSymbol(),this.backgroundFillSymbol].filter(le)}getAttributeHash(){return this.visualVariables?.reduce((e,t)=>e+t.getAttributeHash(),"")??""}getMeshHash(){return this.symbols.reduce((e,t)=>e+JSON.stringify(t),"")}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t);for(const s of this.attributes)s.valueExpression&&await _(e,t,s.valueExpression),s.field&&e.add(s.field)}};i([r({type:[X],json:{write:!0}})],d.prototype,"attributes",void 0),i([r(pe)],d.prototype,"backgroundFillSymbol",void 0),i([r({type:m,json:{write:!0}})],d.prototype,"defaultColor",void 0),i([r({type:String,json:{write:!0}})],d.prototype,"defaultLabel",void 0),i([r({type:Number,range:{min:0,max:1},json:{write:!0}})],d.prototype,"holePercentage",void 0),i([r({type:x,json:{write:!0}})],d.prototype,"othersCategory",void 0),i([r({type:we,json:{write:!0}})],d.prototype,"legendOptions",void 0),i([r({type:V,json:{default:null,write:!0}})],d.prototype,"outline",void 0),i([r({type:Number,cast:G,json:{write:!0}})],d.prototype,"size",void 0),i([R({pieChart:"pie-chart"})],d.prototype,"type",void 0),i([r({types:[De]})],d.prototype,"visualVariables",void 0),d=i([g("esri.renderers.PieChartRenderer")],d);const _e={key:"type",base:S,typeMap:{heatmap:p,simple:Z,"unique-value":K,"class-breaks":U,"dot-density":c,dictionary:f,"pie-chart":d},errorContext:"renderer"},Pe={key:"type",base:S,typeMap:{simple:Z,"unique-value":K,"class-breaks":U,heatmap:p},errorContext:"renderer",validate:Ce};function Ce(e){switch(e.type){case"simple":return Ne(e);case"unique-value":return Ve(e);case"class-breaks":return Re(e);case"heatmap":return e}}function Ne(e){if(e.symbol)return e;P.getLogger("esri.renderers.support.types").error("Removed invalid 'simple' renderer without a symbol from web scene.")}function Ve(e){const t=e.uniqueValueInfos,s=t?.filter(({symbol:o,label:n},l)=>(o||P.getLogger("esri.renderers.support.types").error(`Removed invalid unique value info ([${l}] ${n}) without a symbol from web scene.`),!!o));return s?.length!==t?.length&&(e.uniqueValueInfos=s),e}function Re(e){const t=e.classBreakInfos,s=t?.filter(({symbol:o,label:n},l)=>(o||P.getLogger("esri.renderers.support.types").error(`Removed invalid class break info ([${l}] ${n}) without a symbol from web scene.`),!!o));return s?.length!==t?.length&&(e.classBreakInfos=s),e}export{w as c,_e as m,Pe as u};
