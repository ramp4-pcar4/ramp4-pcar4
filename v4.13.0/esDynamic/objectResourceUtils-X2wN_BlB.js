import{dy as Q,a0 as we,q as Y,i as be,fB as K,hY as _,s as ve,ah as W,cP as J,fs as X}from"./main-BFDurRCu.js";import{a as Me}from"./devEnvironmentUtils-CxrVv3RG.js";import{i as Z,j as Ae,n as Re}from"./mat3-DOnW3DjW.js";import{n as z,e as ee}from"./mat3f64-BnNZDR5l.js";import{h as Be}from"./mat4-OOmHNWi7.js";import{e as Oe}from"./mat4f64-xsZDPPj0.js";import{a as Se}from"./vec2f64-CkowXrDb.js";import{E as te,c as Pe,i as re,r as Ie,A as Ee,I as Ce}from"./vec32-Cj8pVsU0.js";import{L as se,p as oe,n as $}from"./OutputColorHighlightOID.glsl-BdXTjs7_.js";import{o as ne,T as ae,g as Fe,M as ke,O as Ue,V as Le}from"./BufferView-wDxx79o3.js";import{r as qe,n as _e,d as ie,l as le}from"./vec3-lTcIGC_C.js";import{o as $e,d as ue}from"./vec4-FWCYsiir.js";import{n as je,o as Ne,a as Ve}from"./indexUtils-l8XrgMvJ.js";import{n as j}from"./resourceUtils-Tz7BBTTs.js";import{a as De,i as Ge}from"./vec2f32-hTAvipMV.js";import{_ as ce}from"./asyncUtils-BPUlNCrX.js";import{u as We}from"./memoryEstimations-DeWfxwaV.js";import{t as ze}from"./NestedMap-DL9KstBd.js";import{r as me}from"./Version-CnwD6MZa.js";import{A as He}from"./Indices-BuIC5D20.js";import{t as Qe}from"./requestImageUtils-B2YN5Eb9.js";import{t as C}from"./orientedBoundingBox-CSC169JG.js";import{e as H,i as A,n as Ye}from"./basicInterfaces-Dsf65ICa.js";import{e as E}from"./VertexAttribute-hUz6pozM.js";import{W as N,n as Ke,o as Je,s as Xe,t as Ze}from"./DefaultMaterial-7UvmJfZD.js";import{P as fe}from"./enums-wEDHPbCF.js";import{a as de}from"./NormalAttribute.glsl-BnbqDItl.js";function F(r){if(r==null)return null;const t=r.offset!=null?r.offset:De,o=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:Ge,u=z(1,0,0,0,1,0,t[0],t[1],1),i=z(Math.cos(o),-Math.sin(o),0,Math.sin(o),Math.cos(o),0,0,0,1),n=z(s[0],0,0,0,s[1],0,0,0,1),a=ee();return Z(a,i,n),Z(a,u,a),a}class et{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class tt{constructor(t,o,s){this.name=t,this.lodThreshold=o,this.pivotOffset=s,this.stageResources=new et,this.numberOfVertices=0}}const B=()=>be.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class rt{constructor(t,o,s){this.resource=t,this.textures=o,this.cachedMemory=s}}async function st(r,t){const o=await ot(r,t),s=await ut(o.textureDefinitions??{},t);let u=0;for(const i in s)if(s.hasOwnProperty(i)){const n=s[i];u+=n?.image?n.image.width*n.image.height*4:0}return new rt(o,s,u+We(o))}async function ot(r,t){const o=t?.streamDataRequester;if(o)return nt(r,o,t);const s=await ce(we(r,t));if(s.ok===!0)return s.value.data;Y(s.error),pe(s.error)}async function nt(r,t,o){const s=await ce(t.request(r,"json",o));if(s.ok===!0)return s.value;Y(s.error),pe(s.error.details.url)}function pe(r){throw new ve("",`Request for object resource failed: ${r}`)}function at(r){const t=r.params,o=t.topology;let s=!0;switch(t.vertexAttributes||(B().warn("Geometry must specify vertex attributes"),s=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=t.faces;if(i){if(t.vertexAttributes)for(const n in t.vertexAttributes){const a=i[n];a?.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(B().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),s=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(B().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),s=!1)):(B().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),s=!1)}}else B().warn("Indexed geometries must specify faces"),s=!1;break}default:B().warn(`Unsupported topology '${o}'`),s=!1}r.params.material||(B().warn("Geometry requires material"),s=!1);const u=r.params.vertexAttributes;for(const i in u)u[i].values||(B().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function it(r,t){const o=new Array,s=new Array,u=new Array,i=new ze,n=r.resource,a=me.parse(n.version||"1.0","wosr");mt.validate(a);const m=n.model.name,e=n.model.geometries,l=n.materialDefinitions??{},c=r.textures;let x=0;const h=new Map;for(let g=0;g<e.length;g++){const f=e[g];if(!at(f))continue;const w=ct(f),T=f.params.vertexAttributes,b=[],p=d=>{if(f.params.topology==="PerAttributeArray")return null;const M=f.params.faces;for(const y in M)if(y===d)return M[y].values;return null},v=T[E.POSITION],U=v.values.length/v.valuesPerElement;for(const d in T){const M=T[d],y=M.values,D=p(d)??He(U);b.push([d,new C(y,D,M.valuesPerElement,!0)])}const R=w.texture,P=c&&c[R];if(P&&!h.has(R)){const{image:d,parameters:M}=P,y=new se(d,M);s.push(y),h.set(R,y)}const L=h.get(R),V=L?L.id:void 0,O=w.material;let S=i.get(O,R);if(S==null){const d=l[O.slice(O.lastIndexOf("/")+1)].params;d.transparency===1&&(d.transparency=0);const M=P?he(P.alphaChannelUsage):void 0,y={ambient:Q(d.diffuse),diffuse:Q(d.diffuse),opacity:1-(d.transparency||0),textureAlphaMode:M,textureAlphaCutoff:.33,textureId:V,doubleSided:!0,cullFace:H.None,colorMixMode:d.externalColorMixMode||"tint",textureAlphaPremultiplied:P?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(y,t.materialParameters),S=new N(y,t),i.set(O,R,S)}u.push(S);const q=new oe(S,b);x+=b.find(d=>d[0]===E.POSITION)?.[1]?.indices.length??0,o.push(q)}return{engineResources:[{name:m,stageResources:{textures:s,materials:u,geometries:o},pivotOffset:n.model.pivotOffset,numberOfVertices:x,lodThreshold:null}],referenceBoundingBox:lt(o)}}function lt(r){const t=K();return r.forEach(o=>{const s=o.boundingInfo;s!=null&&(_(t,s.bbMin),_(t,s.bbMax))}),t}async function ut(r,t){const o=new Array;for(const i in r){const n=r[i],a=n.images[0].data;if(!a){B().warn("Externally referenced texture data is not yet supported");continue}const m=n.encoding+";base64,"+a,e="/textureDefinitions/"+i,l=n.channels==="rgba"?n.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:fe.REPEAT,t:fe.REPEAT},preMultiplyAlpha:he(l)!==A.Opaque},x=t?.disableTextures?Promise.resolve(null):Qe(m,t);o.push(x.then(h=>({refId:e,image:h,parameters:c,alphaChannelUsage:l})))}const s=await Promise.all(o),u={};for(const i of s)u[i.refId]=i;return u}function he(r){switch(r){case"mask":return A.Mask;case"maskAndTransparency":return A.MaskBlend;case"none":return A.Opaque;default:return A.Blend}}function ct(r){const t=r.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const mt=new me(1,2,"wosr");async function xe(r,t){const o=ge(Me(r));if(o.fileType==="wosr"){const c=await(t.cache?t.cache.loadWOSR(o.url,t):st(o.url,t)),{engineResources:x,referenceBoundingBox:h}=it(c,t);return{lods:x,referenceBoundingBox:h,isEsriSymbolResource:!1,isWosr:!0}}let s;if(t.cache)s=await t.cache.loadGLTF(o.url,t,!!t.usePBR);else{const{loadGLTF:c}=await import("./loader-DSz2HLee.js");s=await c(new je(t.streamDataRequester),o.url,t,t.usePBR)}const u=s.model.meta?.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&u!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,xt(s,u));const n=!!t.usePBR,a=s.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:i,mrrFactors:Xe}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:Ze},m={...t.materialParameters,treeRendering:i},{engineResources:e,referenceBoundingBox:l}=ft(s,a,m,t,o.specifiedLodIndex,i);return{lods:e,referenceBoundingBox:l,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function ge(r){const t=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function ft(r,t,o,s,u,i){const n=r.model,a=new Array,m=new Map,e=new Map,l=n.lods.length,c=K();return n.lods.forEach((x,h)=>{const g=s.skipHighLods===!0&&(l>1&&h===0||l>3&&h===1)||s.skipHighLods===!1&&u!=null&&h!==u;if(g&&h!==0)return;const f=new tt(x.name,x.lodThreshold,[0,0,0]);x.parts.forEach(w=>{const T=g?new N({},s):dt(n,w,f,t,o,m,e,s,i),{geometry:b,vertexCount:p}=pt(w,T??new N({},s)),v=b.boundingInfo;v!=null&&h===0&&(_(c,v.bbMin),_(c,v.bbMax)),T!=null&&(f.stageResources.geometries.push(b),f.numberOfVertices+=p)}),g||a.push(f)}),{engineResources:a,referenceBoundingBox:c}}function dt(r,t,o,s,u,i,n,a,m){const e=r.materials.get(t.material);if(e==null)return null;const{normal:l,color:c,texCoord0:x,tangent:h}=t.attributes,g=t.material+(l?"_normal":"")+(c?"_color":"")+(x?"_texCoord0":"")+(h?"_tangent":""),f=t.attributes.texCoord0!=null,w=t.attributes.normal!=null,T=ht(e.alphaMode);if(!i.has(g)){if(f){const d=(y,D=!1,ye=!1)=>{if(y!=null&&!n.has(y)){const G=r.textures.get(y);if(G){const I=G.data,Te=D&&!j(I)?a.compressionOptions:void 0;n.set(y,new se(j(I)?I.data:I,{...G.parameters,preMultiplyAlpha:!j(I)&&ye,encoding:j(I)?I.encoding:void 0,compressionOptions:Te}))}}},M=T!==A.Opaque&&!m;d(e.colorTexture,M,T!==A.Opaque),d(e.normalTexture),d(e.occlusionTexture,!0),d(e.emissiveTexture),d(e.metallicRoughnessTexture,!0)}const p=1/J,v=e.color[0]**p,U=e.color[1]**p,R=e.color[2]**p,P=e.emissiveFactor[0]**p,L=e.emissiveFactor[1]**p,V=e.emissiveFactor[2]**p,O=e.colorTexture!=null&&f?n.get(e.colorTexture):null,S=Ke(e),q=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:Se;i.set(g,new N({...s,customDepthTest:Ye.Lequal,textureAlphaMode:T,textureAlphaCutoff:e.alphaCutoff,diffuse:[v,U,R],ambient:[v,U,R],opacity:e.alphaMode==="OPAQUE"?1:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?H.None:H.Back,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:w?de.Attribute:de.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclusion,textureId:O?.id,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&f?n.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:O!=null&&!!O.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&f?n.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&f?n.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&f?n.get(e.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[P,L,V],mrrFactors:S?Je:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:S,colorTextureTransformMatrix:F(e.colorTextureTransform),normalTextureTransformMatrix:F(e.normalTextureTransform),scale:[q[0],q[1]],occlusionTextureTransformMatrix:F(e.occlusionTextureTransform),emissiveTextureTransformMatrix:F(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:F(e.metallicRoughnessTextureTransform),...u},a))}const b=i.get(g);if(o.stageResources.materials.push(b),f){const p=v=>{v!=null&&o.stageResources.textures.push(n.get(v))};p(e.colorTexture),p(e.normalTexture),p(e.occlusionTexture),p(e.emissiveTexture),p(e.metallicRoughnessTexture)}return b}function pt(r,t){const o=r.attributes.position.count,s=Ne(r.indices||o,r.primitiveType),u=$(3*o),{typedBuffer:i,typedBufferStride:n}=r.attributes.position;qe(u,i,r.transform,3,n);const a=[[E.POSITION,new C(u,s,3,!0)]];if(r.attributes.normal!=null){const e=$(3*o),{typedBuffer:l,typedBufferStride:c}=r.attributes.normal;Ae(k,r.transform),_e(e,l,k,3,c),X(k)&&ie(e,e),a.push([E.NORMAL,new C(e,s,3,!0)])}if(r.attributes.tangent!=null){const e=$(4*o),{typedBuffer:l,typedBufferStride:c}=r.attributes.tangent;Re(k,r.transform),$e(e,l,k,4,c),X(k)&&ie(e,e,4),a.push([E.TANGENT,new C(e,s,4,!0)])}if(r.attributes.texCoord0!=null){const e=$(2*o),{typedBuffer:l,typedBufferStride:c}=r.attributes.texCoord0;Ve(e,l,2,c),a.push([E.UV0,new C(e,s,2,!0)])}const m=r.attributes.color;if(m!=null){const e=new Uint8Array(4*o);m.elementCount===4?m instanceof ae?ue(e,m,1,255):(m instanceof Fe||m instanceof ke)&&ue(e,m,1/255,255):(e.fill(255),m instanceof ne?le(e,m.typedBuffer,1,255,4,m.typedBufferStride):(r.attributes.color instanceof Ue||r.attributes.color instanceof Le)&&le(e,m.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),a.push([E.COLOR,new C(e,s,4,!0)])}return{geometry:new oe(t,a),vertexCount:o}}const k=ee();function ht(r){switch(r){case"BLEND":return A.Blend;case"MASK":return A.Mask;case"OPAQUE":case null:case void 0:return A.Opaque}}function xt(r,t){for(let o=0;o<r.model.lods.length;++o){const s=r.model.lods[o];for(const u of s.parts){const i=u.attributes.normal;if(i==null)return;const n=u.attributes.position,a=n.count,m=W(),e=W(),l=W(),c=new Float32Array(4*a),x=new Float32Array(3*a),h=Be(Oe(),u.transform);let g=0,f=0;for(let w=0;w<a;w++){n.getVec(w,e),i.getVec(w,m),te(e,e,u.transform),Pe(l,e,t.center),re(l,l,t.radius);const T=l[2],b=Ie(l),p=Math.min(.45+.55*b*b,1)**J;re(l,l,t.radius),h!==null&&te(l,l,h),Ee(l,l),o+1!==r.model.lods.length&&r.model.lods.length>1&&Ce(l,l,m,T>-1?.2:Math.min(-4*T-3.8,1)),x[g]=l[0],x[g+1]=l[1],x[g+2]=l[2],g+=3,c[f]=p,c[f+1]=p,c[f+2]=p,c[f+3]=1,f+=4}u.attributes.normal=new ne(x),u.attributes.color=new ae(c)}}}const gt=Object.freeze(Object.defineProperty({__proto__:null,fetch:xe,parseUrl:ge},Symbol.toStringTag,{value:"Module"}));export{xe as Y,gt as o,F as s};
