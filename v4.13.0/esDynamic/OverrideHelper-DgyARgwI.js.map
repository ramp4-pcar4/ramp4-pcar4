{"version":3,"file":"OverrideHelper-DgyARgwI.js","sources":["../../node_modules/@arcgis/core/symbols/cim/OverrideHelper.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\n*/\nimport e from\"../../Color.js\";import{isRGB as r}from\"../../core/colorUtils.js\";import{clone as i}from\"../../core/lang.js\";import s from\"../../layers/support/FieldsIndex.js\";import{createRendererExpression as t}from\"../../support/ArcadeExpression.js\";import{normalizeDashEffectTemplate as o,toLowerCaseProps as a,normalizePrimitiveOverrideProps as c,attributesToFields as l,analyzeTextParts as n,assignTextValuesFromFeature as p,uncapitalize as f}from\"./utils.js\";import m from\"../../views/2d/arcade/callExpressionWithFeature.js\";const y=e=>{if(!e)return[0,0,0,0];const{r,g:i,b:s,a:t}=e;return[r,i,s,255*t]};class v{static findApplicableOverrides(e,r,i){if(e&&r){if(e.primitiveName){let s=!1;for(const r of i)if(r.primitiveName===e.primitiveName){s=!0;break}if(!s)for(const t of r)t.primitiveName===e.primitiveName&&i.push(t)}switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":if(e.effects)for(const s of e.effects)v.findApplicableOverrides(s,r,i);if(e.symbolLayers)for(const s of e.symbolLayers)v.findApplicableOverrides(s,r,i);break;case\"CIMTextSymbol\":break;case\"CIMSolidStroke\":case\"CIMPictureStroke\":case\"CIMGradientStroke\":case\"CIMSolidFill\":case\"CIMPictureFill\":case\"CIMHatchFill\":case\"CIMGradientFill\":case\"CIMVectorMarker\":case\"CIMCharacterMarker\":case\"CIMPictureMarker\":if(e.effects)for(const s of e.effects)v.findApplicableOverrides(s,r,i);if(e.markerPlacement&&v.findApplicableOverrides(e.markerPlacement,r,i),\"CIMVectorMarker\"===e.type){if(e.markerGraphics)for(const s of e.markerGraphics)v.findApplicableOverrides(s,r,i),v.findApplicableOverrides(s.symbol,r,i)}else\"CIMCharacterMarker\"===e.type?v.findApplicableOverrides(e.symbol,r,i):\"CIMHatchFill\"===e.type?v.findApplicableOverrides(e.lineSymbol,r,i):\"CIMPictureMarker\"===e.type&&v.findApplicableOverrides(e.animatedSymbolProperties,r,i)}}}static findEffectOverrides(e,r){if(!e)return null;if(\"CIMGeometricEffectDashes\"===e.type&&o(e),!r||!e.primitiveName)return{type:\"cim-effect-param\",effect:e,overrides:[]};const i=a(e),s=e.primitiveName,t=[];for(const o of r)o.primitiveName===s&&t.push(a(o));return{type:\"cim-effect-param\",effect:i,overrides:c(t)}}static async resolveSymbolOverrides(e,r,t,o,a,c,n){if(!e?.symbol)return null;let{symbol:p,primitiveOverrides:f}=e;const m=!!f;if(!m&&!o)return p;p=i(p),f=i(f);let y=!0;if(r||(r={attributes:{}},y=!1),m){if(y||(f=f.filter((e=>!e.valueExpressionInfo?.expression.includes(\"$feature\")))),n||(f=f.filter((e=>!e.valueExpressionInfo?.expression.includes(\"$view\")))),f.length>0){const e=l(r.attributes),i={spatialReference:t,fields:e,geometryType:a};await v.createRenderExpressions(f,i),v.evaluateOverrides(f,r,a??\"esriGeometryPoint\",c,n,new s(e))}v.applyOverrides(p,f)}return o&&v.applyDictionaryTextOverrides(p,r,o,null),p}static{this._expressionToRenderExpression=new Map}static async createRenderExpressions(e,r){const i=[];for(const s of e){const e=s.valueExpressionInfo;if(!e||v._expressionToRenderExpression.has(e.expression))continue;const o=t(e.expression,r.spatialReference);i.push(o),o.then((r=>v._expressionToRenderExpression.set(e.expression,r)))}i.length>0&&await Promise.all(i)}static evaluateOverrides(e,i,s,t,o,a){const c={$view:{scale:o?.scale}};for(const l of e){l.value&&\"object\"==typeof l.value&&r(l.value)&&(\"Color\"===l.propertyName||\"StrokeColor\"===l.propertyName)&&(l.value=y(l.value));const e=l.valueExpressionInfo;if(!e)continue;const o=v._expressionToRenderExpression.get(e.expression);o&&(l.value=m(o,i,c,s,a,t))}}static applyDictionaryTextOverrides(e,r,i,s,t=\"Normal\"){if(e?.type)switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":case\"CIMTextSymbol\":{const o=e.symbolLayers;if(!o)return;for(const a of o)a&&\"CIMVectorMarker\"===a.type&&v.applyDictionaryTextOverrides(a,r,i,s,\"CIMTextSymbol\"===e.type?e.textCase:t)}break;case\"CIMVectorMarker\":{const t=e.markerGraphics;if(!t)return;for(const e of t)e&&v.applyDictionaryTextOverrides(e,r,i,s)}break;case\"CIMMarkerGraphic\":{const o=e.textString;if(o&&o.includes(\"[\")){const a=n(o,i);e.textString=p(r,a,s,t)}}}}static applyOverrides(e,r,i,s){if(e.primitiveName)for(const t of r)if(t.primitiveName===e.primitiveName){const r=f(t.propertyName);if(s&&s.push({cim:e,nocapPropertyName:r,value:e[r]}),i){let r=!1;for(const s of i)s.primitiveName===e.primitiveName&&(r=!0);r||i.push(t)}null!=t.value&&(e[r]=t.value)}switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":if(e.effects)for(const t of e.effects)v.applyOverrides(t,r,i,s);if(e.symbolLayers)for(const t of e.symbolLayers)v.applyOverrides(t,r,i,s);break;case\"CIMTextSymbol\":break;case\"CIMSolidStroke\":case\"CIMSolidFill\":case\"CIMVectorMarker\":if(e.effects)for(const t of e.effects)v.applyOverrides(t,r,i,s);if(\"CIMVectorMarker\"===e.type&&e.markerGraphics)for(const t of e.markerGraphics)v.applyOverrides(t,r,i,s),v.applyOverrides(t.symbol,r,i,s)}}static restoreOverrides(e){for(const r of e)r.cim[r.nocapPropertyName]=r.value}static buildOverrideKey(e){let r=\"\";for(const i of e)void 0!==i.value&&(r+=`${i.primitiveName}${i.propertyName}${JSON.stringify(i.value)}`);return r}static toValue(r,i){if(\"DashTemplate\"===r)return i.split(\" \").map((e=>Number(e)));if(\"Color\"===r){const r=new e(i).toRgba();return r[3]*=255,r}return i}}export{v as OverrideHelper};\n"],"names":["y","e","r","i","s","t","v","o","a","c","n","p","f","m","l"],"mappings":"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","x_google_ignoreList":[0]}