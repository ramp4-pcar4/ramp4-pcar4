{"version":3,"file":"CIMSymbolRasterizer-CHPajZH1.js","sources":["../../node_modules/@arcgis/core/symbols/cim/CIMSymbolRasterizer.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\n*/\nimport{isPolyline as e,isPolygon as t}from\"../../geometry/support/jsonUtils.js\";import i from\"./CIMResourceManager.js\";import{Transformation as r,CanvasDrawHelper as h}from\"./CIMSymbolDrawHelper.js\";import{CIMSymbolHelper as s}from\"./CIMSymbolHelper.js\";import{OverrideHelper as n}from\"./OverrideHelper.js\";import{scale as a,translate as o}from\"./rasterizingUtils.js\";import{mapCIMSymbolToGeometryType as l}from\"./utils.js\";const m=96/72;class g{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new i}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement(\"canvas\")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(i,r,h,o,m,g,c,d,w,u){if(!i)return null;const{data:p}=i;if(!p||\"CIMSymbolReference\"!==p.type||!p.symbol)return null;const{symbol:f}=p;g||(g=l(f));const x=await n.resolveSymbolOverrides(p,r,this._spatialReference,m,g,c,d),b=this._cimResourceManager,M=[];s.fetchResources(x,b,M),s.fetchFonts(x,b,M),M.length>0&&await Promise.all(M);const{width:C,height:R}=h;let v=y(g,C,R,o,u);const I=s.getEnvelope(x,v,b);if(!I)return null;I.x===1/0&&(I.x=C+2),I.y===1/0&&(I.y=-R/2),I.width===-1/0&&(I.width=C),I.height===-1/0&&(I.height=R);let S=1,_=0,P=0;switch(f.type){case\"CIMPointSymbol\":case\"CIMTextSymbol\":{let e=1;I.width>C&&(e=C/I.width);let t=1;I.height>R&&(t=R/I.height),\"preview\"===o&&(I.width<C&&(e=C/I.width),I.height<R&&(t=R/I.height)),S=Math.min(e,t),_=I.x+I.width/2,P=I.y+I.height/2}break;case\"CIMLineSymbol\":if(u){P=I.y+I.height/2,_=I.x+I.width/2;const e=I.width-C,t=I.height-R;v={paths:a(v.paths,{xmin:-1*I.width/2+e,xmax:I.width/2-e,ymin:-1*I.height/2+t,ymax:I.height/2-t,width:I.width-2*e,height:I.height-2*t})}}else{(w||I.height>R)&&(S=R/I.height),P=I.y+I.height/2;const i=I.x*S+C/2,r=(I.x+I.width)*S+C/2,h=e(v)?v.paths:t(v)?v.rings:null;if(null===h)throw new Error(\"Bad geometry, can't rasterise symbol!\");h[0][0][0]-=i/S,h[0][2][0]-=(r-C)/S}break;case\"CIMPolygonSymbol\":if(u){P=I.y+I.height/2,_=I.x+I.width/2;const e=I.width-C,t=I.height-R;v={paths:a(v.rings,{xmin:-1*I.width/2+e,xmax:I.width/2-e,ymin:-1*I.height/2+t,ymax:I.height/2-t,width:I.width-2*e,height:I.height-2*t})}}else{_=I.x+I.width/2,P=I.y+I.height/2;const e=I.x*S+C/2,t=(I.x+I.width)*S+C/2,i=I.y*S+R/2,r=(I.y+I.height)*S+R/2,{rings:h}=v;e<0&&(h[0][0][0]-=e,h[0][3][0]-=e,h[0][4][0]-=e),i<0&&(h[0][0][1]+=i,h[0][1][1]+=i,h[0][4][1]+=i),t>C&&(h[0][1][0]-=t-C,h[0][2][0]-=t-C),r>R&&(h[0][2][1]+=r-R,h[0][3][1]+=r-R)}}const j={type:\"cim\",data:{type:\"CIMSymbolReference\",symbol:x}};return this.rasterize(j,C,R,_,P,S,g,1,v)}rasterize(e,t,i,s,n,a,o,g=0,c=null,d=window.devicePixelRatio||1){const{data:w}=e;if(!w||\"CIMSymbolReference\"!==w.type||!w.symbol)return null;const{symbol:u}=w,p=this._canvas,f=d*m;p.width=t*f,p.height=i*f,o||(o=l(u)),c||(c=y(o,t,i,\"legend\")),p.width+=2*g,p.height+=2*g;const x=p.getContext(\"2d\",{willReadFrequently:!0}),b=r.createIdentity();b.translate(-s,-n),b.scale(a*f,-a*f),b.translate(t*f/2+g,i*f/2+g),x.clearRect(0,0,p.width,p.height);return new h(x,this._cimResourceManager,b,!0).drawSymbol(u,c),x.getImageData(0,0,p.width,p.height)}}function c(e,t,i,r){if(\"esriGeometryPolygon\"===t){return{rings:o(a(e.rings,{xmin:0,ymin:0,width:i,height:r}),-1*i/2,-1*r/2)}}if(\"esriGeometryPolyline\"===t){return{paths:o(a(e.paths,{xmin:0,ymin:0,width:i,height:r}),-1*i/2,-1*r/2)}}return null}function y(e,t,i,r,h){const s=1,n=-t/2+s,a=t/2-s,o=i/2-s,l=-i/2+s;if(h&&(\"esriGeometryPolygon\"===e||\"esriGeometryPolyline\"===e)){const r=c(h,e,t,i);if(r)return r}switch(e){case\"esriGeometryPoint\":return{x:0,y:0};case\"esriGeometryPolyline\":return{paths:[[[n,0],[0,0],[a,0]]]};default:return\"legend\"===r?{rings:[[[n,o],[a,0],[a,l],[n,l],[n,o]]]}:{rings:[[[n,o],[a,o],[a,l],[n,l],[n,o]]]}}}export{g as CIMSymbolRasterizer};\n"],"names":["m","g","e","i","r","h","o","d","w","u","p","f","l","x","n","b","M","s","C","R","v","y","I","S","P","t","a","j","c"],"mappings":";;;;;;AAIwa,MAAMA,IAAE,KAAG;AAAG,MAAMC,EAAC;AAAA,EAAC,YAAYC,GAAE;AAAC,SAAK,oBAAkBA,GAAE,KAAK,mBAAiB,MAAK,KAAK,sBAAoB,IAAIC;AAAA,EAAC;AAAA,EAAC,IAAI,UAAS;AAAC,WAAO,KAAK,qBAAmB,KAAK,mBAAiB,SAAS,cAAc,QAAQ,IAAG,KAAK;AAAA,EAAgB;AAAA,EAAC,IAAI,kBAAiB;AAAC,WAAO,KAAK;AAAA,EAAmB;AAAA,EAAC,MAAM,wBAAwBA,GAAEC,GAAEC,GAAEC,GAAEN,GAAEC,GAAE,GAAEM,GAAEC,GAAEC,GAAE;AAAC,QAAG,CAACN,EAAE,QAAO;AAAK,UAAK,EAAC,MAAKO,EAAC,IAAEP;AAAE,QAAG,CAACO,KAA0BA,EAAE,SAAzB,wBAA+B,CAACA,EAAE,OAAO,QAAO;AAAK,UAAK,EAAC,QAAOC,EAAC,IAAED;AAAE,IAAAT,MAAIA,IAAEW,EAAED,CAAC;AAAG,UAAME,IAAE,MAAMC,EAAE,uBAAuBJ,GAAEN,GAAE,KAAK,mBAAkBJ,GAAEC,GAAE,GAAEM,CAAC,GAAEQ,IAAE,KAAK,qBAAoBC,IAAE,CAAA;AAAGC,IAAAA,EAAE,eAAeJ,GAAEE,GAAEC,CAAC,GAAEC,EAAE,WAAWJ,GAAEE,GAAEC,CAAC,GAAEA,EAAE,SAAO,KAAG,MAAM,QAAQ,IAAIA,CAAC;AAAE,UAAK,EAAC,OAAME,GAAE,QAAOC,EAAC,IAAEd;AAAE,QAAIe,IAAEC,EAAEpB,GAAEiB,GAAEC,GAAEb,GAAEG,CAAC;AAAE,UAAMa,IAAEL,EAAE,YAAYJ,GAAEO,GAAEL,CAAC;AAAE,QAAG,CAACO,EAAE,QAAO;AAAK,IAAAA,EAAE,MAAI,UAAMA,EAAE,IAAEJ,IAAE,IAAGI,EAAE,MAAI,UAAMA,EAAE,IAAE,CAACH,IAAE,IAAGG,EAAE,UAAQ,WAAOA,EAAE,QAAMJ,IAAGI,EAAE,WAAS,WAAOA,EAAE,SAAOH;AAAG,QAAII,IAAE,GAAE,IAAE,GAAEC,IAAE;AAAE,YAAOb,EAAE,MAAI;AAAA,MAAE,KAAI;AAAA,MAAiB,KAAI;AAAgB;AAAC,cAAIT,IAAE;AAAE,UAAAoB,EAAE,QAAMJ,MAAIhB,IAAEgB,IAAEI,EAAE;AAAO,cAAIG,IAAE;AAAE,UAAAH,EAAE,SAAOH,MAAIM,IAAEN,IAAEG,EAAE,SAAoBhB,MAAZ,cAAgBgB,EAAE,QAAMJ,MAAIhB,IAAEgB,IAAEI,EAAE,QAAOA,EAAE,SAAOH,MAAIM,IAAEN,IAAEG,EAAE,UAASC,IAAE,KAAK,IAAIrB,GAAEuB,CAAC,GAAE,IAAEH,EAAE,IAAEA,EAAE,QAAM,GAAEE,IAAEF,EAAE,IAAEA,EAAE,SAAO;AAAA,QAAC;AAAC;AAAA,MAAM,KAAI;AAAgB,YAAGb,GAAE;AAAC,UAAAe,IAAEF,EAAE,IAAEA,EAAE,SAAO,GAAE,IAAEA,EAAE,IAAEA,EAAE,QAAM;AAAE,gBAAMpB,IAAEoB,EAAE,QAAMJ,GAAEO,IAAEH,EAAE,SAAOH;AAAEC,UAAAA,IAAE,EAAC,OAAMM,EAAEN,EAAE,OAAM,EAAC,MAAK,KAAGE,EAAE,QAAM,IAAEpB,GAAE,MAAKoB,EAAE,QAAM,IAAEpB,GAAE,MAAK,KAAGoB,EAAE,SAAO,IAAEG,GAAE,MAAKH,EAAE,SAAO,IAAEG,GAAE,OAAMH,EAAE,QAAM,IAAEpB,GAAE,QAAOoB,EAAE,SAAO,IAAEG,EAAC,CAAC,EAAC;AAAA,QAAC,OAAK;AAAC,WAACjB,KAAGc,EAAE,SAAOH,OAAKI,IAAEJ,IAAEG,EAAE,SAAQE,IAAEF,EAAE,IAAEA,EAAE,SAAO;AAAE,gBAAM,IAAEA,EAAE,IAAEC,IAAEL,IAAE,GAAE,KAAGI,EAAE,IAAEA,EAAE,SAAOC,IAAEL,IAAE,GAAEb,IAAEH,EAAEkB,CAAC,IAAEA,EAAE,QAAMK,EAAEL,CAAC,IAAEA,EAAE,QAAM;AAAK,cAAUf,MAAP,KAAS,OAAM,IAAI,MAAM,uCAAuC;AAAE,UAAAA,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAG,IAAEkB,GAAElB,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,MAAI,IAAEa,KAAGK;AAAA,QAAC;AAAC;AAAA,MAAM,KAAI;AAAmB,YAAGd,GAAE;AAAC,UAAAe,IAAEF,EAAE,IAAEA,EAAE,SAAO,GAAE,IAAEA,EAAE,IAAEA,EAAE,QAAM;AAAE,gBAAMpB,IAAEoB,EAAE,QAAMJ,GAAEO,IAAEH,EAAE,SAAOH;AAAEC,UAAAA,IAAE,EAAC,OAAMM,EAAEN,EAAE,OAAM,EAAC,MAAK,KAAGE,EAAE,QAAM,IAAEpB,GAAE,MAAKoB,EAAE,QAAM,IAAEpB,GAAE,MAAK,KAAGoB,EAAE,SAAO,IAAEG,GAAE,MAAKH,EAAE,SAAO,IAAEG,GAAE,OAAMH,EAAE,QAAM,IAAEpB,GAAE,QAAOoB,EAAE,SAAO,IAAEG,EAAC,CAAC,EAAC;AAAA,QAAC,OAAK;AAAC,cAAEH,EAAE,IAAEA,EAAE,QAAM,GAAEE,IAAEF,EAAE,IAAEA,EAAE,SAAO;AAAE,gBAAMpB,IAAEoB,EAAE,IAAEC,IAAEL,IAAE,GAAEO,KAAGH,EAAE,IAAEA,EAAE,SAAOC,IAAEL,IAAE,GAAEf,IAAEmB,EAAE,IAAEC,IAAEJ,IAAE,GAAEf,KAAGkB,EAAE,IAAEA,EAAE,UAAQC,IAAEJ,IAAE,GAAE,EAAC,OAAMd,EAAC,IAAEe;AAAE,UAAAlB,IAAE,MAAIG,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGH,GAAEG,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGH,GAAEG,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGH,IAAGC,IAAE,MAAIE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGF,GAAEE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGF,GAAEE,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGF,IAAGsB,IAAEP,MAAIb,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGoB,IAAEP,GAAEb,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGoB,IAAEP,IAAGd,IAAEe,MAAId,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGD,IAAEe,GAAEd,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,KAAGD,IAAEe;AAAA,QAAE;AAAA,IAAC;AAAC,UAAMQ,IAAE,EAAC,MAAK,OAAM,MAAK,EAAC,MAAK,sBAAqB,QAAOd,EAAC,EAAC;AAAE,WAAO,KAAK,UAAUc,GAAET,GAAEC,GAAE,GAAEK,GAAED,GAAEtB,GAAE,GAAEmB,CAAC;AAAA,EAAC;AAAA,EAAC,UAAUlB,GAAEuB,GAAEtB,GAAEc,GAAEH,GAAEY,GAAEpB,GAAEL,IAAE,GAAE2B,IAAE,MAAKrB,IAAE,OAAO,oBAAkB,GAAE;AAAC,UAAK,EAAC,MAAK,EAAC,IAAEL;AAAE,QAAG,CAAC,KAA0B,EAAE,SAAzB,wBAA+B,CAAC,EAAE,OAAO,QAAO;AAAK,UAAK,EAAC,QAAOO,EAAC,IAAE,GAAEC,IAAE,KAAK,SAAQC,IAAEJ,IAAEP;AAAE,IAAAU,EAAE,QAAMe,IAAEd,GAAED,EAAE,SAAOP,IAAEQ,GAAEL,MAAIA,IAAEM,EAAEH,CAAC,IAAGmB,MAAIA,IAAEP,EAAEf,GAAEmB,GAAEtB,GAAE,QAAQ,IAAGO,EAAE,SAAO,IAAET,GAAES,EAAE,UAAQ,IAAET;AAAE,UAAMY,IAAEH,EAAE,WAAW,MAAK,EAAC,oBAAmB,GAAE,CAAC,GAAEK,IAAEX,EAAE,eAAc;AAAG,WAAAW,EAAE,UAAU,CAACE,GAAE,CAACH,CAAC,GAAEC,EAAE,MAAMW,IAAEf,GAAE,CAACe,IAAEf,CAAC,GAAEI,EAAE,UAAUU,IAAEd,IAAE,IAAEV,GAAEE,IAAEQ,IAAE,IAAEV,CAAC,GAAEY,EAAE,UAAU,GAAE,GAAEH,EAAE,OAAMA,EAAE,MAAM,GAAS,IAAIL,EAAEQ,GAAE,KAAK,qBAAoBE,GAAE,EAAE,EAAE,WAAWN,GAAEmB,CAAC,GAAEf,EAAE,aAAa,GAAE,GAAEH,EAAE,OAAMA,EAAE,MAAM;AAAA,EAAC;AAAC;AAAC,SAASkB,EAAE1B,GAAEuB,GAAEtB,GAAEC,GAAE;AAAC,SAA2BqB,MAAxB,wBAAiC,EAAC,OAAMnB,EAAEoB,EAAExB,EAAE,OAAM,EAAC,MAAK,GAAE,MAAK,GAAE,OAAMC,GAAE,QAAOC,EAAC,CAAC,GAAE,KAAGD,IAAE,GAAE,KAAGC,IAAE,CAAC,EAAC,IAA8BqB,MAAzB,yBAAkC,EAAC,OAAMnB,EAAEoB,EAAExB,EAAE,OAAM,EAAC,MAAK,GAAE,MAAK,GAAE,OAAMC,GAAE,QAAOC,EAAC,CAAC,GAAE,KAAGD,IAAE,GAAE,KAAGC,IAAE,CAAC,EAAC,IAAS;AAAI;AAAC,SAASiB,EAAEnB,GAAEuB,GAAEtB,GAAEC,GAAEC,GAAE;AAAC,QAAUS,IAAE,CAACW,IAAE,IAAE,GAAEC,IAAED,IAAE,IAAE,GAAEnB,IAAEH,IAAE,IAAE,GAAES,IAAE,CAACT,IAAE,IAAE;AAAE,MAAGE,MAA4BH,MAAxB,yBAAoDA,MAAzB,yBAA4B;AAAC,UAAME,IAAEwB,EAAEvB,GAAEH,GAAEuB,GAAEtB,CAAC;AAAE,QAAGC,EAAE,QAAOA;AAAA,EAAC;AAAC,UAAOF,GAAC;AAAA,IAAE,KAAI;AAAoB,aAAM,EAAC,GAAE,GAAE,GAAE,EAAC;AAAA,IAAE,KAAI;AAAuB,aAAM,EAAC,OAAM,CAAC,CAAC,CAACY,GAAE,CAAC,GAAE,CAAC,GAAE,CAAC,GAAE,CAACY,GAAE,CAAC,CAAC,CAAC,EAAC;AAAA,IAAE;AAAQ,aAAiBtB,MAAX,WAAa,EAAC,OAAM,CAAC,CAAC,CAACU,GAAER,CAAC,GAAE,CAACoB,GAAE,CAAC,GAAE,CAACA,GAAEd,CAAC,GAAE,CAACE,GAAEF,CAAC,GAAE,CAACE,GAAER,CAAC,CAAC,CAAC,EAAC,IAAE,EAAC,OAAM,CAAC,CAAC,CAACQ,GAAER,CAAC,GAAE,CAACoB,GAAEpB,CAAC,GAAE,CAACoB,GAAEd,CAAC,GAAE,CAACE,GAAEF,CAAC,GAAE,CAACE,GAAER,CAAC,CAAC,CAAC,EAAC;AAAA,EAAC;AAAC;","x_google_ignoreList":[0]}