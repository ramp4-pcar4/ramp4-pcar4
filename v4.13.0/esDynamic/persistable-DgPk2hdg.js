import{b2 as I,b3 as j,b4 as N,b5 as h,b6 as P,b7 as x,b8 as R,b9 as A,ba as b,bb as S,bc as $,s as O,bd as F,be as q,bf as J}from"./main-BFDurRCu.js";import{x as K}from"./MD5-CXHDUqXT.js";import{i as z}from"./multiOriginJSONSupportUtils-DGETddQl.js";import{n as C}from"./uuid-Dj9mdEVg.js";import{p as y}from"./resourceExtension-DCCj0Izs.js";function k(t){const r=t?.origins??[void 0];return(s,n)=>{const e=B(t,s,n);for(const c of r){const i=I(s,c,n);for(const o in e)i[o]=e[o]}}}function B(t,r,s){if(t?.type==="resource")return M(t,r,s);switch(t?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:n,write:e}=j;return{read:n,write:e}}}}function M(t,r,s){const n=N(r,s);return{type:String,read:(e,c,i)=>{const o=S(e,c,i);return n.type===String?o:typeof n.type=="function"?new n.type({url:o}):void 0},write:{isRequired:n.json?.write?.isRequired,writer(e,c,i,o){if(!o?.resources)return typeof e=="string"?void(c[i]=h(e,o)):void(c[i]=e.write({},o));const a=Y(e),p=h(a,{...o,verifyItemRelativeUrls:o?.verifyItemRelativeUrls?{writtenUrls:o.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},P.NO),l=n.type!==String&&(!z(this)||o?.origin&&this.originIdOf(s)>x(o.origin)),u={object:this,propertyName:s,value:e,targetUrl:p,dest:c,targetPropertyName:i,context:o,params:t};o?.portalItem&&p&&!R(p)?l&&t?.contentAddressed?g(u):l?V(u):W(u):o?.portalItem&&(p==null||A(p)!=null||b(p)||l)?g(u):c[i]=p}}}}function g(t){const{targetUrl:r,params:s,value:n,context:e,dest:c,targetPropertyName:i}=t;if(!e.portalItem)return;const o=$(r),a=w(n,r,e);if(s?.contentAddressed&&a.type!=="json")return void e.messages?.push(new O("persistable:contentAddressingUnsupported",`Property "${i}" is trying to serializing a resource with content of type ${a.type} with content addressing. Content addressing is only supported for json resources.`,{content:a}));const p=s?.contentAddressed&&a.type==="json"?K(a.jsonString):o?.filename??C(),l=F(s?.prefix??o?.prefix,p),u=`${l}.${y(a)}`;if(s?.contentAddressed&&e.resources&&a.type==="json"){const f=e.resources.toKeep.find(({resource:m})=>m.path===u)??e.resources.toAdd.find(({resource:m})=>m.path===u);if(f)return void(c[i]=f.resource.itemRelativeUrl)}const d=e.portalItem.resourceFromPath(u);b(r)&&e.resources&&e.resources.pendingOperations.push(q(r).then(f=>{d.path=`${l}.${y({type:"blob",blob:f})}`,c[i]=d.itemRelativeUrl}).catch(()=>{}));const U=s?.compress??!1;e.resources&&v({...t,resource:d,content:a,compress:U,updates:e.resources.toAdd}),c[i]=d.itemRelativeUrl}function V(t){const{context:r,targetUrl:s,params:n,value:e,dest:c,targetPropertyName:i}=t;if(!r.portalItem)return;const o=r.portalItem.resourceFromPath(s),a=w(e,s,r),p=y(a),l=J(o.path),u=n?.compress??!1;p===l?(r.resources&&v({...t,resource:o,content:a,compress:u,updates:r.resources.toUpdate}),c[i]=s):g(t)}function W({context:t,targetUrl:r,dest:s,targetPropertyName:n}){t.portalItem&&t.resources&&(t.resources.toKeep.push({resource:t.portalItem.resourceFromPath(r),compress:!1}),s[n]=r)}function v({object:t,propertyName:r,updates:s,resource:n,content:e,compress:c}){const i=o=>{Z(t,r,o)};s.push({resource:n,content:e,compress:c,finish:i})}function w(t,r,s){return typeof t=="string"?{type:"url",url:r}:{type:"json",jsonString:JSON.stringify(t.toJSON(s))}}function Y(t){return t==null?null:typeof t=="string"?t:t.url}function Z(t,r,s){typeof t[r]=="string"?t[r]=s.url:t[r].url=s.url}export{k as v};
