{"version":3,"file":"ArcadeExpression-XjY3x7KV.js","sources":["../../node_modules/@arcgis/core/support/ArcadeExpression.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\n*/\nimport{ArcadeDate as e}from\"../arcade/ArcadeDate.js\";import t from\"../core/Error.js\";import\"../core/has.js\";import{DateOnly as r}from\"../core/sql/DateOnly.js\";import{TimeOnly as i}from\"../core/sql/TimeOnly.js\";import{fromJSON as n}from\"../geometry/support/jsonUtils.js\";import s from\"../layers/support/FieldsIndex.js\";import{loadArcade as a}from\"./loadArcade.js\";import{unknown as o,system as c}from\"../time/constants.js\";const l=[\"geometry\",\"scale\",\"timeProperties\"];function d(e,t){if(null!=t)for(const r of l)t.hasArcadeDependency(r)&&e.add(r);return e}function u(e,t){return p.create(e,t,null,[\"$feature\",\"$view\"])}function h(e,t){return p.create(e,t,null,[\"$feature\",\"$view\"])}function m(e,t,r){return p.create(e,t,r,[\"$feature\",\"$view\",\"$config\"])}class p{static async create(e,r,i,n){const{arcade:s,Dictionary:o}=await a();let c;try{c=s.parseScript(e)}catch(f){throw new t(\"arcade-bad-expression\",\"Failed to parse arcade script\",{script:e,error:f})}const l=s.scriptUsesGeometryEngine(c);l&&await s.enableGeometrySupport(),await s.loadDependentModules(new Set,c,null,!1,l);const d={vars:n.reduce(((e,t)=>({...e,[t]:null})),{}),spatialReference:r,useAsync:!1},u=s.compileScript(c,d);let h=null;null!=i&&(h=new o(i),h.immutable=!0);const m=new o;return m.immutable=!1,m.setField(\"scale\",0),new p(e,s,c,u,r,m,h,o)}constructor(e,t,r,i,n,s,a,o){this.script=e,this._arcade=t,this._syntaxTree=r,this._compiled=i,this._spatialReference=n,this._viewDict=s,this._configDict=a,this._dictionaryCtor=o,this._dependencies=new Map,this._featureReader=new f,this._dependencies.set(\"geometry\",t.scriptTouchesGeometry(this._syntaxTree)),this._dependencies.set(\"scale\",this._arcade.referencesMember(this._syntaxTree,\"scale\")),this._dependencies.set(\"timeProperties\",this._arcade.scriptUsesViewProperties(this._syntaxTree,[\"timeProperties\"]))}evaluate(t,r){const i=r.$view?.timeZone;if(r.$view){let t;if(this._viewDict.setField(\"scale\",r.$view.scale),null!=r.$view.timeProperties){const{currentStart:n,currentEnd:s}=r.$view.timeProperties;t=new this._dictionaryCtor({currentStart:null!=n?null!=i?e.epochToArcadeDate(n,i):e.unknownEpochToArcadeDate(n):void 0,currentEnd:null!=s?null!=i?e.epochToArcadeDate(s,i):e.unknownEpochToArcadeDate(s):void 0,startIncluded:!0,endIncluded:!0})}this._viewDict.setField(\"timeProperties\",t)}return this._compiled({vars:{$view:this._viewDict,$config:this._configDict,$feature:t},spatialReference:this._spatialReference,timeZone:i})}repurposeFeature(e,t){return this._featureReader.bind(e,t,this._spatialReference),this._featureReader}references(e){return this._dependencies.get(e)??!1}}class f{constructor(){this._boundTarget=null,this._boundSchema={fields:null,fieldsIndex:null,spatialReference:null,get geometryType(){return null},get objectIdField(){return null}},this.arcadeDeclaredClass=\"esri.arcade.Feature\",this._contextTimeZone=null}bind(e,t,r){const i=t??new s(_(e.attributes));this._boundTarget=e,this._boundSchema.fields=i.fields,this._boundSchema.fieldsIndex=i,this._boundSchema.spatialReference=r}_getField(e){return this._boundSchema.fieldsIndex.get(e)}get contextTimeZone(){return this._contextTimeZone}set contextTimeZone(e){this._contextTimeZone=e}readArcadeFeature(){return this}hasField(e){return this._boundSchema.fieldsIndex.has(e)}geometry(){if(\"fromJSON\"in this._boundTarget)return this._boundTarget.geometry;const e=n(this._boundTarget.geometry);if(e){if(!this._boundSchema.spatialReference)throw new Error(\"InternalError: Expected spatial reference to be defined\");e.spatialReference=this._boundSchema.spatialReference}return e}isUnknownDateTimeField(e){return this._boundSchema.fieldsIndex.getTimeZone(e)===o}field(t,n=!0){const s=this._getField(t);if(s){const n=this._boundTarget.attributes[s.name];if(null==n)return null;switch(s.type){case\"date-only\":case\"esriFieldTypeDateOnly\":return r.fromReader(n);case\"time-only\":case\"esriFieldTypeTimeOnly\":return i.fromReader(n);case\"esriFieldTypeTimestampOffset\":case\"timestamp-offset\":return e.fromReaderAsTimeStampOffset(n);case\"date\":case\"esriFieldTypeDate\":return this.isUnknownDateTimeField(t)?e.unknownEpochToArcadeDate(n):e.epochToArcadeDate(n,this.contextTimeZone??c);default:return n}}if(n)throw new Error(`Field ${t} does not exist`);return null}setField(e,t){throw new Error(\"Unable to update feature attribute values, feature is readonly\")}keys(){return this._boundSchema.fieldsIndex.fields.map((e=>e.name))}castToText(e=!1){return JSON.stringify(this._boundTarget)}gdbVersion(){return null}fullSchema(){return this._boundSchema}castAsJson(e=null){return{attributes:this._boundTarget.attributes,geometry:!0===e?.keepGeometryType?this.geometry():this.geometry()?.toJSON()??null}}castAsJsonAsync(e=null,t=null){return Promise.resolve(this.castAsJson(t))}}function _(e){const t=[];for(const r in e)t.push({name:r,alias:r,type:\"string\"==typeof e[r]?\"esriFieldTypeString\":\"esriFieldTypeDouble\"});return t}export{p as ArcadeExpression,f as ArcadeFeatureReader,d as collectExpressionDependencies,m as createDictionaryExpression,u as createLabelExpression,h as createRendererExpression,_ as deriveFields};\n"],"names":["l","d","e","t","r","h","p","m","n","o","a","c","u","i","s","f","_"],"mappings":"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","x_google_ignoreList":[0]}