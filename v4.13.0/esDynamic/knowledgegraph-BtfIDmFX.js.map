{"version":3,"file":"knowledgegraph-BtfIDmFX.js","sources":["../../node_modules/@arcgis/core/arcade/functions/knowledgegraph.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.33/esri/copyright.txt for details.\n*/\nimport e from\"../../config.js\";import r from\"../ArcadePortal.js\";import t from\"../Dictionary.js\";import{ArcadeExecutionError as n,ExecutionErrorCodes as o}from\"../executionError.js\";import{B as a,w as i,o as s,J as p,K as l,e as c,f,g as u,n as m,h as d}from\"../../chunks/languageUtils.js\";import{getPortal as h}from\"../portalUtils.js\";import g from\"../../geometry/Geometry.js\";import{load as w,project as y,isLoaded as j}from\"../../geometry/projectionUtils.js\";import S from\"../../geometry/SpatialReference.js\";import{webMercatorToGeographic as v,geographicToWebMercator as R}from\"../../geometry/support/webMercatorUtils.js\";import G from\"../../portal/Portal.js\";import x from\"../../portal/PortalItem.js\";import{project as k}from\"../../rest/geometryService/project.js\";import P from\"../../rest/knowledgeGraph/Entity.js\";import b from\"../../rest/knowledgeGraph/GraphQueryStreaming.js\";import I from\"../../rest/knowledgeGraph/ObjectValue.js\";import W from\"../../rest/knowledgeGraph/Path.js\";import D from\"../../rest/knowledgeGraph/Relationship.js\";import T from\"../../rest/support/ProjectParameters.js\";import{isString as U,isArray as q,isNumber as A,isDate as J}from\"../../support/guards.js\";let N=null;async function F(r){const t=e.geometryServiceUrl??\"\";if(!t){j()||await w();for(const e of r)e.container[e.indexer]=y(e.container[e.indexer],S.WGS84);return}const n=r.map((e=>e.container[e.indexer])),o=new T({geometries:n,outSpatialReference:S.WGS84}),a=await k(t,o);for(let e=0;e<a.length;e++){const t=r[e];t.container[t.indexer]=a[e]}}async function M(e,r){const t=new x({portal:e,id:r});return await t.load(),null===N&&(N=await import(\"../../rest/knowledgeGraphService.js\")),await N.fetchKnowledgeGraph(t.url)}function Q(e,r,t,n,o){if(null===e)return null;if(U(e)||A(e))return e;if(c(e))return e.toJSDate();if(c(e))return e.toJSDate();if(f(e))return e.toStorageFormat();if(u(e))return e.toStorageString();if(m(e)){const a={};for(const i of e.keys())a[i]=Q(e.field(i),r,t,n,o),a[i]instanceof g&&o.push({container:a,indexer:i});return a}if(q(e)){const a=e.map((e=>Q(e,r,t,n,o)));for(let e=0;e<a.length;e++)a[e]instanceof g&&o.push({container:a,indexer:e});return a}return d(e)?e.spatialReference.isWGS84?e:e.spatialReference.isWebMercator&&r?v(e):e:void 0}function B(e,r){if(!e)return e;if(e.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return R(e);if(e.spatialReference.equals(r.spatialReference))return e;throw new n(r,o.WrongSpatialReference,null)}function E(e,r){if(!e)return null;const t={};for(const n in e)t[n]=K(e[n],r);return t}function K(e,r){return null===e?null:q(e)?e.map((e=>K(e,r))):e instanceof P?{graphTypeName:e.typeName,id:e.id,graphType:\"entity\",properties:E(e.properties,r)}:e instanceof I?{graphType:\"object\",properties:E(e.properties,r)}:e instanceof D?{graphTypeName:e.typeName,id:e.id,graphType:\"relationship\",originId:e.originId??null,destinationId:e.destinationId??null,properties:E(e.properties,r)}:e instanceof W?{graphType:\"path\",path:e.path?e.path.map((e=>K(e,r))):null}:d(e)?B(e,r):U(e)||A(e)||J(e)?e:null}function V(e){\"async\"===e.mode&&(e.functions.knowledgegraphbyportalitem=function(t,s){return e.standardFunctionAsync(t,s,((e,p,l)=>{if(a(l,2,2,t,s),null===l[0])throw new n(t,o.PortalRequired,s);if(l[0]instanceof r){const e=i(l[1]);let r;r=t.services?.portal?t.services.portal:G.getDefault();return M(h(l[0],r),e)}if(!1===U(l[0]))throw new n(t,o.InvalidParameter,s);const c=i(l[0]);return M(t.services?.portal??G.getDefault(),c)}))},e.signatures.push({name:\"knowledgegraphbyportalitem\",min:2,max:2}),e.functions.querygraph=function(r,i){return e.standardFunctionAsync(r,i,(async(e,c,f)=>{a(f,2,4,r,i);const u=f[0];if(!s(u))throw new n(r,o.InvalidParameter,i);const m=f[1];if(!U(m))throw new n(r,o.InvalidParameter,i);null===N&&(N=await import(\"../../rest/knowledgeGraphService.js\"));let d=null;const h=p(f[2],null);if(!(h instanceof t||null===h))throw new n(r,o.InvalidParameter,i);if(h){let e=[];d=Q(h,!0,!1,r,e),e=e.filter((e=>!e.container[e.indexer].spatialReference.isWGS84)),e.length>0&&await F(e)}const g=p(f[3],!1),w=new b({openCypherQuery:m,bindParameters:d,provenanceBehavior:g?\"include\":\"exclude\"});(u?.serviceDefinition?.currentVersion??11.3)>11.2&&(w.outputSpatialReference=r.spatialReference);const y=(await N.executeQueryStreaming(u,w)).resultRowsStream.getReader(),j=[];try{for(;;){const{done:e,value:t}=await y.read();if(e)break;if(q(t))for(const n of t)j.push(K(n,r));else{const e=[];for(const n of t)e.push(K(t[n],r));j.push(e)}}}catch(S){throw S}return t.convertJsonToArcade(j,l(r),!1,!0)}))},e.signatures.push({name:\"querygraph\",min:2,max:4}))}export{V as registerFunctions};\n"],"names":["N","F","r","t","e","j","w","y","S","n","o","T","a","k","M","x","Q","U","A","c","f","u","m","i","g","q","d","v","B","R","E","K","P","I","D","W","J","V","s","p","l","G","h","b"],"mappings":"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","x_google_ignoreList":[0]}