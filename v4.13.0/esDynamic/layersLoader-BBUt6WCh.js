import{s as y,cl as m,K as F,cm as H,cq as M,Z as P}from"./main-BFDurRCu.js";import{t as w,n as G}from"./fetchService-IPSkq0MP.js";import{o as k,u as x,s as f,l as D,y as A,c as h,e as g,i as C,a as I}from"./loadUtils-B4p6zboh.js";import{e as b}from"./jsonContext-C9WBVzLb.js";import{s as E}from"./portalItemUtils-BfWDJg-S.js";import{t as O}from"./styleUtils-BnJpZ0Gl.js";async function R(t,o){const r=t.instance.portalItem;if(r?.id)return await r.load(o),j(t),t.validateItem&&t.validateItem(r),J(t,o)}function j(t){const o=t.instance.portalItem;if(!o?.type||!t.supportedTypes.includes(o.type))throw new y("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:o?.type,expectedType:t.supportedTypes.join(", ")})}async function J(t,o){const r=t.instance,e=r.portalItem;if(!e)return;let{url:n}=e;const{title:a}=e,l=b(e,"portal-item");if(r.type==="group")return N(r,l,t);n&&r.type!=="media"&&r.read({url:n},l);const i=new g,{data:c,preferredHost:s}=await L(t,i,o);return n=e.url,"isUrlHostModified"in r&&(s?r.applyPreferredHost({preferredHost:s}):r.applyHostFromPortalItem()),c&&r.read(c,l),r.resourceReferences={portalItem:e,paths:l.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:a},l),O(r,l)}async function N(t,o,r){const e=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:a}=e;if(a==="Group Layer"){if(!E(e,"Map"))throw new y("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return V(t,r)}return t.read({title:n},o),$(t,r)}async function V(t,o){const r=t.portalItem,e=await r.fetchData("json");if(!e)return;if(!o.populateGroupLayer)throw new y("portal:missing-populate-group-layer","Missing populate group layer");const n=b(r,"web-map");t.read(e,n),await o.populateGroupLayer(t,e,{context:n}),t.resourceReferences={portalItem:r,paths:n.readResourcePaths??[]}}async function $(t,o){let r;const{portalItem:e}=t;if(!e)return;const n=e.type,a=o.layerModuleTypeMap;if(!a)throw new y("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(n){case"Feature Service":case"Feature Collection":r=a.FeatureLayer;break;case"Stream Service":r=a.StreamLayer;break;case"Scene Service":r=a.SceneLayer;break;case"Video Service":r=a.VideoLayer;break;default:throw new y("portal:unsupported-item-type-as-group",`The item type '${n}' is not supported as a 'IGroupLayer'`)}const l=n==="Video Service",i=new g;let[c,{data:s}]=await Promise.all([r(),l?{data:null}:L(o,i)]),u=()=>c;if(l)return K(t,u,a);if(n==="Feature Service"){const p=f(s)?.customParameters;s=e.url?(await D(s,e.url,i)).data:{},u=await W(s,a)||u;const{provider:S,preferredHost:T}=await Q(e.url,{customParameters:p,loadContext:i});return m(e,T),await d(t,u,u,s,a,S)}return n==="Scene Service"&&e.url&&(s=await A(e,s,i)),h(s)>0?await d(t,u,null,s,a):await q(t,u,a)}async function q(t,o,r){const{portalItem:e}=t;if(!e?.url)return;const n=await w(e.url);n&&d(t,o,null,{layers:n.layers?.map(I),tables:n.tables?.map(I)},r)}async function K(t,o,r){const{portalItem:e}=t;if(!e?.url)return;const n=await w(e.url);n&&d(t,o,null,{layers:n.layers?.map(({id:a,name:l})=>({id:a,name:l}))},r)}async function d(t,o,r,e,n,a){let l=e.layers||[];const i=e.tables||[];if(t.portalItem?.type==="Feature Collection"?(l.forEach((c,s)=>{c.id=s,c?.layerDefinition?.type==="Table"&&i.push(c)}),l=l.filter(c=>c?.layerDefinition?.type!=="Table")):(l.reverse(),i.reverse()),l.forEach(c=>{const s=a?.(c);if(s||!a){const u=v(t,o(c),e,c,s);t.add(u)}}),i.length){const c=r?null:await n.FeatureLayer();i.forEach(s=>{const u=a?.(s);if(u||!a){const p=v(t,r?r(s):c,e,s,u);t.tables.add(p)}})}}function v(t,o,r,e,n){const a=t.portalItem,l={portalItem:a.clone(),layerId:e.id};e.url!=null&&(l.url=e.url);const i=new o(l);if("sourceJSON"in i&&(i.sourceJSON=n),i.type!=="subtype-group"&&i.type!=="catalog"&&(i.sublayerTitleMode="service-name"),a.type==="Feature Collection"){const c={origin:"portal-item",portal:a.portal||P.getDefault()};i.read(e,c);const s=r.showLegend;s!=null&&i.read({showLegend:s},c)}return i}async function L(t,o,r){if(t.supportsData===!1)return{data:void 0};const e=t.instance,n=e.portalItem;if(!n)return{data:void 0};let a=null;try{a=await n.fetchData("json",r)}catch{}if(z(e)){let l=null;const{count:i,preferredHost:c}=await U(n,a,o);if(m(n,c),(a?.layers||a?.tables)&&i>0){if(e.layerId==null){const s=k(e.type),u=s?.length?x(a,s)[0]:f(a);u&&(e.layerId=u.id)}l=Z(a,e),l?.layerType==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),l&&a.showLegend!=null&&(l.showLegend=a.showLegend)}return i>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),{data:l,preferredHost:c}}return{data:a}}async function U(t,o,r){if(o?.layers&&o?.tables)return{count:h(o)};const e=F(t.url);if(!e)return{count:1};const n=e.url.path,a=await r.fetchServiceMetadata(n,{customParameters:f(o)?.customParameters}).catch(()=>null);return{count:(o?.layers?.length??a?.layers?.length??0)+(o?.tables?.length??a?.tables?.length??0),preferredHost:M(t)?H():null}}function Z(t,o){const{layerId:r}=o,e=t.layers?.find(n=>n.id===r)||t.tables?.find(n=>n.id===r);return e&&B(e,o)?e:null}function z(t){return t.type!=="stream"&&"layerId"in t}function B(t,o){const r="layerType"in t&&t.layerType,{type:e}=o;return!(e==="feature"&&r&&t.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!r||e==="oriented-imagery"&&!r||e==="subtype-group"&&!r)}async function Q(t,o){const{layersJSON:r,preferredHost:e}=await G(t,o);if(!r)return{provider:null,preferredHost:e};const n=[...r.layers,...r.tables];return{provider:a=>n.find(l=>l.id===a.id),preferredHost:e}}async function W(t,o){const{layers:r,tables:e}=t,n=[...r??[],...e??[]];if(!n.length)return;const a=new Set,l=[];for(const{layerType:s}of n){const u=s??"ArcGISFeatureLayer";if(a.has(u))continue;a.add(u);const p=o[C(u)];l.push(p())}const i=await Promise.all(l),c=new Map;return Array.from(a).forEach((s,u)=>{c.set(s,i[u])}),({layerType:s})=>{const u=s??"ArcGISFeatureLayer";return c.get(u)}}export{R as load};
