import{aw as le,v as F,x as D,z as te,I as Te,H as Ee,al as Re,B as de,a0 as Me,iX as Oe,i as Ge,ak as Ve,dX as L,dW as C,Z as ve,S as ze,iY as Je,bv as He}from"./main-BFDurRCu.js";import{h as We}from"./TimeOnly-CGkId3bj.js";import{t as Be,D as _e,l as ue}from"./arcade-BoHTeCSG.js";import{a as k,A as qe,z as ce,K as j,j as M,p as x,S as Ke,i as De,y as ke,X as xe,q as Z,T as q,$ as ne,b as H,G as Qe,N as K,V as Xe,Z as ie}from"./aiServices-u5nRiq9H.js";import{a as p,r as y,e as Ye,o as et}from"./enum-g1DWyQyu.js";import{R as tt,q as Se,p as nt,c as fe,e as it,a as ot,b as at,N as oe,j as rt,F as st,E as lt,L as W,B as dt,d as ae,f as $,k as me}from"./featureSetUtils--lhp90Mu.js";import{t as ut}from"./ImmutableArray-CiJxhY8_.js";import{l as ct}from"./portalUtils-COohlq76.js";import{u as ft,O as Ae}from"./SpatialFilter-B44tswGH.js";import{x as Ce,s as pe}from"./shared-DttuBH5Z.js";import{R as v}from"./WhereClause-D4rZJkVN.js";import je from"./FeatureLayer-D09djTpa.js";import{m as P}from"./Field-BIQ-quF4.js";import{f as mt,u as pt,s as yt}from"./utils-BO8hgPs3.js";import{s as B}from"./NetworkElement-DPZIJwbn.js";var Ue;(function(n){n[n.RTJunctionJunctionConnectivity=1]="RTJunctionJunctionConnectivity",n[n.RTContainment=2]="RTContainment",n[n.RTAttachment=3]="RTAttachment",n[n.RTJunctionEdgeConnectivity=4]="RTJunctionEdgeConnectivity",n[n.RTEdgeJunctionEdgeConnectivity=5]="RTEdgeJunctionEdgeConnectivity"})(Ue||(Ue={})),new le({connected:"connected",upstream:"upstream",downstream:"downstream",shortestPath:"shortest-path",subnetwork:"subnetwork",subnetworkController:"subnetwork-controller",loops:"loops",isolation:"isolation",path:"path",circuit:"circuit"});const O=new le({junctionJunctionConnectivity:"junction-junction-connectivity",connectivity:"connectivity",attachment:"attachment",containment:"containment",junctionEdgeFromConnectivity:"junction-edge-from-connectivity",junctionEdgeMidspanConnectivity:"junction-edge-midspan-connectivity",junctionEdgeToConnectivity:"junction-edge-to-connectivity"});new le({normal:"normal",rebuild:"rebuild",forceRebuild:"force-rebuild"});let _=class extends B{constructor(n){super(n),this.type="telecomNetworkElement",this.firstUnit=null,this.numUnits=null}};F([D({json:{write:!1}})],_.prototype,"type",void 0),F([D({json:{write:!0}})],_.prototype,"firstUnit",void 0),F([D({json:{write:!0}})],_.prototype,"numUnits",void 0),_=F([te("esri.rest.networks.support.TelecomNetworkElement")],_);let A=class extends de{constructor(n){super(n),this.globalId=null,this.associationType=null,this.fromNetworkElement=null,this.toNetworkElement=null,this.geometry=null,this.errorMessage=null,this.percentAlong=null,this.errorCode=null,this.isContentVisible=null,this.status=null}readFromNetworkElement(n,s){return s.fromFirstUnit||s.fromNumUnits?new _({globalId:s.fromGlobalId,networkSourceId:s.fromNetworkSourceId,terminalId:s.fromTerminalId,firstUnit:s.fromFirstUnit,numUnits:s.fromNumUnits}):new B({globalId:s.fromGlobalId,networkSourceId:s.fromNetworkSourceId,terminalId:s.fromTerminalId})}writeFromNetworkElement(n,s){if(n&&(s.fromGlobalId=n.globalId,s.fromNetworkSourceId=n.networkSourceId,s.fromTerminalId=n.terminalId,n.type==="telecomNetworkElement")){const t=n;s.fromFirstUnit=t.firstUnit,s.fromNumUnits=t.numUnits}}readToNetworkElement(n,s){return s.toFirstUnit||s.toNumUnits?new _({globalId:s.toGlobalId,networkSourceId:s.toNetworkSourceId,terminalId:s.toTerminalId,firstUnit:s.toFirstUnit,numUnits:s.toNumUnits}):new B({globalId:s.toGlobalId,networkSourceId:s.toNetworkSourceId,terminalId:s.toTerminalId})}writeToNetworkElement(n,s){if(n&&(s.toGlobalId=n.globalId,s.toNetworkSourceId=n.networkSourceId,s.toTerminalId=n.terminalId,n.type==="telecomNetworkElement")){const t=n;s.toFirstUnit=t.firstUnit,s.toNumUnits=t.numUnits}}};F([D({type:String,json:{write:!0}})],A.prototype,"globalId",void 0),F([D({type:O.apiValues,json:{type:O.jsonValues,read:O.read,write:O.write}})],A.prototype,"associationType",void 0),F([D({type:B,json:{write:{target:{fromGlobalId:{type:String},fromNetworkSourceId:{type:Number},fromTerminalId:{type:Number},fromFirstUnit:{type:Number},fromNumUnits:{type:Number}}},read:{source:["fromGlobalId","fromNetworkSourceId","fromTerminalId","fromFirstUnit","fromNumUnits"]}}})],A.prototype,"fromNetworkElement",void 0),F([Te("fromNetworkElement")],A.prototype,"readFromNetworkElement",null),F([Ee("fromNetworkElement")],A.prototype,"writeFromNetworkElement",null),F([D({type:B,json:{write:{target:{toGlobalId:{type:String},toNetworkSourceId:{type:Number},toTerminalId:{type:Number},toFirstUnit:{type:Number},toNumUnits:{type:Number}}},read:{source:["toGlobalId","toNetworkSourceId","toTerminalId","toFirstUnit","toNumUnits"]}}})],A.prototype,"toNetworkElement",void 0),F([Te("toNetworkElement")],A.prototype,"readToNetworkElement",null),F([Ee("toNetworkElement")],A.prototype,"writeToNetworkElement",null),F([D({type:Re,json:{write:!0}})],A.prototype,"geometry",void 0),F([D({type:String,json:{write:!0}})],A.prototype,"errorMessage",void 0),F([D({type:Number,json:{write:!0}})],A.prototype,"percentAlong",void 0),F([D({type:Number,json:{write:!0}})],A.prototype,"errorCode",void 0),F([D({type:Boolean,json:{write:!0}})],A.prototype,"isContentVisible",void 0),F([D({type:Number,json:{write:!0}})],A.prototype,"status",void 0),A=F([te("esri.rest.networks.support.Association")],A);let re=class extends de{constructor(n){super(n),this.associations=[]}};F([D({type:[A],json:{write:!0}})],re.prototype,"associations",void 0),re=F([te("esri.rest.networks.support.QueryAssociationsResult")],re);function wt(n){const{returnDeletes:s,elements:t,gdbVersion:o,moment:I}=n.toJSON();return{returnDeletes:s,elements:JSON.stringify(t.map(g=>({globalId:g.globalId,networkSourceId:g.networkSourceId,terminalId:g.terminalId}))),types:JSON.stringify(n.types.map(g=>O.toJSON(g))).replaceAll('"connectivity"','"junctionJunctionConnectivity"'),gdbVersion:o,moment:I??Date.now()}}async function It(n,s,t){const o=mt(n),I={...wt(s),f:"json"},g=pt({...o.query,...I}),e=yt(g,{...t,method:"post"}),i=`${o.path}/associations/query`,{data:r}=await Me(i,e),l=re.fromJSON(r);return s.types.includes("connectivity")&&Oe(Ge.getLogger("esri/rest/networks/support/QueryAssociationsParameters"),"types",{replacement:"Please use 'junction-junction-connectivity' instead of 'connectivity'.",see:"https://arcg.is/11Tr8a#types",version:"4.29",warnOnce:!0}),l}var ye;let z=ye=class extends de{static from(n){return Ve(ye,n)}constructor(n){super(n),this.returnDeletes=!1,this.elements=[],this.types=[],this.gdbVersion=null,this.moment=null}};F([D({type:Boolean,json:{write:!0}})],z.prototype,"returnDeletes",void 0),F([D({type:[B],json:{write:!0}})],z.prototype,"elements",void 0),F([D({type:[O.apiValues],json:{type:O.jsonValues,read:O.read,write:O.write}})],z.prototype,"types",void 0),F([D({type:String,json:{write:!0}})],z.prototype,"gdbVersion",void 0),F([D({type:Date,json:{type:Number,write:{writer:(n,s)=>{s.moment=n?.getTime()}}}})],z.prototype,"moment",void 0),z=ye=F([te("esri.rest.networks.support.QueryAssociationsParameters")],z);function gt(n){if(n.length===1){if(C(n[0]))return ue("distinct",n[0],-1);if(H(n[0]))return ue("distinct",n[0].toArray(),-1)}return ue("distinct",n,-1)}function we(n,s,t){const o=n.getVariables();if(o.length>0){const I={};for(const g of o)I[g]=s.evaluateIdentifier(t,{name:g});n.parameters=I}return n}function c(n,s,t=null){for(const o in n)if(o.toLowerCase()===s.toLowerCase())return n[o];return t}function Le(n){if(n===null)return null;const s={type:c(n,"type",""),name:c(n,"name","")};if(s.type==="range")s.range=c(n,"range",[]);else{s.codedValues=[];for(const t of c(n,"codedValues",[]))s.codedValues.push({name:c(t,"name",""),code:c(t,"code",null)})}return s}function Ie(n){if(n===null)return null;const s={},t=c(n,"wkt");t!==null&&(s.wkt=t);const o=c(n,"wkid");return o!==null&&(s.wkid=o),s}function Ze(n){if(n===null)return null;const s={hasZ:c(n,"hasz",!1),hasM:c(n,"hasm",!1)},t=c(n,"spatialreference");t!=null&&(s.spatialReference=Ie(t));const o=c(n,"x",null);if(o!==null)return s.x=o,s.y=c(n,"y",null),s.hasZ&&(s.z=c(n,"z",null)),s.hasM&&(s.m=c(n,"m",null)),s;const I=c(n,"rings",null);if(I!==null)return s.rings=I,s;const g=c(n,"paths",null);if(g!==null)return s.paths=g,s;const e=c(n,"points",null);if(e!==null)return s.points=e,s;for(const i of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const r=c(n,i,null);r!==null&&(s[i]=r)}return s}function ht(n,s){for(const t of s)if(t===n)return!0;return!1}function bt(n){return!!n.layerDefinition&&!!n.featureSet&&ht(n.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&C(n.layerDefinition.fields)!==!1&&C(n.featureSet.features)!==!1}function Q(n){return n?.toLowerCase()==="utc"?"UTC":n?.toLowerCase()==="unknown"?"Unknown":n}async function Ft(n,s,t,o,I,g,e){const i=await n.getFeatureSetInfo();if((i?.layerId??null)===null||!I.layerIdLookup.get(i.layerId))return null;const r=n.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),l=[];switch(t){case"connected":l.push("connectivity"),l.push("junction-edge-from-connectivity"),l.push("junction-edge-to-connectivity"),l.push("junction-edge-midspan-connectivity"),l.push("junction-junction-connectivity");break;case"container":case"content":l.push("containment");break;case"structure":case"attached":l.push("attachment");break;case"junctionedge":l.push("junction-edge-from-connectivity"),l.push("junction-edge-to-connectivity");break;case"midspan":l.push("junction-edge-midspan-connectivity");break;default:throw new p(g,y.InvalidParameter,e)}let w=null,f=!1;if(o!==null&&o!==""&&o!==void 0){for(const u of I.terminals)u.terminalName===o&&(w=u.terminalId);w===null&&(f=!0)}const d=[];if(!f){const u=new B({globalId:s.field(n.globalIdField),networkSourceId:I.layerIdLookup.get(i.layerId).sourceId,...w?{terminalId:w}:""}),m=await It(r,new z({types:l,elements:[u]}));let S=0;for(const h of m.associations){let b=null,E="",R="";if(h.fromNetworkElement?.globalId===u.globalId?(b=h.toNetworkElement,R="to"):h.toNetworkElement?.globalId===u.globalId&&(b=h.fromNetworkElement,R="from"),!b)continue;switch(t){case"attached":if(h.associationType!=="attachment"||R!=="to")continue;break;case"structure":if(h.associationType!=="attachment"||R!=="from")continue;break;case"container":if(h.associationType!=="containment"||R!=="from")continue;break;case"content":if(h.associationType!=="containment"||R!=="to")continue;break;case"connected":break;case"junctionedge":h.associationType==="junction-edge-to-connectivity"?E="to":h.associationType==="junction-edge-from-connectivity"&&(E="from");break;case"midspan":if(h.associationType!=="junction-edge-midspan-connectivity")continue}const X=I.sourceIdLookup.get(b.networkSourceId)?.className??"";d.push(new He({geometry:null,attributes:{objectId:S++,globalId:b.globalId,percentAlong:h.percentAlong??0,isContentVisible:h.isContentVisible?0:1,className:X,side:E}}))}}const a=new je({source:d,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new P({name:"objectId",alias:"objectId",type:"oid"}),new P({name:"globalId",alias:"globalId",type:"global-id"}),new P({name:"percentAlong",alias:"percentAlong",type:"double"}),new P({name:"side",alias:"side",type:"string"}),new P({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new P({name:"className",alias:"className",type:"string"})]});return oe(a)}function Nt(n){if(n.mode==="async"){n.functions.timezone=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,1,2,t,o),qe(e[0])||ce(e[0]))return"Unknown";if(j(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?Q("unknown"):Q(e[0].dateFieldsTimeZone);if(!(e[1]instanceof M)||e[1].hasField("type")===!1)throw new p(t,y.InvalidParameter,o);const l=e[1].field("type");if(L(l)===!1)throw new p(t,y.InvalidParameter,o);switch(x(l).toLowerCase()){case"preferredtimezone":return Q(e[0].preferredTimeZone);case"editfieldsinfo":return Q(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return Q(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&L(e[1].field("fieldname")))return Q(e[0].fieldTimeZone(x(e[1].field("fieldname"))))}throw new p(t,y.InvalidParameter,o)}const i=Ke(e[0],De(t));if(i===null)return null;const r=i.timeZone;return r==="system"?We.systemTimeZoneCanonicalName:r.toLowerCase()==="utc"?"UTC":r.toLowerCase()==="unknown"?"Unknown":r})},n.functions.sqltimestamp=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{k(e,1,3,t,o);const i=e[0];if(ke(i)){if(e.length===1)return i.toSQLWithKeyword();if(e.length===2)return i.changeTimeZone(x(e[1])).toSQLWithKeyword();throw new p(t,y.InvalidParameter,o)}if(ce(i))return i.toSQLWithKeyword();if(j(i)){if(e.length!==3)throw new p(t,y.InvalidParameter,o);await i.load();const r=x(e[1]);if(ce(e[2]))return e[2].toSQLWithKeyword();if(ke(e[2])===!1)throw new p(t,y.InvalidParameter,o);const l=i.fieldTimeZone(r);return l==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(l).toSQLWithKeyword()}throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"sqltimestamp",min:2,max:4}),n.functions.featuresetbyid=function(t,o){return n.standardFunctionAsync(t,o,(I,g,e)=>{if(k(e,2,4,t,o),xe(e[0])){const i=x(e[1]);let r=Z(e[2],null);const l=q(Z(e[3],!0));if(r===null&&(r=["*"]),C(r)===!1)throw new p(t,y.InvalidParameter,o);return e[0].featureSetById(i,l,r)}throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"featuresetbyid",min:2,max:4});const s=new Ye(["datasource","parent","root"]);n.functions.getfeatureset=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,1,2,t,o),ne(e[0])){const i=e[1]==null?"datasource":s.lookup(x(e[1]));return tt(e[0].fullSchema(),i,t.lrucache,t.interceptor,t.spatialReference)}throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"getfeatureset",min:1,max:2}),n.functions.featuresetbyportalitem=function(t,o){return n.standardFunctionAsync(t,o,(I,g,e)=>{if(k(e,2,5,t,o),e[0]===null)throw new p(t,y.PortalRequired,o);if(e[0]instanceof Be){const f=x(e[1]),d=x(e[2]);let a=Z(e[3],null);const u=q(Z(e[4],!0));if(a===null&&(a=["*"]),C(a)===!1)throw new p(t,y.InvalidParameter,o);let m;return m=t.services?.portal?t.services.portal:ve.getDefault(),m=ct(e[0],m),Se(f,d,t.spatialReference,a,u,m,t.lrucache,t.interceptor)}if(L(e[0])===!1)throw new p(t,y.PortalRequired,o);const i=x(e[0]),r=x(e[1]);let l=Z(e[2],null);const w=q(Z(e[3],!0));if(l===null&&(l=["*"]),C(l)===!1)throw new p(t,y.InvalidParameter,o);return Se(i,r,t.spatialReference,l,w,t.services?.portal??ve.getDefault(),t.lrucache,t.interceptor)})},n.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),n.functions.featuresetbyname=function(t,o){return n.standardFunctionAsync(t,o,(I,g,e)=>{if(k(e,2,4,t,o),xe(e[0])){const i=x(e[1]);let r=Z(e[2],null);const l=q(Z(e[3],!0));if(r===null&&(r=["*"]),C(r)===!1)throw new p(t,y.InvalidParameter,o);return e[0].featureSetByName(i,l,r)}throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"featuresetbyname",min:2,max:4}),n.functions.featureset=function(t,o){return n.standardFunction(t,o,(I,g,e)=>{k(e,1,1,t,o);const i={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(L(e[0])){const r=JSON.parse(e[0]);r.layerDefinition!==void 0?(i.layerDefinition=r.layerDefinition,i.featureSet=r.featureSet,r.layerDefinition.spatialReference&&(i.layerDefinition.spatialReference=r.layerDefinition.spatialReference)):(i.featureSet.features=r.features,i.featureSet.geometryType=r.geometryType,i.layerDefinition.geometryType=i.featureSet.geometryType,i.layerDefinition.objectIdField=r.objectIdFieldName??"",i.layerDefinition.typeIdField=r.typeIdFieldName,i.layerDefinition.globalIdField=r.globalIdFieldName,i.layerDefinition.fields=r.fields,r.spatialReference&&(i.layerDefinition.spatialReference=r.spatialReference))}else{if(!(e[0]instanceof M))throw new p(t,y.InvalidParameter,o);{const r=JSON.parse(e[0].castToText(!0)),l=c(r,"layerdefinition");if(l!==null){i.layerDefinition.geometryType=c(l,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.globalIdField=c(l,"globalidfield",""),i.layerDefinition.objectIdField=c(l,"objectidfield",""),i.layerDefinition.typeIdField=c(l,"typeidfield",""),i.layerDefinition.hasZ=c(l,"hasz",!1)===!0,i.layerDefinition.hasM=c(l,"hasm",!1)===!0;const w=c(l,"spatialreference");w&&(i.layerDefinition.spatialReference=Ie(w));const f=[];for(const a of c(l,"fields",[])){const u={name:c(a,"name",""),alias:c(a,"alias",""),type:c(a,"type",""),nullable:c(a,"nullable",!0),editable:c(a,"editable",!0),length:c(a,"length",null),domain:Le(c(a,"domain"))};f.push(u)}i.layerDefinition.fields=f;const d=c(r,"featureset");if(d){const a={};for(const u of f)a[u.name.toLowerCase()]=u.name;for(const u of c(d,"features",[])){const m={},S=c(u,"attributes",{});for(const h in S)m[a[h.toLowerCase()]]=S[h];i.featureSet.features.push({attributes:m,geometry:Ze(c(u,"geometry"))})}}}else{i.layerDefinition.hasZ=c(r,"hasz",!1)===!0,i.layerDefinition.hasM=c(r,"hasm",!1)===!0,i.layerDefinition.geometryType=c(r,"geometrytype",""),i.featureSet.geometryType=i.layerDefinition.geometryType,i.layerDefinition.objectIdField=c(r,"objectidfieldname",""),i.layerDefinition.typeIdField=c(r,"typeidfieldname","");const w=c(r,"spatialreference");w&&(i.layerDefinition.spatialReference=Ie(w));const f=[],d=c(r,"fields",null);if(!C(d))throw new p(t,y.InvalidParameter,o);for(const m of d){const S={name:c(m,"name",""),alias:c(m,"alias",""),type:c(m,"type",""),nullable:c(m,"nullable",!0),editable:c(m,"editable",!0),length:c(m,"length",null),domain:Le(c(m,"domain"))};f.push(S)}i.layerDefinition.fields=f;const a={};for(const m of f)a[m.name.toLowerCase()]=m.name;let u=c(r,"features",null);if(C(u))for(const m of u){const S={},h=c(m,"attributes",{});for(const b in h)S[a[b.toLowerCase()]]=h[b];i.featureSet.features.push({attributes:S,geometry:Ze(c(m,"geometry",null))})}else u=null,i.featureSet.features=u}}}if(bt(i)===!1)throw new p(t,y.InvalidParameter,o);return i.layerDefinition.geometryType||(i.layerDefinition.geometryType="esriGeometryNull"),nt.create(i,t.spatialReference)})},n.signatures.push({name:"featureset",min:1,max:1}),n.functions.filter=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,2,2,t,o),C(e[0])||H(e[0])){const i=[];let r,l=e[0];if(l instanceof ut&&(l=l.toArray()),!Qe(e[1]))throw new p(t,y.InvalidParameter,o);r=e[1].createFunction(t);for(const w of l){const f=r(w);ze(f)?await f===!0&&i.push(w):f===!0&&i.push(w)}return i}if(j(e[0])){const i=await e[0].load(),r=v.create(e[1],{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),l=r.getVariables();if(l.length>0){const w={};for(const f of l)w[f]=n.evaluateIdentifier(t,{name:f});r.parameters=w}return new fe({parentfeatureset:e[0],whereclause:r})}throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"filter",min:2,max:2}),n.functions.orderby=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,2,2,t,o),j(e[0])){const i=new it(e[1]);return new ot({parentfeatureset:e[0],orderbyclause:i})}throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"orderby",min:2,max:2}),n.functions.top=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,2,2,t,o),j(e[0]))return new at({parentfeatureset:e[0],topnum:e[1]});if(C(e[0]))return K(e[1])>=e[0].length?e[0].slice():e[0].slice(0,K(e[1]));if(H(e[0]))return K(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,K(e[1]));throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"top",min:2,max:2}),n.functions.first=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,1,1,t,o),j(e[0])){const i=await e[0].first(I.abortSignal);if(i!==null){const r=_e.createFromGraphicLikeObject(i.geometry,i.attributes,e[0],t.timeZone);return r._underlyingGraphic=i,r}return i}return C(e[0])?e[0].length===0?null:e[0][0]:H(e[0])?e[0].length()===0?null:e[0].get(0):null})},n.signatures.push({name:"first",min:1,max:1}),n.functions.attachments=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{k(e,1,2,t,o);const i={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof M){if(e[1].hasField("minsize")&&(i.minsize=K(e[1].field("minsize"))),e[1].hasField("metadata")&&(i.returnMetadata=q(e[1].field("metadata"))),e[1].hasField("maxsize")&&(i.maxsize=K(e[1].field("maxsize"))),e[1].hasField("types")){const r=Xe(e[1].field("types"),!1);r.length>0&&(i.types=r)}}else if(e[1]!==null)throw new p(t,y.InvalidParameter,o)}if(ne(e[0])){const r=e[0]._layer;let l;if(j(r))l=r;else{if(r==null||!Ce(r))return[];l=oe(r,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}return await l.load(),l.queryAttachments(e[0].field(l.objectIdField),i.minsize,i.maxsize,i.types,i.returnMetadata)}if(e[0]===null)return[];throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"attachments",min:1,max:2}),n.functions.featuresetbyrelationshipname=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{k(e,2,4,t,o);const i=e[0],r=x(e[1]);let l=Z(e[2],null);const w=q(Z(e[3],!0));if(l===null&&(l=["*"]),C(l)===!1)throw new p(t,y.InvalidParameter,o);if(e[0]===null)return null;if(!ne(e[0]))throw new p(t,y.InvalidParameter,o);const f=i._layer;let d;if(j(f))d=f;else{if(f==null||!Ce(f))return null;d=oe(f,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)}d=await d.load();const a=d.relationshipMetaData().filter(b=>b.name===r);if(a.length===0)return null;if(a[0].relationshipTableId!==void 0&&a[0].relationshipTableId!==null&&a[0].relationshipTableId>-1)return rt(d,a[0],i.field(d.objectIdField),d.spatialReference,l,w,t.lrucache,t.interceptor);let u=d.serviceUrl();if(!u)return null;u=u.charAt(u.length-1)==="/"?u+a[0].relatedTableId.toString():u+"/"+a[0].relatedTableId.toString();const m=await st(u,d.spatialReference,l,w,t.lrucache,t.interceptor);await m.load();let S=m.relationshipMetaData();if(S=S.filter(b=>b.id===a[0].id),i.hasField(a[0].keyField)===!1||i.field(a[0].keyField)===null){const b=await d.getFeatureByObjectId(i.field(d.objectIdField),[a[0].keyField]);if(b){const E=v.create(S[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return E.parameters={id:b.attributes[a[0].keyField]},m.filter(E)}return new ft({parentfeatureset:m})}const h=v.create(S[0].keyField+"= @id",{fieldsIndex:m.getFieldsIndex(),timeZone:m.dateFieldsTimeZoneDefaultUTC});return h.parameters={id:i.field(a[0].keyField)},m.filter(h)})},n.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),n.functions.featuresetbyassociation=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{k(e,2,3,t,o);const i=e[0],r=et(x(Z(e[1],""))),l=L(e[2])?x(e[2]):null;if(e[0]===null)return null;if(!ne(e[0]))throw new p(t,y.InvalidParameter,o);let w=i._layer;if(w instanceof je&&(w=oe(w,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),w===null||j(w)===!1)return null;await w.load();const f=w.serviceUrl(),d=await lt(f,t.spatialReference,!0);if(d.unVersion>=8)return await Ft(w,i,r,l,d,t,o);const a=d.associations;let u=null,m=null,S=!1;if(l!==null&&l!==""&&l!==void 0){for(const T of d.terminals)T.terminalName===l&&(m=T.terminalId);m===null&&(S=!0)}const h=a.getFieldsIndex(),b=h.get("TOGLOBALID").name,E=h.get("FROMGLOBALID").name,R=h.get("TOTERMINALID").name,X=h.get("FROMTERMINALID").name,Y=h.get("FROMNETWORKSOURCEID").name,ee=h.get("TONETWORKSOURCEID").name,J=h.get("ASSOCIATIONTYPE").name,$e=h.get("ISCONTENTVISIBLE").name,Pe=h.get("OBJECTID").name;for(const T of w.fields)if(T.type==="global-id"){u=i.field(T.name);break}let G=null,ge=new W(new P({name:"percentalong",alias:"percentalong",type:"double"}),v.create("0",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),he=new W(new P({name:"side",alias:"side",type:"string"}),v.create("''",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));const U="globalid",be="globalId",Fe={};for(const T in d.lkp)Fe[T]=d.lkp[T].sourceId;const V=new dt(new P({name:"classname",alias:"classname",type:"string"}),null,Fe);let N="";switch(r){case"midspan":{N=`((${b}='${u}') OR ( ${E}='${u}')) AND (${J} IN (5))`,V.codefield=v.create(`CASE WHEN (${b}='${u}') THEN ${Y} ELSE ${ee} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const T=pe($.findField(a.fields,E));T.name=U,T.alias=U,G=new W(T,v.create(`CASE WHEN (${E}='${u}') THEN ${b} ELSE ${E} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),ge=d.unVersion>=4?new me($.findField(a.fields,h.get("PERCENTALONG").name)):new W(new P({name:"percentalong",alias:"percentalong",type:"double"}),v.create("0",{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{N=`((${b}='${u}') OR ( ${E}='${u}')) AND (${J} IN (4,6))`,V.codefield=v.create(`CASE WHEN (${b}='${u}') THEN ${Y} ELSE ${ee} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const T=pe($.findField(a.fields,E));T.name=U,T.alias=U,G=new W(T,v.create(`CASE WHEN (${E}='${u}') THEN ${b} ELSE ${E} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC})),he=new W(new P({name:"side",alias:"side",type:"string"}),v.create(`CASE WHEN (${J}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let T=`${b}='@T'`,Ne=`${E}='@T'`;m!==null&&(T+=` AND ${R}=@A`,Ne+=` AND ${X}=@A`),N="(("+T+") OR ("+Ne+"))",N=ie(N,"@T",u??""),T=ie(T,"@T",u??""),m!==null&&(T=ie(T,"@A",m.toString()),N=ie(N,"@A",m.toString())),V.codefield=v.create("CASE WHEN "+T+` THEN ${Y} ELSE ${ee} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC});const se=pe($.findField(a.fields,E));se.name=U,se.alias=U,G=new W(se,v.create("CASE WHEN "+T+` THEN ${E} ELSE ${b} END`,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}));break}case"container":N=`${b}='${u}' AND ${J} = 2`,m!==null&&(N+=` AND ${R} = `+m.toString()),V.codefield=Y,N="( "+N+" )",G=new ae($.findField(a.fields,E),U,U);break;case"content":N=`(${E}='${u}' AND ${J} = 2)`,m!==null&&(N+=` AND ${X} = `+m.toString()),V.codefield=ee,N="( "+N+" )",G=new ae($.findField(a.fields,b),U,U);break;case"structure":N=`(${b}='${u}' AND ${J} = 3)`,m!==null&&(N+=` AND ${R} = `+m.toString()),V.codefield=Y,N="( "+N+" )",G=new ae($.findField(a.fields,E),U,be);break;case"attached":N=`(${E}='${u}' AND ${J} = 3)`,m!==null&&(N+=` AND ${X} = `+m.toString()),V.codefield=ee,N="( "+N+" )",G=new ae($.findField(a.fields,b),U,be);break;default:throw new p(t,y.InvalidParameter,o)}return S&&(N="1 <> 1"),new $({parentfeatureset:a,adaptedFields:[new me($.findField(a.fields,Pe)),new me($.findField(a.fields,$e)),G,he,V,ge],extraFilter:N?v.create(N,{fieldsIndex:a.getFieldsIndex(),timeZone:a.dateFieldsTimeZoneDefaultUTC}):null})})},n.signatures.push({name:"featuresetbyassociation",min:2,max:6}),n.functions.groupby=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,3,3,t,o),!j(e[0]))throw new p(t,y.InvalidParameter,o);const i=await e[0].load(),r=[],l=[];let w=!1,f=[];if(L(e[1]))f.push(e[1]);else if(e[1]instanceof M)f.push(e[1]);else if(C(e[1]))f=e[1];else{if(!H(e[1]))throw new p(t,y.InvalidParameter,o);f=e[1].toArray()}for(const d of f)if(L(d)){const a=v.create(x(d),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),u=Ae(a)===!0?x(d):"%%%%FIELDNAME";r.push({name:u,expression:a}),u==="%%%%FIELDNAME"&&(w=!0)}else{if(!(d instanceof M))throw new p(t,y.InvalidParameter,o);{const a=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",u=d.hasField("expression")?d.field("expression"):"";if(a==="%%%%FIELDNAME"&&(w=!0),!a)throw new p(t,y.InvalidParameter,o);r.push({name:a,expression:v.create(u||a,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(f=[],L(e[2]))f.push(e[2]);else if(C(e[2]))f=e[2];else if(H(e[2]))f=e[2].toArray();else{if(!(e[2]instanceof M))throw new p(t,y.InvalidParameter,o);f.push(e[2])}for(const d of f){if(!(d instanceof M))throw new p(t,y.InvalidParameter,o);{const a=d.hasField("name")?d.field("name"):"",u=d.hasField("statistic")?d.field("statistic"):"",m=d.hasField("expression")?d.field("expression"):"";if(!(a&&u&&L(u)&&m))throw new p(t,y.InvalidParameter,o);l.push({name:a,statistic:u,expression:v.create(m,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(w){const d={};for(const u of i.fields)d[u.name.toLowerCase()]=1;for(const u of r)u.name!=="%%%%FIELDNAME"&&(d[u.name.toLowerCase()]=1);for(const u of l)u.name!=="%%%%FIELDNAME"&&(d[u.name.toLowerCase()]=1);let a=0;for(const u of r)if(u.name==="%%%%FIELDNAME"){for(;d["field_"+a.toString()]===1;)a++;d["field_"+a.toString()]=1,u.name="FIELD_"+a.toString()}}for(const d of r)we(d.expression,n,t);for(const d of l)we(d.expression,n,t);return e[0].groupby(r,l)})},n.signatures.push({name:"groupby",min:3,max:3}),n.functions.distinct=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(j(e[0])){k(e,2,2,t,o);const i=await e[0].load(),r=[];let l=[];if(L(e[1]))l.push(e[1]);else if(e[1]instanceof M)l.push(e[1]);else if(C(e[1]))l=e[1];else{if(!H(e[1]))throw new p(t,y.InvalidParameter,o);l=e[1].toArray()}let w=!1;for(const f of l)if(L(f)){const d=v.create(x(f),{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC}),a=Ae(d)===!0?x(f):"%%%%FIELDNAME";r.push({name:a,expression:d}),a==="%%%%FIELDNAME"&&(w=!0)}else{if(!(f instanceof M))throw new p(t,y.InvalidParameter,o);{const d=f.hasField("name")?f.field("name"):"%%%%FIELDNAME",a=f.hasField("expression")?f.field("expression"):"";if(d==="%%%%FIELDNAME"&&(w=!0),!d)throw new p(t,y.InvalidParameter,o);r.push({name:d,expression:v.create(a||d,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC})})}}if(w){const f={};for(const a of i.fields)f[a.name.toLowerCase()]=1;for(const a of r)a.name!=="%%%%FIELDNAME"&&(f[a.name.toLowerCase()]=1);let d=0;for(const a of r)if(a.name==="%%%%FIELDNAME"){for(;f["field_"+d.toString()]===1;)d++;f["field_"+d.toString()]=1,a.name="FIELD_"+d.toString()}}for(const f of r)we(f.expression,n,t);return e[0].groupby(r,[])}return gt(e)})},n.functions.getfeaturesetinfo=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,1,1,t,o),!j(e[0]))return null;const i=await e[0].getFeatureSetInfo();return i?M.convertObjectToArcadeDictionary({layerId:i.layerId,layerName:i.layerName,itemId:i.itemId,serviceLayerUrl:i.serviceLayerUrl,webMapLayerId:i.webMapLayerId??null,webMapLayerTitle:i.webMapLayerTitle??null,className:null,objectClassId:null},De(t),!1,!1):null})},n.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),n.functions.filterbysubtypecode=function(t,o){return n.standardFunctionAsync(t,o,async(I,g,e)=>{if(k(e,2,2,t,o),j(e[0])){const i=await e[0].load(),r=e[1];if(!Je(r))throw new p(t,y.InvalidParameter,o);if(i.subtypeField){const w=v.create(`${i.subtypeField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new fe({parentfeatureset:e[0],whereclause:w})}if(i.typeIdField===null||i.typeIdField==="")throw new p(t,y.FeatureSetDoesNotHaveSubtypes,o);const l=v.create(`${i.typeIdField}= ${e[1]}`,{fieldsIndex:i.getFieldsIndex(),timeZone:i.dateFieldsTimeZoneDefaultUTC});return new fe({parentfeatureset:e[0],whereclause:l})}throw new p(t,y.InvalidParameter,o)})},n.signatures.push({name:"filterbysubtypecode",min:2,max:2})}}export{Nt as registerFunctions};
