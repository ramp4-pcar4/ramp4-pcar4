{"version":3,"file":"layersLoader-DBDJoOa3.js","sources":["../../node_modules/@arcgis/core/portal/support/layersLoader.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.29/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{parse as t}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as r}from\"../../layers/support/fetchService.js\";import{LayerLoadContext as a}from\"../../layers/support/LayerLoadContext.js\";import{populateGroupLayer as o}from\"../../layers/support/layersCreator.js\";import{layerLookupMap as n}from\"../../layers/support/lazyLayerLoader.js\";import s from\"../Portal.js\";import{createForItemRead as l}from\"./jsonContext.js\";import{getFirstLayerOrTable as i,preprocessFSItemData as p,getSubtypeGroupLayerIds as u,getOrientedImageryLayerIds as c,getCatalogLayerIds as y,populateSceneServiceItemData as f,getNumLayersAndTables as m,createSublayerData as d,getFirstLayerOrTableId as h}from\"./loadUtils.js\";import{hasTypeKeyword as w}from\"./portalItemUtils.js\";import{loadStyleRenderer as g}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as b}from\"../../support/requestPresets.js\";async function I(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),L(e),e.validateItem&&e.validateItem(r),v(e,t)}function L(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function v(e,t){const r=e.instance,o=r.portalItem;if(!o)return;const{url:n,title:s}=o,i=l(o,\"portal-item\");if(\"group\"===r.type)return S(r,i,e);n&&\"media\"!==r.type&&r.read({url:n},i);const p=new a,u=await C(e,p,t);return u&&r.read(u,i),r.resourceReferences={portalItem:o,paths:i.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:s},i),g(r,i)}async function S(t,r,a){const o=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:s}=o;if(\"Group Layer\"===s){if(!w(o,\"Map\"))throw new e(\"portal:invalid-layer-item-typekeyword\",\"'Group Layer' item without 'Map' type keyword is not supported\");return T(t)}return t.read({title:n},r),j(t,a)}async function T(e){const t=e.portalItem,r=await t.fetchData(\"json\");if(!r)return;const a=l(t,\"web-map\");e.read(r,a),await o(e,r,{context:a}),e.resourceReferences={portalItem:t,paths:a.readResourcePaths??[]}}async function j(t,r){let o;const{portalItem:n}=t;if(!n)return;const s=n.type,l=r.layerModuleTypeMap;switch(s){case\"Feature Service\":case\"Feature Collection\":o=l.FeatureLayer;break;case\"Stream Service\":o=l.StreamLayer;break;case\"Scene Service\":o=l.SceneLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const d=new a;let[h,w]=await Promise.all([o(),C(r,d)]),g=()=>h;if(\"Feature Service\"===s){const e=i(w)?.customParameters;w=n.url?await p(w,n.url,d):{};const r=u(w),a=c(w),o=y(w),s=[];if(r.length||a?.length){r.length&&s.push(\"SubtypeGroupLayer\"),a?.length&&s.push(\"OrientedImageryLayer\"),o?.length&&s.push(\"CatalogLayer\");const e=[];for(const r of s){const t=l[r];e.push(t())}const t=await Promise.all(e),n=new Map;s.forEach(((e,r)=>{n.set(e,t[r])})),g=e=>e.layerType?n.get(e.layerType)??h:h}const f=await G(n.url,{customParameters:e,loadContext:d});return await M(t,g,w,f)}return\"Scene Service\"===s&&n.url&&(w=await f(n,w,d)),m(w)>0?await M(t,g,w):await P(t,g)}async function P(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await b(r.url);a&&M(e,t,{layers:a.layers?.map(d),tables:a.tables?.map(d)})}async function M(e,t,r,a){let o=r.layers||[];const s=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type?(o.forEach(((e,t)=>{e.id=t,\"Table\"===e?.layerDefinition?.type&&s.push(e)})),o=o.filter((e=>\"Table\"!==e?.layerDefinition?.type))):(o.reverse(),s.reverse()),o.forEach((o=>{const n=a?.(o);if(n||!a){const a=x(e,t(o),r,o,n);e.add(a)}})),s.length){const t=await n.FeatureLayer();s.forEach((o=>{const n=a?.(o);if(n||!a){const a=x(e,t,r,o,n);e.tables.add(a)}}))}}function x(e,t,r,a,o){const n=e.portalItem,l={portalItem:n.clone(),layerId:a.id};null!=a.url&&(l.url=a.url);const i=new t(l);if(\"sourceJSON\"in i&&(i.sourceJSON=o),\"subtype-group\"!==i.type&&\"catalog\"!==i.type&&(i.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===n.type){const e={origin:\"portal-item\",portal:n.portal||s.getDefault()};i.read(a,e);const t=r.showLegend;null!=t&&i.read({showLegend:t},e)}return i}async function C(e,t,r){if(!1===e.supportsData)return;const a=e.instance,o=a.portalItem;if(!o)return;let n=null;try{n=await o.fetchData(\"json\",r)}catch(s){}if(k(a)){let e=null;const r=await F(o,n,t);if((n?.layers||n?.tables)&&r>0){if(null==a.layerId){const e=u(n);a.layerId=\"subtype-group\"===a.type?e?.[0]:h(n)}e=D(n,a),e&&null!=n.showLegend&&(e.showLegend=n.showLegend)}return r>1&&\"sublayerTitleMode\"in a&&\"service-name\"!==a.sublayerTitleMode&&(a.sublayerTitleMode=\"item-title-and-service-name\"),e}return n}async function F(e,r,a){if(r?.layers&&r?.tables)return m(r);const o=t(e.url);if(!o)return 1;const n=await a.fetchServiceMetadata(o.url.path,{customParameters:i(r)?.customParameters}).catch((()=>null));return(r?.layers?.length??n?.layers?.length??0)+(r?.tables?.length??n?.tables?.length??0)}function D(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&E(a,t)?a:null}function k(e){return\"stream\"!==e.type&&\"layerId\"in e}function E(e,t){return!(\"feature\"===t.type&&\"layerType\"in e&&\"SubtypeGroupLayer\"===e.layerType||\"subtype-group\"===t.type&&!(\"layerType\"in e))}async function G(e,t){const{layersJSON:a}=await r(e,t);if(!a)return null;const o=[...a.layers,...a.tables];return e=>o.find((t=>t.id===e.id))}export{I as load};\n"],"names":["I","t","r","L","v","e","o","n","i","l","S","p","a","u","C","g","s","w","T","j","d","h","c","y","f","G","M","m","P","b","x","k","F","D","E"],"mappings":"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","x_google_ignoreList":[0]}