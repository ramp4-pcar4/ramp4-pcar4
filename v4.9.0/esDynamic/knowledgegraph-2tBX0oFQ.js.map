{"version":3,"file":"knowledgegraph-2tBX0oFQ.js","sources":["../../node_modules/@arcgis/core/arcade/functions/knowledgegraph.js"],"sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.29/esri/copyright.txt for details.\n*/\nimport e from\"../../config.js\";import\"../../geometry.js\";import r from\"../ArcadePortal.js\";import t from\"../Dictionary.js\";import{ArcadeExecutionError as n,ExecutionErrorCodes as o}from\"../executionError.js\";import{H as a,j as i,c as s,w as p,K as l,o as c,N as f,b as u,k as m,m as g,n as h,v as d,p as w,a7 as y}from\"../../chunks/languageUtils.js\";import{getPortal as j}from\"../portalUtils.js\";import S from\"../../geometry/Geometry.js\";import{isLoaded as R,load as v,project as G}from\"../../geometry/projection.js\";import{webMercatorToGeographic as k,geographicToWebMercator as x}from\"../../geometry/support/webMercatorUtils.js\";import P from\"../../portal/Portal.js\";import b from\"../../portal/PortalItem.js\";import{project as I}from\"../../rest/geometryService/project.js\";import W from\"../../rest/knowledgeGraph/Entity.js\";import T from\"../../rest/knowledgeGraph/GraphQueryStreaming.js\";import D from\"../../rest/knowledgeGraph/ObjectValue.js\";import N from\"../../rest/knowledgeGraph/Path.js\";import q from\"../../rest/knowledgeGraph/Relationship.js\";import A from\"../../rest/support/ProjectParameters.js\";import U from\"../../geometry/SpatialReference.js\";let F=null;async function J(r){const t=e.geometryServiceUrl??\"\";if(!t){R()||await v();for(const e of r)e.container[e.indexer]=G(e.container[e.indexer],U.WGS84);return}const n=r.map((e=>e.container[e.indexer])),o=new A({geometries:n,outSpatialReference:U.WGS84}),a=await I(t,o);for(let e=0;e<a.length;e++){const t=r[e];t.container[t.indexer]=a[e]}}async function M(e,r){const t=new b({portal:e,id:r});return await t.load(),null===F&&(F=await import(\"../../rest/knowledgeGraphService.js\")),await F.fetchKnowledgeGraph(t.url)}function Q(e,r,t,a,i){if(null===e)return null;if(s(e)||u(e))return e;if(m(e))return e.toJSDate();if(m(e))return e.toJSDate();if(g(e))return e.toStorageFormat();if(h(e))return e.toStorageString();if(d(e)){const n={};for(const o of e.keys())n[o]=Q(e.field(o),r,t,a,i),n[o]instanceof S&&i.push({container:n,indexer:o});return n}if(c(e)){const n=e.map((e=>Q(e,r,t,a,i)));for(let e=0;e<n.length;e++)n[e]instanceof S&&i.push({container:n,indexer:e});return n}if(w(e)){if(e.spatialReference.isWGS84)return e;if(e.spatialReference.isWebMercator&&r)return k(e);if(!r||!t)return e;throw new n(a,o.WrongSpatialReference,null)}}function E(e,r){if(!e)return e;if(e.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return x(e);if(e.spatialReference.equals(r.spatialReference))return e;throw new n(r,o.WrongSpatialReference,null)}function K(e,r){if(!e)return null;const t={};for(const n in e)t[n]=V(e[n],r);return t}function V(e,r){return null===e?null:c(e)?e.map((e=>V(e,r))):e instanceof W?{graphTypeName:e.typeName,id:e.id,graphType:\"entity\",properties:K(e.properties,r)}:e instanceof D?{graphType:\"object\",properties:K(e.properties,r)}:e instanceof q?{graphTypeName:e.typeName,id:e.id,graphType:\"relationship\",originId:e.originId??null,destinationId:e.destinationId??null,properties:K(e.properties,r)}:e instanceof N?{graphType:\"path\",path:e.path?e.path.map((e=>V(e,r))):null}:w(e)?E(e,r):s(e)||u(e)||y(e)?e:null}function C(e){\"async\"===e.mode&&(e.functions.knowledgegraphbyportalitem=function(t,p){return e.standardFunctionAsync(t,p,((e,l,c)=>{if(a(c,2,2,t,p),null===c[0])throw new n(t,o.PortalRequired,p);if(c[0]instanceof r){const e=i(c[1]);let r=null;r=t.services?.portal?t.services.portal:P.getDefault();return M(j(c[0],r),e)}if(!1===s(c[0]))throw new n(t,o.InvalidParameter,p);const f=i(c[0]);return M(t.services?.portal??P.getDefault(),f)}))},e.signatures.push({name:\"knowledgegraphbyportalitem\",min:2,max:2}),e.functions.querygraph=function(r,i){return e.standardFunctionAsync(r,i,(async(e,u,m)=>{a(m,2,4,r,i);const g=m[0];if(!p(g))throw new n(r,o.InvalidParameter,i);const h=m[1];if(!s(h))throw new n(r,o.InvalidParameter,i);null===F&&(F=await import(\"../../rest/knowledgeGraphService.js\"));let d=null;const w=l(m[2],null);if(!(w instanceof t||null===w))throw new n(r,o.InvalidParameter,i);if(w){let e=[];d=Q(w,!0,!1,r,e),e=e.filter((e=>!e.container[e.indexer].spatialReference.isWGS84)),e.length>0&&await J(e)}const y=new T({openCypherQuery:h,bindParameters:d});(g?.serviceDefinition?.currentVersion??11.3)>11.2&&(y.outputSpatialReference=r.spatialReference);const j=(await F.executeQueryStreaming(g,y)).resultRowsStream.getReader(),S=[];try{for(;;){const{done:e,value:t}=await j.read();if(e)break;if(c(t))for(const n of t)S.push(V(n,r));else{const e=[];for(const n of t)e.push(V(t[n],r));S.push(e)}}}catch(R){throw R}return t.convertJsonToArcade(S,f(r),!1,!0)}))},e.signatures.push({name:\"querygraph\",min:2,max:4}))}export{C as registerFunctions};\n"],"names":["F","J","r","e","R","v","G","U","n","o","A","a","I","t","M","b","Q","i","s","u","m","g","h","d","S","c","w","k","E","x","K","V","W","D","q","N","y","C","p","l","P","j","f","T"],"mappings":"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","x_google_ignoreList":[0]}